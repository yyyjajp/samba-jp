<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">

<chapter id="NetCommand">
<chapterinfo>
	&author.jht;
	&author.vl;
	&author.gd;
	<pubdate>May 9, 2005</pubdate>
</chapterinfo>

<title>リモートとローカル管理:Netコマンド</title>

<para>
<indexterm><primary>net</primary></indexterm>
<indexterm><primary>リモート管理</primary></indexterm>
<indexterm><primary>コマンド行</primary></indexterm>
<indexterm><primary>scripted control</primary></indexterm>
<command>net</command>コマンドはSamba-3における新しい機能の1つで、共通作業のために、
多くの必要なリモート管理操作用の便利なツールを提供する試みである。<command>net</command>
は自由度が高いデザインで、スクリプト制御アプリケーションのためと同様にコマンド行操作
でも使うように出来ている。
</para>

<para>
<indexterm><primary>net</primary></indexterm>
<indexterm><primary>ネットワーク管理者の道具箱</primary></indexterm>
<indexterm><primary>smbgroupedit</primary></indexterm>
<indexterm><primary>rpcclient</primary></indexterm>
当初は同じ名前のMicrosoft Windows コマンドの模倣を狙って作られたが、<command>net</command>
は、Sambaネットワーク管理者の道具箱の基本的な部分になる、非常に強力なツールに変貌した。
Samba Teamは、<command>smbgroupedit</command>と<command>rpcclient</command>のような
ツールも提供していて、それらは本当に役に立つ能力が<command>net</command>コマンドに集約
された。<command>smbgroupedit</command>コマンドは、いくつかの機能のみが
<command>rpcclient</command>に集約された間、<command>net</command>コマンドに完全に移植された。
それらのユーティリティや機能に対する古いリファレンスを見つけた場合、それ以外を探す前に、
<command>net</command>コマンドを見るべきである。
</para>

<para>
Samba-3管理者は、そうすることが、自ら招いた痛み、苦しみと自暴自棄を科すことをほとんど
確実に引き起こすので、この章を取り繕うことができない。
</para>

	<sect1>
	<title>概要</title>

	<para>
<indexterm><primary>スタンドアロン</primary></indexterm>
<indexterm><primary>ドメインメンバ</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>DMS</primary></indexterm>
<indexterm><primary>authentication</primary></indexterm>
	Samba-3サーバのインストールに伴う作業は、スタンドアロンかドメインメンバの
	どちらも、さらにドメインコントローラ(PDCまたはBDC)は管理者権限の作成を必要と
	するところから始まる。もちろん、ユーザとグループアカウントの作成は、スタンド
	アロンサーバとPDC両者において必須である。BDCまたはドメインメンバサーバ(DMS)
	においては、ドメインユーザとグループアカウントは中央のドメイン認証バック
	エンドから得られる。
	</para>

	<para>
<indexterm><primary>サーバタイプ</primary></indexterm>
<indexterm><primary>ローカルUNIXグループ</primary></indexterm>
<indexterm><primary>mapped</primary></indexterm>
<indexterm><primary>ドメイングローバルグループ</primary></indexterm>
<indexterm><primary>UID</primary></indexterm>
<indexterm><primary>GID</primary></indexterm>
<indexterm><primary>アクセス権</primary></indexterm>
<indexterm><primary>net</primary></indexterm>
	インストールされているサーバのタイプに関係なく、ローカルUNIXグループはWindowsの
	ネットワークにおけるドメイングローバルグループアカウントにマップされねばならない。
	なぜだろうか?それは、Sambaは常時、伝統的なUNIXのUIDとGID制御によってホスト
	サーバのリソースのアクセスを制限するからである。これは、ドメイングローバル
	グループのメンバであるドメインユーザは、Sambaがホスティングしているサーバの
	ローカルなUIDとGIDをベースとしたアクセス権が与えられるようにするために、
	ローカルグループはドメイングローバルグループにマップされなければならない。
	このようなマッピングは<command>net</command>コマンドを使うことで実装される。
	</para>

	<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>DMS</primary></indexterm>
<indexterm><primary>セキュリティアカウント</primary></indexterm>
<indexterm><primary>domain authentication</primary></indexterm>
<indexterm><primary>信頼アカウント</primary></indexterm>
<indexterm><primary>net</primary></indexterm>
	メンバ(PDC、BDCあるいはDMS)として動作しているSamba-3サーバがホスティングしている
	UNIXシステムは、ドメイン認証データベース(かあるいはディレクトリ)中にマシン信頼
	アカウントを持たねばならない。そのようなセキュリティ(あるいは信頼)アカウントの
	作成も、<command>net</command>コマンドを使うことよって扱える。
	</para>

	<para>
<indexterm><primary>ドメイン間の信頼関係</primary></indexterm>
<indexterm><primary>net</primary></indexterm>
<indexterm><primary>administrative duties</primary></indexterm>
<indexterm><primary>ユーザ管理</primary></indexterm>
<indexterm><primary>グループ管理</primary></indexterm>
<indexterm><primary>共有管理</primary></indexterm>
<indexterm><primary>プリンタ管理</primary></indexterm>
<indexterm><primary>プリンタのマイグレーション</primary></indexterm>
<indexterm><primary>SID管理</primary></indexterm>
	<command>net</command>コマンドを使うことで、ドメイン間信頼関係をも確立でき、
	また、ユーザ管理、グループ管理、共有とプリンタ管理、ファイルとプリンタの
	マイグレーション、SIDの管理などのような、有り余るほどの典型的な管理作業も
	できる。
	</para>

	<para>
<indexterm><primary>net</primary></indexterm>
<indexterm><primary>man pages</primary></indexterm>
	全体の構成は今明確にすべきである:<command>net</command>はSamba-3の動作において
	重要な役割を演じる。その役割は継続して開発されている。この章に含まれているもの
	は、その重要性の証拠であり、それは、完全にオンラインUNIXマニュアル中でその
	使用をカバーすることが賢明であるとは、もはや考えられない点において、複雑に成長
	してきた。
	</para>

	</sect1>
	
	<sect1>
	<title>管理者の作業と手段</title>

	<para>
<indexterm><primary>net</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>分散コンピューティング環境</primary><see>DCE</see></indexterm>
<indexterm><primary>リモートプロシジャーコール</primary><see>RPC</see></indexterm>
	<command>net</command>の基本的な動作はここに文書化されている。この文書は完璧
	ではなく、不完全である。WindowsサーバからSambaサーバへの移行について最も着目
	しているので、分散コンピューティング環境のリモートプロシジャーコール(DCE RPC)
	モードの操作について強調している。Active Directoryドメインのメンバであるサーバに
	対して使用されるとき、ADSモード操作を使うことは望ましい(そして、それはしばしば
	必要である)。<command>net</command>は両方ともサポートするが、すべての操作に
	対してではない。モードが指定されない多くの操作では、<command>net</command>は
	自動的に<constant>ads</constant>, <constant>rpc</constant>と
	<constant>rap</constant>モードにフォールバックする。このユーティリティの
	能力についてのより包括的な概要はマニュアルページを参照のこと。
	</para>

	</sect1>

	<sect1>
	<title>UNIXとWindowsのグループ管理</title>

	<para>
<indexterm><primary>Active Directory</primary></indexterm>
<indexterm><primary>net</primary><secondary>rpc</secondary></indexterm>
<indexterm><primary>net</primary><secondary>ads</secondary></indexterm>
<indexterm><primary>net</primary><secondary>rap</secondary></indexterm>
<indexterm><primary>RAP</primary></indexterm>
	初めに、この章の主要な注目点は、Sambaによってサポートされている
	<command>net rpc</command>ファミリの動作の使用方法である。それらの大半は、
	Active Directoryに接続したときに使われる<command>net ads</command>モードでも
	サポートされる。<command>net rap</command>動作モードもそれらの操作のいくつかで
	サポートされる。RAPプロトコルはIBM OS/2といくつかの初期のSMBサーバによって
	使われる。
	</para>

	<para>
<indexterm><primary>net</primary></indexterm>
<indexterm><primary>ユーザ管理</primary></indexterm>
<indexterm><primary>グループ管理</primary></indexterm>
	Sambaの<command>net</command>ツールはコマンドラインで完結するための、すべての
	共通な管理作業が出来る十分な能力を実装している。このセクションでは、必須の
	ユーザとグループ管理機能のそれぞれについて説明している。
	</para>

	<para>
<indexterm><primary>グループ</primary></indexterm>
<indexterm><primary>ドメイン</primary><secondary>groups</secondary></indexterm>
<indexterm><primary>ローカル</primary><secondary>groups</secondary></indexterm>
<indexterm><primary>ドメインユーザアカウント</primary></indexterm>
	Samba-3は2種類のグループを認識する。それは、<emphasis>ドメイングループ</emphasis>
	と<emphasis>ローカルグループ</emphasis>である。ドメイングループは(メンバとして)
	ドメインユーザアカウントのみを含むことは出来る。ローカルグループはローカル
	グループ、ドメインユーザとメンバとしてのドメイングループをを含むことが出来る。
	</para>

	<para>
	ローカルグループの目的は、そのグループアカウントに対して、通常のUNIX/Linux
	グループのようにファイルのアクセス権を	設定することであり、また、Windows
	ファイルサーバを再配置しても継続的である。
	</para>

	<sect2>
	<title>グループアカウントの追加、改名、あるいは削除</title>

	<para>
	SambaはWindowsクライアントにファイルと印刷サービスを提供する。Windows環境に
	対して有効にしたファイルシステムリソースは、必要に応じてWindowsネットワーク
	環境と互換の方式で提供しなければならない。UNIXグループはUNIX OSとそのファイル
	システム内で、操作の必要で提供するために要求に応じて作成および削除される。
	</para>

	<para>
	Windows環境に対して有効にするために、Sambaは、Windows(あるいはドメイン)グループ
	と呼ばれる論理的なエントリに、UNIXグループをマップされることが出来る機能を持つ。
	Sambaはローカルとグローバルと言う2つのタイプのWindowsグループをサポートする。
	グローバルグループはメンバとグローバルユーザを含むことが出来る。このメンバシップは
	通常のUNIX流儀に影響されるが、UNIXユーザをUNIXグループに追加する。Windowsユーザ
	アカウントはユーザのSambaSAMAccount(論理エントリ)とUNIXユーザアカウントとの
	マッピングから成り立つ。そのため、UNIXユーザはWindowsユーザにマップされ(すなわち、
	Windowsユーザアカウントとパスワードが与えられる)、そのユーザに属するUNIX
	グループはWindowsグループアカウントにマップされる。この結果は、Windowsアカウント
	環境においてそのユーザが、UNIXグループメンバシップであるという理由で、Windows
	グループアカウントのメンバでもあるということである。
	</para>

	<para>
	Windowsグループ管理を扱う以下の項では、Windowsグループアカウントとそのメンバの
	間の関係について、それぞれのWindowsグループアカウントの関係をデモする。これは、
	論理マッピングが作成されるとすぐに、どのように自動的にUNIXグループメンバをWindows
	グループメンバシップに渡すかを表示する。
	</para>

	<sect3>
	<title>新しいグループの追加又は作成</title>

	<para>
	Windowsグループアカウントを追加する前に、現在有効なグループは以下のようにして表示できる:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>group</tertiary></indexterm>
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>group list</tertiary></indexterm>
<screen>
&rootprompt; net rpc group list -Uroot%not24get
Password:
Domain Admins
Domain Users
Domain Guests
Print Operators
Backup Operators
Replicator
Domain Computers
Engineers
</screen>
	</para>

<?latex \newpage ?>
	<para>
	<quote>SupportEngrs</quote>というWindowsグループアカウントは、以下のコマンドを
	実行することで追加できる:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>group add</tertiary></indexterm>
<screen>
&rootprompt; net rpc group add "SupportEngrs" -Uroot%not24get
</screen>
	以下のコマンドを実行することで、新しいグループアカウント追加の結果が有効になって
いることが検証できる:
<screen>
&rootprompt; net rpc group list -Uroot%not24get
Password:
Domain Admins
Domain Users
Domain Guests
Print Operators
Backup Operators
Replicator
Domain Computers
Engineers
SupportEngrs
</screen>
	</para>

	<para>
<indexterm><primary>POSIX</primary></indexterm>
<indexterm><primary>smbldap-groupadd</primary></indexterm>
<indexterm><primary>getent</primary></indexterm>
	以下はPOSIX(UNIX/Linuxシステムアカウント)グループが、
	<smbconfoption name="add group script">/opt/IDEALX/sbin/smbldap-groupadd -p "%g"</smbconfoption>
	インタフェーススクリプトを呼び出すことによって作成されたことを表示する:
<screen>
&rootprompt; getent group
...
Domain Admins:x:512:root
Domain Users:x:513:jht,lct,ajt,met
Domain Guests:x:514:
Print Operators:x:550:
Backup Operators:x:551:
Replicator:x:552:
Domain Computers:x:553:
Engineers:x:1002:jht
SupportEngrs:x:1003:
</screen>
	以下は、グループアカウントを追加する<command>net</command>の使用で、Windows
	グループアカウントのために作られたPOSIXグループの即時的なマッピング中での結果を示す:
<indexterm><primary>net</primary><secondary>groupmap</secondary><tertiary>list</tertiary></indexterm>
<screen>
&rootprompt; net groupmap list
Domain Admins (S-1-5-21-72630-4128915-11681869-512) -> Domain Admins
Domain Users (S-1-5-21-72630-4128915-11681869-513) -> Domain Users
Domain Guests (S-1-5-21-72630-4128915-11681869-514) -> Domain Guests
Print Operators (S-1-5-21-72630-4128915-11681869-550) -> Print Operators
Backup Operators (S-1-5-21-72630-4128915-11681869-551) -> Backup Operators
Replicator (S-1-5-21-72630-4128915-11681869-552) -> Replicator
Domain Computers (S-1-5-21-72630-4128915-11681869-553) -> Domain Computers
Engineers (S-1-5-21-72630-4128915-11681869-3005) -> Engineers
SupportEngrs (S-1-5-21-72630-4128915-11681869-3007) -> SupportEngrs
</screen>
	</para>

	</sect3>

	<sect3>
	<title>WindowsグループからUNIXグループへのマッピング</title>

	<para>
<indexterm><primary>mapped</primary></indexterm>
<indexterm><primary>Windowsグループ</primary></indexterm>
<indexterm><primary>システムグループ</primary></indexterm>
<indexterm><primary>アクセス制御</primary></indexterm>
	Windowsグループは、SambaサーバをホスティングしているOSに適した方法での首尾一貫
	した方法で主張できるファイルシステムのアクセス制御が出来るように、UNIXシステム
	(POSIX)グループにマップされる必要がある。
	</para>

	<para>
<indexterm><primary>access controls</primary></indexterm>
<indexterm><primary>UID</primary></indexterm>
<indexterm><primary>GID</primary></indexterm>
<indexterm><primary>locally known UID</primary></indexterm>
	SambaサーバをホスティングしているUNIX/Linuxサーバのファイルシステムで、すべての
	ファイルシステム(ファイルとディレクトリ)アクセス制御はUID/GID識別の組を使って
	実装される。SambaはUNIXファイルシステムの仕組みに優先したり、置き換えることは
	しない。これは、ファイルシステムにアクセスするすべてのWindowsネットワーク操作は、
	Windowsユーザから特定のUNIX/Linuxグループアカウントにマップするメカニズムを
	提供する。ユーザアカウントはローカルに知られているUIDにもマップする必要がある。
	<command>net</command>コマンドはここでは任意のRPC機能は呼び出さないが、passdbに
	直接アクセスすることに注意。
	</para>

	<para>
<indexterm><primary>既定値のマッピング</primary></indexterm>
<indexterm><primary>Domain Admins</primary></indexterm>
<indexterm><primary>Domain Users</primary></indexterm>
<indexterm><primary>Domain Guests</primary></indexterm>
<indexterm><primary>Windowsグループ</primary></indexterm>
<indexterm><primary>UNIXグループ</primary></indexterm>
<indexterm><primary>マッピング</primary></indexterm>
	Sambaは<constant>Domain Admins, Domain Users</constant>と
	<constant>Domain Guests</constant>グローバルグループの既定値のマッピングに
	依存する。追加のグループはサンプルで与えられた中でのように追加できる。存在する
	UNIXグループアカウントをWindowsグループにマップすることが必要なときがある。
	この操作は実際Windowsグループアカウントをマップ生成の結果として作成する。
	</para>

	<para>
<indexterm><primary>net</primary><secondary>groupmap</secondary><tertiary>modify</tertiary></indexterm>
<indexterm><primary>net</primary><secondary>groupmap</secondary><tertiary>add</tertiary></indexterm>
<indexterm><primary>net</primary><secondary>groupmap</secondary><tertiary>delete</tertiary></indexterm>
	<constant>add</constant>、<constant>modify</constant>と<constant>delete</constant>
	を含む操作が許可される。それぞれの操作の例はここで示される。
	</para>

	<note><para>
	Samba-3.0.23で始まるWindowsドメイングループは明示的に作成する必要がある。既定値
	では、すべてのUNIXグループはWindowsローカルグループとしてWindowsネットワーク
	に対して公開される。
	</para></note>

	<para>
	存在するUNIXグループは以下の例のようにして存在するWindowsグループにマップされる:
<screen>
&rootprompt; net groupmap modify ntgroup="Domain Users" unixgroup=users
</screen>
	存在するUNIXグループは以下の例のようにして新しいWindowsグループにマップされる:
<screen>
&rootprompt; net groupmap add ntgroup="EliteEngrs" unixgroup=Engineers type=d
</screen>
	サポートされているマッピングタイプは'd'(ドメイングローバル)と'l'(ドメインローカル)
	である。Windowsグループは削除でき、新しいWindowsグループは以下のコマンドでUNIX
	グループにマップ出来る:
<screen>
&rootprompt; net groupmap delete ntgroup=Engineers
&rootprompt; net groupmap add ntgroup=EngineDrivers unixgroup=Engineers type=d
</screen>
	削除と追加操作はWindowsグループかドメイングループとして知られている論理エントリ
	のみに影響する。操作は、UNIXシステムグループの削除も作成もしないので、UNIX
	システムグループには影響しない。UNIXグループからWindowsグループへのマッピングは、
	ドメインメンバクライアント上(ワークステーションとサーバ)のファイルとフォルダが、
	ドメインユーザとグループに対してドメイン全体のアクセス制御を得ることが出来る
	ようにするために、WindowsグループとしてWindowsグループを有効にさせる。
	</para>

	<para>
	<constant>domain(グローバル)</constant>と<constant>local</constant>という
	二種類のWindowsグループか作成できる。前者の例では、作成されたWindowsグループは
	<constant>domain</constant>かグローバルタイプである。以下のコマンドでは、
	<constant>local</constant>タイプのWindowsグループを作成する。
<screen>
&rootprompt; net groupmap add ntgroup=Pixies unixgroup=pixies type=l
</screen>
	サポートされているマッピングタイプは'd' (ドメイングローバル)と 'l' (ドメイン
	ローカル)で、Samba中でのドメインローカルグループは個別のSambaサーバに対する
	ローカルなものとして扱われる。ローカルグループは、複数ネストされたグループの
	サポートを有効にするためにSambaで使うことができる。
	</para>

	</sect3>

	<sect3>
	<title>グループアカウントの削除</title>

	<para>
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>group delete</tertiary></indexterm>
	グループアカウントは以下のコマンドで削除できる:
<screen>
&rootprompt; net rpc group delete SupportEngineers -Uroot%not24get
</screen>
	</para>

	<para>
	削除の検証は有効である。同じコマンドは以下で示されるように実行できる。
	</para>

	</sect3>

	<sect3>
	<title>グループアカウントの改名</title>

	<note><para>
	このコマンドはマニュアルページには記述がない。ソースコード上では実装されているが、
	現時点では動作しない。ソースコード上から得られた文書例は、どのようにそれが
	動くかを示す。これがいつ修正されるかを、今後のリリースにおけるリリースノート
	で確認すること(訳注:3.4.0でもマニュアルに記載はない)。
	</para></note>

	<para>
	時々グループアカウントの改名が必要なときがある。良い管理者は、この単純な要求が
	無視されるならば、何人かのマネージャの要求がどのくらい痛ましくなるかを知っている。
	以下のコマンドは、どのようにWindowsグループ<quote>SupportEngrs</quote>が
	<quote>CustomerSupport</quote>に改名できるかを示す:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>group rename</tertiary></indexterm>
<screen>
&rootprompt; net rpc group rename SupportEngrs \
    CustomerSupport -Uroot%not24get
</screen>
	</para>

	</sect3>

	</sect2>

	<sect2 id="grpmemshipchg">
	<title>グループメンバシップの操作</title>

	<para>
	3つの操作をグループメンバシップに関して行うことが出来る。それは、(1)Windows
	ユーザをWindowsグループに追加する、(2)WindowsグループからWindowsユーザを削除する、
	(3)Windowsグループに属するWindowsユーザを表示する である。
	</para>

	<para>
	混乱を防ぐため、何らかの変更を行う前に、グループメンバシップを確認することは
	意味がある。<command>getent group</command>はUNIX/Linuxのグループメンバシップを
	表示する。UNIX/Linuxグループメンバは<command>net groupmap</command>コマンド
	(<link linkend="groupmapping"/>を参照)で、マップされたWindowsグループのメンバ
	としても見ることができる。以下のUNIX/Linuxメンバシップは、<constant>ajt</constant>
	というユーザが<constant>Engineers</constant>というUNIX/Linuxのグループのメンバ
	であることを示している。
<screen>
&rootprompt; getent group
...
Domain Admins:x:512:root
Domain Users:x:513:jht,lct,ajt,met,vlendecke
Domain Guests:x:514:
Print Operators:x:550:
Backup Operators:x:551:
Replicator:x:552:
Domain Computers:x:553:
Engineers:x:1000:jht,ajt
</screen>
	WindowsグループにマップされたUNIX/Linuxのグループは以下のようになる:
<screen>
&rootprompt; net groupmap list
Domain Admins (S-1-5-21-72630-412605-116429-512) -> Domain Admins
Domain Users (S-1-5-21-72630-412605-116429-513) -> Domain Users
Domain Guests (S-1-5-21-72630-412605-116429-514) -> Domain Guests
Print Operators (S-1-5-21-72630-412605-116429-550) -> Print Operators
Backup Operators (S-1-5-21-72630-412605-116429-551) -> Backup Operators
Replicator (S-1-5-21-72630-412605-116429-552) -> Replicator
Domain Computers (S-1-5-21-72630-412605-116429-553) -> Domain Computers
Engineers (S-1-5-21-72630-412605-116429-3001) -> Engineers
</screen>
	</para>

	<para>
	与えられた<constant>ajt</constant>というユーザは、すでにUNIX/Linuxグループの
	メンバで、グループマッピング経由、Windowsグループのメンバで、このアカウントを
	再度追加する試みは失敗する。これのデモは以下の通り:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>group addmem</tertiary></indexterm>
<screen>
&rootprompt; net rpc group addmem "MIDEARTH\Engineers" ajt -Uroot%not24get
Could not add ajt to MIDEARTH\Engineers: NT_STATUS_MEMBER_IN_GROUP
</screen>
	これは、UNIX/LinuxグループとWindowsグループの間のグループマッピングは有効でかつ
	透過的であることを示している。
	</para>

	<para>
	ユーザ<constant>ajt</constant>を、<command>net rpc group</command>ユーティリティ
	を使って追加することを許可するために、このアカウントは最初に削除されねばならない。
	削除とその確認は以下のようになる:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>group delmem</tertiary></indexterm>
<screen>
&rootprompt; net rpc group delmem "MIDEARTH\Engineers" ajt -Uroot%not24get
&rootprompt; getent group Engineers
Engineers:x:1000:jht
&rootprompt; net rpc group members Engineers -Uroot%not24get
MIDEARTH\jht
</screen>
	この例2つの中で、UNIX/Linuxシステムレベルで、グループはもはや<constant>ajt</constant>
	をメンバとしてはいない。上記は又Windowsグループメンバシップの場合も示している。
	</para>

	<para>
	<command>net rpc group</command>ユーティリティを使ってアカウントは再度追加される:
<screen>
&rootprompt; net rpc group addmem "MIDEARTH\Engineers" ajt -Uroot%not24get
&rootprompt; getent group Engineers
Engineers:x:1000:jht,ajt
&rootprompt; net rpc group members Engineers -Uroot%not24get
MIDEARTH\jht
MIDEARTH\ajt
</screen>
	</para>

	<para>
	この例では、Windowsの<constant>Domain Users</constant>アカウントのメンバは
	<command>net rpc group</command>ユーティリティを使って検証される。この
	UNIX/Linuxグループの内容は4つ前のパラグラフで示されていることに注意。
	Windows(ドメイン)グループメンバシップは以下のようになる:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>group members</tertiary></indexterm>
<screen>
&rootprompt; net rpc group members "Domain Users" -Uroot%not24get
MIDEARTH\jht
MIDEARTH\lct
MIDEARTH\ajt
MIDEARTH\met
MIDEARTH\vlendecke
</screen>
	この特別な例は、Windowsグループ名が、大文字小文字を区別しない流儀で
	(Microsoft Windowsと同じ)Sambaによって扱われることを示す:
<screen>
&rootprompt; net rpc group members "DomAiN USerS" -Uroot%not24get
MIDEARTH\jht
MIDEARTH\lct
MIDEARTH\ajt
MIDEARTH\met
MIDEARTH\vlendecke
</screen>
	</para>

	<note><para>
	単純に<constant>Domain Users</constant>の代わりに
	<constant>MIDEARTH\Domain Users</constant>という形でグループ名を指定しても
	失敗する。net rpc group の既定値の動作はローカルマシンへコマンドの動作を
	行うからである。Windowsグループはマシンに対してローカルなように扱われる。
	もしも他のマシンに対して問い合わせが必要ならば、その名前は、
	<command>net</command>コマンドの<constant>-S servername</constant>
	パラメータを使って指定する。
	</para></note>

	</sect2>

	<sect2 id="nestedgrpmgmgt">
	<title>ネストされたグループのサポート</title>

	<para>
	ドメインユーザとドメイングループのメンバである(含む)ローカルグループを作成する
	ことはWindows(と現在はSambaも)で可能である。<constant>demo</constant>という
	ローカルグループは以下のようにして作成できる:
<screen>
&rootprompt; net rpc group add demo -L -S MORDON -Uroot%not24get
</screen>
	ここで、-L スイッチはローカルグループ作成を意味する。特定のサーバに対しての
	動作を行う場合は、 -S 引数を使う。-U引数はマシン上で適切な権限と権利を持つ
	ユーザを指定するのに使う。
	</para>

	<para>
	グループメンバの追加と削除は<command>net rpc group</command>コマンドの
	<constant>addmem</constant>と<constant>delmem</constant>サブコマンドを使う
	ことで行える。たとえば、ローカルグループ<constant>demo</constant>に対して
	<quote>DOM\Domain Users</quote>を追加するには以下のように行う:
<screen>
&rootprompt; net rpc group addmem demo "DOM\Domain Users" -Uroot%not24get
</screen>
	</para>

	<para>
	以下のようにして、ネストされたグループのメンバを表示することが出来る:
<screen>
&rootprompt; net rpc group members demo -Uroot%not24get
DOM\Domain Users
DOM\Engineers
DOM\jamesf
DOM\jht
</screen>
	</para>

	<para>
	ネストされたグループメンバは以下のようにして削除出来る:
<screen>
&rootprompt; net rpc group delmem demo "DOM\jht" -Uroot%not24get
</screen>
	</para>

	<sect3>
	<title>Sambaサーバからのワークステーション上のネストされたグループの管理</title>

	<para>
	Windowsネットワーク管理者はしばしばSambaメーリングリストに、個々のワーク
	ステーション上ですべての人に管理者権限を許可することが可能かと言うことを
	質問してくる。これは、もちろんとても悪い習慣ではあるが、一般的にユーザの不満を
	防ぐために行われる。個々では、どのようにSamba PDCまたはBDCからリモートでそれが
	出来るかを示す:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>group addmem</tertiary></indexterm>
<screen>
&rootprompt; net rpc group addmem "Administrators" "Domain Users" \
    -S WINPC032 -Uadministrator%secret
</screen>
	</para>

	<para>
	これはスクリプト化出来、そのためにWindowsワークステーションからドメインに
	ログオンするユーザとして実行できる。どのようにそれが行われるかの簡単な例を
	以下に示す。
	</para>

	<procedure>
	<title>ワークステーションの Power Usersグループへの自動的なユーザの追加</title>

		<step><para>
		<link linkend="autopoweruserscript"></link>で示されているスクリプトを
		作成し、<filename>autopoweruser.sh</filename>という名前で
		ディレクトリ<filename>/etc/samba/scripts</filename>中に配置する。
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>group addmem</tertiary></indexterm>
<indexterm><primary>autopoweruser.sh</primary></indexterm>
<indexterm><primary>/etc/samba/scripts</primary></indexterm>
		</para></step>

<example id="autopoweruserscript">
<title>ワークステーションのPower UsersグループにDomain Users を自動で追加するスクリプト</title>
<screen>
#!/bin/bash

/usr/bin/net rpc group addmem "Power Users" "DOMAIN_NAME\$1" \
                   -UAdministrator%secret -S $2

exit 0
</screen>
</example>

		<step><para>
		ログオンプロセスの一部として実行できるようにスクリプトにパーを設定する:
<screen>
&rootprompt; chown root:root /etc/samba/autopoweruser.sh
&rootprompt; chmod 755 /etc/samba/autopoweruser.sh
</screen>
		</para></step>

		<step><para>
		<link linkend="magicnetlogon">Netlogonのsmb.confファイルでの例</link>
		で示されるような<literal>NETLOGON</literal>セクションが含むパラメータ
		のように&smb.conf;ファイルを変更する。
		</para></step>

<example id="magicnetlogon">
<title>Magic Netlogon共有</title>
<smbconfblock>
<smbconfsection name="[netlogon]"/>
<smbconfoption name="comment">Netlogon Share</smbconfoption>
<smbconfoption name="path">/var/lib/samba/netlogon</smbconfoption>
<smbconfoption name="root preexec">/etc/samba/scripts/autopoweruser.sh %U %m</smbconfoption>
<smbconfoption name="read only">Yes</smbconfoption>
<smbconfoption name="guest ok">Yes</smbconfoption>
</smbconfblock>
</example>

		<step><para>
		すべてのWindowsワークステーション管理者アカウントが、
		<link linkend="magicnetlogon">Netlogonのsmb.confファイルでの例</link>
		にあるようなスクリプト中で使われるのと同じパスワードを持つようにする。
		</link>
		</para></step>

</procedure>

	<para>
	このスクリプトはユーザがネットワークにログオンする時には毎回実行される。
	そのため、すべてのユーザはローカルWindowsワークステーションの管理権限を
	持つ。これはもちろんグループを使って割り当てることが出来、その場合、
	この手続きの使用のためには微少な修正ですむ。この方法の使用のための修正
	点の肝心なところは、すべてのユーザがワークステーション上で適切な権限を
	持つことを保証することである。
	</para>

	</sect3>

	</sect2>

	</sect1>

	<sect1>
	<title>UNIXとWindowsのユーザ管理</title>

	<para>
<indexterm><primary>ユーザアカウント</primary></indexterm>
<indexterm><primary>UNIX/Linuxのユーザアカウント</primary></indexterm>
<indexterm><primary>UID</primary></indexterm>
<indexterm><primary>POSIXアカウント</primary></indexterm>
<indexterm><primary>レンジ</primary></indexterm>
<indexterm><primary>Windowsのユーザアカウント</primary></indexterm>
<indexterm><primary>winbindd</primary></indexterm>
<indexterm><primary>アカウント情報</primary></indexterm>
	すべてのWindowsネットワークユーザアカウントはUNIX/Linuxユーザアカウントに変換
	されねばならない。実際には、UNIX/LinuxのSambaサーバは、アカウント情報の内のUID
	のみを必要とする。UIDは、システム(POSIX)アカウントか、Windowsユーザアカウントに
	よって使われるために割り当てられる目的で予約されるUID番号の事前割当範囲(レンジ)
	から取得される。この場合、UID事前割当範囲(訳注:pool)の場合、特定のユーザに
	対するUIDは<command>winbindd</command>によって割り当てられる。
	</para>

	<para>
	ここは、異なった名前を持つUNIXアカウントにWindowsユーザアカウントをマッピング
	する重要な方法であ<smbconfoption name="username map"/>インタフェース機能を
	議論するのにふさわしい場所ではない。この機能についての詳細は&smb.conf;ファイルの
	マニュアルページを参照のこと。
	</para>

	<sect2 id="sbeuseraddn">
	<title>ユーザアカウントの追加</title>

	<para>
	<command>net</command>経由(詳細はマニュアルページ)でのユーザの追加は以下の通り:
<screen>
net [&lt;method&gt;] user ADD &lt;name&gt; [-c container] [-F user flags] \
    [misc. options] [targets]
</screen>
	ユーザアカウントのパスワードは以下の方法で設定できる:
<screen>
net rpc password &lt;username&gt; [&lt;password&gt;] -Uadmin_username%admin_pass
</screen>
	</para>

	<para>
	以下ではサーバ<constant>FRODO</constant>にアカウントを追加する例を示す:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>user add</tertiary></indexterm>
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>user password</tertiary></indexterm>
<screen>
&rootprompt; net rpc user add jacko -S FRODO -Uroot%not24get
Added user jacko
</screen>
	アカウントのパスワードは以下の方法で追加できる(すべて同じ操作を示す):
<screen>
&rootprompt; net rpc password jacko f4sth0rse -S FRODO -Uroot%not24get
&rootprompt; net rpc user password jacko f4sth0rse \
    -S FRODO -Uroot%not24get
</screen>
	</para>

	</sect2>

	<sect2>
	<title>ユーザアカウントの削除</title>

	<para>
	ユーザアカウントの削除方法は以下の通り:
<screen>
net [&lt;method&gt;] user DELETE &lt;name&gt; [misc. options] [targets]
</screen>
	以下ではユーザアカウント<constant>jacko</constant>を削除する:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>user delete</tertiary></indexterm>
<screen>
&rootprompt; net rpc user delete jacko -Uroot%not24get
Deleted user account
</screen>
	</para>

	</sect2>

	<sect2>
	<title>ユーザアカウントの管理</title>

	<para>
	2の基本的なユーザアカウント操作が定常的に使われる:パスワード変更とどのグループに
	ユーザが所属しているかの問い合わせである。パスワード変更操作は
	<link linkend="sbeuseraddn"/>の通り。
	</para>

	<para>
	Windowsグループのメンバシップの問い合わせ能力は基本的である。以下では、リモート
	サーバが、どのグループにユーザが属しているかを調べることが出来るかを示す:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>user info</tertiary></indexterm>
<screen>
&rootprompt; net rpc user info jacko -S SAURON -Uroot%not24get
net rpc user info jacko -S SAURON -Uroot%not24get
Domain Users
Domain Admins
Engineers
TorridGroup
BOP Shop
Emergency Services
</screen>
	</para>

	<para>
	古いユーザ名から新しいユーザ名へのユーザアカウントの改名も可能である。ただし、この操作はSambaサーバに対しては動作しないことに注意。しかし、ユーザ名の改名はWindowsサーバでは可能である。
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>user rename</tertiary></indexterm>

	</para>

	</sect2>

	<sect2>
	<title>ユーザのマッピング</title>

	<para>
<indexterm><primary>ログイン名</primary></indexterm>
<indexterm><primary>/etc/samba/smbusers</primary></indexterm>
<indexterm><primary>username map</primary></indexterm>
	ある条件下で、ユーザのWindowsにおけるログオン名はSambaサーバ上で持つユーザの
	ログインIDと異なることは避けられない。Sambaサーバ上で、Windowsユーザ名を
	異なったUNIX/Linuxユーザ名にマップできる特別なファイルを作ることが出来る。
	&smb.conf;ファイルも、<constant>[global]</constant>セクションで以下の
	パラメータを含むように変更しなければならない。
<screen>
username map = /etc/samba/smbusers
</screen>
	<filename>/etc/samba/smbusers</filename>ファイルの内容は以下の通り:
<screen>
parsonsw: "William Parsons"
marygee: geeringm
</screen>
	この例では、Windowsユーザアカウント<quote>William Parsons</quote>はUNIXユーザ
	<constant>parsonsw</constant>にマップされ、Windowsユーザアカウント
	<quote>geeringm</quote>はUNIXユーザconstant>marygee</constant>にマップされる。
	</para>

	</sect2>

	</sect1>

	<sect1>
	<title>管理ユーザの権限と権利</title>

	<para>
<indexterm><primary>credentials</primary></indexterm>
<indexterm><primary>プリンタ管理</primary></indexterm>
<indexterm><primary>共有管理</primary></indexterm>
<indexterm><primary>グループ管理</primary></indexterm>
<indexterm><primary>ユーザ管理</primary></indexterm>
	3.0.11より前のすべてのSambaは、Sambaサーバ上で、ユーザ、グループ、共有、プリンタ
	とその他の管理を行うのに、<constant>root</constant>アカウントしか使えなかった。
	これは、何人かのユーザには問題を引き起こし、しばしばUNIX/Linuxシステム上で、最も
	セキュリティに敏感なアカウントの権限を渡す必要があるという弱点の元であった。
	</para>

	<para>
<indexterm><primary>管理者権限の委譲</primary></indexterm>
<indexterm><primary>通常のユーザ</primary></indexterm>
<indexterm><primary>権利と権限</primary></indexterm>
<indexterm><primary>特権管理</primary></indexterm>
<indexterm><primary>ユーザのグループ</primary></indexterm>
	Sambaバージョン3.0.11から、ユーザまたはユーザが属するグループに対して必要に応じて
	管理者権限を委譲する機能が加わった。管理者特権の重要性は<link linkend="rights"/>に
	説明がある。ユーザ権限と権利管理に関する<command>net</command>コマンドの使用例は
	この章の適切な箇所にある。
	</para>

	<note><para>
	ユーザ権限と権利が正しく設定した場合、UNIX UID=0である<constant>root</constant>ユーザ
	(およびその同義語)のためのWindowsネットワークアカウントの必要がなくなる。初期のユーザ
	権限と権利は、<constant>Domain Admins</constant>グループのメンバの任意のアカウントに
	割り当てることが出来る。権利はグループアカウントと同じように割り当てられる。
	</para></note>

	<para>
	既定値では、何らの権利と権限も割り当てられない。これは以下のコマンドを実行する
	ことで以下のように表示される:
<screen>
&rootprompt; net rpc rights list accounts -U root%not24get
BUILTIN\Print Operators
No privileges assigned

BUILTIN\Account Operators
No privileges assigned

BUILTIN\Backup Operators
No privileges assigned

BUILTIN\Server Operators
No privileges assigned

BUILTIN\Administrators
No privileges assigned

Everyone
No privileges assigned
</screen>
	</para>

	<para>
	<command>net</command>コマンドは、以下の方法で現在サポートされている権利と
	権限を得るのに使える:
<indexterm><primary>SeMachineAccountPrivilege</primary></indexterm>
<indexterm><primary>SePrintOperatorPrivilege</primary></indexterm>
<indexterm><primary>SeAddUsersPrivilege</primary></indexterm>
<indexterm><primary>SeRemoteShutdownPrivilege</primary></indexterm>
<indexterm><primary>SeDiskOperatorPrivilege</primary></indexterm>
<indexterm><primary>SeBackupPrivilege</primary></indexterm>
<indexterm><primary>SeRestorePrivilege</primary></indexterm>
<indexterm><primary>SeTakeOwnershipPrivilege</primary></indexterm>
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>rights list</tertiary></indexterm>
<screen>
&rootprompt; net rpc rights list -U root%not24get
     SeMachineAccountPrivilege  Add machines to domain
      SePrintOperatorPrivilege  Manage printers
           SeAddUsersPrivilege  Add users and groups to the domain
     SeRemoteShutdownPrivilege  Force shutdown from a remote system
       SeDiskOperatorPrivilege  Manage disk shares
             SeBackupPrivilege  Back up files and directories
            SeRestorePrivilege  Restore files and directories
      SeTakeOwnershipPrivilege  Take ownership of files or other objects
</screen>
	Machine account権限は、Windows NT4以降のネットワーククライアントをドメインに
	参加させるために必要である。disk operator権限は、ユーザが所有していない
	オブジェクトの、共有のACLとファイルとディレクトリのACLを管理するために必要である。
	</para>

	<para>
	この例では、すべての権利は<constant>Domain Admins</constant>グループに割り当てられる。これは、このグループのメンバが通常全権を有することになっている。この割り当ては以下のようになっている:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>rights grant</tertiary></indexterm>
<screen>
&rootprompt; net rpc rights grant "MIDEARTH\Domain Admins" \
    SeMachineAccountPrivilege SePrintOperatorPrivilege \
    SeAddUsersPrivilege SeRemoteShutdownPrivilege \
    SeDiskOperatorPrivilege  -U root%not24get
Successfully granted rights.
</screen>
	Next, the domain user <constant>jht</constant> is given the privileges needed for day-to-day
	administration:
<screen>
&rootprompt; net rpc rights grant "MIDEARTH\jht" \
    SeMachineAccountPrivilege SePrintOperatorPrivilege \
    SeAddUsersPrivilege SeDiskOperatorPrivilege \
    -U root%not24get
Successfully granted rights.
</screen>
	</para>

	<para>
	The following step permits validation of the changes just made:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>rights list accounts</tertiary></indexterm>
<screen>
&rootprompt; net rpc rights list accounts -U root%not24get
MIDEARTH\jht
SeMachineAccountPrivilege
SePrintOperatorPrivilege
SeAddUsersPrivilege
SeDiskOperatorPrivilege

BUILTIN\Print Operators
No privileges assigned

BUILTIN\Account Operators
No privileges assigned

BUILTIN\Backup Operators
No privileges assigned

BUILTIN\Server Operators
No privileges assigned

BUILTIN\Administrators
No privileges assigned

Everyone
No privileges assigned

MIDEARTH\Domain Admins
SeMachineAccountPrivilege
SePrintOperatorPrivilege
SeAddUsersPrivilege
SeRemoteShutdownPrivilege
SeDiskOperatorPrivilege
</screen>
	</para>

	</sect1>

	<sect1>
	<title>Managing Trust Relationships</title>

	<para>
	There are essentially two types of trust relationships: the first is between domain controllers and domain
	member machines (network clients), the second is between domains (called interdomain trusts). All
	Samba servers that participate in domain security require a domain membership trust account, as do like
	Windows NT/200x/XP workstations.
	</para>

	<sect2>
	<title>Machine Trust Accounts</title>

	<para>
	The net command looks in the &smb.conf; file to obtain its own configuration settings. Thus, the following
	command 'knows' which domain to join from the &smb.conf; file.
	</para>

	<para>
	A Samba server domain trust account can be validated as shown in this example:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>testjoin</tertiary></indexterm>
<screen>
&rootprompt; net rpc testjoin
Join to 'MIDEARTH' is OK
</screen>
	Where there is no domain membership account, or when the account credentials are not valid, the following
	results will be observed:
<screen>
net rpc testjoin -S DOLPHIN
Join to domain 'WORLDOCEAN' is not valid
</screen>
	</para>

	<para>
	The equivalent command for joining a Samba server to a Windows ADS domain is shown here:
<indexterm><primary>net</primary><secondary>ads</secondary><tertiary>testjoin</tertiary></indexterm>
<screen>
&rootprompt; net ads testjoin
Using short domain name -- TAKEAWAY
Joined 'LEMONADE' to realm 'TAKEAWAY.BIZ'
</screen>
	In the event that the ADS trust was not established, or is broken for one reason or another, the following
	error message may be obtained:
<screen>
&rootprompt; net ads testjoin -UAdministrator%secret
Join to domain is not valid
</screen>
	</para>

	<para>
	The following demonstrates the process of creating a machine trust account in the target domain for the
	Samba server from which the command is executed:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>join</tertiary></indexterm>
<screen>
&rootprompt; net rpc join -S FRODO -Uroot%not24get
Joined domain MIDEARTH.
</screen>
	The joining of a Samba server to a Samba domain results in the creation of a machine account. An example
	of this is shown here:
<screen>
&rootprompt; pdbedit -Lw merlin\$
merlin$:1009:9B4489D6B90461FD6A3EC3AB96147E16:\
176D8C554E99914BDF3407DEA2231D80:[S          ]:LCT-42891919:
</screen>
	The S in the square brackets means this is a server (PDC/BDC) account. The domain join can be cast to join
	purely as a workstation, in which case the S is replaced with a W (indicating a workstation account). The
	following command can be used to affect this:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>join member</tertiary></indexterm>
<screen>
&rootprompt; net rpc join member -S FRODO -Uroot%not24get
Joined domain MIDEARTH.
</screen>
	Note that the command-line parameter <constant>member</constant> makes this join specific. By default
	the type is deduced from the &smb.conf; file configuration. To specifically join as a PDC or BDC, the
	command-line parameter will be <constant>[PDC | BDC]</constant>. For example:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>join bdc</tertiary></indexterm>
<screen>
&rootprompt; net rpc join bdc -S FRODO -Uroot%not24get
Joined domain MIDEARTH.
</screen>
	It is best to let Samba figure out the domain join type from the settings in the &smb.conf; file.
	</para>

	<para>
	The command to join a Samba server to a Windows ADS domain is shown here:
<indexterm><primary>net</primary><secondary>ads</secondary><tertiary>join</tertiary></indexterm>
<screen>
&rootprompt; net ads join -UAdministrator%not24get
Using short domain name -- GDANSK
Joined 'FRANDIMITZ' to realm 'GDANSK.ABMAS.BIZ'
</screen>
	</para>

	<para>
	There is no specific option to remove a machine account from an NT4 domain. When a domain member that is a
	Windows machine is withdrawn from the domain, the domain membership account is not automatically removed
	either. Inactive domain member accounts can be removed using any convenient tool. If necessary, the
	machine account can be removed using the following <command>net</command> command:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>user delete</tertiary></indexterm>
<screen>
&rootprompt; net rpc user delete HERRING\$ -Uroot%not24get
Deleted user account.
</screen>
	The removal is made possible because machine accounts are just like user accounts with a trailing $
	character. The account management operations treat user and machine accounts in like manner.
	</para>

	<para>
	A Samba-3 server that is a Windows ADS domain member can execute the following command to detach from the
	domain:
<indexterm><primary>net</primary><secondary>ads</secondary><tertiary>leave</tertiary></indexterm>
<screen>
&rootprompt; net ads leave
</screen>
	</para>

	<para>
	Detailed information regarding an ADS domain can be obtained by a Samba DMS machine by executing the
	following:
<indexterm><primary>net</primary><secondary>ads</secondary><tertiary>status</tertiary></indexterm>
<screen>
&rootprompt; net ads status
</screen>
	The volume of information is extensive. Please refer to the book <quote>Samba-3 by Example</quote>,
	Chapter 7 for more information regarding its use. This book may be obtained either in print or online from
	the <ulink url="http://www.samba.org/samba/docs/Samba3-ByExample.pdf">Samba-3 by Example</ulink>.
	</para>

	</sect2>

	<sect2>
	<title>Interdomain Trusts</title>

	<para>
	Interdomain trust relationships form the primary mechanism by which users from one domain can be granted
	access rights and privileges in another domain. 
	</para>

	<para>
	To discover what trust relationships are in effect, execute this command:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>trustdom list</tertiary></indexterm>
<screen>
&rootprompt; net rpc trustdom list -Uroot%not24get
Trusted domains list:

none

Trusting domains list:

none
</screen>
	There are no interdomain trusts at this time; the following steps will create them.
	</para>

	<para>
	It is necessary to create a trust account in the local domain. A domain controller in a second domain can
	create a trusted connection with this account. That means that the foreign domain is being trusted
	to access resources in the local domain. This command creates the local trust account:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>trustdom add</tertiary></indexterm>
<screen>
&rootprompt; net rpc trustdom add DAMNATION f00db4r -Uroot%not24get
</screen>
	The account can be revealed by using the <command>pdbedit</command> as shown here:
<screen>
&rootprompt; pdbedit -Lw DAMNATION\$
DAMNATION$:1016:9AC1F121DF897688AAD3B435B51404EE: \
7F845808B91BB9F7FEF44B247D9DC9A6:[I         ]:LCT-428934B1:
</screen>
	A trust account will always have an I in the field within the square brackets.
	</para>

	<para>
	If the trusting domain is not capable of being reached, the following command will fail:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>trustdom list</tertiary></indexterm>
<screen>
&rootprompt; net rpc trustdom list -Uroot%not24get
Trusted domains list:

none

Trusting domains list:

DAMNATION           S-1-5-21-1385457007-882775198-1210191635
</screen>
	The above command executed successfully; a failure is indicated when the following response is obtained:
<screen>
net rpc trustdom list -Uroot%not24get
Trusted domains list:

DAMNATION           S-1-5-21-1385457007-882775198-1210191635

Trusting domains list:

DAMNATION           domain controller is not responding
</screen>
	</para>

	<para>
	Where a trust account has been created on a foreign domain, Samba is able to establish the trust (connect with)
	the foreign account. In the process it creates a one-way trust to the resources on the remote domain. This
	command achieves the objective of joining the trust relationship:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>trustdom establish</tertiary></indexterm>
<screen>
&rootprompt; net rpc trustdom establish DAMNATION
Password: xxxxxxx	== f00db4r
Could not connect to server TRANSGRESSION
Trust to domain DAMNATION established
</screen>
	Validation of the two-way trust now established is possible as shown here:
<screen>
&rootprompt; net rpc trustdom list -Uroot%not24get
Trusted domains list:

DAMNATION           S-1-5-21-1385457007-882775198-1210191635

Trusting domains list:

DAMNATION           S-1-5-21-1385457007-882775198-1210191635
</screen>
	</para>

	<para>
	Sometimes it is necessary to remove the ability for local users to access a foreign domain. The trusting
	connection can be revoked as shown here:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>trustdom revoke</tertiary></indexterm>
<screen>
&rootprompt; net rpc trustdom revoke DAMNATION -Uroot%not24get
</screen>
	At other times it becomes necessary to remove the ability for users from a foreign domain to be able to
	access resources in the local domain. The command shown here will do that:
<screen>
&rootprompt; net rpc trustdom del DAMNATION -Uroot%not24get
</screen>

	</para>

	</sect2>

	</sect1>

	<sect1>
	<title>Managing Security Identifiers (SIDS)</title>

	<para>
<indexterm><primary>security identifier</primary></indexterm>
<indexterm><primary>SID</primary></indexterm>
<indexterm><primary>desktop profiles</primary></indexterm>
<indexterm><primary>user encoded</primary></indexterm>
<indexterm><primary>group SID</primary></indexterm>
	The basic security identifier that is used by all Windows networking operations is the Windows security
	identifier (SID). All Windows network machines (servers and workstations), users, and groups are
	identified by their respective SID. All desktop profiles are also encoded with user and group SIDs that
	are specific to the SID of the domain to which the user belongs.
	</para>

	<para>
<indexterm><primary>machine SID</primary></indexterm>
<indexterm><primary>domain SID</primary></indexterm>
<indexterm><primary>SID</primary></indexterm>
<indexterm><primary>rejoin</primary></indexterm>
	It is truly prudent to store the machine and/or domain SID in a file for safekeeping. Why? Because 
	a change in hostname or in the domain (workgroup) name may result in a change in the SID. When you
	have the SID on hand, it is a simple matter to restore it. The alternative is to suffer the pain of
	having to recover user desktop profiles and perhaps rejoin all member machines to the domain.
	</para>

	<para>
	First, do not forget to store the local SID in a file. It is a good idea to put this in the directory
	in which the &smb.conf; file is also stored. Here is a simple action to achieve this:
<indexterm><primary>net</primary><secondary>getlocalsid</secondary></indexterm>
<screen>
&rootprompt; net getlocalsid > /etc/samba/my-sid
</screen>
	Good, there is now a safe copy of the local machine SID. On a PDC/BDC this is the domain SID also.
	</para>

	<para>
	The following command reveals what the former one should have placed into the file called
	<filename>my-sid</filename>:
<screen>
&rootprompt; net getlocalsid
SID for domain MERLIN is: S-1-5-21-726309263-4128913605-1168186429
</screen>
	</para>

	<para>
	If ever it becomes necessary to restore the SID that has been stored in the <filename>my-sid</filename>
	file, simply copy the SID (the string of characters that begins with <constant>S-1-5-21</constant>) to
	the command line shown here:
<indexterm><primary>net</primary><secondary>setlocalsid</secondary></indexterm>
<screen>
&rootprompt; net setlocalsid S-1-5-21-1385457007-882775198-1210191635
</screen>
	Restoration of a machine SID is a simple operation, but the absence of a backup copy can be very
	problematic.
	</para>

	<para>
	The following operation is useful only for machines that are being configured as a PDC or a BDC.
	DMS and workstation clients should have their own machine SID to avoid
	any potential namespace collision. Here is the way that the BDC SID can be synchronized to that
	of the PDC (this is the default NT4 domain practice also):
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>getsid</tertiary></indexterm>
<screen>
&rootprompt; net rpc getsid -S FRODO -Uroot%not24get
Storing SID S-1-5-21-726309263-4128913605-1168186429 \
    for Domain MIDEARTH in secrets.tdb
</screen>
	Usually it is not necessary to specify the target server (-S FRODO) or the administrator account
	credentials (-Uroot%not24get).
	</para>

	</sect1>
	
	<sect1>
	<title>Share Management</title>

	<para>
	Share management is central to all file serving operations. Typical share operations include:
	</para>

	<itemizedlist>
		<listitem><para>Creation/change/deletion of shares</para></listitem>
		<listitem><para>Setting/changing ACLs on shares</para></listitem>
		<listitem><para>Moving shares from one server to another</para></listitem>
		<listitem><para>Change of permissions of share contents</para></listitem>
	</itemizedlist>

	<para>
	Each of these are dealt with here insofar as they involve the use of the <command>net</command>
	command. Operations outside of this command are covered elsewhere in this document.
	</para>

	<sect2>
	<title>Creating, Editing, and Removing Shares</title>

	<para>
	A share can be added using the <command>net rpc share</command> command capabilities.
	The target machine may be local or remote and is specified by the -S option. It must be noted
	that the addition and deletion of shares using this tool depends on the availability of a suitable
	interface script. The interface scripts Sambas <command>smbd</command> uses are called
	<smbconfoption name="add share command"/>, <smbconfoption name="delete share command"/> and
	<smbconfoption name="change share command"/> A set of example scripts are provided in the Samba source
	code tarball in the directory <filename>~samba/examples/scripts</filename>.
	</para>

	<para>
	The following steps demonstrate the use of the share management capabilities of the <command>net</command>
	utility. In the first step a share called <constant>Bulge</constant> is added. The sharepoint within the
	file system is the directory <filename>/data</filename>. The command that can be executed to perform the
	addition of this share is shown here:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>share add</tertiary></indexterm>
<screen>
&rootprompt; net rpc share add Bulge=/data -S MERLIN -Uroot%not24get
</screen>
	Validation is an important process, and by executing the command <command>net rpc share</command>
	with no other operators it is possible to obtain a listing of available shares, as shown here:
<screen>
&rootprompt; net rpc share -S MERLIN -Uroot%not24get
profdata
archive
Bulge   &lt;--- This one was added
print$
netlogon
profiles
IPC$
kyocera
ADMIN$
</screen>
	</para>

	<para>
	Often it is desirable also to permit a share to be removed using a command-line tool.
	The following step permits the share that was previously added to be removed:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>share delete</tertiary></indexterm>
<screen>
&rootprompt; net rpc share delete Bulge -S MERLIN -Uroot%not24get
</screen>
	A simple validation shown here demonstrates that the share has been removed:
<screen>
&rootprompt; net rpc share -S MERLIN -Uroot%not24get
profdata
archive
print$
netlogon
profiles
IPC$
ADMIN$
kyocera
</screen>
	</para>

	</sect2>

	<sect2>
	<title>Creating and Changing Share ACLs</title>

	<para>
	At this time the <command>net</command> tool cannot be used to manage ACLs on Samba shares. In MS Windows 
	language this is called Share Permissions.
	</para>

	<para>
	It is possible to set ACLs on Samba shares using either the SRVTOOLS NT4 Domain Server Manager
	or using the Computer Management MMC snap-in. Neither is covered here,
	but see <link linkend="AccessControls"/>.
	</para>

	</sect2>

	<sect2>
	<title>Share, Directory, and File Migration</title>

	<para>
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>vampire</tertiary></indexterm>
	Shares and files can be migrated in the same manner as user, machine, and group accounts.
	It is possible to preserve access control settings (ACLs) as well as security settings
	throughout the migration process. The <command>net rpc vampire</command> facility is used
	to migrate accounts from a Windows NT4 (or later) domain to a Samba server. This process
	preserves passwords and account security settings and is a precursor to the migration
	of shares and files.
	</para>

	<para>
	The <command>net rpc share</command> command may be used to migrate shares, directories,
	files, and all relevant data from a Windows server to a Samba server.
	</para>

	<para>
	A set of command-line switches permit the creation of almost direct clones of Windows file
	servers. For example, when migrating a fileserver, file ACLs and DOS file attributes from
	the Windows server can be included in the migration process and will reappear, almost identically,
	on the Samba server when the migration has been completed.
	</para>

	<para>
	The migration process can be completed only with the Samba server already being fully operational.
	The user and group accounts must be migrated before attempting to migrate data
	share, files, and printers. The migration of files and printer configurations involves the use
	of both SMB and MS DCE RPC services. The benefit of the manner in which the migration process has
	been implemented is that the possibility now exists to use a Samba server as a man-in-middle migration
	service that affects a transfer of data from one server to another. For example, if the Samba
	server is called MESSER, the source Windows NT4 server is called PEPPY, and the target Samba
	server is called GONZALES, the machine MESSER can be used to effect the migration of all data
	(files and shares) from PEPPY to GONZALES. If the target machine is not specified, the local
	server is assumed by default - as net's general rule of thumb .
	</para>

	<para>
	The success of server migration requires a firm understanding of the structure of the source
	server (or domain) as well as  the processes on which the migration is critically dependant.
	</para>

	<para>
	There are two known limitations to the migration process:
	</para>

	<orderedlist>
		<listitem><para>
		The <command>net</command> command requires that the user credentials provided exist on both
		the migration source and the migration target.
		</para></listitem>

		<listitem><para>
		Printer settings may not be fully or may be incorrectly migrated. This might in particular happen
		when migrating a Windows 2003 print server to Samba.
		</para></listitem>
	</orderedlist>

	<sect3>
	<title>Share Migration</title>

	<para>
	The <command>net rpc share migrate</command> command operation permits the migration of plain
	share stanzas. A stanza contains the parameters within which a file or print share are defined.
	The use of this migration method will create share stanzas that have as parameters the file
	system directory path, an optional description, and simple security settings that permit write
	access to files. One of the first steps necessary following migration is to review the share
	stanzas to ensure that the settings are suitable for use.
	</para>

	<para>
	The shares are created on the fly as part of the migration process. The <command>smbd</command>
	application does this by calling on the operating system to execute the script specified by the 
	&smb.conf; parameter <parameter>add share command</parameter>.
	</para>

	<para>
	There is a suitable example script for the <parameter>add share command</parameter> in the
	<filename>$SAMBA_SOURCES/examples/scripts</filename> directory. It should be noted that
	the account that is used to drive the migration must, of necessity, have appropriate file system
	access privileges and have the right to create shares and to set ACLs on them. Such rights are
	conferred by these rights: <parameter>SeAddUsersPrivilege</parameter> and <parameter>SeDiskOperatorPrivilege</parameter>.
	For more information regarding rights and privileges please refer to <link linkend="rights"/>.
	</para>

	<para>
	The syntax of the share migration command is shown here:
<screen>
net rpc share MIGRATE SHARES &lt;share-name&gt; -S &lt;source&gt;
        [--destination=localhost] [--exclude=share1,share2] [-v]
</screen>
	When the parameter &lt;share-name&gt; is omitted, all shares will be migrated. The potentially
	large list of available shares on the system that is being migrated can be limited using the
	<parameter>--exclude</parameter> switch. For example:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>share migrate</tertiary></indexterm>
<screen>
&rootprompt; net rpc share migrate shares myshare\
         -S win2k -U administrator%secret"
</screen>
	This will migrate the share <constant>myshare</constant> from the server <constant>win2k</constant>
	to the Samba Server using the permissions that are tied to the account <constant>administrator</constant> 
	with the password <constant>secret</constant>. The account that is used must be the same on both the
	migration source server and the target Samba server. The use of the <command>net rpc
	vampire</command>, prior to attempting the migration of shares, will ensure that accounts will be
	identical on both systems. One precaution worth taking before commencement of migration of shares is
	to validate that the migrated accounts (on the Samba server) have the needed rights and privileges.
	This can be done as shown here:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>right list accounts</tertiary></indexterm>
<screen>
&rootprompt; net rpc right list accounts -Uroot%not24get
</screen>
	The steps taken so far perform only the migration of shares. Directories and directory contents
	are not migrated by the steps covered up to this point.
	</para>

	</sect3>

	<sect3>
	<title>File and Directory Migration</title>

	<para>
	Everything covered to this point has been done in preparation for the migration of file and directory
	data. For many people preparation is potentially boring and the real excitement only begins when file
	data can be used. The next steps demonstrate the techniques that can be used to transfer (migrate)
	data files using the <command>net</command> command.
	</para>

	<para>
	Transfer of files from one server to another has always been a challenge for MS Windows
	administrators because Windows NT and 200X servers do not always include the tools needed. The
	<command>xcopy</command> from Windows NT is not capable of preserving file and directory ACLs, 
	it does so only with Windows 200x. Microsoft does provide a
	utility that can copy ACLs (security settings) called <command>scopy</command>, but it is provided only
	as part of the Windows NT or 200X Server Resource Kit.
	</para>

	<para>
	There are several tools, both commercial and freeware, that can be used from a Windows server to copy files
	and directories with full preservation of security settings. One of the best known of the free tools is
	called <command>robocopy</command>.
	</para>

	<para>
	The <command>net</command> utility can be used to copy files and directories with full preservation of
	ACLs as well as DOS file attributes. Note that including ACLs makes sense only where the destination
	system will operate within the same security context as the source system. This applies both to a
	DMS and to domain controllers that result from a vampired domain.
	Before file and directory migration, all shares must already exist.
	</para>

	<para>
	The syntax for the migration commands is shown here:
<screen>
net rpc share MIGRATE FILES &lt;share-name&gt; -S &lt;source&gt;
    [--destination=localhost] [--exclude=share1,share2]
    [--acls] [--attrs] [--timestamps] [-v]
</screen>
	If the &lt;share-name&gt; parameter is omitted, all shares will be migrated. The potentially large
	list of shares on the source system can be restricted using the <parameter>--exclude</parameter> command
	switch.
	</para>

	<para>
	Where it is necessary to preserve all file ACLs, the <parameter>--acls</parameter> switch should be added
	to the above command line. Original file timestamps can be preserved by specifying the
	<parameter>--timestamps</parameter> switch, and the DOS file attributes (i.e., hidden, archive, etc.) can
	be preserved by specifying the <parameter>--attrs</parameter> switch.
	</para>

	<note><para>
	The ability to preserve ACLs depends on appropriate support for ACLs as well as the general file system
	semantics of the host operating system on the target server. A migration from one Windows file server to
	another will perfectly preserve all file attributes. Because of the difficulty of mapping Windows ACLs
	onto a POSIX ACLs-supporting system, there can be no perfect migration of Windows ACLs to a Samba server.
	</para></note>

	<para>
	The ACLs that result on a Samba server will most probably not match the originating ACLs. Windows supports
	the possibility of files that are owned only by a group. Group-alone file ownership is not possible under
	UNIX/Linux. Errors in migrating group-owned files can be avoided by using the &smb.conf; file
	<smbconfoption name="force unknown acl user">yes</smbconfoption> parameter. This facility will
	automatically convert group-owned files into correctly user-owned files on the Samba server.
	</para>

	<para>
	An example for migration of files from a machine called <constant>nt4box</constant> to the Samba server
	from which the process will be handled is shown here:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>share migrate files</tertiary></indexterm>
<screen>
&rootprompt; net rpc share migrate files -S nt4box --acls \
    --attrs -U administrator%secret
</screen>
	</para>

	<para>
	This command  will migrate all files and directories from all file shares on the Windows server called
	<constant>nt4box</constant> to the Samba server from which migration is initiated. Files that are group-owned
	will be owned by the user account <constant>administrator</constant>.
	</para>

	</sect3>
	
	<sect3>
	<title>Share-ACL Migration</title>
	<para>
	It is possible to have share-ACLs (security descriptors) that won't allow you, even as Administrator, to
	copy any files or directories into it. Therefor the migration of the share-ACLs has been put into a separate
	function:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>share migrate security</tertiary></indexterm>
<screen>
&rootprompt; net rpc share migrate security -S nt4box -U administrator%secret
</screen>
	</para>

	<para>
	This command will only copy the share-ACL of each share on nt4box to your local samba-system.
	</para>
	</sect3>

	<sect3>
	<title>Simultaneous Share and File Migration</title>

	<para>
	The operating mode shown here is just a combination of the previous three. It first migrates
	share definitions and then all shared files and directories and finally migrates the share-ACLs:
<screen>
net rpc share MIGRATE ALL &lt;share-name&gt; -S &lt;source&gt;
    [--exclude=share1, share2] [--acls] [--attrs] [--timestamps] [-v]
</screen>
	</para>

	<para>
	An example of simultaneous migration is shown here:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>share migrate all</tertiary></indexterm>
<screen>
&rootprompt; net rpc share migrate all -S w2k3server -U administrator%secret
</screen>
	This will generate a complete server clone of the <parameter>w2k3server</parameter> server.
	</para>

	</sect3>

	</sect2>

	<sect2>
	<title>Printer Migration</title>

	<para>
	The installation of a new server, as with the migration to a new network environment, often is similar to
	building a house; progress is very rapid from the laying of foundations up to the stage at which
	the house can be locked up, but the finishing off appears to take longer and longer as building
	approaches completion.
	</para>

	<para>
	Printing needs vary greatly depending on the network environment and may be very simple or complex. If
	the need is very simple, the best solution to the implementation of printing support may well be to
	re-install everything from a clean slate instead of migrating older configurations. On the other hand,
	a complex network that is integrated with many international offices and a multiplexity of local branch
	offices, each of which form an inter-twined maze of printing possibilities, the ability to migrate all
	printer configurations is decidedly beneficial. To manually re-establish a complex printing network
	will take much time and frustration. Often it will not be possible to find driver files that are
	currently in use, necessitating the installation of newer drivers. Newer drivers often implement
	printing features that will necessitate a change in the printer usage. Additionally, with very complex
	printer configurations it becomes almost impossible to re-create the same environment &smbmdash; no matter
	how extensively it has been documented.
	</para>

	<para>
	The migration of an existing printing architecture involves the following:
	</para>

	<itemizedlist>
		<listitem><para>Establishment of print queues.</para></listitem>

		<listitem><para>Installation of printer drivers (both for the print server and for Windows clients.</para></listitem>

		<listitem><para>Configuration of printing forms.</para></listitem>

		<listitem><para>Implementation of security settings.</para></listitem>

		<listitem><para>Configuration of printer settings.</para></listitem>
	</itemizedlist>

	<para>
	The Samba <command>net</command> utility permits printer migration from one Windows print server
	to another. When this tool is used to migrate printers to a Samba server <command>smbd</command>,
	the application that receives the network requests to create the necessary services must call out
	to the operating system in order to create the underlying printers. The call-out is implemented
	by way of an interface script that can be specified by the &smb.conf; file parameter
	<smbconfoption id="add printer script"/>. This script is essential to the migration process.
	A suitable example script may be obtained from the <filename>$SAMBA_SOURCES/examples/scripts</filename>
	directory. Take note that this script must be customized to suit the operating system environment
	and may use its tools to create a print queue.
	</para>

	<para>
	Each of the components listed above can be completed separately, or they can be completed as part of an
	automated operation. Many network administrators prefer to deal with migration issues in a manner that
	gives them the most control, particularly when things go wrong. The syntax for each operation is now
	briefly described.
	</para>

	<para>
	Printer migration from a Windows print server (NT4 or 200x) is shown. This instruction causes the
	printer share to be created together with the underlying print queue:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>printer migrate printers</tertiary></indexterm>
<screen>
net rpc printer MIGRATE PRINTERS [printer] [misc. options] [targets]
</screen>
	Printer drivers can be migrated from the Windows print server to the Samba server using this
	command-line instruction:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>printer migrate drivers</tertiary></indexterm>
<screen>
net rpc printer MIGRATE DRIVERS [printer] [misc. options] [targets]
</screen>
	Printer forms can be migrated with the following operation:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>printer migrate forms</tertiary></indexterm>
<screen>
net rpc printer MIGRATE FORMS [printer] [misc. options] [targets]
</screen>
	Printer security settings (ACLs) can be migrated from the Windows server to the Samba server using this command:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>printer migrate security</tertiary></indexterm>
<screen>
net rpc printer MIGRATE SECURITY [printer] [misc. options] [targets]
</screen>
	Printer configuration settings include factors such as paper size and default paper orientation.
	These can be migrated from the Windows print server to the Samba server with this command:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>printer migrate settings</tertiary></indexterm>
<screen>
net rpc printer MIGRATE SETTINGS [printer] [misc. options] [targets]
</screen>
	</para>

	<para>
	Migration of printers including the above-mentioned sets of information may be completed
	with a single command using this syntax:
<screen>
net rpc printer MIGRATE ALL [printer] [misc. options] [targets]
</screen>
	</para>

	</sect2>

	</sect1>

	<sect1>
	<title>Controlling Open Files</title>

	<para>
	The man page documents the <command>net file</command> function suite, which provides the tools to
	close open files using either RAP or RPC function calls. Please refer to the man page for specific
	usage information.
	</para>

	</sect1>

	<sect1>
	<title>Session and Connection Management</title>

	<para>
	The session management interface of the <command>net session</command> command uses the old RAP
	method to obtain the list of connections to the Samba server, as shown here:
<indexterm><primary>net</primary><secondary>rap</secondary><tertiary>session</tertiary></indexterm>
<screen>
&rootprompt; net rap session -S MERLIN -Uroot%not24get
Computer             User name            Client Type        Opens Idle time
------------------------------------------------------------------------------
\\merlin             root                 Unknown Client         0 00:00:00
\\marvel             jht                  Unknown Client         0 00:00:00
\\maggot             jht                  Unknown Client         0 00:00:00
\\marvel             jht                  Unknown Client         0 00:00:00
</screen>
	</para>

	<para>
	A session can be closed by executing a command as shown here:
<screen>
&rootprompt; net rap session close marvel -Uroot%not24get
</screen>
	</para>

	</sect1>

	<sect1>
	<title>Printers and ADS</title>

	<para>
	When Samba-3 is used within an MS Windows ADS environment, printers shared via Samba will not be browseable
	until they have been published to the ADS domain. Information regarding published printers may be obtained
	from the ADS server by executing the <command>net ads print info</command> command following this syntax:
<indexterm><primary>net</primary><secondary>ads</secondary><tertiary>printer info</tertiary></indexterm>
<screen>
net ads printer info &lt;printer_name&gt; &lt;server_name&gt; -Uadministrator%secret
</screen>
	If the asterisk (*) is used in place of the printer_name argument, a list of all printers will be
	returned.
	</para>

	<para>
	To publish (make available) a printer to ADS, execute the following command:
<indexterm><primary>net</primary><secondary>ads</secondary><tertiary>printer publish</tertiary></indexterm>
<screen>
net ads printer publish &lt;printer_name&gt; -Uadministrator%secret
</screen>
	This publishes a printer from the local Samba server to ADS.
	</para>

	<para>
	Removal of a Samba printer from ADS is achieved by executing this command:
<indexterm><primary>net</primary><secondary>ads</secondary><tertiary>printer remove</tertiary></indexterm>
<screen>
net ads printer remove &lt;printer_name&gt; -Uadministrator%secret
</screen>
	</para>

	<para>
	A generic search (query) can also be made to locate a printer across the entire ADS domain by executing:
<indexterm><primary>net</primary><secondary>ads</secondary><tertiary>printer search</tertiary></indexterm>
<screen>
net ads printer search &lt;printer_name&gt; -Uadministrator%secret
</screen>
	</para>

	</sect1>

	<sect1>
	<title>Manipulating the Samba Cache</title>

	<para>
	Please refer to the <command>net</command> command man page for information regarding cache management.
	</para>

	</sect1>

	<sect1>
	<title>Managing IDMAP UID/SID Mappings</title>

	<para>
	The IDMAP UID to SID, and SID to UID, mappings that are created by <command>winbindd</command> can be
	backed up to a text file. The text file can be manually edited, although it is highly recommended that
	you attempt this only if you know precisely what you are doing.
	</para>

	<para>
	An IDMAP text dump file can be restored (or reloaded). There are two situations that may necessitate
	this action: a) The existing IDMAP file is corrupt, b) It is necessary to install an editted version
	of the mapping information.
	</para>

	<para>
	Winbind must be shut down to dump the IDMAP file. Before restoring a dump file, shut down
	<command>winbindd</command> and delete the old <filename>winbindd_idmap.tdb</filename> file.
	</para>

	<sect2>
	<title>Creating an IDMAP Database Dump File</title>

	<para>
	The IDMAP database can be dumped to a text file as shown here:
<screen>
net idmap dump &lt;full_path_and_tdb_filename&gt; &gt; dumpfile.txt
</screen>
	Where a particular build of Samba the run-time tdb files are stored in the
	<filename>/var/lib/samba</filename> directory the following commands to create the dump file will suffice:
<screen>
net idmap dump /var/lib/samba/winbindd_idmap.tdb &gt; idmap_dump.txt
</screen>
	</para>

	</sect2>

	<sect2>
	<title>Restoring the IDMAP Database Dump File</title>

	<para>
	The IDMAP dump file can be restored using the following command:
<screen>
net idmap restore idmap_dump.txt
</screen>
	Where the Samba run-time tdb files are stored in the <filename>/var/lib/samba</filename> directory
    the following command can be used to restore the data to the tdb file:
<screen>
net idmap restore /var/lib/samba/winbindd_idmap.tdb &lt; idmap_dump.txt
</screen>
	</para>

	</sect2>

	</sect1>

	<sect1 id="netmisc1">
	<title>Other Miscellaneous Operations</title>

	<para>
	The following command is useful for obtaining basic statistics regarding a Samba domain. This command does
	not work with current Windows XP Professional clients.
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>info</tertiary></indexterm>
<screen>
&rootprompt; net rpc info
Domain Name: RAPIDFLY
Domain SID: S-1-5-21-399034208-633907489-3292421255
Sequence number: 1116312355
Num users: 720
Num domain groups: 27
Num local groups: 6
</screen>
	</para>

	<para>
	Another useful tool is the <command>net time</command> tool set. This tool may be used to query the
	current time on the target server as shown here:
<indexterm><primary>net</primary><secondary>time</secondary></indexterm>
<screen>
&rootprompt; net time -S SAURON
Tue May 17 00:50:43 2005
</screen>
	In the event that it is the intent to pass the time information obtained to the UNIX
	<command>/bin/time</command>, it is a good idea to obtain the time from the target server in a format
	that is ready to be passed through. This may be done by executing:
<indexterm><primary>net</primary><secondary>time</secondary><tertiary>system</tertiary></indexterm>
<screen>
&rootprompt; net time system -S FRODO
051700532005.16
</screen>
	The time can be set on a target server by executing:
<indexterm><primary>net</primary><secondary>time</secondary><tertiary>set</tertiary></indexterm>
<screen>
&rootprompt; net time set -S MAGGOT -U Administrator%not24get
Tue May 17 00:55:30 MDT 2005
</screen>
	It is possible to obtain the time zone of a server by executing the following command against it:
<indexterm><primary>net</primary><secondary>time</secondary><tertiary>zone</tertiary></indexterm>
<screen>
&rootprompt; net time zone -S SAURON
-0600
</screen>
	</para>

	</sect1>

</chapter>
