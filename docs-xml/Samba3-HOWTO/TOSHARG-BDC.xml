<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<chapter id="samba-bdc">

<chapterinfo>
	&author.jht;
	&author.vl;
	<author>&person.gd;<contrib>LDAP updates</contrib></author>
</chapterinfo>

<title>バックアップドメインコントローラ</title>

<para>
このセクションを読み始める前に、<link linkend="samba-pdc">ドメイン制御</link>
中で説明されているSambaドメインコントローラの設定に問題がないようにして
おくこと。
</para>

<sect1>
<title>機能と利便性</title>

<para>
この章は、説明するのが最も困難な章の一つである。何を書いても、誰かがまだ
実現できていない項目、あるいはまったく異なるアプローチを使った方が遥かに
効果的に実現できる項目について、実現されたはずだと期待してSambaチームに
問い合わせてくることを防止することはできないと思われる。もしこの章で説明
されているはずなのに、いくら読んでも言及されない事項というのがある場合は、
要件あるいは質問内容を明確に書いて
<ulink url="mailto:jht@samba.org">John H. Terpstra</ulink>
まで電子メールで問い合わせてほしい。
</para>

<para>
<indexterm><primary>SAM バックエンド</primary><secondary>LDAP</secondary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>LDAP</primary><secondary>slave</secondary></indexterm>
<indexterm><primary>スケーラビリティ</primary></indexterm>
Samba-3 は別のSambaプライマリドメインコントローラ(PDC)に対するバックアップ
ドメインコントローラ(BDC)として機能することができる。Samba-3 PDCは、LDAP
アカウントバックエンドとともに運用することができる。LDAPバックエンドは、
共用のマスタLDAPサーバかスレーブサーバのどちらでも使える。スレーブLDAPサーバ
を使用する利点は、マスタがダウンしている時でもクライアントがネットワークに
ログオンできるということである。これによりSambaが高いレベルの拡張性を持つ
ことになり、大規模な組織のための効果的なソリューションとなり得る。PDCにLDAP
スレーブサーバを使用する場合、マスタの継続的な可用性を確保する必要がある。&smbmdash;
悪い時にスレーブ側から見てマスタがダウンしていると、安定性の問題や運用上の
問題となる。
</para>

<para>
<indexterm><primary>双方向</primary><secondary>propagation</secondary></indexterm>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
<indexterm><primary>非LDAP</primary><secondary>バックエンド</secondary></indexterm>
<indexterm><primary>propagate</primary></indexterm>
Samba-3 BDCをLDAPでないバックエンドとともに運用することも可能だが、
バックエンドが何らかの形で「双方向の」伝達を許容し、BDC側からマスタ
への変更が可能であるようにしなければならない。現段階でこれをできるのは
LDAPのみである。PDCが、そのプライマリとしてLDAPマスタサーバを使うことが
好ましい間、BDCはスレーブLDAPサーバを使うことが出来る。
</para>

<para>
<indexterm><primary>非LDAP</primary><secondary>バックエンド</secondary></indexterm>
<indexterm><primary>SAMバックエンド</primary><secondary>非LDAP</secondary></indexterm>
<indexterm><primary>ドメイン</primary><secondary>メンバ</secondary><tertiary>サーバ</tertiary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>trust account password</primary></indexterm>
<indexterm><primary>domain trust</primary></indexterm>
LDAPでないバックエンドSAMデータベースを使用するのは問題に陥りやすくなる。
なぜなら、ドメインメンバサーバもワークステーションも、マシン信頼アカウントの
パスワードを定期的に変更するからである。新しいバスワードはローカルでしか保存
されない。このことは、(LDAPベースのソリューションにあるような)集中的に格納
されたアカウントデータベースが無く、Samba-3 がBDCとして動作しているとき、
BDC 側のドメインメンバ信頼アカウントのパスワードの記録が、PDC(マスタ)のSAM
のコピーに届かないことを意味する。もし、PDCのSAMがBDC側に複製されると、
最新の(変更後の)信頼アカウントのパスワードを含むSAMが上書きされることになり、
ドメイン信頼が無効になってしまう。
</para>

<para>
<indexterm><primary>net</primary><secondary>rpc</secondary></indexterm>
<indexterm><primary>SAM backend</primary><secondary>ldapsam</secondary></indexterm>
<indexterm><primary>SAM backend</primary><secondary>tdbsam</secondary></indexterm>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
BDCの設定方法に関して挙げられたコメントや質問の数が多いので、可能な選択肢の
一つ一つについて、おのおのの解について利点欠点を見てみよう。
<link linkend="pdc-bdc-table">以下のドメインバックエンドアカウント分散オプション一覧</link>
は、PDC/BDC構成で設定可能な設定例の一覧である。
</para>

<table frame="all" id="pdc-bdc-table"><title>分散ドメインバックエンドアカウントの選択肢</title>
<tgroup cols="3">
        <colspec align="center" colwidth="1*"/>
        <colspec align="center" colwidth="1*"/>
        <colspec align="left" colwidth="3*"/>

        <thead>
        <row><entry>PDCバックエンド</entry><entry>BDCバックエンド</entry><entry>補足事項</entry></row>
        </thead>
        <tbody>
        <row>
        <entry><para>マスタLDAPサーバ</para></entry>
        <entry><para>スレーブLDAPサーバ</para></entry>
        <entry><para>高い整合性を提供する完全なソリューション。SAMは共通マスタLDAPサーバで
	    複製される。</para></entry>
        </row>
        <row>
        <entry><para>単一の集中LDAPサーバ</para></entry>
        <entry><para>単一の集中LDAPサーバ</para></entry>
	<entry><para>
	フェイルオーバ機能がないが実用可能なソリューション。これは実用的なソリューションで
	あるが、完全ではない。
	</para></entry>
        </row>
        <row>
        <entry><para>tdbsam</para></entry>
        <entry><para>tdbsam + <command>net rpc vampire</command></para></entry>
        <entry><para>
	Samba-3.0では動かない。Sambaはサーバサイドプロトコル要求を実装していない。
	</para></entry>
        </row>
        <row>
        <entry><para>tdbsam</para></entry>
        <entry><para>tdbsam + <command>rsync</command></para></entry>
        <entry><para>
	この設定を使ってはいけない。TDBファイルが使用中の状態でデータがディスクに
	完全に書き戻されていないかもしれないので、動作しない。
	さらに、ドメインの信頼関係を壊すだろう。
	</para></entry>
        </row>
        <row>
        <entry><para>smbpasswd file</para></entry>
        <entry><para>smbpasswd file</para></entry>
        <entry><para>
	この設定を使ってはいけない。
	同期が遅延するためにエレガントな解ではなく、ドメイン信頼関係
	の問題で悩むだろう。
	</para></entry>
        </row>
        </tbody>
</tgroup>
</table>

</sect1>

<sect1>
<title>基本的な背景情報について</title>

<para>
<indexterm><primary>ドメインコントローラ</primary></indexterm>
<indexterm><primary>ログオン要求</primary></indexterm>
<indexterm><primary>LanMan</primary></indexterm>
<indexterm><primary>Netlogon</primary></indexterm>
ドメインコントローラは、ネットワーク上のワークステーションからのログオン
要求に答えることが出来るマシンである。Microsoft LanManagerとIBM LanServer
はこの機能を提供していた初期のプロダクトの2つである。その技術は、LanMan 
NetLogonサービスとして知られるようになった。
</para>

<para>
<indexterm>ネットワーク<primary></primary><secondary>ログオン</secondary><tertiary>サービス</tertiary></indexterm>
<indexterm><primary>Windows NT3.10</primary></indexterm>
Microsoft Windows NT3.10が最初にリリースされたとき、拡張された機能を持つ
新しい形式のネットワークログオンサービスを持つ新しい形式のドメイン制御
をサポートした。このサービスはNT NetLogonサービスとして知られるようになった。
このサービスの性質は、Microsoft Windows NTの発展に伴い変更され、現在では
複雑な技術の幅を超えて実装された複雑なサービスの集合体として提供されて
いる。
</para>

<sect2>
<title>Microsoft Windows NT4スタイルのドメイン制御</title>

<para>
<indexterm><primary>ドメインコントローラ</primary></indexterm>
<indexterm><primary>認証サーバ</primary></indexterm>
<indexterm><primary>ユーザ名</primary></indexterm>
<indexterm><primary>パスワード</primary></indexterm>
<indexterm><primary>SAM</primary></indexterm>
<indexterm><primary>Security Account Manager</primary><see>SAM</see></indexterm>
<indexterm><primary>ドメイン制御データベース</primary><see>SAM</see></indexterm>
NT4/200x/XP Professionalワークステーションにユーザがログオンするときは
いつでも、ワークステーションはユーザが入力したユーザ名/パスワードペア
が正しいかを検証するためにドメインコントローラ(認証サーバ)に接続する。
もしも入力された情報がドメイン制御データベース(SAM、すなわちセキュリティ
アカウントマネージャデータベース)に格納されているアカウント情報と
一致しない場合、認証要求を出したワークステーションにいくつかのエラー
コードを返す。
</para>

<para>
<indexterm><primary>アカウント情報</primary></indexterm>
<indexterm><primary>マシンアカウントデータベース</primary></indexterm>
<indexterm><primary>プロファイル</primary></indexterm>
<indexterm><primary>ネットワークアクセスプロファイル</primary></indexterm>
<indexterm><primary>デスクトッププロファイル</primary></indexterm>
ユーザ名/パスワードペアが検証されたとき、ドメインコントローラ(認証サーバ)
はそのドメインに対するユーザとマシンアカウントデータベース中の、そのユーザ
に関係するアカウント情報の完全な項目一覧を返す。この情報はそのユーザに対する
完全なネットワークアクセスプロファイルを含むが、ユーザのデスクトッププロファイル
に特有の情報は含まないか、あるいはそれに関して、ユーザが属してもよいグループ
のためのすべてのデスクトッププロファイルも含まれない。また、それには、
パスワード満了時間、パスワードの一意性制御情報、ネットワークアクセス時間制限
情報、アカウント検証情報、ユーザがアクセスできるネットワークからのマシン名
や空にその他の情報が含まれている。すべての情報はMicrosoft Windows NT(3.10,
 3.50, 3.51, 4.0)バージョン中のSAM中に格納される。
</para>

<para>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
<indexterm><primary>%SystemRoot%\System32\config</primary></indexterm>
<indexterm><primary>C:\WinNT\System32\config</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>SAM</primary></indexterm>
ドメインコントローラ上のアカウント情報(ユーザとマシン)は2つのファイルに格納
され、そのうちの1つにはセキュリティ情報を含み、もう1つはSAMである。それらは
<filename>%SystemRoot%\System32\config</filename>ディレクトリ中に同じ名前で
の同じファイルに格納される。これは通常<filename>C:\WinNT\System32\config</filename>
に変換される。これらはネットワーク上にあるBDCのSAMデータベースの複製で関連
するファイルである。
</para>

<para>
BDCをインストールすることが好ましい2つの状況がある:
</para>

<itemizedlist>
	<listitem><para>
	<indexterm><primary>PDC</primary></indexterm>
	<indexterm><primary>BDC</primary></indexterm>
	PDCがいるローカルネットワーク上で、もしもたくさんのワークステーション
	があるか、PDCが一般的に高負荷な場合。この場合、BDCはネットワーク上
	のログオン要求を拾い、ネットワークサービスの堅牢性を追加するのを支援
	する。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>network</primary><secondary>wide-area</secondary></indexterm>
	おのおののリモートサイトで、広域ネットワークの転送量を減らすためとリモート
	ネットワーク操作の安定性を追加するため。ネットワークのデザインと、戦略的な
	BDCの配置はともに、可能な限りクライアントへのデータ交換をする、たくさんの
	ネットワークの局所化を実装するとともに、必要とする広域ネットワークのバンド
	幅(とコストも)を最小化するのを支援する。
	</para></listitem>
</itemizedlist>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>SAM</primary></indexterm>
<indexterm><primary>ユーザアカウントデータベース</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>trigger</primary></indexterm>
真のWindows NT4環境中でのPDCとBDCの相互運用は、ここで言及する価値がある。PDCは
SAMのマスタコピーを持っている。PDCが持っているローカルネットワーク上に物理的に
ある間にユーザアカウントデータベースへの変更が管理者によって行われるという
イベント中で、変更はSAMのマスタコピーのPDCインスタンスで直接行われるだろう。
別のオフィスでこの更新が行われるというイベントの場合は、変更はローカルBDC
上の差分ファイルに格納されるだろう。BDCはSAM同期を開始するために、PDCに対して
トリガを送る。PDCはドメイン中のすべてのBDCに接続し、差分を入手し、それをそれら
固有のSAMのコピーに適用する。
</para>

<para>
<indexterm><primary>SAM</primary><secondary>複製</secondary></indexterm>
<indexterm><primary>SAM</primary><secondary>差分ファイル</secondary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
Samba-3は真のSAM複製に参加できず、それゆえ、Microsoft Windows NT4で
試用されている同じプロトコルを正確に使用することが出来ない。1つの
Samba-3 BDCはSAM更新差分ファイルを作成できない。BDCが持っている差分
ファイルからSAMの同期をPDC(NT4またはSamba)間で行う操作はできない。
</para>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
Samba-3 はMicrosoft Windows NT4 BDCとしては動作できず、Samba-3は
Microsoft Windows NT4 BDCに対するPDCとして正しく動作できない。
Samba-3とMicrosoft Windows NT4はそれぞれのタイプのPDCへのBDCとして
機能することは出来る。
</para>

<para>
<indexterm><primary>SAM</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>ドメインセキュリティ</primary></indexterm>
BDCはネットワークログオン要求とユーザ認証が出来るところから、
<emphasis>読み出し専用</emphasis>のSAMを保持していると言える。
BDCは、たとえば、PDCへの広域ネットワークがダウンするような場合
特に、このサービスを提供し続けることができる。BDCはネットワーク
の完全性と同様のドメインセキュリティの保守の両方でとても重要な
役割を演じる。
</para>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>昇格</primary></indexterm>
<indexterm><primary>降格</primary></indexterm>
<indexterm><primary>再設定</primary></indexterm>
NT4 PDCが稼働停止の必要がある状態か、停止している時、NT4 BDC
の1つはPDCに昇格することが出来る。もしもNT4 PDCが動作中にこの
ことが発生すると、それは自動的にNT4 BDCに降格する。これは、
ドメインコントローラの管理において重要な観点である。降格および
昇格を行う時に使うツールはドメインサーバマネージャである。Samba-3 
BDCは、Sambaの再設定が&smb.conf;ファイルの変更を必要とするという
理由で、この方式で昇格することは出来ないことに注意。&smb.conf;
ファイルを手動での変更とSambaネットワークサービスに関連したもの
の再起動で十分である。
</para>

<sect3>
<title>PDC設定例</title>

<para>
<indexterm><primary>ドメインログオン</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
バージョン2.2の最初からSambaは公式に、Windows NT4、2003とXP Professional
を含む現行Windowsクライアントすべてでドメインログオン機能を公式にサポート
している。PDCを有効にしたSambaでは&smb.conf;中の<smbconfsection name="[global]"/>
セクション内にいくつかのパラメータを設定しなければならない。最低限
必要な設定の例は<link linkend="minimalPDC">BDCと共に使う、PDC上にLDAP
サーバがあるPDCのための最低限のsmb.conf  &smbmdash;の節</link>
を参照のこと。
</para>

<example id="minimalPDC">
<title>BDCと共に使う、PDC上にLDAPサーバがあるPDCのための最低限のsmb.conf &smbmdash;</title>
<smbconfblock>
<smbconfoption name="workgroup">&example.workgroup;</smbconfoption>
<smbconfoption name="passdb backend">ldapsam://localhost:389</smbconfoption>
<smbconfoption name="domain master">yes</smbconfoption>
<smbconfoption name="domain logons">yes</smbconfoption>
<smbconfoption name="ldap suffix">dc=quenya,dc=org</smbconfoption>
<smbconfoption name="ldap user suffix">ou=Users</smbconfoption>
<smbconfoption name="ldap group suffix">ou=Groups</smbconfoption>
<smbconfoption name="ldap machine suffix">ou=Computers</smbconfoption>
<smbconfoption name="ldap idmap suffix">ou=Idmap</smbconfoption>
<smbconfoption name="ldap admin dn">cn=sambadmin,dc=quenya,dc=org</smbconfoption>
</smbconfblock>
</example>

<para>
<indexterm><primary>profile path</primary></indexterm>
<indexterm><primary>home drive</primary></indexterm>
<smbconfsection name="[homes]"/>と<smbconfsection name="[netlogon]"/>
共有のようないくつかのものもプロファイルパス、ユーザのホームドライブや
その他を設定するために一緒に設定が必要である。これはこの章では
触れられない。詳細な情報については、<link linkend="samba-pdc">ドメイン制御</link>
を参照のこと。PDC設定のための特定の推奨パターンは
<link linkend="samba-pdc">ドメイン制御の章</link>を参照のこと。また別に、
ローカルとオンライン書店から入手できる<quote>Samba-3 by Example</quote>という
書籍(<ulink url="http://www.samba.org/samba/docs/Samba3-ByExample">book</ulink>)
中にOpenLDAPとSambaのネットワーク動作設定例が完全に記述されている。
</para>

</sect3>
</sect2>

<sect2>
<title>LDAP設定の注意</title>

<para>
<indexterm><primary>LDAP</primary><secondary>マスタ</secondary></indexterm>
<indexterm><primary>LDAP</primary><secondary>スレーブ</secondary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
マスタとスレーブLDAPサーバ設定時、マスタLDPサーバをPDCで、スレーブLDAPサーバ
をBDCで使うことは推奨される。スレーブLDAPサーバを使うことは不可欠ではないが、
サービスの冗長性を提供するために多くの管理者はそのことを望んでいる。もちろん、
1つまたはそれ以上のBDCは任意のスレーブLDAPサーバを使うことが出来る。繰り返すと、
ネットワーク全体用に1つのLDAPサーバを使うことは完全に可能である。
</para>

<para>
<indexterm><primary>LDAP</primary><secondary>マスタ</secondary></indexterm>
<indexterm><primary>LDAP</primary><secondary>サーバ</secondary></indexterm>
<indexterm><primary>CN</primary></indexterm>
<indexterm><primary>DN</primary></indexterm>
<indexterm><primary>RFC2830</primary></indexterm>
スレーブLDAPサーバサーバを持つマスタLDAPサーバ設定時、このことを
<filename>/etc/openldap/slapd.conf</filename>ファイル中に設定する
ことを忘れないように。サーバ証明書のDNはサーバの名前のためのCN属性を
使わなければならず、CNはサーバの完全なドメイン名を伝搬しなければならない
ことに注意。追加の別名とワイルドカードは、subjectAltName認証拡張(訳注:
certificate extension)中に存在しても良い。サーバ証明書についてのより詳細
な情報はRFC2830にある。
</para>

<para>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>OpenLDAP</primary></indexterm>
<indexterm><primary>トランスポートレイヤのセキュリティ</primary><see>TLS</see></indexterm>
<indexterm><primary>/etc/ssl/certs/slapd.pem</primary></indexterm>
<indexterm><primary>slapd.pem</primary></indexterm>
<indexterm><primary>Red Hat Linux</primary></indexterm>
この文書の範囲内にはうまく適合しないが、LDAPのインストール作業はLDAPが
有効になっているSamba操作の基本である。トランスポートレイヤのセキュリティ
(TLS)とともにOpenLDAPを使うとき、<filename>/etc/ssl/certs/slapd.pem</filename>
中のマシン名は<filename>/etc/openldap/sldap.conf</filename>と同じものである
必要がある。Red Hat Linuxスタートアップスクリプトはホスト名として、
<quote>localhost.localdomain</quote>とした<filename>slapd.pem</filename>
ファイルを生成する。これだと、正しいホスト名で証明書が再作成されない限り、
スレーブLDAPサーバ(すなわちSamba BDC)からLDAPサーバにアクセスできない。
</para>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>OpenLDAP</primary></indexterm>
<indexterm><primary>マシンアカウント</primary></indexterm>
<indexterm><primary>credentials</primary></indexterm>
<indexterm><primary>複製</primary></indexterm>
<indexterm><primary>duplicate</primary></indexterm>
LDAPスレーブサーバを使う形でSamba PDCをインストールしてはいけない。ドメインへの
クライアントマシンの参加は、LDAPデータベース中へのマシンアカウントの変更がマスタ
LDAPサーバ上で行わなければならないという理由で、この設定では失敗する。これは
PDCが問い合わせるスレーブサーバに十分急速に複製されない。そのため、クライアント
マシン上に、アカウントの証明書がセットアップできないというエラーメッセージが出る。
LDAPサーバ上でマシンアカウントが作成されるが、パスワードファイルは空である。
残念なことに、いくつかのサイトはこのような設定を防げず、それらのサイトは、
レプリケーションに追いつくために、Sambaの処理を十分に遅くするように意図するための、
<smbconfoption name="ldap replication sleep"/>パラメータを検討すべきである。
これは、その場しのぎの解決方法であり、管理者が何らかのスクリプト(たとえば、
<smbconfoption name="add machine script"/>のようなもの)を使って手動で複製
しなければならない。
</para>

<para>
PDC/BDCとLDAPを使う、設定可能なパターンは以下の通り:
</para>

<itemizedlist>
	<listitem><para>
	PDC+BDC -> 1つの集中LDAPサーバ。
	</para></listitem>
	<listitem><para>
	PDC -> LDAP マスタサーバ、 BDC -> LDAPスレーブサーバ。
	</para></listitem>
	<listitem><para>
	PDC -> 第二のスレーブLDAPサーバを使うLDAPマスタ。
	</para><para>
	BDC -> 第二のスレーブLDAPサーバを使うLDAPマスタ。
	</para></listitem>
	<listitem><para>
	PDC -> 第二のスレーブLDAPサーバを使うLDAPマスタ。
	</para><para>
	BDC -> 第二のマスタLDAPサーバを使うLDAPスレーブサーバ。
	</para></listitem>
</itemizedlist>

<para>
(セカンダリ)LDAPサーバサーバの次候補の設定を行うために、
<link linkend="mulitldapcfg">&smb.conf;に記述する複数LDAPサーバの例</link>
を指定する。
</para>

<example id="mulitldapcfg">
<title>&smb.conf;に記述する複数LDAPサーバ</title>
<smbconfblock>
<smbconfoption name="passdb backend">ldapsam:"ldap://master.quenya.org ldap://slave.quenya.org"</smbconfoption>
</smbconfblock>
</example>

</sect2>

<sect2>
<title>Active Directoryドメイン制御</title>

<para>
<indexterm><primary>Microsoft Windows 2000</primary></indexterm>
<indexterm><primary>Active Directory</primary></indexterm>
<indexterm><primary>ディレクトリ</primary></indexterm>
<indexterm><primary>replicated</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>ドメインコントローラ</primary></indexterm>
Microsoft Windows 2000とActive Directoryのリリース時点で、この情報は
複製が出来、部分的あるいは全体の管理者による管理が伝搬できるディレクトリ
中に格納される。Samba-3はActive Directory内でドメインコントローラ
にはなれず、また、Active Directoryサーバにもなれない。これは、Samba-3
はActive DirectoryドメインコントローラのBDCとして振る舞えないことも
意味する。
</para>

</sect2>

<sect2>
<title>何がネットワーク上でドメインコントローラを制限するか?</title>

<para>
<indexterm><primary>DMB</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>WINS</primary></indexterm>
<indexterm><primary>NetBIOS</primary></indexterm>
ドメインMIDEARTH用のドメインコントローラであるおのおののマシンは、
WINSサーバかローカルネットワークに対するブロードキャストを使って
NetBIOSグループ名MIDEARTH&lt;1C&gt;を登録しなければならない。
PDCもWINSサーバを使って一意のNetBIOS名MIDEARTH&lt;1B&gt;を登録する。
名前タイプ&lt;1B&gt;名は通常認証に関連する何らの作業もしない、
ドメインマスタブラウザ(DMB)のために通常予約されるが、Microsoft
ドメインの実装はDMBに対してPDCと同じマシンであることを要求する。
</para>

<para>
<indexterm><primary>ブロードキャスト</primary></indexterm>
<indexterm><primary>名前登録</primary></indexterm>
<indexterm><primary>SMB/CIFS</primary></indexterm>
WINSサーバを使っていないとき、ブロードキャスト名前登録はそれだけで
十分になっていなければならない。<link linkend="NetworkBrowsing">ネットワークブラウジング</link>
と<link linkend="netdiscuss">Discussion</link>に、TCP/IPネットワーク
プロトコル関連と、どのようにSMB/CIFS名前が扱うかについてのより詳細な
情報があるので参照すること。
</para>

</sect2>

<sect2>
<title>どのようにワークステーションがそのドメインコントローラを探すか?</title>

<para>
<indexterm><primary>ドメインコントローラへの位置づけ</primary></indexterm>
<indexterm><primary>NetBIOS</primary></indexterm>
ドメインコントローラの位置を見つけるのには2つのメカニズムがある:1つは
NetBIOS over TCP/IPが有効なときに使われ、もう1つはTCP/IPネットワーク設定
で無効になっているときである。
</para>

<para>
<indexterm><primary>DNS</primary></indexterm>
<indexterm><primary>broadcast messaging</primary></indexterm>
NetBIOS over TCP/IPが無効になっているとき、すべての名前解決は、
Active Directory通信技術のような、DNS、UDP上のブロードキャストを使う。
このタイプの環境では、すべてのマシンは適切なDNSエントリを必要とする。
より詳細な情報は<link linkend="adsdnstech">DNSとActive Directory</link>
にある。
</para>

<sect3>
<title>NetBIOS Over TCP/IPが有効</title>
<para>
<indexterm><primary>Windows NT4/200x/XP</primary></indexterm>
<indexterm><primary>ドメインコントローラ</primary></indexterm>
<indexterm><primary>ログオン要求</primary></indexterm>
<indexterm><primary>credentials validation</primary></indexterm>

ローカルユーザを認証させたいドメインMIDEARTH内の
Microsoft Windows NT4/200x/XP Professionalワークステーションは、
MIDEARTHのドメインコントローラを見つける必要がある。これは、グループ名
MIDEARTH&lt;1C&gt;に対するNetBIOS名前解決を行うことによって行われる。
問い合わせから結果をもどす、おのおののマシンはドメインコントローラで
あり、ログイン要求に答えることが出来ることを仮定している。セキュリティ
ホールを造らないために、ワークステーションと選択されたドメインコントローラ
はおのおのを認証する。その後、ワークステーションはユーザの認証情報(
ユーザ名/パスワードペア)を認証のためにローカルのドメインコントローラに
送る。
</para>

</sect3>

<sect3>
<title>NetBIOS Over TCP/IPが無効</title>

<para>
<indexterm><primary>realm</primary></indexterm>
<indexterm><primary>ログオン認証</primary></indexterm>
<indexterm><primary>DNS</primary></indexterm>
<indexterm><primary>_ldap._tcp.pdc._msdcs.quenya.org</primary></indexterm>
ユーザログオン認証に影響を与えることを必要とする realm <constant>quenya.org</constant>
中のMicrosoft Windows NT4/200x/XP Professional workstationは
<constant>_ldap._tcp.pdc._msdcs.quenya.org</constant>レコードをDNS
サーバに対して再度問い合わせすることでドメインコントローラの位置を
見つける。この項目に対する関連したより詳細な情報は、
<link linkend="adsdnstech">DNSとActive Directory</link>にある。
</para>

</sect3>
</sect2>
</sect1>

<sect1>
<title>バックアップドメインコントローラの設定</title>

<para>
<indexterm><primary>BDC</primary></indexterm>
BDCの作成には最初に&smbd;を動かす前にSamba サーバを準備するため
のいくつかのステップが要求される。
</para>

<itemizedlist>
	<listitem><para>
	<indexterm><primary>SID</primary></indexterm>
	<indexterm><primary>PDC</primary></indexterm>
	<indexterm><primary>BDC</primary></indexterm>
	<indexterm><primary>private/secrets.tdb</primary></indexterm>
	<indexterm><primary>private/MACHINE.SID</primary></indexterm>
	<indexterm><primary>ドメインSID</primary></indexterm>
	ドメインSIDはPDCとBDCで同じにしなければならない。バージョン2.2.5
	以前のSambaでは、ドメインSIDは<filename>private/MACHINE.SID</filename>
	ファイルに格納されていた。バージョン2.2.5以降すべてのバージョンの
	Sambaでは、ドメインSIDは<filename>private/secrets.tdb</filename>ファイルに
	格納されている。このファイルはおのおののサーバで固有であり、PDCからBDCに
	コピーできない。BDCは新しいSIDを起動時に生成する。新しく生成したBDCのSID
	でPDCのドメインSIDを上書きする。これは、BDCにドメインSIDを入手することを
	認める手続きである。これについては以下で説明する。
	</para>

	<para>
	<indexterm><primary>ドメインSID</primary></indexterm>
	<indexterm><primary>PDC</primary></indexterm>
	<indexterm><primary>BDC</primary></indexterm>
	<indexterm><primary>secrets.tdb</primary></indexterm>
	<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>getsid</tertiary></indexterm>
	PDCまたは存在するBDCからドメインSIDを検索するためと、それを
	<filename>secrets.tdb</filename>に格納するためには、以下を実行する:
	</para>
<screen>
&rootprompt;<userinput>net rpc getsid</userinput>
</screen>
	</listitem>

	<listitem><para>
	<indexterm><primary>secrets.tdb</primary></indexterm>
	<indexterm><primary>smbpasswd</primary></indexterm>
	<indexterm><primary>LDAP管理用パスワード</primary></indexterm>
	<smbconfoption name="ldap admin dn"/>の指定は必須である。
	これは、<command>smbpasswd -w <replaceable>mysecret</replaceable></command>
	を使って、<filename>secrets.tdb</filename>中にLDAP管理用パスワードを
	設定することも要求する。
	</para></listitem>

	<listitem><para>
	The <smbconfoption name="ldap suffix"/>パラメータと<smbconfoption name="ldap idmap suffix"/>
	パラメータは&smb.conf;ファイル中で指定しなければならない。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>レプリケーション</primary><secondary>SAM</secondary></indexterm>
	<indexterm><primary>ユーザデータベース</primary></indexterm>
	<indexterm><primary>同期</primary></indexterm>
	<indexterm><primary>NIS</primary></indexterm>
	UNIXユーティリティ差データベースはPDCからBDCにむけて同期しなければ
	ならない。これは、<filename>/etc/passwd</filename>と
	<filename>/etc/group</filename>の両方がPDCからBDCに複製されなければ
	ならないことを意味している。これは変更が行われたたびごとに手動で
	行うことが出来る。別のやり方として、PDCをNISマスタサーバとして設定し、
	BDCをNISスレーブサーバとして設定するBDCをNISクライアントとして設定
	するのでは、PDCが止まっているときにそのユーザデータベースにアクセス
	出来ないので不十分である。NISはパスワード同期の唯一の手法というわけ
	ではない。LDAPを使う解も同様に動作する。
	</para>
	</listitem>

	<listitem><para>
	<indexterm><primary>パスワードデータベース</primary></indexterm>
	<indexterm><primary>複製</primary></indexterm>
	<indexterm><primary>PDC</primary></indexterm>
	<indexterm><primary>BDC</primary></indexterm>
	<indexterm><primary>smbpasswd</primary></indexterm>
	<indexterm><primary>rsync</primary></indexterm>
	<indexterm><primary>ssh</primary></indexterm>
	<indexterm><primary>LDAP</primary></indexterm>
	SambaパスワードデータベースはPDCからBDCに向けて複製されねばならない。
	<command>rsync</command>と<command>ssh</command>で<filename>smbpasswd</filename>
	ファイルの同期を取るのが可能であるにもかかわらず、この方法は破綻していて
	欠陥があり、それゆえ推奨できない。よりよい解決方法は、おのおののBDC
	に対してスレーブLDAPサーバを、PDCにマスタLDAPサーバを構築することである。
	rsyncの使用は、一定間隔毎にデータが複製されるということにより、本質的に
	欠陥がある。すべての瞬間に、正しい現在のマシンとユーザアカウント情報で
	BDCが操作できるという保証がない。これは、この方法が、首尾一貫しない
	セキュリティデータのために不連続なネットワークサービスへのアクセスによって
	ユーザに不都合が生じる危険性がある。Windows ワークステーションが通常の
	間隔でマシン信頼アカウントパスワードを更新(変更)することを心にとめて
	おかねばならず、&smbmdash;管理者は通常それが起きていることを知らない。
	</para>

	<para>
	<indexterm><primary>POSIX</primary></indexterm>
	<indexterm><primary>LDAP</primary></indexterm>
	<indexterm><primary>SambaSAMAccount</primary></indexterm>
	<indexterm><primary>同期</primary></indexterm>
	POSIX(UNIXユーザとグループ)アカウント用とSambaSAMAccountデータ用の両方に
	LDAPを使うことは、すべてのアカウント変更情報が共有ディレクトリに書かれること
	を自動的に保証する。これは、LDAPがその要求に適合するために、アカウント情報の
	同期のための任意の特別な動作の必要性をこのことは排除する。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>netlogon share</primary></indexterm>
	<indexterm><primary>replicate</primary></indexterm>
	<indexterm><primary>PDC</primary></indexterm>
	<indexterm><primary>BDC</primary></indexterm>
	<indexterm><primary>cron</primary></indexterm>
	<indexterm><primary>rsync</primary></indexterm>
	netlogon共有はPDCからBDCに向けて複製されねばならない。これは、ログインスクリプト
	が変更されるたびごとに手動で行うことが出来るか、<command>rsync</command>のような
	ツールを使うことでこの共有中のディレクトリ構造を複製する、<command>cron</command>
	ジョブを使うことで自動的に行える。netlogonデータの複製のために、
	<command>rsync</command>を使うことは、ネットワークセキュリティに対して特段重要
	というわけではなく、意識的な移動の一部としてnetlogon共有へのすべての変更を行う
	管理者によって与えられたものについて手動で管理できる(訳注:意味取りにくい)。
	</para></listitem>

</itemizedlist>

<sect2>
<title>設定例</title>

<para>
最後に、BDCはワークステーションによって見つけられるようになっていなければならない。
これは、<link linkend="minim-bdc">BDCであるための最低限の設定</link>中にある
Samba &smb.conf;ファイルの<smbconfsection name="[global]"/>セクションで設定
されることで行える。
</para>

<example id="minim-bdc">
<title>BDCであるための最低限の設定</title>
<smbconfblock>
<smbconfoption name="workgroup">&example.workgroup;</smbconfoption>
<smbconfoption name="passdb backend">ldapsam:ldap://slave-ldap.quenya.org</smbconfoption>
<smbconfoption name="domain master">no</smbconfoption>
<smbconfoption name="domain logons">yes</smbconfoption>
<smbconfoption name="ldap suffix">dc=abmas,dc=biz</smbconfoption>
<smbconfoption name="ldap user suffix">ou=Users</smbconfoption>
<smbconfoption name="ldap group suffix">ou=Groups</smbconfoption>
<smbconfoption name="ldap machine suffix">ou=Computers</smbconfoption>
<smbconfoption name="ldap idmap suffix">ou=Idmap</smbconfoption>
<smbconfoption name="ldap admin dn">cn=sambadmin,dc=quenya,dc=org</smbconfoption>
<smbconfoption name="idmap backend">ldap:ldap://master-ldap.quenya.org</smbconfoption>
<smbconfoption name="idmap uid">10000-20000</smbconfoption>
<smbconfoption name="idmap gid">10000-20000</smbconfoption>
</smbconfblock>
</example>

<para>
完全な、OpenLDAPとSambaを使うネットワーク設定の例の説明は、ローカルとオンライン
書店で見つけられる、<quote>Samba-3 by Example</quote>という
<ulink url="http://www.samba.org/samba/docs/Samba3-ByExample">本</ulink>
にある。
</para>

<para>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>NetBIOS</primary></indexterm>
<indexterm><primary>group</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
この設定はWINSサーバを使ってMIDEARTH&lt;1C&gt;という名前のみをBDCに
登録させる。これは、MIDEARTH&lt;1C&gt;というNetBIOSグループ名が、1つ
以上のマシンから登録されるという意味において、問題ではない。パラメータ
<smbconfoption name="domain master">no</smbconfoption>は、PDCのために
予約されている固有のNetBIOS名であるMIDEARTH&lt;1B&gt;をBDCが登録させ
ないようにする。
</para>

<para>
<indexterm><primary>idmap backend</primary></indexterm>
<indexterm><primary>winbindd</primary></indexterm>
<indexterm><primary>redirect</primary></indexterm>
<indexterm><primary>winbindd</primary></indexterm>
<indexterm><primary>LDAP database</primary></indexterm>
<indexterm><primary>UID</primary></indexterm>
<indexterm><primary>GID</primary></indexterm>
<indexterm><primary>SID</primary></indexterm>
<indexterm><primary>nss_ldap</primary></indexterm>
<parameter>idmap backend</parameter>パラメータは、共有されるリポジトリ
中のUNIXアカウントのためのWindows SIDからUIDとGIDへのすべてのマッピング
を格納するためのLDAPサーバデータベースを使うための<command>winbindd</command>
ユーティリティにリダイレクトする。BDCは<command>nss_ldap</command>ユーティリティ
とNSS経由の、ローカルでのUIDとGIDの解決にも依存する。
</para>

<note><para>
<indexterm><primary>サーバタイプ</primary><secondary>ドメインメンバ</secondary></indexterm>
<indexterm><primary>ID マッピング</primary></indexterm>
<indexterm><primary>ドメインメンバサーバ</primary></indexterm>
<indexterm><primary>idmap backend</primary></indexterm>
Samba-3は新しいIDマッピング機能を導入した。その機能の特徴の1つは、
NTドメインのユーザとグループSIDに関してユーザとグループIDが扱われる
より柔軟さを提供することである。新しい機能の1つは、UNIX/Linuxの
UIDとGIDの値が、PDC、すべてのBDCとすべてのドメインメンバサーバ上で
一貫していることを明確に保証することを提供することである。これを制御
するパラメータは、<parameter>idmap backend</parameter>である。その動作
に関連する詳細な情報は、&smb.conf;マニュアルページを参照してほしい。
</para></note>

<para>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>winbindd</primary></indexterm>
<indexterm><primary>ドメインメンバサーバ</primary></indexterm>
BDC上での<smbconfoption name="idmap backend">ldap:ldap://master.quenya.org</smbconfoption>
オプションの使用は、PDC上でldapsamが使われている時にのみ意味をなす。
LDAPベースのバックエンドの目的は、ドメインメンバ(固有のpassdbバックエンドがない)
にWindowsネットワークユーザとグループを共通のUID/GIDに解決するためのwinbind
を使うことも許可する。別の言い方をすると、このオプションは一般的に、
BDCとドメインメンバサーバ上で使うために意図されている。
</para>

</sect2>
</sect1>

<sect1>
<title>共通のエラー</title>

<para>
<indexterm><primary>ドメイン制御</primary></indexterm>
ドメイン制御はSambaの新しい領域であるが、参照できるたくさんの例がある。
更新された情報は、それが有効になったときで、新しいSambaのリリースがあった
時か、Samba Web<ulink url="http://samba.org">site</ulink>で公開される。
Sambaリリースパッケージの<filename>WHATSNEW.txt</filename>を特に参照すること。
<quote>Samba-3 by Example</quote>という本には、よくテストされ、検証された
例が記述されている。これをSamba Webサイト上の
<ulink url="http://www.samba.org/samba/docs/Samba3-ByExample.pdf">本</ulink>
からコピーを入手することもできる。
</para>

<sect2>
<title>マシンアカウントが満了し続ける</title>

<para>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
<indexterm><primary>passdb</primary></indexterm>
<indexterm><primary>SAM</primary></indexterm>
<indexterm><primary>ローカルマシン信頼アカウント</primary></indexterm>
この問題は、passdb(SAM)ファイルが中央のサーバからコピーされたがローカルのBDC
がPDCとして振る舞う時に起こる。これはローカルマシン信頼アカウントパスワードを
ローカルSAMに更新することを適用することで解決する。そのような更新は中央の
サーバにコピーは戻されない新しいマシンアカウントパスワードは次に、PDCから
SAMが再度コピーされたときに上書きされる。結果は起動時のドメインメンバマシン
が、データベース中でそのパスワードがそれと一致しないことを見つけ、開始時の
セキュリティチェックが失敗し、このマシンはログオン要求を出すことが出来ず、
アカウント満了エラーが出る(訳注:この辺不安)。
</para>

<para>
解決策は、ldapsamバックエンドのようなより堅牢なpassdbバックエンドを使うことで、
すなわち、おのおののBDCにスレーブLDAPサーバを立て、PDCにマスタLDAPサーバを
立てることである。
</para>

</sect2>

<sect2>
<title>NT4 PDCのバックアップドメインコントローラにSambaはなれるか?</title>

<para>
<indexterm><primary>複製</primary><secondary>SAM</secondary></indexterm>
<indexterm><primary>SAM</primary></indexterm>
できない。オリジナルのNT4 SAM複製プロトコルはまだ完全に実装されていない。
</para>

<para>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>ログオン要求</primary></indexterm>
SambaでBDCを使う利点はあるか?もちろん。しかし、それはSamba PDCに対して
のみである。BDCの実装は可用性の点のみである。もしもPDCがSambaだった
場合、2番目のSambaマシンはPDCがダウンしているときはいつでもログオン要求
をサービスするように設定できる。
</para>

</sect2>

<sect2>
<title>smbpasswdファイルの複製をどのようにやったらよいか?</title>

<para>
<indexterm><primary>複製</primary><secondary>SAM</secondary></indexterm>
<indexterm><primary>smbpasswd</primary></indexterm>
<indexterm><primary>SAM</primary></indexterm>
smbpasswdファイルの複製はデリケートである。SAMが変更されたときはいつでも
行わなければならない。おのおののユーザのパスワードの変更はsmbpasswd
ファイル中で行われてBDCに複製されねばならない。そのため、smbpasswdファイル
の複製は非常にしばしば必要となる。
</para>

<para>
<indexterm><primary>平文のパスワード</primary></indexterm>
<indexterm><primary>ssh</primary></indexterm>
<indexterm><primary>rsync</primary></indexterm>
smbpasswdファイルには平文パスワード相当のものが含まれているので、ネットワーク
上で暗号化しないで送ってはならない。PDCからBDCへのsmbpasswd複製方法の最も良い
設定は、rsyncを使うことである。rsyncは伝送路としてsshを使える。
<command>ssh</command>それ自身は、パスワードの入力をユーザに
<emphasis>要求しない</emphasis><command>rsync</command>転送を設定できる。
</para>

<para>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
少し前に説明したが、この方法を使うことは欠陥があるため危険である。マシン信頼
アカウントは同期から外れ、結果としてドメインが破壊される。この方法は
<emphasis>推奨されない</emphasis>。その代わりにLDAPを使うこと。
</para>

</sect2>

<sect2>
<title>これをすべてのLDAPに使えるか?</title>

<para>
<indexterm><primary>pdb_ldap</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
簡単な答えはyesである。Sambaのpdb_ldapコードはレプリカLDAPサーバに対する
バインドサポートと、データベースに対する変更が必要ならば、referralの
追跡と再バインドを行う(通常BDCはリードオンリで、そのためこれは滅多に
起こらない)。
</para>

</sect2>
</sect1>
</chapter>
