<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<chapter id="samba-bdc">

<chapterinfo>
	&author.jht;
	&author.vl;
	<author>&person.gd;<contrib>LDAP updates</contrib></author>
</chapterinfo>

<title>バックアップドメインコントローラ</title>

<para>
このセクションを読み始める前に、<link linkend="samba-pdc">ドメイン制御</link>
中で説明されているSambaドメインコントローラの設定に自身があるようにして
おくこと。
</para>

<sect1>
<title>機能と利便性</title>

<para>
これは、要約するのが最も難しい章である。ここで何かを言うかが重要ではなく、
まだ提供できていない、あるいは全く違ったアプローチを使うことでより効果的に
達成できるかに、誰かが引き続き結論を描くか、期待を込めてSambaチームに
アプローチする。この本に取り上げられていない持続的な関心事を持っている場合、
要求または質問を明確にして<ulink url="mailto:jht@samba.org">John H. Terpstra</ulink>
まで電子メールを送ってほしい。
</para>

<para>
<indexterm><primary>SAM backend</primary><secondary>LDAP</secondary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>LDAP</primary><secondary>slave</secondary></indexterm>
<indexterm><primary>スケーラビリティ</primary></indexterm>
Samba-3は他のSambaプライマリドメインコントローラ(PDC)へのバックアップドメイン
コントローラ(BDC)として振る舞うことが出来る。Samba-3 PDCはLDAPアカウント
バックエンドと共に動作できる。LDAPバックエンドは共通のマスタLDAPサーバか
スレーブサーバのどちらでも使える。スレーブLDAPサーバの利用は、マスタサーバ
がダウンしたときに、クライアントが引き続きネットワークにログオンできるようになる
という利点がある。これは効果的にSambaに対して高度な拡張性を与え、大規模な
組織のための効果的なソリューションとなる。もしも、PDCにスレーブLDAPサーバを
使うのであれば、マスタサーバの可用性を確保しておく必要がある。&smbmdash;
もしも、スレーブが悪い時間にマスタのダウンを検出したならば、安定性と操作上の
問題が生じるであろう(訳注:最近のOpenLDAPだと、マスタ/スレーブという用語は
使っていない)。
</para>

<para>
<indexterm><primary>two-way</primary><secondary>propagation</secondary></indexterm>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
<indexterm><primary>非LDAP</primary><secondary>バックエンド</secondary></indexterm>
<indexterm><primary>propagate</primary></indexterm>
非LDAPバックエンドでSamba-3 BDCを動かすことが可能ではあるが、そのバックエンドは
なんらかの、BDCからマスタへの"2-way"の更新の伝搬を許可しなければならない。この
点で、LDAPのみが、BDCからPDCへのイデンティティデータベースの変更を伝搬する能力
を提供する。PDCに対してそのプライマリとしてLDAPマスタサーバを使うことが望ましい
間、BDCはスレーブLDAPサーバを使える(訳注:whileをどう訳すか...
The BDC can use a slave LDAP server, while it
is preferable for the PDC to use as its primary an LDAP master server.)。
</para>

<para>
<indexterm><primary>非LDAP</primary><secondary>バックエンド</secondary></indexterm>
<indexterm><primary>SAMバックエンド</primary><secondary>非LDAP</secondary></indexterm>
<indexterm><primary>ドメイン</primary><secondary>メンバ</secondary><tertiary>サーバ</tertiary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>trust account password</primary></indexterm>
<indexterm><primary>domain trust</primary></indexterm>
非LDAPバックエンドSAMデータベースの使用は、ドメインメンバサーバとワーク
ステーションが定期的にマシン信頼アカウントのパスワードを変更するため、
特に問題である。新しいパスワードはローカルにのみ格納される。これは、
もしも、Samba-3がBDCで動いている場合、集中して管理するアカウントデータ
ベース(LDAPベースのソリューションで提供されるようなもの)の欠如を意味し、
ドメインメンバ信頼アカウントパスワードのインスタンスは、PDC(マスタ)のSAMの
コピーに届かない。もしもPDCのSAMがBDCに複製されるならば、更新された
(変更された)信頼アカウントパスワードを含むSAMを上書きし、ドメインの信頼
関係を壊す結果となる。
</para>

<para>
<indexterm><primary>net</primary><secondary>rpc</secondary></indexterm>
<indexterm><primary>SAM backend</primary><secondary>ldapsam</secondary></indexterm>
<indexterm><primary>SAM backend</primary><secondary>tdbsam</secondary></indexterm>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
どのようにBDCを設定するかの、数多いコメントと議論によって発生した質問
を考慮し、おのおの可能なオプションを考慮し、おのおのの解について利点
欠点を見てみよう。
<link linkend="pdc-bdc-table">以下のドメインバックエンドアカウント分散オプション一覧</link>
は、PDC/BDC公正のための可能な設定例の一覧である。
</para>

<table frame="all" id="pdc-bdc-table"><title>ドメインバックエンドアカウント分散オプション</title>
<tgroup cols="3">
        <colspec align="center" colwidth="1*"/>
        <colspec align="center" colwidth="1*"/>
        <colspec align="left" colwidth="3*"/>

        <thead>
        <row><entry>PDCバックエンド</entry><entry>BDCバックエンド</entry><entry>補足事項</entry></row>
        </thead>
        <tbody>
        <row>
        <entry><para>マスタLDAPサーバ</para></entry>
        <entry><para>スレーブLDAPサーバ</para></entry>
        <entry><para>高い完全性を提供する完全なソリューション。SAMは共通マスタLDAPサーバで
	    複製される。</para></entry>
        </row>
        <row>
        <entry><para>単一の集中LDAPサーバ</para></entry>
        <entry><para>単一の集中LDAPサーバ</para></entry>
	<entry><para>
	フェイルオーバ機能がない実用可能なソリューション。これは実用的なソリューションで
	あるが、完全ではない。
	</para></entry>
        </row>
        <row>
        <entry><para>tdbsam</para></entry>
        <entry><para>tdbsam + <command>net rpc vampire</command></para></entry>
        <entry><para>
	Samba-3.0では動かない。Sambaはサーバサイドプロトコル要求を実装していない。
	</para></entry>
        </row>
        <row>
        <entry><para>tdbsam</para></entry>
        <entry><para>tdbsam + <command>rsync</command></para></entry>
        <entry><para>
	この設定を使ってはいけない。データがディスクに完全に書き戻されていない
	かもしれないので、TDBファイルは使用中状態であるため動作しない。
	さらに、ドメインの信頼関係を壊すだろう。
	</para></entry>
        </row>
        <row>
        <entry><para>smbpasswd file</para></entry>
        <entry><para>smbpasswd file</para></entry>
        <entry><para>
	この設定を使ってはいけない。
	同期が遅延するためにエレガントな解ではなく、ドメイン信頼関係
	の問題で悩むだろう。
	</para></entry>
        </row>
        </tbody>
</tgroup>
</table>

</sect1>

<sect1>
<title>本質的な背景について</title>

<para>
<indexterm><primary>ドメインコントローラ</primary></indexterm>
<indexterm><primary>ログオン要求</primary></indexterm>
<indexterm><primary>LanMan</primary></indexterm>
<indexterm><primary>Netlogon</primary></indexterm>
ドメインコントローラは、ネットワーク上のワークステーションからのログオン
要求に答えることが出来るマシンである。Microsoft LanManagerとIBM LanServer
はこの機能を提供していた初期のプロダクトの2つである。その技術は、LanMan 
NetLogonサービスとして知られるようになった。
</para>

<para>
<indexterm>ネットワーク<primary></primary><secondary>ログオン</secondary><tertiary>サービス</tertiary></indexterm>
<indexterm><primary>Windows NT3.10</primary></indexterm>
Microsoft Windows NT3.10が最初にリリースされたとき、拡張された機能を持つ
新しい形式のネットワークログオンサービスを持つ新しい形式のドメイン制御
をサポートした。このサービスはNT NetLogonサービスとして知られるようになった。
このサービスの性質は、Microsoft Windows NTの発展に伴い変更され、現在では
複雑な技術の幅を超えて実装された複雑なサービスの集合体として提供されて
いる。
</para>

<sect2>
<title>Microsoft Windows NT4スタイルのドメイン制御</title>

<para>
<indexterm><primary>ドメインコントローラ</primary></indexterm>
<indexterm><primary>認証サーバ</primary></indexterm>
<indexterm><primary>ユーザ名</primary></indexterm>
<indexterm><primary>パスワード</primary></indexterm>
<indexterm><primary>SAM</primary></indexterm>
<indexterm><primary>Security Account Manager</primary><see>SAM</see></indexterm>
<indexterm><primary>ドメイン制御データベース</primary><see>SAM</see></indexterm>
NT4/200x/XP Professionalワークステーションにユーザがログオンするときは
いつでも、ワークステーションはユーザが入力したユーザ名/パスワードペア
が正しいかを検証するためにドメインコントローラ(認証サーバ)に接続する。
もしも入力された情報がドメイン制御データベース(SAM、すなわちセキュリティ
アカウントマネージャデータベース)に格納されているアカウント情報と
一致しない場合、認証要求を出したワークステーションにいくつかのエラー
コードを返す。
</para>

<para>
<indexterm><primary>アカウント情報</primary></indexterm>
<indexterm><primary>マシンアカウントデータベース</primary></indexterm>
<indexterm><primary>プロファイル</primary></indexterm>
<indexterm><primary>ネットワークアクセスプロファイル</primary></indexterm>
<indexterm><primary>デスクトッププロファイル</primary></indexterm>
ユーザ名/パスワードペアが検証されたとき、ドメインコントローラ(認証サーバ)
はそのドメインに対するユーザとマシンアカウントデータベース中の、そのユーザ
に関係するアカウント情報の完全な項目一覧を返す。この情報はそのユーザに対する
完全なネットワークアクセスプロファイルを含むが、ユーザのデスクトッププロファイル
に特有の情報は含まないか、あるいはそれに関して、ユーザが属してもよいグループ
のためのすべてのデスクトッププロファイルも含まれない。また、それには、
パスワード満了時間、パスワードの一意性制御情報、ネットワークアクセス時間制限
情報、アカウント検証情報、ユーザがアクセスできるネットワークからのマシン名
や空にその他の情報が含まれている。すべての情報はMicrosoft Windows NT(3.10,
 3.50, 3.51, 4.0)バージョン中のSAM中に格納される。
</para>

<para>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
<indexterm><primary>%SystemRoot%\System32\config</primary></indexterm>
<indexterm><primary>C:\WinNT\System32\config</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>SAM</primary></indexterm>
ドメインコントローラ上のアカウント情報(ユーザとマシン)は2つのファイルに格納
され、そのうちの1つにはセキュリティ情報を含み、もう1つはSAMである。それらは
<filename>%SystemRoot%\System32\config</filename>ディレクトリ中に同じ名前で
の同じファイルに格納される。これは通常<filename>C:\WinNT\System32\config</filename>
に変換される。これらはネットワーク上にあるBDCのSAMデータベースの複製で関連
するファイルである。
</para>

<para>
BDCをインストールすることが好ましい2つの状況がある:
</para>

<itemizedlist>
	<listitem><para>
	<indexterm><primary>PDC</primary></indexterm>
	<indexterm><primary>BDC</primary></indexterm>
	PDCがいるローカルネットワーク上で、もしもたくさんのワークステーション
	があるか、PDCが一般的に高負荷な場合。この場合、BDCはネットワーク上
	のログオン要求を拾い、ネットワークサービスの堅牢性を追加するのを支援
	する。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>network</primary><secondary>wide-area</secondary></indexterm>
	おのおののリモートサイトで、広域ネットワークの転送量を減らすためとリモート
	ネットワーク操作の安定性を追加するため。ネットワークのデザインと、戦略的な
	BDCの配置はともに、可能な限りクライアントへのデータ交換をする、たくさんの
	ネットワークの局所化を実装するとともに、必要とする広域ネットワークのバンド
	幅(とコストも)を最小化するのを支援する。
	</para></listitem>
</itemizedlist>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>SAM</primary></indexterm>
<indexterm><primary>ユーザアカウントデータベース</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>trigger</primary></indexterm>
真のWindows NT4環境中でのPDCとBDCの相互運用は、ここで言及する価値がある。PDCは
SAMのマスタコピーを持っている。PDCが持っているローカルネットワーク上に物理的に
ある間にユーザアカウントデータベースへの変更が管理者によって行われるという
イベント中で、変更はSAMのマスタコピーのPDCインスタンスで直接行われるだろう。
別のオフィスでこの更新が行われるというイベントの場合は、変更はローカルBDC
上の差分ファイルに格納されるだろう。BDCはSAM同期を開始するために、PDCに対して
トリガを送る。PDCはドメイン中のすべてのBDCに接続し、差分を入手し、それをそれら
固有のSAMのコピーに適用する。
</para>

<para>
<indexterm><primary>SAM</primary><secondary>複製</secondary></indexterm>
<indexterm><primary>SAM</primary><secondary>差分ファイル</secondary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
Samba-3は真のSAM複製に参加できず、それゆえ、Microsoft Windows NT4で
試用されている同じプロトコルを正確に使用することが出来ない。1つの
Samba-3 BDCはSAM更新差分ファイルを作成できない。BDCが持っている差分
ファイルからSAMの同期をPDC(NT4またはSamba)間で行う操作はできない。
</para>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
Samba-3 はMicrosoft Windows NT4 BDCとしては動作できず、Samba-3は
Microsoft Windows NT4 BDCに対するPDCとして正しく動作できない。
Samba-3とMicrosoft Windows NT4はそれぞれのタイプのPDCへのBDCとして
機能することは出来る。
</para>

<para>
<indexterm><primary>SAM</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>ドメインセキュリティ</primary></indexterm>
BDCはネットワークログオン要求とユーザ認証が出来るところから、
<emphasis>読み出し専用</emphasis>のSAMを保持していると言える。
BDCは、たとえば、PDCへの広域ネットワークがダウンするような場合
特に、このサービスを提供し続けることができる。BDCはネットワーク
の完全性と同様のドメインセキュリティの保守の両方でとても重要な
役割を演じる。
</para>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>昇格</primary></indexterm>
<indexterm><primary>降格</primary></indexterm>
<indexterm><primary>再設定</primary></indexterm>
NT4 PDCが稼働停止の必要がある状態か、停止している時、NT4 BDC
の1つはPDCに昇格することが出来る。もしもNT4 PDCが動作中にこの
ことが発生すると、それは自動的にNT4 BDCに降格する。これは、
ドメインコントローラの管理において重要な観点である。降格および
昇格を行う時に使うツールはドメインサーバマネージャである。Samba-3 
BDCは、Sambaの再設定が&smb.conf;ファイルの変更を必要とするという
理由で、この方式で昇格することは出来ないことに注意。&smb.conf;
ファイルを手動での変更とSambaネットワークサービスに関連したもの
の再起動で十分である。
</para>

<sect3>
<title>PDC設定例</title>

<para>
<indexterm><primary>ドメインログオン</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
バージョン2.2の最初からSambaは公式に、Windows NT4、2003とXP Professional
を含む現行Windowsクライアントすべてでドメインログオン機能を公式にサポート
している。PDCを有効にしたSambaでは&smb.conf;中の<smbconfsection name="[global]"/>
セクション内にいくつかのパラメータを設定しなければならない。最低限
必要な設定の例は<link linkend="minimalPDC">BDCと共に使う、PDC上にLDAP
サーバがあるPDCのための最低限のsmb.conf  &smbmdash;の節</link>
を参照のこと。
</para>

<example id="minimalPDC">
<title>BDCと共に使う、PDC上にLDAPサーバがあるPDCのための最低限のsmb.conf &smbmdash;</title>
<smbconfblock>
<smbconfoption name="workgroup">&example.workgroup;</smbconfoption>
<smbconfoption name="passdb backend">ldapsam://localhost:389</smbconfoption>
<smbconfoption name="domain master">yes</smbconfoption>
<smbconfoption name="domain logons">yes</smbconfoption>
<smbconfoption name="ldap suffix">dc=quenya,dc=org</smbconfoption>
<smbconfoption name="ldap user suffix">ou=Users</smbconfoption>
<smbconfoption name="ldap group suffix">ou=Groups</smbconfoption>
<smbconfoption name="ldap machine suffix">ou=Computers</smbconfoption>
<smbconfoption name="ldap idmap suffix">ou=Idmap</smbconfoption>
<smbconfoption name="ldap admin dn">cn=sambadmin,dc=quenya,dc=org</smbconfoption>
</smbconfblock>
</example>

<para>
<indexterm><primary>profile path</primary></indexterm>
<indexterm><primary>home drive</primary></indexterm>
<smbconfsection name="[homes]"/>と<smbconfsection name="[netlogon]"/>
共有のようないくつかのものもプロファイルパス、ユーザのホームドライブや
その他を設定するために一緒に設定が必要である。これはこの章では
触れられない。詳細な情報については、<link linkend="samba-pdc">ドメイン制御</link>
を参照のこと。PDC設定のための特定の推奨パターンは
<link linkend="samba-pdc">ドメイン制御の章</link>を参照のこと。また別に、
ローカルとオンライン書店から入手できる<quote>Samba-3 by Example</quote>という
書籍(<ulink url="http://www.samba.org/samba/docs/Samba3-ByExample">book</ulink>)
中にOpenLDAPとSambaのネットワーク動作設定例が完全に記述されている。
</para>

</sect3>
</sect2>

<sect2>
<title>LDAP設定の注意</title>

<para>
<indexterm><primary>LDAP</primary><secondary>マスタ</secondary></indexterm>
<indexterm><primary>LDAP</primary><secondary>スレーブ</secondary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
マスタとスレーブLDAPサーバ設定時、マスタLDPサーバをPDCで、スレーブLDAPサーバ
をBDCで使うことは推奨される。スレーブLDAPサーバを使うことは不可欠ではないが、
サービスの冗長性を提供するために多くの管理者はそのことを望んでいる。もちろん、
1つまたはそれ以上のBDCは任意のスレーブLDAPサーバを使うことが出来る。繰り返すと、
ネットワーク全体用に1つのLDAPサーバを使うことは完全に可能である。
</para>

<para>
<indexterm><primary>LDAP</primary><secondary>マスタ</secondary></indexterm>
<indexterm><primary>LDAP</primary><secondary>サーバ</secondary></indexterm>
<indexterm><primary>CN</primary></indexterm>
<indexterm><primary>DN</primary></indexterm>
<indexterm><primary>RFC2830</primary></indexterm>
スレーブLDAPサーバサーバを持つマスタLDAPサーバ設定時、このことを
<filename>/etc/openldap/slapd.conf</filename>ファイル中に設定する
ことを忘れないように。サーバ証明書のDNはサーバの名前のためのCN属性を
使わなければならず、CNはサーバの完全なドメイン名を伝搬しなければならない
ことに注意。追加の別名とワイルドカードは、subjectAltName認証拡張(訳注:
certificate extension)中に存在しても良い。サーバ証明書についてのより詳細
な情報はRFC2830にある。
</para>

<para>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>OpenLDAP</primary></indexterm>
<indexterm><primary>トランスポートレイヤのセキュリティ</primary><see>TLS</see></indexterm>
<indexterm><primary>/etc/ssl/certs/slapd.pem</primary></indexterm>
<indexterm><primary>slapd.pem</primary></indexterm>
<indexterm><primary>Red Hat Linux</primary></indexterm>
この文書の範囲内にはうまく適合しないが、LDAPのインストール作業はLDAPが
有効になっているSamba操作の基本である。トランスポートレイヤのセキュリティ
(TLS)とともにOpenLDAPを使うとき、<filename>/etc/ssl/certs/slapd.pem</filename>
中のマシン名は<filename>/etc/openldap/sldap.conf</filename>と同じものである
必要がある。Red Hat Linuxスタートアップスクリプトはホスト名として、
<quote>localhost.localdomain</quote>とした<filename>slapd.pem</filename>
ファイルを生成する。これだと、正しいホスト名で証明書が再作成されない限り、
スレーブLDAPサーバ(すなわちSamba BDC)からLDAPサーバにアクセスできない。
</para>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>OpenLDAP</primary></indexterm>
<indexterm><primary>マシンアカウント</primary></indexterm>
<indexterm><primary>credentials</primary></indexterm>
<indexterm><primary>複製</primary></indexterm>
<indexterm><primary>duplicate</primary></indexterm>
LDAPスレーブサーバを使う形でSamba PDCをインストールしてはいけない。ドメインへの
クライアントマシンの参加は、LDAPデータベース中へのマシンアカウントの変更がマスタ
LDAPサーバ上で行わなければならないという理由で、この設定では失敗する。これは
PDCが問い合わせるスレーブサーバに十分急速に複製されない。そのため、クライアント
マシン上に、アカウントの証明書がセットアップできないというエラーメッセージが出る。
LDAPサーバ上でマシンアカウントが作成されるが、パスワードファイルは空である。
残念なことに、いくつかのサイトはこのような設定を防げず、それらのサイトは、
レプリケーションに追いつくために、Sambaの処理を十分に遅くするように意図するための、
<smbconfoption name="ldap replication sleep"/>パラメータを検討すべきである。
これは、その場しのぎの解決方法であり、管理者が何らかのスクリプト(たとえば、
<smbconfoption name="add machine script"/>のようなもの)を使って手動で複製
しなければならない。
</para>

<para>
PDC/BDCとLDAPを使う、設定可能なパターンは以下の通り:
</para>

<itemizedlist>
	<listitem><para>
	PDC+BDC -> 1つの集中LDAPサーバ。
	</para></listitem>
	<listitem><para>
	PDC -> LDAP マスタサーバ、 BDC -> LDAPスレーブサーバ。
	</para></listitem>
	<listitem><para>
	PDC -> 第二のスレーブLDAPサーバを使うLDAPマスタ。
	</para><para>
	BDC -> 第二のスレーブLDAPサーバを使うLDAPマスタ。
	</para></listitem>
	<listitem><para>
	PDC -> 第二のスレーブLDAPサーバを使うLDAPマスタ。
	</para><para>
	BDC -> 第二のマスタLDAPサーバを使うLDAPスレーブサーバ。
	</para></listitem>
</itemizedlist>

<para>
(セカンダリ)LDAPサーバサーバの次候補の設定を行うために、
<link linkend="mulitldapcfg">&smb.conf;に記述する複数LDAPサーバの例</link>
を指定する。
</para>

<example id="mulitldapcfg">
<title>&smb.conf;に記述する複数LDAPサーバ</title>
<smbconfblock>
<smbconfoption name="passdb backend">ldapsam:"ldap://master.quenya.org ldap://slave.quenya.org"</smbconfoption>
</smbconfblock>
</example>

</sect2>

<sect2>
<title>Active Directoryドメイン制御</title>

<para>
<indexterm><primary>Microsoft Windows 2000</primary></indexterm>
<indexterm><primary>Active Directory</primary></indexterm>
<indexterm><primary>ディレクトリ</primary></indexterm>
<indexterm><primary>replicated</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>ドメインコントローラ</primary></indexterm>
Microsoft Windows 2000とActive Directoryのリリース時点で、この情報は
複製が出来、部分的あるいは全体の管理者による管理が伝搬できるディレクトリ
中に格納される。Samba-3はActive Directory内でドメインコントローラ
にはなれず、また、Active Directoryサーバにもなれない。これは、Samba-3
はActive DirectoryドメインコントローラのBDCとして振る舞えないことも
意味する。
</para>

</sect2>

<sect2>
<title>何がネットワーク上でドメインコントローラを制限するか?</title>

<para>
<indexterm><primary>DMB</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>WINS</primary></indexterm>
<indexterm><primary>NetBIOS</primary></indexterm>
ドメインMIDEARTH用のドメインコントローラであるおのおののマシンは、
WINSサーバかローカルネットワークに対するブロードキャストを使って
NetBIOSグループ名MIDEARTH&lt;1C&gt;を登録しなければならない。
PDCもWINSサーバを使って一意のNetBIOS名MIDEARTH&lt;1B&gt;を登録する。
名前タイプ&lt;1B&gt;名は通常認証に関連する何らの作業もしない、
ドメインマスタブラウザ(DMB)のために通常予約されるが、Microsoft
ドメインの実装はDMBに対してPDCと同じマシンであることを要求する。
</para>

<para>
<indexterm><primary>ブロードキャスト</primary></indexterm>
<indexterm><primary>名前登録</primary></indexterm>
<indexterm><primary>SMB/CIFS</primary></indexterm>
WINSサーバを使っていないとき、ブロードキャスト名前登録はそれだけで
十分になっていなければならない。<link linkend="NetworkBrowsing">ネットワークブラウジング</link>
と<link linkend="netdiscuss">Discussion</link>に、TCP/IPネットワーク
プロトコル関連と、どのようにSMB/CIFS名前が扱うかについてのより詳細な
情報があるので参照すること。
</para>

</sect2>

<sect2>
<title>どのようにワークステーションがそのドメインコントローラを探すか?</title>

<para>
<indexterm><primary>ドメインコントローラへの位置づけ</primary></indexterm>
<indexterm><primary>NetBIOS</primary></indexterm>
ドメインコントローラの位置を見つけるのには2つのメカニズムがある:1つは
NetBIOS over TCP/IPが有効なときに使われ、もう1つはTCP/IPネットワーク設定
で無効になっているときである。
</para>

<para>
<indexterm><primary>DNS</primary></indexterm>
<indexterm><primary>broadcast messaging</primary></indexterm>
NetBIOS over TCP/IPが無効になっているとき、すべての名前解決は、
Active Directory通信技術のような、DNS、UDP上のブロードキャストを使う。
このタイプの環境では、すべてのマシンは適切なDNSエントリを必要とする。
より詳細な情報は<link linkend="adsdnstech">DNSとActive Directory</link>
にある。
</para>

<sect3>
<title>NetBIOS Over TCP/IPが有効</title>
<para>
<indexterm><primary>Windows NT4/200x/XP</primary></indexterm>
<indexterm><primary>ドメインコントローラ</primary></indexterm>
<indexterm><primary>ログオン要求</primary></indexterm>
<indexterm><primary>credentials validation</primary></indexterm>

ローカルユーザを認証させたいドメインMIDEARTH内の
Microsoft Windows NT4/200x/XP Professionalワークステーションは、
MIDEARTHのドメインコントローラを見つける必要がある。これは、グループ名
MIDEARTH&lt;1C&gt;に対するNetBIOS名前解決を行うことによって行われる。
問い合わせから結果をもどす、おのおののマシンはドメインコントローラで
あり、ログイン要求に答えることが出来ることを仮定している。セキュリティ
ホールを造らないために、ワークステーションと選択されたドメインコントローラ
はおのおのを認証する。その後、ワークステーションはユーザの認証情報(
ユーザ名/パスワードペア)を認証のためにローカルのドメインコントローラに
送る。
</para>

</sect3>

<sect3>
<title>NetBIOS Over TCP/IPが無効</title>

<para>
<indexterm><primary>realm</primary></indexterm>
<indexterm><primary>ログオン認証</primary></indexterm>
<indexterm><primary>DNS</primary></indexterm>
<indexterm><primary>_ldap._tcp.pdc._msdcs.quenya.org</primary></indexterm>
ユーザログオン認証に影響を与えることを必要とする realm <constant>quenya.org</constant>
中のMicrosoft Windows NT4/200x/XP Professional workstationは
<constant>_ldap._tcp.pdc._msdcs.quenya.org</constant>レコードをDNS
サーバに対して再度問い合わせすることでドメインコントローラの位置を
見つける。この項目に対する関連したより詳細な情報は、
<link linkend="adsdnstech">DNSとActive Directory</link>にある。
</para>

</sect3>
</sect2>
</sect1>

<sect1>
<title>バックアップドメインコントローラの設定</title>

<para>
<indexterm><primary>BDC</primary></indexterm>
BDCの作成には最初に&smbd;を動かす前にSamba サーバを準備するため
のいくつかのステップが要求される。
</para>

<itemizedlist>
	<listitem><para>
	<indexterm><primary>SID</primary></indexterm>
	<indexterm><primary>PDC</primary></indexterm>
	<indexterm><primary>BDC</primary></indexterm>
	<indexterm><primary>private/secrets.tdb</primary></indexterm>
	<indexterm><primary>private/MACHINE.SID</primary></indexterm>
	<indexterm><primary>ドメインSID</primary></indexterm>
	ドメインSIDはPDCとBDCで同じにしなければならない。バージョン2.2.5
	以前のSambaでは、ドメインSIDは<filename>private/MACHINE.SID</filename>
	ファイルに格納されていた。バージョン2.2.5以降すべてのバージョンの
	Sambaでは、ドメインSIDは<filename>private/secrets.tdb</filename>ファイルに
	格納されている。このファイルはおのおののサーバで固有であり、PDCからBDCに
	コピーできない。BDCは新しいSIDを起動時に生成する。新しく生成したBDCのSID
	でPDCのドメインSIDを上書きする。これは、BDCにドメインSIDを入手することを
	認める手続きである。これについては以下で説明する。
	</para>

	<para>
	<indexterm><primary>ドメインSID</primary></indexterm>
	<indexterm><primary>PDC</primary></indexterm>
	<indexterm><primary>BDC</primary></indexterm>
	<indexterm><primary>secrets.tdb</primary></indexterm>
	<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>getsid</tertiary></indexterm>
	PDCまたは存在するBDCからドメインSIDを検索するためと、それを
	<filename>secrets.tdb</filename>に格納するためには、以下を実行する:
	</para>
<screen>
&rootprompt;<userinput>net rpc getsid</userinput>
</screen>
	</listitem>

	<listitem><para>
	<indexterm><primary>secrets.tdb</primary></indexterm>
	<indexterm><primary>smbpasswd</primary></indexterm>
	<indexterm><primary>LDAP administration password</primary></indexterm>
	Specification of the <smbconfoption name="ldap admin dn"/> is obligatory.
	This also requires the LDAP administration password to be set in the <filename>secrets.tdb</filename>
	using the <command>smbpasswd -w <replaceable>mysecret</replaceable></command>.
	</para></listitem>

	<listitem><para>
	The <smbconfoption name="ldap suffix"/> parameter and the <smbconfoption name="ldap idmap suffix"/>
	parameter must be specified in the &smb.conf; file.
	</para></listitem>

	<listitem><para>
	<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
	<indexterm><primary>user database</primary></indexterm>
	<indexterm><primary>synchronized</primary></indexterm>
	<indexterm><primary>NIS</primary></indexterm>
	The UNIX user database has to be synchronized from the PDC to the
	BDC. This means that both the <filename>/etc/passwd</filename> and
	<filename>/etc/group</filename> have to be replicated from the PDC
	to the BDC. This can be done manually whenever changes are made. 
	Alternately, the PDC is set up as an NIS master server and the BDC as an NIS slave
	server. To set up the BDC as a mere NIS client would not be enough,
	as the BDC would not be able to access its user database in case of
	a PDC failure. NIS is by no means the only method to synchronize
	passwords. An LDAP solution would also work.
	</para>
	</listitem>

	<listitem><para>
	<indexterm><primary>password database</primary></indexterm>
	<indexterm><primary>replicated</primary></indexterm>
	<indexterm><primary>PDC</primary></indexterm>
	<indexterm><primary>BDC</primary></indexterm>
	<indexterm><primary>smbpasswd</primary></indexterm>
	<indexterm><primary>rsync</primary></indexterm>
	<indexterm><primary>ssh</primary></indexterm>
	<indexterm><primary>LDAP</primary></indexterm>
	The Samba password database must be replicated from the PDC to the BDC.
	Although it is possible to synchronize the <filename>smbpasswd</filename>
	file with <command>rsync</command> and <command>ssh</command>, this method
	is broken and flawed, and is therefore not recommended. A better solution
	is to set up slave LDAP servers for each BDC and a master LDAP server for the PDC.
	The use of rsync is inherently flawed by the fact that the data will be replicated
	at timed intervals. There is no guarantee that the BDC will be operating at all
	times with correct and current machine and user account information. This means that
	this method runs the risk of users being inconvenienced by discontinuity of access
	to network services due to inconsistent security data. It must be born in mind that
	Windows workstations update (change) the machine trust account password at regular
	intervals &smbmdash; administrators are not normally aware that this is happening
	or when it takes place.
	</para>

	<para>
	<indexterm><primary>POSIX</primary></indexterm>
	<indexterm><primary>LDAP</primary></indexterm>
	<indexterm><primary>SambaSAMAccount</primary></indexterm>
	<indexterm><primary>synchronize</primary></indexterm>
	The use of LDAP for both the POSIX (UNIX user and group) accounts and for the
	SambaSAMAccount data automatically ensures that all account change information
	will be written to the shared directory. This eliminates the need for any special
	action to synchronize account information because LDAP will meet that requirement.
	</para></listitem>

	<listitem><para>
	<indexterm><primary>netlogon share</primary></indexterm>
	<indexterm><primary>replicate</primary></indexterm>
	<indexterm><primary>PDC</primary></indexterm>
	<indexterm><primary>BDC</primary></indexterm>
	<indexterm><primary>cron</primary></indexterm>
	<indexterm><primary>rsync</primary></indexterm>
	The netlogon share has to be replicated from the PDC to the BDC. This can be done manually whenever login
	scripts are changed, or it can be done automatically using a <command>cron</command> job that will replicate
	the directory structure in this share using a tool like <command>rsync</command>. The use of
	<command>rsync</command> for replication of the netlogon data is not critical to network security and is one
	that can be manually managed given that the administrator will make all changes to the netlogon share as part
	of a conscious move.
	</para></listitem>

</itemizedlist>

<sect2>
<title>Example Configuration</title>

<para>
Finally, the BDC has to be capable of being found by the workstations. This can be done by configuring the
Samba &smb.conf; file <smbconfsection name="[global]"/> section as shown in <link linkend="minim-bdc">Minimal
Setup for Being a BDC</link>.
</para>

<example id="minim-bdc">
<title>Minimal Setup for Being a BDC</title>
<smbconfblock>
<smbconfoption name="workgroup">&example.workgroup;</smbconfoption>
<smbconfoption name="passdb backend">ldapsam:ldap://slave-ldap.quenya.org</smbconfoption>
<smbconfoption name="domain master">no</smbconfoption>
<smbconfoption name="domain logons">yes</smbconfoption>
<smbconfoption name="ldap suffix">dc=abmas,dc=biz</smbconfoption>
<smbconfoption name="ldap user suffix">ou=Users</smbconfoption>
<smbconfoption name="ldap group suffix">ou=Groups</smbconfoption>
<smbconfoption name="ldap machine suffix">ou=Computers</smbconfoption>
<smbconfoption name="ldap idmap suffix">ou=Idmap</smbconfoption>
<smbconfoption name="ldap admin dn">cn=sambadmin,dc=quenya,dc=org</smbconfoption>
<smbconfoption name="idmap backend">ldap:ldap://master-ldap.quenya.org</smbconfoption>
<smbconfoption name="idmap uid">10000-20000</smbconfoption>
<smbconfoption name="idmap gid">10000-20000</smbconfoption>
</smbconfblock>
</example>

<para>
Fully documented working example network configurations using OpenLDAP and Samba
as available in the <ulink url="http://www.samba.org/samba/docs/Samba3-ByExample">book</ulink> <quote>Samba-3
by Example</quote> that may be obtained from local and on-line book stores.
</para>

<para>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>NetBIOS</primary></indexterm>
<indexterm><primary>group</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
This configuration causes the BDC to register only the name MIDEARTH&lt;1C&gt; with the WINS server. This is
not a problem, as the name MIDEARTH&lt;1C&gt; is a NetBIOS group name that is meant to be registered by more
than one machine. The parameter <smbconfoption name="domain master">no</smbconfoption> forces the BDC not to
register MIDEARTH&lt;1B&gt;, which is a unique NetBIOS name that is reserved for the PDC.
</para>

<para>
<indexterm><primary>idmap backend</primary></indexterm>
<indexterm><primary>winbindd</primary></indexterm>
<indexterm><primary>redirect</primary></indexterm>
<indexterm><primary>winbindd</primary></indexterm>
<indexterm><primary>LDAP database</primary></indexterm>
<indexterm><primary>UID</primary></indexterm>
<indexterm><primary>GID</primary></indexterm>
<indexterm><primary>SID</primary></indexterm>
<indexterm><primary>nss_ldap</primary></indexterm>
The <parameter>idmap backend</parameter> will redirect the <command>winbindd</command> utility to use the LDAP
database to store all mappings for Windows SIDs to  UIDs and GIDs for UNIX accounts in a repository that is
shared. The BDC will however depend on local resolution of UIDs and GIDs via NSS and the
<command>nss_ldap</command> utility.
</para>

<note><para>
<indexterm><primary>Server Type</primary><secondary>Domain Member</secondary></indexterm>
<indexterm><primary>ID mapping</primary></indexterm>
<indexterm><primary>domain member server</primary></indexterm>
<indexterm><primary>idmap backend</primary></indexterm>
Samba-3 has introduced a new ID mapping facility. One of the features of this facility is that it
allows greater flexibility in how user and group IDs are handled in respect to NT domain user and group
SIDs. One of the new facilities provides for explicitly ensuring that UNIX/Linux UID and GID values
will be consistent on the PDC, all BDCs, and all domain member servers. The parameter that controls this
is called <parameter>idmap backend</parameter>. Please refer to the man page for &smb.conf; for more information
regarding its behavior.
</para></note>

<para>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>winbindd</primary></indexterm>
<indexterm><primary>domain member servers</primary></indexterm>
The use of the <smbconfoption name="idmap backend">ldap:ldap://master.quenya.org</smbconfoption>
option on a BDC only makes sense where ldapsam is used on a PDC. The purpose of an LDAP-based idmap backend is
also to allow a domain member (without its own passdb backend) to use winbindd to resolve Windows network users
and groups to common UID/GIDs. In other words, this option is generally intended for use on BDCs and on domain
member servers.
</para>

</sect2>
</sect1>

<sect1>
<title>Common Errors</title>

<para>
<indexterm><primary>domain control</primary></indexterm>
Domain control was a new area for Samba, but there are now many examples that we may refer to.
Updated information will be published as they become available and may be found in later Samba releases or
from the Samba Web <ulink url="http://samba.org">site</ulink>; refer in particular to the
<filename>WHATSNEW.txt</filename> in the Samba release tarball. The book, <quote>Samba-3 by Example</quote>
documents well tested and proven configuration examples. You can obtain a copy of this
<ulink url="http://www.samba.org/samba/docs/Samba3-ByExample.pdf">book</ulink> for the Samba web site.
</para>

<sect2>
<title>Machine Accounts Keep Expiring</title>

<para>
<indexterm><primary>Machine Trust Accounts</primary></indexterm>
<indexterm><primary>passdb</primary></indexterm>
<indexterm><primary>SAM</primary></indexterm>
<indexterm><primary>Local Machine Trust Account</primary></indexterm>
This problem will occur when the passdb (SAM) files are copied  from a central
server but the local BDC is acting as a PDC. This results in the application of
Local Machine Trust Account password updates to the local SAM. Such updates 
are not copied back to the central server. The newer machine account password is then
overwritten when the SAM is recopied from the PDC. The result is that the domain member machine
on startup will find that its passwords do not match the one now in the database, and
since the startup security check will now fail, this machine will not allow logon attempts
to proceed and the account expiry error will be reported.
</para>

<para>
The solution is to use a more robust passdb backend, such as the ldapsam backend, setting up
a slave LDAP server for each BDC and a master LDAP server for the PDC.
</para>

</sect2>

<sect2>
<title>Can Samba Be a Backup Domain Controller to an NT4 PDC?</title>

<para>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
<indexterm><primary>SAM</primary></indexterm>
No. The native NT4 SAM replication protocols have not yet been fully implemented.
</para>

<para>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>logon requests</primary></indexterm>
Can I get the benefits of a BDC with Samba?  Yes, but only to a Samba PDC.The
main reason for implementing a BDC is availability. If the PDC is a Samba
machine, a second Samba machine can be set up to service logon requests whenever
the PDC is down.
</para>

</sect2>

<sect2>
<title>How Do I Replicate the smbpasswd File?</title>

<para>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
<indexterm><primary>smbpasswd</primary></indexterm>
<indexterm><primary>SAM</primary></indexterm>
Replication of the smbpasswd file is sensitive. It has to be done whenever changes
to the SAM are made. Every user's password change is done in the smbpasswd file and
has to be replicated to the BDC. So replicating the smbpasswd file very often is necessary.
</para>

<para>
<indexterm><primary>plaintext password</primary></indexterm>
<indexterm><primary>ssh</primary></indexterm>
<indexterm><primary>rsync</primary></indexterm>
As the smbpasswd file contains plaintext password equivalents, it must not be
sent unencrypted over the wire. The best way to set up smbpasswd replication from
the PDC to the BDC is to use the utility rsync. rsync can use ssh as a transport.
<command>ssh</command> itself can be set up to accept <emphasis>only</emphasis>
<command>rsync</command> transfer without requiring the user to type a password.
</para>

<para>
<indexterm><primary>machine trust accounts</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
As said a few times before, use of this method is broken and flawed. Machine trust 
accounts will go out of sync, resulting in a broken domain. This method is
<emphasis>not</emphasis> recommended. Try using LDAP instead.
</para>

</sect2>

<sect2>
<title>Can I Do This All with LDAP?</title>

<para>
<indexterm><primary>pdb_ldap</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
The simple answer is yes. Samba's pdb_ldap code supports binding to a replica
LDAP server and will also follow referrals and rebind to the master if it ever
needs to make a modification to the database. (Normally BDCs are read-only, so
this will not occur often).
</para>

</sect2>
</sect1>
</chapter>
