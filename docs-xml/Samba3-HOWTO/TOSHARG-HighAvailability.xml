<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<chapter id="SambaHA">
<chapterinfo>
	&author.jht;
	&author.jeremy;
</chapterinfo>

<title>高可用性</title>

<sect1>
<title>機能と利便性</title>

<para>
<indexterm><primary>可用性</primary></indexterm>
<indexterm><primary>intolerance</primary></indexterm>
<indexterm><primary>vital task</primary></indexterm>
ネットワーク管理者は、しばしばファイルと印刷サービスの可用性について関心を持っている。
ネットワークユーザは、きわめて重要な、責任ある仕事を遂行するのに依存するサービスに
対して、厳しい態度をとりがちである。
</para>

<para>
コンピュータルームにあるサインが、スタッフに、彼らの責任を思い出させるのに
役に立った。それは以下のようなものであった:
A sign in a computer room served to remind staff of their responsibilities. It read:
</para>

<blockquote>
<para>
<indexterm><primary>fail</primary></indexterm>
<indexterm><primary>managed by humans</primary></indexterm>
<indexterm><primary>economically wise</primary></indexterm>
<indexterm><primary>anticipate failure</primary></indexterm>
すべての人間は間違う、大きな事でも小さな事でも、絶えず失敗する方法で。機械も同様に
故障する。コンピュータは、人によって管理する機械であり、故障の結果は鮮烈である。
あなたの責任は、失敗を扱うことであり、それを予想することであり、人間らしさを
可能な限り排除し、適切な費用で目的を達成することである。
あなたの動作は、問題の一部分か、あるいは解決方法の一部分だろうか?
All humans fail, in both great and small ways we fail continually. Machines fail too.
Computers are machines that are managed by humans, the fallout from failure
can be spectacular. Your responsibility is to deal with failure, to anticipate it
and to eliminate it as far as is humanly and economically wise to achieve.
Are your actions part of the problem or part of the solution?
</para>
</blockquote>

<para>
もしも、計画された、かつ精算セキュリティな方法で障害を扱うならば、最初に問題を理解する
必要がある。それがこの章の目的である。
</para>

<para>
<indexterm><primary>高可用性high availability</primary></indexterm>
<indexterm><primary>CIFS/SMB</primary></indexterm>
<indexterm><primary>state of knowledge</primary></indexterm>
付加的に、以下の議論の中には、障害に対してどのようにネットワーク基盤を提供するかに
ついての情報の元が存在する。ここでの目的は、高可用性という題に対する長い論文を
提供することではない。さらに追加すると、高可用性ソリューションの詳細な動作例を
提供しないということを、意識的に行っている。その代わりに、
Sambaと他のCIFS/SMB技術の実装に適用する、高可用性における知識と習慣の現在の状態の
プレゼンテーションにおいて、純粋に着目する、詳細な文書を提供する試みを、誰かが
立ち上げるだろうという希望的観測をこめて、問題の概要を提供する。
Parenthetically, in the following discussion there are seeds of information on how to
provision a network infrastructure against failure. Our purpose here is not to provide
a lengthy dissertation on the subject of high availability. Additionally, we have made
a conscious decision to not provide detailed working examples of high availability
solutions; instead we present an overview of the issues in the hope that someone will
rise to the challenge of providing a detailed document that is focused purely on
presentation of the current state of knowledge and practice in high availability as it
applies to the deployment of Samba and other CIFS/SMB technologies.
</para>

</sect1>

<sect1>
<title>技術的な議論</title>

<para>
<indexterm><primary>SambaXPカンファレンス</primary></indexterm>
<indexterm><primary>ドイツ</primary></indexterm>
<indexterm><primary>inspired structure</primary></indexterm>
以下の要約は、2003年4月に、ドイツのゲッティンンゲンで行われた、SambaXP 2003
カンファレンスで、Jeremy Allisonによって発表されたものの一部である。
素材は他のソースから追加されたが、それをフォローする構造にインスパイアされた
のはJeremyであった。
The following summary was part of a presentation by Jeremy Allison at the SambaXP 2003
conference that was held at Goettingen, Germany, in April 2003. Material has been added
from other sources, but it was Jeremy who inspired the structure that follows.
</para>

	<sect2>
	<title>最終目的</title>

	<para>
<indexterm><primary>クラスタリング技術</primary></indexterm>
<indexterm><primary>affordable power</primary></indexterm>
<indexterm><primary>無停止サービス</primary></indexterm>
	すべてのクラスタリング技術は以下の1つあるいはそれ以上を達成することを目的としている:
	</para>

	<itemizedlist>
		<listitem><para>コンピュータの能力を最大限使えること。</para></listitem>
		<listitem><para>より高速なプロトコル実行を行うこと。</para></listitem>
		<listitem><para>無停止サービスを提供すること。</para></listitem>
		<listitem><para>単一障害点を避けること。</para></listitem>
		<listitem><para>資源を最も効果的に使うこと。</para></listitem>
	</itemizedlist>

	<para>
	クラスタ化されたファイルサーバは理想的に以下の属性を有している:
<indexterm><primary>クラスタ化されたファイルサーバ</primary></indexterm>
<indexterm><primary>透過的な接続</primary></indexterm>
<indexterm><primary>透過的な再接続</primary></indexterm>
<indexterm><primary>分散ファイルシステム</primary></indexterm>
	</para>

	<itemizedlist>
		<listitem><para>すべてのクライアントはどのサーバにも透過的に接続できる。</para></listitem>
		<listitem><para>サーバが故障するとクライアントは透過的に他のサーバに再接続できる。</para></listitem>
		<listitem><para>すべてのサーバは、同じファイル群を提供する。</para></listitem>
		<listitem><para>すべてのファイルの変更は、すべてのサーバで直接行われるように見える。</para>
			<itemizedlist><listitem><para>分散ファイルシステムが必要。</para></listitem></itemizedlist></listitem>
		<listitem><para>より多くのサーバやディスクを追加することで、無限に拡張できる。</para></listitem>
	</itemizedlist>

	</sect2>

	<sect2>
	<title>これがなぜ難しいか?</title>

	<para>
	簡単に言うと、問題は<emphasis>状態(state)</emphasis>にある。
	</para>

	<itemizedlist>
		<listitem>
			<para>
<indexterm><primary>state information</primary></indexterm>
			すべてのTCP/IP接続はステート情報に依存する。
			</para>
			<para>
<indexterm><primary>TCP failover</primary></indexterm>
			TCP接続はパケットシーケンス番号を持っている。このシーケンス
			番号は、シームレスなTCPフェールオーバーを引き起こすために、
			クラスタ中で、すべてのマシン上で動的に更新される必要がある。
			</para>
		</listitem>
		<listitem>
			<para>
<indexterm><primary>CIFS/SMB</primary></indexterm>
<indexterm><primary>TCP</primary></indexterm>
			CIFS/SMB(Windowsネットワークプロトコル)はTCP接続を使用している。
			</para>
			<para>
			これは、基本的な設計の見地から、フェイルオーバーは真剣に考慮
			されていない事を意味する。
			<itemizedlist>
				<listitem><para>
				すべての現在のSMBクラスタはフェールオーバーソリューション
				である。&smbmdash;これらは再接続するクライアントに
				頼っている。これは、サーバのフェールオーバーを提供するが、
				クライアントはサーバの故障のために情報を失う可能性がある。
<indexterm><primary>サーバの故障</primary></indexterm>
				</para></listitem>
			</itemizedlist>
			</para>
		</listitem>
		<listitem>
			<para>
			サーバはクライアント接続に関するステート情報を保存する。
			<itemizedlist>
<indexterm><primary>state</primary></indexterm>
				<listitem><para>CIFS/SMBには多くのステートがある。</para></listitem>
				<listitem><para>すべてのファイルのオープンは、共有モードを
				    チェックするために他のオープンしているファイルと比較する。</para></listitem>
			</itemizedlist>
			</para>
		</listitem>
	</itemizedlist>

		<sect3>
		<title>最先端の状況</title>

		<para>
<indexterm><primary>クラスタサービス</primary></indexterm>
<indexterm><primary>単一サーバ</primary></indexterm>
<indexterm><primary>TCPデータストリーム</primary></indexterm>
<indexterm><primary>front-end virtual server</primary></indexterm>
<indexterm><primary>仮想サーバ</primary></indexterm>
<indexterm><primary>de-multiplex</primary></indexterm>
<indexterm><primary>SMB</primary></indexterm>
		1つの名前と1つのIPアドレスを持つ単一のサーバのように、ファイルサーバの
		クラスタを見せるためにすることは可能で、クライアントから受信した
		TCPデータストリームはフロントエンドの仮想サーバによって処理される必要が
		ある。このサーバはSMBプロトコルレイヤレベルで、入力したパケットを分割し、
		次に、クラスタ中の異なったサーバにSMBパケットを中継する。
		</para>

		<para>
<indexterm><primary>IPC$接続</primary></indexterm>
<indexterm><primary>RPC呼び出し</primary></indexterm>
		印刷とユーザ検索要求を扱うために、1つのサーバに対する、すべてのIPC$接続と
		RPC呼び出しを分割することができた。RPC印刷ハンドルは、異なったIPC$
		セッションで共有される。&smbmdash;これはクラスタサーバをまたがって
		これを分割するのは難しい!
		One could split all IPC$ connections and RPC calls to one server to handle printing and user
		lookup requirements. RPC printing handles are shared between different IPC4 sessions &smbmdash; it is
		hard to split this across clustered servers!
		</para>

		<para>
		概念的に、すべての他のサーバはファイルサービスのみ提供する。これは
		集中するよりも簡単な問題である。
		Conceptually speaking, all other servers would then provide only file services. This is a simpler
		problem to concentrate on.
		</para>

		</sect3>

		<sect3>
		<title>SMBリクエストの分割</title>

		<para>
<indexterm><primary>SMBリクエスト</primary></indexterm>
<indexterm><primary>SMBステート情報</primary></indexterm>
<indexterm><primary>フロントエンド仮想サーバ</primary></indexterm>
<indexterm><primary>込み入った問題</primary></indexterm>
		SMBリクエストを分割する事は、SMBステート情報を知っていることが要求され、そのすべては
		フロントエンドの<emphasis>仮想</emphasis>サーバによって保持されねばならない。
		これは解決するのには複雑で難しい問題である。
		</para>

		<para>
<indexterm><primary>vuid</primary></indexterm>
<indexterm><primary>tid</primary></indexterm>
<indexterm><primary>fid</primary></indexterm>
		Windows XPとその後継は、その意味を変更し、そのため、ステート情報
		(vuid,tid,fid)は操作が成功するために一致しなければならない。これは、
		以前よりも物事を単純にし、前へ進むためのよい一歩である。
		</para>

		<para>
<indexterm><primary>SMBリクエスト</primary></indexterm>
<indexterm><primary>ターミナルサーバ</primary></indexterm>
		SMBリクエストは、それに対応するサーバにvuidによって送られる。
		このソリューションを作り出すコードは現在存在しない。この問題は、
		Samba中で、Windows 2000ターミナルサーバからの複数のリクエストからの
		リクエストを正しく処理する問題と、概念的に似ている。
		</para>

		<para>
<indexterm><primary>分割</primary></indexterm>
		直接クライアントにサーバプールを提示することで開始するという
		1つの可能性がある。これは、分割ステップを省略できる。
		</para>

		</sect3>

		<sect3>
		<title>分散ファイルシステムの試み</title>

		<para>
<indexterm><primary>分散ファイルシステム</primary></indexterm>
		UNIXとLinux用に、たくさんの分散ファイルシステムがある。
		</para>

		<para>
<indexterm><primary>バックエンド</primary></indexterm>
<indexterm><primary>SMB semantics</primary></indexterm>
<indexterm><primary>共有モード</primary></indexterm>
<indexterm><primary>locking</primary></indexterm>
<indexterm><primary>oplock</primary></indexterm>
<indexterm><primary>分散ファイルシステム</primary></indexterm>
		SMB文法を認識することを、ずっと心にとめている間は、我々のクラスタの
		バックエンドに多くが適用できる(共有モード、ロックとoplock問題は特に)。
		一般的な自由に使える分散ファイルシステムには以下がある:
		Many could be adopted to backend our cluster, so long as awareness of SMB
		semantics is kept in mind (share modes, locking, and oplock issues in particular).
		Common free distributed file systems include:
<indexterm><primary>NFS</primary></indexterm>
<indexterm><primary>AFS</primary></indexterm>
<indexterm><primary>OpenGFS</primary></indexterm>
<indexterm><primary>Lustre</primary></indexterm>
		</para>

		<itemizedlist>
			<listitem><para>NFS</para></listitem>
			<listitem><para>AFS</para></listitem>
			<listitem><para>OpenGFS</para></listitem>
			<listitem><para>Lustre</para></listitem>
		</itemizedlist>

		<para>
<indexterm><primary>サーバプール</primary></indexterm>
		サーバプール(クラスタ)は、もしもすべてのSMB文法がそのプール内で実行出来るならば、
		任意の分散ファイルシステムを使える。
		</para>

		</sect3>

		<sect3>
		<title>分散ファイルシステム上の限定的な制約</title>

		<para>
<indexterm><primary>SMBサービス</primary></indexterm>
<indexterm><primary>oplockハンドリング</primary></indexterm>
<indexterm><primary>サーバプール</primary></indexterm>
<indexterm><primary>backend file system pool</primary></indexterm>
		クラスタ化されたサーバが純粋なSMBサービスを提供するとき、oplockの
		取り扱いは、バックエンドのファイルシステムプールに渡される必要なしに
		サーバプール内で完了してもよい。
		Where a clustered server provides purely SMB services, oplock handling
		may be done within the server pool without imposing a need for this to
		be passed to the backend file system pool.
		</para>

		<para>
<indexterm><primary>NFS</primary></indexterm>
<indexterm><primary>相互運用性</primary></indexterm>
		他方、サーバプールがNFSや他のファイルサービスをも提供する場合、
		SMBサービスと相互運用できるように、oplockを認識する実装は基本である。
		これは、現在有意義な挑戦である。これの相互運用性の提供に失敗すると、
		Microsoft Windows クライアントのユーザによってはっきりと気がつく
		明確な性能の低下をもたらす。
		</para>

		<para>
		最後に、すべてのステート情報は、サーバプール間で共有されるべきである。
		</para>

		</sect3>

		<sect3>
		<title>サーバプールの通信</title>

		<para>
<indexterm><primary>POSIX semantics</primary></indexterm>
<indexterm><primary>SMB</primary></indexterm>
<indexterm><primary>POSIX locks</primary></indexterm>
<indexterm><primary>SMB locks</primary></indexterm>
		ほとんどのバックエンドファイルシステムは、POSIXファイルシステムを
		サポートしている。これは、SMB文法をファイルシステム中で使うことを
		困難にしている。POSIXのロック機構は、SMBのロック機構とは異なる
		属性と文法である。
		</para>

		<para>
<indexterm><primary>smbd</primary></indexterm>
<indexterm><primary>tdb</primary></indexterm>
<indexterm><primary>クラスタ化されたsmbd</primary></indexterm>
		サーバプール中のすべての<command>smbd</command>プロセスはごく短時間に
		通信しなければならない。このため、Sambaが使う現在の
		<parameter>tdb</parameter>ファイル構造はネットワーク間で使うのには
		適していない。クラスタ化された<command>smbd</command>は何らかの、
		他のものを使う必要がある。
		</para>

		</sect3>

		<sect3>
		<title>サーバプール通信の要求</title>

		<para>
		サーバプール内の高速サーバ間通信は、完全に機能するシステムのために
		あらかじめ必要な機能である。これを可能にするものは以下のものがある:
		</para>

		<itemizedlist>
<indexterm><primary>Myrinet</primary></indexterm>
<indexterm><primary>scalable coherent interface</primary><see>SCI</see></indexterm>
			<listitem><para>
			商用の共有メモリバス(例:MyrinetまたはSCI [scalable coherent interface])。
			これはとても価格が高い。
			</para></listitem>
		
			<listitem><para>
			ギガビットイーサネット(現在簡単に使える)。
			</para></listitem>
		
			<listitem><para>
			生のイーサネットフレーミング(TCPとUDPのオーバヘッドをバイパス)。
			</para></listitem>
		</itemizedlist>

		<para>
		これを有効にし、効果的にするための性能要求のための計測を識別することは
		まだしていない。
		We have yet to identify metrics for  performance demands to enable this to happen
		effectively.
		</para>

		</sect3>

		<sect3>
		<title>Sambaに対する変更要求</title>

		<para>
		Sambaは、透過的なフィルオーバクラスタが出来るように、高速サーバ間接続システムで
		動くように、明確に修正する必要がある。
		</para>

		<para>
		影響を受けると思われるSamba内の特定の機能は以下の通り:
		</para>

		<itemizedlist>
			<listitem><para>
			データベースのロック、oplockの通知と共有モードデータベース。
			</para></listitem>

			<listitem><para>
<indexterm><primary>failure semantics</primary></indexterm>
<indexterm><primary>oplock messages</primary></indexterm>
			障害の意味を定義する必要がある。SambaはWindowsと同じように
			振る舞う。oplockメッセージが失敗したとき、ファイルオープン
			要求は許可されるが、これはクラスタ環境では潜在的に危険である。
			そのため、どのようにサーバ間プールの障害の意味が機能するかと、
			どのようにそのような機能を実装したらよいだろうか?
			Failure semantics need to be defined. Samba behaves the same way as Windows.
			When oplock messages fail, a file open request is allowed, but this is 
			potentially dangerous in a clustered environment. So how should interserver
			pool failure semantics function, and how should such functionality be implemented?
			</para></listitem>

			<listitem><para>
			これはポイントツーポイントロックマネージャを使って実装すべきか、
			あるいは、マルチキャスト手法を使って行うべきだろうか?
			</para></listitem>

		</itemizedlist>

		</sect3>
	</sect2>

	<sect2>
	<title>簡単なソリューション</title>

	<para>
<indexterm><primary>フェイルオーバサーバ</primary></indexterm>
<indexterm><primary>エクスポートされたファイルシステム</primary></indexterm>
<indexterm><primary>分散ロックプロトコル</primary></indexterm>
	フェイルオーバサーバにエクスポートされたファイルシステム内で異なった機能を
	扱えるようにすることは、分散ロッキングプロトコルを要求する問題をなくす。
	</para>

	<para>
<indexterm><primary>high-speed server interconnect</primary></indexterm>
<indexterm><primary>complex file name space</primary></indexterm>
	もしも、ペアの中で1つのサーバのみアクティブである場合、高速サーバ間通信の必要性は
	無くなる。この場合、新しいものを開発する代わりに、既存の高可用性ソリューションが
	使える。これはかなりのコストがかかる単純なソリューションである。&smbmdash;
	そのコストとは、より複雑なファイル名空間を管理する必要があるということである。
	単一のファイルシステムではないため、管理者はすべてのサービスがどこに配置されて
	いるかを覚えておかなければならない。&smbmdash;複雑さは、扱うのが容易ではない。
	</para>

	<para>
<indexterm><primary>仮想サーバ</primary></indexterm>
	<emphasis>仮想サーバ</emphasis>は、バックエンドサーバに要求をリダイレクトする
	ため、引き続き必要である。バックエンドファイル空間の完全性は管理者の責任である。
	</para>

	</sect2>

	<sect2>
	<title>高可用性サーバ製品</title>

	<para>
<indexterm><primary>resource failover</primary></indexterm>
<indexterm><primary>高可用性サーバ</primary></indexterm>
<indexterm><primary>dedicated heartbeat</primary></indexterm>
<indexterm><primary>LAN</primary></indexterm>
<indexterm><primary>フェイルオーバプロセス</primary></indexterm>
	フェイルオーバサーバはリソースのフェイルオーバを扱うために通信する必要がある。
	これは高可用性サービスでは基本である。専用のハートビートを使うことは、
	フェイルオーバプロセスで、ある種の自立性を導入する、一般的な技術である。
	これは、しばしは専用のリンク(LANまたはシリアル通信)上で行われる。
	</para>

	<para>
<indexterm><primary>SCSI</primary></indexterm>
<indexterm><primary>Red Hatクラスタマネージャ</primary></indexterm>
<indexterm><primary>Microsoft Wolfpack</primary></indexterm>
<indexterm><primary>Fiber Channel</primary></indexterm>
<indexterm><primary>failover communication</primary></indexterm>
	多くのフェイルオーバソリューション(Red HatクラスタマネージャとMicrosoft Wolfpack
	のような)はフェイルオーバ通信のためにファイバチャネルディスクストレージアレイ
	をSCSIで共有して使える。Sambaに対するRed Hat高可用性ソリューションについての
	情報は、
	<ulink url="http://www.redhat.com/docs/manuals/enterprise/RHEL-AS-2.1-Manual/cluster-manager/s1-service-samba.html">www.redhat.com</ulink>
	で得られる。
	</para>

	<para>
<indexterm><primary>Linux高可用性プロジェクト</primary></indexterm>
	Linux高可用性プロジェクトは、高可用性Sambaファイルサーバソリューションを構築
	したいならば、考慮するに値するリソースである。
	<ulink url="http://www.linux-ha.org/">www.linux-ha.org/</ulink>にある
	ホームページを見てほしい。
	</para>

	<para>
<indexterm><primary>バックエンドの障害</primary></indexterm>
<indexterm><primary>サービスの継続性</primary></indexterm>
	フロントエンドサーバの複雑性は、すべてのネットワーククライアントに対して、
	サービスの継続性を同時に提供する間、バックエンドの障害をうまく扱わなければ
	ならないという理由で、高可用性に対する挑戦の余地がある。
	</para>
	
	</sect2>

	<sect2>
	<title>MS-DFS: 貧者のクラスター</title>

	<para>
<indexterm><primary>MS-DFS</primary></indexterm>
<indexterm><primary>DFS</primary><see>MS-DFS, 分散ファイルシステム</see></indexterm>
	MS-DFSリンクは異なったバックエンドサーバにクライアントをリダイレクトするのに
	使われる。これはMicrosoftによってすでに導入された何かで、ネットワーククライアントに
	複雑性を増やしてしまう。MS-DFSは単純な、ファイルレベルでさえ動作する、継続的な
	ファイルシステム名前空間という幻影を作成する。
	</para>

	<para>
	とりわけ、管理の複雑さを犠牲にすると、分散システム(仮のクラスタ)は既存のSambaの
	機能を使うことで作成できる。
	</para>

	</sect2>

	<sect2>
	<title>結論</title>

	<itemizedlist>
		<listitem><para>透過的なSMBクラスタは作るのが難しい!</para></listitem>
		<listitem><para>クライアントフェイルオーバは現在出来る最も良いものである。</para></listitem>
		<listitem><para>実用的で管理が楽な高可用性透過的クラスタソリューションを可能にする前には、
		    たくさんの作業が必要である。</para></listitem>
		<listitem><para>MS-DFSは単一の透過的クラスタという幻想を作るのことができる。</para></listitem>
	</itemizedlist>

	</sect2>

</sect1>
</chapter>
