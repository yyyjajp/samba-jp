<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<chapter id="diagnosis">
<chapterinfo>
	&author.tridge;
	&author.jelmer;
	&author.danshearer;
	<pubdate>Wed Jan 15</pubdate>
</chapterinfo>

<title>Sambaチェックリスト</title>

<sect1>
<title>概要</title>

<para>
<indexterm><primary>検証</primary></indexterm>
この章には、Sambaサーバの検証が行えるテストの一覧が含まれている。また、それらの手順の
どこかで失敗した問題を起こす可能性の高いものが何かと言うことについても説明している。
もしも、すべてのテストをパスしたら、おそらく正しく動いているだろう。
</para>

<para>
すべてのテストを示された順で行うべきである。後のテストが、前のテストで確認された
機能のみを使うように、テストを注意深く選ぶようにしてある。しかし、最初のエラーで
止まってはならない:テストの継続が、問題の解決を手助けするという事例があったからで
ある。
</para>

<para>
もしも、<quote>It does not work,</quote>というタイトルでメールをSambaメーリングリストの
どこかに送り、このテスト手順に従わないならば、メールが無視されても驚いてはいけない。
</para>

</sect1>

<sect1>
<title>前提条件</title>

<para>
すべてのテストにおいて、SambaサーバはBIGSERVERで、PCクライアントがACLIENTで、両者とも
TESTGROUPというワークグループに属していることを仮定する。
</para>

<para>
手続きは、他のクライアントのタイプと同様である。
</para>

<para>
&smb.conf;中の有効な共有名も分かっているものとする。ここでの例における共有の名前は
<smbconfsection name="tmp"/>である。これは、<link linkend="tmpshare">次の例</link>
で示される行を追加することで、このような<smbconfsection name="tmp"/>共有を追加できる。
</para>

<example id="tmpshare">
<title>[tmp]共有のためのsmb.conf</title>
<smbconfblock>
<smbconfsection name="[tmp]"/>
<smbconfoption name="comment">temporary files </smbconfoption>
<smbconfoption name="path">/tmp</smbconfoption>
<smbconfoption name="read only">yes</smbconfoption>
</smbconfblock>
</example>

<note><para>
これらのテストはバージョン3.0.0以降のSambaシステムを仮定する。以前のバージョンでは
いくつかのコマンドは存在しない。
</para></note>

<para>
<indexterm><primary>エラーメッセージ</primary></indexterm>
<indexterm><primary>名前解決</primary></indexterm>
<indexterm><primary>/etc/resolv.conf</primary></indexterm>
受け取ったエラーメッセージに注意をはらってほしい。もしもエラーメッセージが、使用している
サーバが調子が悪いという事を報告しているのであれば、まず初めに使用しているIPを名前解決
する方式が正しく設定されているかどうかをチェックすべきである。実際に存在している
ネームサーバを、<filename>/etc/resolv.conf</filename>が正しく指し示しているようにする
こと。
</para>

<para>
<indexterm><primary>DNSサーバアクセス</primary></indexterm>
<indexterm><primary>名前解決</primary></indexterm>
<indexterm><primary>dnsプロキシ</primary></indexterm>
<indexterm><primary>testparm</primary></indexterm>
また、もしも、名前解決用のDNSサーバアクセスが出来ないならば、&smb.conf;に
<parameter>dns proxy = no</parameter>が設定されているかをチェックする。
これをチェックする最も良い方法は、<command>testparm smb.conf</command>である。
</para>


<para>
<indexterm><primary>ログファイル</primary></indexterm>
<indexterm><primary>tail</primary></indexterm>
<indexterm><primary>/usr/local/samba/var</primary></indexterm>
<indexterm><primary>/var/log/samba</primary></indexterm>
<indexterm><primary>ログファイル</primary><secondary>モニタリング</secondary></indexterm>
別のターミナルコンソール(X中で複数のターミナルを使うには、ctrl-alt-F1からF6を使用)で、
<command>tail -F log_file_name</command>を使うことで、テストの間ログファイルをモニタする
のは便利である。適切なログファイルは(既定値によるインストールでは)、
<filename>/usr/local/samba/var</filename>にある。また、マシンからの接続ログは、ここか、
<filename>/var/log/samba</filename>か、あるいは
&smb.conf;ファイル中でロギングを指定した場合には、それに依存する場所にある。
</para>

<para>
もしも、それらのテスト中に&smb.conf;ファイルを変更したならば、&smbd;と&nmbd;の再起動を
忘れないこと。
</para>

</sect1>

<sect1>
<title>テスト</title>
<procedure>
<title>使用しているSambaサーバの診断</title>


<step performance="required">
<para>
<indexterm><primary>testparm</primary></indexterm>
&smb.conf;ファイルを格納しているディレクトリ中で、<command>testparm smb.conf</command>を
実行する。もしも何らかのエラーが発生した場合、その&smb.conf;の設定には間違いがある。
</para>

<note><para>
<indexterm><primary>/etc/samba</primary></indexterm>
<indexterm><primary>/usr/local/samba/lib</primary></indexterm>
使用している&smb.conf;ファイルは、<filename>/etc/samba</filename>か
<filename>/usr/local/samba/lib</filename>にあってもよい。
</para></note>
</step>

<step performance="required">
<para>
<indexterm><primary>ping</primary></indexterm>
PCから<command>ping BIGSERVER</command>コマンドを動かし、UNIXマシンから
<command>ping ACLIENT</command>を動かす。正常な応答がない場合、TCP/IP層の設定が
うまくいっていない。
</para>

<para>
PC上でpingを動かす場合には、<quote>DOS プロンプト</quote>を起動する必要がある。
</para>

<para>
<indexterm><primary>/etc/hosts</primary></indexterm>
<indexterm><primary>DNS</primary></indexterm>
<indexterm><primary>/etc/resolv.conf</primary></indexterm>
もしも、<quote><errorname>host not found</errorname></quote>か同様なメッセージが
表示されたならば、DNSソフトウェアか<filename>/etc/hosts</filename>ファイルが正しく
設定されていない。もしもDNSを使っている場合、<filename>/etc/resolv.conf</filename>に、
正しい、最新のエントリがあるかどうかをチェックする。DNSエントリなしにSambaをサーバと
クライアントとして動作させることは可能であるが、この後のテストでは、正しいエントリが
あると仮定している。
</para>

<para>
<indexterm><primary>ファイアウォール</primary></indexterm>
<indexterm><primary>iptables</primary></indexterm>
<indexterm><primary>ipchains</primary></indexterm>
pingが失敗するかもしれない他の理由としては、使用しているホスト上でファイアウォール
ソフトウェアが動作している場合である。ワークステーションからの問い合わせに対して
ルールをゆるめる必要がありえ、それはおそらく、他のサブネットからのアクセスを許可する
ことであろう(Linux上では、これは、<command>ipchains</command>か
<command>iptables</command>という、適切なファイアウォール管理コマンドによって行える)。
</para>

<note>
<para>
最新のUNIXディストリビューションでは、既定値でipchains/iptablesをインストールしている。
これは、しばしばよく見落とされる問題である。
</para>
</note>

<para>
<indexterm><primary>iptables</primary></indexterm>
<indexterm><primary>ipchains</primary></indexterm>
もしも、テスト中にシステム中どのようなファイアウォールルールが存在しているかを調べたい
場合、単純に<command>iptables -L -v</command>か、あるいは
<parameter>ipchains</parameter>ベースのファイアウォールを使っている場合には、
<command>ipchains -L -v</command>を入力する。
</para>

<para>
以下は、Sambaが有効になっていない外部向けのイーサネットインタフェース(eth1)とSambaが
有効になっている内部向けの(プライベートネットワーク)インタフェース(eth0)を持つ、
システムからの結果例である。
<screen>
frodo:~ # iptables -L -v
Chain INPUT (policy DROP 98496 packets, 12M bytes)
 pkts bytes target     prot opt in     out     source     destination
 187K  109M ACCEPT     all  --  lo     any     anywhere   anywhere
 892K  125M ACCEPT     all  --  eth0   any     anywhere   anywhere
1399K 1380M ACCEPT     all  --  eth1   any     anywhere   anywhere  \
					state RELATED,ESTABLISHED

Chain FORWARD (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source     destination
 978K 1177M ACCEPT     all  --  eth1   eth0    anywhere   anywhere \
					state RELATED,ESTABLISHED
 658K   40M ACCEPT     all  --  eth0   eth1    anywhere   anywhere
    0     0 LOG        all  --  any    any     anywhere   anywhere \
					LOG level warning

Chain OUTPUT (policy ACCEPT 2875K packets, 1508M bytes)
 pkts bytes target     prot opt in     out     source     destination

Chain reject_func (0 references)
 pkts bytes target     prot opt in     out     source     destination
</screen>
</para>

</step>

<step performance="required">
<para>
UNIXマシン上で<command>smbclient -L BIGSERVER</command>を動かす。
これで有効な共有の一覧が得られる。
</para>

<para>
<indexterm><primary>bad password</primary></indexterm>
<indexterm><primary>hosts allow</primary></indexterm>
<indexterm><primary>hosts deny</primary></indexterm>
<indexterm><primary>valid users</primary></indexterm>
<indexterm><primary>guest account</primary></indexterm>
<indexterm><primary>invalid users</primary></indexterm>
もしも<quote>bad password</quote>という文字列があるエラーメッセージが表示されたら、
不正な<parameter>hosts allow</parameter>、<parameter>hosts deny</parameter>か
<parameter>valid users</parameter>行が&smb.conf;にあるか、ゲストアカウントが無効に
なっている。&testparm;でゲストアカウントが何かを調べ、一時的に
<parameter>hosts allow</parameter>, <parameter>hosts deny</parameter>,
<parameter>valid users</parameter>, か<parameter>invalid users</parameter>行を
削除してみる。
</para>

<para>
<indexterm><primary>inetd.conf</primary></indexterm>
もしも、<literal>connection refused</literal>というメッセージが帰ってきたら、
<command>smbd</command>サーバが動いていないかもしれない。もしも
<filename>inetd.conf</filename>経由で動作するようにしていたら、おそらくこのファイルの
編集が間違っている。もしもdaemonとして動作するようにしていたら、動作しているかを調べ、
<command>netstat -a</command>を使ってnetbios-ssnポートがLISTEN中かを確認する。
</para>

<note><para>
<indexterm><primary>inetd</primary></indexterm>
<indexterm><primary>xinetd</primary><see>inetd</see></indexterm>
ある種のUNIX/Linuxシステムでは、<command>inetd</command>の代わりに
<command>xinetd</command>を使っている。ネットワークスーパーデーモンの、
特定のシステム実装についての、制御ファイルの位置の説明文書を調べること。
</para></note>

<para>
もしも、<literal>session request failed</literal>というメッセージが表示されたならば、
サーバは接続を拒否している。もしも<quote>Your server software is being unfriendly</quote>
というメッセージが表示されたならば、それはおそらく&smbd;に対するコマンドラインオプションを
間違えているか、&smbd;の初期起動時に同様の致命的な問題がある。&testparm;で設定ファイル
(&smb.conf;)の文法と、ログとロックファイルを保持する種々のディレクトリもチェックする。
</para>

<para>
セッション要求を拒否するか、断るかもしれない数多くの理由がある。それらは、
<link linkend="modif1">次の例</link>で示されている&smb.conf;ファイルのエントリ
によって発生する。
</para>


<example id="modif1">
<title>特定のサブネットからのみ接続を受け付ける設定例</title>
<smbconfblock>
<smbconfsection name="[globals]"/>
<smbconfoption name="hosts deny">ALL</smbconfoption>
<smbconfoption name="hosts allow">xxx.xxx.xxx.xxx/yy</smbconfoption>
<smbconfoption name="interfaces">eth0</smbconfoption>
<smbconfoption name="bind interfaces only">Yes</smbconfoption>
</smbconfblock>
</example>

<para>
<indexterm><primary>loopback adapter</primary></indexterm>
<link linkend="modif1">特定のサブネットからのみ接続を受け付ける設定例</link>では、
ループバックアダプタアドレス 127.0.0.1へ自動的に変換される任意のセッション要求は
許可されない。この問題を解決するためには、<link linkend="modif2">以下の例</link>で
示されているような行に変更する。
</para>

<example id="modif2">
<title>特定のサブネットとローカルホストから接続を許可する例</title>
<smbconfblock>
<smbconfsection name="[globals]"/>
<smbconfoption name="hosts deny">ALL</smbconfoption>
<smbconfoption name="hosts allow">xxx.xxx.xxx.xxx/yy 127.</smbconfoption>
<smbconfoption name="interfaces">eth0 lo</smbconfoption>
</smbconfblock>
</example>

<para>
<indexterm><primary>inetd</primary></indexterm>
<indexterm><primary>smbclient</primary></indexterm>
他の、よくある2つのエラーの例は、Samba(すでに<application>inetd</application>経由で
&smbd;が動いている)か、DECのPathworksのような、ポート<constant>139</constant>上で
何かがすでに動いているものである。デーモンで&smbd;を動かす前に
<filename>inetd.conf</filename>ファイルをチェックすること。&smbmdash;そうすれば
多くのトラブルを防げる!
</para>

<para>
<indexterm><primary>サブネットマスク</primary></indexterm>
<indexterm><primary>ブロードキャストアドレス</primary></indexterm>
<indexterm><primary>log.nmbd</primary></indexterm>
<indexterm><primary>ネットワークインタフェース</primary></indexterm>
<indexterm><primary>IPアドレス</primary></indexterm>
さらに、このテストが失敗する、他のあり得そうな例としては、サブネットマスクか
ブロードキャストアドレスの設定が不正な場合である。ネットワークインタフェースの
IPアドレス、ブロードキャスト、サブネットマスクが正しいかと、それらが
<filename>log.nmbd</filename>ファイル中に正しくSambaが記録しているかを確認すること。
</para>

</step>

<step performance="required">

<para>
<indexterm><primary>nmblookup</primary></indexterm>
<command>nmblookup -B BIGSERVER __SAMBA__</command>コマンドを動かす。
使用しているSambaサーバのIPアドレスが表示されるはずである。
</para>

<para>
<indexterm><primary>inetd.conf</primary></indexterm>
<indexterm><primary>nmbd</primary></indexterm>
<indexterm><primary>ポート 137</primary></indexterm>
そうでない場合、&nmbd;が駄々しくインストールされていない。<filename>inetd.conf</filename>
経由で動かしている場合はそこを、あるいはデーモンが動いていてUDPポート137をリッスン
しているかどうかをチェックする。
</para>

<para>
ある1つのよくある問題は、多くのinetdの実装が、コマンドライン上に多数のパラメータを使えない
というものである。もしもこの場合、正しいパラメータを含む1行のみのスクリプトを作成し、
それをinetdから起動する。
</para>

</step>

<step performance="required">

<para>
<indexterm><primary>nmblookup</primary></indexterm>
<command>nmblookup -B ACLIENT `*'</command>を起動する。
</para>

<para>
You should get the PC's IP address back. If you do not, then the client
software on the PC isn't installed correctly, or isn't started, or you
got the name of the PC wrong. 
</para>

<para>
If ACLIENT does not resolve via DNS, then use the IP address of the
client in the above test.
</para>

</step>

<step performance="required">

<para>
Run the command <command>nmblookup -d 2 `*'</command>.
</para>

<para>
This time we are trying the same as the previous test but are trying
it via a broadcast to the default broadcast address. A number of
NetBIOS/TCP/IP hosts on the network should respond, although Samba may
not catch all of the responses in the short time it listens. You
should see the <literal>got a positive name query response</literal>
messages from several hosts.
</para>

<para>
<indexterm><primary>nmblookup</primary></indexterm>
If this does not give a result similar to the previous test, then nmblookup isn't correctly getting your
broadcast address through its automatic mechanism. In this case you should experiment with the <smbconfoption
name="interfaces"/> option in &smb.conf; to manually configure your IP address, broadcast, and netmask.
</para>

<para>
If your PC and server aren't on the same subnet, then you will need to use the
<option>-B</option> option to set the broadcast address to that of the PC's subnet.
</para>

<para>
This test will probably fail if your subnet mask and broadcast address are
not correct. (Refer to test 3 notes above).
</para>

</step>

<step performance="required">


<para>
<indexterm><primary>smbclient</primary></indexterm>
Run the command <command>smbclient //BIGSERVER/TMP</command>. You should 
then be prompted for a password. You should use the password of the account
with which you are logged into the UNIX box. If you want to test with
another account, then add the <option>-U accountname</option> option to the end of
the command line &smbmdash; for example, <command>smbclient //bigserver/tmp -Ujohndoe</command>.
</para>

<note><para>
It is possible to specify the password along with the username as follows:
<command>smbclient //bigserver/tmp -Ujohndoe%secret</command>.
</para></note>

<para>
Once you enter the password, you should get the <prompt>smb></prompt> prompt. If you
do not, then look at the error message. If it says <quote><errorname>invalid network
name,</errorname></quote> then the service <smbconfsection name="tmp"/> is not correctly set up in your &smb.conf;.
</para>

<para>
If it says <quote><errorname>bad password,</errorname></quote> then the likely causes are:
</para>

<orderedlist>
<listitem>
	<para>
	You have shadow passwords (or some other password system) but didn't
	compile in support for them in &smbd;.
	</para>
</listitem>

<listitem>
	<para>
	Your <smbconfoption name="valid users"/> configuration is incorrect.
	</para>
</listitem>

<listitem>
	<para>
	You have a mixed-case password and you haven't enabled the <smbconfoption name="password level"/> option at a high enough level.
	</para>
</listitem>

<listitem>
	<para>
	The <smbconfoption name="path"/> line in &smb.conf; is incorrect. Check it with &testparm;.
	</para>
</listitem>

<listitem>
	<para>
	You enabled password encryption but didn't map UNIX to Samba users. Run
	<command>smbpasswd -a username</command>
	</para>
</listitem>
</orderedlist>

<para>
<indexterm><primary>dir</primary></indexterm>
<indexterm><primary>get</primary></indexterm>
<indexterm><primary>put</primary></indexterm>
<indexterm><primary>help command</primary></indexterm>
Once connected, you should be able to use the commands <command>dir</command>, <command>get</command>,
<command>put</command>, and so on. Type <command>help command</command> for instructions. You should
especially check that the amount of free disk space shown is correct when you type <command>dir</command>.
</para>

</step>

<step performance="required">

<para>
<indexterm><primary>net view</primary></indexterm>
On the PC, type the command <command>net view \\BIGSERVER</command>. You will 
need to do this from within a DOS prompt window. You should get back a 
list of shares available on the server.
</para>

<para>
<indexterm><primary>nmbd</primary></indexterm>
If you get a message <literal>network name not found</literal> or similar error, then NetBIOS
name resolution is not working. This is usually caused by a problem in <command>nmbd</command>.
To overcome it, you could do one of the following (you only need to choose one of them):
</para>

<orderedlist>
<listitem><para>
	Fix the &nmbd; installation.
</para></listitem>

<listitem><para>
	Add the IP address of BIGSERVER to the <command>wins server</command> box in the
	advanced TCP/IP setup on the PC.
</para></listitem>

<listitem><para>
	Enable Windows name resolution via DNS in the advanced section of the TCP/IP setup.
</para></listitem>

<listitem><para>
	Add BIGSERVER to your lmhosts file on the PC.
</para></listitem>
</orderedlist>

<para>
If you get a message <quote><errorname>invalid network name</errorname></quote> or 
<quote><errorname>bad password error,</errorname></quote> then apply the
same fixes as for the <command>smbclient -L</command> test. In
particular, make sure your <command>hosts allow</command> line is correct (see the man pages).
</para>

<para>
Also, do not overlook that fact that when the workstation requests the
connection to the Samba server, it will attempt to connect using the 
name with which you logged onto your Windows machine. You need to make
sure that an account exists on your Samba server with that exact same
name and password.
</para>

<para>
If you get a message <quote><errorname>specified computer is not receiving requests</errorname></quote> or similar error,
it probably means that the host is not contactable via TCP services.
Check to see if the host is running TCP wrappers, and if so, add an entry in
the <filename>hosts.allow</filename> file for your client (or subnet, and so on.)
</para>

</step>

<step performance="required">

<para>
Run the command <command>net use x: \\BIGSERVER\TMP</command>. You should 
be prompted for a password, then you should get a <computeroutput>command completed 
successfully</computeroutput> message. If not, then your PC software is incorrectly 
installed or your &smb.conf; is incorrect. Make sure your <parameter>hosts allow</parameter>
and other config lines in &smb.conf; are correct.
</para>

<para>
It's also possible that the server can't work out what username to connect you as.
To see if this is the problem, add the line
<smbconfoption name="user">username</smbconfoption> to the
<smbconfsection name="[tmp]"/> section of 
&smb.conf; where <parameter>username</parameter> is the
username corresponding to the password you typed. If you find this
fixes things, you may need the username mapping option. 
</para>

<para>
It might also be the case that your client only sends encrypted passwords 
and you have <smbconfoption name="encrypt passwords">no</smbconfoption> in &smb.conf;.
Change this setting to `yes' to fix this.
</para>

</step>

<step performance="required">

<para>
Run the command <command>nmblookup -M <parameter>testgroup</parameter></command> where 
<parameter>testgroup</parameter> is the name of the workgroup that your Samba server and 
Windows PCs belong to. You should get back the IP address of the 
master browser for that workgroup.
</para>

<para>
If you do not, then the election process has failed. Wait a minute to
see if it is just being slow, then try again. If it still fails after
that, then look at the browsing options you have set in &smb.conf;. Make
sure you have <smbconfoption name="preferred master">yes</smbconfoption> to ensure that 
an election is held at startup.
</para>

</step>

<step performance="required">

<para>
From file manager, try to browse the server. Your Samba server should
appear in the browse list of your local workgroup (or the one you
specified in &smb.conf;). You should be able to double-click on the name
of the server and get a list of shares. If you get the error message <quote>invalid password,</quote>
 you are probably running Windows NT and it
is refusing to browse a server that has no encrypted password
capability and is in user-level security mode. In this case, either set
<smbconfoption name="security">server</smbconfoption> and 
<smbconfoption name="password server">Windows_NT_Machine</smbconfoption> in your
&smb.conf; file or make sure <smbconfoption name="encrypt passwords"/> is
set to <quote>yes</quote>.
</para>

</step>
</procedure>
</sect1>

</chapter>
