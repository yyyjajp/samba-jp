<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<chapter id="InterdomainTrusts">
<chapterinfo>
	&author.jht;
	&author.mimir;
	<author>&person.jelmer;<contrib>drawing</contrib></author>
        <author>
                <firstname>Stephen</firstname><surname>Langasek</surname>
                <affiliation>
                        <address><email>vorlon@netexpress.net</email></address>
                </affiliation>
        </author>
	<pubdate>April 3, 2003</pubdate>
</chapterinfo>

<title>ドメイン間の信頼関係</title>


<para>
<indexterm><primary>ドメイン間の信頼</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>trusts</primary></indexterm>
<indexterm><primary>sambaからsambaへの信頼</primary></indexterm>
<indexterm><primary>Active Directory</primary></indexterm>
<indexterm><primary>NT4形式のドメイン</primary></indexterm>
<indexterm><primary>trust relationships</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>LDAPベース</primary></indexterm>
Samba-3はNT4形式のドメイン信頼関係をサポートする。NT4形式のドメインからSamba-3に移行
したいが、Active Directory やLDAPベースの認証バックエンドを採用したくないという多くの
サイトが使用したいと思う機能である。この章では、信頼関係に関する背景情報と信頼関係の
作成方法を説明する。Samba-3はNT4を信頼することができ(その逆も可)、またSamba対Sambaの
信頼を作成することも可能である。
</para>

<para>
<indexterm><primary>winbind</primary></indexterm>
<indexterm><primary>UIDレンジ</primary></indexterm>
<indexterm><primary>GIDレンジ</primary></indexterm>
<indexterm><primary>daemon</primary></indexterm>
<indexterm><primary>winbindd</primary></indexterm>
ドメイン間の信頼関係を使う場合、<command>winbind</command>を使うことが必要であるので、
<command>winbindd</command>が動いていなければならない。このモードにおけるwinbindの
動作は、&smb.conf;ファイル中の有効なUIDレンジと有効なGIDレンジの指定に依存する。
これらは以下のように指定する:
<smbconfblock>
<smbconfoption name="idmap uid">10000-20000</smbconfoption>
<smbconfoption name="idmap gid">10000-20000</smbconfoption>
</smbconfblock>
<indexterm><primary>passdbバックエンド</primary></indexterm>
<indexterm><primary>POSIXユーザアカウント</primary></indexterm>
<indexterm><primary>最大値</primary></indexterm>
<indexterm><primary>4294967295</primary></indexterm>
指定されたレンジの値はホストOSで使っている値とPOSIXユーザアカウント用のpassdbバック
エンドで使っている値を上書きしてはならない。最大値はホストOSによって許可されている
上限の値で制限される。これはUNIXカーネルで制限されるパラメータである。Linux kernel
2.6ベースのシステムは最大値として4294967295(符号なし32ビット値)である。
</para>

<note><para>
<indexterm><primary>winbind</primary></indexterm>
<indexterm><primary>信頼しているドメイン</primary></indexterm>
<indexterm><primary>信頼されたドメイン</primary></indexterm>
winbindを使用するのはSambaが信頼しているドメインの時のみであり、信頼されたドメインの時
には不要である。
</para></note>

<sect1>
<title>機能と利便性</title>

<para>
<indexterm><primary>拡張性</primary></indexterm>
<indexterm><primary>信頼関係</primary></indexterm>
Samba-3はSambaとMicrosoft Windows NT4形式と同じようにSamba間の信頼関係に参加できる。
これは、Microsoft Windows NT4と同様な拡張性をSambaに付与する。
</para>

<para>
<indexterm><primary>拡張性のあるバックエンド</primary></indexterm>
<indexterm><primary>認証データベース</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>ドメイン間の信頼</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
Samaba-3はLDAPのような拡張性のあるバックエンド認証データベースと共に動作でき、プライマリ
及びバックアップドメイン管理モードで動作できるので、管理者はドメイン間の信頼関係を使用
する代わりの選択肢を考慮するべきである。なぜならば、この機能はその動作原理からして、
本質的に脆弱なものだからである。このことこそが、Microsoft Active Directory が開発され
採用される主な理由でもある。
</para>

</sect1>

<sect1>
<title>信頼関係に関する背景情報</title>

<para>
<indexterm><primary>セキュリティドメイン</primary></indexterm>
<indexterm><primary>階層がない</primary></indexterm>
<indexterm><primary>security structure</primary></indexterm>
<indexterm><primary>大きな組織</primary></indexterm>
<indexterm><primary>delegation</primary></indexterm>
<indexterm><primary>administrative responsibilities</primary></indexterm>
MS Windows NT3/4形式のセキュリティドメインは、階層がないセキュリティ構造を採用している。
この構造の制約が、大規模な組織では Microsoft Windows ネットワークの拡張性に影響を与える
ことはよく知られている。さらに、この設計の結果であるフラットな名前空間は、大規模で
多様性に富む組織における管理責務の代行に多大な影響を及ぼす。
</para>

<para>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>Kerberos</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>limitations</primary></indexterm>
<indexterm><primary>domain security</primary></indexterm>
Microsoft は、古いテクノロジーの制約を回避するために、Active Directory Service(ADS)を、
Kerberos及びLDAPをベースとして開発した。しかし全ての組織が ADSを採用する準備ができ、
その意思があるわけではない。小規模の組織にとっては古い NT形式のドメインセキュリティで
充分である。また、ADS を採用するために面倒な変更作業を行うことを望まない保守的な
ユーザも残っている。
</para>

<para>
<indexterm><primary>セキュリティドメイン</primary></indexterm>
<indexterm><primary>アクセスの権利</primary></indexterm>
<indexterm><primary>権限</primary></indexterm>
<indexterm><primary>信頼</primary></indexterm>
<indexterm><primary>信頼されたドメイン</primary></indexterm>
<indexterm><primary>信頼しているドメイン</primary></indexterm>
<indexterm><primary>片方向</primary></indexterm>
Microsoft Windows NTで、Microsoft はあるドメインのユーザが、別のドメインのアクセス権や
他の権限を付与されるような機構を実現するため、多様なセキュリティドメインの存在を可能に
する機能を導入した。この機能を<emphasis>信頼(Trusts)</emphasis>という言葉で言い表わす。
具体的には、あるドメインが別のドメインのユーザを<emphasis>信頼する</emphasis>という
ことである。あるドメインのユーザが別のセキュリティドメインのユーザになれる時、
そのようなドメインを信頼される(trusted)ドメインと言う。そのようなユーザに権利や権限を
与えた方のドメインは信頼する(trusting) ドメインと言う。NT3.x/4.0 では信頼関係は一方向
のみである。そのため双方のドメインのユーザが他方のドメインで権限と権利を持とうとする
場合には、それぞれの方向に一つずつ、二つの信頼関係を設定する必要がある。
</para>

<para>
<indexterm><primary>セキュリティドメイン</primary></indexterm>
<indexterm><primary>nontransitive</primary></indexterm>
<indexterm><primary>信頼関係</primary></indexterm>
<indexterm><primary>transitive</primary></indexterm>
<indexterm><primary>explicit trust</primary></indexterm>
NT4形式のMicrosoft セキュリティドメインでは、全ての信頼は非推移的である。この意味は、
例えば三つのドメインがあり(仮に赤、白、青とする)、その赤と白が信頼関係を持ち、また
白と青が信頼関係を持つとする。この場合、赤と青のドメインの間に暗黙に了解された
信頼関係を持つわけではない。関係は明示的でなければならず、推移的ではない。
</para>

<para>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>セキュリティコンテキスト</primary></indexterm>
<indexterm><primary>信頼関係</primary></indexterm>
<indexterm><primary>双方向の信頼</primary></indexterm>
<indexterm><primary>Windows 2000</primary></indexterm>
<indexterm><primary>セキュリティドメイン</primary></indexterm>
<indexterm><primary>NT4形式のドメイン</primary></indexterm>
Microsoft Windows 2000から登場した新たなADSセキュリティの方式では、信頼関係は既定値で
双方向になっている。また、全てのADSドメイン間の信頼は推移的である。上の赤、白、青
ドメインの例では、Windows 2000及びADSを使用する場合、赤と青ドメインは互いに信頼できる。
これはADSドメインの本質的な特長である。Samba-3 はMicrosoft Windows NT4方式のドメイン間
信頼機能を実装し、Microsoft Windows NT4方式のドメインと類似した方法で、
Microsoft Windows 200x ADS セキュリティドメインとの相互運用を実現している。
</para>

</sect1>

<sect1>
<title>ネイティブなMicrosoft Windows NT4の信頼関係の設定</title>

<para>
<indexterm><primary>Interdomain Trusts</primary><secondary>creating</secondary></indexterm>
<indexterm><primary>双方向の信頼</primary></indexterm>
<indexterm><primary>security credentials</primary></indexterm>
ドメイン間信頼関係を作成するには二つのステップがある。双方向の信頼関係を有効にする
ためには、双方のドメイン管理者が相手のドメインのために信頼アカウントを作成し、
セキュリティに関する信用情報を確認する際に使用できるようにしなければならない。
</para>


<sect2>
<title>NT4ドメイン信頼関係の作成</title>

<para>
<indexterm><primary>ドメインの信頼</primary></indexterm>
<indexterm><primary>信頼関係</primary></indexterm>
<indexterm><primary>ドメインユーザマネージャ</primary></indexterm>
<indexterm><primary>リモートドメイン</primary></indexterm>
<indexterm><primary>standard confirmation</primary></indexterm>
Microsoft Windows NT4では、全てのドメインの信頼関係は
<application>ドメインユーザーマネジャ</application>を使って設定する。これは、
メニューバーのドメインユーザーマネジャーポリシーのエントリから行う。
<guimenu>ポリシー</guimenu>メニューから<guimenuitem>信頼関係</guimenuitem>を選択する。
<guimenuitem>信頼する側のドメイン</guimenuitem>と記された低い方のボックスの隣に二つの
ボタンがある。 <guibutton>追加</guibutton>と<guibutton>削除</guibutton>である。
<guibutton>追加</guibutton>ボタンは、自ドメイン内のユーザにアクセス権限を付与することが
できるリモートドメイン名を入力するパネルを開く。また、信頼するドメインが信頼される
ドメインのユーザを認証するときに使用する、信頼関係のパスワードも入力する必要がある。
パスワードは(標準的な確認の手続きとして)二度入力しなければならない。
</para>

</sect2>


<sect2>
<title>NT4ドメイン信頼関係の構築完了</title>

<para>
<indexterm><primary>信頼関係</primary></indexterm>
<indexterm><primary>信頼しているドメイン</primary></indexterm>
<indexterm><primary>信頼されたドメイン</primary></indexterm>
<indexterm><primary>リモートドメイン</primary></indexterm>
<indexterm><primary>パスワードが割り当てられた</primary></indexterm>
<indexterm><primary>Interdomain Trusts</primary><secondary>Completing</secondary></indexterm>
信頼関係は、もう一方のドメイン(信頼するドメイン)が信頼されるドメインと適切に接続された
場合のみ動作する。信頼関係を完成するためには、管理者はまず、ドメインユーザーマネジャを
起動し、メニューから<guilabel>ポリシー</guilabel>を選択し、
それから<guilabel>信頼関係</guilabel>を選択し、<guilabel>信頼される側のドメイン</guilabel>
と記されたボックスの横の<guibutton>追加</guibutton>ボタンをクリックする。パネルが
開いたらリモートドメイン名とパスワードを入力する。
</para>

</sect2>

<sect2>
<title>ドメイン間信頼関係の機能</title>


<para>
<indexterm><primary>双方向の信頼</primary></indexterm>
<indexterm><primary>信頼関係</primary></indexterm>
<indexterm><primary>信頼が確立</primary></indexterm>
<indexterm><primary>片方向の信頼</primary></indexterm>
<indexterm><primary>Windows NT4ドメイン</primary></indexterm>
<indexterm><primary>ドメイン間信頼関係</primary><secondary>機能</secondary></indexterm>
双方向の信頼関係は、二つの方方向の信頼がそれぞれ互いの方向に作成されることで築かれる。
二つのMicrosoft Windows NT4ドメイン間で片方向の信頼が確立されている場合(仮にDomAとDomB
とする)、次の機能が可能になる:
</para>

<figure id="trusts1">
	<title>信頼の概要</title>
	<imagefile>trusts1</imagefile>
</figure>

<itemizedlist>
	<listitem><para>
	DomA(DomB への信頼接続を完了する)はDomBを<parameter>信頼する</parameter>。
	</para></listitem>

	<listitem><para>
	DomAが<parameter>信頼する</parameter>ドメインである。
	</para></listitem>

	<listitem><para>
	DomBが<parameter>信頼される</parameter>ドメインである(信頼アカウントの起点)。
	</para></listitem>

	<listitem><para>
	DomB のユーザーは DomA のリソースにアクセスすることができる。
	</para></listitem>

	<listitem><para>
	DomA のユーザーは DomB のリソースにアクセスすることはできない。
	</para></listitem>

	<listitem><para>
	DomB のグローバル・グループは DomA で使用できる。
	</para></listitem>

	<listitem><para>
	DomA のグローバル・グループは DomB では使用できない。
	</para></listitem>

	<listitem><para>
	DomB は DomA のクライアントワークステーションのログオンダイアログボックスに表示される。
	</para></listitem>

	<listitem><para>
	DomA は DomB のクライアントワークステーションのログオンダイアログボックスに表示されない。
	</para></listitem>
</itemizedlist>

<itemizedlist>
	<listitem><para>
	信頼するドメインのユーザー/グループは信頼されるドメインへの権限、許可、
	アクセスは与えられない。
	</para></listitem>

	<listitem><para>
	信頼するドメインは信頼されるドメインにアクセスしたり(ユーザ/グローバルグループの)
	アカウントを使用することができる。
	</para></listitem>

	<listitem><para>
	信頼されるドメインの管理者は信頼するドメイン内で管理権限を付与される。
	</para></listitem>

	<listitem><para>
	信頼されるドメインのユーザは信頼するドメインで権利や特権を付与される。
	</para></listitem>

	<listitem><para>
	信頼されるドメインのグローバルグループは信頼するドメインで権利や許可を
	与えられる。
	</para></listitem>

	<listitem><para>
	信頼されるドメインのグローバルグループはMicrosoft Windowsドメインメンバ
	マシンのローカルグループのメンバーになることができる。
	</para></listitem>
</itemizedlist>

</sect2>

</sect1>

<sect1>
<title>SambaにおけるNT形式のドメイン信頼関係の設定</title>

<para>
<indexterm><primary>ドメイン間の信頼関係</primary></indexterm>
ここでは、Samba サーバがドメイン間の信頼関係に参加できるようにするための設定方法を、
簡潔に紹介する。Samba における信頼関係のサポートは初期段階なので、正しく機能しない
ことがあっても驚かないこと。
</para>

<para>
<indexterm><primary>peer domain</primary></indexterm>
<indexterm><primary>信頼関係</primary></indexterm>
<indexterm><primary>Windows NT4サーバ</primary></indexterm>
<indexterm><primary>ドメイン間</primary></indexterm>
下記における手順の説明では、信頼関係の相手先のドメインは、Windows NT4 サーバで管理
されていると仮定する。しかし、リモート側は Samba-3 ドメインであっても構わない。
この文書を読み終わるころには明らかになることであるが、以下に書かれている説明のうち、
Samba固有の部分のみを合わせると、純粋なSamba環境におけるドメイン信頼の構築の説明と
なる、ということである。
</para>

<sect2 id="samba-trusted-domain">
<title>信頼されるドメインとしてのSamba</title>

<para>
<indexterm><primary>trusted party</primary></indexterm>
<indexterm><primary>特別なアカウント</primary></indexterm>
<indexterm><primary>trusting party</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>smbpasswd</primary></indexterm>
Samba PDC を、信頼関係のある二者のうち信頼される側に設定するためには、まず信頼する側の
ドメインのための特別なアカウントを作成する必要がある。そのためには
<command>smbpasswd</command>ユーティリティを使う。信頼されるドメインアカウントを
作成するのは、信頼されるマシンアカウントを作成するのに似ている。仮にドメイン名をSAMBA
とし、リモートドメインをRUMBAとする。最初のステップは好みのシェルからこのコマンドを
発行することである:
</para>

<para>
<screen>
&rootprompt; <userinput>smbpasswd -a -i rumba</userinput>
New SMB password: <userinput>XXXXXXXX</userinput>
Retype SMB password: <userinput>XXXXXXXX</userinput>
Added user rumba$
</screen>

ここで、<option>-a</option>はパスワードデータベースの中に新規のアカウントを追加するこ
とを意味し、<option>-i</option>は、
<quote>このアカウントをドメイン間の信頼フラグ付きで作成せよ</quote>ということを意味する。
where <option>-a</option> means to add a new account into the
passdb database and <option>-i</option> means to <quote>create this
account with the Interdomain trust flag</quote>.
</para>

<para>
<indexterm><primary>account name</primary></indexterm>
<indexterm><primary>remote domain</primary></indexterm>
<indexterm><primary>password database</primary></indexterm>
<indexterm><primary>/etc/passwd</primary></indexterm>
The account name will be <quote>rumba$</quote> (the name of the remote domain).
If this fails, you should check that the trust account has been added to the system
password database (<filename>/etc/passwd</filename>). If it has not been added, you
can add it manually and then repeat the previous step.
</para>

<para>
<indexterm><primary>password</primary></indexterm>
<indexterm><primary>new account</primary></indexterm>
<indexterm><primary>confirm the trust</primary></indexterm>
<indexterm><primary>Windows NT Server</primary></indexterm>
After issuing this command, you will be asked to enter the password for the account. You can use any password
you want, but be aware that Windows NT will not change this password until 7 days following account creation.
After the command returns successfully, you can look at the entry for the new account (in the standard way as
appropriate for your configuration) and see that the account's name is really RUMBA$ and it has the
<quote>I</quote> flag set in the flags field. Now you are ready to confirm the trust by establishing it from
Windows NT Server.
</para>


<para>
<indexterm><primary>User Manager</primary></indexterm>
<indexterm><primary>trusted domain name</primary></indexterm>
<indexterm><primary>relationship password</primary></indexterm>
<indexterm><primary>remote domain</primary></indexterm>
<indexterm><primary>established</primary></indexterm>
Open <application>User Manager for Domains</application> and from the <guimenu>Policies</guimenu> menu, select
<guimenuitem>Trust Relationships...</guimenuitem>.  Beside the <guilabel>Trusted domains</guilabel> list box,
click the <guimenu>Add...</guimenu> button. You will be prompted for the trusted domain name and the
relationship password. Type in SAMBA, as this is the name of the remote domain and the password used at the
time of account creation.  Click on <guibutton>OK</guibutton> and, if everything went without incident, you
will see the <computeroutput>Trusted domain relationship successfully established</computeroutput> message.
</para>

</sect2>
<sect2>
<title>Samba as the Trusting Domain</title>

<para>
<indexterm><primary>NT-controlled domain</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
This time activities are somewhat reversed. Again, we'll assume that your domain
controlled by the Samba PDC is called SAMBA and the NT-controlled domain is called RUMBA.
</para>

<para>
The very first step is to add an account for the SAMBA domain on RUMBA's PDC.
</para>


<para>
<indexterm><primary>User Manager</primary></indexterm>
<indexterm><primary>trusted domain</primary></indexterm>
<indexterm><primary>password</primary></indexterm>
Launch the <application>Domain User Manager</application>, then from the menu select
<guimenu>Policies</guimenu>, <guimenuitem>Trust Relationships</guimenuitem>.
Now, next to the <guilabel>Trusting Domains</guilabel> box, press the <guibutton>Add</guibutton>
button and type in the name of the trusted domain (SAMBA) and the password to use in securing
the relationship.
</para>

<para>
<indexterm><primary>password</primary></indexterm>
<indexterm><primary>confirm the password</primary></indexterm>
The password can be arbitrarily chosen. It is easy to change the password from the Samba server whenever you
want. After you confirm the password, your account is ready for use. Now its Samba's turn.
</para>

<para>
Using your favorite shell while logged in as root, issue this command:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>trustdom establish</tertiary></indexterm>
</para>

<para>
&rootprompt;<userinput>net rpc trustdom establish rumba</userinput>
</para>

<para>
<indexterm><primary>password</primary></indexterm>
<indexterm><primary>interdomain connection</primary></indexterm>
<indexterm><primary>ordinary connection</primary></indexterm>
You will be prompted for the password you just typed on your Windows NT4 Server box.
An error message, <literal>"NT_STATUS_NOLOGON_INTERDOMAIN_TRUST_ACCOUNT,"</literal>
that may be reported periodically is of no concern and may safely be ignored.
It means the password you gave is correct and the NT4 server says the account is ready for
interdomain connection and not for ordinary connection.  After that, be patient;
it can take a while (especially in large networks), but eventually you should see
the <literal>Success</literal> message. Congratulations! Your trust
relationship has just been established.
</para>

<note><para>
You have to run this command as root because you must have write access to
the <filename>secrets.tdb</filename> file.
</para></note>

</sect2>
</sect1>

<sect1>
<title>NT4-Style Domain Trusts with Windows 2000</title>

<para>
<indexterm><primary>trust relationship</primary></indexterm>
<indexterm><primary>Windows 2000 server</primary></indexterm>
<indexterm><primary>NT4-style</primary></indexterm>
<indexterm><primary>mixed mode</primary></indexterm>
Although <application>Domain User Manager</application> is not present in Windows 2000, it is 
also possible to establish an NT4-style trust relationship with a Windows 2000 domain 
controller running in mixed mode as the trusting server. It should also be possible for 
Samba to trust a Windows 2000 server; however, more testing is still needed in this area.
</para>

<para>
<indexterm><primary>interdomain trust</primary></indexterm>
<indexterm><primary>trust account</primary></indexterm>
<indexterm><primary>not transitive</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
After <link linkend="samba-trusted-domain">creating the interdomain trust account on the Samba server</link>
as described previously, open <application>Active Directory Domains and Trusts</application> on the AD
controller of the domain whose resources you wish Samba users to have access to. Remember that since NT4-style
trusts are not transitive, if you want your users to have access to multiple mixed-mode domains in your AD
forest, you will need to repeat this process for each of those domains. With <application>Active Directory
domains and trusts</application> open, right-click on the name of the Active Directory domain that will trust
our Samba domain and choose <guimenuitem>Properties</guimenuitem>, then click on the
<guilabel>Trusts</guilabel> tab. In the upper part of the panel, you will see a list box labeled
<guilabel>Domains trusted by this domain:</guilabel> and an <guilabel>Add...</guilabel> button next to it.
Press this button and, just as with NT4, you will be prompted for the trusted domain name and the relationship
password. Press <emphasis>OK</emphasis> and after a moment, Active Directory will respond with
<computeroutput>The trusted domain has been added and the trust has been verified.</computeroutput> Your
Samba users can now be granted access to resources in the AD domain.
</para>
</sect1>

<sect1>
<title>Common Errors</title>

<para>
Interdomain trust relationships should not be attempted on networks that are unstable
or that suffer regular outages. Network stability and integrity are key concerns with
distributed trusted domains.
</para>

<sect2>
<title>Browsing of Trusted Domain Fails</title>

<para>
<emphasis>Browsing from a machine in a trusted Windows 200x domain to a Windows 200x member of
a trusting Samba domain, I get the following error:</emphasis>
<screen>
The system detected a possible attempt to compromise security. Please
ensure that you can contact the server that authenticated you.
</screen>
</para>

<para>
<emphasis>The event logs on the box I'm trying to connect to have entries regarding group
policy not being applied because it is a member of a down-level domain.</emphasis>
</para>

<para>If there is a computer account in the Windows
200x domain for the machine in question, and it is disabled, this problem can
occur.  If there is no computer account (removed or never existed), or if that 
account is still intact (i.e., you just joined it to another domain), everything 
seems to be fine. By default, when you unjoin a domain (the Windows 200x 
domain), the computer tries to automatically disable the computer account in 
the domain.  If you are running as an account that has privileges to do this 
when you unjoin the machine, it is done; otherwise it is not done.
</para>

</sect2>

<sect2>
<title>Problems with LDAP ldapsam and Older Versions of smbldap-tools</title>

<para>
If you use the <command>smbldap-useradd</command> script to create a trust
account to set up interdomain trusts, the process of setting up the trust will
fail. The account that was created in the LDAP database will have an account
flags field that has <literal>[W          ]</literal>, when it must have
<literal>[I          ]</literal> for interdomain trusts to work.
</para>

<para>Here is a simple solution.
Create a machine account as follows:
<screen>
&rootprompt; smbldap-useradd -w domain_name
</screen>
Then set the desired trust account password as shown here:
<screen>
&rootprompt; smbldap-passwd domain_name\$
</screen>
Using a text editor, create the following file:
<screen>
dn: uid=domain_name$,ou=People,dc={your-domain},dc={your-top-level-domain}
changetype: modify
sambaAcctFlags: [I         ]
</screen>
Then apply the text file to the LDAP database as follows:
<screen>
&rootprompt; ldapmodify -x -h localhost \
 -D "cn=Manager,dc={your-domain},dc={your-top-level-domain}" \
 -W -f /path-to/foobar
</screen>
Create a single-sided trust under the NT4 Domain User Manager, then execute:
<screen>
&rootprompt; net rpc trustdom establish domain_name
</screen>
</para>

<para>
It works with Samba-3  and NT4 domains, and also with Samba-3 and Windows 200x ADS in mixed mode.
Both domain controllers, Samba and NT must have the same WINS server; otherwise,
the trust will never work. 
</para>

</sect2>

</sect1>

</chapter>
