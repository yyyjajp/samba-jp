<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<chapter id="upgrading-to-3.0">
<chapterinfo>
	&author.jelmer;
	&author.jht;
	&author.jerry;
	<pubdate>August 16, 2007</pubdate>
</chapterinfo>

<title>Sambaのアップデートとアップグレード</title>
<para>
この章では、3.xシリーズのリリースの間に行われた変更の詳細な記録を提供する。この時点で、
このシリーズはGNU GPLバージョン2でライセンスされる3.0.xとGNU GPLバージョン3でライセンス
される Samba 3.2.xシリーズがある。
</para>

<sect1>
<title>アップデート要求の要点</title>
<para>
Sambaは常時発展しているソフトウェアで、リリース間で明確な違いがある時もある。それらの
変更点のいくつかは、公式のMicrosoftパッチとアップデートによるセキュリティか機能の更新の
結果、Microsoft Windows ネットワーククライアントによって使われるプロトコルの変更の結果に
よってもたらされる。特に、Sambaそれ自身の内部操作に影響するものについては、Sambaは
そのような変更に追従しなければならない。
</para>

<para>
使用しているSambaのバージョンに、明確に言及している、以下のどのような節をも参照して
ほしい。一般的に、新しいリリースに適用されるすべての変更は、それ以降のリリースにも
適用される。例えば、Samba3.0.23における変更は、3.0.25を含むそのあとすべての新しい
リリースに適用される。Samba 3.2.xは3.2.0固有の変更が適用される前に、Samba 3.0.25から
オリジナルが分割された。3.0.xシリーズの機能が特に無効にされていないのならば、
3.2.xシリーズの動作は、それ以前のパターンに沿うと推測できる。
</para>

<sect2>
<title>Samba-3.0.xからSamba-3.2.0へのアップグレード</title>
<para>
</para>
</sect2>

<sect2 id="oldupdatenotes">
<title>Samba-2.xからSamba-3.0.25へのアップグレード</title>
<para>
<indexterm><primary>Sambaの違い</primary></indexterm>
<indexterm><primary>変更されたパラメータ</primary></indexterm>
<indexterm><primary>簡単なガイド</primary></indexterm>
この章では、主に、Samba-3.0.25とSamba-2.2.8a間での違いについて取り扱う。
それは、設定パラメータが変更された点と、2.2.xから3.0.25への簡単なガイドを
提供する。
</para>
</sect2>

<sect2>
<title>お手軽移行ガイド</title>

<para>
Samba-3.0.25の既定値の動作は、おおよそSamba-2.2.xと同じであるべきである。&smb.conf;
ファイル中に新しいパラメータ<smbconfoption name="passdb backend"/>が定義されていない
場合の既定値の動作は、<smbconfoption name="encrypt passwords">Yes</smbconfoption>と
<filename>smbpasswd</filename>データベースを使う、Samba-2.2.xの既定値の動作と同じに
なる。
</para>

<para>
<indexterm><primary>動作がほぼ同じ</primary></indexterm>
<indexterm><primary>異なるプロトコル</primary></indexterm>
なぜ、<emphasis>動作がおおよそSamba-2.2.xと同じであるべきである</emphasis>と言うのか?
なぜならば、Samba-3.0.25は、結果として異なったプロトコルコードパスを取るかもしれない
ネイティブなユニコードをサポートするような、新しいプロトコルを使うことが出来るからである。
そのような環境における新しい動作は、古いものとは正確に同じではない。うれしいことに、
ドメインとマシンSIDはアップグレードにおいて保存される。
</para>

<para>
<indexterm><primary>LDAPバックエンド</primary></indexterm>
<indexterm><primary>データベース</primary></indexterm>
<indexterm><primary>pdbedit</primary></indexterm>
<indexterm><primary>Samba-3互換のLDAPバックエンド</primary></indexterm>
もしも、Samba-2.2.xがLDAPを使っていて、LDAPデータベースを更新する時間がないならば、
&smb.conf;ファイル中で<smbconfoption name="passdb backend">ldapsam_compat</smbconfoption>
を指定する。その他の点に関しては、動作は多かれ少なかれ同じであるべきである。
その後、Samba-3互換のLDAPバックエンドに切り替える時間があるとき、<command>pdbedit</command>
を使って古いLDAPデータベースを新しいものに移行することは可能である。
<link linkend="pdbeditthing">The <emphasis>pdbedit</emphasis>コマンドを参照のこと。
</para>

</sect2>
</sect1>

<sect1>
<title>Samba-3.xシリーズにおける新しい機能</title>
<para>
</para>

<sect2>
<title>Samba-3.2.xシリーズにおける新しい機能</title>
<para>
</para>
</sect2>

<sect2>
<title>Samba-3.0.xにおける新しい機能</title>

<para>
新機能のうち代表的なものは以下の通り:
</para>

<orderedlist numeration="arabic">
	<listitem><para>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>LDAP/Kerberos</primary></indexterm>
	Active Directoryのサポート。このリリースはメンバサーバとしてADS realmに参加でき、
	LDAP/Kerberosを使ってユーザの認証が出来る。
	</para></listitem>

	<listitem><para>
<indexterm><primary>ユニコード</primary></indexterm>
<indexterm><primary>マルチバイト文字セット</primary></indexterm>
	ユニコードのサポート。Sambaはネットワーク上でUnicodeを使えるようになり、
	マルチバイトとユニコード文字セットを扱うための、よりよい基盤を内部にもつ
	ようになった。
	</para></listitem>

	<listitem><para>
<indexterm><primary>認証システム</primary></indexterm>
	新しい認証システム。内部の認証システムはほとんど書き換えられた。変更の多くは
	内部的なものであるが、新しい認証システムはとても自由に設定できる。
	</para></listitem>

	<listitem><para>
<indexterm><primary>名前の短縮</primary></indexterm>
	新しい、ファイル名の短縮システム。ファイル名短縮システムは完全に書き換えられた。
	内部データベースは、恒久的に短縮マップを格納する。
	</para></listitem>

	<listitem><para>
<indexterm><primary>netコマンド</primary></indexterm>
        新しい<quote>net</quote>コマンド。新しい<quote>net</quote>コマンドが追加された。
	Windows中の<quote>net</quote>コマンドと幾分似ている。結局、たくさんある他の
	ユーティリティ(たとえばsmbpasswd)を<quote>net</quote>中のサブコマンドで
	置き換えることを計画している。
	</para></listitem>

	<listitem><para>
<indexterm><primary>status32コード</primary></indexterm>
	Sambaはネットワーク上でNT形式のstatus32コードで通信できるようになった。
	これはかなりエラーハンドリングを改善する。
	</para></listitem>

	<listitem><para>
<indexterm><primary>プリンタ属性の公開</primary></indexterm>
	よりよいWindows 200x/XP印刷サポート。Active Directory中にプリンタ属性を
	公開することを含む。
	</para></listitem>

	<listitem><para>
<indexterm><primary>RPCモジュール</primary></indexterm>
<indexterm><primary>passdbバックエンド</primary></indexterm>
<indexterm><primary>文字セット</primary></indexterm>
	新しい、passdbバックエンドと文字セット用の、ローダブルRPCモジュール。
	</para></listitem>

	<listitem><para>
<indexterm><primary>winbinddデーモンの二重化</primary></indexterm>
	よりパフォーマンスを改善するために、既定値で、winbinddデーモンの二重化をサポート。
	</para></listitem>

	<listitem><para>
<indexterm><primary>移行</primary></indexterm>
<indexterm><primary>idの移行</primary></indexterm>
<indexterm><primary>SID</primary></indexterm>
	Windows NT 4.0ドメインからSambaドメインへ、管理ユーザ、グループとドメインSIDの
	移行サポート。
	</para></listitem>

	<listitem><para>
<indexterm><primary>ドメイン間の信頼</primary></indexterm>
<indexterm><primary>ドメインコントローラ</primary></indexterm>
	Windows NT 4.0ドメインコントローラとの信頼関係の確立のサポート。
	</para></listitem>

	<listitem><para>
<indexterm><primary>Winbindアーキテクチャ</primary></indexterm>
<indexterm><primary>LDAPディレクトリ</primary></indexterm>
<indexterm><primary>ID mapping</primary></indexterm>
	SIDからUID/GIDマッピングをLDAPディレクトリに格納する事による、
	分散Winbindアーキテクチャの新規サポート。
	</para></listitem>

	<listitem><para>
	Samba文書構造の大規模な更新。
	</para></listitem>

	<listitem><para>
<indexterm><primary>SMB署名</primary></indexterm>
<indexterm><primary>セキュリティの設定</primary></indexterm>
	既定値のWindows 2003セキュリティ設定との互換を取るために、サーバと
	クライアントにおけるSMB署名の完全なサポート。
	</para></listitem>
</orderedlist>

<para>
さらに多くの改良がある!
</para>


<sect3>
<title>設定パラメータの変更</title>

<para>
この節には、Samba-2.2.xシリーズからSamba-3.0.25を含むまでの&smb.conf;の変更の
簡単な一覧がある。
</para>

<para>
新規、あるいは変更されたパラメータについての完全な説明は、smb.conf(5)のマニュアル
ページを参照のこと。
</para>

<para>
Sambaのアップデートあるいはアップグレードをするときはいつでも、Sambaの配布セット
の一部である、<emphasis>WHATSNEW.txt</emphasis>というファイルを読むことを強く推奨する。
このファイルは、Sambaの<ulink url="http://www.samba.org/samba/">webサイト</ulink>の、
右側のカラム、Current Stable Releaseの下で、<emphasis>Release Notes</emphasis>を
クリックして入手してもよい。
</para>

</sect3>

<sect3>
<title>削除されたパラメータ</title>

<indexterm><primary>削除されたパラメータ</primary></indexterm>
<para>
アルファベット順で、以下はSamba-2.2.xから3.0.35で削除されたパラメータの一覧である。
</para>

<itemizedlist>
	<listitem><para>admin log</para></listitem>
	<listitem><para>alternate permissions</para></listitem>
	<listitem><para>character set</para></listitem>
	<listitem><para>client codepage</para></listitem>
	<listitem><para>code page directory</para></listitem>
	<listitem><para>coding system</para></listitem>
	<listitem><para>domain admin group</para></listitem>
	<listitem><para>domain guest group</para></listitem>
	<listitem><para>enable rid algorithm</para></listitem>
	<listitem><para>enable svcctl</para></listitem>
	<listitem><para>force unknown acl user</para></listitem>
	<listitem><para>hosts equiv</para></listitem>
	<listitem><para>ldap filter</para></listitem>
	<listitem><para>min password length</para></listitem>
	<listitem><para>nt smb support</para></listitem>
	<listitem><para>post script</para></listitem>
	<listitem><para>printer admin</para></listitem>
	<listitem><para>printer driver</para></listitem>
	<listitem><para>printer driver file</para></listitem>
	<listitem><para>printer driver location</para></listitem>
	<listitem><para>read size</para></listitem>
	<listitem><para>source environment</para></listitem>
	<listitem><para>status </para></listitem>
	<listitem><para>strip dot </para></listitem>
	<listitem><para>total print jobs</para></listitem>
	<listitem><para>unicode</para></listitem>
	<listitem><para>use rhosts</para></listitem>
	<listitem><para>valid chars</para></listitem>
	<listitem><para>vfs options</para></listitem>
	<listitem><para>winbind enable local accounts</para></listitem>
	<listitem><para>winbind max idle children</para></listitem>
	<listitem><para>wins partners</para></listitem>
</itemizedlist>

</sect3>

<sect3>
<title>New Parameters</title>

<para>The following new parameters have been released up to and including Samba 3.0.25 (grouped by function:)</para>

<para>Remote Management</para>

<indexterm><primary>new parameters</primary></indexterm>

<itemizedlist>
	<listitem><para>abort shutdown script</para></listitem>
	<listitem><para>shutdown script</para></listitem>
</itemizedlist>

<para>User and Group Account Management</para>

<itemizedlist>
	<listitem><para>add group script</para></listitem>
	<listitem><para>add machine script</para></listitem>
	<listitem><para>add user to group script</para></listitem>
	<listitem><para>algorithmic rid base</para></listitem>
	<listitem><para>delete group script</para></listitem>
	<listitem><para>delete user from group script</para></listitem>
	<listitem><para>passdb backend</para></listitem>
	<listitem><para>rename user script</para></listitem>
	<listitem><para>set primary group script</para></listitem>
	<listitem><para>username map script</para></listitem>
</itemizedlist>

<para>Authentication</para>

<itemizedlist>
	<listitem><para>auth methods</para></listitem>
	<listitem><para>ldap password sync</para></listitem>
	<listitem><para>passdb expand explicit</para></listitem>
	<listitem><para>realm</para></listitem>
</itemizedlist>

<para>Protocol Options</para>

<itemizedlist>
	<listitem><para>add port command</para></listitem>
	<listitem><para>afs token lifetime</para></listitem>
	<listitem><para>client lanman auth</para></listitem>
	<listitem><para>client NTLMv2 auth</para></listitem>
	<listitem><para>client schannel</para></listitem>
	<listitem><para>client signing</para></listitem>
	<listitem><para>client use spnego</para></listitem>
	<listitem><para>defer sharing violations</para></listitem>
	<listitem><para>disable netbios</para></listitem>
	<listitem><para>dmapi support</para></listitem>
	<listitem><para>enable privileges</para></listitem>
	<listitem><para>use kerberos keytab</para></listitem>
	<listitem><para>log nt token command</para></listitem>
	<listitem><para>ntlm auth</para></listitem>
	<listitem><para>paranoid server security </para></listitem>
	<listitem><para>sendfile</para></listitem>
	<listitem><para>server schannel</para></listitem>
	<listitem><para>server signing</para></listitem>
	<listitem><para>smb ports</para></listitem>
	<listitem><para>svcctl list</para></listitem>
	<listitem><para>use spnego</para></listitem>
</itemizedlist>

<para>File Service</para>

<itemizedlist>
	<listitem><para>allocation roundup size</para></listitem>
	<listitem><para>acl check permissions</para></listitem>
	<listitem><para>acl group control</para></listitem>
	<listitem><para>acl map full control</para></listitem>
	<listitem><para>aio read size</para></listitem>
	<listitem><para>aio write size</para></listitem>
	<listitem><para>dfree cache time</para></listitem>
	<listitem><para>dfree command</para></listitem>
	<listitem><para>ea support</para></listitem>
	<listitem><para>enable asu support</para></listitem>
	<listitem><para>fam change notify</para></listitem>
	<listitem><para>force unknown acl user</para></listitem>
	<listitem><para>get quota command</para></listitem>
	<listitem><para>hide special files</para></listitem>
	<listitem><para>hide unwriteable files</para></listitem>
	<listitem><para>inherit owner</para></listitem>
	<listitem><para>hostname lookups</para></listitem>
	<listitem><para>kernel change notify</para></listitem>
	<listitem><para>mangle prefix</para></listitem>
	<listitem><para>map acl inherit</para></listitem>
	<listitem><para>map read only</para></listitem>
	<listitem><para>max stat cache size</para></listitem>
	<listitem><para>msdfs proxy</para></listitem>
	<listitem><para>open files database hash size</para></listitem>
	<listitem><para>set quota command</para></listitem>
	<listitem><para>store dos attributes</para></listitem>
	<listitem><para>use sendfile</para></listitem>
	<listitem><para>usershare allow guests</para></listitem>
	<listitem><para>usershare max shares</para></listitem>
	<listitem><para>usershare owner only</para></listitem>
	<listitem><para>usershare path</para></listitem>
	<listitem><para>usershare prefix allow list</para></listitem>
	<listitem><para>usershare prefix deny list</para></listitem>
	<listitem><para>usershare template share</para></listitem>
	<listitem><para>vfs objects</para></listitem>
</itemizedlist>

<para>Printing</para>

<itemizedlist>
	<listitem><para>cups options</para></listitem>
	<listitem><para>cups server</para></listitem>
	<listitem><para>force printername</para></listitem>
	<listitem><para>iprint server</para></listitem>
	<listitem><para>max reported print jobs</para></listitem>
	<listitem><para>printcap cache time</para></listitem>
</itemizedlist> 


<para>Unicode and Character Sets</para>

<itemizedlist>
	<listitem><para>display charset</para></listitem>
	<listitem><para>dos charset</para></listitem>
	<listitem><para>UNIX charset</para></listitem>
</itemizedlist>

<para>SID to UID/GID Mappings</para>

<itemizedlist>
	<listitem><para>idmap backend</para></listitem>
	<listitem><para>idmap gid</para></listitem>
	<listitem><para>idmap uid</para></listitem>
	<listitem><para>username map script</para></listitem>
	<listitem><para>winbind nss info</para></listitem>
	<listitem><para>winbind offline logon</para></listitem>
	<listitem><para>winbind refresh tickets</para></listitem>
	<listitem><para>winbind trusted domains only</para></listitem>
	<listitem><para>template primary group</para></listitem>
</itemizedlist>

<para>LDAP</para>

<itemizedlist>
	<listitem><para>ldap delete dn</para></listitem>
	<listitem><para>ldap group suffix</para></listitem>
	<listitem><para>ldap idmap suffix</para></listitem>
	<listitem><para>ldap machine suffix</para></listitem>
	<listitem><para>ldap passwd sync</para></listitem>
	<listitem><para>ldap replication sleep</para></listitem>
	<listitem><para>ldap timeout</para></listitem>
	<listitem><para>ldap user suffix</para></listitem>
</itemizedlist>

<para>General Configuration</para>

<itemizedlist>
	<listitem><para>eventlog list</para></listitem>
	<listitem><para>preload modules</para></listitem>
	<listitem><para>reset on zero vc</para></listitem>
	<listitem><para>privatedir</para></listitem>
</itemizedlist>

</sect3>

<sect3>
<title>Modified Parameters (Changes in Behavior)</title>

<itemizedlist>
	<listitem><para>acl group control (new default is No, deprecated parameter)</para></listitem>
	<listitem><para>change notify timeout (scope changed)</para></listitem>
	<listitem><para>dos filemode (disabled by default)</para></listitem>
	<listitem><para>dos filetimes (enabled by default)</para></listitem>
	<listitem><para>enable asu support (disabled by default)</para></listitem>
	<listitem><para>enable privileges (enabled by default)</para></listitem>
	<listitem><para>encrypt passwords (enabled by default) </para></listitem>
	<listitem><para>host msdfs (enabled by default)</para></listitem>
	<listitem><para>mangling method (set to hash2 by default) </para></listitem>
	<listitem><para>map to guest</para></listitem>
	<listitem><para>only user (deprecated)</para></listitem>
	<listitem><para>passwd chat</para></listitem>
	<listitem><para>passwd program</para></listitem>
	<listitem><para>password server</para></listitem>
	<listitem><para>restrict anonymous (integer value)</para></listitem>
	<listitem><para>security (new ads value)</para></listitem>
	<listitem><para>strict locking (auto by default)</para></listitem>
	<listitem><para>winbind cache time (increased to 5 minutes)</para></listitem>
	<listitem><para>winbind enum groups (disabled by default)</para></listitem>
	<listitem><para>winbind enum users (disabled by default)</para></listitem>
	<listitem><para>winbind nested groups (enabled by default)</para></listitem>
	<listitem><para>winbind uid (deprecated in favor of idmap uid)</para></listitem>
	<listitem><para>winbind gid (deprecated in favor of idmap gid)</para></listitem>
	<listitem><para>winbindd nss info</para></listitem>
	<listitem><para>write cache (deprecated)</para></listitem>
</itemizedlist>

</sect3>

</sect2>

<sect2>
<title>New Functionality</title>

	<para>
<indexterm><primary>major changes</primary></indexterm>
	The major changes in behavior since that Samba-2.2.x series are documented in this section.
	Please refer to the <filename>WHATSNEW.txt</filename> file that ships with every release of
	Samba to obtain detailed information regarding the changes that have been made during the
	life of the current Samba release.
	</para>

	<sect3>
	<title>TDB Data Files</title>

<indexterm><primary>tdb data files</primary></indexterm>
	<para>
	Refer to <link linkend="install">Installation, Chapter 1</link>, <link linkend="tdbdocs">Chapter 1</link>
	for information pertaining to the Samba-3 data files, their location and the information that must be
	preserved across server migrations, updates and upgrades.
	</para>

	<para>
<indexterm><primary>tdb file backup</primary></indexterm>
	Please remember to back up your existing ${lock directory}/*tdb before upgrading to Samba-3. If necessary,
	Samba will upgrade databases as they are opened. Downgrading from Samba-3 to 2.2, or reversion to an earlier
	version of Samba-3 from a later release, is an unsupported path.
	</para>

	<para>
<indexterm><primary>tdb file descriptions</primary></indexterm>
	The old Samba-2.2.x tdb files are described in <link linkend="oldtdbfiledesc">the next table</link>.
	</para>


        <table frame='all' id="oldtdbfiledesc"><title>Samba-2.2.x TDB File Descriptions</title>
        <tgroup cols='3'>
			<colspec align="left"/>
			<colspec align="justify" colwidth="1*"/>
			<colspec align="left"/>
                <thead>
                <row>
                        <entry align="left">Name</entry>
                        <entry align="justify">Description</entry>
                        <entry align="center">Backup?</entry>
                </row>
                </thead>
                <tbody>
                <row>
                        <entry>account_policy</entry>
			<entry>User policy settings</entry>
			<entry>yes</entry>
		</row>
		<row>
			<entry>brlock</entry>
			<entry>Byte-range file locking information.</entry>
			<entry>no</entry>
		</row>
		<row>
			<entry>connections</entry>
			<entry><para>Client connection information</para></entry>
			<entry>no</entry>
		</row>
		<row>
			<entry>locking</entry>
			<entry>Temporary file locking data.</entry>
			<entry>no</entry>
		</row>
		<row>
			<entry>messages</entry>
			<entry><para>Temporary storage of messages being processed by smbd.</para></entry>
			<entry>no</entry>
		</row>
       <row>
            <entry>ntdrivers</entry>
            <entry><para>Stores per-printer driver information.</para></entry>
			<entry>yes</entry>
        </row>
        <row>
            <entry>ntforms</entry>
            <entry><para>Stores per-printer forms information.</para></entry>
			<entry>yes</entry>
        </row>
        <row>
            <entry>ntprinters</entry>
            <entry><para>Stores the per-printer devmode configuration settings.</para></entry>
			<entry>yes</entry>
        </row>
		<row>
			<entry>printing/*.tdb</entry>
			<entry><para>Cached output from lpq command created on a per-print-service basis.</para></entry>
			<entry>no</entry>
		</row>
		<row>

			<entry>registry</entry>
			<entry><para>Read-only Samba registry skeleton that provides support for
				exporting various database tables via the winreg RPCs.</para></entry>
			<entry>no</entry>
		</row>
		<row>
			<entry>sessionid</entry>
			<entry><para>Temporary cache for miscellaneous session information.</para></entry>
			<entry>no</entry>
		</row>
		<row>
			<entry>share_info</entry>
			<entry>Share ACL settings.</entry>
			<entry>yes</entry>
		</row>
		<row>

			<entry>unexpected</entry>
			<entry><para>Packets received for which no process was listening.</para></entry>
			<entry>no</entry>
		</row>
		<row>
			<entry>winbindd_cache</entry>
			<entry><para>Cache of identity information received from an NT4 or an ADS domain.</para></entry>
			<entry>yes</entry>
		</row>
		<row>
			<entry>winbindd_idmap</entry>
			<entry><para>New ID map table from SIDS to UNIX UIDs/GIDs.</para></entry>
			<entry>yes</entry>
		</row>
		</tbody>
	</tgroup>
	</table>

	</sect3>

	<sect3>
	<title>Changes in Behavior</title>

	<para>
	The following issues are known changes in behavior between Samba-2.2 and
	Samba-3 that may affect certain installations of Samba.
	</para>

	<orderedlist>
		<listitem><para>
<indexterm><primary>Windows domain</primary></indexterm>
<indexterm><primary>getpwnam() call</primary></indexterm>
<indexterm><primary>NT_STATUS_LOGON_FAILURE</primary></indexterm>
		When operating as a member of a Windows domain, Samba-2.2 would map any users authenticated by the remote DC
		to the <quote>guest account</quote> if a UID could not be obtained via the getpwnam() call. Samba-3 rejects
		the connection with the error message <quote>NT_STATUS_LOGON_FAILURE.</quote> There is no current workaround
		to re-establish the Samba-2.2 behavior.
		</para></listitem>

		<listitem><para>
<indexterm><primary>add user script</primary></indexterm>
<indexterm><primary>add machine script</primary></indexterm>
		When adding machines to a Samba-2.2 controlled domain, the
		<quote>add user script</quote> was used to create the UNIX identity of the
		machine trust account. Samba-3 introduces a new <quote>add machine
		script</quote> that must be specified for this purpose. Samba-3 will
		not fall back to using the <quote>add user script</quote> in the absence of
		an <quote>add machine script</quote>.
		</para></listitem>
	</orderedlist>

	</sect3>

	<sect3>
	<title>Passdb Backends and Authentication</title>

	<para>
	There have been a few new changes that Samba administrators should be
	aware of when moving to Samba-3.
	</para>

	<orderedlist>
		<listitem><para>
<indexterm><primary>encrypted passwords</primary></indexterm>
		Encrypted passwords have been enabled by default in order to
		interoperate better with out-of-the-box Windows client
		installations. This does mean that either (a) a Samba account
		must be created for each user, or (b) <quote>encrypt passwords = no</quote>
		must be explicitly defined in &smb.conf;.
		</para></listitem>

		<listitem><para>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>Kerberos</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
		Inclusion of new <smbconfoption name="security">ads</smbconfoption> option for integration
		with an Active Directory domain using the native Windows Kerberos 5 and LDAP protocols.
		</para></listitem>
	</orderedlist>

	<para>
<indexterm><primary>account storage backends</primary></indexterm>
	Samba-3 also includes the possibility of setting up chains of authentication methods (<smbconfoption
	name="auth methods"/>) and account storage backends (<smbconfoption name="passdb backend"/>).  Please refer to
	the &smb.conf; man page and <link linkend="passdb">Account Information Databases</link>, for
	details. While both parameters assume sane default values, it is likely that you will need to understand what
	the values actually mean in order to ensure Samba operates correctly.
	</para>

	<para>
<indexterm><primary>pdbedit</primary></indexterm>
<indexterm><primary>smbpasswd</primary></indexterm>
<indexterm><primary>net tool</primary></indexterm>
	Certain functions of the <command>smbpasswd</command> tool have been split between the
	new <command>smbpasswd</command> utility, the <command>net</command> tool, and the new <command>pdbedit</command>
	utility. See the respective man pages for details.
	</para>

	</sect3>

	<sect3>
	<title>LDAP</title>

	<para>
	This section outlines the new features effecting Samba/LDAP integration.
	</para>

		<sect4>
		<title>New Schema</title>

		<para>
<indexterm><primary>object class</primary></indexterm>
<indexterm><primary>sambaSamAccount</primary></indexterm>
<indexterm><primary>LDIF</primary></indexterm>
<indexterm><primary>attributes</primary></indexterm>
		A new object class (sambaSamAccount) has been introduced to replace
		the old sambaAccount. This change aids in the renaming of attributes
		to prevent clashes with attributes from other vendors. There is a
		conversion script (examples/LDAP/convertSambaAccount) to modify an LDIF
		file to the new schema.
		</para>

		<para>
		Example:
<indexterm><primary>ldapsearch</primary></indexterm>
		</para>
		<para><screen>
		&prompt;ldapsearch .... -LLL -b "ou=people,dc=..." &gt; old.ldif
		&prompt;convertSambaAccount --sid &lt;DOM SID&gt; --input old.ldif --output new.ldif
		</screen></para>

		<para>
<indexterm><primary>net</primary><secondary>getlocalsid</secondary></indexterm>
		The &lt;DOM SID&gt; can be obtained by running
<screen>
&prompt;<userinput>net getlocalsid &lt;DOMAINNAME&gt;</userinput>
</screen>
<indexterm><primary>PDC</primary></indexterm>
		on the Samba PDC as root.
		</para>

		<para>
		Under Samba-2.x the domain SID can be obtained by executing:
<indexterm><primary>smbpasswd</primary></indexterm>
<screen>
&prompt;<userinput>smbpasswd -S &lt;DOMAINNAME&gt;</userinput>
</screen>
		</para>

		<para>
<indexterm><primary>old sambaAccount</primary></indexterm>
<indexterm><primary>ldapsam_compat</primary></indexterm>
<indexterm><primary>object class declaration</primary></indexterm>
<indexterm><primary>samba.schema</primary></indexterm>
		The old <literal>sambaAccount</literal> schema may still be used by specifying the
		<parameter>ldapsam_compat</parameter> passdb backend. However, the sambaAccount and
		associated attributes have been moved to the historical section of
		the schema file and must be uncommented before use if needed.
		The Samba-2.2 object class declaration for a <literal>sambaAccount</literal> has not changed
		in the Samba-3 <filename>samba.schema</filename> file.
		</para>

		<para>
		Other new object classes and their uses include:
		</para>

		<itemizedlist>
			<listitem><para>
<indexterm><primary>sambaDomain</primary></indexterm>
<indexterm><primary>domain information</primary></indexterm>
<indexterm><primary>RID</primary></indexterm>
<indexterm><primary>ldap suffix</primary></indexterm>
<indexterm><primary>ldapsam</primary></indexterm>
<indexterm><primary>idmap</primary></indexterm>
			<literal>sambaDomain</literal> &smbmdash; domain information used to allocate RIDs
			for users and groups as necessary. The attributes are added
			in <quote>ldap suffix</quote> directory entry automatically if
			an idmap UID/GID range has been set and the <quote>ldapsam</quote>
			passdb backend has been selected.
			</para></listitem>

			<listitem><para>
<indexterm><primary>sambaGroupMapping</primary></indexterm>
<indexterm><primary>ldap group suffix</primary></indexterm>
<indexterm><primary>net groupmap</primary></indexterm>
			sambaGroupMapping &smbmdash; an object representing the
			relationship between a posixGroup and a Windows
			group/SID. These entries are stored in the <quote>ldap
			group suffix</quote> and managed by the <quote>net groupmap</quote> command.
			</para></listitem>

			<listitem><para>
<indexterm><primary>sambaUNIXIdPool</primary></indexterm>
<indexterm><primary>ldap idmap suffix</primary></indexterm>
<indexterm><primary>idmap UID</primary></indexterm>
<indexterm><primary>idmap GID</primary></indexterm>
			<literal>sambaUNIXIdPool</literal> &smbmdash; created in the <quote>ldap idmap suffix</quote> entry
			automatically and contains the next available <quote>idmap UID</quote> and
			<quote>idmap GID</quote>.
			</para></listitem>

			<listitem><para>
<indexterm><primary>sambaIdmapEntry</primary></indexterm>
<indexterm><primary>idmap_ldap module</primary></indexterm>
			<literal>sambaIdmapEntry</literal> &smbmdash; object storing a mapping between a
			SID and a UNIX UID/GID. These objects are created by the
			idmap_ldap module as needed.
			</para></listitem>
		</itemizedlist>

		</sect4>

		<sect4>
		<title>New Suffix for Searching</title>

		<para>
<indexterm><primary>LDAP queries</primary></indexterm>
<indexterm><primary>passdb backend</primary></indexterm>
<indexterm><primary>ldap suffix</primary></indexterm>
<indexterm><primary>ldap user suffix</primary></indexterm>
<indexterm><primary>ldap machine suffix</primary></indexterm>
<indexterm><primary>ldap group suffix</primary></indexterm>
<indexterm><primary>ldap idmap suffix</primary></indexterm>
		The following new &smb.conf; parameters have been added to aid in directing
		certain LDAP queries when <parameter>passdb backend = ldapsam://...</parameter> has been
		specified.
		</para>

		<itemizedlist>
			<listitem><para>ldap suffix         &smbmdash; used to search for user and computer accounts.</para></listitem>
			<listitem><para>ldap user suffix    &smbmdash; used to store user accounts.</para></listitem>
			<listitem><para>ldap machine suffix &smbmdash; used to store machine trust accounts.</para></listitem>
			<listitem><para>ldap group suffix   &smbmdash; location of posixGroup/sambaGroupMapping entries.</para></listitem>
			<listitem><para>ldap idmap suffix   &smbmdash; location of sambaIdmapEntry objects.</para></listitem>
		</itemizedlist>

		<para>
<indexterm><primary>ldap suffix</primary></indexterm>
<indexterm><primary>subsuffix parameters</primary></indexterm>
		If an <parameter>ldap suffix</parameter> is defined, it will be appended to all of the
		remaining subsuffix parameters. In this case, the order of the suffix
		listings in &smb.conf; is important. Always place the <parameter>ldap suffix</parameter> first
		in the list.
		</para>

		<para>
		Due to a limitation in Samba's &smb.conf; parsing, you should not surround
		the domain names with quotation marks.
		</para>

		</sect4>

		<sect4>
		<title>IdMap LDAP Support</title>

		<para>
<indexterm><primary>idmap backend</primary></indexterm>
		Samba-3 supports an LDAP backend for the idmap subsystem. The
		following options inform Samba that the idmap table should be
		stored on the directory server <emphasis>onterose</emphasis> in the ou=Idmap,dc=quenya,dc=org partition.
		</para>

		<smbconfblock>
		<smbconfsection name="[global]"/>
		<member>...</member>
		<smbconfoption name="idmap backend">ldap:ldap://onterose/</smbconfoption>
		<smbconfoption name="ldap idmap suffix">ou=Idmap</smbconfoption>
		<smbconfoption name="idmap uid">40000-50000</smbconfoption>
		<smbconfoption name="idmap gid">40000-50000</smbconfoption>
		</smbconfblock>

		<para>
<indexterm><primary>NFS</primary></indexterm>
		This configuration allows Winbind installations on multiple servers to
		share a UID/GID number space, thus avoiding the interoperability problems
		with NFS that were present in Samba-2.2.
		</para>

		</sect4>

		</sect3>

	</sect2>

</sect1>

</chapter>
