<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<chapter id="idmapper">
<chapterinfo>
	&author.jht;
</chapterinfo>

<title>識別情報のマッピング(IDMAP)</title>

<para>
<indexterm><primary>Windows</primary></indexterm>
<indexterm><primary>相互運用性</primary></indexterm>
<indexterm><primary>IDMAP</primary></indexterm>
<indexterm><primary>Windows Security Identifiers</primary><see>SID</see></indexterm>
<indexterm><primary>SID</primary></indexterm>
<indexterm><primary>UID</primary></indexterm>
<indexterm><primary>GID</primary></indexterm>
Microsoft Windows オペレーティングシステムは、Sambaを実装したOSとの間での相互運用性を
行うために、難しい問題を要求してくるといういくつかの特徴がある。この章では、
SambaサーバをMicrosoft Windowsネットワーク環境に統合するための難問の1つを解決するために
使う、Samba-3(バージョン 3.0.8以降)のメカニズムについて明示的に説明する。この章では、
Windowsのセキュリティ識別子(SID)をUNIXのUIDとGIDについての識別情報マッピング(IDMAP)
について説明する。
</para>

<para>
いろいろな場面において十分に適用出来るようにするため、各可能なSambaの配布タイプに
ついて解説を行う。これは、どのようにIDMAP機能が実装されたかについての概要によって
フォローされる。
</para>

<para>
<indexterm><primary>ネットワーククライアント</primary></indexterm>
<indexterm><primary>IDMAP</primary></indexterm>
<indexterm><primary>IDMAP infrastructure</primary></indexterm>
<indexterm><primary>既定値の動作</primary></indexterm>
IDMAP機能は、複数のSambaサーバ(またはSambaネットワーククライアント)がドメイン中で
インストールされている場合に重要である。単一のSambaサーバにおいては、IDMAP基盤
については余り気にかける必要はない。&smbmdash;既定値におけるSambaの動作はほとんど
の場合、十分に使えるものである。複数のSambaサーバが使われる場合、あるサーバから
別のサーバにデータを移動する時にはしばしばこれが必要で、それはやっかい事が始まる
所でもある!
</para>

<para>
<indexterm><primary>UID</primary></indexterm>
<indexterm><primary>GID</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>NSS</primary></indexterm>
<indexterm><primary>nss_ldap</primary></indexterm>
<indexterm><primary>NT4のドメインメンバ</primary></indexterm>
<indexterm><primary>ADSのドメインメンバ</primary></indexterm>
<indexterm><primary>security name-space</primary></indexterm>
LDAPディレクトリ中にユーザとグループアカウント情報が格納されている場合、すべてのサーバは
ユーザとグループに対して一貫したUIDとGIDを使うことが出来る。これは、NSSとnss_ldapツール
を使うことで出来る。Sambaはローカルアカウントのみを使うように設定出来、その場合、IDMAP
での問題が発生する範囲は若干少なくなる。これは、サーバが単一のドメインに属していて、
ドメイン間の信頼関係が必要ない時に有効に動作する。別の言い方をすると、もしもSamba
サーバがNT4ドメインのメンバかADSのドメインメンバである場合か、不慮のクロスオーバが
ないように、セキュリティ名前空間を保持する必要がある場合、(すなわち、ユーザ
<literal>DOMINICUS\FJones</literal>は<literal>FRANCISCUS\FJones</literal>という
ユーザのアカウントリソースへのアクセスが出来ないようにしなければならない)
<footnote>Sambaローカルアカウントモードは、<literal>DOMINICUS\FJones</literal>と
<literal>FRANCISCUS\FJones</literal>の両者について、UNIXユーザ
<literal>FJones</literal>へマッピングを行う。</footnote>クローズする試みは、
IDMAP機能が設定されているという方法に対して提供されなければならない。
</para>

<para>
<indexterm><primary>IDMAP</primary></indexterm>
<indexterm><primary>domain access</primary></indexterm>
<indexterm><primary>SID</primary></indexterm>
<indexterm><primary>UID</primary></indexterm>
<indexterm><primary>GID</primary></indexterm>
<indexterm><primary>one domain</primary></indexterm>
IDMAPの使用は、Sambaサーバが一つ以上のドメインからワークステーションまたはサーバによって
アクセスされる場合に重要であり、そのような場合、winbindを動作させることが重要で、そうする
と、外部のSIDをローカルのUNIX UIDとGIDに解決(IDマッピング)することが出来るようになる。
</para>

<para>
<indexterm><primary>winbindd</primary></indexterm>
IDMAP機能は、Samba起動時に<command>winbindd</command>の実行を必要とする。
</para>

<sect1>
<title>SambaサーバのサーバタイプとIDMAP</title>

<para>
<indexterm><primary>サーバタイプ</primary></indexterm>
4つの基本的なサーバタイプがあり、これは、
 <link linkend="ServerType">サーバタイプとセキュリティモードの章</link>に
説明がある。
</para>

	<sect2>
	<title>スタンドアロンSambaサーバ</title>

	<para>
	<indexterm><primary>スタンドアロンサーバ</primary></indexterm>
	<indexterm><primary>Active Directory</primary></indexterm>
	<indexterm><primary>NT4ドメイン</primary></indexterm>
	スタンドアロンSambaサーバはWindows NT4ドメイン、Windows 200x Active Directory
	ドメインかSambaドメインのメンバでない形で動く。
	</para>

	<para>
	<indexterm><primary>IDMAP</primary></indexterm>
	<indexterm><primary>identity</primary></indexterm>
	<indexterm><primary>ローカルユーザ</primary></indexterm>
	定義により、これは、ユーザとグループはローカルに作成/制御され、ネットワーク
	ユーザの識別はローカルのUNIX/Linuxユーザログイン情報に一致しなければならない。
	そのため、IDMAP機能はほとんど関心を払う必要はなく、winbindも不要で、IDMAP
	機能は関連しないか、興味を持つべきものではない。
	</para>

	</sect2>

	<sect2>
	<title>ドメインメンバサーバかドメインメンバクライアント</title>

	<para>
	<indexterm><primary>PDC</primary></indexterm>
	<indexterm><primary>BDC</primary></indexterm>
	<indexterm><primary>NT4</primary></indexterm>
	<indexterm><primary>SID</primary></indexterm>
	<indexterm><primary>Active Directory</primary></indexterm>
	Samba-3はWindows NT4 PDCまたはBDCとして動作でき、それによって、Windows NT4と
	互換性を持つドメイン制御プロトコルを提供する。Samba-3のファイルと印刷共有
	プロトコルはすべてのバージョンのMicrosoft Windows製品と互換がある。Windows NT4は
	Microsoft Windows Active Directoryと同様、広範囲にWindows SIDを使用する。
	</para>

	<para>
	<indexterm><primary>MS Windows SID</primary></indexterm>
	<indexterm><primary>UID</primary></indexterm>
	<indexterm><primary>GID</primary></indexterm>
	Samba-3ドメインメンバサーバとクライアントはMicrosoft Windows SIDと正しく相互に
	処理を行わなければならない。入力されたSIDはローカルのUNIX UIDとGIDに変換され
	なければならない。Sambaサーバから出力する情報は、適切なSIDでMicrosoft Windows
	クライアントとサーバに提供されなければならない。
	</para>

	<para>
	<indexterm><primary>ADS</primary></indexterm>
	<indexterm><primary>winbind</primary></indexterm>
	Windowsネットワークドメイン(NT4形式またはADS)のメンバであるSambaはいろいろな
	方法で識別情報のマッピングを扱うように設定出来る。使用するメカニズムは、
	<command>winbindd</command>デーモンが使われるか否かとどのようにwinbindの
	機能が設定されているかに依存する。設定オプションの簡単な説明は以下の通り:
	</para>

	<variablelist>
		<varlistentry><term>Winbindが使用されず、ユーザとグループがローカルの場合: </term>
			<listitem>
				<para>
				<indexterm><primary>winbindd</primary></indexterm>
				<indexterm><primary>smbd</primary></indexterm>
				<indexterm><primary>ネットワークトラフィック</primary></indexterm>
				<indexterm><primary>LoginID</primary></indexterm>
				<indexterm><primary>アカウント名</primary></indexterm>
				<indexterm><primary>getpwnam</primary></indexterm>
				<indexterm><primary>NSS</primary></indexterm>
				<indexterm><primary>ローカルユーザ</primary></indexterm>
				<indexterm><primary>ローカルグループ</primary></indexterm>
				<indexterm><primary>/etc/passwd</primary></indexterm>
				<indexterm><primary>/etc/group</primary></indexterm>
				<command>winbindd</command>が使われないと、Samba
				(<command>smbd</command>)は、入力されたネットワークからの
				情報の識別を解決するための、基本的なUNIX/Linuxメカニズムを
				使用する。これは、セッションセットアップ要求時にLoginID
				(アカウント名)を使い、getpwnam()システムファンクションコール
				にそれを渡す。この呼び出しは最近のUNIX/Linuxシステム上では
				ネームサービススイッチ(NSS)メカニズムを使うように実装されて
				いる。"ユーザとグループがローカル"という場合、それらは
				ローカルシステム上の、<filename>/etc/passwd</filename>と
				<filename>/etc/group</filename>にそれぞれ格納されることを
				意味する。
				</para>

				<para>
				<indexterm><primary>SessionSetupAndX</primary></indexterm>
				<indexterm><primary>/etc/passwd</primary></indexterm>
				たとえば、ユーザ<literal>BERYLIUM\WambatW</literal>が
				Sambaサーバに対して接続をオープンしようとする場合、
				入力されるSessionSetupAndX要求は、<filename>/etc/passwd</filename>
				ファイル中のユーザ<literal>WambatW</literal>を検索するために
				システムを呼び出す。
				</para>

				<para>
				<indexterm><primary>スタンドアロン</primary></indexterm>
				<indexterm><primary>ドメインメンバサーバ</primary></indexterm>
				<indexterm><primary>NT4</primary></indexterm>
				<indexterm><primary>ADS</primary></indexterm>
				<indexterm><primary>PDC</primary></indexterm>
				<indexterm><primary>smbpasswd</primary></indexterm>
				<indexterm><primary>tdbsam</primary></indexterm>
				<indexterm><primary>passdbバックエンド</primary></indexterm>
				この設定は、スタンドアロンSambaサーバ、ドメインメンバサーバ
				(NT4またはADS)とsmbpasswdまたはtdbsamベースのSamba passdb
				バックエンドを使うPDCに対して使うことが出来る。
				</para>
			</listitem>
		</varlistentry>
	
		<varlistentry><term>Winbindは使わないが、ユーザとグループはNSS経由で解決する場合</term>
			<listitem>
				<para>
				<indexterm><primary>ユーザアカウント</primary></indexterm>
				<indexterm><primary>グループアカウント</primary></indexterm>
				<indexterm><primary>ローカルアカウント</primary></indexterm>
				<indexterm><primary>リポジトリ</primary></indexterm>
				<indexterm><primary>NIS</primary></indexterm>
				<indexterm><primary>LDAP</primary></indexterm>
				この場合、ユーザとグループアカウントは、ローカルアカウントとして
				取り扱われる。ローカルアカウントそのものとただ1つ違う点は、
				共有可能なリポジトリ内にアカウントが格納されると言うことである。
				一般的には、これは、NIS形式のデータベースか、そうでなければ
				LDAP内にあると言うことである。
				</para>

				<para>
				<indexterm><primary>スタンドアロン</primary></indexterm>
				<indexterm><primary>ドメインメンバサーバ</primary></indexterm>
				<indexterm><primary>NT4</primary></indexterm>
				<indexterm><primary>ADS</primary></indexterm>
				<indexterm><primary>PDC</primary></indexterm>
				<indexterm><primary>smbpasswd</primary></indexterm>
				<indexterm><primary>tdbsam</primary></indexterm>
				この設定は、スタンドアロンSambaサーバ、ドメインメンバサーバ
				(NT4またはADS)とsmbpasswdまたはtdbsamベースのSamba passdb
                                バックエンドを使うPDCに対して使うことが出来る。
				</para>
			</listitem>
		</varlistentry>

		<varlistentry><term>Winbind/NSSと既定値のローカルなIDMAPテーブルの場合: </term>
			<listitem>
				<para>
				<indexterm><primary>NT4ドメイン</primary></indexterm>
				<indexterm><primary>ADSドメイン</primary></indexterm>
				<indexterm><primary>winbind</primary></indexterm>
				<indexterm><primary>ドメイン制御</primary></indexterm>
				Windows NT4ドメインかADSドメインのメンバである単一のSamba
				サーバか単純なSambaサーバのみを必要とするサイトは多数ある。
				標準的なサーバの例は、ドメイン用のドメインコントローラ
				からアカウント認証情報を入手するためにwinbindを使うように
				設定され、ローカルアカウントを持たないアプライアンスの
				ようなファイルサーバである。ドメイン制御機能は、Samba-3、
				Microsoft Windows NT4かMicrosoft Windows Active Directory
				によって提供される。
				</para>

				<para>
				<indexterm><primary>UID numbers</primary></indexterm>
				<indexterm><primary>GID numbers</primary></indexterm>
				<indexterm><primary>/etc/nsswitch.conf</primary></indexterm>
				<indexterm><primary>winbind</primary></indexterm>
				<indexterm><primary>SID</primary></indexterm>
				Winbindは、この状態においては非常に有益である。必要と
				されるすべては、&smb.conf;ファイル中で定義することが出来る
				UIDとGIDの値の範囲である。<filename>/etc/nsswitch.conf</filename>
				ファイルは、入力されたSIDを適切なUIDとGIDにマッピングする
				ための、すべての難しい作業をこなす<command>winbind</command>
				を使うために設定される。SIDはwinbindがそれを受け取る順で
				UID/GIDに割り当てられる。
				</para>

				<para>
				<indexterm><primary>UID</primary></indexterm>
				<indexterm><primary>GID</primary></indexterm>
				<indexterm><primary>IDMAP</primary></indexterm>
				<indexterm><primary>corrupted file</primary></indexterm>
				この設定は、複数のSambaサーバとそれがすべてのサーバ間で
				同じUIDとGIDが同じユーザとグループになる事を要求する
				サイト中では便利でも実際的でもない。この方法の危険性の
				1つは、winbindのIDMAPデータベースファイルが壊れるか
				無くなった場合、修正あるいは再構成れれたIDMAPファイルは、
				現時点で正しい所有者に所属していない、Sambaサーバ上に格納
				された、Microsoft Windowsファイルの以前の結果から異なる
				ユーザとグループに割り当てるかもしれないということである。
				This configuration is not convenient or practical in sites that have more than one
				Samba server and that require the same UID or GID for the same user or group across
				all servers. One of the hazards of this method is that in the event that the winbind
				IDMAP file becomes corrupted or lost, the repaired or rebuilt IDMAP file may allocate
				UIDs and GIDs to different users and groups from what was there previously with the
				result that MS Windows files that are stored on the Samba server may now not belong to
				the rightful owners.
				</para>
			</listitem>
		</varlistentry>

		<varlistentry><term>Winbind/NSSがRIDベースのIDMAPの場合: </term>
			<listitem>
				<para>
				<indexterm><primary>RID</primary></indexterm>
				<indexterm><primary>idmap_rid</primary></indexterm>
				<indexterm><primary>ADS</primary></indexterm>
				<indexterm><primary>LDAP</primary></indexterm>
				IDMAP_RID機能はSamba 3.0.8から提供された。これは、
				ADSスキーマ拡張を適用しないMicrosoft ADSを使用する
				ことに関わりがあり、IDMAPテーブルをメンテナンスする
				目的のためにLDAPディレクトリサーバをインストールして
				いない、たくさんのサイトのために作業を簡単にする。
				もしも単一のADSドメイン(ドメインのフォレストではなく
				複数のドメインツリーでない)で、IDMAPテーブル問題に
				対して単純なステレオタイプの解決方法を望んでいるなら、
				IDMAP_RIDは明らかな選択肢である。
				</para>

				<para>
				<indexterm><primary>idmap_rid</primary></indexterm>
				<indexterm><primary>idmap uid</primary></indexterm>
				<indexterm><primary>idmap gid</primary></indexterm>
				<indexterm><primary>RID</primary></indexterm>
				<indexterm><primary>SID</primary></indexterm>
				<indexterm><primary>UID</primary></indexterm>
				<indexterm><primary>idmapバックエンド</primary></indexterm>
				<indexterm><primary>自動マッピング</primary></indexterm>
				この機能は<parameter>idmap uid</parameter>と
				<parameter>idmap gid</parameter>のレンジを割り当てることを
				要求し、それが、SIDの相対識別子(RID)の部分を直接UIDのベースにRIDの
				値を足した分に、自動マッピングするための、このレンジの
				サブセットを割り当てることが可能な
				<parameter>idmap uid</parameter>の範囲内であることを要求する。
				たとえば、もしも<parameter>idmap uid</parameter>の範囲が
				<constant>1000-100000000</constant>で、
				<parameter>idmap backend = idmap_rid:DOMAIN_NAME=1000-50000000</parameter>
				で、発生したSIDが
				<constant>S-1-5-21-34567898-12529001-32973135-1234</constant>
				という値ならば、結果のUIDは<constant>1000 + 1234 = 2234</constant>である。
				</para>
			</listitem>
		</varlistentry>

		<varlistentry><term>WinbindとNSS/LDAPバックエンドベースのIDMAP機能: </term>
			<listitem>
				<para>
				<indexterm><primary>ドメインメンバ</primary></indexterm>
				<indexterm><primary>winbind</primary></indexterm>
				<indexterm><primary>SID</primary></indexterm>
				<indexterm><primary>UID</primary></indexterm>
				<indexterm><primary>GID</primary></indexterm>
				<indexterm><primary>idmap gid</primary></indexterm>
				<indexterm><primary>idmap uid</primary></indexterm>
				<indexterm><primary>LDAP</primary></indexterm>
				この設定では、<command>winbind</command>は&smb.conf;ファイル内で
				指定された<parameter>idmap uid</parameter>と
				<parameter>idmap gid</parameter>の範囲からSIDからUIDとGIDに
				解決を行うが、ローカルのwinbind IDMAPテーブルを使う代わりに、
				すべてのドメインメンバマシン(クライアントとサーバ)が共通の
				IDMAPテーブルを共有できるためのLDAPディレクトリ中に格納された
				ものを使う。
				</para>

				<para>
				<indexterm><primary>idmapバックエンド</primary></indexterm>
				<indexterm><primary>LDAPサーバ</primary></indexterm>
				<indexterm><primary>LDAP redirects</primary></indexterm>
				すべてのLDAP IDMAPクライアントは、&smb.conf;ファイル中の
				<parameter>idmap backend</parameter>機能がLDAPリダイレクトを
				正しく扱えないため、マスタLDAPサーバのみを使うということは
				重要である。
				</para>
			</listitem>
		</varlistentry>

		<varlistentry><term>UNIX/LinuxのユーザとグループIDを解決するためにNSSを使うwinbindの場合: </term>
			<listitem>
				<para>
				passdb バックエンドとしてのLDAPの使用はPDC、BDCとドメイン
				メンバサーバに対する優れた解である。それは、UID、GIDと
				一致したSIDがすべてのサーバ間で首尾一貫している事を
				保証するきちんとした解である。
				</para>

				<para>
				<indexterm><primary>LDAP</primary></indexterm>
				<indexterm><primary>PADL</primary></indexterm>
				LDAPベースのpassdbバックエンドの使用は、PADL nss_ldap
				ユーティリティか同等品を要求する。この状況の場合、
				winbindは外部のSID、すなわち、スタンドアロン
				WindowsクライアントからのSID(すなわち、このドメインの
				メンバでない)を他のドメインからのSIDと同じように
				扱うために使われる。外部のUID/GIDは、ローカルのIDMAP
				テーブルでwinbindを使う時と同じ方法で正確に、
				割り当てられた範囲(idmap uidとidmap gid)にマップされる。
				</para>

				<para>
				<indexterm><primary>nss_ldap</primary></indexterm>
				<indexterm><primary>AD4UNIX</primary></indexterm>
				<indexterm><primary>MMC</primary></indexterm>
				nss_ldapツールセットはActive Directory経由と同様に、LDAP
				経由でUIDとGIDにアクセスするために使われる。Active Directory
				を使うために、AD4UNIXスキーマ拡張か、Microsoft Services for
				UNIXバージョン3.5かそれ以降のどちらかをを、UNIXアカウント
				認証情報を管理するために、ADSスキーマを	拡張するために
				インストールしてADSスキーマを変更することが必要である。
				ADSスキーマが拡張されると、Microsoft管理コンソール(MMC)
				スナップインもADSのユーザとコンピュータ管理ツールから
				UNIXの認証情報を設定/管理することが出来るようにインストール
				される。各アカウントは、UIDとGIDデータがSambaによって使われる
				ことが出来る前に、UNIXで有効な状態と分離されなければならない。
				</para>
			</listitem>
		</varlistentry>

	</variablelist>

	</sect2>

	<sect2>
	<title>プライマリドメインコントローラ</title>

	<para>
	<indexterm><primary>ドメインセキュリティ</primary></indexterm>
	<indexterm><primary>SID</primary></indexterm>
	<indexterm><primary>RID</primary></indexterm>
	<indexterm><primary>algorithmic mapping</primary></indexterm>
	Microsoft Windowsドメインセキュリティシステムは、アカウント作成のプロセスの
	一部として、ユーザとグループSIDを生成する。WindowsはUNIXのUIDかGIDのような
	概念を持たない。その代わり、固有のタイプのセキュリティ記述子を持つ。Sambaが
	ドメインコントローラとして使われる時、各ユーザとグループに固有のSIDを生成する
	手段を提供する。Sambaは、&smb.conf;ファイル中で指定されたベースの値にUID
	またはGIDを2倍した値を足すという算術的に計算されたRIDを足すマシンとドメイン
	SIDを生成する。この方法は<quote>算術的マッピング</quote>と呼ばれる。
	</para>

	<para>
	<indexterm><primary>RID base</primary></indexterm>
	例をあげると、もしもユーザのUIDが4321の場合、算術的なRIDベースが1000だとすると、
	RIDは<literal>1000 + (2 x 4321) = 9642</literal>となる。そのため、もしもドメイン
	SIDが<literal>S-1-5-21-89238497-92787123-12341112</literal>ならば、
	結果のSIDは<literal>S-1-5-21-89238497-92787123-12341112-9642</literal>となる。
	</para>

	<para>
	<indexterm><primary>on-the-fly</primary></indexterm>
	<indexterm><primary>SID</primary></indexterm>
	<indexterm><primary>passdb backend</primary></indexterm>
	<indexterm><primary>ldapsam</primary></indexterm>
	The foregoing type of SID is produced by Samba as an automatic function and is either produced on the fly
	(as is the case when using a <parameter>passdb backend = [tdbsam | smbpasswd]</parameter>), or may be stored
	as a permanent part of an account in an LDAP-based ldapsam.
	</para>

	<para>
	<indexterm><primary>SFU 3.5</primary></indexterm>
	<indexterm><primary>ADS</primary></indexterm>
	<indexterm><primary>directory schema</primary></indexterm>
	<indexterm><primary>account attributes</primary></indexterm>
	<indexterm><primary>UID</primary></indexterm>
	<indexterm><primary>GID</primary></indexterm>
	<indexterm><primary>ADS schema</primary></indexterm>
	<indexterm><primary>account management</primary></indexterm>
	<indexterm><primary>MMC</primary></indexterm>
	ADS uses a directory schema that can be extended to accommodate additional
	account attributes such as UIDs and GIDs. The installation of Microsoft Service for UNIX 3.5 will expand
	the normal ADS schema to include UNIX account attributes. These must of course be managed separately
	through a snap-in module to the normal ADS account management MMC interface.
	</para>

	<para>
	<indexterm><primary>PDC</primary></indexterm>
	<indexterm><primary>passdb backend</primary></indexterm>
	<indexterm><primary>BDC</primary></indexterm>
	<indexterm><primary>LDAP backend</primary></indexterm>
	Security identifiers used within a domain must be managed to avoid conflict and to preserve itegrity.
	In an NT4 domain context, the PDC manages the distribution of all security credentials to the backup
	domain controllers (BDCs). At this time the only passdb backend for a Samba domain controller that is suitable
	for such information is an LDAP backend.
	</para>

	</sect2>

	<sect2>
	<title>Backup Domain Controller</title>

	<para>
	<indexterm><primary>BDC</primary></indexterm>
	<indexterm><primary>read-only access</primary></indexterm>
	<indexterm><primary>security credentials</primary></indexterm>
	<indexterm><primary>LDAP</primary></indexterm>
	<indexterm><primary>group account</primary></indexterm>
	<indexterm><primary>write changes</primary></indexterm>
	<indexterm><primary>directory</primary></indexterm>
	BDCs have read-only access to security credentials that are stored in LDAP.
	Changes in user or group account information are passed by the BDC to the PDC. Only the PDC can write
	changes to the directory.
	</para>

	<para>
	IDMAP information can be written directly to the LDAP server so long as all domain controllers
	have access to the master (writable) LDAP server. Samba-3 at this time does not handle LDAP redirects
	in the IDMAP backend. This means that it is is unsafe to use a slave (replicate) LDAP server with
	the IDMAP facility.
	</para>

	</sect2>

</sect1>

<sect1>
<title>Examples of IDMAP Backend Usage</title>

<para>
<indexterm><primary>Domain Member Server</primary><see>DMS</see></indexterm>
<indexterm><primary>Domain Member Client</primary><see>DMC</see></indexterm>
<indexterm><primary>DMS</primary></indexterm>
<indexterm><primary>DMC</primary></indexterm>
<indexterm><primary>winbind</primary></indexterm>
Anyone who wishes to use <command>winbind</command> will find the following example configurations helpful.
Remember that in the majority of cases <command>winbind</command> is of primary interest for use with
domain member servers (DMSs) and domain member clients (DMCs).
</para>

	<sect2>
	<title>Default Winbind TDB</title>

	<para>
	Two common configurations are used:
	</para>

	<itemizedlist>
		<listitem><para>
		Networks that have an NT4 PDC (with or without BDCs) or a Samba PDC (with or without BDCs).
		</para></listitem>

		<listitem><para>
		Networks that use MS Windows 200x ADS.
		</para></listitem>
	</itemizedlist>

	<sect3>
	<title>NT4-Style Domains (Includes Samba Domains)</title>

	<para>
	<link linkend="idmapnt4dms">NT4 Domain Member Server smb.con</link> is a simple example of an NT4 DMS
	&smb.conf; file that shows only the global section.
	</para>

<example id="idmapnt4dms">
<title>NT4 Domain Member Server smb.conf</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">MEGANET2</smbconfoption>
<smbconfoption name="security">DOMAIN</smbconfoption>
<smbconfoption name="idmap uid">10000-20000</smbconfoption>
<smbconfoption name="idmap gid">10000-20000</smbconfoption>
<smbconfoption name="template primary group">"Domain Users"</smbconfoption>
<smbconfoption name="template shell">/bin/bash</smbconfoption>
</smbconfblock>
</example>

	<para>
	<indexterm><primary>winbind</primary></indexterm>
	<indexterm><primary>/etc/nsswitch.conf</primary></indexterm>
	The use of <command>winbind</command> requires configuration of NSS. Edit the <filename>/etc/nsswitch.conf</filename>
	so it includes the following entries:
<screen>
...
passwd: files winbind
shadow: files winbind
group:  files winbind
...
hosts:  files [dns] wins
...
</screen>
	The use of DNS in the hosts entry should be made only if DNS is used on site.
	</para>

	<para>
	The creation of the DMS requires the following steps:
	</para>

	<procedure>
		<step><para>
		Create or install an &smb.conf; file with the above configuration.
		</para></step>

		<step><para>
		Execute:
<screen>
&rootprompt; net rpc join -UAdministrator%password
Joined domain MEGANET2.
</screen>
	<indexterm><primary>join</primary></indexterm>
	The success of the join can be confirmed with the following command:
<screen>
&rootprompt; net rpc testjoin
Join to 'MIDEARTH' is OK
</screen>
		A failed join would report an error message like the following:
		<indexterm><primary>failed join</primary></indexterm>
<screen>
&rootprompt; net rpc testjoin
[2004/11/05 16:34:12, 0] utils/net_rpc_join.c:net_rpc_join_ok(66)
Join to domain 'MEGANET2' is not valid
</screen>
		</para></step>

		<step><para>
		<indexterm><primary>nmbd</primary></indexterm>
		<indexterm><primary>winbind</primary></indexterm>
		<indexterm><primary>smbd</primary></indexterm>
		Start the <command>nmbd, winbind,</command> and <command>smbd</command> daemons in the order shown.
		</para></step>
	</procedure>

	</sect3>

	<sect3>
	<title>ADS Domains</title>

	<para>
	<indexterm><primary>domain join</primary></indexterm>
	<indexterm><primary>ADS domain</primary></indexterm>
	The procedure for joining an ADS domain is similar to the NT4 domain join, except the &smb.conf; file
	will have the contents shown in <link linkend="idmapadsdms">ADS Domain Member Server smb.conf</link>
	</para>

<example id="idmapadsdms">
<title>ADS Domain Member Server smb.conf</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">BUTTERNET</smbconfoption>
<smbconfoption name="netbios name">GARGOYLE</smbconfoption>
<smbconfoption name="realm">BUTTERNET.BIZ</smbconfoption>
<smbconfoption name="security">ADS</smbconfoption>
<smbconfoption name="template shell">/bin/bash</smbconfoption>
<smbconfoption name="idmap uid">500-10000000</smbconfoption>
<smbconfoption name="idmap gid">500-10000000</smbconfoption>
<smbconfoption name="winbind use default domain">Yes</smbconfoption>
<smbconfoption name="winbind nested groups">Yes</smbconfoption>
<smbconfoption name="printer admin">"BUTTERNET\Domain Admins"</smbconfoption>
</smbconfblock>
</example>

	<para>
	<indexterm><primary>KRB</primary></indexterm>
	<indexterm><primary>kerberos</primary></indexterm>
	<indexterm><primary>/etc/krb5.conf</primary></indexterm>
	<indexterm><primary>MIT</primary></indexterm>
	<indexterm><primary>MIT kerberos</primary></indexterm>
	<indexterm><primary>Heimdal</primary></indexterm>
	<indexterm><primary>Heimdal kerberos</primary></indexterm>
	ADS DMS operation requires use of kerberos (KRB). For this to work, the <filename>krb5.conf</filename>
	must be configured. The exact requirements depends on which version of MIT or Heimdal Kerberos is being
	used. It is sound advice to use only the latest version, which at this time are MIT Kerberos version
	1.3.5 and Heimdal 0.61.
	</para>

	<para>
	The creation of the DMS requires the following steps:
	</para>

	<procedure>
		<step><para>
		Create or install an &smb.conf; file with the above configuration.
		</para></step>

		<step><para>
		Edit the <filename>/etc/nsswitch.conf</filename> file as shown above.
		</para></step>

		<step><para>
		Execute:
		<indexterm><primary>net</primary><secondary>ads</secondary><tertiary>join</tertiary></indexterm>
<screen>
&rootprompt; net ads join -UAdministrator%password
Joined domain BUTTERNET.
</screen>
	The success or failure of the join can be confirmed with the following command:
<screen>
&rootprompt; net ads testjoin
Using short domain name -- BUTTERNET
Joined 'GARGOYLE' to realm 'BUTTERNET.BIZ'
</screen>
	</para>

	<para>
	An invalid or failed join can be detected by executing:
<screen>
&rootprompt; net ads testjoin
GARGOYLE$@'s password:
[2004/11/05 16:53:03, 0] utils/net_ads.c:ads_startup(186)
  ads_connect: No results returned
Join to domain is not valid
</screen>
		<indexterm><primary>error message</primary></indexterm>
		<indexterm><primary>failure</primary></indexterm>
		<indexterm><primary>log level</primary></indexterm>
		<indexterm><primary>identify</primary></indexterm>
		The specific error message may differ from the above because it depends on the type of failure that
		may have occurred. Increase the <parameter>log level</parameter> to 10, repeat the test,
		and then examine the log files produced to identify the nature of the failure.
		</para></step>

		<step><para>
		Start the <command>nmbd</command>, <command>winbind</command>, and <command>smbd</command> daemons in the order shown.
		</para></step>

	</procedure>

	</sect3>
	</sect2>

	<sect2>
	<title>IDMAP_RID with Winbind</title>

	<para>
	<indexterm><primary>idmap_rid</primary></indexterm>
	<indexterm><primary>SID</primary></indexterm>
	<indexterm><primary>RID</primary></indexterm>
	<indexterm><primary>IDMAP</primary></indexterm>
	The <command>idmap_rid</command> facility is a new tool that, unlike native winbind, creates a
	predictable mapping of MS Windows SIDs to UNIX UIDs and GIDs. The key benefit of this method
	of implementing the Samba IDMAP facility is that it eliminates the need to store the IDMAP data
	in a central place. The downside is that it can be used only within a single ADS domain and
	is not compatible with trusted domain implementations.
	</para>

	<para>
	<indexterm><primary>SID</primary></indexterm>
	<indexterm><primary>allow trusted domains</primary></indexterm>
	<indexterm><primary>idmap uid</primary></indexterm>
	<indexterm><primary>idmap gid</primary></indexterm>
	This alternate method of SID to UID/GID  mapping can be achieved using the idmap_rid
        plug-in. This plug-in uses the RID of the user SID to derive the UID and GID by adding the
        RID to a base value specified. This utility requires that the parameter
        <quote>allow trusted domains = No</quote> be specified, as it is not compatible
        with multiple domain environments. The <parameter>idmap uid</parameter> and 
	<parameter>idmap gid</parameter> ranges must be specified.
	</para>

	<para>
	<indexterm><primary>idmap_rid</primary></indexterm>
	<indexterm><primary>realm</primary></indexterm>
	The idmap_rid facility can be used both for NT4/Samba-style domains and Active Directory.
	To use this with an NT4 domain, do not include the <parameter>realm</parameter> parameter; additionally, the
	method used to join the domain uses the <constant>net rpc join</constant> process.
	</para>

	<para>
	An example &smb.conf; file for and ADS domain environment is shown in <link linkend="idmapadsridDMS">ADS
	Domain Member smb.conf using idmap_rid</link>.
	</para>

<example id="idmapadsridDMS">
<title>ADS Domain Member smb.conf using idmap_rid</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">KPAK</smbconfoption>
<smbconfoption name="netbios name">BIGJOE</smbconfoption>
<smbconfoption name="realm">CORP.KPAK.COM</smbconfoption>
<smbconfoption name="server string">Office Server</smbconfoption>
<smbconfoption name="security">ADS</smbconfoption>
<smbconfoption name="allow trusted domains">No</smbconfoption>
<smbconfoption name="idmap backend">idmap_rid:KPAK=500-100000000</smbconfoption>
<smbconfoption name="idmap uid">500-100000000</smbconfoption>
<smbconfoption name="idmap gid">500-100000000</smbconfoption>
<smbconfoption name="template shell">/bin/bash</smbconfoption>
<smbconfoption name="winbind use default domain">Yes</smbconfoption>
<smbconfoption name="winbind enum users">No</smbconfoption>
<smbconfoption name="winbind enum groups">No</smbconfoption>
<smbconfoption name="winbind nested groups">Yes</smbconfoption>
<smbconfoption name="printer admin">"Domain Admins"</smbconfoption>
</smbconfblock>
</example>

	<para>
	<indexterm><primary>large domain</primary></indexterm>
	<indexterm><primary>Active Directory</primary></indexterm>
	<indexterm><primary>response</primary></indexterm>
	<indexterm><primary>getent</primary></indexterm>
	In a large domain with many users it is imperative to disable enumeration of users and groups.
	For example, at a site that has 22,000 users in Active Directory the winbind-based user and
	group resolution is unavailable for nearly 12 minutes following first startup of 
	<command>winbind</command>. Disabling enumeration resulted in instantaneous response.
	The disabling of user and group enumeration means that it will not be possible to list users
	or groups using the <command>getent passwd</command> and <command>getent group</command>
	commands. It will be possible to perform the lookup for individual users, as shown in the following procedure.
	</para>

	<para>
	<indexterm><primary>NSS</primary></indexterm>
	<indexterm><primary>/etc/nsswitch.conf</primary></indexterm>
	The use of this tool requires configuration of NSS as per the native use of winbind. Edit the
	<filename>/etc/nsswitch.conf</filename> so it has the following parameters:
<screen>
...
passwd: files winbind
shadow: files winbind
group:  files winbind
...
hosts:  files wins
...
</screen>
	</para>

	<para>
	The following procedure can use the idmap_rid facility:
	</para>

	<procedure>
		<step><para>
		Create or install an &smb.conf; file with the above configuration.
		</para></step>

		<step><para>
		Edit the <filename>/etc/nsswitch.conf</filename> file as shown above.
		</para></step>

		<step><para>
		Execute:
<screen>
&rootprompt; net ads join -UAdministrator%password
Using short domain name -- KPAK
Joined 'BIGJOE' to realm 'CORP.KPAK.COM'
</screen>
		</para>

		<para>
		<indexterm><primary>failed join</primary></indexterm>
		An invalid or failed join can be detected by executing:
<screen>
&rootprompt; net ads testjoin
BIGJOE$@'s password:
[2004/11/05 16:53:03, 0] utils/net_ads.c:ads_startup(186)
  ads_connect: No results returned
Join to domain is not valid
</screen>
		The specific error message may differ from the above because it depends on the type of failure that
		may have occurred. Increase the <parameter>log level</parameter> to 10, repeat the test,
		and then examine the log files produced to identify the nature of the failure.
		</para></step>

		<step><para>
		Start the <command>nmbd</command>, <command>winbind</command>, and <command>smbd</command> daemons in the order shown.
		</para></step>

		<step><para>
		Validate the operation of this configuration by executing:
		<indexterm><primary></primary></indexterm>
<screen>
&rootprompt; getent passwd administrator
administrator:x:1000:1013:Administrator:/home/BE/administrator:/bin/bash
</screen>
		</para></step>
	</procedure>

	</sect2>

	<sect2>
	<title>IDMAP Storage in LDAP Using Winbind</title>

	<para>
	<indexterm><primary>ADAM</primary></indexterm>
	<indexterm><primary>ADS</primary></indexterm>
	The storage of IDMAP information in LDAP can be used with both NT4/Samba-3-style domains and
	ADS domains. OpenLDAP is a commonly used LDAP server for this purpose, although any
	standards-complying LDAP server can be used. It is therefore possible to deploy this IDMAP
	configuration using the Sun iPlanet LDAP server, Novell eDirectory, Microsoft ADS plus ADAM,
	and so on.
	</para>

	<para>
	An example is for an ADS domain is shown in <link linkend="idmapldapDMS">ADS Domain Member Server using
	LDAP</link>.
	</para>

<example id="idmapldapDMS">
<title>ADS Domain Member Server using LDAP</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">SNOWSHOW</smbconfoption>
<smbconfoption name="netbios name">GOODELF</smbconfoption>
<smbconfoption name="realm">SNOWSHOW.COM</smbconfoption>
<smbconfoption name="server string">Samba Server</smbconfoption>
<smbconfoption name="security">ADS</smbconfoption>
<smbconfoption name="log level">1 ads:10 auth:10 sam:10 rpc:10</smbconfoption>
<smbconfoption name="ldap admin dn">cn=Manager,dc=SNOWSHOW,dc=COM</smbconfoption>
<smbconfoption name="ldap idmap suffix">ou=Idmap</smbconfoption>
<smbconfoption name="ldap suffix">dc=SNOWSHOW,dc=COM</smbconfoption>
<smbconfoption name="idmap backend">ldap:ldap://ldap.snowshow.com</smbconfoption>
<smbconfoption name="idmap uid">150000-550000</smbconfoption>
<smbconfoption name="idmap gid">150000-550000</smbconfoption>
<smbconfoption name="template shell">/bin/bash</smbconfoption>
<smbconfoption name="winbind use default domain">Yes</smbconfoption>
</smbconfblock>
</example>

	<para>
	<indexterm><primary>realm</primary></indexterm>
	In the case of an NT4 or Samba-3-style domain the <parameter>realm</parameter> is not used, and the
	command used to join the domain is <command>net rpc join</command>. The above example also demonstrates
	advanced error-reporting techniques that are documented in <link linkend="dbglvl">Reporting Bugs</link>.
	</para>

	<para>
	<indexterm><primary>MIT kerberos</primary></indexterm>
	<indexterm><primary>Heimdal kerberos</primary></indexterm>
	<indexterm><primary>/etc/krb5.conf</primary></indexterm>
	Where MIT kerberos is installed (version 1.3.4 or later), edit the <filename>/etc/krb5.conf</filename> 
	file so it has the following contents:
<screen>
[logging]
 default = FILE:/var/log/krb5libs.log
 kdc = FILE:/var/log/krb5kdc.log
 admin_server = FILE:/var/log/kadmind.log

[libdefaults]
 default_realm = SNOWSHOW.COM
 dns_lookup_realm = false
 dns_lookup_kdc = true

[appdefaults]
 pam = {
   debug = false
   ticket_lifetime = 36000
   renew_lifetime = 36000
   forwardable = true
   krb4_convert = false
 }
</screen>
	</para>

	<para>
	Where Heimdal kerberos is installed, edit the <filename>/etc/krb5.conf</filename>
        file so it is either empty (i.e., no contents) or it has the following contents:
<screen>
[libdefaults]
        default_realm = SNOWSHOW.COM
        clockskew = 300

[realms]
        SNOWSHOW.COM = {
                kdc = ADSDC.SHOWSHOW.COM
        }
        
[domain_realm]
        .snowshow.com = SNOWSHOW.COM
</screen>
	</para>

	<note><para>
	Samba cannot use the Heimdal libraries if there is no <filename>/etc/krb5.conf</filename> file.
	So long as there is an empty file, the Heimdal kerberos libraries will be usable. There is no
	need to specify any settings because Samba, using the Heimdal libraries, can figure this out automatically.
	</para></note>

	<para>
	Edit the NSS control file <filename>/etc/nsswitch.conf</filename> so it has the following entries:
<screen>
...
passwd: files ldap
shadow: files ldap
group:  files ldap
...
hosts:  files wins
...
</screen>
	</para>

	<para>
	<indexterm><primary>PADL</primary></indexterm>
	<indexterm><primary>/etc/ldap.conf</primary></indexterm>
	You will need the <ulink url="http://www.padl.com">PADL</ulink> <command>nss_ldap</command> 
	tool set for this solution. Configure the <filename>/etc/ldap.conf</filename> file so it has 
	the information needed. The following is an example of a working file:
<screen>
host    192.168.2.1
base    dc=snowshow,dc=com
binddn  cn=Manager,dc=snowshow,dc=com
bindpw  not24get

pam_password exop

nss_base_passwd ou=People,dc=snowshow,dc=com?one
nss_base_shadow ou=People,dc=snowshow,dc=com?one
nss_base_group  ou=Groups,dc=snowshow,dc=com?one
ssl     no
</screen>
	</para>

	<para>
	The following procedure may be followed to effect a working configuration:
	</para>

	<procedure>
		<step><para>
		Configure the &smb.conf; file as shown above.
		</para></step>

		<step><para>
		Create the <filename>/etc/krb5.conf</filename> file as shown above.
		</para></step>

		<step><para>
		Configure the <filename>/etc/nsswitch.conf</filename> file as shown above.
		</para></step>

		<step><para>
		Download, build, and install the PADL nss_ldap tool set. Configure the 
		<filename>/etc/ldap.conf</filename> file as shown above.
		</para></step>

		<step><para>
		Configure an LDAP server and initialize the directory with the top-level entries needed by IDMAP,
		shown in the following LDIF file:
<screen>
dn: dc=snowshow,dc=com
objectClass: dcObject
objectClass: organization
dc: snowshow
o: The Greatest Snow Show in Singapore.
description: Posix and Samba LDAP Identity Database

dn: cn=Manager,dc=snowshow,dc=com
objectClass: organizationalRole
cn: Manager
description: Directory Manager

dn: ou=Idmap,dc=snowshow,dc=com
objectClass: organizationalUnit
ou: idmap
</screen>
		</para></step>

		<step><para>
		Execute the command to join the Samba DMS to the ADS domain as shown here:
<screen>
&rootprompt; net ads testjoin
Using short domain name -- SNOWSHOW
Joined 'GOODELF' to realm 'SNOWSHOW.COM'
</screen>
		</para></step>

		<step><para>
		Store the LDAP server access password in the Samba <filename>secrets.tdb</filename> file as follows:
<screen>
&rootprompt; smbpasswd -w not24get
</screen>
		</para></step>

		<step><para>
		Start the <command>nmbd</command>, <command>winbind</command>, and <command>smbd</command> daemons in the order shown.
		</para></step>
	</procedure>

	<para>
	<indexterm><primary>diagnostic</primary></indexterm>
	Follow the diagnositic procedures shown earlier in this chapter to identify success or failure of the join.
	In many cases a failure is indicated by a silent return to the command prompt with no indication of the
	reason for failure.
	</para>

	</sect2>

	<sect2>
	<title>IDMAP and NSS Using LDAP from ADS with RFC2307bis Schema Extension</title>

	<para>
	<indexterm><primary>rfc2307bis</primary></indexterm>
	<indexterm><primary>schema</primary></indexterm>
	The use of this method is messy. The information provided in the following is for guidance only
	and is very definitely not complete. This method does work; it is used in a number of large sites
	and has an acceptable level of performance.
	</para>

	<para>
	An example &smb.conf; file is shown in <link linkend="idmaprfc2307">ADS Domain Member Server using
RFC2307bis Schema Extension Date via NSS</link>.
	</para>

<example id="idmaprfc2307">
<title>ADS Domain Member Server using RFC2307bis Schema Extension Date via NSS</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">BOBBY</smbconfoption>
<smbconfoption name="realm">BOBBY.COM</smbconfoption>
<smbconfoption name="security">ADS</smbconfoption>
<smbconfoption name="idmap uid">150000-550000</smbconfoption>
<smbconfoption name="idmap gid">150000-550000</smbconfoption>
<smbconfoption name="template shell">/bin/bash</smbconfoption>
<smbconfoption name="winbind cache time">5</smbconfoption>
<smbconfoption name="winbind use default domain">Yes</smbconfoption>
<smbconfoption name="winbind trusted domains only">Yes</smbconfoption>
<smbconfoption name="winbind nested groups">Yes</smbconfoption>
</smbconfblock>
</example>

	<para>
	<indexterm><primary>nss_ldap</primary></indexterm>
	The DMS must be joined to the domain using the usual procedure. Additionally, it is necessary
	to build and install the PADL nss_ldap tool set. Be sure to build this tool set with the
	following:
<screen>
./configure --enable-rfc2307bis --enable-schema-mapping
make install
</screen> 
	</para>

	<para>
	<indexterm><primary>/etc/nsswitch.conf</primary></indexterm>
	The following <filename>/etc/nsswitch.conf</filename> file contents are required:
<screen>
...
passwd: files ldap
shadow: files ldap
group:  files ldap
...
hosts:  files wins
...
</screen>
	</para>

	<para>
	<indexterm><primary>/etc/ldap.conf</primary></indexterm>
	<indexterm><primary>nss_ldap</primary></indexterm>
	The <filename>/etc/ldap.conf</filename> file must be configured also. Refer to the PADL documentation
	and source code for nss_ldap to specific instructions.
	</para>

	<para>
	The next step involves preparation of the ADS schema. This is briefly discussed in the remaining
	part of this chapter.
	</para>

		<sect3>
		<title>IDMAP, Active Directory, and MS Services for UNIX 3.5</title>

		<para>
		<indexterm><primary>SFU</primary></indexterm>
		The Microsoft Windows Service for UNIX (SFU) version 3.5 is available for free 
		<ulink url="http://www.microsoft.com/windows/sfu/">download</ulink>
		from the Microsoft Web site. You will need to download this tool and install it following
		Microsoft instructions.
		</para>

		</sect3>

		<sect3>
		<title>IDMAP, Active Directory and AD4UNIX</title>

		<para>
		Instructions for obtaining and installing the AD4UNIX tool set can be found from the
		<ulink url="http://www.geekcomix.com/cgi-bin/classnotes/wiki.pl?LDAP01/An_Alternative_Approach">
		Geekcomix</ulink> Web site.
		</para>

		</sect3>

	</sect2>

</sect1>

</chapter>
