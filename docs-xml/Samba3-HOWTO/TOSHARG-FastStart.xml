<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<chapter id="FastStart">
<chapterinfo>
	&author.jht;
</chapterinfo>

<title>手軽な始め方: 短気な方への手引き</title>

<para>
Samba HOWTO文書中に含めるものについての最初に提案を受けた時、
だれかが問い合わせのためのサンプル設定をたくさん書いた&smbmdash;。これは、
動いているシステムからたくさんのエッセンスを提示することに由来するたくさんの
価値を失わないで行う事が甚だしく難しい。それがドキュメントに抜けているもので
ある。それをカバーする章の内容の中に設定の可能性の広範囲な説明がある。この
章は、要求されたことに対する処方であると思いたい。
</para>

<para>
この章中の情報は、ほとんど完成したこの本のオリジナルバージョンの後に書かれた
<quote>Samba-3 by Example</quote>という本と比較してとてもまばらである。
<quote>Samba-3 by Example</quote>は最初の版の最終稿をレビューした結果を
フィードバックしたものである。読者フィードバックが、オリジナルのレビュアによ
り反映が行われることを見ることは興味深かった。どの場合にも、経験ある
ネットワーク管理者がそこから得るものと同様、何が新しいかをより理解する
ための基礎的な調査に1ヶ月半かかった。<quote>Samba-3 by Example</quote>は
その調査の結果である。この本のいくつかのページで提供されているものは、より
包括的に<quote>Samba-3 by Example</quote>の第二版でカバーしている。
両方のほんの第二版は同じ時期にリリースされた。
</para>

<para>
まとめると、<quote>公式のSamba-3 HOWTO &amp; リファレンスガイド</quote>は
自動車修理工の修理ガイドと同等のものとして意図されている。
<quote>Samba-3 by Example</quote>は、どのように車を運転するかを説明する
ドライバ向けのガイドと同等である。もしもネットワークの設定例を完全にしたい
のであれば、
<ulink url="http://www.samba.org/samba/docs/Samba3-ByExample.pdf">Samba-3 by
Example</ulink>を参照すること。
</para>

<sect1>
<title>機能と利点</title>

<para>
基本的な動作するシステムを作成するために、Sambaは最小限の設定しか必要としない。
この節では、簡単なものから複雑なものへ、おのおのを動かすために必要とされる
設定ファイルの変更とすべてのステップを順番に提供する。徹底的に設定された
システムは、追加の高機能な機能を使うだろう。それらの追加機能はこの文書の
残りの部分で触れられている。
</para>

<para>
ここで使っている例は、数多くの人が設定の例のために要求したものに依っている。
すべての識別子は問題がないようにしてあり、非現実的な存在しないサイトへ
何らかの形で似ていることは計画的に行われている。
</para>

</sect1>

<sect1>
<title>例題サイトの説明</title>

<para>
最初の設定例中では、例外的な、簡単なシステム要求の場合を考えてみる。
ほとんど取り組みを必要としないものを複雑にしようとする真の誘惑がある。
</para>

<para>
<link linkend="anon-ro"></link> はCD-ROMイメージを提供するのに十分かも
しれないサーバのタイプか、ネットワーククライアントが使う用途向けの参考
文書を提供する。この設定は
<link linkend="StandAloneServer"></link>、<link linkend="RefDocServer"></link>
でも取り上げている。この設定の目的は、ゲストも含めて誰でもリードオンリで
アクセスできる共有ボリュームを提供することである。
</para>

<para>
2番目の例は、コンピュータ上にインストールされた正しいプリンタドライバを
持つのと同じくらい長く、誰でも印刷できるプリントサーバのための最低限の
設定である。これは
<link linkend="StandAloneServer"></link>, <link linkend="SimplePrintServer"></link>
で説明されているものと同じである。
</para>

<para>
次の例は、システム上にアカウントを持つユーザのみがアクセス可能な、安全な
オフィス用ファイル/プリントサーバである。このサーバはワークグループの
ファイル/プリントサーバととてもよく似ているが、匿名でアクセスするマシンより
はより安全である。このタイプのシステムは、一般的に小さなオフィスの用途に
適合している。サー派はネットワークログオン機能、ドメイン制御を提供しない。
その代わりにネットワーク経由のストレージデバイス(NAS)とプリントサーバである。
</para>

<para>
最後の例は存在するMicrosoft Windowsネットワークを統合するか、それを完全に
置き換えるより複雑なシステムである。これらはSambaドメイン制御(PDC/BDC)と
同様なドメインメンバサーバとリモートの場所中にあるブランチオフィスでの、
大きな分散ネットワーク中で詳細が説明されるものをカバーする。
</para>

</sect1>

<sect1>
<title>動く例</title>

<para>
設定の例はSambaが動くために必要なすべてをカバーするためにデザインされている。
それはこのテキストの範囲を明らかに超えている、基本的なOSプラットフォームの
設定をカバーしていない。
</para>

<para>
また、OSベンダによって提供されているパッケージにか、他の手段で
Sambaが正しくインストールされていることも仮定している。
</para>

	<sect2>
	<title>スタンドアロンサーバ</title>

	<para>
	<indexterm><primary>サーバタイプ</primary><secondary>スタンドアロン</secondary></indexterm>
	スタンドアロンサーバであるということは、それがドメインコントローラでないこと、
	ドメイン制御下に参加していないと言う事実以上のことを何も暗示しない。これは
	単純で、ワークグループ風のサーバであるか、ドメインセキュリティ管理下のメンバ
	であることができる。
	</para>

	<para>
	  例題が作成されている間、真のビジネスオフィスが、そのオフィスの大きさが
	  増えたり必要に応じて変わるようなことが起こると思うかもしれないのと同じ
          ように、システムガソのすばらしい能力に向かって進歩するすべての試みが行
	  われた。
	</para>

		<sect3 id="anon-ro">
		<title>匿名リードオンリ文書サーバ</title>

		<para>
		<indexterm><primary>リードオンリ</primary><secondary>サーバ</secondary></indexterm>
		このタイプのサーバの目的は、共有リソース上にある任意の文書やファイルを
		任意のユーザに有効にさせることである。共有リソースはCD-ROMでもファイル
		領域でも可能である。
		</para>

		<itemizedlist>
			<listitem><para>
			ファイルシステムの共有位置は<filename>/export</filename>である。
			</para></listitem>

			<listitem><para>
			すべてのファイルはJack Baumbachと呼ばれるユーザが所有している。
			Jackのログイン名は<emphasis>jackb</emphasis>である。そのパス
			ワードは<emphasis>m0r3pa1n</emphasis>である。 &smbmdash;
			もちろんこれは例として使っているものである。すべての、この
			文書の読者がこのことを知っているため、実環境でこれを使っては
			いけない。
			</para></listitem>
		</itemizedlist>

		<procedure>
		<title>インストール手順: リードオンリサーバ</title>
			<step><para>
			ユーザをシステムに登録する(ユーザのホームディレクトリも作る):
<screen>
&rootprompt;<userinput>useradd -c "Jack Baumbach" -m -g users -p m0r3pa1n jackb</userinput>
</screen>
			</para></step>

			<step><para>
			ディレクトリを作りパーミッションと所有者を設定する:
<screen>
&rootprompt;<userinput>mkdir /export</userinput>
&rootprompt;<userinput>chmod u+rwx,g+rx,o+rx /export</userinput>
&rootprompt;<userinput>chown jackb.users /export</userinput>
</screen>
			</para></step>

			<step><para>
			<filename>/export</filename>ディレクトリに共有したいファイルをコピーする。
			</para></step>

			<step><para>
			
			<link linkend="anon-example">匿名リードオンリサーバ設定</link>で
			表示されているSamba設定ファイル(<filename>/etc/samba/smb.conf</filename>)を
			インストールする。
			</para></step>

<example id="anon-example">
<title>匿名リードオンリサーバ設定</title>
<smbconfblock>
<smbconfcomment>グローバルパラメータ</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">MIDEARTH</smbconfoption>
<smbconfoption name="netbios name">HOBBIT</smbconfoption>
<smbconfoption name="security">share</smbconfoption>

<smbconfsection name="[data]"/>
<smbconfoption name="comment">Data</smbconfoption>
<smbconfoption name="path">/export</smbconfoption>
<smbconfoption name="read only">Yes</smbconfoption>
<smbconfoption name="guest ok">Yes</smbconfoption>
</smbconfblock>
</example>

			<step><para>
			以下のコマンドを実行して設定ファイルをテストする:
<screen>
&rootprompt;<userinput>testparm</userinput>
</screen>
                        代替として、<filename>smb.conf.master</filename>と呼ばれるマスタ
                        設定ファイルから操作している場合、以下のコマンドシーケンスの方が
                        より適切である:
<screen>
&rootprompt; cd /etc/samba
&rootprompt; testparm -s smb.conf.master > smb.conf
&rootprompt; testparm
</screen>
                        何らかのエラーメッセージが出力されるかもしれないことに注意。
                        エラー出力がない場合にのみ先に進むこと。上記の設定ファイルで
                        生成される典型的な出力の例は以下の通り:
<screen>
Load smb config files from /etc/samba/smb.conf
Processing section "[data]"
Loaded services file OK.
Server role: ROLE_STANDALONE
Press enter to see a dump of your service definitions
<userinput>[Press enter]</userinput>

# Global parameters
[global]
	workgroup = MIDEARTH
	netbios name = HOBBIT
	security = share

[data]
	comment = Data
	path = /export
	read only = Yes
	guest only = Yes
</screen>
			</para></step>

			<step><para>
                        OSプラットフォームに適した方法でSambaを起動する。その方法は
			プラットフォーム依存である。Sambaを起動することに関するそれ
			以上の情報は、<link linkend="startingSamba">Starting Samba</link>
			を参照のこと。
			</para></step>

			<step><para>
			Microsoft Windowsクライアントをワークグループ
			<emphasis>MIDEARTH</emphasis>に設定し、コンピュータ名を
			ROBBINSに設定し再起動し、数分待ち、Windowsエクスプローラ
			を開いてマイネットワークをクリックする。そこにマシンHOBBIT
			がある。このマシンアイコンをクリックすると、
			<emphasis>data</emphasis>共有が現れる。共有をクリック後、
			<filename>/export</filename>ディレクトリ中にある、以前に
			そこにおいたファイルが現れる。
			</para></step>
		</procedure>

		<para>
		上記の情報(#グローバルパラメータ以下)は
		<filename>/etc/samba/smb.conf</filename>ファイルの完全な内容を提供
		する。
		</para>

		</sect3>

		<sect3>
		<title>匿名の読み書き可能な文書サーバ</title>

		<para>
		<indexterm><primary>匿名</primary><secondary>読み書きサーバ</secondary></indexterm>
                以前の例からこの設定を発展系と見なすべきである。違いは、共有アクセスが
		jackbというユーザIDに、プライマリグループがjackbに強制的に設定されると
		いうことである。その他1つの改善点は、ユーザjackbを
		<filename>smbpasswd</filename>に追加することが出来るということである。
		これを行うのには以下を実行する:
<screen>
&rootprompt;<userinput>smbpasswd -a jackb</userinput>
New SMB password: <userinput>m0r3pa1n</userinput>
Retype new SMB password: <userinput>m0r3pa1n</userinput>
Added user jackb.
</screen>
		<filename>smbpasswd</filename>ファイルへのこのユーザの追加は、エクス
		プローラのプロパティにおいて所有者が<emphasis>User Unknown</emphasis>
		の代わりに<emphasis>jackb</emphasis>が表示されると言うことである。
		</para>

		<para>
		完全な変更後の&smb.conf;ファイルは<link linkend="anon-rw"/>である。
		</para>

<example id="anon-rw">
<title>変更後の匿名の読み書き可能な設定の smb.conf</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">MIDEARTH</smbconfoption>
<smbconfoption name="netbios name">HOBBIT</smbconfoption>
<smbconfoption name="security">SHARE</smbconfoption>

<smbconfsection name="[data]"/>
<smbconfoption name="comment">Data</smbconfoption>
<smbconfoption name="path">/export</smbconfoption>
<smbconfoption name="force user">jackb</smbconfoption>
<smbconfoption name="force group">users</smbconfoption>
<smbconfoption name="read only">No</smbconfoption>
<smbconfoption name="guest ok">Yes</smbconfoption>
</smbconfblock>
</example>

		</sect3>

		<sect3>
		<title>匿名プリントサーバ</title>

		<para>
		<indexterm><primary>匿名</primary><secondary>プリントサーバ</secondary></indexterm>
		匿名プリントサーバは2つの目的で提供される:
		</para>

		<itemizedlist>
			<listitem><para>
			1つの所から、すべてのプリンタに印刷を許可する。
			</para></listitem>

			<listitem><para>
			制限された数のプリンタに対するアクセスのため、たくさんの
			ユーザのためにネットワークのトラフィック輻輳を減らす。
			</para></listitem>
		</itemizedlist>

		<para>
		最も単純な匿名印刷サーバ中で、Windowsワークステーション上での正しい
		プリンタドライバのインストール要求は共通である。この場合、プリント
		サーバはスプーラに対して印刷ジョブを単に渡すだけに設定され、
		スプーラはプリンタに対して素通しになるように設定される。別の言い方
		をすると、プリントスプーラはプリンタに対して渡されたデータストリーム
		をフィルタリングもなんらかの処理もしない。
		</para>

		<para>
		この設定中で、プリンタの追加ウィザードを使うのは好ましくなく、
		また、自動ドライバダウンロードを行うのも望まない。そのため、
		以下の設定でそれを無効にする。
		<link linkend="anon-print"></link>は結果の &smb.conf;ファイルである。
		</para>

<example id="anon-print">
<title>匿名プリントサーバのsmb.conf</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">MIDEARTH</smbconfoption>
<smbconfoption name="netbios name">LUTHIEN</smbconfoption>
<smbconfoption name="security">share</smbconfoption>
<smbconfoption name="printcap name">cups</smbconfoption>
<smbconfoption name="disable spoolss">Yes</smbconfoption>
<smbconfoption name="show add printer wizard">No</smbconfoption>
<smbconfoption name="printing">cups</smbconfoption>

<smbconfsection name="[printers]"/>
<smbconfoption name="comment">All Printers</smbconfoption>
<smbconfoption name="path">/var/spool/samba</smbconfoption>
<smbconfoption name="guest ok">Yes</smbconfoption>
<smbconfoption name="printable">Yes</smbconfoption>
<smbconfoption name="use client driver">Yes</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>
</smbconfblock>
</example>

		<para>
		上記の設定は理想的なものではない。よりよい機能を使っておらず、
		故意にエレガントではない解決方法を提示している。しかし、これは
		基本であり、これで印刷は出来る。SambaはCUPSによって提供される
		直接印刷APIを使える。CUPSライブラリを、Sambaコンパイル時に指定
		してリンクした場合、既定値の印刷システムはCUPSになる。princap name
		がCUPSを指定した場合、Sambaはすべての印刷機能のためにCUPSに直接
		通信を行うため、CUPSライブラリAPIを使う。
		<parameter>printing</parameter>の値をSYSVかBSDに設定して外部印刷
		コマンドを強制的に使うことが可能で、パラメータ
		<parameter>printcap name</parameter>の値はCUPS以外の何かに設定
		しなければならない。この場合、Windowsクライアントに対して有効に
		させるためのプリンタの一覧が含まれている任意のファイルの名前を設定
		する。
		</para>

		<note><para>
		Windowsユーザはローカルプリンタのインストールが必要で、ドライバの
		インストール後に通常使うプリンタを切り替える。通常使うプリンタは
		そのマシン上のネットワークプリンタに設定できる。
		</para></note>

		<para>
		ディレクトリ<filename>/var/spool/samba</filename>が使えるように
		なっていることを確かめておくこと。以下の手順はこれを達成するため
		に行わなければならない:
		</para>

		<itemizedlist>
			<listitem><para>
			ディレクトリはスーパーユーザ(root)のユーザとグループに属さねば
                        ならない:
<screen>
&rootprompt;<userinput>chown root.root /var/spool/samba</userinput>
</screen>
			</para></listitem>

			<listitem><para>
			ディレクトリのパーミッションは以下のようにスティッキービット
			を設定して「その他」をRWに設定しなければならない:
<screen>
&rootprompt;<userinput>chmod a+twrx /var/spool/samba</userinput>
</screen>
                スティッキービット設定の目的は、一時印刷ファイルを所有していない
                ユーザが誤用で制御を得てしまう可能性を防止するためである。
			</para></listitem>
		</itemizedlist>


		<note><para>
		<indexterm><primary>MIME</primary><secondary>raw</secondary></indexterm>
		<indexterm><primary>素通し印刷</primary></indexterm>
		CUPSが有効になっているシステムで、中間のCUPSプリントフィルタ処理なしで、
		直接プリンタに生データを渡す機能がある。このモードの操作を使うことが
		要求される場合、生データを印刷するデバイスを設定することが必要である。
		また、<filename>/etc/mime.conv</filename>と
		<filename>/etc/mime.types</filename>ファイル中のraw mime ハンドラを
		有効にする必要もある。<link linkend="cups-raw"></link>を参照のこと。
		</para></note>

		</sect3>

		<sect3>

		<title>セキュアな読み書き可能ファイルと印刷サーバ</title>

		<para>
		続いて、簡単なシステムからやや複雑なサーバの例に説明を進めよう。
		</para>

		<para>
		新しいサーバは認証されたユーザのみ(すなわち、ローカルアカウントを持つ)が、
		ホームディレクトリと同様にファイルを保存できる共用データ領域を必要とする。
		また、誰でも使える1つのプリンタも提供する。
		</para>

		<para>
		この仮想の環境(このデータを入手するための盗聴は無いものとする)中で、
		使うのに難しくない、<emphasis>十分な安全性</emphasis>を持つ簡単な環境に
		サイトは依存する。
		</para>

		<para>
		サイトユーザは Jack Baumbach, Mary Orvilleと Amed Sehkahである。おのおのは
		パスワード(これ以降の例では表示しない)を持つ。Maryはプリンタ管理者で、
		共通の共有中のファイルの所有者である。
		</para>

		<para>
		この設定は既定値である<emphasis>ユーザレベルのセキュリティ</emphasis>を
		ベースとしていて、<filename>/etc/samba/smbpasswd</filename>中に
		Windows互換の暗号化パスワードを格納している。この設定にするための既定値
		の&smb.conf;エントリは
		<smbconfoption name="passdb backend">smbpasswd, guest</smbconfoption>である。
		これが既定値になっているので、設定ファイルにこれを記述する必要はない。
		guest バックエンドはSamba設定ファイル中で指定されるか否かに関わらす、
		有効なpassdb backendに追加されることに注意。
		</para>


		<procedure>
		<title>セキュアなオフィスサーバのインストール</title>
			<step><para>
		<indexterm><primary>オフィスサーバ</primary></indexterm>
			すべてのユーザをOSに追加する:
<screen>
&rootprompt;<userinput>useradd -c "Jack Baumbach" -m -g users -p m0r3pa1n jackb</userinput>
&rootprompt;<userinput>useradd -c "Mary Orville" -m -g users -p secret maryo</userinput>
&rootprompt;<userinput>useradd -c "Amed Sehkah" -m -g users -p secret ameds</userinput>
</screen>
			</para></step>

			<step><para>
			<link linkend="OfficeServer"/>中で示されているようにSambaの &smb.conf;を設定する。
			</para></step>

<example id="OfficeServer">
<title>セキュアなオフィスサーバのsmb.conf</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">MIDEARTH</smbconfoption>
<smbconfoption name="netbios name">OLORIN</smbconfoption>
<smbconfoption name="printcap name">cups</smbconfoption>
<smbconfoption name="disable spoolss">Yes</smbconfoption>
<smbconfoption name="show add printer wizard">No</smbconfoption>
<smbconfoption name="printing">cups</smbconfoption>

<smbconfsection name="[homes]"/>
<smbconfoption name="comment">Home Directories</smbconfoption>
<smbconfoption name="valid users">%S</smbconfoption>
<smbconfoption name="read only">No</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>

<smbconfsection name="[public]"/>
<smbconfoption name="comment">Data</smbconfoption>
<smbconfoption name="path">/export</smbconfoption>
<smbconfoption name="force user">maryo</smbconfoption>
<smbconfoption name="force group">users</smbconfoption>
<smbconfoption name="read only">No</smbconfoption>

<smbconfsection name="[printers]"/>
<smbconfoption name="comment">All Printers</smbconfoption>
<smbconfoption name="path">/var/spool/samba</smbconfoption>
<smbconfoption name="printer admin">root, maryo</smbconfoption>
<smbconfoption name="create mask">0600</smbconfoption>
<smbconfoption name="guest ok">Yes</smbconfoption>
<smbconfoption name="printable">Yes</smbconfoption>
<smbconfoption name="use client driver">Yes</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>
</smbconfblock>
</example>

			<step><para>
			Microsoft Windowsパスワードデータベースに新規ユーザを追加する:
<screen>
&rootprompt;<userinput>smbpasswd -a root</userinput>
New SMB password: <userinput>bigsecret</userinput>
Reenter smb password: <userinput>bigsecret</userinput>
Added user root.

&rootprompt;<userinput>smbpasswd -a jackb</userinput>
New SMB password: <userinput>m0r3pa1n</userinput>
Retype new SMB password: <userinput>m0r3pa1n</userinput>
Added user jackb.

&rootprompt;<userinput>smbpasswd -a maryo</userinput>
New SMB password: <userinput>secret</userinput>
Reenter smb password: <userinput>secret</userinput>
Added user maryo.

&rootprompt;<userinput>smbpasswd -a ameds</userinput>
New SMB password: <userinput>mysecret</userinput>
Reenter smb password: <userinput>mysecret</userinput>
Added user ameds.
</screen>
			</para></step>

			<step><para>
			Install printer using the CUPS Web interface. Make certain that all
			printers that will be shared with Microsoft Windows clients are installed
			as raw printing devices.
			</para></step>

			<step><para>
			Start Samba using the operating system administrative interface.
			Alternately, this can be done manually by executing:
			<indexterm><primary>smbd</primary></indexterm>
			<indexterm><primary>nmbd</primary></indexterm>
			<indexterm><primary>starting samba</primary><secondary>smbd</secondary></indexterm>
			<indexterm><primary>starting samba</primary><secondary>nmbd</secondary></indexterm>
<screen>
&rootprompt;<userinput> nmbd; smbd;</userinput>
</screen>
			Both applications automatically execute as daemons. Those who are paranoid about
			maintaining control can add the <constant>-D</constant> flag to coerce them to start
			up in daemon mode.
			</para></step>

			<step><para>
			Configure the <filename>/export</filename> directory:
<screen>
&rootprompt;<userinput>mkdir /export</userinput>
&rootprompt;<userinput>chown maryo.users /export</userinput>
&rootprompt;<userinput>chmod u=rwx,g=rwx,o-rwx /export</userinput>
</screen>
			</para></step>

			<step><para>
			Check that Samba is running correctly:
<screen>
&rootprompt;<userinput>smbclient -L localhost -U%</userinput>
Domain=[MIDEARTH] OS=[UNIX] Server=[Samba-3.0.20]

Sharename      Type      Comment
---------      ----      -------
public         Disk      Data
IPC$           IPC       IPC Service (Samba-3.0.20)
ADMIN$         IPC       IPC Service (Samba-3.0.20)
hplj4          Printer   hplj4

Server               Comment
---------            -------
OLORIN               Samba-3.0.20

Workgroup            Master
---------            -------
MIDEARTH             OLORIN
</screen>
			The following error message indicates that Samba was not running:
<screen>
&rootprompt; smbclient -L olorin -U%
Error connecting to 192.168.1.40 (Connection refused)
Connection to olorin failed
</screen>
			</para></step>

			<step><para>
			Connect to OLORIN as maryo:
<screen>
&rootprompt;<userinput>smbclient //olorin/maryo -Umaryo%secret</userinput>
OS=[UNIX] Server=[Samba-3.0.20]
smb: \> <userinput>dir</userinput>
.                              D        0  Sat Jun 21 10:58:16 2003
..                             D        0  Sat Jun 21 10:54:32 2003
Documents                      D        0  Fri Apr 25 13:23:58 2003
DOCWORK                        D        0  Sat Jun 14 15:40:34 2003
OpenOffice.org                 D        0  Fri Apr 25 13:55:16 2003
.bashrc                        H     1286  Fri Apr 25 13:23:58 2003
.netscape6                    DH        0  Fri Apr 25 13:55:13 2003
.mozilla                      DH        0  Wed Mar  5 11:50:50 2003
.kermrc                        H      164  Fri Apr 25 13:23:58 2003
.acrobat                      DH        0  Fri Apr 25 15:41:02 2003

		55817 blocks of size 524288. 34725 blocks available
smb: \> <userinput>q</userinput>
</screen>
			</para></step>
		</procedure>

			<para>
			By now you should be getting the hang of configuration basics. Clearly, it is time to
			explore slightly more complex examples. For the remainder of this chapter we abbreviate
			instructions, since there are previous examples.
			</para>

		</sect3>

	</sect2>

	<sect2>
	<title>Domain Member Server</title>

	<para>
	<indexterm><primary>Server Type</primary><secondary>Domain Member</secondary></indexterm>
	In this instance we consider the simplest server configuration we can get away with
	to make an accounting department happy. Let's be warned, the users are accountants and they
	do have some nasty demands. There is a budget for only one server for this department.
	</para>

	<para>
	The network is managed by an internal Information Services Group (ISG), to which we belong.
	Internal politics are typical of a medium-sized organization; Human Resources is of the
	opinion that they run the ISG because they are always adding and disabling users. Also,
	departmental managers have to fight tooth and nail to gain basic network resources access for
	their staff. Accounting is different, though, they get exactly what they want. So this should
	set the scene.
	</para>

	<para>
	We use the users from the last example. The accounting department
	has a general printer that all departmental users may use. There is also a check printer
	that may be used only by the person who has authority to print checks. The chief financial
	officer (CFO) wants that printer to be completely restricted and for it to be located in the
	private storage area in her office. It therefore must be a network printer.
	</para>

	<para>
	The accounting department uses an accounting application called <emphasis>SpytFull</emphasis>
	that must be run from a central application server. The software is licensed to run only off
	one server, there are no workstation components, and it is run off a mapped share. The data
	store is in a UNIX-based SQL backend. The UNIX gurus look after that, so this is not our
	problem.
	</para>

	<para>
	The accounting department manager (maryo) wants a general filing system as well as a separate
	file storage area for form letters (nastygrams). The form letter area should be read-only to
	all accounting staff except the manager. The general filing system has to have a structured
	layout with a general area for all staff to store general documents as well as a separate
	file area for each member of her team that is private to that person, but she wants full
	access to all areas. Users must have a private home share for personal work-related files
	and for materials not related to departmental operations.
	</para>
	
		<sect3>
		<title>Example Configuration</title>
		
		<para>
		The server <emphasis>valinor</emphasis> will be a member server of the company domain.
		Accounting will have only a local server. User accounts will be on the domain controllers,
		as will desktop profiles and all network policy files.
		</para>

		<procedure>
			<step><para>
			Do not add users to the UNIX/Linux server; all of this will run off the
			central domain.
			</para></step>

			<step><para>
			Configure &smb.conf; according to <link linkend="fast-member-server">Member server smb.conf
			(globals)</link> and <link linkend="fast-memberserver-shares">Member server smb.conf (shares
			and services)</link>.
			</para></step>

<example id="fast-member-server">
<title>Member Server smb.conf (Globals)</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">MIDEARTH</smbconfoption>
<smbconfoption name="netbios name">VALINOR</smbconfoption>
<smbconfoption name="security">DOMAIN</smbconfoption>
<smbconfoption name="printcap name">cups</smbconfoption>
<smbconfoption name="disable spoolss">Yes</smbconfoption>
<smbconfoption name="show add printer wizard">No</smbconfoption>
<smbconfoption name="idmap uid">15000-20000</smbconfoption>
<smbconfoption name="idmap gid">15000-20000</smbconfoption>
<smbconfoption name="winbind use default domain">Yes</smbconfoption>
<smbconfoption name="printing">cups</smbconfoption>
</smbconfblock>
</example>

<example id="fast-memberserver-shares">
<title>Member Server smb.conf (Shares and Services)</title>
<smbconfblock>
<smbconfsection name="[homes]"/>
<smbconfoption name="comment">Home Directories</smbconfoption>
<smbconfoption name="valid users">%S</smbconfoption>
<smbconfoption name="read only">No</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>

<smbconfsection name="[spytfull]"/>
<smbconfoption name="comment">Accounting Application Only</smbconfoption>
<smbconfoption name="path">/export/spytfull</smbconfoption>
<smbconfoption name="valid users">@Accounts</smbconfoption>
<smbconfoption name="admin users">maryo</smbconfoption>
<smbconfoption name="read only">Yes</smbconfoption>

<smbconfsection name="[public]"/>
<smbconfoption name="comment">Data</smbconfoption>
<smbconfoption name="path">/export/public</smbconfoption>
<smbconfoption name="read only">No</smbconfoption>

<smbconfsection name="[printers]"/>
<smbconfoption name="comment">All Printers</smbconfoption>
<smbconfoption name="path">/var/spool/samba</smbconfoption>
<smbconfoption name="printer admin">root, maryo</smbconfoption>
<smbconfoption name="create mask">0600</smbconfoption>
<smbconfoption name="guest ok">Yes</smbconfoption>
<smbconfoption name="printable">Yes</smbconfoption>
<smbconfoption name="use client driver">Yes</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>
</smbconfblock>
</example>

			<step><para>
			<indexterm><primary>net</primary><secondary>rpc</secondary></indexterm>
			Join the domain. Note: Do not start Samba until this step has been completed!
<screen>
&rootprompt;<userinput>net rpc join -Uroot%'bigsecret'</userinput>
Joined domain MIDEARTH.
</screen>
			</para></step>

			<step><para>
			Make absolutely certain that you disable (shut down) the <command>nscd</command>
			daemon on any system on which <command>winbind</command> is configured to run.
			</para></step>

			<step><para>
			Start Samba following the normal method for your operating system platform.
			If you wish to do this manually, execute as root:
			<indexterm><primary>smbd</primary></indexterm>
			<indexterm><primary>nmbd</primary></indexterm>
			<indexterm><primary>winbindd</primary></indexterm>
			<indexterm><primary>starting samba</primary><secondary>smbd</secondary></indexterm>
			<indexterm><primary>starting samba</primary><secondary>nmbd</secondary></indexterm>
			<indexterm><primary>starting samba</primary><secondary>winbindd</secondary></indexterm>
<screen>
&rootprompt;<userinput>nmbd; smbd; winbindd;</userinput>
</screen>
			</para></step>

			<step><para>
			Configure the name service switch (NSS) control file on your system to resolve user and group names
			via winbind. Edit the following lines in <filename>/etc/nsswitch.conf</filename>:
<programlisting>
passwd: files winbind
group:  files winbind
hosts:  files dns winbind
</programlisting>
			</para></step>

			<step><para>
			Set the password for <command>wbinfo</command> to use:
<screen>
&rootprompt;<userinput>wbinfo --set-auth-user=root%'bigsecret'</userinput>
</screen>
			</para></step>

			<step><para>
			Validate that domain user and group credentials can be correctly resolved by executing:
<screen>
&rootprompt;<userinput>wbinfo -u</userinput>
MIDEARTH\maryo
MIDEARTH\jackb
MIDEARTH\ameds
...
MIDEARTH\root

&rootprompt;<userinput>wbinfo -g</userinput>
MIDEARTH\Domain Users
MIDEARTH\Domain Admins
MIDEARTH\Domain Guests
...
MIDEARTH\Accounts
</screen>
			</para></step>

			<step><para>
			Check that <command>winbind</command> is working. The following demonstrates correct
			username resolution via the <command>getent</command> system utility:
<screen>
&rootprompt;<userinput>getent passwd maryo</userinput>
maryo:x:15000:15003:Mary Orville:/home/MIDEARTH/maryo:/bin/false
</screen>
			</para></step>

			<step><para>
			A final test that we have this under control might be reassuring:
<screen>
&rootprompt;<userinput>touch /export/a_file</userinput>
&rootprompt;<userinput>chown maryo /export/a_file</userinput>
&rootprompt;<userinput>ls -al /export/a_file</userinput>
...
-rw-r--r--    1 maryo    users       11234 Jun 21 15:32 a_file
...

&rootprompt;<userinput>rm /export/a_file</userinput>
</screen>
			</para></step>

			<step><para>
			Configuration is now mostly complete, so this is an opportune time
			to configure the directory structure for this site:
<screen>
&rootprompt;<userinput>mkdir -p /export/{spytfull,public}</userinput>
&rootprompt;<userinput>chmod ug=rwxS,o=x /export/{spytfull,public}</userinput>
&rootprompt;<userinput>chown maryo.Accounts /export/{spytfull,public}</userinput>
</screen>
			</para></step>
		</procedure>

		</sect3>

	</sect2>

	<sect2>
	<title>Domain Controller</title>


	<para>
	<indexterm><primary>Server Type</primary><secondary>Domain Controller</secondary></indexterm>
	For the remainder of this chapter the focus is on the configuration of domain control.
	The examples that follow are for two implementation strategies. Remember, our objective is
	to create a simple but working solution. The remainder of this book should help to highlight
	opportunity for greater functionality and the complexity that goes with it.
	</para>

	<para>
	A domain controller configuration can be achieved with a simple configuration using the new
	tdbsam password backend. This type of configuration is good for small
	offices, but has limited scalability (cannot be replicated), and performance can be expected
	to fall as the size and complexity of the domain increases.
	</para>

	<para>
	The use of tdbsam is best limited to sites that do not need
	more than a Primary Domain Controller (PDC). As the size of a domain grows the need
	for additional domain controllers becomes apparent. Do not attempt to under-resource
	a Microsoft Windows network environment; domain controllers provide essential
	authentication services. The following are symptoms of an under-resourced domain control
	environment:
	</para>

	<itemizedlist>	
		<listitem><para>
		 Domain logons intermittently fail.
		</para></listitem>

		<listitem><para>
		File access on a domain member server intermittently fails, giving a permission denied
		error message.
		</para></listitem>
	</itemizedlist>

	<para>
	A more scalable domain control authentication backend option might use
	Microsoft Active Directory or an LDAP-based backend. Samba-3 provides
	for both options as a domain member server. As a PDC, Samba-3 is not able to provide
	an exact alternative to the functionality that is available with Active Directory.
	Samba-3 can provide a scalable LDAP-based PDC/BDC solution.
	</para>

	<para>
	The tdbsam authentication backend provides no facility to replicate
	the contents of the database, except by external means (i.e., there is no self-contained protocol
	in Samba-3 for Security Account Manager database [SAM] replication).
	</para>

	<note><para>
	If you need more than one domain controller, do not use a tdbsam authentication backend.
	</para></note>

		<sect3>
		<title>Example: Engineering Office</title>

		<para>
		The engineering office network server we present here is designed to demonstrate use
		of the new tdbsam password backend. The tdbsam
		facility is new to Samba-3. It is designed to provide many user and machine account controls
		that are possible with Microsoft Windows NT4. It is safe to use this in smaller networks.
		</para>

		<procedure>
			<step><para>
			A working PDC configuration using the tdbsam
			password backend can be found in <link linkend="fast-engoffice-global">Engineering Office smb.conf
			(globals)</link> together with <link linkend="fast-engoffice-shares">Engineering Office smb.conf
			(shares and services)</link>:
			<indexterm><primary>pdbedit</primary></indexterm>
			</para></step>

<example id="fast-engoffice-global">
<title>Engineering Office smb.conf (globals)</title>
<smbconfblock>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">MIDEARTH</smbconfoption>
<smbconfoption name="netbios name">FRODO</smbconfoption>
<smbconfoption name="passdb backend">tdbsam</smbconfoption>
<smbconfoption name="printcap name">cups</smbconfoption>
<smbconfoption name="add user script">/usr/sbin/useradd -m %u</smbconfoption>
<smbconfoption name="delete user script">/usr/sbin/userdel -r %u</smbconfoption>
<smbconfoption name="add group script">/usr/sbin/groupadd %g</smbconfoption>
<smbconfoption name="delete group script">/usr/sbin/groupdel %g</smbconfoption>
<smbconfoption name="add user to group script">/usr/sbin/groupmod -A %u %g</smbconfoption>
<smbconfoption name="delete user from group script">/usr/sbin/groupmod -R %u %g</smbconfoption>
<smbconfoption name="add machine script">/usr/sbin/useradd -s /bin/false -d /var/lib/nobody %u</smbconfoption>
<smbconfcomment>Note: The following specifies the default logon script.</smbconfcomment>
<smbconfcomment>Per user logon scripts can be specified in the user account using pdbedit </smbconfcomment>
<smbconfoption name="logon script">scripts\logon.bat</smbconfoption>
<smbconfcomment>This sets the default profile path. Set per user paths with pdbedit</smbconfcomment>
<smbconfoption name="logon path">\\%L\Profiles\%U</smbconfoption>
<smbconfoption name="logon drive">H:</smbconfoption>
<smbconfoption name="logon home">\\%L\%U</smbconfoption>
<smbconfoption name="domain logons">Yes</smbconfoption>
<smbconfoption name="os level">35</smbconfoption>
<smbconfoption name="preferred master">Yes</smbconfoption>
<smbconfoption name="domain master">Yes</smbconfoption>
<smbconfoption name="idmap uid">15000-20000</smbconfoption>
<smbconfoption name="idmap gid">15000-20000</smbconfoption>
<smbconfoption name="printing">cups</smbconfoption>
</smbconfblock>
</example>

<example id="fast-engoffice-shares">
<title>Engineering Office smb.conf (shares and services)</title>
<smbconfblock>
<smbconfsection name="[homes]"/>
<smbconfoption name="comment">Home Directories</smbconfoption>
<smbconfoption name="valid users">%S</smbconfoption>
<smbconfoption name="read only">No</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>

<smbconfcomment>Printing auto-share (makes printers available thru CUPS)</smbconfcomment>
<smbconfsection name="[printers]"/>
<smbconfoption name="comment">All Printers</smbconfoption>
<smbconfoption name="path">/var/spool/samba</smbconfoption>
<smbconfoption name="printer admin">root, maryo</smbconfoption>
<smbconfoption name="create mask">0600</smbconfoption>
<smbconfoption name="guest ok">Yes</smbconfoption>
<smbconfoption name="printable">Yes</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>

<smbconfsection name="[print$]"/>
<smbconfoption name="comment">Printer Drivers Share</smbconfoption>
<smbconfoption name="path">/var/lib/samba/drivers</smbconfoption>
<smbconfoption name="write list">maryo, root</smbconfoption>
<smbconfoption name="printer admin">maryo, root</smbconfoption>

<smbconfcomment>Needed to support domain logons</smbconfcomment>
<smbconfsection name="[netlogon]"/>
<smbconfoption name="comment">Network Logon Service</smbconfoption>
<smbconfoption name="path">/var/lib/samba/netlogon</smbconfoption>
<smbconfoption name="admin users">root, maryo</smbconfoption>
<smbconfoption name="guest ok">Yes</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>

<smbconfcomment>For profiles to work, create a user directory under the path</smbconfcomment>
<smbconfcomment> shown. i.e., mkdir -p /var/lib/samba/profiles/maryo</smbconfcomment>
<smbconfsection name="[Profiles]"/>
<smbconfoption name="comment">Roaming Profile Share</smbconfoption>
<smbconfoption name="path">/var/lib/samba/profiles</smbconfoption>
<smbconfoption name="read only">No</smbconfoption>
<smbconfoption name="profile acls">Yes</smbconfoption>

<smbconfcomment>Other resource (share/printer) definitions would follow below.</smbconfcomment>
</smbconfblock>
</example>

			<step><para>
			Create UNIX group accounts as needed using a suitable operating system tool:
<screen>
&rootprompt;<userinput>groupadd ntadmins</userinput>
&rootprompt;<userinput>groupadd designers</userinput>
&rootprompt;<userinput>groupadd engineers</userinput>
&rootprompt;<userinput>groupadd qateam</userinput>
</screen>
			</para></step>

			<step><para>
			Create user accounts on the system using the appropriate tool
			provided with the operating system. Make sure all user home directories
			are created also. Add users to groups as required for access control
			on files, directories, printers, and as required for use in the Samba
			environment.
			</para></step>


			<step><para>
			<indexterm><primary>net</primary><secondary>groupmap</secondary></indexterm>
			<indexterm><primary>initGroups.sh</primary></indexterm>
			Assign each of the UNIX groups to NT groups by executing this shell script
			(You could name the script <filename>initGroups.sh</filename>):
<screen>
#!/bin/bash
#### Keep this as a shell script for future re-use
			
# First assign well known groups
net groupmap add ntgroup="Domain Admins" unixgroup=ntadmins rid=512 type=d
net groupmap add ntgroup="Domain Users"  unixgroup=users rid=513 type=
net groupmap add ntgroup="Domain Guests" unixgroup=nobody rid=514 type=d

# Now for our added Domain Groups
net groupmap add ntgroup="Designers" unixgroup=designers type=d
net groupmap add ntgroup="Engineers" unixgroup=engineers type=d
net groupmap add ntgroup="QA Team"   unixgroup=qateam    type=d
</screen>
			</para></step>

			<step><para>
			Create the <filename>scripts</filename> directory for use in the 
			<smbconfsection name="[NETLOGON]"/> share:
<screen>
&rootprompt;<userinput>mkdir -p /var/lib/samba/netlogon/scripts</userinput>
</screen>
			Place the logon scripts that will be used (batch or cmd scripts)
			in this directory.
			</para></step>
		</procedure>

		<para>
		The above configuration provides a functional PDC
		system to which must be added file shares and printers as required.
		</para>

		</sect3>

		<sect3>
		<title>A Big Organization</title>

		<para>
		In this section we finally get to review in brief a Samba-3 configuration that
		uses a Lightweight Directory Access (LDAP)-based authentication backend. The
		main reasons for this choice are to provide the ability to host primary
		and Backup Domain Control (BDC), as well as to enable a higher degree of
		scalability to meet the needs of a very distributed environment.
		</para>

			<sect4>
			<title>The Primary Domain Controller</title>

			<para>
			This is an example of a minimal configuration to run a Samba-3 PDC
			using an LDAP authentication backend. It is assumed that the operating system
			has been correctly configured.
			</para>

			<para>
			The Idealx scripts (or equivalent) are needed to manage LDAP-based POSIX and/or
			SambaSamAccounts. The Idealx scripts may be downloaded from the <ulink url="http://www.idealx.org">
			Idealx</ulink> Web site. They may also be obtained from the Samba tarball. Linux
			distributions tend to install the Idealx scripts in the 
			<filename>/usr/share/doc/packages/sambaXXXXXX/examples/LDAP/smbldap-tools</filename> directory.
			Idealx scripts version <constant>smbldap-tools-0.9.1</constant> are known to work well.
			</para>

			<procedure>
				<step><para>
				Obtain from the Samba sources <filename>~/examples/LDAP/samba.schema</filename>
				and copy it to the <filename>/etc/openldap/schema/</filename> directory.
				</para></step>

				<step><para>
				Set up the LDAP server. This example is suitable for OpenLDAP 2.1.x.
				The <filename>/etc/openldap/slapd.conf</filename> file.
				<indexterm><primary>/etc/openldap/slapd.conf</primary></indexterm>
<title>Example slapd.conf File</title>
<screen>
# Note commented out lines have been removed
include         /etc/openldap/schema/core.schema
include         /etc/openldap/schema/cosine.schema
include         /etc/openldap/schema/inetorgperson.schema
include         /etc/openldap/schema/nis.schema
include         /etc/openldap/schema/samba.schema

pidfile         /var/run/slapd/slapd.pid
argsfile        /var/run/slapd/slapd.args

database        bdb
suffix          "dc=quenya,dc=org"
rootdn          "cn=Manager,dc=quenya,dc=org"
rootpw          {SSHA}06qDkonA8hk6W6SSnRzWj0/pBcU3m0/P
# The password for the above is 'nastyon3'

directory     /var/lib/ldap

index   objectClass     eq
index cn                      pres,sub,eq
index sn                      pres,sub,eq
index uid                     pres,sub,eq
index displayName             pres,sub,eq
index uidNumber               eq
index gidNumber               eq
index memberUid               eq
index   sambaSID              eq
index   sambaPrimaryGroupSID  eq
index   sambaDomainName       eq
index   default               sub
</screen>
				</para></step>

				<step><para>
				Create the following file <filename>initdb.ldif</filename>:
				<indexterm><primary>initdb.ldif</primary></indexterm>
<programlisting>
# Organization for SambaXP Demo
dn: dc=quenya,dc=org
objectclass: dcObject
objectclass: organization
dc: quenya
o: SambaXP Demo
description: The SambaXP Demo LDAP Tree

# Organizational Role for Directory Management
dn: cn=Manager,dc=quenya,dc=org
objectclass: organizationalRole
cn: Manager
description: Directory Manager

# Setting up the container for users
dn: ou=People, dc=quenya, dc=org
objectclass: top
objectclass: organizationalUnit
ou: People

# Set up an admin handle for People OU
dn: cn=admin, ou=People, dc=quenya, dc=org
cn: admin
objectclass: top
objectclass: organizationalRole
objectclass: simpleSecurityObject
userPassword: {SSHA}0jBHgQ1vp4EDX2rEMMfIudvRMJoGwjVb
# The password for above is 'mordonL8'
</programlisting>
				</para></step>

				<step><para>
				Load the initial data above into the LDAP database:
<screen>
&rootprompt;<userinput>slapadd -v -l initdb.ldif</userinput>
</screen>
				</para></step>

				<step><para>
				Start the LDAP server using the appropriate tool or method for
				the operating system platform on which it is installed.
				</para></step>

				<step><para>
				Install the Idealx script files in the <filename>/usr/local/sbin</filename> directory,
				then configure the smbldap_conf.pm file to match your system configuration.
				</para></step>

				<step><para>
				The &smb.conf; file that drives this backend can be found in example <link
				linkend="fast-ldap">LDAP backend smb.conf for PDC</link>. Add additional stanzas
				as required.
				</para></step>

<example id="fast-ldap">
<title>LDAP backend smb.conf for PDC</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">MIDEARTH</smbconfoption>
<smbconfoption name="netbios name">FRODO</smbconfoption>
<smbconfoption name="passdb backend">ldapsam:ldap://localhost</smbconfoption>
<smbconfoption name="username map">/etc/samba/smbusers</smbconfoption>
<smbconfoption name="printcap name">cups</smbconfoption>
<smbconfoption name="add user script">/usr/local/sbin/smbldap-useradd -m '%u'</smbconfoption>
<smbconfoption name="delete user script">/usr/local/sbin/smbldap-userdel %u</smbconfoption>
<smbconfoption name="add group script">/usr/local/sbin/smbldap-groupadd -p '%g'</smbconfoption>
<smbconfoption name="delete group script">/usr/local/sbin/smbldap-groupdel '%g'</smbconfoption>
<smbconfoption name="add user to group script">/usr/local/sbin/smbldap-groupmod -m '%u' '%g'</smbconfoption>
<smbconfoption name="delete user from group script">/usr/local/sbin/smbldap-groupmod -x '%u' '%g'</smbconfoption>
<smbconfoption name="set primary group script">/usr/local/sbin/smbldap-usermod -g '%g' '%u'</smbconfoption>
<smbconfoption name="add machine script">/usr/local/sbin/smbldap-useradd -w '%u'</smbconfoption>
<smbconfoption name="logon script">scripts\logon.bat</smbconfoption>
<smbconfoption name="logon path">\\%L\Profiles\%U</smbconfoption>
<smbconfoption name="logon drive">H:</smbconfoption>
<smbconfoption name="logon home">\\%L\%U</smbconfoption>
<smbconfoption name="domain logons">Yes</smbconfoption>
<smbconfoption name="os level">35</smbconfoption>
<smbconfoption name="preferred master">Yes</smbconfoption>
<smbconfoption name="domain master">Yes</smbconfoption>
<smbconfoption name="ldap suffix">dc=quenya,dc=org</smbconfoption>
<smbconfoption name="ldap machine suffix">ou=People</smbconfoption>
<smbconfoption name="ldap user suffix">ou=People</smbconfoption>
<smbconfoption name="ldap group suffix">ou=People</smbconfoption>
<smbconfoption name="ldap idmap suffix">ou=People</smbconfoption>
<smbconfoption name="ldap admin dn">cn=Manager</smbconfoption>
<smbconfoption name="ldap ssl">no</smbconfoption>
<smbconfoption name="ldap passwd sync">Yes</smbconfoption>
<smbconfoption name="idmap uid">15000-20000</smbconfoption>
<smbconfoption name="idmap gid">15000-20000</smbconfoption>
<smbconfoption name="printing">cups</smbconfoption>
</smbconfblock>
</example>

				<step><para>
				Add the LDAP password to the <filename>secrets.tdb</filename> file so Samba can update
				the LDAP database:
<screen>
&rootprompt;<userinput>smbpasswd -w mordonL8</userinput>
</screen>
				</para></step>

				<step><para>
				Add users and groups as required. Users and groups added using Samba tools
				will automatically be added to both the LDAP backend and the operating
				system as required.
				</para></step>

			</procedure>

			</sect4>

			<sect4>
			<title>Backup Domain Controller</title>

			<para>
			<link linkend="fast-bdc"/> shows the example configuration for the BDC. Note that
			the &smb.conf; file does not specify the smbldap-tools scripts &smbmdash; they are
			not needed on a BDC. Add additional stanzas for shares and printers as required.
			</para>

			<procedure>
				<step><para>
				Decide if the BDC should have its own LDAP server or not. If the BDC is to be
				the LDAP server, change the following &smb.conf; as indicated. The default
				configuration in <link linkend="fast-bdc">Remote LDAP BDC smb.conf</link>
				uses a central LDAP server.
				</para></step>

<example id="fast-bdc">
<title>Remote LDAP BDC smb.conf</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">MIDEARTH</smbconfoption>
<smbconfoption name="netbios name">GANDALF</smbconfoption>
<smbconfoption name="passdb backend">ldapsam:ldap://frodo.quenya.org</smbconfoption>
<smbconfoption name="username map">/etc/samba/smbusers</smbconfoption>
<smbconfoption name="printcap name">cups</smbconfoption>
<smbconfoption name="logon script">scripts\logon.bat</smbconfoption>
<smbconfoption name="logon path">\\%L\Profiles\%U</smbconfoption>
<smbconfoption name="logon drive">H:</smbconfoption>
<smbconfoption name="logon home">\\%L\%U</smbconfoption>
<smbconfoption name="domain logons">Yes</smbconfoption>
<smbconfoption name="os level">33</smbconfoption>
<smbconfoption name="preferred master">Yes</smbconfoption>
<smbconfoption name="domain master">No</smbconfoption>
<smbconfoption name="ldap suffix">dc=quenya,dc=org</smbconfoption>
<smbconfoption name="ldap machine suffix">ou=People</smbconfoption>
<smbconfoption name="ldap user suffix">ou=People</smbconfoption>
<smbconfoption name="ldap group suffix">ou=People</smbconfoption>
<smbconfoption name="ldap idmap suffix">ou=People</smbconfoption>
<smbconfoption name="ldap admin dn">cn=Manager</smbconfoption>
<smbconfoption name="ldap ssl">no</smbconfoption>
<smbconfoption name="ldap passwd sync">Yes</smbconfoption>
<smbconfoption name="idmap uid">15000-20000</smbconfoption>
<smbconfoption name="idmap gid">15000-20000</smbconfoption>
<smbconfoption name="printing">cups</smbconfoption>
</smbconfblock>
</example>

				<step><para>
				Configure the NETLOGON and PROFILES directory as for the PDC in <link linkend="fast-bdc"/>.
				</para></step>
			</procedure>

			</sect4>

		</sect3>

	</sect2>

</sect1>

</chapter>
