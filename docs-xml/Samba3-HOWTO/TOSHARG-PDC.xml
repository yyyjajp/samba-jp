<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<chapter id="samba-pdc">

<chapterinfo>
	&author.jht;
	&author.jerry;
	&author.dbannon;
	<author>&person.gd; <contrib>LDAP updates</contrib></author>
</chapterinfo>

<title>ドメイン制御</title>

<para>
Microsoft Windows のネットワークの世界に考えられないような誤解をしている人が
たくさんいる。それは私たちが支援を提供できる機会が増えるということですからそれはそれでいいのだが、
この分野で本当にヘルプを必要とする人は、まず、既に一般向けに出されている情報に親しむことを
推奨する。
</para>

<para>
<indexterm><primary>ドメイン</primary><secondary>コントローラー</secondary></indexterm>
ある程度の基本を理解・修得されてからこの章を読み進めることを推奨する。Microsoft Windowsネットワーク
では、誤った設定の影響がはっきりと現れる。Microsoft Windows ネットワークのユーザーから、
ネットワーク設定の誤りに起因すると思われる細かなトラブルにしつこく悩まされるという
苦情が出ることがよくある。ところが、多くの人々にとって Microsoft Windowsネットワークの
世界というのはドメインコントローラーを知るところから始まり、それはネットワーク操作の障害を
魔法のように、すべて解決してくれそうに思えるてくるものである。
</para>

<para>
<link linkend="domain-example">ドメインの例の図解</link>は典型的な、Microsoft 
Windows ネットワーク ドメインセキュリティネットワーク環境を図示している。
ワークステーションA、BとCは多くの物理的なMicrosoft Windowsネットワーククライアント
を代表していると考えられたい。
</para>

<figure id="domain-example">
	<title>ドメインの例</title>
	<imagefile scale="40">domain</imagefile>
</figure>

<para>
Sambaメーリングリストから、よくあるネットワークに関する問題の多くを容易に特定できる。
もしも以下の話題についてよく分からないのであれば、それについて取り扱っている、
このHOWTO文書の節を読むことを強く勧める。以下は、最も一般的なMicrosoft Windows
ネットワークの問題である:
</para>

<itemizedlist>
	<listitem><para>基本的なTCP/IPの設定</para></listitem>
	<listitem><para>NetBIOS名の解決方法</para></listitem>
	<listitem><para>認証の設定</para></listitem>
	<listitem><para>ユーザーとグループの設定</para></listitem>
	<listitem><para>UNIX/Linux上での基本的なファイルとディレクトリのアクセス制御</para></listitem>
	<listitem><para>ネットワーク環境中でMicrosoft Windowsクライアントがどのようにやりとりをするかの理解</para></listitem>
</itemizedlist>

<para>
がっくりする必要はない。Microsoft Windowsのネットワーク機能は、一見、大変シンプルで
誰でもできそうに見える。実際には、適切な研修と準備をしないで Microsoft Windows ネットワーク
を設定するのは、あまりよい考えとは言えない。とはいえ、なかなか払拭できない思い込みをちょっと
脇にどけることにしよう。<emphasis>ミスを犯すのもいいことです!</emphasis>時と場合によっては
失敗も教訓となる。しかし、生産性のロスを招き、組織に不可避の財政負担を強いるようなミスを
犯してもよいわけではない。
</para>

<para>
それでは、ミスを犯してもよい場所とはどこであろうか? それは実害のない場所である。ミスを犯すなら、
テストネットワーク上で、ユーザーから遠く離れた場所で、他の人に苦痛を与えない状況でやってほしい。
</para>

<sect1>
<title>機能と利便性</title>

<para>
<indexterm><primary>ドメインセキュリティ</primary></indexterm>
<emphasis>Microsoftドメインセキュリティの最も重要な利便性は何か?</emphasis>
</para>

<para>
<indexterm>シングルサインオン<primary></primary><see>SSO</see></indexterm>
<indexterm><primary>trust</primary></indexterm>
<indexterm><primary>アカウント</primary></indexterm>
<indexterm><primary>ドメイン</primary><secondary>セキュリティ</secondary><tertiary>プロトコル</tertiary></indexterm>
要するに、<emphasis>シングルサインオン</emphasis>、あるいは短く言えばSSO
である。これは多くの人にとって、Microsoft Windows NT 以後のネットワーキング
における聖杯である。SSOは、ユーザーのユーザーアカウントが存在するドメインの
メンバーであるワークステーション(あるいは、アクセスするドメインとの間に適切な
信頼関係があるドメインに属するワークステーション)のいずれからも、ネットワーク
にログオンできるという優れた設計を可能にする。ユーザーは、自分のホームの(個人の)
ワークステーションの前に座っているかのように、ネットワークにログオンでき、
リソース(共有、ファイル、プリンター)にアクセスできる。これはドメインセキュリティ
プロトコルの一つの特長である。
</para>

<para>
<indexterm><primary>SID</primary></indexterm>
<indexterm><primary>RID</primary></indexterm>
<indexterm><primary>relative identifier</primary><see>RID</see></indexterm>
<indexterm><primary>セキュリティ識別子</primary><see>SID</see></indexterm>
<indexterm><primary>アクセス制御</primary></indexterm>
Samba PDCを実装するサイトは、ドメインセキュリティの利便性を享受できる。ドメイン
は、固有のネットワーク・セキュリティ識別子(SID)を提供する。ドメインユーザーと
グループセキュリティの識別子は、ネットワーク SID に、アカウント毎に一意の
相対識別子(RID)を付け足したものである。ユーザーとグループのSID(ネットワークSID
+RID)は、ネットワークリソースに付けられるアクセス制御リスト(ACL)を作成するのに
使用され、組織内のアクセス制御を可能にする。UNIXシステムは、ローカル
セキュリティ識別子のみ認識する。
</para>

<para>
<indexterm><primary>SID</primary></indexterm>
SIDはセキュリティコンテキストを表す。例をあげると、おのおののWindows
マシンは固有のSIDを持つローカルマシンのセキュリティコンテキストでの
ローカルアカウントを持つ。すべてのドメイン(NT4、ADS、Samba)は
ドメインSIDによって定義されるセキュリティドメインセキュリティコン
テキストで存在するアカウントを含む。
</para>

<para>
<indexterm><primary>SID</primary></indexterm>
<indexterm><primary>RID</primary></indexterm>
ドメインメンバーサーバーはドメインSIDとは異なるSIDを持つ。ドメインメンバー
サーバーはすべてのドメインユーザーをローカルユーザーとして見なすように
設定できる。SIDは持続的である。標準的なドメインのユーザーSIDは以下の
ようなものである:
<screen>
S-1-5-21-726309263-4128913605-1168186429
</screen>
すべてのアカウント(ユーザー、グループ、マシン、信頼関係など)はRIDが割り当てられる。
これは、アカウントが作成された時に自動的に行われる。UNIX OSはユーザーとグループ
識別子に別々の名前空間を使う(UIDとGID)が、Windowsは同じ名前空間からRIDを
割り当てる。WindowsユーザーとWindowsグループは同じRIDを持てない。ちょうどUNIX
ユーザー<literal>root</literal>がUID=0であるように、Windows Administrator
は、よく知られたRID=500を持つ。RIDはWindowsドメインRIDに連結され、そのため、
上記のSIDを持つドメインのAdministratorアカウントは下記のユーザーSIDを持つ。
<screen>
S-1-5-21-726309263-4128913605-1168186429-500
</screen>
Windowsネットワーク領域中での残りのすべてのアカウントは全体で一意なセキュリティ
識別子を持つ。
</para>

<note><para>
<indexterm><primary>ドメイン</primary><secondary>メンバー</secondary></indexterm>
<indexterm><primary>マシンアカウント</primary></indexterm>
<indexterm><primary>domain</primary><secondary>trust account</secondary></indexterm>
Microsoft Windows ドメインセキュリティ環境でのネットワーククライアントは提供される
高度な機能にアクセス出来るためには、ドメインメンバーでなければならない。ドメイン
メンバーシップはワークグループ名をドメイン名に設定するだけではない。ワーク
ステーションに対する(マシンアカウントと呼ばれる)ドメイン信頼アカウントの作成
が必要である。より詳細については
<link linkend="domain-member">ドメインメンバーシップ</link>を参照のこと。
</para></note>

<para>
以下の機能はSamba-4リリースにある、いくつかの機能の概要である:
</para>

<itemizedlist>
	<listitem><para>
	<indexterm><primary>アカウント</primary><secondary>バックエンド</secondary></indexterm>
	Samba-4はユーザー、グループとマシンアカウントが格納される時に使われる
	バックエンドの選択を行う事をサポートしているが、それらは旧来の(NT4)
	ドメインコントローラーとして振る舞う時のことであり、Active Directory
	ドメインコントローラーの時には使えない。
	</para>

	<para>
	<indexterm><primary>LDAP</primary></indexterm>
	<indexterm><primary>replicated</primary></indexterm>
	<indexterm><primary>distributed</primary></indexterm>
	<indexterm><primary>拡張性</primary></indexterm>
	<indexterm><primary>信頼性</primary></indexterm>
	LDAP passdbバックエンドは、拡張性と高いレベルでの信頼性を
	提供するという理由で、とても価値のある、アカウントバックエンドが
	分散かつ複製が出来るメリットを享受できる。
	これは、Samba-4が旧来の(NT4風の)ドメインコントローラーとして振る舞う時に
	使われ、Active Directoryドメインコントローラーとして振る舞う場合には
	使われない。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>ドメイン間</primary><secondary>信頼</secondary><tertiary>アカウント</tertiary></indexterm>
	<indexterm><primary>信頼アカウント</primary><secondary>ドメイン間</secondary></indexterm>
	<indexterm><primary>相互運用性</primary></indexterm>
	Windows NT4のドメイン信頼関係である。Samba-4はワークステーションと
	サーバー(マシン)信頼アカウントをサポートする。これは、ネットワークの
	スケーラビリティと相互運用性をさらに支援する、NT4スタイルのドメイン
	間信頼アカウントをサポートするが、これは旧来の(NT4風の)ドメインコントローラー
	の場合の時のみである。
	</para></listitem>
	
	<listitem><para>
	<indexterm><primary>NetBIOS</primary></indexterm>
	<indexterm><primary>raw SMB</primary></indexterm>
	<indexterm><primary>active directory</primary></indexterm>
	<indexterm><primary>ドメイン</primary><secondary>メンバーサーバー</secondary></indexterm>
	<indexterm><primary>ドメイン</primary><secondary>コントローラー</secondary></indexterm>
	<indexterm><primary>ネットワーク</primary><secondary>ブラウジング</secondary></indexterm>
	
	NetBIOS over TCP/IPなしの操作は、むしろraw SMB over TCP/IPを使うことである。注意:
	これはMicrosoft active directoryドメインメンバーサーバーとして操作する時にのみ
	実行可能である。旧来の(NT4風の)Sambaドメインコントローラーとして動作する時、
	NetBIOSの使用は、
	ネットワークブラウジングのサポートを提供するために必要である。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>WINS</primary></indexterm>
	<indexterm><primary>TCPポート</primary></indexterm>
	<indexterm><primary>セッションサービス</primary></indexterm>
	Samba-4はNetBIOSネームサービス(WINS)、NetBIOS ever TCP/IP(TCPポート139)、
	SMB over TCP(TCP port 445)セッションサービスとMicrosoft互換のONC DCE 
	RPCサービス(TCPポート135)を提供する。
	</para></listitem>

	<listitem><para>
	  <indexterm><primary>kerberos</primary></indexterm>
	  <indexterm><primary>active directory</primary></indexterm>
	  Windows 2000 active directoryドメインコントローラー(すなわち、
	  KerberosとActive Directory)として振る舞う。
	</para></listitem>

	<listitem><para>
	  <indexterm><primary>MMC</primary></indexterm>
	  <indexterm><primary>SVRTOOLS.EXE</primary></indexterm>
	  <indexterm><primary>Microsoft management console</primary><see>MMC</see></indexterm>
	  Windows 200x/XP Microsoft 管理コンソール (MMC) は、Samba-4が
	  Active Directoryドメインコントローラーとなっている時に、Samba-4サーバーの
	  管理用として利用できる。旧来の(NT4風の)ドメインコントローラーの場合は、
	  MS Windows NT4 ドメインサーバーマネージャと、MS Windows NT4
	  ドメインユーザーマネージャのみを使う事ができる。両者とも、
	  この後で説明するSVRTOOLS.EXEパッケージの一部である。
	</para></listitem>
</itemizedlist>

<para>
以下の機能はSamba-4では提供されていない:
</para>

<itemizedlist>
	<listitem><para>
	<indexterm><primary>SAM</primary></indexterm>
	<indexterm><primary>複製</primary></indexterm>
	NT4ドメインコントローラー間でのSAMの複製(すなわちSamba PDCとWindows NT BDCまたはその逆)。
	これは、Sambaが、PDCがMicrosoftベースのWindows NT PDCである時にBDCと
	して動作出来ないことを意味する。Samba-4はWindows PDCとBDCでのアカウント
	データの複製に参加できない。
	</para></listitem>
</itemizedlist>

<para>
<indexterm><primary>グループ</primary><secondary>マッピング</secondary></indexterm>
Samba ではWindows NT グループと UNIX グループ間でのグループマッピングを実装
している(これは、限られたスペースでは説明できないくらい非常に複雑で
ある)。これについての詳細については
<link linkend="groupmapping">グループマッピング:Microsoft WindowsとUNIX</link>
を参照のこと。
</para>

<para>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
<indexterm><primary>信頼アカウント</primary><secondary>マシン</secondary></indexterm>
<indexterm><primary>マシンアカウント</primary></indexterm>
Samba-4はMicrosoft Windows NT4 PDCまたはWindows200x Active Directory
と同様に、適切なバックエンドデータベースにユーザーとマシン
信頼アカウント情報を格納することを必要とする。これについては、
<link linkend="machine-trust-accounts">
Microsoft Windows ワークステーション/サーバー マシン信頼アカウント</link>
を参照のこと。
完全なアカウントデータベースバックエンドについての解説は
<link linkend="passdb">アカウント情報データベース</link>を参照のこと。
</para>

</sect1>

<sect1>
<title>シングルサインオンとドメインセキュリティ</title>

<para>
<indexterm><primary>シングルサインオン</primary><see>SSO</see></indexterm>
<indexterm><primary>SSO</primary></indexterm>
<indexterm><primary>active directory</primary></indexterm>
<indexterm><primary>認証</primary></indexterm>
<indexterm><primary>validation</primary></indexterm>
<indexterm><primary>パスワードの一意性</primary></indexterm>
<indexterm><primary>パスワード履歴</primary></indexterm>
ネットワーク管理者が、Windows NT4とactive directoryネットワークの利点に
ついて説明を求められるとき、しばしば言及するのが、シングルサインオン
(SSO)を実装しているということである。多くの会社がSSOを実装している。
シングルサインオンソリューション実装のモードは、一般的に、ネットワーク
業務における重要な要因であり、Windowsネットワークに関してとても重要で
ある。会社には多くの種類の情報システムがあり、それぞれはユーザー認証と認可
(訳注:authentication and validation)を要求し、そのため、一般的
ではないが、ユーザーは10以上のログインIDとパスワードを記憶する必要が
あるかもしれない。この問題は、おのおののシステムのパスワードが
一定期間で更新が必定で、パスワードの複雑さとパスワード履歴が
適用されるときには特に顕著となる。
</para>

<para>
<indexterm><primary>管理のオーバーヘッド</primary></indexterm>
非常に数多くの情報システムに対するアクセス権限(ユーザー名/パスワードペア)
を扱うユーザーの問題に対する回答がSSOであるという認識を包括的に
持っている。多くの巧妙な案が、ユーザーフレンドリーなSSOのソリューション
を提供可能にするために考案された。問題は、この導入がうまく終わって
いない場合、サイトは複雑さによるたくさんの費用と管理上のオーバーヘッド
が起きるかもしれないということである。簡単に言って、多くのSSOソリュー
ションは管理上の悪夢である。
</para>

<para>
<indexterm><primary>identity management</primary></indexterm>
<indexterm><primary>認証システム</primary></indexterm>
<indexterm><primary>SSO</primary></indexterm>
SSOを使うことですべてのユーザーアカウント情報を集中管理できる。
環境の複雑さと、SSOを導入したシステムの稼働期間に依存して、
新しいアイデンティティ管理とユーザー認証システムを受け入れること
は可能ではないかもしれない。多くのSSOソリューションは、
ユーザーのための認証を処理する新しい上位の構造から成り立つ
レガシーシステムを改良する。これは、SSOの追加は全体的な情報
システムの複雑さを増大することを意味する。理想的には、SSOの
導入は複雑さの低減と管理オーバーヘッドの削減をすべきである。
</para>

<para>
<indexterm><primary>集中化したアイデンティティ管理</primary></indexterm>
<indexterm><primary>アイデンティティ管理</primary><secondary>集中化</secondary></indexterm>
<indexterm><primary>集中化</primary><secondary>認証</secondary></indexterm>
<indexterm><primary>レガシーシステム</primary></indexterm>
<indexterm><primary>アクセス制御</primary></indexterm>
たくさんのネットワーク管理の最初のゴールは、しばしば集中管理した
アイデンティティ管理システムを作り、使うことである。これは、
そのような集中化したシステムは、すべての情報システムによって
使うことが出来る単一の認証基盤を使うことをしばしば仮定している。
Microsoft Windows NT4セキュリティドメインアーキテクチャとMicrosoft
Active Directoryサービスは、そのようなシステムに対しての理想的な
基盤としてしばしば提供される。ユーザーの認証とアクセス制御のために
Microsoft(NT4ドメインかadsサービス)を使うことが出来る単一の
認証基盤を使う、そのような集中化したシステムがしばしば仮定される。
単一の集中化した認証サービスのすばらしい幻想は一般的に、現実を
理解するときに一般的に壊れている。レガシーシステムを使うときの問題
は、その導入がリエンジニアリングの観点から、過度に侵略的になるか、
アプリケーションソフトが、設計されて実装されたユーザー認証の特定の
要素に依存して組み込まれているという理由により、認証とアクセス制御
を具体化する能力がしばしばないということである。
</para>

<para>
<indexterm><primary>メタディレクトリ</primary></indexterm>
<indexterm><primary>credentials</primary></indexterm>
<indexterm><primary>disparate information systems</primary></indexterm>
<indexterm><primary>管理手続き</primary></indexterm>
<indexterm><primary>ワークフロープロトコル</primary></indexterm>
<indexterm><primary>rights</primary></indexterm>
<indexterm><primary>privileges</primary></indexterm>
<indexterm><primary>provisioned</primary></indexterm>
これまでの10年間、産業が、レガシー名情報テクノロジーシステムの
制限の鍵となる点を回避するために作られた、いろいろな方法が開発
されてきた。しばしば使われるその1つの方法はメタディレクトリを
使うことである。メタディレクトリには、それぞれのシステムに固有な
形式で、すべての異なる情報システムのためにユーザー認証情報を保存
する。単一のユーザー認証情報を使うすべてのシステムのために、新しい
基盤がユーザーアクセスを可能にさせることが提供されるシステムの
迷宮の中で、ユーザー権限と権利(rights and privileges)を管理する
ための厳格に実施されるワークフロープロトコルに、管理手続き
の巧妙なセットが結合される。
</para>

<para>
<indexterm><primary>Organization for the Advancement of Structured Information Standards</primary><see>OASIS</see></indexterm>
<indexterm><primary>Security Assertion Markup Language</primary><see>SAML</see></indexterm>
<indexterm><primary>Federated Identity Management</primary><see>FIM</see></indexterm>
<indexterm><primary>安全なアクセス</primary></indexterm>
Organization for the Advancement of Structured Information Standards (OASIS)
は、認証情報の通信のための構造化情報であるSecurity Assertion Markup Language (SAML)
を開発している。SAMLを配置するための全体的な技術と手法の包括的名称(訳注:umbrella name)は
Federated Identity Management (FIM)と呼ばれる。FIMはそれぞれのユーザーを認証
するための異なった情報システムの複雑な迷宮中で、かつおのおのが提供するサービス
の安全なアクセスを請け負うために、おのおののシステムに依存する。
</para>

<para>
<indexterm><primary>Simple Object Access Protocol</primary><see>SOAP</see></indexterm>
<indexterm><primary>federated organizations</primary></indexterm>
<indexterm><primary>Liberty Alliance</primary></indexterm>
<indexterm><primary>federated-identity</primary></indexterm>
<indexterm><primary></primary></indexterm>
<indexterm><primary></primary></indexterm>
SAML文書はWebサービスのために必要なコンピューター間通信のための
Simple Object Access Protocol (SOAP)メッセージ中に包むことが出来る。
あるいは、ライブサービスを共有する集合化したWebサービス間で渡される
かもしれない。リバティ・アライアンスは、SAML1.1をアプリケーション
フレームワークとして適用した、連携型アイデンティティ標準
(訳注:federated-identity standards)を普及させるために作られた
コンソーシアム(訳注:industry group)である。MicrosoftとIBMは
WS-Securityと呼ばれる別の方式を提案していた。ある人は、競合して
いる技術と手法がSAML 2.0標準が世に出るときにまとまるのではないか
と信じていた。現在ではごく少数のWebアクセス管理製品のみがSAMLを
サポートしているが、技術の実装は、アプリケーション統合のための
カスタマイズとユーザーインタフェースの開発のために、主に必要と
される。要するに、それがなぜFIMが大木つて成長している産業である
かの理由である。
</para>

<para>
<indexterm><primary>相互運用性</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>GSSAPI</primary></indexterm>
<indexterm><primary>general security service application programming interface</primary><see>GSSAPI</see></indexterm>
この本の向こうの範囲の大きな絵を無視し、集中したシステムへのすべての
ユーザーとグループのマイグレーション管理は、正しい方向への第一歩である。
Microsoft Active Directoryサービス(ADS)やその他のプロプライエティな
ものか、general security service application programming interface
(GSSAPI)サービスによって定義されているプロトコルを使う数々の認証
メカニズム(kerberosのような)の柔軟な組み合わせができる情報アクセス
(LDAPのような)のための、標準プロトコルを提供するオープンソースシステム
のような、ディレクトリ中にアイデンティティ管理システムデータを位置づける
のは、相互運用性のための基本である。
</para>

<para>
<indexterm><primary>OpenLDAP</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>認証エージェント</primary></indexterm>
ますます多くの会社がLDAPシステムを使うことを許可するための異なったレガシー
プラットフォームのために認証エージェントを提供する。OpenLDAPの使用で、
LDAP標準のオープンソース実装が支配的である。実際、LDAPとMicrosoft
ADSを使うためにSambaで提供することは、Sambaが、高度な拡張性と
Sambaは、組織のネットワーク技術に届くように前進することを意味する。
</para>

<para>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>認証アーキテクチャ</primary></indexterm>
<indexterm><primary>ntlm_auth</primary></indexterm>
<indexterm><primary>SQUID</primary></indexterm>
<indexterm><primary>FIM</primary></indexterm>
Microsoft ADSは、集中化した認証基盤を提供するために拡張できる、
制限付きの完全に商用なサービスを提供する。SambaとLDAPは、集中化した
認証基盤の拡張のための同様な機会を提供するが、実際、Sambaチームは、
LDAPあるいは他のものを使って、認証サービスの拡張の導入中で、
、持続可能な選択とFIMマーケットプレイス中での競合をより多く作成する、
<command>ntlm_auth</command>ユーティリティのような完全なツールを
SQUID(OSSのプロキシサーバー)のようなアプリケーションのために
先を見越している。
</para>

<para>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>OpenLDAP</primary></indexterm>
<indexterm><primary>identity information</primary></indexterm>
もしも、プライマリドメインコントロールが大きなサイトに適合した拡張性
があれば、LDAP を使うことが出来るに違いない。それを使うためのすばやい
OpenLDAP と Samba の設定は、ディレクトリの時代が始まったことの十分な
証明である。Samba は LDAP を使うことが必然ではないが、
ユーザーとグループという識別情報を分散可能にする機構を使おうとすると、
それを不可避の選択としている。
</para>

<para>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>e-Directory</primary></indexterm>
この時点で、SambaベースのBDCを使用するには、Samba-4 Active Directory
ドメインコントローラーか、旧来の(NT4風の)ドメインをLDAPバックエンドとして
使用することが必要である。最も一般的な、Sambaサイトによって使われるLDAP実装は
OpenLDAPである。標準準拠の任意のLDAPサーバーを使うことも可能である。それらは、
IBM、CA、Novell(e-Directory)とその他で知られている。
</para>

</sect1>

<sect1>
<title>ドメイン制御の基礎</title>

<para>
<indexterm><primary>ドメイン制御</primary></indexterm>
長年の間に、ドメイン管理に関する一般の理解はほとんど神話の世界になってきた。
ドメイン制御についての基本を概観する前に、
ドメインコントローラーの3つのタイプについて説明する。
</para>

<sect2>
<title>ドメインコントローラーの種類</title>

<itemizedlist>
	<listitem><para>NT4スタイルプライマリドメインコントローラー</para></listitem>
	<listitem><para>NT4スタイルバックアップドメインコントローラー</para></listitem>
	<listitem><para>ADSドメインコントローラー</para></listitem>
</itemizedlist>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>powerful</primary></indexterm>
<indexterm><primary>ネットワーク</primary><secondary>パフォーマンス</secondary></indexterm>
<indexterm><primary>ドメイン</primary><secondary>メンバー</secondary><secondary>サーバー</secondary></indexterm>
<emphasis>プライマリドメインコントローラー</emphasis>あるいはPDCはMicrosoft
Windows NTで重要な役割を演じる。Windows 200xドメインアーキテクチャ中では
この役割はドメインコントローラーが担う。Microsoft Windowsネットワークにおける
ドメインコントローラーの役割は、ドメインコントローラーがネットワークの中で
最も強力で最も能力のあるマシンでなければならないことを示す、ということになって
いる。ところが、おかしなことを言うと思われるかも知れないが、ネットワークの
全体的な性能を高めるためには、インフラストラクチャー全体がバランスのとれた
ものでなければならない。ドメインコントローラーよりもスタンドアロン
(ドメインメンバー)サーバーに投資する方が賢明である。
</para>

<para>
<indexterm><primary>SAM</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>認証</primary></indexterm>
<indexterm><primary>同期</primary></indexterm>
<indexterm><primary>FSMO</primary></indexterm>
<indexterm><primary>Flexible Single Master Operator</primary><see>FSMO</see></indexterm>
<indexterm><primary>Security Account Manager</primary><see>SAM</see></indexterm>
Microsoft Windows NT4スタイルドメインの場合、新しいドメイン制御データベースを
初期化するのはPDCである。これにより、Security Account Manager (SAM)と呼ばれる
Windowsレジストリの一部分が形成される。これは、NT4スタイルのドメインユーザーの認証と
BDCのドメイン認証データベースとの同期で鍵となる役割を果たす。
Active Directoryドメインコントローラーの場合は、いくつかのサーバーは、
Flexible Single Master Operator (FSMO)ロールオーナ(と、それゆえに、特定の
動作を独占し続ける)になれるので、一般的には分散、マルチマスターの複製された
ディレクトリということになる。
</para>

<para>
<indexterm><primary>バックエンドデータベース</primary></indexterm>
<indexterm><primary>レジストリ</primary></indexterm>
Samba-4では、NT4スタイルのSAMデータベース(レジストリファイルの1つ)と
としていくつかのタイプのデータを保持するバックエンドデータベースを使うことができる。
旧来のドメインにおける、PDC/BDCのためには、この機能はLDAPベースの
ユーザーとマシンアカウントバックエンドを使う事で実装されている。
Samba-4 Active Directoryドメインコントローラーは内部的にストレージを
実装している。
<footnote><para><link linkend="passdb">アカウント情報データベース</link>
を参照のこと。</para></footnote>
</para>

<para>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>WINS</primary></indexterm>
<indexterm><primary>authentication</primary></indexterm>
<indexterm><primary>netlogon</primary></indexterm>
<indexterm><primary>name lookup</primary></indexterm>
<emphasis>バックアップドメインコントローラー</emphasis>またはBDCはネットワーク
認証リクエストの処理に重要な役割を演じる。BDCはPDCに優先してログオン要求に答える
ようになっている。BDCとPDCの両方があるネットワークセグメント上では、
ネットワークログオン要求はおおむねBDCが処理する。PDCはBDCが高負荷
(ロードアベレージが大きい)ときにログオン要求に応える。ユーザーがWindows
ドメインメンバークライアントにログオンした時、ワークステーションは最も近い
ネットワークログオンサーバーを探すために、ネットワークに問い合わせを
行う。WINSサーバーが使われている時は、WINSサーバーへの問い合わせ
で行われる。もしもネットログオンサーバーがWINS問い合わせでは見つからないか、
WINSサーバーがない場合、ワークステーションはUDPブロードキャストプロトコル
上でmailslotブロードキャスト経由でNetBIOS名前検索を実行する。これは、
Windowsクライアントが使うことが出来るネットログオンサーバーがたくさんの
変数によって影響され、それゆえ、PDCまたはBDCが特定のログオン認証要求
を処理する単純な決定要素はない。
</para>

<para>
<indexterm><primary>昇格</primary></indexterm>
<indexterm><primary>降格</primary></indexterm>
Windows NT4 BDC は PDC に昇格することが出来る。BDC が PDC に昇格する時に PDC
がオンラインならば、以前の PDC は自動的に BDC に降格する。Samba では
これは自動的には行われない。PDC と BDC は手動で設定し、その他適切な
変更を行う必要がある。
</para>

<para>
<indexterm><primary>ドメイン</primary><secondary>コントローラー</secondary><tertiary>変換</tertiary></indexterm>
Microsoft Windows NT4では、インストール時に、サーバーのマシンタイプが
何になるかを決める。BDCからPDCへの昇格やその逆も
可能である。Windows NT4ドメインコントローラーからドメインメンバーサーバー
かスタンドアロンサーバーへの変換のためにMicrosoftが提供している唯一の
手法は、再インストールである。インストール時に提供されている選択肢
は以下の通り:
</para>

<itemizedlist>
	<listitem><para><emphasis>プライマリドメインコントローラー</emphasis>&smbmdash; ドメインSAMを生成するサーバー。</para></listitem>
	<listitem><para><emphasis>バックアップドメインコントローラー</emphasis>&smbmdash; ドメインSAMのコピーを受け取るサーバー。</para></listitem>
	<listitem><para><emphasis>ドメインメンバーサーバー</emphasis> &smbmdash; ドメインSAMのコピーを持たない。すべてのアクセス制御についてドメインコントローラーから認証を受け取るサーバー。</para></listitem>
	<listitem><para><emphasis>スタンドアロンサーバー</emphasis> &smbmdash;SAM同期を行わず、固有の認証データベースを持ち、ドメインセキュリティでは何の役割も担わないサーバー。</para></listitem>
</itemizedlist>

<para>
<indexterm><primary>ドメイン</primary><secondary>制御</secondary><tertiary>役割</tertiary></indexterm>
<indexterm><primary>native member</primary></indexterm>
Samba サーバーは &smb.conf; ファイルに簡単な変更をすることで、ドメイン
コントローラーへ、あるいはドメインコントローラーから容易に変換できる。
Samba は Windows200x サーバーの Active Directory ドメインでのネイティブ
なメンバーとして完全に振る舞える。
</para>

<para>
<indexterm><primary>変換</primary><secondary>ドメインメンバーサーバー</secondary></indexterm>
完全な図を提供するために、Microsoft Windows 2000 ドメイン制御の設定は
サーバーがインストールされた後に行われる。ドメインメンバーサーバーへの変換、
あるいはドメイン制御からの変換を行うための手順と、Active Directory
サービスのサポートのインストール、あるいはActive Directoryから抜ける
ための方法については、Microsoftの資料を参照してほしい。
</para>

<para>
<indexterm><primary>複製</primary><secondary>SAM</secondary></indexterm>
<indexterm><primary>SAM</primary><secondary>複製</secondary></indexterm>
Samba での新機能として、SAM複製コンポーネントを除く、Microsoft Windows
NT4 スタイルのドメインコントローラー機能の実装が上げられる。しかし、Samba
はMicrosoft Windows 200x ドメイン制御プロトコルについてもサポートすることも
注目してほしい。
</para>

</sect2>

<sect2>
<title>ドメイン制御の準備</title>

<para>
<indexterm><primary>スタンドアロン</primary></indexterm>
<indexterm><primary>ワークグループ</primary></indexterm>
<indexterm><primary>メンバー</primary></indexterm>
<indexterm><primary>セキュリティ</primary></indexterm>
Microsoft Windows のマシンが、お互いに他のサーバーやドメインコントローラー
とやりとりするのには2つの方法がある:そのうちの1つは、一般的に
<emphasis>ワークグループ</emphasis>メンバーとして呼ばれている
<emphasis>スタンドアロン</emphasis>システムであり、もう1つは、
一般的に<emphasis>ドメイン</emphasis>メンバーと呼ばれている、
セキュリティシステム中で全面的に参加するものである。
</para>

<para>
<indexterm><primary>ワークグループ</primary></indexterm>
<indexterm><primary>ワークグループ</primary><secondary>メンバーシップ</secondary></indexterm>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
ワークグループのメンバーであるために、特別な設定は必要ないということに注意してほ
しい。ただ、ネットワーク設定に、ワークグループのエントリについて共通に使う
単一の名前を持つようにマシンを設定するだけである。この時WORKGROUPという名前を使
うのが一般的である。この設定モードでは、マシン信頼アカウントはなく、メンバーシッ
プの概念は、すべてのマシンがネットワーク環境の中で、論理的に一緒のグループに
まとめられているという以上のものではない。繰り返すが、明確言うと、
<emphasis>ワークグループモードは、セキュリティの確保されたマシンアカウントを含まない</emphasis>。
</para>

<para>
<indexterm><primary>ドメインメンバーシップ</primary></indexterm>
<indexterm><primary>マシン信頼アカウント</primary><secondary>パスワード</secondary></indexterm>
<indexterm><primary>トリガ</primary></indexterm>
ドメインメンバーのマシンは、ドメインアカウントデータベース中にマシン信頼
アカウントを持つ。ドメインメンバーシップを有効にするには、おのおののマシン上で
以下の特別な手続きが必要である。この手続きは、ローカルマシンのAdministrator
アカウントによってのみ行うことが出来、これにより、ドメインマシンアカウント(もしも
存在しなければ)を作成し、そのアカウントを初期化する。クライアントが
最初にドメインにログオンすると、それがマシンアカウントのパスワード変更処理
のトリガとなり自動的に起動される。
</para>

<note><para>
<indexterm><primary>ドメインメンバー</primary></indexterm>
Sambaがドメインコントローラーとして設定されるとき、セキュアなネットワーク操作は
Microsoft Windows NT4/200x/XP Professionalクライアントがすべてドメインメンバー
として設定されることを要求する。もしもマシンがドメインのメンバーでなければ、
それはワークグループ(スタンドアロン)マシンとして操作される。ドメインメンバーシップ
に関係する情報は <link linkend="domain-member">ドメインメンバーシップ</link>
を参照してほしい。
</para></note>

<para>
以下はMicrosoft Windows NT4/200x/XPクライアントのための、Microsoft Windows
NT4スタイルとしてSamba を設定するために必要な手順である:
</para>

<itemizedlist>
	<listitem><para>基本的なTCP/IPとMicrosoft Windows ネットワークの設定。</para></listitem>
	<listitem><para>正しいサーバーの役割の指定(<smbconfoption name="security">user</smbconfoption>)。</para></listitem>
	<listitem><para>一貫性のある名前解決の設定。<footnote><para><link linkend="NetworkBrowsing">ネットワークブラウジングNetwork Browsing</link>と 
		<link linkend="integrate-ms-networks">Microsoft Windows ネットワークとSambaの統合</link>を参照。</para></footnote></para></listitem>
	<listitem><para>Windows NT4/200x/XP Professionalクライアントのためのドメインログオン。</para></listitem>
	<listitem><para>移動プロファイルの設定か、明示的にローカルプロファイルを強制使用する設定。</para></listitem>
	<listitem><para>network/systemポリシーの設定。</para></listitem>
	<listitem><para>ドメインユーザーアカウントの追加と管理。</para></listitem>
	<listitem><para>Microsoft Windows NT4/2000 ProfessionalとWindows XP Professionalクライアントマシンがドメインメンバーになるような設定。</para></listitem>
</itemizedlist>

<note><para>
<indexterm><primary>移動プロファイル</primary></indexterm>
<indexterm><primary>アカウントポリシー</primary></indexterm>
移動プロファイルとシステム/ネットワークポリシーは、高度なネットワーク管理の話題で、
このドキュメントの
<link linkend="ProfileMgmt">デスクトッププロファイル管理</link>と
<link linkend="PolicyMgmt">システムとアカウントポリシー</link>で触れられている。
しかしながら、それらはWindows NT ネットワーク
のコンセプトに関連するので、必ずしもSamba PDCに固有の説明ではない。
</para></note>

<para>
ドメインコントローラーはSMB/CIFSサーバーであって以下を行う:
</para>

<itemizedlist>
	<listitem><para>
	<indexterm><primary>NetBIOS</primary><secondary>brooadcast</secondary></indexterm>
	<indexterm><primary>WINS</primary></indexterm>
	<indexterm><primary>UDP</primary></indexterm>
	<indexterm><primary>DNS</primary></indexterm>
	<indexterm><primary>active directory</primary></indexterm>
	自分自身をドメインコントローラーとして登録し、公告する(NetBIOSブロードキャストに
	加え、UDPブロードキャスト上でのMailslotブロードキャスト、WINSサーバーへのUDPユニキャスト、
	DNSとActive Directory経由での名前登録によって)。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>NETLOGON</primary></indexterm>
	<indexterm><primary>LanMan logon サービス</primary></indexterm>
	NETLOGON サービスの提供(これは実際、複数のプロトコル上で動くサービスの集合体である。
	それらにはLanManログオンサービス、Netlogonサービス、ローカルセキュリティアカウント
	サービスとそれらのバリエーションを含む。)。
	</para></listitem>

	<listitem><para>
	NETLOGONという共有が提供される。
	</para></listitem>
</itemizedlist>

<para>
<indexterm><primary>ドメイン</primary><secondary>マスター</secondary><tertiary>ブラウザー</tertiary></indexterm>
<indexterm><primary>ローカル</primary><secondary>マスター</secondary><tertiary>ブラウザー</tertiary></indexterm>
<indexterm><primary>DMB</primary></indexterm>
<indexterm><primary>LMB</primary></indexterm>
<indexterm><primary>ブラウズリスト</primary></indexterm>
それらを提供するために Samba を設定することはむしろ容易である。おのおのの Samba
ドメインコントローラーは Samba が<smbconfoption name="domain logons"/>機能(&smb.conf;
ファイル中のパラメーター名の後に)と呼ぶ NETLOGON サービスを提供しなければな
らない。さらに、Samba ドメイン中の1つのサーバーはドメインマスターブラウザーとして
それ自身を公告しなければならない。<footnote><para><link linkend="NetworkBrowsing">
ネットワークのブラウジング</link>を参照。</para></footnote>これにより、与えられた
ドメインまたはワークグループに DMB 識別されるようなドメイン固有の NetBIOS 名
を PDC が取得することになる。ブロードキャストで分離されたサブネットの、同じドメイン
またはワークグループ上の複数のローカルマスターブラウザー (LMB) は、WAN 全体の
ブラウズリストの完全なコピーのために問い合わせを行う。
ブラウザークライアントは次にそれらの LMB に接続し、ブロードキャストで分離
されたサブネットのためのリストだけではなく、ドメイン全体のブラウズリストを受け取る。
</para>

</sect2>
</sect1>

<sect1>
<title>ドメイン制御: 設定例</title>

<para>
Samba PDCを作成するための作業の第一歩は&smb.conf;中で必要なパラメーターの
理解である。PDCとして機能するための&smb.conf;の例は以下の<link linkend="pdc-example">
PDC用のsmb.confの例</link>である。
</para>

<example id="pdc-example">
<title>PDC用のsmb.confの例</title>
<smbconfblock>
<smbconfsection name="[global]"/>
<smbconfoption name="netbios name"><replaceable>BELERIAND</replaceable></smbconfoption>
<smbconfoption name="workgroup"><replaceable>&example.workgroup;</replaceable></smbconfoption>
<smbconfoption name="passdb backend">tdbsam</smbconfoption>
<smbconfoption name="security">user</smbconfoption>
<smbconfoption name="domain logons">yes</smbconfoption>
<smbconfoption name="logon path">\\%N\profiles\%U</smbconfoption>
<smbconfoption name="logon drive">H:</smbconfoption>
<smbconfoption name="logon home">\\homeserver\%U\winprofile</smbconfoption>
<smbconfoption name="logon script">logon.cmd</smbconfoption>

<smbconfsection name="[netlogon]"/>
<smbconfoption name="path">/var/lib/samba/netlogon</smbconfoption>
<smbconfoption name="read only">yes</smbconfoption>
<smbconfoption name="write list"><replaceable>ntadmin</replaceable></smbconfoption>

<smbconfsection name="[profiles]"/>
<smbconfoption name="path">/var/lib/samba/profiles</smbconfoption>
<smbconfoption name="read only">no</smbconfoption>
<smbconfoption name="create mask">0600</smbconfoption>
<smbconfoption name="directory mask">0700</smbconfoption>
</smbconfblock>
</example>

<para>
<link linkend="pdc-example">上記の例</link>中で示される基本的なオプションの説明は以下の通り:
</para>

<variablelist>
	<varlistentry><term>passdb backend </term>
		<listitem><para>
		<indexterm><primary>グループ</primary><secondary>アカウント</secondary></indexterm>
		<indexterm><primary>smbpasswd</primary></indexterm>
		<indexterm><primary>tdbsam</primary></indexterm>
		<indexterm><primary>ldapsam</primary></indexterm>
		<indexterm><primary>guest</primary></indexterm>
		<indexterm><primary>default accounts</primary></indexterm>
		ここにすべてのユーザーとグループアカウント情報が含まれている。PDCで使える値は:
		<emphasis>smbpasswd, tdbsamとldapsam</emphasis>である。<quote>guest</quote>
		エントリは既定値のアカウントを提供し、それは既定値で含まれている;明示的に
		追加する必要はない。
		</para>

		<para>
		<indexterm><primary>passdb backend</primary></indexterm>
		<indexterm><primary>distributed</primary></indexterm>
		<indexterm><primary>smbpasswd</primary></indexterm>
		<indexterm><primary>tdbsam</primary></indexterm>
		BDCを使う場合、passdb backendを配信するために論理的な唯一の選択肢は
		LDAPを使うことである。tdbsamとsmbpasswdファイルは効果的に配信できないため、それを
		使うべきではない。
		</para></listitem>
	</varlistentry>

	<varlistentry><term>ドメイン管理パラメーター</term>
		<listitem><para>
		<indexterm><primary>network</primary><secondary>logon</secondary></indexterm>
		パラメーター<emphasis>domain logons</emphasis>はドメイン
		管理とネットワークログオンのサポートを確実にするために中心的な役割を演じる。
		</para></listitem>
	</varlistentry>

	<varlistentry><term>環境パラメーター</term>
		<listitem><para>
		<indexterm><primary>logon path</primary></indexterm>
		<indexterm><primary>logon home</primary></indexterm>
		<indexterm><primary>logon drive</primary></indexterm>
		<indexterm><primary>logon script</primary></indexterm>
		パラメーター<emphasis>logon path, logon home, logon drive</emphasis>と<emphasis>logon script</emphasis>
		は環境サポートの設定で、クライアントログオン操作機能を支援し、ネットワーク管理の
		間接費用を軽減するための、自動コントロール機能の提供するものである。
		それらのパラメーターに関しては、マニュアルページの情報を参照してほしい。
		</para></listitem>
	</varlistentry>

	<varlistentry><term>NETLOGON共有</term>
		<listitem><para>
		<indexterm><primary>NETLOGON</primary></indexterm>
		<indexterm><primary>logon処理</primary></indexterm>
		<indexterm><primary>ドメインログオン</primary></indexterm>
		<indexterm><primary>ドメインメンバーシップ</primary></indexterm>
		<indexterm><primary>グループポリシー</primary></indexterm>
		<indexterm><primary>NTConfig.POL</primary></indexterm>
		NETLOGON共有はドメインログオンとドメインメンバーシップサポートで中心的な役割を演じる。
		この共有はすべてのMicrosoftドメインコントローラー上で提供される。これは、ログオン処理のために
		必要となるかもしれない他の共通ツールを見つけるのと同じように、ログオンスクリプト
		の提供と、グループポリシーファイル(NTConfig.POL)の格納のために使われる。これは、
		ドメインコントローラー上で不可欠な共有である。
		</para></listitem>
	</varlistentry>

	<varlistentry><term>PROFILE共有</term>
		<listitem><para>
		<indexterm><primary>デスクトッププロファイル</primary></indexterm>
		<indexterm><primary>VFS</primary></indexterm>
		<indexterm><primary>fake_permissions</primary></indexterm>
		<indexterm><primary>プロファイル</primary></indexterm>
		<indexterm><primary></primary></indexterm>
		この共有はユーザーのデスクトッププロファイルを格納するために使われる。各ユーザー
		はディレクトリの root にこの共有を持たねばならない。このディレクトリはユーザーが
		書き込み可能で、グローバルに読み込み可能でなければならない。Samba は
		<quote>fake_permissions</quote>と呼ばれる、この共有上にインストール可能な
		VFS モジュールを用意している。これは Samba の管理者が、全員に対してこのディレクトリを
		読み込みのみにすることを許可する。もちろん、これはプロファイルが適した形で作成された
		後に行ってのみ有効である。
		</para></listitem>
	</varlistentry>
</variablelist>

<note><para>
上記のパラメーターが、サーバーの動作モードを決めるパラメーターの一式であると思って良い。
&smb.conf;パラメーターのうち必須のものを以下に列挙する:
</para>

<para>
<smbconfblock>
<smbconfoption name="netbios name">BELERIAND</smbconfoption>
<smbconfoption name="workgroup">&example.workgroup;</smbconfoption>
<smbconfoption name="domain logons">Yes</smbconfoption>
<smbconfoption name="security">User</smbconfoption>
</smbconfblock>
</para>

<para>
この節中にある、長いリスト中で示されている追加のパラメーターは、より完全な
説明のためのものである。
</para></note>

</sect1>

<sect1>
<title>SambaによるADSドメイン制御</title>

<para>
<indexterm><primary>active directory</primary></indexterm>
Samba-4はActive Directoryサーバーとしても動作する。これは完全に
Active DirectoryのPDCとして機能する。いくつかのActive Directory
ドメインコントローラーの機能用プロトコルも実装されている。
</para>

<para>
<indexterm><primary>ドメインコントローラー</primary></indexterm>
<indexterm><primary>active directory</primary></indexterm>
<indexterm><primary>classic domain support</primary></indexterm>
たしかに、Samba-4はMicrosoft Windows NT4スタイルのドメインコントローラーが持つ
大部分の機能を提供するように設計されている。Samba-4にはWindows NT4の全ての
機能があるわけではないが、一方Windows NT4 ドメインコントローラーにはない
多くのの特徴を持っている。これが、<emphasis>旧来のドメイン</emphasis>コントローラー
と呼ぶ理由である。端的に言えば、このモードでSamba-4が動く場合にはNT4ではなく、
Active Directoryドメインコントロールとしての観点からは、異なった機能となる。
</para>

</sect1>

<sect1>
<title>ドメインとネットワークログインの設定</title>

<para>
<indexterm><primary>ドメインログオン</primary></indexterm>
ネットワークとドメインのログオンについて、ここで言及するのは、ドメインコントローラー
が提供する本質的な機能の欠かせない部分だからである。
</para>

<sect2>
<title>ドメインネットワークログオンサービス</title>

<para>
<indexterm><primary>ドメインログオン</primary></indexterm>
すべてのドメインコントローラーはネットログオンサービスを動かさなければ
ならない(Samba中での<emphasis>ドメインログオン</emphasis>)。
1つのドメインコントローラーは
<smbconfoption name="domain master"></smbconfoption>(PDC)なしで設定
されなければならない;すべてのBDCではパラメーターを
<smbconfoption name="domain master">No</smbconfoption>と設定しなければならない。
</para>

<sect3>
<title>設定例</title>

<example id="PDC-config">
<title>PDCにするためのsmb.conf</title>
<smbconfblock>
<smbconfsection name="[global]"/>
<smbconfoption name="domain logons">Yes</smbconfoption>
<smbconfoption name="domain master">(PDCなら省略, BDCならNo)</smbconfoption>

<smbconfsection name="[netlogon]"/>
<smbconfoption name="comment">Network Logon Service</smbconfoption>
<smbconfoption name="path">/var/lib/samba/netlogon</smbconfoption>
<smbconfoption name="guest ok">Yes</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>
</smbconfblock>
</example>

</sect3>
<sect3>
<title>Windows Home Editionにおける特別な例</title>

<para>
<indexterm><primary>Windows Home editions</primary></indexterm>
次のことを完全に理解してほしい:Microsoft Windows Home Editionを Microsoft 
Windows NT4またはActive Directoryドメインセキュリティに統合したいと思っても
それが出来ない。これを解決する唯一のオプションは、Microsoft 
Windows Home EditionからMicrosoft Windows Professional への
アップグレードを購入することである。
</para>

<note><para>
Microsoft Windows Home Editionはどのようなタイプのドメインセキュリティ
機能に参加する能力は持っていない。Microsoft Windows 9x/Meと異なり、
Microsoft Windows Home Edition はネットワークにログオンする機能を
完全に欠いている。
</para></note>

<para>
このことは前にも説明したが、この事について、Sambaチームの誰かに
質問を問い合わせたり、メーリングリストに質問を投げないでほしい。なぜなら
「出来ないから」である。それが出来るとなると、それはMicrosoftとの間のライセンス
に違反することになるので、それをしないことを推奨する。
</para>

</sect3>

</sect2>

<sect2>
<title>セキュリティモードとマスターブラウザー</title>

<para>
<indexterm><primary>security mode</primary></indexterm>
<indexterm><primary>user-mode security</primary></indexterm>
<indexterm><primary>share-mode security</primary></indexterm>
わかりにくい点が残らないように、最後に幾つかコメントを記述する。
userモード以外でのセキュリティモードの時に、Sambaをドメインコントローラーと
して設定してもよいかについては、さまざまな議論があった。技術的な理由で
うまくいかないセキュリティモードは、share モードのセキュリティのみである。
domainモードとserver モードのセキュリティは、実際にはSMBのuserレベルの
セキュリティの変形のようなものである。
</para>

<para>
<indexterm><primary>DOMAIN&lt;1C&gt;</primary></indexterm>
<indexterm><primary>DOMAIN&lt;1B&gt;</primary></indexterm>
<indexterm><primary>DMB</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>NetBIOS名</primary></indexterm>
<indexterm><primary>ドメインコントローラー</primary></indexterm>
<indexterm><primary>election</primary></indexterm>
この問題は、Samba がドメインコントローラーとして機能しているときに、
そのワークグループのドメインマスターブラウザーでなければならないかという
議論と密接に関連している。
純粋なMicrosoft Windows NTドメイン中では、PDCはDMBになるために選択に勝ち、
次に、DOMAIN&lt;1B&gt;というNetBIOS名を登録する。これはWindowsクライアントが
DOMAIN&lt;1C&gt;名を探すためにネットワークログオンサーバー見つけるときに使う
名前である。DMBはドメインマスターブラウザーである。&smbmdash;
<link linkend="NetworkBrowsing">ネットワークブラウジングの章</link>、
<link linkend="DMB">WORKGROUPブラウジングの設定</link>を参照のこと。
この問題も議論に密接に結びついている。
Microsoft PDC はDMBになるためにelectionに勝つことを期待するが、もしも
勝てない場合、electionはDMBになるためのelectionに負けたという内容を
Windowsイベントロガー(訳注:イベントビューワ?)に、警告メッセージを
短い間隔で連続して出力する。この理由のため、SambaサーバーがPDCである
ネットワーク中では、SambaドメインコントローラーをDMBとして設定するのが
賢いやり方である。
</para>

<note><para>
<indexterm><primary>DOMAIN&lt;1D&gt;</primary></indexterm>
<indexterm><primary>動機</primary></indexterm>
<indexterm><primary>ドメイン制御</primary></indexterm>
<indexterm><primary>ブラウズリスト管理</primary></indexterm>
<indexterm><primary>ネットワーク</primary><secondary>ログオン</secondary><tertiary></tertiary></indexterm>
DOMAIN&lt;1C&gt;名を登録するSMB/CIFSサーバーは、ネットワークログオン
サービスを提供するのでそのように処理する。DOMAIN&lt;1B&gt;名を
登録するサーバーはDMBである&smbmdash;すなわち、DOMAIN&lt;1D&gt;名
を登録されたすべてのマシンを含んでのブラウズリスト同期の責任を
持つと言うことである。後者は、存在しているローカルネットワーク
セグメントで、すべてのNetBIOS名の登録監視に責任があるLMBである。
ネットワークログオンサービス(NETLOGON)はドメイン制御に関連して
いているが、ネットワークブラウジングとブラウズリスト管理には関係
していない。1Cと1B/1Dの名前サービスはお互いに無関係である。
</para></note>

<para>
<smbconfoption name="security">user</smbconfoption>以外のモードで
Sambaドメインコントローラーを使うための設定の問題に戻ろう。
ユーザーからの接続要求を検証するためにSambaホストが他のSMBサーバーかドメイン
コントローラーを使うように設定した場合、ネットワーク上の他のマシン
(<smbconfoption name="password server"/>)は、Sambaホストよりもより
詳しくユーザーについて知っているという状況になる。99％のケースで、
この別のホストはドメインコントローラーである。ドメインモードセキュリティ
で動作している場合、<smbconfoption name="workgroup"/>パラメーター
は(すでにドメインコントローラーが持っている)Windows NTドメインの名前に
設定しれなければならない。もしもそのドメインがドメインコントローラー
をまだ持っていない場合、ドメイン自体がないのと同じである。
</para>

<para>
すでに定義上PDCを持つドメイン用にSambaサーバーをドメインコントローラーとして
設定することは問題を発生させる。それゆえ、そのドメインに対してDMBになるようにと
<smbconfoption name="security">user</smbconfoption>を設定するようにSamba
ドメインコントローラーをいつでも設定すべきである。この方法のみが公式にサポート
される操作モードである。
</para>

</sect2>

</sect1>

<sect1>
<title>よくあるエラー</title>

<sect2>
<title><quote>$</quote>マシン名中に$を含められない</title>

<para>
<indexterm><primary>BSD</primary></indexterm>
<indexterm><primary>FreeBSD</primary></indexterm>
<indexterm><primary>/etc/passwd</primary></indexterm>
通常<filename>/etc/passwd</filename>に格納されるマシンアカウントは、マシン名に
<quote>$</quote>を追加した形である。いくつかのBSDシステムはユーザー名
に<quote>$</quote>を使うものが作成できない。最近のFreeBSDのバージョンはこの
制限が取り払われたが、それより古いものはまだ使われている。
</para>

<para>
<indexterm><primary>vipw</primary></indexterm>
問題はエントリを作る時に使われるプログラム中のみである。一度作成されると
問題なく動作する。まず<quote>$</quote>なしでユーザー名を作る。次に、エントリを
編集するために <command>vipw</command>を使い<quote>$</quote>を追加する。
あるいは、最初からエントリをvipwで作っても良い。その際には固有のユーザーログインIDを使うように
すること。
</para>

<note><para>マシンアカウントはワークステーションが持つ名前と同じ名前でなければならない。</para></note>

<note><para>
UNIXのツール<command>vipw</command>は直接<filename>/etc/passwd</filename>を修正
する共通的なツールである。vipwを使うと(もしも使われているならば)shadowファイルが
パスワードファイルと同じになることを保証する。これはセキュリティの観点から重要
である。
</para></note>

</sect2>

<sect2>
<title>存在するマシンアカウントがあるためにドメイン参加に失敗する</title>
		
<para>
<indexterm><primary>ドメインへの参加</primary></indexterm>
<quote>I get told,マシン信頼アカウント作成時に `You already have a connection to the Domain....'
(既にドメインへの接続があります。) か
`Cannot join domain, the credentials supplied conflict with an existing set...'
(ドメインに参加できません。信用情報が既存のものと一致しません)
が出ることについては以前に話した。</quote>
</para>

<para>
これは、そのマシン自身からマシン信頼アカウントの作成を使用としたとき、
Samba PDC上の共有(かIPC$)にすでに接続している(つまりマップされたドライブ)
がある時に起きる。以下のコマンドはすべてのネットワークドライブ接続を切断する:
<screen>
&dosprompt;<userinput>net use * /d</userinput>
</screen>
これはすべてのネットワーク接続を切る。
</para>

<para>
さらに、もしもマシンがすでに参加済みのドメインと同じ名前の
<quote>workgroupのメンバー</quote>ならば(これはやってはいけない)、このメッセージが出る。
ワークグループを何か別の名前に変えて&smbmdash;再起動し、&smbmdash;
もう一度やってみる。
</para>

</sect2>

<sect2>
<title>システムにログオンできない(C000019B)</title>

<para><quote>
ドメイン参加に成功したが、Sambaのバージョンを新しくした後、ログオン時に
<errorname>`The system cannot log you on (C000019B). Please try again or consult your system
administrator
(システムはあなたのログオンを許可できません(C000019B)。後ほど再試行するか、システム管理者に相談してログオンしてください)
</errorname>というメッセージが出た。'</quote>
</para>

<para>
<indexterm><primary>SID</primary></indexterm>
これはsecrets.tdbに格納されているドメインSIDが変わったことによって引き
起こされるものである。ドメインSIDが変わるよくある理由は、ドメイン名
かサーバー名(NetBIOS名)が変わったことである。問題を解決する唯一の方法は
オリジナルのドメインSIDに戻すか、クライアントをいったんドメインから
削除して再参加することである。ドメインSIDは、netまたはrpcclient
ユーティリティによってリセットすることも出来る。
</para>

<para>
ドメインSIDをリセットしたり、変更するには、以下のようにnetコマンドを
使用する:

<screen>
&rootprompt;<userinput>net getlocalsid 'OLDNAME'</userinput>
&rootprompt;<userinput>net setlocalsid 'SID'</userinput>
</screen>
</para>

<para>
ワークステーションのマシン信頼アカウントはドメイン(またはネットワーク)
SIDでのみ動作する。このSIDが変更されると、ドメイン
メンバー(ワークステーション)はドメインにログオンできない。オリジナルの
ドメインSIDはsecrets.tdbファイルから復元できる。別の解は、おのおのの
ワークステーションが再度ドメインに参加することである。
</para>

</sect2>

<sect2>
<title>マシン信頼アカウントがアクセスできない</title>

<para>
<quote>ドメインに参加しようとした時 <errorname>"The machine account 
for this computer either does not exist or is not accessible
(このコンピューターのマシン・アカウントは存在しないか、アクセスできません) 
</errorname>."
というメッセージが出た。何が悪い?</quote>
</para>

<para>
この問題は、PDCが適切なマシン信頼アカウントを持っていないことに起因
する。アカウント作成時に
<smbconfoption name="add machine script"/>という方法を使った場合、
このメッセージは、アカウント作成に失敗したことを示している。ドメイン管理ユーザー
のシステムが
動作しているかを確認して正常動作するようにすること。
</para>

<para>
かわりに、手動でアカウントエントリを作成していた場合、正しく作られていない
ということである。Samba PDC上で<filename>smbpasswd</filename>ファイル
中のマシン信頼アカウントのエントリが正しく出来たかどうかを確認する。もしも、
smbpasswd ユーティリティを使わないでアカウントをエディターで追加した場合、
アカウント名をマシンの NetBIOS名 に<quote>$</quote>を追加して(すなわち、
computer_name$)おくこと。これは SambaSAMAccount バックエンドと同じように
POSIX UNIX システムアカウントバックエンドの両方の中に存在する必要がある。
Samba におけるバックエンドの既定値(すなわち、パラメーター
<parameter>passdb backend</parameter>)は &smb.conf; ファイル中で指定されて
おらず、また、もしも指定されているものが<literal>smbpasswd</literal>
だった場合、それらはそれぞれ<filename>/etc/passwd</filename>と
<filename>/etc/samba/smbpasswd</filename>(あるいはもしも Samba チームの
既定値の設定を使ってコンパイルした場合は
<filename>/usr/local/samba/lib/private/smbpasswd</filename>)である。
<filename>/etc/passwd</filename>の使用は NSS <filename>/etc/nsswitch.conf</filename>
ファイル中の別の設定で上書きすることが出来る。
</para>

<para>
SambaサーバーとNTクライアントの間のサブネットマスクの不一致により、この問題が起こると
いう報告も一部から上がっている。クライアントとサーバー両方で整合性
を取るようにすること。
</para>
</sect2>

<sect2>
<title>アカウントが無効</title>

<para><quote>NT4/W200xワークステーションからSambaドメインにログオンしようとした
とき、アカウントが無効になっているメッセージが出た。</quote></para>

<para>
<userinput>smbpasswd -e <replaceable>username</replaceable>でユーザーアカウントを有効化する
</userinput>。これは通常アカウント作成時に行われる。
</para>

</sect2>

<sect2>
<title>ドメインコントローラーが無効</title>
		
<para><quote>Sambaが開始してから数分間、クライアントがエラー`Domain Controller Unavailable'
(ドメイン・コントローラーが使えません。)を表示する。</quote></para>

<para>
ドメインコントローラーはネットワーク上にその役割をアナウンスする。これは通常しばらくかかる。最低15分は待ち、
再度試してみること。
</para>
</sect2>

<sect2>
<title>ドメイン参加後ドメインメンバーワークステーションにログオンできない</title>

<para>
<indexterm><primary>schannel</primary></indexterm>
<indexterm><primary>signing</primary></indexterm>
ドメイン参加成功後、2つのメッセージのうちの1つが出てユーザーログオンに失敗する:
1つはドメインコントローラーが見つからないというもので、もう1つはアカウントが
ドメインにないか、パスワードが違うというものである。これは、<emphasis>schannel</emphasis>
(セキュアchannel)の設定か、<emphasis>smb 署名</emphasis>の設定について、
Windows クライアントとSamba サーバー間で、設定の不一致によるものと考えられる。
以下を実行して、Samba の
<emphasis>client schannel</emphasis>、<emphasis>server schannel</emphasis>、
<emphasis>client signing</emphasis>、<emphasis>server signing</emphasis>の設定と
それらの値について確認すること:
<screen>
<command>testparm -v | grep channel</command>
</screen>
</para>

<para>
また、MMC &smbmdash; ローカルセキュリティの設定を使うこと。このツールはコントロール
パネルにある。ポリシーの設定は、ローカルポリシー/セキュリティオプション領域にあり、
<emphasis>Secure Channel:..., and Digitally sign...(セキュリティチャネル、 デジタル的に署名)</emphasis>
という言葉を含んだ項目で設定する。

</para>

<para>
これらが Samba サーバー設定と一致した設定になっていることが大切である。
</para>

</sect2>

</sect1>
</chapter>
