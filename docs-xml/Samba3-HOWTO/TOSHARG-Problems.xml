<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<chapter id="problems">

<chapterinfo>
	&author.jerry;
	&author.jelmer;
	&author.dbannon;
	&author.danshearer;
	<pubdate>8 Apr 2003</pubdate>
</chapterinfo>

<title>Sambaの問題の調査と解決方法</title>

<para>
<indexterm><primary>RFCs</primary></indexterm>
<indexterm><primary>SMB</primary></indexterm>
<indexterm><primary>documentation</primary></indexterm>
メーリングリスト、RFCやドキュメントのような形で、数多くの情報源が存在している。Sambaの
配布物に由来するドキュメントには、ブラウジングのような一般的なSMBのトピックについての
良い説明が含まれている。
</para> 
	
<sect1>
<title>診断ツール</title>

<para>
<indexterm><primary>sniffer</primary></indexterm>
<indexterm><primary>LAN</primary></indexterm>
<indexterm><primary>データの解析</primary></indexterm>
<indexterm><primary>SMB ネットワーキング</primary></indexterm>
<indexterm><primary>ネットワークアナライザ</primary></indexterm>
SMBネットワーキングにおいて、特定の問題について、何が原因かと言うことが、簡単に
分からないことがよくある。Sambaそれ自身はむしろ役立つ情報を提供するが、いくつかの
例では、<emphasis>sniffer</emphasis>を使った方がよいかもしれない。snifferは
LANをモニタし、そこに送信されているデータを解析し、画面上に表示するプログラムである。
</para>

<sect2>
<title>Sambaそれ自身によるデバッグ</title>

<para>
<indexterm><primary>診断ツール</primary></indexterm>
<indexterm><primary>問題のデバッグ</primary></indexterm>
<indexterm><primary>smbd</primary></indexterm>
<indexterm><primary>nmbd</primary></indexterm>
<indexterm><primary>パスワードのデバッグ</primary></indexterm>
<indexterm><primary>debug level</primary></indexterm>
<indexterm><primary>log level</primary></indexterm>
問題をデバッグするための最も良い診断ツールの1つは、Sambaそれ自身である。動作するときの、
<smbconfoption name="debug level"/>を、&smbd;と&nmbd;両方に指定する、
<option>-d オプション</option>が使える。<command>smbd, nmbd</command>と&smb.conf;の
マニュアルページに、デバッギングオプションに関連するより詳細な情報があるので参照すること。
debug level(log level)は1(既定値)から10までを指定できる(100はパスワードデバッグ用)。
</para>
	
<para>
<indexterm><primary>デバッギング</primary></indexterm>
<indexterm><primary>gcc</primary></indexterm>
<indexterm><primary>gdb</primary></indexterm>
<indexterm><primary>smbd</primary></indexterm>
<indexterm><primary>nmbd</primary></indexterm>
<indexterm><primary>LsaEnumTrustedDomains</primary></indexterm>
<indexterm><primary>attach gdb</primary></indexterm>
別の、デバッギングに便利な方法は、<command>gcc -g </command>フラグ付きでSambaをコンパイル
することである。これは、バイナリ中にデバッグ情報を埋め込み、動作中の
<command>smbd/nmbd</command>プロセスに<command>gdb</command>がアタッチできるようにする。
NTワークステーション向けに、ある<command>smbd</command>プロセスに<command>gdb</command>を
アタッチするためには、最初にワークステーションとの接続を確立する。
<parameter>LsaEnumTrustedDomains</parameter>を生成するのに、ctrl-alt-deleteを
押し、ドメインログオン画面を表示すれば(少なくとも、最初にドメインに参加しておく)
十分である。その後、ワークステーションは開いているコネクションを維持し、smbdプロセスが
走り出す(短い、smbdのアイドルタイムアウトを設定していないと仮定する)。
<command>ctrl-alt-delete</command>を押してからパスワードを実際に入力するまでの間に、
<command>gdb</command>をアタッチでき、そのあと継続できる。
</para>

<para>
調べてみる価値のある便利なSambaのコマンドのいくつかは以下の通り:
<indexterm><primary>testparm</primary></indexterm>
<indexterm><primary>smbclient</primary></indexterm>
<screen>
&prompt;<userinput>testparm | more</userinput>
&prompt;<userinput>smbclient -L //{サーバのnetbios名}</userinput>
</screen>
</para>

</sect2>

<sect2>
	<title>Tcpdump</title>
  
<para>
<indexterm><primary>tcpdump</primary></indexterm>
<indexterm><primary>tethereal</primary></indexterm>
<indexterm><primary>ethereal</primary></indexterm>
<ulink url="http://www.tcpdump.org/">Tcpdump</ulink>はSMBをサポートした最初の
UNIX上でのsnifferである。これはコマンドラインユーティリティで、現在、そのSMB
サポートは、<command>ethereal</command>や<command>tethereal</command>よりは
若干遅れている。
</para>

</sect2>

<sect2>
	<title>Ethereal</title>

<para>
<indexterm><primary>ethereal</primary></indexterm>
<ulink url="http://www.ethereal.com/">Ethereal</ulink>は、GUIのsnifferで、UNIX(Gtk)
とWindows両方で使える。EtherealのSMBサポートはとても良い。<command>ethereal</command>の
使用法の詳細は、良くできているEthereal User Guideを読むこと。
</para>

<figure id="ethereal1"><title>キャプチャの開始</title><imagefile>ethereal1</imagefile></figure>

<para>
<indexterm><primary>ports</primary></indexterm>
ポート137,138,139,445をリッスン。例えば、<link linkend="ethereal1">キャプチャの開始</link>
画面であるように、<userinput>port 137, port 138,port 139,か port 445</userinput>を
フィルタとして使う。
</para>

<para>
<command>tethereal</command>という名前のコンソールバージョンのecherealもある。
</para>

<figure id="ethereal2"><title>Etherealメインデータウィンドウ</title><imagefile>ethereal2</imagefile></figure>

</sect2>

<sect2>
<title>Windowsのネットワークモニタ</title>
	
<para>
<indexterm><primary>ネットワークモニタ</primary></indexterm>
<indexterm><primary>Netmon</primary></indexterm>
<indexterm><primary>Microsoft Developer Network CD</primary></indexterm>
<indexterm><primary>SMS</primary></indexterm>
<indexterm><primary>promiscuous mode</primary></indexterm>
<indexterm><primary>ethereal</primary></indexterm>
Microsoft Windows NT上での同等品は、ネットワークモニタ(Netmonとして知られる)が、
Microsoft Developer Network CD、Windows NTサーバインストールCDとSMSのCD中ににある。
SMSに同梱されているnetmonは任意の2つのコンピュータ間のパケットをダンプできる(すなわち、
ネットワークインタフェースをpromiscuousモードにする)。NTサーバインストールCDに同梱
されているものは、ローカルのNTマシンに直接来るネットワークトラフィックとローカルな
サブネットのブロードキャストのみモニタできる。etherealはnetmon形式のファイルを読み書き
出来る事に注意。
</para>

<sect3>
<title>NTワークステーション上へのネットワークモニタのインストール</title>

<para>
<indexterm><primary>Netmon.</primary></indexterm>
Installing Netmon on an NT workstation requires a couple of steps. The following are instructions for
installing Netmon V4.00.349, which comes with Microsoft Windows NT Server 4.0, on Microsoft Windows NT
Workstation 4.0. The process should be similar for other versions of Windows NT version of Netmon. You will
need both the Microsoft Windows NT Server 4.0 Install CD and the Workstation 4.0 Install CD.
</para> 

<para>
<indexterm><primary>Network Monitor Tools and Agent</primary></indexterm>
Initially you will need to install <application>Network Monitor Tools and Agent</application>
on the NT Server to do this: 
</para>

<itemizedlist>
	<listitem><para>Go to <guibutton>Start</guibutton> -> <guibutton>Settings</guibutton> -> <guibutton>Control Panel</guibutton> -> 
	<guibutton>Network</guibutton> -> <guibutton>Services</guibutton> -> <guibutton>Add</guibutton>.</para></listitem>
	
	<listitem><para>Select the <guilabel>Network Monitor Tools and Agent</guilabel> and click on <guibutton>OK</guibutton>.</para></listitem> 
	
	<listitem><para>Click on <guibutton>OK</guibutton> on the Network Control Panel.</para></listitem> 
	
	<listitem><para>Insert the Windows NT Server 4.0 install CD when prompted.</para></listitem> 
</itemizedlist>

<para>
At this point, the Netmon files should exist in <filename>%SYSTEMROOT%\System32\netmon\*.*</filename>.   
Two subdirectories exist as well: <filename>parsers\</filename>, which contains the necessary DLLs
for parsing the Netmon packet dump, and <filename>captures\</filename>.
</para>

<para>
To install the Netmon tools on an NT Workstation, you will first need to install the 
Network  Monitor Agent from the Workstation install CD.
</para>

<itemizedlist>
	<listitem><para>Go to <guibutton>Start</guibutton> -> <guibutton>Settings</guibutton> ->
		<guibutton>Control Panel</guibutton> -> <guibutton>Network</guibutton> ->
		<guibutton>Services</guibutton> -> <guibutton>Add</guibutton>.</para></listitem> 

	<listitem><para>Select the <guilabel>Network Monitor Agent</guilabel>, click on
		<guibutton>OK</guibutton>.</para></listitem> 
	
	<listitem><para>Click on <guibutton>OK</guibutton> in the Network Control Panel.
	</para></listitem> 
	
	<listitem><para>Insert the Windows NT Workstation 4.0 install CD when prompted.</para></listitem> 
</itemizedlist>

<para>
Now copy the files from the NT Server in <filename>%SYSTEMROOT%\System32\netmon</filename>
to <filename>%SYSTEMROOT%\System32\netmon</filename> on the workstation and set permissions
as you deem appropriate for your site. You will need administrative rights on the NT box to run Netmon.
</para>

</sect3>
<sect3>
<title>Installing Network Monitor on Windows 9x/Me</title>
<para>
To install Netmon on Windows 9x/Me, install the Network Monitor Agent 
from the Windows 9x/Me CD (<filename>\admin\nettools\netmon</filename>). 
There is a readme file included with the Netmon driver files on the CD if you need 
information on how to do this. Copy the files from a working Netmon installation.
</para>
</sect3>
</sect2>
</sect1>

<sect1>
<title>Useful URLs</title>
<itemizedlist>

<listitem><para>See how Scott Merrill simulates a BDC behavior at 
       <ulink noescape="1" url="http://www.skippy.net/linux/smb-howto.html">
       http://www.skippy.net/linux/smb-howto.html</ulink>. </para></listitem>

<listitem><para>FTP site for older SMB specs, 
       <ulink noescape="1" url="ftp://ftp.microsoft.com/developr/drg/CIFS/">
       ftp://ftp.microsoft.com/developr/drg/CIFS/</ulink></para></listitem>.

</itemizedlist>

</sect1>

<sect1>
<title>Getting Mailing List Help</title>

<para>
There are a number of Samba-related mailing lists. Go to <ulink 
noescape="1" url="http://samba.org">http://samba.org</ulink>, click on your nearest mirror,
and then click on <command>Support</command>. Next, click on <command>
Samba-related mailing lists</command>.
</para>

<para>
For questions relating to Samba TNG, go to
<ulink noescape="1" url="http://www.samba-tng.org/">http://www.samba-tng.org/</ulink>. 
It has been requested that you do not post questions about Samba-TNG to the
mainstream Samba lists.</para>

<para>
If you do post a message to one of the lists, please observe the following guidelines:
</para>

<itemizedlist>

	<listitem><para>
<indexterm><primary>volunteers</primary></indexterm>
	Always remember that the developers are volunteers; they are
	not paid and they never guarantee to produce a particular feature at 
	a particular time. Any timelines are <quote>best guess,</quote> and nothing more.
	</para></listitem>

	<listitem><para>
<indexterm><primary>PDC</primary></indexterm>
	Always mention what version of Samba you are using and what 
	operating system it's running under. You should list the relevant sections of
	your &smb.conf; file, at least the options in <smbconfsection name="[global]"/>
	that affect PDC support.
	</para></listitem>

	<listitem><para>In addition to the version, if you obtained Samba via
	CVS, mention the date when you last checked it out.</para></listitem>

	<listitem><para> Try to make your questions clear and brief. Lots of long, 
	convoluted questions get deleted before	they are completely read!
	Do not post HTML-encoded messages. Most people on mailing lists simply delete
	them.
	</para></listitem>

	<listitem><para> If you run one of those nifty <quote>I'm on holiday</quote> things when
	you are away, make sure its configured to not answer mailing list traffic. Autoresponses
	to mailing lists really irritate the thousands of people who end up having to deal
	with such bad netiquet bahavior.
	</para></listitem> 

	<listitem><para>
<indexterm><primary>cross post</primary></indexterm>
	Don't cross post. Work out which is the best list to post to 
	and see what happens. Do not post to both samba-ntdom and samba-technical.
	Many people active on the lists subscribe to more 
	than one list and get annoyed to see the same message two or more times.
	Often someone who thinks a message would be better dealt 
	with on another list will forward it on for you.</para></listitem>

	<listitem><para>You might include <emphasis>partial</emphasis>
	log files written at a log level set to as much as 20. 
	Please do not send the entire log but just enough to give the context of the
	error messages.</para></listitem>

	<listitem><para>If you have a complete Netmon trace (from the opening of
	the pipe to the error), you can send the *.CAP file as well.</para></listitem> 
	    
	<listitem><para>Please think carefully before attaching a document to an email.
	Consider pasting the relevant parts into the body of the message. The Samba
	mailing lists go to a huge number of people. Do they all need a copy of your 
	&smb.conf; in their attach directory?</para></listitem>

</itemizedlist>

</sect1>

<sect1>
<title>How to Get Off the Mailing Lists</title>

<para>To have your name removed from a Samba mailing list, go to the same
place where you went to
subscribe to it, go to <ulink noescape="1" url="http://lists.samba.org/">http://lists.samba.org</ulink>, 
click on your nearest mirror, click on <command>Support</command>, and 
then click on <command>Samba-related mailing lists</command>. 
</para>

<para>
Please do not post messages to the list asking to be removed. You will only
be referred to the above address (unless that process failed in some way).
</para>

</sect1>

</chapter>
