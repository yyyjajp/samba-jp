<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<chapter id="domain-member">

<chapterinfo>
	&author.jht;
	&author.jeremy;
	&author.jerry;
	&author.tridge;
	&author.jelmer;
	<author>&person.gd;<contrib>LDAP updates</contrib></author>
</chapterinfo>

<title>ドメインメンバシップ</title>

<para>
<indexterm><primary>ドメインメンバ</primary></indexterm>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
<indexterm><primary>ドメインセキュリティ</primary></indexterm>
ドメインメンバシップはきわめて重要な事項である。Sambaは
Microsoftドメインセキュリティコンテキスト中においてメンバサーバとして
参加できねばならず、Sambaはドメインマシンメンバ信頼アカウントを
付与できねばならない。これなしには多くのユーザに実行可能なオプション
を提供できないだろう。
</para>

<para>
<indexterm><primary>ドメインメンバシップ</primary></indexterm>
<indexterm><primary>misinformation</primary></indexterm>
この章では、ドメインメンバシップに関する背景情報、Sambaの設定と、
Microsoft Windows クライアントのドメインに参加方法について説明する。
なぜそれが必要か?なぜならば、両者とも現在のMicrosoft Windows
ネットワーキングと、特にUNIX/Linuxネットワーキング中と管理領域に関して
かなりの間違った情報、誤解があり、また知識の欠如が顕著だからである。
この章によってその欠如を埋めることを望みたい。
</para>

<sect1>
<title>機能と利便性</title>

<para>
<indexterm><primary>ドメインセキュリティ</primary></indexterm>
<indexterm><primary>シングルサインオン</primary></indexterm>
<indexterm><primary>SSO</primary></indexterm>
Microsoft Windows ワークステーションおよびサーバがドメイン
セキュリティに参加するためには、ドメインメンバにならなければならない。
ドメインセキュリティに参加することは、しばしば<emphasis>シングルサインオン</emphasis>
か短く<acronym>SSO</acronym>と呼ばれる。この章では、ワークステーション
(かあるいはもう一台の、<application>Microsoft Windows NT4/200x</application>サーバ&smbmdash;)
か、SambaサーバをMicrosoft Windowsドメインセキュリティコンテキストの
メンバにするための手順について説明する。
</para>

<para>
<indexterm><primary>native member</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>ドメイン制御</primary></indexterm>
<indexterm><primary>サーバタイプ</primary><secondary>ドメインメンバ</secondary></indexterm>
Samba-3 はNT4形式のMicrosoft Windowsドメインにネイティブなメンバサーバ
として、Microsoft Windows Active Directoryドメインにネイティブな
メンバサーバとして、あるいは、Sambaドメイン制御ネットワークに、参加
できる。ドメインメンバシップはたくさんの利点を持つ:
</para>

<itemizedlist>
	<listitem><para>
	<indexterm><primary>SAM</primary></indexterm>
	Microsoft WindowsワークステーションユーザはSSOの利点を享受できる。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>アクセス権</primary></indexterm>
	<indexterm><primary>ファイルの所有者</primary></indexterm>
	<indexterm><primary>アクセス制御</primary></indexterm>
	<indexterm><primary>SAM</primary></indexterm>
	ドメインユーザアカウントの(アクセス)権限とファイルの所有権およびアクセス制御は
	単一のドメインセキュリティアカウントマネージャ(SAM)データベース
	から設定できる(ドメインメンバであるMicrosoft Windowsワークステーション
	と同様にドメインメンバサーバで動作する)。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>ドメインメンバ</primary></indexterm>
	<indexterm><primary>ネットワークログオン</primary></indexterm>
	ドメインメンバの<application>Microsoft Windows NT4/200x/XP Professional</application>
	ワークステーションのみがネットワークログオン機能を使える。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>ドメインメンバ</primary></indexterm>
	<indexterm><primary>ポリシーファイル</primary></indexterm>
	<indexterm><primary>NTConfig.POL</primary></indexterm>
	<indexterm><primary>デスクトッププロファイル</primary></indexterm>
	ドメインメンバのワークステーションを、ポリシーファイル
	(<filename>NTConfig.POL</filename>)およびデスクトッププロファイルを使用
	してよりよく制御できる。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>ログオンスクリプト</primary></indexterm>
	<indexterm><primary>transparent access</primary></indexterm>
	<indexterm><primary>アプリケーションサーバ</primary></indexterm>
	ログオンスクリプトの使用することにより、ユーザはアプリケーションサーバ
	上のネットワークアプリケーションへ自由にアクセスできる。
	(訳注:意味はこれでよい?)。
	Through the use of logon scripts, users can be given transparent access to network
	applications that run off application servers.
	</para></listitem>

	<listitem><para>
	<indexterm><primary>ユーザアクセス管理</primary></indexterm>
	<indexterm><primary>SAM</primary></indexterm>
	<indexterm><primary>LDAP</primary></indexterm>
	<indexterm><primary>ADS</primary></indexterm>
	ネットワーク管理者は、より優れたアプリケーション管理およびユーザアクセス
	管理が可能になる。ユーザアカウントを、中央にあるドメインデータベース
	(NT4/SambaでのSAM形式ドメインか、LDAPによるディレクトリがバックエンドになった
	NT4ドメインか、Active Directory基盤経由で)以外の任意のネットワーク
	クライアントかサーバ上でユーザアカウントを保守する必要がないからである。
	</para></listitem>
</itemizedlist>

</sect1>

<sect1 id="machine-trust-accounts">
<title>MicrosoftWindowsワークステーション/サーバのマシン信頼アカウント</title>

<para>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
<indexterm><primary>認証</primary></indexterm>
<indexterm><primary>ドメインコントローラ</primary></indexterm>
<indexterm><primary>rogue user</primary></indexterm>
マシン信頼アカウントは(ユーザというよりはむしろ)クライアントマシンを
ドメインコントローラサーバに対して認証するために使われる。Windowsの用語では、
これは<quote>コンピュータアカウント</quote>として知られている。
マシン信頼アカウントの目的は、不正(訳注:rogue)ユーザとドメインコントローラ
が、共謀してドメインメンバのワークステーションにアクセスすることを
防ぐことである。
</para>

<para>
<indexterm><primary>マシン信頼アカウント</primary><secondary>パスワード</secondary></indexterm>
<indexterm><primary>shared secret</primary></indexterm>
<indexterm><primary>unauthorized</primary></indexterm>
<indexterm><primary>Windows NT/200x/XP Professional</primary></indexterm>
<indexterm><primary>Windows 9x/Me/XP Home</primary></indexterm>
マシン信頼アカウントのパスワードは、ドメインコントローラとの間で暗号化
通信を行うために共通の秘密鍵(訳注:shared secret:共通鍵?)である。
これは、同じNetBIOS名を持つ未認証マシンがドメインに参加し、ドメインセキュリティ
操作をし、ドメインユーザ/グループアカウントへアクセスすることを得ることを防ぐ
セキュリティ機能である。Windows NT/200x/XP Professionalクライアントは
マシン信頼アカウントを使うが、Windows 9x/Me/XP Homeは使わない。従って、
Windows 9x/Me/XP Homeクライアントは、マシン信頼アカウントを持たないため、
ドメインコントローラとの間で、共通の秘密鍵を持つことはなく、決してドメイン
の真のメンバにはなれない。
</para>

<para>
<indexterm><primary>Windowsレジストリ</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
Windows NT4 PDCはマシン信頼アカウントをWindowsレジストリ中に格納する。
Microsoft Windows 2000の登場と共に、Active Directoryという、
マシン信頼アカウントのための新しいリポジトリが登場した。それに対し、
Samba PDCはマシン信頼アカウントを以下のように2つの部分に分けて格納する:

<itemizedlist>
	<listitem><para>
	<indexterm><primary>ドメインセキュリティアカウント</primary></indexterm>
	<indexterm><primary>アカウント情報</primary></indexterm>
	<indexterm><primary>バックエンドデータベース</primary></indexterm>
	&smb.conf;ファイル中で設定される、ドメインセキュリティアカウントは
	<smbconfoption name="passdb backend"/>に格納される。格納される
	アカウント情報の性質は、選択されたバックエンドデータベースの
	タイプに依存する。
	</para>

	<para>
	<indexterm><primary>smbpasswd</primary></indexterm>
	<indexterm><primary>UNIX login ID</primary></indexterm>
	<indexterm><primary>UID</primary></indexterm>
	<indexterm><primary>LanMan</primary></indexterm>
	<indexterm><primary>NT形式で暗号化されたパスワード</primary></indexterm>
	<indexterm><primary>UNIXユーザ識別子</primary><see>UID</see></indexterm>
	このデータのより古い形式は<filename>smbpasswd</filename>データベースで、
	そこにはUNIXのログインID、UNIXのユーザ識別子(UID)、LanManおよびNT形式で
	暗号化されたパスワードを格納している。また、ここでは触れないが、その他
	にもいくつかの情報が入っている。
	</para>

	<para>
	<indexterm><primary>database</primary></indexterm>
	<indexterm><primary>ldapsam</primary></indexterm>
	<indexterm><primary>smbpasswd</primary></indexterm>
	<indexterm><primary>アカウント制御</primary></indexterm>
	2つのより新しいデータベースは、ldapsamとtdbsamと呼ばれる。どちらも、以前の
	<filename>smbpasswd</filename>ファイルよりもかなりより多くのデータを格納する。
	その付加情報により、新しいユーザアカウント管理の新しい方法が可能になる。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>UNIXアカウント</primary></indexterm>
	<indexterm><primary>/etc/passwd</primary></indexterm>
	対応するUNIXアカウントは通常<filename>/etc/passwd</filename>に格納される。
	UNIX ユーザアカウントを必要としないような、より簡便なオペレーションの実現
	に向けて開発中だが、この機能は Samba-3 の初期リリースまでは実装されない予定
	である(訳注:この部分は古い)。
	</para></listitem>
</itemizedlist>
</para>

<?latex \newpage ?>
<para>
<indexterm><primary>マシン信頼アカウント</primary><secondary>作成</secondary></indexterm>
マシン信頼アカウントの作成には3つの方法がある:
</para>

<itemizedlist>
	<listitem><para>
	<indexterm><primary>手動でのUNIXアカウント作成</primary></indexterm>
	UNIX/Linuxコマンド行からの手動作成。この方法では、Sambaとそれに対応する
	UNIXアカウントが手動で作成される。
	</para></listitem>

	<listitem><para>
	<indexterm><primary>サーバマネージャ</primary></indexterm>
	<indexterm><primary>Nexusツールキット</primary></indexterm>
	NT4ドメインコントローラからMicrosoft Windows NT4サーバマネージャを使うか、
	MicrosoftのWebサイトから入手可能なNexusツールキットを使う。このツールは
	ユーザが管理者アカウントでログオンしている限り、任意のMicrosoft Windows
	マシンから実行することが出来る。
	</para></listitem>
	
	<listitem><para>
	<indexterm><primary>マシン信頼アカウント</primary></indexterm>
	<indexterm><primary>参加済みのクライアント</primary></indexterm>
	
	<quote>その場での</quote>作成。Sambaマシン信頼アカウントは、
	クライアントがドメインに参加したときに、Sambaによって自動的に作成
	される(セキュリティ上、この方法が推奨される)。対応するUNIX
	アカウントは自動でも、手動ででも作成できる。
	</para></listitem>
</itemizedlist>

<para>
<indexterm><primary>enforcing</primary></indexterm>
<indexterm><primary>マシン信頼アカウント</primary><secondary>作成</secondary></indexterm>
Microsoft Windows NT4/200x/XP ProfessionalもSambaもマシン信頼アカウントを
強制する方法を提供しない。これは管理者の選択問題である。
</para>

<sect2>
<title>マシン信頼アカウントの手動作成</title>

<para>
<indexterm><primary>/etc/passwd</primary></indexterm>
<indexterm><primary></primary></indexterm>
<indexterm><primary>useradd</primary></indexterm>
<indexterm><primary>vipw</primary></indexterm>
マシン信頼アカウントの手動作成の最初の手順は、<filename>/etc/passwd</filename>
中に対応するUNIXアカウントを手動で作成することである。
この作業は、<command>vipw</command>か、通常、新規のUNIXアカウント作成時に
使われる<quote>adduser</quote>コマンドを使用する。以下は、Linux
ベースのSambaサーバにおける例である:
<screen>
&rootprompt;<userinput>/usr/sbin/useradd -g machines -d /var/lib/nobody \
   -c <replaceable>"machine nickname"</replaceable> \
   -s /bin/false <replaceable>machine_name</replaceable>$ </userinput>

&rootprompt;<userinput>passwd -l <replaceable>machine_name</replaceable>$</userinput>
</screen>
</para>

<para>
<indexterm><primary>プライマリグループ</primary></indexterm>
<indexterm><primary>GID</primary></indexterm>
<indexterm><primary>マシンアカウント</primary></indexterm>
上記の例の中では、全マシンアカウントのプライマリグループとして使われる
<quote>machines</quote>という、既存のシステムグループがある。以下の例では、
<quote>machines</quote>グループのGIDは100である。
</para>

<para>
<indexterm><primary>chpass</primary></indexterm>
<indexterm><primary>BSD</primary></indexterm>
*BSDシステム上では、この作業は<command>chpass</command>ユーティリティを使うこと
もできる:
<screen>
&rootprompt;<userinput>chpass -a \
'<replaceable>machine_name</replaceable>$:*:101:100::0:0:Windows <replaceable>machine_name</replaceable>:/dev/null:/sbin/nologin'</userinput>
</screen>
</para>

<para>
<indexterm><primary>/etc/passwd</primary></indexterm>
<indexterm><primary>$</primary></indexterm>
<indexterm><primary>null shell</primary></indexterm>
<indexterm><primary>ホームディレクトリ</primary></indexterm>
<filename>/etc/passwd</filename>のエントリは<quote>$</quote>を追加した
マシン名を付けたもので、パスワードは持たず、シェル情報が空白で(訳注:
/dev/nullを指定すること)、ホームディレクトリの定義がない。たとえば、
マシン名が<quote>doppy</quote>の場合は<filename>/etc/passwd</filename>
のエントリは以下のようになる:
<programlisting>
doppy$:x:505:100:<replaceable>machine_nickname</replaceable>:/dev/null:/bin/false
</programlisting>
</para>

<para>
<indexterm><primary>machine_nickname</primary></indexterm>
<indexterm><primary>machine_name</primary></indexterm>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
上記の例では、<replaceable>machine_nickname</replaceable>はクライアントに対する
任意の名前を記述する(たとえばBasementComputer)。
<replaceable>machine_name</replaceable>はドメインに参加するときの
クライアントのNetBIOS名でなければならない。<quote>$</quote>は
クライアントのNetBIOS名に必ず付加しなければならず、そうしないと、
Sambaはこれがマシン信頼アカウントと認識できない。
</para>

<para>
<indexterm><primary>UNIXアカウント</primary></indexterm>
<indexterm><primary>Sambaアカウント</primary></indexterm>
<indexterm><primary>マシン信頼アカウント</primary><secondary>パスワード</secondary></indexterm>
対応するUNIXアカウントが作成されたなら、次の手順はよく知られた初期マシン信頼
アカウントパスワードを持つクライアント用のSambaアカウントを作成することである。
これは以下に示すような<command>smbpasswd</command>を使用する:
<screen>
&rootprompt;<userinput>smbpasswd -a -m <replaceable>machine_name</replaceable></userinput>
</screen>
</para>

<para>
<indexterm><primary>マシン名</primary></indexterm>
<indexterm><primary>NetBIOS名</primary></indexterm>
<indexterm><primary>RID</primary></indexterm>
<indexterm><primary>UID</primary></indexterm>
ここで<replaceable>machine_name</replaceable>はマシンのNetBIOS名である。
新規のマシンアカウントのRIDは対応するUNIXアカウントのUIDから生成される。
</para>

<warning>
<title>クライアントをドメインに即座に参加させる</title>

<para>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>サーバマネージャ</primary></indexterm>
<indexterm><primary>パスワードの変更</primary></indexterm>
<indexterm><primary>NetBIOS名</primary></indexterm>
この方法でマシン信頼アカウントを手動作成することは、 Windows NT PDC で
<indexterm><primary>サーバマネージャ</primary></indexterm>
<application>サーバマネージャ</application>によりマシン信頼アカウントを
作成するのと同等である。アカウントが作成されてからクライアントがドメイン
に参加してパスワードを変更するまでの間、同じ NetBIOS 名を持つマシンで
ドメインに参加しようとする侵入者の被害を受ける可能性がある。 PDC は、
ドメインのメンバを信頼するようにできており、多くのユーザー情報をこのような
クライアントに渡してしまう。注意すること!
</para>
</warning>
</sect2>

<sect2>
<title>NT4サーバマネージャによるドメインマシンアカウントの管理</title>

<para>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
<indexterm><primary>自動的なアカウントの生成</primary></indexterm>
<indexterm><primary>サーバマネージャ</primary></indexterm>
有効な<smbconfoption name="add machine script"/>はマシン信頼アカウントの
自動作成に必須である。これは自動アカウント作成機能を使用する場合でも、
NT4 ドメインサーバマネージャを使用する場合でも必要である。
</para>

<para>
<indexterm><primary>SRVTOOLS.EXE</primary></indexterm>
<indexterm><primary>SrvMgr.exe</primary></indexterm>
<indexterm><primary>UsrMgr.exe</primary></indexterm>
<indexterm><primary>ドメイン管理ツール</primary></indexterm>
ドメインを管理しようとしているマシンが
<application>Microsoft Windows NT4 ワークステーション又はMicrosoft Windows 200x/XP Professional</application>
の場合、使用するツールは<command>SRVTOOLS.EXE</command>という
パッケージである。これをターゲットディレクトリで実行すると、<command>SrvMgr.exe</command>
及び<command>UsrMgr.exe</command>(どちらもMicrosoft Windows NT4 ワークステーション
のドメイン管理ツール)が解凍される。
</para>

<para>
<indexterm><primary>Nexus.exe</primary></indexterm>
<indexterm><primary>Microsoft Windows 9x/Me</primary></indexterm>
ワークステーションが<application>Microsoft Windows 9x/Me</application>
ファミリー製品であれば、 Microsoft のWebサイトから<command>Nexus.exe</command>
パッケージをダウンロードする。それをターゲットディレクトリから実行すると、
上記と同じツールで、9x/Meプラットフォーム用のものが解凍される。
</para>

<para>
これらのツールに関する詳細情報は次のKnowledge Baseの記事で得ることができる: 
<ulink url="http://support.microsoft.com/default.aspx?scid=kb;en-us;173673">173673</ulink>と
<ulink url="http://support.microsoft.com/default.aspx?scid=kb;en-us;172540">172540</ulink>
</para>

<para>
<indexterm><primary>srvmgr.exe</primary></indexterm>
<indexterm><primary>ドメインのサーバマネージャ</primary></indexterm>
<command>srvmgr.exe</command>(ドメイン用のサーバマネージャ)を起動し、以下の手順を実行する:
</para>

<procedure>
<title>サーバマネージャによるドメインマシンアカウント管理</title>
	<step><para>
	メニューから<guimenu>コンピュータ</guimenu>を選択する。
	</para></step>

	<step><para>
	<guimenuitem>Select Domain</guimenuitem>をクリックする。
	</para></step>

	<step><para>
	<guilabel>Select Domain</guilabel>パネルで管理対象の
	ドメイン名をクリックし、 <guibutton>OK</guibutton>をクリックする。
	</para></step>

	<step><para>
	再度メニュー画面から<guimenu>コンピュータ</guimenu>を選択する。
	</para></step>

	<step><para>
	<guimenuitem>Add to Domain</guimenuitem>を選択する。
	</para></step>

	<step><para>
	ダイアログボックス中で、<guilabel>Add NT Workstation of Server</guilabel>
	ラジオボタンをクリックし、フィールドにマシン名を入力し、
	<guibutton>Add</guibutton>ボタンをクリックする。
	</para></step>
</procedure>

</sect2>

<sect2>
<title>マシン信頼アカウントの即時作成</title>

<para>
<indexterm><primary>マシン信頼アカウント</primary><secondary>作成</secondary></indexterm>
マシン信頼アカウント作成の第3の(そして推奨する)方法は、クライアントが
ドメインに参加する時、必要に応じて Samba サーバーアカウントを作成する方法である。
</para>

<para>
<indexterm><primary>マシン信頼アカウント</primary><secondary>UNIXアカウント</secondary></indexterm>
<indexterm><primary>UNIXアカウント</primary></indexterm>
<indexterm><primary>add machine script</primary></indexterm>
Samba の各マシン信頼アカウントは対応するUNIXアカウントを必要とするので、
通常、 UNIXアカウントを自動作成する機能が提供されている。これには &smb.conf;
ファイル内に add machine script オプションを設定する必要がある。
しかし、この方法は必須ではなく、対応するUNIXアカウントを手動で作成しても構わない。
</para>


<para>
<indexterm><primary>useradd</primary></indexterm>
<indexterm><primary>Red Hat Linux</primary></indexterm>
以下は、Red Hat linux での例である:
<smbconfblock>
<smbconfsection name="[global]"/>
<smbconfoption name="add machine script">/usr/sbin/useradd -d /var/lib/nobody -g 100 -s /bin/false -M %u</smbconfoption>
</smbconfblock>
</para>

</sect2>

<sect2><title>Microsoft Windows ワークステーション又はサーバをドメインメンバにする</title>

<para>
Microsoft Windows ワークステーションやサーバをドメインのメンバ
にする手順は Windowsのバージョンによって異なる。
</para>

<sect3>
	<title>Windows 200x/XP Professionalクライアント</title>

	<para>
<indexterm><primary>ドメインメンバ</primary></indexterm>
<indexterm><primary>マシン信頼アカウント</primary><secondary>作成権限</secondary></indexterm>
<indexterm><primary>権限</primary></indexterm>
<indexterm><primary>root</primary></indexterm>
        ユーザーがクライアントをドメインメンバにする時、 Windows 200x は、ドメイン内で
        マシンアカウントを作成する権限を持つアカウント及びパスワードの入力を要求する。
        Samba管理者アカウント(すなわち、Sambaサーバ上で<constant>root</constant>権限を
        持つSambaアカウント)をここで入力せねばならない。通常のユーザアカウントが入力さ
        れると、この作業は失敗する(訳注:net rpc rightsでSeMachineAccountPrivilege権限を
        持ったユーザも出来るのでは?)
	</para>

	<para>
<indexterm><primary>管理者アカウント</primary></indexterm>
<indexterm><primary>/etc/passwd</primary></indexterm>
        セキュリティのため、この管理者アカウントのパスワードは<filename>/etc/passwd</filename>
        でルートユーザ用に使用されているパスワード以外のものを設定するべきである。
	</para>

	<para>
<indexterm><primary>アカウント</primary></indexterm>
<indexterm><primary>ドメインメンバの作成</primary></indexterm>
<indexterm><primary>root</primary></indexterm>
<indexterm><primary>map</primary></indexterm>
        ドメインメンバのマシンアカウントを作成するために使用するアカウント名は
        ネットワーク管理者が任意に選択する。もしそれが<constant>root</constant>以外なら
        &smb.conf;中のパラメータ
        <smbconfoption name="username map">/etc/samba/smbusers</smbconfoption>
        で指定するファイル名中で容易にマッピングできる。
	</para>

	<para>
<indexterm><primary>管理者アカウント</primary></indexterm>
<indexterm><primary>暗号化キー</primary></indexterm>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
        Samba管理者アカウントのセッションキーは、マシン信頼アカウントのパスワード
        設定の際、暗号化キーの機能を果たす。マシン信頼アカウントはその場でで作成
        されるか、または、既に存在していれば更新される。
	</para>
</sect3>

<sect3>
	<title>Windows NT4 クライアント</title>

	<para>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
<indexterm><primary>コンピュータアカウントの作成</primary></indexterm>
<indexterm><primary>マシンの参加</primary></indexterm>
        マシン信頼アカウントが手動作成された場合、Identification Changes
        メニュー画面でドメイン名を入力するが、
        <guilabel>Create a Computer Account in the Domain</guilabel>
	チェックボックスにはチェックを入れない。こうすることでマシン
	がドメインに参加する際に既存のマシン信頼アカウントが使用される。
	</para>

	<para>
<indexterm><primary>マシン信頼アカウント</primary></indexterm>
<indexterm><primary>on the fly</primary></indexterm>
<indexterm><primary>コンピュータアカウント</primary></indexterm>
<indexterm><primary>管理者アカウント</primary></indexterm>
	もしマシン信頼アカウントがその場で作成される場合は、Identification Changes
	メニュー画面でドメイン名を入力し、
	<guilabel>Create a Computer Account in the Domain</guilabel>
	チェックボックスにチェックを入れる。この場合、上記 Windows2000用
	の手順に従いドメインに参加する(プロンプトに対してSamba管理者
	アカウント名を入力する)。
	</para>
</sect3>

<sect3>
	<title>Sambaクライアント</title>

	<para>
<indexterm><primary></primary></indexterm>
	Joining a Sambaクライアントをドメインに参加させる方法は
	<link linkend="domain-member-server">次の章</link>に記述されている。
	</para>
</sect3>

</sect2>
</sect1>

<sect1 id="domain-member-server">
<title>ドメインメンバサーバ</title>

<para>
<indexterm><primary>ドメインセキュリティ</primary></indexterm>
<indexterm><primary>セキュリティコンテキスト</primary></indexterm>
<indexterm><primary>認証機構</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
このモードのサーバ操作は、Sambaマシンをドメインセキュリティコンテキスト
のメンバーにすることを含む。またこれは定義上、全てのユーザ認証は中央で
定義された認証機構(訳注:authentication regime)で行われることを意味する。
この認証機構は NT3/4形式(旧式のドメインテクノロジー)サーバ又は
Microsoft Windows 2000以降で実装されているActive Directory server(ADS)
が提供する。
</para>

<para>
<emphasis>
<indexterm><primary>認証</primary><secondary>バックエンド</secondary></indexterm>
<indexterm><primary>分散ディレクトリ</primary></indexterm>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>OpenLDAP</primary></indexterm>
<indexterm><primary>iPlanet</primary></indexterm>
<indexterm><primary>Sun</primary></indexterm>
<indexterm><primary>Novell</primary></indexterm>
<indexterm><primary>e-Directory</primary></indexterm>
もちろん、認証バックエンド自体はSambaがサポートしている分散ディレクトリ
構造のサーバなら、いずれでも構いません。LDAP(OpenLDAPベース) 、Sunの
iPlanet、Novellの e-Directoryなどが使用可能である。
</emphasis>
</para>

<note><para>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>アイデンティティ管理</primary></indexterm>
<indexterm><primary>マシン認証</primary></indexterm>
SambaがLDAPやその他のアイデンティティ管理、あるいは、ディレクトリ
サービスを使用するように設定される場合、ユーザ及びマシン認証を継続して
実行するのはSambaである。Sambaが行う認証をLDAPサーバが代替するわけでは
ないことに注意。
</para></note>

<para>
<indexterm><primary>ドメインマシンアカウントの作成</primary></indexterm>
<indexterm><primary>ドメインメンバサーバ</primary></indexterm>
<indexterm><primary>ドメインに参加</primary></indexterm>
ドメインメンバサーバーのドメインマシンアカウント作成に関する詳細情報や
Sambaドメインメンバマシンがドメインに参加し完全に信頼されるようにする
方法に関しては、<link linkend="samba-pdc">ドメイン管理</link>の章を参照のこと。
</para>

<sect2>
<title>Samba-3でNT4形式でのドメインに参加する</title>

<para><link linkend="assumptions">下記の表</link>に、この後この章で使用される名前を示す。</para>

<table frame="all" id="assumptions"><title>前提</title>
	<tgroup cols="2">
		<colspec align="right"/>
		<colspec align="left"/>
	<tbody>
			<row>
				<entry>Samba DMSのNetBIOS名:</entry><entry>SERV1</entry>
			</row>
			<row>
				<entry>Windows 200x/NTドメイン名:</entry><entry>&example.workgroup;</entry>
			</row>
			<row>
				<entry>ドメインのPDCのNetBIOS名:</entry><entry>DOMPDC</entry>
			</row>
			<row>
				<entry>ドメインのBDCのNetBIOS名:</entry><entry>DOMBDC1とDOMBDC2</entry>
			</row>
	</tbody>
	</tgroup>
</table>

<para>
<indexterm><primary></primary></indexterm>
まず&smb.conf;ファイルを編集し、Sambaが以降ドメインセキュリティを
使用するように設定しなければならない。
</para>

<para>
<indexterm><primary>security = user</primary></indexterm>
<indexterm><primary>standalone server</primary></indexterm>
<indexterm><primary>ドメインメンバサーバ</primary></indexterm>
<indexterm><primary>ドメインセキュリティ</primary></indexterm>
&smb.conf;中の[global]セクション中に<smbconfoption name="security"/>
行を、下記のように変更(又は追加)する:
<smbconfblock>
<smbconfoption name="security">domain</smbconfoption>
</smbconfblock>
もしも、パラメータ<parameter>security = user</parameter>が使われている
ならば、このマシンはスタンドアロンサーバで動作するのでドメインメンバ
サーバではないことに注意。ドメインセキュリティモードはSambaにドメイン
セキュリティコンテキスト内で動作するようにさせる。
</para>

<para>
次に、<smbconfsection name="[global]"/>セクション中の
<smbconfoption name="workgroup"/>行を下記のように修正する:
<smbconfblock>
<smbconfoption name="workgroup">&example.workgroup;</smbconfoption>
</smbconfblock>
これが参加するドメイン名である。
</para>

<para>
<indexterm><primary>認証</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
ユーザーが NT PDC で認証されるように<smbconfoption name="encrypt passwords"/>
パラメータを<constant>yes</constant>に設定しなければならない。もしこの
パラメータが特に指定されていなければ、既定値で設定されている。
このパラメータを設定する必要はないが、もしも&smb.conf;ファイル中で指定
されたならば、必ず<constant>Yes</constant>に設定されねばならない。
</para>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>authenticate users</primary></indexterm>
<indexterm><primary>ドメインコントローラ</primary></indexterm>
最後に、[global]セクションの<smbconfoption name="password server"/>行
を下記のように追加(又は修正)する:
<smbconfblock>
<smbconfoption name="password server">DOMPDC DOMBDC1 DOMBDC2</smbconfoption>
</smbconfblock>
これらはSambaがユーザ認証のために通信を行うプライマリ及びバックアップの
ドメインコントローラである。Sambaは各サーバに対し、リスト順に接続するので、
複数のドメインコントローラの間で認証負荷を分散するためには、このリストの
順番を適宜変更してもよい。
</para>

<para>
<indexterm><primary>ドメインコントローラのリスト</primary></indexterm>
<indexterm><primary>メカニズム</primary></indexterm>
<indexterm><primary>ブロードキャストベースの名前解決</primary></indexterm>
<indexterm><primary>DNSによる名前解決</primary></indexterm>
代わりに、認証に使用するドメインコントローラのリストを smbdが自動的に決める
ようにしたい場合、この行を次のように設定する:
<smbconfblock>
<smbconfoption name="password server">*</smbconfoption>
</smbconfblock>
<indexterm><primary>WINS</primary></indexterm>
この方法で、NTと全く同じメカニズムをSambaが使用するようにできる。この方法は
ブロードキャストベースの名前解決を使用するか、WINS データベースの検索により
認証するドメインコントローラを決めるか、DNSによる名前解決によりドメイン
コントローラを見つける。
</para>

<para>
ドメインに参加するために次のコマンドを実行する:
<indexterm><primary>net</primary><secondary>rpc</secondary><tertiary>join</tertiary></indexterm>
<screen>
&rootprompt;<userinput>net rpc join -S DOMPDC -U<replaceable>Administrator%password</replaceable></userinput>
</screen>
</para>

<para>
<indexterm><primary>NetBIOS名</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>WINS検索</primary></indexterm>
<indexterm><primary>NetBIOSブロードキャスト</primary></indexterm>
もしも、<option>-S DOMPDC</option>引数が与えられない場合、ドメイン名は&smb.conf;
から入手し、PDCのNetBIOS名は、WINS検索を使うか、NetBIOSブロードキャストベースの名前
検索のどちらかで入手する。
</para>

<para>
<indexterm><primary>ドメインへの参加</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>Administrator%password</primary></indexterm>
<indexterm><primary>ドメインに参加</primary></indexterm>
マシンがDOMドメインに参加しようとしていて、そのドメインのPDC(ドメインのSAMデータ
ベースへの書き込み権限のある唯一のマシン)がDOMPDCなので、
<option>-S</option>オプションを使用する。
<replaceable>Administrator%password</replaceable>は、はマシンをドメインに追加する
のに必要な権限を持つアカウントのログイン名とパスワードである。これが成功すれば、
使用しているターミナルの画面に下のようなメッセージが表示される。
古いNT4式のドメイン環境使用の場合:
<screen>
<computeroutput>Joined domain DOM.</computeroutput>
</screen>
</para>

<para>
<indexterm><primary>net</primary><secondary>ads</secondary><tertiary>join</tertiary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>ADSドメインへの参加</primary></indexterm>
Active Directory使用の場合、ADSドメインへ参加するためのコマンドは以下の通り:
<screen>
&rootprompt; net ads join -U<replaceable>Administrator%password</replaceable>
</screen>
成功すると以下の結果が表示される:
<screen>
<computeroutput>Joined SERV1 to realm MYREALM.</computeroutput>
</screen>
</para>

<para>
詳細情報については、<command>net</command>のマニュアルページと
<link linkend="NetCommand">リモート管理の章</link>を参照のこと。
</para>

<para>
<indexterm><primary>ドメインに参加</primary></indexterm>
<indexterm><primary>マシン信頼アカウントの作成</primary></indexterm>
<indexterm><primary>PDC</primary></indexterm>
この手順により、事前にPDC上でマシン信頼アカウントを作成する必要はなく、
サーバがドメインに接続できる。
</para>

<para>
<indexterm><primary>マシンアカウントのパスワード</primary><secondary>変更プロトコル</secondary></indexterm>
<indexterm><primary>ランダムなマシンアカウントのパスワード</primary></indexterm>
<indexterm><primary>/usr/local/samba/private/secrets.tdb</primary></indexterm>
<indexterm><primary>/etc/samba/secrets.tdb</primary></indexterm>
このコマンドは、マシンアカウントパスワード変更プロトコルを通して、
Sambaサーバの新規(任意の)マシンアカウントパスワードを、smbpasswdファイルが
通常格納されているディレクトリと同じディレクトリにあるファイルに書き込む。
DMSによって必要とされる信頼アカウント情報は
<filename>/usr/local/samba/private/secrets.tdb</filename>か
<filename>/etc/samba/secrets.tdb</filename>ファイル中に書かれる。
</para>

<para>
<indexterm><primary>ドメインレベルのセキュリティ</primary></indexterm>
<indexterm><primary>シャドウパスワードファイル</primary></indexterm>
このファイルはrootにより作成・所有され、root 以外のユーザは読めない。これが、
システムのドメインレベルのセキュリティの鍵を握る部分であり、シャドウ
パスワードファイル同様に慎重に扱わなければならない。
</para>

<para>
<indexterm><primary>Samba daemons</primary></indexterm>
<indexterm><primary>ディストリビューション</primary></indexterm>
<indexterm><primary>/etc/init.d/samba</primary></indexterm>
最後に、Sambaのdaemonを再起動し、クライアントがドメインセキュリティを使用開始する
準備をする。Samba デーモンの再起動方法はディストリビューションにもよるが、ほとんど
の場合は次のとおりである:
<screen>
&rootprompt;/etc/init.d/samba restart
</screen>
</para>

</sect2>

<sect2>
<title>これがなぜ<parameter>security = server</parameter>よりもすぐれているのか?</title>

<para>
<indexterm><primary>domain security</primary></indexterm>
<indexterm><primary>UNIX users</primary></indexterm>
<indexterm><primary>authentication</primary></indexterm>
Currently, domain security in Samba does not free you from having to create local UNIX users to represent the
users attaching to your server. This means that if domain user <constant>DOM\fred</constant> attaches to your
domain security Samba server, there needs to be a local UNIX user fred to represent that user in the UNIX file
system. This is similar to the older Samba security mode <smbconfoption
name="security">server</smbconfoption>, where Samba would pass through the authentication request to a Windows
NT server in the same way as a Windows 95 or Windows 98 server would.
</para>

<para>
<indexterm><primary>winbind</primary></indexterm>
<indexterm><primary>UID</primary></indexterm>
<indexterm><primary>GID</primary></indexterm>
Please refer to <link linkend="winbind">Winbind: Use of Domain Accounts</link>, for information on a system
to automatically assign UNIX UIDs and GIDs to Windows NT domain users and groups.
</para>

<para>
<indexterm><primary>domain-level</primary></indexterm>
<indexterm><primary>authentication</primary></indexterm>
<indexterm><primary>RPC</primary></indexterm>
The advantage of domain-level security is that the authentication in domain-level security is passed down the
authenticated RPC channel in exactly the same way that an NT server would do it. This means Samba servers now
participate in domain trust relationships in exactly the same way NT servers do (i.e., you can add Samba
servers into a resource domain and have the authentication passed on from a resource domain PDC to an account
domain PDC).
</para>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>BDC</primary></indexterm>
<indexterm><primary>connection resources</primary></indexterm>
In addition, with <smbconfoption name="security">server</smbconfoption>, every Samba daemon on a server has to
keep a connection open to the authenticating server for as long as that daemon lasts. This can drain the
connection resources on a Microsoft NT server and cause it to run out of available connections. With
<smbconfoption name="security">domain</smbconfoption>, however, the Samba daemons connect to the PDC or BDC
only for as long as is necessary to authenticate the user and then drop the connection, thus conserving PDC
connection resources.
</para>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>authentication reply</primary></indexterm>
<indexterm><primary>SID</primary></indexterm>
<indexterm><primary>NT groups</primary></indexterm>
Finally, acting in the same manner as an NT server authenticating to a PDC means that as part of the
authentication reply, the Samba server gets the user identification information such as the user SID, the list
of NT groups the user belongs to, and so on.
</para>

<note>
<para>
Much of the text of this document was first published in the Web magazine 
<ulink url="http://www.linuxworld.com"><emphasis>LinuxWorld</emphasis></ulink> as the article <ulink
url="http://www.linuxworld.com/linuxworld/lw-1998-10/lw-10-samba.html"/>
<emphasis>Doing the NIS/NT Samba</emphasis>.
</para>
</note>

</sect2>
</sect1>

<sect1 id="ads-member">
<title>Samba ADS Domain Membership</title>

<para>
<indexterm significance="preferred"><primary>Active Directory</primary></indexterm>
<indexterm significance="preferred"><primary>ADS</primary><see>Active Directory</see></indexterm>
<indexterm><primary>KDC</primary></indexterm>
<indexterm><primary>Kerberos</primary></indexterm>
This is a rough guide to setting up Samba-3 with Kerberos authentication against a
Windows 200x KDC. A familiarity with Kerberos is assumed.
</para> 

<sect2>
<title>Configure &smb.conf;</title>

<para>
You must use at least the following three options in &smb.conf;:
</para>

<smbconfblock>
<smbconfoption name="realm">your.kerberos.REALM</smbconfoption>
<smbconfoption name="security">ADS</smbconfoption>
<smbconfcomment>The following parameter need only be specified if present.</smbconfcomment>
<smbconfcomment>The default setting if not present is Yes.</smbconfcomment>
<smbconfoption name="encrypt passwords">yes</smbconfoption>
</smbconfblock>

<para>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>realm</primary></indexterm>
<indexterm><primary>DNS</primary></indexterm>
<indexterm><primary>ADS DC</primary></indexterm>
<indexterm><primary>password server</primary></indexterm>
In case samba cannot correctly identify the appropriate ADS server using the realm name, use the 
<smbconfoption name="password server"/> option in &smb.conf;:
<smbconfblock>
<smbconfoption name="password server">your.kerberos.server</smbconfoption>
</smbconfblock>
The most common reason for which Samba may not be able to locate the ADS domain controller is a consequence of
sites maintaining some DNS servers on UNIX systems without regard for the DNS requirements of the ADS
infrastructure. There is no harm in specifying a preferred ADS domain controller using the <parameter>password
server</parameter>.
</para>

<note><para>
<indexterm><primary>smbpasswd</primary></indexterm>
<indexterm><primary>authenticated</primary></indexterm>
You do <emphasis>not</emphasis> need an smbpasswd file, and older clients will be authenticated as 
if <smbconfoption name="security">domain</smbconfoption>, although it will not do any harm and 
allows you to have local users not in the domain.
</para></note>

</sect2>
  
<sect2>
<title>Configure <filename>/etc/krb5.conf</filename></title>

<para>
<indexterm><primary>/etc/krb5.conf</primary></indexterm>
<indexterm><primary>Kerberos</primary><secondary>/etc/krb5.conf</secondary></indexterm>
<indexterm><primary>MIT</primary></indexterm>
<indexterm><primary>Heimdal</primary></indexterm>
With both MIT and Heimdal Kerberos, it is unnecessary to configure the <filename>/etc/krb5.conf</filename>,
and it may be detrimental.
</para>

<para>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>SRV records</primary></indexterm>
<indexterm><primary>DNS zon</primary></indexterm>
<indexterm><primary>KDC</primary></indexterm>
<indexterm><primary>_kerberos.REALM.NAME</primary></indexterm>
Microsoft ADS automatically create SRV records in the DNS zone 
<parameter>_kerberos._tcp.REALM.NAME</parameter> for each KDC in the realm. This is part
of the installation and configuration process used to create an Active Directory domain.
A KDC is a Kerberos Key Distribution Center and forms an integral part of the Microsoft
active directory infrastructure.
</para>

<para>
<indexterm><primary>kinit</primary></indexterm>
<indexterm><primary>DES-CBC-MD5</primary></indexterm>
<indexterm><primary>DES-CBC-CRC</primary></indexterm>
<indexterm><primary>encryption types</primary></indexterm>
<indexterm><primary>kerberos</primary></indexterm>
<indexterm><primary>Windows 2000</primary></indexterm>
UNIX systems can use kinit and the DES-CBC-MD5 or DES-CBC-CRC encryption types to authenticate to the Windows
2000 KDC. For further information regarding Windows 2000 ADS kerberos interoperability please refer to the
Microsoft Windows 2000 Kerberos <ulink
url="http://www.microsoft.com/windows2000/techinfo/planning/security/kerbsteps.asp">Interoperability</ulink>
guide. Another very useful document that may be referred to for general information regarding Kerberos
interoperability is <ulink url="http://www.ietf.org/rfc/rfc1510.txt?number=1510">RFC1510</ulink>. This RFC
explains much of the magic behind the operation of Kerberos.
</para>

<para>
<indexterm><primary>MIT</primary></indexterm>
<indexterm><primary>KRB5</primary></indexterm>
<indexterm><primary>SRV records</primary></indexterm>
<indexterm><primary>krb5.conf</primary></indexterm>
<indexterm><primary>DNS lookup</primary></indexterm>
<indexterm><primary>libraries</primary></indexterm>
MIT's, as well as Heimdal's, recent KRB5 libraries default to checking for SRV records, so they will 
automatically find the KDCs. In addition, <filename>krb5.conf</filename> only allows specifying 
a single KDC, even there if there may be more than one. Using the DNS lookup allows the KRB5 
libraries to use whichever KDCs are available.
</para>

<para>
<indexterm><primary>krb5.conf</primary></indexterm>
When manually configuring <filename>krb5.conf</filename>, the minimal configuration is:
<screen>
[libdefaults]
	default_realm = YOUR.KERBEROS.REALM

[realms]
	YOUR.KERBEROS.REALM = {
	kdc = your.kerberos.server
	}

[domain_realms]
	.kerberos.server = YOUR.KERBEROS.REALM
</screen>
</para>

<para>
<indexterm><primary>Heimdal</primary></indexterm>
When using Heimdal versions before 0.6, use the following configuration settings:
<screen>
[libdefaults]
	default_realm      = YOUR.KERBEROS.REALM
	default_etypes     = des-cbc-crc des-cbc-md5
	default_etypes_des = des-cbc-crc des-cbc-md5

[realms]
        YOUR.KERBEROS.REALM = {
        kdc = your.kerberos.server
	}

[domain_realms]
        .kerberos.server = YOUR.KERBEROS.REALM
</screen>
</para>

<para>
<indexterm><primary>KDC</primary></indexterm>
<indexterm><primary>kinit</primary></indexterm>
Test your config by doing a <userinput>kinit
<replaceable>USERNAME</replaceable>@<replaceable>REALM</replaceable></userinput> and
making sure that your password is accepted by the Win2000 KDC.
</para>

<para>
<indexterm><primary>Heimdal</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>KDC</primary></indexterm>
<indexterm><primary>Windows 2003</primary></indexterm>
With Heimdal versions earlier than 0.6.x you can use only newly created accounts
in ADS or accounts that have had the password changed once after migration, or
in case of <constant>Administrator</constant> after installation. At the
moment, a Windows 2003 KDC can only be used with Heimdal releases later than 0.6
(and no default etypes in krb5.conf). Unfortunately, this whole area is still
in a state of flux.
</para>

<note><para>
<indexterm><primary>realm</primary></indexterm>
<indexterm><primary>uppercase</primary></indexterm>
<indexterm><primary>KDC</primary></indexterm>
The realm must be in uppercase or you will get a <quote><errorname>Cannot find KDC for
requested realm while getting initial credentials</errorname></quote> error (Kerberos
is case-sensitive!).
</para></note>

<note><para>
<indexterm><primary>synchronize</primary></indexterm>
<indexterm><primary>credentials</primary></indexterm>
<indexterm><primary>time difference</primary></indexterm>
<indexterm><primary>clock skew</primary></indexterm>
Time between the two servers must be synchronized. You will get a <quote><errorname>kinit(v5): Clock skew too
great while getting initial credentials</errorname></quote> if the time difference (clock skew) is more than five minutes.
</para></note>

<para>
<indexterm><primary>clock skew</primary></indexterm>
<indexterm><primary>Kerberos</primary></indexterm>
Clock skew limits are configurable in the Kerberos protocols. The default setting is five minutes.
</para>

<para>
<indexterm><primary>DNS</primary></indexterm>
<indexterm><primary>KDC</primary></indexterm>
<indexterm><primary>hostname</primary></indexterm>
<indexterm><primary>realm</primary></indexterm>
You also must ensure that you can do a reverse DNS lookup on the IP address of your KDC. Also, the name that
this reverse lookup maps to must either be the NetBIOS name of the KDC (i.e., the hostname with no domain
attached) or it can be the NetBIOS name followed by the realm.
</para>

<para>
<indexterm><primary>/etc/hosts</primary></indexterm>
<indexterm><primary>KDC</primary></indexterm>
<indexterm><primary>realm</primary></indexterm>
The easiest way to ensure you get this right is to add a <filename>/etc/hosts</filename> entry mapping the IP
address of your KDC to its NetBIOS name. If you do not get this correct, then you will get a <errorname>local
error</errorname> when you try to join the realm.
</para>

<para>
<indexterm><primary>Kerberos</primary></indexterm>
<indexterm><primary>Create the Computer Account</primary></indexterm>
<indexterm><primary>Testing Server Setup</primary></indexterm>
<indexterm><primary></primary></indexterm>
If all you want is Kerberos support in &smbclient;, then you can skip directly to <link
linkend="ads-test-smbclient">Testing with &smbclient;</link> now.  <link
linkend="ads-create-machine-account">Create the Computer Account</link> and <link
linkend="ads-test-server">Testing Server Setup</link> are needed only if you want Kerberos support for &smbd;
and &winbindd;.
</para>

</sect2>

<sect2 id="ads-create-machine-account">
<title>Create the Computer Account</title>

<para>
<indexterm><primary>write permission</primary></indexterm>
<indexterm><primary>Samba private directory</primary></indexterm>
<indexterm><primary>Administrator account</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
As a user who has write permission on the Samba private directory (usually root), run:
<screen>
&rootprompt; <userinput>net ads join -U Administrator%password</userinput>
</screen>
The Administrator account can be any account that has been designated in the ADS domain security settings with
permission to add machines to the ADS domain. It is, of course, a good idea to use an account other than Administrator.
On the UNIX/Linux system, this command must be executed by an account that has UID=0 (root).
</para>

<para>
<indexterm><primary>ADS</primary></indexterm>
<indexterm><primary>machine trust account</primary></indexterm>
<indexterm><primary>organizational unit</primary></indexterm>
<indexterm><primary>ADS manager</primary></indexterm>
<indexterm><primary>kinit</primary></indexterm>
<indexterm><primary>net</primary><secondary>ads</secondary><tertiary>join</tertiary></indexterm>
When making a Windows client a member of an ADS domain within a complex organization, you
may want to create the machine trust account within a particular organizational unit. Samba-3 permits
this to be done using the following syntax:
<screen>
&rootprompt; <userinput>kinit Administrator@your.kerberos.REALM</userinput>
&rootprompt; <userinput>net ads join createcomputer="organizational_unit"</userinput>
</screen>
Your ADS manager will be able to advise what should be specified for the "organizational_unit" parameter.
</para>

<para>
<indexterm><primary>organizational directory</primary></indexterm>
<indexterm><primary>machine trust account</primary></indexterm>
<indexterm><primary>container</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
For example, you may want to create the machine trust account in a container called <quote>Servers</quote>
under the organizational directory <quote>Computers/BusinessUnit/Department,</quote> like this:
<screen>
&rootprompt; <userinput>net ads join "Computers/BusinessUnit/Department/Servers"</userinput>
</screen>
This command will place the Samba server machine trust account in the container
<literal>Computers/BusinessUnit/Department/Servers</literal>. The container should exist in the ADS directory
before executing this command.  Please note that forward slashes must be used, because backslashes are both
valid characters in an OU name and used as escapes for other characters.  If you need a backslash in an OU 
name, it may need to be quadrupled to pass through the shell escape and ldap escape.
</para>

<sect3>
<title>Possible Errors</title>

<para>
<variablelist>
	<varlistentry><term><errorname>ADS support not compiled in</errorname></term>
	<listitem><para>
	<indexterm><primary>config.cache</primary></indexterm>
	<indexterm><primary>Kerberos</primary></indexterm>
	<indexterm><primary>headers files</primary></indexterm>
	Samba must be reconfigured (remove config.cache) and recompiled (make clean all install) after the
	Kerberos libraries and headers files are installed.
	</para></listitem></varlistentry>

	<varlistentry><term><errorname>net ads join prompts for user name</errorname></term>
	<listitem><para>
	<indexterm><primary>kinit</primary></indexterm>
	<indexterm><primary>rights</primary></indexterm>
	You need to log in to the domain using <userinput>kinit
	<replaceable>USERNAME</replaceable>@<replaceable>REALM</replaceable></userinput>.
	<replaceable>USERNAME</replaceable> must be a user who has rights to add a machine to the domain.
	</para></listitem></varlistentry>

	<varlistentry><term>Unsupported encryption/or checksum types</term>
	<listitem><para>
	<indexterm><primary>/etc/krb5.conf</primary></indexterm>
	<indexterm><primary>unsupported encryption</primary></indexterm>
	<indexterm><primary>Kerberos</primary></indexterm>
	Make sure that the <filename>/etc/krb5.conf</filename> is correctly configured
	for the type and version of Kerberos installed on the system.
	</para></listitem></varlistentry>
</variablelist>
</para>

</sect3>

</sect2>

<sect2 id="ads-test-server">
<title>Testing Server Setup</title>

<para>
<indexterm><primary>successful join</primary></indexterm>
<indexterm><primary>computer account</primary></indexterm>
<indexterm><primary>ADS</primary></indexterm>
If the join was successful, you will see a new computer account with the
NetBIOS name of your Samba server in Active Directory (in the <quote>Computers</quote>
folder under Users and Computers.
</para>

<para>
<indexterm><primary>Windows 2000</primary></indexterm>
<indexterm><primary>net</primary><secondary>use</secondary></indexterm>
<indexterm><primary>DES-CBC-MD5</primary></indexterm>
On a Windows 2000 client, try <userinput>net use * \\server\share</userinput>. You should
be logged in with Kerberos without needing to know a password. If this fails, then run
<userinput>klist tickets</userinput>. Did you get a ticket for the server? Does it have
an encryption type of DES-CBC-MD5? 
</para>

<note><para>
<indexterm><primary>DES-CBC-MD5</primary></indexterm>
<indexterm><primary>ARCFOUR-HMAC-MD5</primary></indexterm>
<indexterm><primary>encoding</primary></indexterm>
Samba can use both DES-CBC-MD5 encryption as well as ARCFOUR-HMAC-MD5 encoding.
</para></note>

</sect2>

<sect2 id="ads-test-smbclient">
<title>Testing with &smbclient;</title>

<para>
<indexterm><primary>smbclient</primary></indexterm>
<indexterm><primary>Kerberos</primary></indexterm>
<indexterm><primary>Kerberos authentication</primary></indexterm>
On your Samba server try to log in to a Windows 2000 server or your Samba
server using &smbclient; and Kerberos. Use &smbclient; as usual, but
specify the <option>-k</option> option to choose Kerberos authentication.
</para>

</sect2>

<sect2>
<title>Notes</title>

<para>
<indexterm><primary>administrator password</primary></indexterm>
<indexterm><primary>change password</primary></indexterm>
<indexterm><primary>encryption types</primary></indexterm>
You must change the administrator password at least once after installing a domain controller, 
to create the right encryption types.
</para>

<para>
<indexterm><primary>_kerberos._udp</primary></indexterm>
<indexterm><primary>_ldap._tcp</primary></indexterm>
<indexterm><primary>default DNS setup</primary></indexterm>
Windows 200x does not seem to create the <parameter>_kerberos._udp</parameter> and
<parameter>_ldap._tcp</parameter> in the default DNS setup. Perhaps this will be fixed later in service packs.
</para>

</sect2>
</sect1>

<sect1>
<title>Sharing User ID Mappings between Samba Domain Members</title>

<para>
<indexterm><primary>maps UNIX users and groups</primary></indexterm>
<indexterm><primary>UID</primary></indexterm>
<indexterm><primary>GID</primary></indexterm>
<indexterm><primary>SID</primary></indexterm>
Samba maps UNIX users and groups (identified by UIDs and GIDs) to Windows users and groups (identified by SIDs).
These mappings are done by the <parameter>idmap</parameter> subsystem of Samba.
</para>

<para>
<indexterm><primary>mappings</primary></indexterm>
<indexterm><primary>CIFS</primary></indexterm>
<indexterm><primary>NFS</primary></indexterm>
In some cases it is useful to share these mappings between Samba domain members,
so <emphasis>name->id</emphasis> mapping is identical on all machines.
This may be needed in particular when sharing files over both CIFS and NFS.
</para>

<para>
<indexterm><primary>LDAP</primary></indexterm>
<indexterm><primary>ldap idmap suffix</primary></indexterm>
To use the <emphasis>LDAP</emphasis> <parameter>ldap idmap suffix</parameter>, set:
</para>

<smbconfblock>
<smbconfoption name="ldap idmap suffix">ou=Idmap</smbconfoption>
</smbconfblock>

<para>
See the &smb.conf; man page entry for the <smbconfoption name="ldap idmap suffix"></smbconfoption>
parameter for further information.
</para>

<para>
<indexterm><primary>smbpasswd</primary></indexterm>
<indexterm><primary>LDAP administrative password</primary></indexterm>
<indexterm><primary>secrets.tdb</primary></indexterm>
Do not forget to specify also the <smbconfoption name="ldap admin dn"/>
and to make certain to set the LDAP administrative password into the <filename>secrets.tdb</filename> using:
<screen>
&rootprompt; smbpasswd -w ldap-admin-password
</screen>
In place of <literal>ldap-admin-password</literal>, substitute the LDAP administration password for your
system.
</para>

</sect1>

<sect1>
<title>Common Errors</title>

<para>
<indexterm><primary>domain member</primary></indexterm>
<indexterm><primary>machine trust accounts</primary></indexterm>
In the process of adding/deleting/re-adding domain member machine trust accounts, there are
many traps for the unwary player and many <quote>little</quote> things that can go wrong.
It is particularly interesting how often subscribers on the Samba mailing list have concluded
after repeated failed attempts to add a machine account that it is necessary to <quote>reinstall</quote>
MS Windows on the machine. In truth, it is seldom necessary to reinstall because of this type
of problem. The real solution is often quite simple, and with an understanding of how MS Windows
networking functions, it is easy to overcome.
</para>

<sect2>
<title>Cannot Add Machine Back to Domain</title>

<para>
<indexterm><primary>machine trust account</primary></indexterm>
<indexterm><primary>already exists</primary></indexterm>
<quote>A Windows workstation was reinstalled. The original domain machine trust
account was deleted and added immediately. The workstation will not join the domain if I use 
the same machine name. Attempts to add the machine fail with a message that the machine already
exists on the network &smbmdash; I know it does not. Why is this failing?</quote>
</para>

<para>
<indexterm><primary>NetBIOS name cache</primary></indexterm>
<indexterm><primary>nbtstat</primary></indexterm>
The original name is still in the NetBIOS name cache and must expire after machine account
deletion before adding that same name as a domain member again. The best advice is to delete
the old account and then add the machine with a new name. Alternately, the name cache can be flushed and
reloaded with current data using the <command>nbtstat</command> command on the Windows client:
<screen>
&dosprompt; nbtstat -R
</screen>
</para>

</sect2>

<sect2>
<title>Adding Machine to Domain Fails</title>

<para>
<indexterm><primary>PDC</primary></indexterm>
<indexterm><primary>fails</primary></indexterm>
<quote>Adding a Windows 200x or XP Professional machine to the Samba PDC Domain fails with a
message that says, <errorname>"The machine could not be added at this time, there is a network problem.
Please try again later."</errorname> Why?</quote>
</para>

<para>
<indexterm><primary>check logs</primary></indexterm>
You should check that there is an <smbconfoption name="add machine script"/> in your &smb.conf;
file. If there is not, please add one that is appropriate for your OS platform. If a script
has been defined, you will need to debug its operation. Increase the <smbconfoption name="log level"></smbconfoption>
in the &smb.conf; file to level 10, then try to rejoin the domain. Check the logs to see which
operation is failing.
</para>

<para>
Possible causes include:
</para>

<itemizedlist>
	<listitem><para>
<indexterm><primary>script</primary></indexterm>
<indexterm><primary>path specified</primary></indexterm>
	The script does not actually exist, or could not be located in the path specified.
	</para>

	<para>
<indexterm><primary>UNIX system account</primary></indexterm>
<indexterm><primary>Samba SAM account</primary></indexterm>
	<emphasis>Corrective action:</emphasis> Fix it. Make sure when run manually
	that the script will add both the UNIX system account and the Samba SAM account.
	</para></listitem>

	<listitem><para>
<indexterm><primary>UNIX system account</primary></indexterm>
<indexterm><primary>/etc/passwd</primary></indexterm>
	The machine could not be added to the UNIX system accounts file <filename>/etc/passwd</filename>.
	</para>

	<para>
<indexterm><primary>legal UNIX system account name</primary></indexterm>
<indexterm><primary>uppercase</primary></indexterm>
	<emphasis>Corrective action:</emphasis> Check that the machine name is a legal UNIX
	system account name. If the UNIX utility <command>useradd</command> is called,
	then make sure that the machine name you are trying to add can be added using this
	tool. <command>Useradd</command> on some systems will not allow any uppercase characters
	nor will it allow spaces in the name.
	</para></listitem>
</itemizedlist>

<para>
<indexterm><primary>backend database</primary></indexterm>
<indexterm><primary>UNIX system account</primary></indexterm>
<indexterm><primary>Samba backend database</primary></indexterm>
The <smbconfoption name="add machine script"/> does not create the
machine account in the Samba backend database; it is there only to create a UNIX system
account to which the Samba backend database account can be mapped.
</para>

</sect2>

<sect2>
	<title>I Can't Join a Windows 2003 PDC</title>

	<para>
<indexterm><primary>SMB signing</primary></indexterm>
<indexterm><primary>SMB</primary></indexterm>
<indexterm><primary>Windows 2003</primary></indexterm>
<indexterm><primary>SMB/CIFS</primary></indexterm>
	Windows 2003 requires SMB signing. Client-side SMB signing has been implemented in Samba-3.0.
	Set <smbconfoption name="client use spnego">yes</smbconfoption> when communicating 
	with a Windows 2003 server. This will not interfere with other Windows clients that do not
	support the more advanced security features of Windows 2003 because the client will simply
	negotiate a protocol that both it and the server suppport. This is a well-known fall-back facility
	that is built into the SMB/CIFS protocols.
	</para>

</sect2>

</sect1>
</chapter>
