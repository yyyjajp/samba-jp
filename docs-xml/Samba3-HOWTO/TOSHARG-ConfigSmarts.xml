<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<chapter id="cfgsmarts">
<chapterinfo>
	&author.jht;
	<pubdate>June 30, 2005</pubdate>
</chapterinfo>
<title>詳細設定のテクニック</title>

<para>
<indexterm><primary>設定のテクニック</primary></indexterm>
<indexterm><primary>include</primary></indexterm>
この本の最初の版のリリース以来、Samba以外の事についてネットワーク管理者の手助けとなる
かもしれない設定テクニックのよりよい資料について、繰り返し要求があった。一部の
ユーザは、<smbconfoption name="include">file-name</smbconfoption>パラメータの使い方に
関連する文書を提供した。
</para>

<para>
<indexterm><primary>複数のサーバ</primary></indexterm>
<indexterm><primary>multiple server personalities</primary></indexterm>
2004年の中頃に始まったが、1つのマシン上で複数のSambaサーバをホスティングする
機能について、関心が高まってきた。1つのサーバ上複数のSambaサーバの振る舞いを
ホスティングする事への興味も増えてきた。
</para>

<para>
<indexterm><primary>技術レビュー</primary></indexterm>
<indexterm><primary>レビューワ</primary></indexterm>
テクニカルレビューワからのフィードバックによりこの章を含める必要が出た。
そのため、今まで十分に言及してこなかった質問への答えををここに記す。さらに、
この章を充実させる、利用者からの追加は歓迎する。ここで提供されているものは、
まったくもって、小さなとっかかりである。
</para>

<para>
<indexterm><primary>複数のサーバ</primary></indexterm>
<indexterm><primary>複数のホスティング</primary></indexterm>
<indexterm><primary>ドメインコントローラ</primary></indexterm>
単一のSambaサーバ上で複数のサーバをホスト出来る方法はいくつもある。複数のサーバ
ホスティングは1つのマシン上で複数のドメインをホストする事を可能にする。そのような
各マシンは独立していて、他に影響を与えずに、起動/停止ができる。
</para>

<para>
<indexterm><primary>複数のサーバ</primary></indexterm>
<indexterm><primary>DMS</primary></indexterm>
<indexterm><primary>匿名サーバ</primary></indexterm>
時には、各サーバが固有のセキュリティモードを持つ、複数のサーバをホスティングする
ことが好ましいことがある。例えば、一般的な匿名印刷サーバのように、単一のUNIX/Linux
ホストはドメインメンバサーバ(DMS)になれる。この場合、ドメインメンバマシンとドメイン
ユーザはDMSにアクセスでき、さらにゲストユーザでさえも、一般的な印刷サーバにアクセス
できる。他の、汎用(匿名)サーバをホスティングするのに便利かもしれないシチュエーションの
例としては、CDROMサーバのホスティングがある。
</para>

<para>
<indexterm><primary>分離されたサーバ</primary></indexterm>
<indexterm><primary></primary></indexterm>
いくつかの環境では、固有のリソースを持つ、特定のユーザかグループのみからアクセス可能な、
分離されたサーバを持つ必要が規定されている。これは、Sambaが多数の物理的なサーバを、
1つのSambaサーバに置き換えられる、単純で、とても効果的な方法の1つである。
</para>

<sect1>
<title>実装</title>

<para>
</para>

<sect2>
<title>複数のサーバのホスティング</title>

<para>
<indexterm><primary>複数のサーバのホスティング</primary></indexterm>
<indexterm><primary>分離されたインスタンス</primary></indexterm>
<indexterm><primary>nmbd</primary></indexterm>
<indexterm><primary>smbd</primary></indexterm>
<indexterm><primary>winbindd</primary></indexterm>
<indexterm><primary>再コンパイル</primary></indexterm>
<indexterm><primary>TDB</primary></indexterm>
複数のサーバホスティングの使用は、それぞれ個別の設定ファイルを持っている、複数の分離
されたSambaインスタンスを動かす必要がある。この方法は、各&nmbd;, &smbd; と &winbindd;
のインスタンスは、完全に分離されたTDBファイルへの書き込みアクセスが出来なければならない
という理由で、とても複雑である。&nmbd;, &smbd; と &winbindd;が使うTDBファイルを分離
させる事は、ホスティングを行う各Sambaを再コンパイルすることで、各Sambaが、固有のTDB
ファイルに対する既定値のディレクトリを持つか、&nmbd;, &smbd; と &winbindd;の
各インスタンスが、それらの固有の&smb.conf;設定ファイルで起動するようにしなければ
ならない、&smb.conf;ファイルを設定することで可能となる。
</para>

<para>
<indexterm><primary>独立</primary></indexterm>
<indexterm><primary>固有のソケットのリッスン</primary></indexterm>
<indexterm><primary>ソケット</primary></indexterm>
<indexterm><primary>SID</primary></indexterm>
各インスタンスは固有のIPアドレス(独立したIPアドレスはIPエイリアスで行える)で操作される
べきである。&nmbd;, &smbd; と&winbindd;の各インスタンスは、その固有IPソケットのみを
リッスンすべきである。これは<smbconfoption name="socket address"/>パラメータを使うことに
よって、安全に出来る。Sambaサーバの各インスタンスは固有のSIDも持つべきであり、これは、
サーバは互いに独立で、分離されていることを意味する。
</para>

<para>
<indexterm><primary>複数サーバのホスティング</primary></indexterm>
<indexterm><primary>private dir</primary></indexterm>
<indexterm><primary>pid directory</primary></indexterm>
<indexterm><primary>lock directory</primary></indexterm>
<indexterm><primary>interfaces</primary></indexterm>
<indexterm><primary>bind interfaces only</primary></indexterm>
<indexterm><primary>netbios name</primary></indexterm>
<indexterm><primary>workgroup</primary></indexterm>
<indexterm><primary>socket address</primary></indexterm>
複数サーバホスティングのユーザはそれほど特異ではなく、プロセス管理と起動時それぞれの
場面において、注意深い設定を要求する。注意深く設定しなければならない、&smb.conf;
パラメータは以下を含む:
<smbconfoption name="private dir"/>, <smbconfoption name="pid directory"/>,<smbconfoption name="lock
directory"/>, <smbconfoption name="interfaces"/>, <smbconfoption name="bind interfaces only"/>, <smbconfoption
name="netbios name"/>, <smbconfoption name="workgroup"/>, <smbconfoption name="socket address"/>。
</para>

<para>
<indexterm><primary>複数のサーバ</primary></indexterm>
<indexterm><primary>貢献</primary></indexterm>
<indexterm><primary>包括的な文書</primary></indexterm>
Those who elect to create multiple Samba servers should have the ability to read and follow
the Samba source code, and to modify it as needed. This mode of deployment is considered beyond the scope of
this book. However, if someone will contribute more comprehensive documentation we will gladly review it, and
if it is suitable extend this section of this chapter. Until such documentation becomes available the hosting
of multiple samba servers on a single host is considered not supported for Samba-3 by the Samba Team.
</para>

</sect2>

<sect2>
<title>Multiple Virtual Server Personalities</title>

<para>
<indexterm><primary>multiple virtual servers</primary></indexterm>
<indexterm><primary>netbios alias</primary></indexterm>
<indexterm><primary>meta-services</primary></indexterm>
Samba has the ability to host multiple virtual servers, each of which have their own personality.  This is
achieved by configuring an &smb.conf; file that is common to all personalities hosted.  Each server
personality is hosted using its own <smbconfoption name="netbios alias"/> name, and each has its own distinct
<smbconfoption name="[global]"/> section. Each server may have its own stanzas for services and meta-services.
</para>

<para>
<indexterm><primary>workgroup</primary></indexterm>
<indexterm><primary>security</primary></indexterm>
<indexterm><primary>netbios aliases</primary></indexterm>
When hosting multiple virtual servers, each with their own personality, each can be in a different workgroup.
Only the primary server can be a domain member or a domain controller. The personality is defined by the
combination of the <smbconfoption name="security"/> mode it is operating in, the <smbconfoption name="netbios
aliases"/> it has, and the <smbconfoption name="workgroup"/> that is defined for it.
</para>

<para>
<indexterm><primary>NetBIOS name</primary></indexterm>
<indexterm><primary>NetBIOS-less SMB</primary></indexterm>
<indexterm><primary>smb ports</primary></indexterm>
<indexterm><primary>TCP port 139</primary></indexterm>
<indexterm><primary>TCP port 445</primary></indexterm>
<indexterm><primary>%L</primary></indexterm>
This configuration style can be used either with NetBIOS names, or using NetBIOS-less SMB over TCP services.
If run using NetBIOS mode (the most common method) it is important that the parameter <smbconfoption name="smb
ports">139</smbconfoption> should be specified in the primary &smb.conf; file. Failure to do this will result
in Samba operating over TCP port 445 and problematic operation at best, and at worst only being able to obtain
the functionality that is specified in the primary &smb.conf; file. The use of NetBIOS over TCP/IP using only
TCP port 139 means that the use of the <literal>%L</literal> macro is fully enabled. If the <smbconfoption
name="smb ports">139</smbconfoption> is not specified (the default is <parameter>445 139</parameter>, or if
the value of this parameter is set at <parameter>139 445</parameter> then the <literal>%L</literal> macro
is not serviceable.
</para>

<para>
<indexterm><primary>host multiple servers</primary></indexterm>
<indexterm><primary>multiple personality</primary></indexterm>
<indexterm><primary>NetBIOS-less</primary></indexterm>
<indexterm><primary>%i macro</primary></indexterm>
It is possible to host multiple servers, each with their own personality, using port 445 (the NetBIOS-less SMB
port), in which case the <literal>%i</literal> macro can be used to provide separate server identities (by
IP Address). Each can have its own <smbconfoption name="security"/> mode. It will be necessary to use the
<smbconfoption name="interfaces"/>, <smbconfoption name="bind interfaces only"/> and IP aliases in addition to
the <smbconfoption name="netbios name"/> parameters to create the virtual servers. This method is considerably
more complex than that using NetBIOS names only using TCP port 139.
</para>

<para>
<indexterm><primary>anonymous file server</primary></indexterm>
Consider an example environment that consists of a standalone, user-mode security Samba server and a read-only
Windows 95 file server that has to be replaced. Instead of replacing the Windows 95 machine with a new PC, it
is possible to add this server as a read-only anonymous file server that is hosted on the Samba server. Here
are some parameters:
</para>

<para>
The Samba server is called <literal>ELASTIC</literal>, its workgroup name is <literal>ROBINSNEST</literal>.
The CDROM server is called <literal>CDSERVER</literal> and its workgroup is <literal>ARTSDEPT</literal>. A
possible implementation is shown here:
</para>

<para>
<indexterm><primary>/etc/samba</primary></indexterm>
<indexterm><primary>nmbd</primary></indexterm>
<indexterm><primary>smbd</primary></indexterm>
<indexterm><primary>smb.conf</primary></indexterm>
The &smb.conf; file for the master server is shown in <link linkend="elastic">Elastic smb.conf File</link>.
This file is placed in the <filename>/etc/samba</filename> directory. Only the &nmbd; and the &smbd; daemons
are needed. When started the server will appear in Windows Network Neighborhood as the machine
<literal>ELASTIC</literal> under the workgroup <literal>ROBINSNEST</literal>. It is helpful if the Windows
clients that must access this server are also in the workgroup <literal>ROBINSNEST</literal> as this will make
browsing much more reliable.
</para>

<example id="elastic">
<title>Elastic smb.conf File</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">ROBINSNEST</smbconfoption>
<smbconfoption name="netbios name">ELASTIC</smbconfoption>
<smbconfoption name="netbios aliases">CDSERVER</smbconfoption>
<smbconfoption name="smb ports">139</smbconfoption>
<smbconfoption name="printcap name">cups</smbconfoption>
<smbconfoption name="disable spoolss">Yes</smbconfoption>
<smbconfoption name="show add printer wizard">No</smbconfoption>
<smbconfoption name="printing">cups</smbconfoption>
<smbconfoption name="include">/etc/samba/smb-%L.conf</smbconfoption>

<smbconfsection name="[homes]"/>
<smbconfoption name="comment">Home Directories</smbconfoption>
<smbconfoption name="valid users">%S</smbconfoption>
<smbconfoption name="read only">No</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>

<smbconfsection name="[office]"/>
<smbconfoption name="comment">Data</smbconfoption>
<smbconfoption name="path">/data</smbconfoption>
<smbconfoption name="read only">No</smbconfoption>

<smbconfsection name="[printers]"/>
<smbconfoption name="comment">All Printers</smbconfoption>
<smbconfoption name="path">/var/spool/samba</smbconfoption>
<smbconfoption name="create mask">0600</smbconfoption>
<smbconfoption name="guest ok">Yes</smbconfoption>
<smbconfoption name="printable">Yes</smbconfoption>
<smbconfoption name="use client driver">Yes</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>
</smbconfblock>
</example>

<para>
<indexterm><primary>smb-cdserver.conf</primary></indexterm>
The configuration file for the CDROM server is listed in <link linkend="cdserver">CDROM Server
smb-cdserver.conf file</link>. This file is called <filename>smb-cdserver.conf</filename> and it should be
located in the <filename>/etc/samba</filename> directory. Machines that are in the workgroup
<literal>ARTSDEPT</literal> will be able to browse this server freely.
</para>

<example id="cdserver">
<title>CDROM Server smb-cdserver.conf file</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">ARTSDEPT</smbconfoption>
<smbconfoption name="netbios name">CDSERVER</smbconfoption>
<smbconfoption name="map to guest">Bad User</smbconfoption>
<smbconfoption name="guest ok">Yes</smbconfoption>

<smbconfsection name="[carousel]"/>
<smbconfoption name="comment">CDROM Share</smbconfoption>
<smbconfoption name="path">/export/cddata</smbconfoption>
<smbconfoption name="read only">Yes</smbconfoption>
<smbconfoption name="guest ok">Yes</smbconfoption>
</smbconfblock>
</example>

<para>
<indexterm><primary>different resources</primary></indexterm>
<indexterm><primary>separate workgroups</primary></indexterm>
<indexterm><primary>read-only access</primary></indexterm>
<indexterm><primary>nobody account</primary></indexterm>
The two servers have different resources and are in separate workgroups. The server <literal>ELASTIC</literal>
can only be accessed by uses who have an appropriate account on the host server. All users will be able to
access the CDROM data that is stored in the <filename>/export/cddata</filename> directory. File system
permissions should set so that the <literal>others</literal> user has read-only access to the directory and its
contents. The files can be owned by root (any user other than the nobody account).
</para>

</sect2>

<sect2>
<title>Multiple Virtual Server Hosting</title>

<para>
<indexterm><primary>primary domain controller</primary></indexterm>
<indexterm><primary>extra machine</primary></indexterm>
<indexterm><primary>same domain/workgroup</primary></indexterm>
In this example, the requirement is for a primary domain controller for the domain called
<literal>MIDEARTH</literal>. The PDC will be called <literal>MERLIN</literal>. An extra machine called
<literal>SAURON</literal> is required. Each machine will have only its own shares. Both machines belong to the
same domain/workgroup.
</para>

<para>
<indexterm><primary>master smb.conf</primary></indexterm>
<indexterm><primary>/etc/samba</primary></indexterm>
<indexterm><primary></primary></indexterm>
The master &smb.conf; file is shown in <link linkend="mastersmbc">the Master smb.conf File Global Section</link>.
The two files that specify the share information for each server are shown in <link linkend="merlinsmbc">the
smb-merlin.conf File Share Section</link>, and <link linkend="sauronsmbc">the smb-sauron.conf File Share
Section</link>. All three files are locate in the <filename>/etc/samba</filename> directory.
</para>

<example id="mastersmbc">
<title>Master smb.conf File Global Section</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">MIDEARTH</smbconfoption>
<smbconfoption name="netbios name">MERLIN</smbconfoption>
<smbconfoption name="netbios aliases">SAURON</smbconfoption>
<smbconfoption name="passdb backend">tdbsam</smbconfoption>
<smbconfoption name="smb ports">139</smbconfoption>
<smbconfoption name="syslog">0</smbconfoption>
<smbconfoption name="printcap name">CUPS</smbconfoption>
<smbconfoption name="show add printer wizard">No</smbconfoption>
<smbconfoption name="add user script">/usr/sbin/useradd -m '%u'</smbconfoption>
<smbconfoption name="delete user script">/usr/sbin/userdel -r '%u'</smbconfoption>
<smbconfoption name="add group script">/usr/sbin/groupadd '%g'</smbconfoption>
<smbconfoption name="delete group script">/usr/sbin/groupdel '%g'</smbconfoption>
<smbconfoption name="add user to group script">/usr/sbin/usermod -G '%g' '%u'</smbconfoption>
<smbconfoption name="add machine script">/usr/sbin/useradd -s /bin/false -d /var/lib/nobody '%u'</smbconfoption>
<smbconfoption name="logon script">scripts\login.bat</smbconfoption>
<smbconfoption name="logon path"> </smbconfoption>
<smbconfoption name="logon drive">X:</smbconfoption>
<smbconfoption name="domain logons">Yes</smbconfoption>
<smbconfoption name="preferred master">Yes</smbconfoption>
<smbconfoption name="wins support">Yes</smbconfoption>
<smbconfoption name="printing">CUPS</smbconfoption>
<smbconfoption name="include">/etc/samba/smb-%L.conf</smbconfoption>
</smbconfblock>
</example>

<example id="merlinsmbc">
<title>MERLIN smb-merlin.conf File Share Section</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">MIDEARTH</smbconfoption>
<smbconfoption name="netbios name">MERLIN</smbconfoption>

<smbconfsection name="[homes]"/>
<smbconfoption name="comment">Home Directories</smbconfoption>
<smbconfoption name="valid users">%S</smbconfoption>
<smbconfoption name="read only">No</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>

<smbconfsection name="[office]"/>
<smbconfoption name="comment">Data</smbconfoption>
<smbconfoption name="path">/data</smbconfoption>
<smbconfoption name="read only">No</smbconfoption>

<smbconfsection name="[netlogon]"/>
<smbconfoption name="comment">NETLOGON</smbconfoption>
<smbconfoption name="path">/var/lib/samba/netlogon</smbconfoption>
<smbconfoption name="read only">Yes</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>

<smbconfsection name="[printers]"/>
<smbconfoption name="comment">All Printers</smbconfoption>
<smbconfoption name="path">/var/spool/samba</smbconfoption>
<smbconfoption name="printable">Yes</smbconfoption>
<smbconfoption name="use client driver">Yes</smbconfoption>
<smbconfoption name="browseable">No</smbconfoption>
</smbconfblock>
</example>

<example id="sauronsmbc">
<title>SAURON smb-sauron.conf File Share Section</title>
<smbconfblock>
<smbconfcomment>Global parameters</smbconfcomment>
<smbconfsection name="[global]"/>
<smbconfoption name="workgroup">MIDEARTH</smbconfoption>
<smbconfoption name="netbios name">SAURON</smbconfoption>

<smbconfsection name="[www]"/>
<smbconfoption name="comment">Web Pages</smbconfoption>
<smbconfoption name="path">/srv/www/htdocs</smbconfoption>
<smbconfoption name="read only">No</smbconfoption>
</smbconfblock>
</example>

</sect2>

</sect1>

</chapter>
