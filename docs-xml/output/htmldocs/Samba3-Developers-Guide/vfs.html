<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Chapter 10. VFS &#12514;&#12472;&#12517;&#12540;&#12523;</title><link rel="stylesheet" href="../samba.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="SAMBA&#38283;&#30330;&#32773;&#12460;&#12452;&#12489;"><link rel="up" href="pt03.html" title="Part III. Samba&#12469;&#12502;&#12471;&#12473;&#12486;&#12512;"><link rel="prev" href="rpc-plugin.html" title="Chapter 9. RPC&#30528;&#33073;&#21487;&#33021;&#12394;&#12514;&#12472;&#12517;&#12540;&#12523;"><link rel="next" href="parsing.html" title="Chapter 11. smb.conf&#12501;&#12449;&#12452;&#12523;"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 10. VFS &#12514;&#12472;&#12517;&#12540;&#12523;</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="rpc-plugin.html">Prev</a> </td><th width="60%" align="center">Part III. Samba&#12469;&#12502;&#12471;&#12473;&#12486;&#12512;</th><td width="20%" align="right"> <a accesskey="n" href="parsing.html">Next</a></td></tr></table><hr></div><div class="chapter" title="Chapter 10. VFS &#12514;&#12472;&#12517;&#12540;&#12523;"><div class="titlepage"><div><div><h2 class="title"><a name="vfs"></a>Chapter 10. VFS &#12514;&#12472;&#12517;&#12540;&#12523;</h2></div><div><div class="author"><h3 class="author"><span class="firstname">Alexander</span> <span class="surname">Bokovoy</span></h3><div class="affiliation"><div class="address"><p><code class="email">&lt;<a class="email" href="mailto:ab@samba.org">ab@samba.org</a>&gt;</code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Stefan</span> <span class="surname">Metzmacher</span></h3><div class="affiliation"><div class="address"><p><code class="email">&lt;<a class="email" href="mailto:metze@samba.org">metze@samba.org</a>&gt;</code></p></div></div></div></div><div><p class="pubdate"> 27 May 2003 </p></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="vfs.html#id2566113">Samba (Posix) VFS&#12524;&#12452;&#12516;</a></span></dt><dd><dl><dt><span class="sect2"><a href="vfs.html#id2566190">&#27726;&#29992;&#12452;&#12531;&#12479;&#12501;&#12455;&#12540;&#12473;</a></span></dt><dt><span class="sect2"><a href="vfs.html#id2508754">&#26377;&#21177;&#12394;VFS&#25805;&#20316;&#12524;&#12452;&#12516;</a></span></dt></dl></dd><dt><span class="sect1"><a href="vfs.html#id2508830">Samba VFS&#12469;&#12502;&#12471;&#12473;&#12486;&#12512;&#12392;&#12514;&#12472;&#12517;&#12540;&#12523;&#12398;&#38291;&#12391;&#12398;&#30456;&#20114;&#20316;&#29992;</a></span></dt><dd><dl><dt><span class="sect2"><a href="vfs.html#id2508837">&#21021;&#26399;&#21270;&#12392;&#30331;&#37682;</a></span></dt><dt><span class="sect2"><a href="vfs.html#id2567085">&#12393;&#12398;&#12424;&#12358;&#12395;&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;&#25509;&#32154;&#21336;&#20301;&#12391;&#12487;&#12540;&#12479;&#12434;&#20966;&#29702;&#12377;&#12427;&#12363;</a></span></dt></dl></dd><dt><span class="sect1"><a href="vfs.html#id2567307">&#26032;&#12375;&#12356;VFS&#12452;&#12531;&#12479;&#12501;&#12455;&#12540;&#12473;&#12408;&#12398;&#12450;&#12483;&#12503;&#12464;&#12524;&#12540;&#12489;</a></span></dt><dd><dl><dt><span class="sect2"><a href="vfs.html#id2567314">2.2.*&#12363;&#12425;3.0&#945;&#12514;&#12472;&#12517;&#12540;&#12523;&#12408;&#12398;&#12450;&#12483;&#12503;&#12464;&#12524;&#12540;&#12489;</a></span></dt></dl></dd><dt><span class="sect1"><a href="vfs.html#id2567763">&#12356;&#12367;&#12388;&#12363;&#12398;&#27880;&#24847;&#20107;&#38917;</a></span></dt><dd><dl><dt><span class="sect2"><a href="vfs.html#id2567768">TRANSPARENT&#38306;&#25968;&#12398;&#23455;&#35013;</a></span></dt><dt><span class="sect2"><a href="vfs.html#id2567791">OPAQUE&#38306;&#25968;&#12398;&#23455;&#35013;</a></span></dt></dl></dd></dl></div><div class="sect1" title="Samba (Posix) VFS&#12524;&#12452;&#12516;"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2566113"></a>Samba (Posix) VFS&#12524;&#12452;&#12516;</h2></div></div></div><p>Samba&#38283;&#30330;&#12398;&#12411;&#12392;&#12435;&#12393;&#12364;&#12289;POSIX&#20114;&#25563;&#12394;OS&#12434;&#20351;&#12387;&#12390;&#12356;&#12427;&#38291;&#12289;
NT&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#12398;&#25991;&#27861;&#12434;&#36969;&#29992;&#12377;&#12427;&#22580;&#21512;&#12395;&#12289;POSIX&#12395;&#12424;&#12387;&#12390;&#35201;&#27714;&#12373;&#12428;&#12427;&#12418;&#12398;&#12424;&#12426;&#12418;&#12289;
&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#12395;&#23550;&#12375;&#12390;&#12398;&#12418;&#12398;&#12398;&#12411;&#12358;&#12364;&#12424;&#12426;&#26126;&#30906;&#12391;&#12354;&#12427;&#12290;Samba 2.2&#20197;&#38477;&#12289;&#12377;&#12409;&#12390;&#12398;
&#25805;&#20316;&#12395;&#38306;&#36899;&#12377;&#12427;&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#12399;&#12289;NTFS&#25991;&#27861;&#12434;&#22793;&#25563;&#12377;&#12427;&#12383;&#12417;&#12395;&#24517;&#35201;&#12392;&#12373;&#12428;&#12427;&#36861;&#21152;&#12398;&#38306;&#25968;&#12392;&#12289;
POSIX&#12398;&#20001;&#26041;&#12391;&#12514;&#12487;&#12523;&#21270;&#12373;&#12428;&#12383;&#24460;&#12398;&#20206;&#24819;&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;(VFS)&#12398;&#12383;&#12417;&#12398;&#12289;&#27010;&#35201;&#12524;&#12452;&#12516;
&#12434;&#36890;&#12375;&#12390;&#34892;&#12431;&#12428;&#12427;&#12290;
</p><p>
&#12371;&#12398;&#27010;&#35201;&#12524;&#12452;&#12516;&#12399;&#12289;&#29694;&#22312;&#36890;&#24120;&#12398;POSIX&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#12364;&#25345;&#12387;&#12390;&#12356;&#12427;&#12418;&#12398;&#12424;&#12426;&#12418;&#12383;&#12367;&#12373;&#12435;&#12398;&#27231;&#33021;&#12434;
&#25552;&#20379;&#12375;&#12390;&#12356;&#12427;&#12290;&#12381;&#12428;&#12425;&#12377;&#12409;&#12390;&#12364;&#20351;&#29992;&#12375;&#12390;&#12356;&#12427;&#29305;&#23450;&#12398;&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#12395;&#23550;&#12375;&#12390;&#23455;&#35013;&#12377;&#12409;&#12365;&#12391;&#12354;&#12427;&#12392;&#12356;&#12358;
&#12371;&#12392;&#12399;&#35201;&#27714;&#12373;&#12428;&#12394;&#12356;&#12290;&#12375;&#12363;&#12375;&#12289;&#12381;&#12428;&#12425;&#12398;&#27231;&#33021;&#12364;&#26377;&#21177;&#12394;&#26178;&#12289;Samba&#12399;CIFS&#12463;&#12521;&#12452;&#12450;&#12531;&#12488;&#12395;&#23550;&#12375;&#12390;
&#12381;&#12428;&#12434;&#20844;&#21578;&#12375;&#12289;&#12381;&#12428;&#12425;&#12399;&#12289;&#12381;&#12428;&#12425;&#12398;&#27231;&#33021;&#12395;&#36973;&#36935;&#12377;&#12427;&#26178;&#12289;&#26356;&#12395;&#22810;&#12367;&#12398;&#36861;&#21152;&#27231;&#33021;&#12434;&#26399;&#24453;&#12377;&#12427;
&#12371;&#12392;&#12434;&#20104;&#28204;&#12377;&#12427;&#12363;&#12418;&#12375;&#12428;&#12394;&#12356;&#12392;&#12356;&#12358;&#20107;&#12434;&#24847;&#21619;&#12377;&#12427;Windows&#12463;&#12521;&#12452;&#12450;&#12531;&#12488;&#12398;&#22580;&#21512;&#12289;&#12392;&#12450;&#12503;&#12522;&#12465;&#12540;&#12471;&#12519;&#12531;
&#12395;&#12424;&#12387;&#12390;&#20351;&#12431;&#12428;&#12427;&#12363;&#12418;&#12375;&#12428;&#12394;&#12356;&#12290;&#12371;&#12428;&#12425;&#12395;&#12399;&#12289;&#23455;&#34892;&#26178;&#12395;VFS&#12514;&#12472;&#12517;&#12540;&#12523;&#12434;&#21205;&#30340;&#12395;&#12525;&#12540;&#12489;&#12377;&#12427;&#12383;&#12417;&#12398;
&#22522;&#30436;&#12434;&#25552;&#20379;&#12377;&#12427;&#12371;&#12392;&#12395;&#12424;&#12426;&#20966;&#29702;&#12364;&#20986;&#26469;&#12427;&#12371;&#12392;&#12392;Samba&#12398;&#12467;&#12450;&#12434;&#22793;&#26356;&#12394;&#12375;&#12395;&#12289;&#12371;&#12398;&#38477;&#38634;&#12434;&#25201;&#12358;&#12371;&#12392;&#12434;
&#35377;&#21487;&#12377;&#12427;&#12383;&#12417;&#12398;&#23455;&#38555;&#30340;&#12394;&#29702;&#30001;&#12364;&#12354;&#12427;&#12290;
This abstraction layer now provides more features than a regular POSIX
file system could fill in. It is not required that all of them should
be implemented by your particular file system.  However, when those
features are available, Samba would advertize them to a CIFS client
and they might be used by an application and in case of Windows client
that might mean a client expects even more additional functionality
when it encounters those features. There is a practical reason to
allow handling of this snowfall without modifying the Samba core and
it is fulfilled by providing an infrastructure to dynamically load VFS
modules at run time.
</p><p>&#21508;VFS&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;&#25968;&#22810;&#12367;&#12398;VFS&#21205;&#20316;&#12434;&#23455;&#35013;&#12391;&#12365;&#12427;&#12290;&#12381;&#12428;&#12364;&#12381;&#12428;&#12434;&#34892;&#12358;&#26041;&#27861;&#12392;&#12399;
&#28961;&#38306;&#20418;&#12391;&#12354;&#12426;&#12289;&#12383;&#12387;&#12383;2&#12388;&#12398;&#20107;&#12364;&#23455;&#38555;&#12395;&#12399;&#37325;&#35201;&#12391;&#12354;&#12427;:&#29305;&#23450;&#12398;&#23455;&#35013;&#12364;&#20182;&#12398;&#12514;&#12472;&#12517;&#12540;&#12523;&#12398;
&#23455;&#35013;&#12392;&#21332;&#35519;&#12377;&#12427;&#12371;&#12392;&#12434;&#24517;&#35201;&#12392;&#12375;&#12390;&#12356;&#12427;&#12363;&#21542;&#12363;&#12363;&#12392;&#12356;&#12358;&#12371;&#12392;&#12392;&#12289;&#12514;&#12472;&#12517;&#12540;&#12523;&#12364;&#12289;&#12381;&#12428;&#12364;&#21205;&#20316;&#20013;&#12398;
&#25991;&#33032;&#12391;&#29305;&#26377;&#12391;&#12354;&#12427;&#36861;&#21152;&#24773;&#22577;&#12434;&#26684;&#32013;&#12377;&#12427;&#12371;&#12392;&#12434;&#24517;&#35201;&#12392;&#12377;&#12427;&#12363;&#21542;&#12363;&#12392;&#12356;&#12358;&#12371;&#12392;&#12391;&#12354;&#12427;&#12290;
&#35079;&#25968;&#12398;VFS&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;&#21516;&#12376;&#26178;&#12395;&#12525;&#12540;&#12489;&#12391;&#12365;&#12289;&#30064;&#12394;&#12387;&#12383;&#12497;&#12521;&#12513;&#12540;&#12479;&#12391;&#21516;&#12376;VFS&#12514;&#12472;&#12517;&#12540;&#12523;&#12398;&#12289;
&#12356;&#12367;&#12388;&#12363;&#12398;&#12452;&#12531;&#12473;&#12479;&#12531;&#12473;&#12434;&#12525;&#12540;&#12489;&#12377;&#12427;&#12371;&#12392;&#12418;&#21487;&#33021;&#12391;&#12354;&#12427;&#12290;
</p><div class="sect2" title="&#27726;&#29992;&#12452;&#12531;&#12479;&#12501;&#12455;&#12540;&#12473;"><div class="titlepage"><div><div><h3 class="title"><a name="id2566190"></a>&#27726;&#29992;&#12452;&#12531;&#12479;&#12501;&#12455;&#12540;&#12473;</h3></div></div></div><p>VFS&#12514;&#12472;&#12517;&#12540;&#12523;&#12395;&#12399;3&#12388;&#12398;&#20027;&#35201;&#12394;&#12467;&#12531;&#12509;&#12540;&#12493;&#12531;&#12488;&#12364;&#12354;&#12427;:
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><span class="emphasis"><em>&#21021;&#26399;&#21270;&#38306;&#25968;</em></span> &#12371;&#12428;&#12399;&#12289;&#23455;&#35013;&#12373;&#12428;&#12383;&#25805;&#20316;&#12434;
&#30331;&#37682;&#12377;&#12427;&#12383;&#12417;&#12395;&#12514;&#12472;&#12517;&#12540;&#12523;&#12434;&#12525;&#12540;&#12489;&#12377;&#12427;&#38291;&#12395;&#21628;&#12400;&#12428;&#12427;&#12290;</p></li><li class="listitem"><p><span class="emphasis"><em>&#12458;&#12506;&#12524;&#12540;&#12471;&#12519;&#12531;&#12486;&#12540;&#12502;&#12523;</em></span> 
&#38745;&#30340;&#12395;&#23450;&#32681;&#12373;&#12428;&#12383;&#12514;&#12472;&#12517;&#12540;&#12523;&#38306;&#25968;&#12392;VFS&#12524;&#12452;&#12516;&#25805;&#20316;&#12398;&#38291;&#12391;&#12398;&#12510;&#12483;&#12500;&#12531;&#12464;&#12434;&#25552;&#20379;&#12377;&#12427;&#12290;
</p></li><li class="listitem"><p><span class="emphasis"><em>&#12514;&#12472;&#12517;&#12540;&#12523;&#38306;&#25968;</em></span> &#12371;&#12428;&#12399;&#23455;&#38555;&#12398;&#25805;&#20316;&#12434;&#34892;&#12358;&#12290;
		</p></li></ul></div><p>
</p><p>&#12371;&#12398;&#27083;&#36896;&#12364;VFS&#12469;&#12502;&#12471;&#12473;&#12486;&#12512;&#12395;&#23550;&#12375;&#12390;&#26368;&#21021;&#12395;&#36969;&#29992;&#12373;&#12428;&#12383;&#38291;&#12289;&#12525;&#12540;&#12480;&#12502;&#12523;&#12514;&#12472;&#12517;&#12540;&#12523;&#12434;
&#12469;&#12509;&#12540;&#12488;&#12377;&#12427;&#12377;&#12409;&#12390;&#12398;Samba3&#12469;&#12502;&#12471;&#12473;&#12486;&#12512;&#12395;&#12414;&#12383;&#12364;&#12387;&#12390;&#12289;&#29694;&#22312;&#20849;&#36890;&#30340;&#12395;&#20351;&#12431;&#12428;&#12427;&#12290;&#23455;&#38555;&#12289;&#12354;&#12427;1&#12388;&#12398;
&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;&#30064;&#12394;&#12387;&#12383;<span class="emphasis"><em>&#12458;&#12506;&#12524;&#12540;&#12471;&#12519;&#12531;&#12486;&#12540;&#12502;&#12523;</em></span>&#12434;&#20998;&#38626;&#12373;&#12428;&#12383;
<span class="emphasis"><em>&#21021;&#26399;&#21270;&#38306;&#25968;</em></span>&#12434;&#36890;&#12375;&#12390;&#20844;&#38283;&#12377;&#12427;&#12371;&#12392;&#12391;&#12289;&#30064;&#12394;&#12387;&#12383;&#12469;&#12502;&#12471;&#12473;&#12486;&#12512;&#12395;&#23550;&#12375;&#12390;&#12398;
&#25968;&#22810;&#12367;&#12398;&#12452;&#12531;&#12479;&#12501;&#12455;&#12540;&#12473;&#12434;&#25552;&#20379;&#12391;&#12365;&#12427;&#12290;</p><p><span class="emphasis"><em>&#21021;&#26399;&#21270;&#38306;&#25968;</em></span>&#12399;&#12289;Samba&#21205;&#20316;&#26178;&#12395;&#12514;&#12472;&#12517;&#12540;&#12523;&#12434;&#30331;&#37682;&#12377;&#12427;&#12398;&#12395;&#20351;&#12431;&#12428;&#12427;&#12290;
Samba&#12398;&#20869;&#37096;&#27083;&#36896;&#20307;&#12392;API&#12399;&#12289;&#26085;&#26178;&#12364;&#32076;&#12388;&#12395;&#12388;&#12428;&#22793;&#21270;&#12375;&#12289;&#21508;&#12522;&#12522;&#12540;&#12473;&#12496;&#12540;&#12472;&#12519;&#12531;&#12399;&#12289;VFS&#12398;&#38283;&#30330;&#20316;&#26989;&#12398;
&#12383;&#12417;&#12395;&#22679;&#21152;&#12375;&#12383;VFS&#12452;&#12531;&#12479;&#12501;&#12455;&#12540;&#12473;&#12496;&#12540;&#12472;&#12519;&#12531;&#12434;&#25345;&#12388;&#12363;&#12289;&#20219;&#24847;&#12398;Samba&#12398;&#27083;&#36896;&#20307;&#12364;&#12289;&#12496;&#12452;&#12490;&#12522;
&#38750;&#20114;&#25563;&#12398;&#26041;&#24335;&#12391;&#22793;&#26356;&#12373;&#12428;&#12427;&#12290;VFS&#12514;&#12472;&#12517;&#12540;&#12523;&#12364;&#12467;&#12531;&#12497;&#12452;&#12523;&#12373;&#12428;&#12427;&#12392;&#12365;&#12289;Samba&#29872;&#22659;&#12398;VFS
&#12452;&#12531;&#12479;&#12501;&#12455;&#12540;&#12473;&#12496;&#12540;&#12472;&#12519;&#12531;&#12399;&#12514;&#12472;&#12517;&#12540;&#12523;&#12398;&#12496;&#12452;&#12490;&#12522;&#12458;&#12502;&#12472;&#12455;&#12463;&#12488;&#20013;&#12395;&#22475;&#12417;&#36796;&#12414;&#12428;&#12289;&#12381;&#12428;&#12399;
&#12514;&#12472;&#12517;&#12540;&#12523;&#12398;&#12525;&#12540;&#12489;&#26178;&#12395;Samba&#12467;&#12450;&#12395;&#12424;&#12387;&#12390;&#12481;&#12455;&#12483;&#12463;&#12373;&#12428;&#12427;&#12290;&#12418;&#12375;&#12418;&#12289;&#12514;&#12472;&#12517;&#12540;&#12523;&#12395;&#12424;&#12387;&#12390;
&#36890;&#30693;&#12373;&#12428;&#12427;VFS&#12452;&#12531;&#12479;&#12501;&#12455;&#12540;&#12473;&#30058;&#21495;&#12364;&#12289;Samba&#12467;&#12450;&#12364;&#35469;&#35672;&#12377;&#12427;&#12418;&#12398;&#12392;&#19968;&#33268;&#12375;&#12394;&#12356;&#22580;&#21512;&#12289;&#12496;&#12540;&#12472;&#12519;&#12531;&#12398;
&#19981;&#19968;&#33268;&#12364;&#26908;&#20986;&#12373;&#12428;&#12289;(&#22793;&#26356;&#12373;&#12428;&#12383;)Samba&#27083;&#36896;&#20307;&#12434;&#12450;&#12463;&#12475;&#12473;&#12377;&#12427;&#12392;&#12365;&#12395;&#12289;&#12513;&#12514;&#12522;&#30772;&#22730;&#12398;&#21487;&#33021;&#24615;&#12434;
&#38450;&#12368;&#12383;&#12417;&#12395;&#12289;&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;&#12525;&#12540;&#12489;&#12373;&#12428;&#12394;&#12356;&#12290;
</p><p>&#12381;&#12428;&#25925;&#12289;&#21021;&#26399;&#21270;&#38306;&#25968;&#12399;VFS&#30331;&#37682;&#38306;&#25968; <code class="literal">smb_register_vfs()</code>&#12395;
3&#12388;&#12398;&#12497;&#12521;&#12513;&#12540;&#12479;&#12434;&#28193;&#12377;&#12290;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><span class="emphasis"><em>&#12452;&#12531;&#12479;&#12501;&#12455;&#12540;&#12473;&#12496;&#12540;&#12472;&#12519;&#12531;&#30058;&#21495;</em></span>, 
			<code class="literal">SMB_VFS_INTERFACE_VERSION</code>&#12392;&#12356;&#12358;&#23450;&#25968;&#12392;&#12375;&#12390;, </p></li><li class="listitem"><p><span class="emphasis"><em>&#12514;&#12472;&#12517;&#12540;&#12523;&#21517;</em></span>, Samba&#12467;&#12450;&#12364;&#35469;&#35672;&#12377;&#12427;&#12289;&#12381;&#12375;&#12390;
			</p></li><li class="listitem"><p><span class="emphasis"><em>&#12458;&#12506;&#12524;&#12540;&#12471;&#12519;&#12531;&#12486;&#12540;&#12502;&#12523;</em></span>&#12290;</p></li></ul></div><p>
</p><p><span class="emphasis"><em>&#12458;&#12506;&#12524;&#12540;&#12471;&#12519;&#12531;&#12486;&#12540;&#12502;&#12523;</em></span>&#12399;&#12289;&#12514;&#12472;&#12517;&#12540;&#12523;&#20869;&#12398;&#12393;&#12398;&#38306;&#25968;&#12364;&#12289;&#29305;&#23450;&#12398;
VFS&#25805;&#20316;&#12395;&#23550;&#24540;&#12375;&#12390;&#12356;&#12427;&#12363;&#12392;&#12289;&#12393;&#12398;&#12424;&#12358;&#12395;&#12381;&#12428;&#12425;&#12398;&#38306;&#25968;&#12434;&#12289;&#27531;&#12426;&#12398;VFS&#12469;&#12502;&#12471;&#12473;&#12486;&#12512;&#12392;&#21332;&#35519;
&#12373;&#12379;&#12427;&#12363;&#12434;&#23450;&#32681;&#12377;&#12427;&#12290;&#21508;&#12458;&#12506;&#12524;&#12540;&#12471;&#12519;&#12531;&#12399;&#20197;&#19979;&#12398;&#26041;&#27861;&#12391;&#23455;&#34892;&#12391;&#12365;&#12427;:
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><span class="emphasis"><em>transparent</em></span>,&#12371;&#12428;&#12399;&#12289;&#12458;&#12506;&#12524;&#12540;&#12471;&#12519;&#12531;&#12364;
	    &#19978;&#26360;&#12365;&#12373;&#12428;&#12390;&#12356;&#12427;&#38291;&#12289;&#12381;&#12398;&#22266;&#26377;&#12398;&#21205;&#20316;&#12398;&#21069;&#24460;&#12395;&#12289;&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;&#24341;&#12365;&#32154;&#12365;&#20197;&#21069;&#12398;
	    &#20966;&#29702;&#12434;&#21628;&#12403;&#20986;&#12377;&#12384;&#12429;&#12358;&#12290;&#12371;&#12398;&#12514;&#12540;&#12489;&#12399;
  <code class="literal">SMB_VFS_LAYER_TRANSPARENT</code>&#12392;&#12356;&#12358;&#23450;&#25968;&#12395;&#12424;&#12387;&#12390;&#25351;&#31034;&#12373;&#12428;&#12427;;</p></li><li class="listitem"><p><span class="emphasis"><em>opaque</em></span>, &#19968;&#36899;&#12398;&#21205;&#20316;&#12434;&#32066;&#20102;&#12373;&#12379;&#12390;&#12356;&#12427;&#20966;&#29702;&#29992;&#12290;
      &#12383;&#12392;&#12360;&#12400;&#12289;&#38750;POSIX&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#12289;&#12354;&#12427;&#12356;&#12399;&#12289;&#12383;&#12392;&#12360;&#12400;&#20491;&#20154;&#21521;&#12369;
      &#12458;&#12540;&#12487;&#12451;&#12458;&#12467;&#12524;&#12463;&#12471;&#12519;&#12531;&#12398;&#12383;&#12417;&#12398;&#12487;&#12540;&#12479;&#12505;&#12540;&#12473;&#12398;&#12424;&#12358;&#12394;&#12289;&#20840;&#12367;&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#12391;&#12394;&#12356;&#12418;&#12398;
      &#19978;&#12391;&#12398;POSIX&#21205;&#20316;&#12434;&#23455;&#35013;&#12377;&#12427;&#12398;&#12395;&#20351;&#12431;&#12428;&#12427;&#12290;&#12371;&#12398;&#12514;&#12540;&#12489;&#12391;&#12399;&#12289;&#23450;&#25968;
      <code class="literal">SMB_VFS_LAYER_OPAQUE</code>&#12434;&#20351;&#12358;&#12290;</p></li><li class="listitem"><p><span class="emphasis"><em>splitter</em></span>, &#12354;&#12427;&#31278;&#12398;&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#21205;&#20316;&#12364;&#12289;
      &#20197;&#21069;&#12398;&#23455;&#34892;&#12434;&#36879;&#36942;&#30340;&#12395;&#21628;&#12403;&#20986;&#12377;&#12383;&#12417;&#12395;&#36861;&#21152;&#12373;&#12428;&#12427;&#20013;&#12391;&#12289;&#32066;&#20102;&#12377;&#12427;&#26178;&#12398;&#26041;&#27861;&#12290;&#12371;&#12428;&#12399;&#36890;&#24120;&#12289;
      &#12381;&#12428;&#12434;&#21628;&#12403;&#20986;&#12377;&#20596;&#12395;&#25147;&#12377;&#21069;&#12395;&#12289;&#12381;&#12398;&#21628;&#12403;&#20986;&#12375;&#12398;&#32080;&#26524;&#12434;&#12510;&#12531;&#12464;&#12522;&#12531;&#12464;&#12377;&#12427;&#12371;&#12392;&#12434;&#20276;&#12358;&#12290;
      &#12371;&#12398;&#12514;&#12540;&#12489;&#12399;&#23450;&#25968;<code class="literal">SMB_VFS_LAYER_SPLITTER</code>&#12434;&#36984;&#25246;&#12377;&#12427;&#12290;
      </p></li><li class="listitem"><p><span class="emphasis"><em>logger</em></span>&#12399;&#20309;&#12418;&#22793;&#26356;&#12379;&#12378;&#12289;&#20309;&#12425;&#12398;&#36861;&#21152;VFS&#25805;&#20316;&#12418;&#34892;&#12431;&#12394;&#12356;&#12290;
      <span class="emphasis"><em>logger</em></span>&#12514;&#12472;&#12517;&#12540;&#12523;&#12364;&#21205;&#20316;&#12377;&#12427;&#12392;&#12365;&#12289;&#21205;&#20316;&#12395;&#12388;&#12356;&#12390;&#12398;&#24773;&#22577;&#12364;
      &#22806;&#37096;&#27231;&#33021;(&#12354;&#12427;&#12356;&#12399;Samba&#12398;&#22266;&#26377;&#12398;&#12487;&#12496;&#12483;&#12464;&#12484;&#12540;&#12523;)&#12434;&#20351;&#12387;&#12390;&#12393;&#12371;&#12363;&#12395;&#35352;&#37682;&#12373;&#12428;&#12427;&#12364;&#12289;
      &#12381;&#12428;&#12399;VFS&#12524;&#12452;&#12516;&#12391;&#12399;&#12394;&#12356;&#12290;&#12371;&#12398;&#12479;&#12452;&#12503;&#12398;&#21205;&#20316;&#12434;&#35352;&#36848;&#12377;&#12427;&#12383;&#12417;&#12395;&#12399;
      <code class="literal">SMB_VFS_LAYER_LOGGER</code>&#23450;&#25968;&#12434;&#20351;&#12358;&#12290;
  </p></li><li class="listitem"><p>&#27491;&#21453;&#23550;&#12395;&#12289;<span class="emphasis"><em>scanner</em></span>&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;&#12289;&#12471;&#12473;&#12486;&#12512;&#12395;&#28193;&#12373;&#12428;&#12427;
      &#12487;&#12540;&#12479;&#12434;&#20966;&#29702;&#12375;&#12390;&#12356;&#12427;&#38291;&#12289;&#20182;&#12398;VFS&#25805;&#20316;&#12434;&#21628;&#12403;&#20986;&#12377;&#12290;&#12371;&#12398;&#12479;&#12452;&#12503;&#12398;&#25805;&#20316;&#12399;&#12289;&#23450;&#25968;
      <code class="literal">SMB_VFS_LAYER_SCANNER</code>&#12395;&#12424;&#12387;&#12390;&#25351;&#31034;&#12373;&#12428;&#12427;&#12290;</p></li></ul></div><p>
</p><p>&#22522;&#26412;&#30340;&#12395;&#12289;<span class="emphasis"><em>transparent</em></span>, <span class="emphasis"><em>opaque</em></span>&#12392;
<span class="emphasis"><em>logger</em></span>&#12392;&#12356;&#12358;3&#12388;&#12398;&#12479;&#12452;&#12503;&#12364;&#12354;&#12427;&#12290;<span class="emphasis"><em>Splitter</em></span>&#12392;
<span class="emphasis"><em>scanner</em></span>&#12399;&#12289;&#38283;&#30330;&#32773;&#12434;&#28151;&#20081;&#12373;&#12379;&#12427;&#12363;&#12418;&#12375;&#12428;&#12394;&#12356;(&#12381;&#12375;&#12390;&#12289;&#25105;&#12293;&#12398;
&#32076;&#39443;&#12364;&#31034;&#12377;&#12424;&#12358;&#12395;&#12289;&#24444;&#12425;&#12399;&#20840;&#12367;&#28151;&#20081;&#12375;&#12390;&#12356;&#12427;)&#12364;&#12289;&#12371;&#12398;&#20998;&#21106;&#12399;&#12514;&#12472;&#12517;&#12540;&#12523;&#12398;&#21205;&#20316;&#12398;&#24615;&#36074;&#12434;
&#12424;&#12426;&#12424;&#12367;&#25552;&#31034;&#12377;&#12427;&#12399;&#12378;&#12391;&#12354;&#12427;&#12290;&#12371;&#12428;&#12414;&#12391;&#12398;&#25152;&#12289;&#38283;&#30330;&#12373;&#12428;&#12383;&#12411;&#12392;&#12435;&#12393;&#12398;&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;&#12289;
transparent&#12434;&#20276;&#12356;opaque&#12364;&#19968;&#33324;&#30340;&#12394;&#12289;3&#12388;&#12398;&#12479;&#12452;&#12503;&#12398;&#12393;&#12428;&#12363;&#12391;&#12354;&#12427;&#12290;
Most of modules
developed so far are either one of those three fundamental types with
transparent and opaque being prevalent.
</p><p>
&#21508;VFS&#25805;&#20316;&#12399;&#12289;&#25805;&#20316;&#12398;&#21628;&#12403;&#20986;&#12375;&#12434;&#31777;&#21336;&#12395;&#12373;&#12379;&#12427;&#12383;&#12417;&#12398;&#12289;vfs_op_type&#12289;&#38306;&#25968;&#12509;&#12452;&#12531;&#12479;&#12392;
vfs_ops&#27083;&#36896;&#20307;&#20013;&#12398;&#12495;&#12531;&#12489;&#12523;&#12509;&#12452;&#12531;&#12479;&#12392;&#12289;tree&#12510;&#12463;&#12525;&#12434;&#25345;&#12388;(
<code class="filename">include/vfs.h</code> &#12392;
<code class="filename">include/vfs_macros.h</code>&#12434;&#21442;&#29031;&#12398;&#12371;&#12392;)&#12290;
</p><pre class="programlisting">
typedef enum _vfs_op_type {
	SMB_VFS_OP_NOOP = -1,

	...

	/* File operations */

	SMB_VFS_OP_OPEN,
	SMB_VFS_OP_CLOSE,
	SMB_VFS_OP_READ,
	SMB_VFS_OP_WRITE,
	SMB_VFS_OP_LSEEK,
	SMB_VFS_OP_SENDFILE,

	...

	SMB_VFS_OP_LAST
} vfs_op_type;
</pre><p>&#12371;&#12398;&#27083;&#36896;&#20307;&#12399;&#38306;&#25968;&#12392;&#12377;&#12409;&#12390;&#12398;&#25805;&#20316;&#12398;&#12383;&#12417;&#12398;&#12495;&#12531;&#12489;&#12523;&#12509;&#12452;&#12531;&#12479;&#12434;&#21547;&#12416;&#12290;</p><pre class="programlisting">
struct vfs_ops {
	struct vfs_fn_pointers {
		...
		
		/* File operations */
		
		int (*open)(struct vfs_handle_struct *handle,
			struct connection_struct *conn,
			const char *fname, int flags, mode_t mode);
		int (*close)(struct vfs_handle_struct *handle,
			struct files_struct *fsp, int fd);
		ssize_t (*read)(struct vfs_handle_struct *handle, 
			struct files_struct *fsp, int fd, void *data, size_t n);
		ssize_t (*write)(struct vfs_handle_struct *handle, 
			struct files_struct *fsp, int fd, 
			const void *data, size_t n);
		SMB_OFF_T (*lseek)(struct vfs_handle_struct *handle, 
			struct files_struct *fsp, int fd, 
			SMB_OFF_T offset, int whence);
		ssize_t (*sendfile)(struct vfs_handle_struct *handle, 
			int tofd, files_struct *fsp, int fromfd, 
			const DATA_BLOB *header, SMB_OFF_T offset, size_t count);

		...
	} ops;
	
	struct vfs_handles_pointers {
		...
		
		/* File operations */
		
		struct vfs_handle_struct *open;
		struct vfs_handle_struct *close;
		struct vfs_handle_struct *read;
		struct vfs_handle_struct *write;
		struct vfs_handle_struct *lseek;
		struct vfs_handle_struct *sendfile;
		
		...
	} handles;
};
</pre><p>
&#12371;&#12398;&#12510;&#12463;&#12525;&#12399;&#20219;&#24847;&#12398;vfs&#25805;&#20316;&#12434;&#21628;&#12403;&#20986;&#12377;&#12383;&#12417;&#12395;*&#20351;&#12431;&#12428;&#12427;&#12409;&#12365;&#12391;&#12354;&#12427;*&#12290;
&#30452;&#25509;conn-&gt;vfs.ops.*&#12434;&#21628;&#12403;&#20986;&#12375;&#12390;&#12399;*&#12356;&#12369;&#12394;&#12356;!!!*
</p><pre class="programlisting">
...
	
/* File operations */
#define SMB_VFS_OPEN(conn, fname, flags, mode) \
	((conn)-&gt;vfs.ops.open((conn)-&gt;vfs.handles.open,\
	 (conn), (fname), (flags), (mode)))
#define SMB_VFS_CLOSE(fsp, fd) \
	((fsp)-&gt;conn-&gt;vfs.ops.close(\
	(fsp)-&gt;conn-&gt;vfs.handles.close, (fsp), (fd)))
#define SMB_VFS_READ(fsp, fd, data, n) \
	((fsp)-&gt;conn-&gt;vfs.ops.read(\
	(fsp)-&gt;conn-&gt;vfs.handles.read,\
	 (fsp), (fd), (data), (n)))
#define SMB_VFS_WRITE(fsp, fd, data, n) \
	((fsp)-&gt;conn-&gt;vfs.ops.write(\
	(fsp)-&gt;conn-&gt;vfs.handles.write,\
	 (fsp), (fd), (data), (n)))
#define SMB_VFS_LSEEK(fsp, fd, offset, whence) \
	((fsp)-&gt;conn-&gt;vfs.ops.lseek(\
	(fsp)-&gt;conn-&gt;vfs.handles.lseek,\
	 (fsp), (fd), (offset), (whence)))
#define SMB_VFS_SENDFILE(tofd, fsp, fromfd, header, offset, count) \
	((fsp)-&gt;conn-&gt;vfs.ops.sendfile(\
	(fsp)-&gt;conn-&gt;vfs.handles.sendfile,\
	 (tofd), (fsp), (fromfd), (header), (offset), (count)))

...
</pre></div><div class="sect2" title="&#26377;&#21177;&#12394;VFS&#25805;&#20316;&#12524;&#12452;&#12516;"><div class="titlepage"><div><div><h3 class="title"><a name="id2508754"></a>&#26377;&#21177;&#12394;VFS&#25805;&#20316;&#12524;&#12452;&#12516;</h3></div></div></div><p>
&#12371;&#12428;&#12425;&#12398;&#20516;&#12399;&#12289;&#35079;&#25968;&#12398;VFS&#12514;&#12472;&#12517;&#12540;&#12523;&#12392;&#12398;&#25509;&#32154;&#29992;&#12395;&#12289;conn-&gt;vfs&#12392;conn-&gt;vfs_opaque&#27083;&#36896;&#20307;&#12434;
&#27083;&#31689;&#12377;&#12427;&#12392;&#12365;&#12395;&#12289;VFS&#12469;&#12502;&#12471;&#12473;&#12486;&#12512;&#12395;&#12424;&#12387;&#12390;&#20351;&#12431;&#12428;&#12427;&#12290;&#20869;&#37096;&#30340;&#12395;Samba&#12399;&#12371;&#12398;&#12503;&#12525;&#12475;&#12473;&#12391;&#12289;opaque&#12392;
transparent&#12524;&#12452;&#12516;&#12398;&#12415;&#12434;&#21306;&#21029;&#12377;&#12427;&#12290;&#20182;&#12398;&#12479;&#12452;&#12503;&#12399;&#12289;&#12424;&#12426;&#12424;&#12356;&#35386;&#26029;&#27231;&#33021;&#12434;&#25552;&#20379;&#12377;&#12427;&#12383;&#12417;&#12395;&#20351;&#12431;&#12428;&#12427;&#12290;
</p><p>
&#12411;&#12392;&#12435;&#12393;&#12398;&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;transparent&#12524;&#12452;&#12516;&#12434;&#25552;&#20379;&#12377;&#12427;&#12290;opaque&#12524;&#12452;&#12516;&#12399;&#12289;&#23455;&#38555;&#12398;&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;
&#12467;&#12540;&#12523;(DB&#12505;&#12540;&#12473;&#12398;VFS&#12398;&#12424;&#12358;&#12394;)&#12434;&#23455;&#35013;&#12377;&#12427;&#12514;&#12472;&#12517;&#12540;&#12523;&#29992;&#12391;&#12354;&#12427;&#12290;&#20363;&#12360;&#12400;&#12289;&#26082;&#23450;&#20516;&#12398;&#12289;Samba&#12395;
&#32068;&#12415;&#36796;&#12414;&#12428;&#12390;&#12356;&#12427;POSIX VFS&#12399;opaque VFS&#12514;&#12472;&#12517;&#12540;&#12523;&#12391;&#12354;&#12427;&#12290;
</p><p>    
&#20182;&#12398;&#12524;&#12452;&#12516;&#12479;&#12452;&#12503;(logger, splitter, scanner)&#12399;&#30064;&#12394;&#12387;&#12383;transparency&#12398;&#27573;&#38542;&#12434;&#25552;&#20379;&#12377;&#12427;&#12383;&#12417;&#12392;&#12289;
&#35386;&#26029;VFS&#12514;&#12472;&#12517;&#12540;&#12523;&#12398;&#21205;&#20316;&#12398;&#12383;&#12417;&#12395;&#35373;&#35336;&#12373;&#12428;&#12383;&#12290;
</p><p>
&#21508;&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;&#12289;1&#12388;&#12398;&#12524;&#12452;&#12516;&#12399;1&#12388;&#12398;&#25805;&#20316;&#27598;&#12395;&#20351;&#12431;&#12428;&#12427;&#12289;&#21516;&#12376;&#26178;&#12395;&#25552;&#20379;&#12373;&#12428;&#12427;&#12356;&#12367;&#12388;&#12363;&#12398;
&#12524;&#12452;&#12516;&#12434;&#23455;&#35013;&#12391;&#12365;&#12427;&#12290;
</p><pre class="programlisting">
typedef enum _vfs_op_layer {
	SMB_VFS_LAYER_NOOP = -1,	/* - For using in VFS module to indicate end of array */
					/*   of operations description */
	SMB_VFS_LAYER_OPAQUE = 0,	/* - Final level, does not call anything beyond itself */
	SMB_VFS_LAYER_TRANSPARENT,	/* - Normal operation, calls underlying layer after */
					/*   possibly changing passed data */
	SMB_VFS_LAYER_LOGGER,		/* - Logs data, calls underlying layer, logging may not */
					/*   use Samba VFS */
	SMB_VFS_LAYER_SPLITTER,		/* - Splits operation, calls underlying layer _and_ own facility, */
					/*   then combines result */
	SMB_VFS_LAYER_SCANNER		/* - Checks data and possibly initiates additional */
					/*   file activity like logging to files _inside_ samba VFS */
} vfs_op_layer;
</pre></div></div><div class="sect1" title="Samba VFS&#12469;&#12502;&#12471;&#12473;&#12486;&#12512;&#12392;&#12514;&#12472;&#12517;&#12540;&#12523;&#12398;&#38291;&#12391;&#12398;&#30456;&#20114;&#20316;&#29992;"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2508830"></a>Samba VFS&#12469;&#12502;&#12471;&#12473;&#12486;&#12512;&#12392;&#12514;&#12472;&#12517;&#12540;&#12523;&#12398;&#38291;&#12391;&#12398;&#30456;&#20114;&#20316;&#29992;</h2></div></div></div><div class="sect2" title="&#21021;&#26399;&#21270;&#12392;&#30331;&#37682;"><div class="titlepage"><div><div><h3 class="title"><a name="id2508837"></a>&#21021;&#26399;&#21270;&#12392;&#30331;&#37682;</h3></div></div></div><p>
&#21508;Samba&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;VFS&#12514;&#12472;&#12517;&#12540;&#12523;&#12391;&#12289;&#12381;&#12428;&#12364;Samba&#12395;&#38745;&#30340;&#12395;&#12522;&#12531;&#12463;&#12373;&#12428;&#12427;&#12394;&#12425;&#12400;&#12289;
</p><pre class="programlisting">NTSTATUS vfs_example_init(void);</pre><p>&#38306;&#25968;&#12363;&#12289;
&#20849;&#26377;&#12514;&#12472;&#12517;&#12540;&#12523;&#12394;&#12425;&#12400;&#12289;
</p><pre class="programlisting">NTSTATUS init_module(void);</pre><p>&#38306;&#25968;&#12434;&#25345;&#12388;&#12409;&#12365;&#12391;&#12354;&#12427;&#12290;
</p><p>
&#12371;&#12428;&#12399;&#12289;&#12514;&#12472;&#12517;&#12540;&#12523;&#20869;&#37096;&#12398;&#38745;&#30340;&#12391;&#12394;&#12356;&#38306;&#25968;&#12398;&#12415;&#12364;&#12381;&#12358;&#12377;&#12409;&#12365;&#12391;&#12354;&#12427;&#12290;&#12464;&#12525;&#12540;&#12496;&#12523;
&#22793;&#25968;&#12399;&#21516;&#27096;&#12395;&#38745;&#30340;&#12391;&#12354;&#12427;&#12409;&#12365;&#12391;&#12354;&#12427;!
</p><p>
&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;&#12381;&#12398;&#38306;&#25968;&#12434;
</p><pre class="programlisting">
NTSTATUS smb_register_vfs(int version, const char *name, vfs_op_tuple *vfs_op_tuples);
</pre><p>
&#38306;&#25968;&#32076;&#30001;&#12391;&#30331;&#37682;&#12377;&#12409;&#12365;&#12391;&#12354;&#12427;&#12290;
</p><div class="variablelist"><dl><dt><span class="term">version</span></dt><dd><p>&#12399;SMB_VFS_INTERFACE_VERSION&#12391;&#35373;&#23450;&#12373;&#12428;&#12427;&#12409;&#12365;&#12391;&#12354;&#12427;&#12290;</p></dd><dt><span class="term">name</span></dt><dd><p>&#12371;&#12428;&#12399;&#12289;&#12371;&#12398;&#12514;&#12472;&#12517;&#12540;&#12523;&#12434;&#20351;&#12358;&#12383;&#12417;&#12395;&#12289;<code class="literal">vfs objects</code>
&#12497;&#12521;&#12513;&#12540;&#12479;&#20013;&#12391;&#19968;&#35239;&#34920;&#31034;&#12377;&#12427;&#20107;&#12364;&#20986;&#26469;&#12427;&#21517;&#21069;&#12391;&#12354;&#12427;&#12290;</p></dd><dt><span class="term">vfs_op_tuples</span></dt><dd><p>
&#12371;&#12428;&#12399;&#12289;vfs_op_tuple&#12398;&#37197;&#21015;&#12391;&#12354;&#12427;(vfs_op_tuples&#12399;&#12289;&#35443;&#32048;&#12364;&#20197;&#19979;&#12391;&#35500;&#26126;&#12373;&#12428;&#12427;)&#12290;
</p></dd></dl></div><p>
&#12514;&#12472;&#12517;&#12540;&#12523;&#12364;&#25552;&#20379;&#12377;&#12427;&#12371;&#12392;&#12434;&#26395;&#12416;&#21508;&#25805;&#20316;&#12398;&#12383;&#12417;&#12395;&#12289;vfs_op_tuple&#20837;&#12428;&#12388;&#12435;&#20013;&#12395;&#12456;&#12531;&#12488;&#12522;&#12364;
&#12354;&#12427;&#12290;
</p><pre class="programlisting">
typedef struct _vfs_op_tuple {
	void* op;
	vfs_op_type type;
	vfs_op_layer layer;
} vfs_op_tuple;
</pre><div class="variablelist"><dl><dt><span class="term">op</span></dt><dd><p>&#25351;&#23450;&#12375;&#12383;&#38306;&#25968;&#12408;&#12398;&#38306;&#25968;&#12509;&#12452;&#12531;&#12479;&#12290;</p></dd><dt><span class="term">type</span></dt><dd><p>&#12393;&#12398;&#25805;&#20316;&#12434;&#38306;&#25968;&#12364;&#25552;&#20379;&#12377;&#12427;&#12363;&#12434;&#25351;&#23450;&#12377;&#12427;&#12383;&#12417;&#12398;&#12289;&#38306;&#25968;&#12398;vfs_op_type&#12290;</p></dd><dt><span class="term">layer</span></dt><dd><p>&#12393;&#12371;&#12391;&#38306;&#25968;&#12364;&#25805;&#20316;&#12377;&#12427;&#12363;&#12398;vfs_op_layer&#12290;</p></dd></dl></div><p>&#31777;&#21336;&#12394;&#20363;:</p><pre class="programlisting">
static vfs_op_tuple example_op_tuples[] = {	
	{SMB_VFS_OP(example_connect),	SMB_VFS_OP_CONNECT,	SMB_VFS_LAYER_TRANSPARENT},
	{SMB_VFS_OP(example_disconnect),	SMB_VFS_OP_DISCONNECT,	SMB_VFS_LAYER_TRANSPARENT},

	{SMB_VFS_OP(example_rename),	SMB_VFS_OP_RENAME,	SMB_VFS_LAYER_OPAQUE},

	/* This indicates the end of the array */
	{SMB_VFS_OP(NULL),				SMB_VFS_OP_NOOP,	SMB_VFS_LAYER_NOOP}
};

NTSTATUS init_module(void)
{
	return smb_register_vfs(SMB_VFS_INTERFACE_VERSION, "example", example_op_tuples);
}
</pre></div><div class="sect2" title="&#12393;&#12398;&#12424;&#12358;&#12395;&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;&#25509;&#32154;&#21336;&#20301;&#12391;&#12487;&#12540;&#12479;&#12434;&#20966;&#29702;&#12377;&#12427;&#12363;"><div class="titlepage"><div><div><h3 class="title"><a name="id2567085"></a>&#12393;&#12398;&#12424;&#12358;&#12395;&#12514;&#12472;&#12517;&#12540;&#12523;&#12399;&#25509;&#32154;&#21336;&#20301;&#12391;&#12487;&#12540;&#12479;&#12434;&#20966;&#29702;&#12377;&#12427;&#12363;</h3></div></div></div><p>&#21508;VFS&#38306;&#25968;&#12398;&#26368;&#21021;&#12398;&#12497;&#12521;&#12513;&#12540;&#12479;&#12399;&#12289;vfs_handle_struct&#12514;&#12472;&#12517;&#12540;&#12523;&#12408;&#12398;&#12509;&#12452;&#12531;&#12479;&#12391;&#12354;&#12427;&#12290;
</p><pre class="programlisting">
typedef struct vfs_handle_struct {
	struct vfs_handle_struct  *next, *prev;
	const char *param;
	struct vfs_ops vfs_next;
	struct connection_struct *conn;
	void *data;
	void (*free_data)(void **data);
} vfs_handle_struct;
</pre><div class="variablelist"><dl><dt><span class="term">param</span></dt><dd><p>&#12371;&#12428;&#12399;<code class="literal">vfs objects</code>&#12497;&#12521;&#12513;&#12540;&#12479;&#20013;&#12391;&#25351;&#23450;&#12373;&#12428;&#12427;&#12514;&#12472;&#12517;&#12540;&#12523;
&#12497;&#12521;&#12513;&#12540;&#12479;&#12391;&#12354;&#12427;&#12290;</p><p>&#12377;&#12394;&#12431;&#12385;&#12289;'vfs objects = example:test'&#29992;&#12497;&#12521;&#12513;&#12540;&#12479;&#12399;&#12289;"test"&#12391;&#12354;&#12429;&#12358;&#12290;</p></dd><dt><span class="term">vfs_next</span></dt><dd><p>&#12371;&#12398;vfs_ops&#27083;&#36896;&#20307;&#12395;&#12399;&#12289;&#27425;&#12398;&#12514;&#12472;&#12517;&#12540;&#12523;&#25805;&#20316;&#12434;&#21628;&#12403;&#20986;&#12377;&#12383;&#12417;&#12398;&#24773;&#22577;&#12364;&#21547;&#12414;&#12428;&#12390;&#12356;&#12427;&#12290;
&#27425;&#12398;&#12514;&#12472;&#12517;&#12540;&#12523;&#25805;&#20316;&#12434;&#21628;&#12406;&#12383;&#12417;&#12395;SMB_VFS_NEXT_*&#12510;&#12463;&#12525;&#12434;&#20351;&#12356;&#12289;&#30452;&#25509;handle-&gt;vfs_next.ops.*&#12395;
&#12450;&#12463;&#12475;&#12473;&#12375;&#12394;&#12356;&#12371;&#12392;!</p></dd><dt><span class="term">conn</span></dt><dd><p>&#12371;&#12428;&#12399;&#12289;&#12495;&#12531;&#12489;&#12523;&#12364;&#24112;&#23646;&#12377;&#12427;connection_struct&#12395;&#25147;&#12427;&#12383;&#12417;&#12398;&#12509;&#12452;&#12531;&#12479;&#12391;&#12354;&#12427;&#12290;</p></dd><dt><span class="term">data</span></dt><dd><p>&#12514;&#12472;&#12517;&#12540;&#12523;&#22266;&#26377;&#12487;&#12540;&#12479;&#12434;&#20445;&#25345;&#12377;&#12427;&#12383;&#12417;&#12398;&#12509;&#12452;&#12531;&#12479;&#12391;&#12354;&#12427;&#12290;
handle-&gt;conn-&gt;mem_ctx TALLOC_CTX&#19978;&#12391;&#25509;&#32154;&#12364;&#26377;&#21177;&#12394;&#38291;&#12289;&#12487;&#12540;&#12479;&#12434;alloc&#12391;&#12365;&#12427;&#12290;
&#12375;&#12363;&#12375;&#12289;&#33258;&#20998;&#33258;&#36523;&#12391;&#12513;&#12514;&#12522;&#31649;&#29702;&#12434;&#34892;&#12358;&#24517;&#35201;&#12418;&#12354;&#12427;&#12290;</p></dd><dt><span class="term">free_data</span></dt><dd><p>&#12371;&#12428;&#12399;&#12289;&#12514;&#12472;&#12517;&#12540;&#12523;&#22266;&#26377;&#12487;&#12540;&#12479;&#12434;&#12501;&#12522;&#12540;&#12395;&#12377;&#12427;&#38306;&#25968;&#12408;&#12398;&#12509;&#12452;&#12531;&#12479;&#12391;&#12354;&#12427;&#12290;
TALLOC_CTX handle-&gt;conn-&gt;mem_ctx&#19978;&#12391;&#22266;&#26377;&#12487;&#12540;&#12479;&#12434;talloc&#12375;&#12383;&#22580;&#21512;&#12289;&#12371;&#12398;&#38306;&#25968;&#12509;&#12452;&#12531;&#12479;&#12399;
NULL&#12395;&#35373;&#23450;&#12377;&#12427;&#12371;&#12392;&#12364;&#20986;&#26469;&#12427;&#12290;</p></dd></dl></div><p>&#22266;&#26377;&#12487;&#12540;&#12479;&#12434;&#25201;&#12358;&#12383;&#12417;&#12398;&#12289;&#12356;&#12367;&#12388;&#12363;&#12398;&#26377;&#30410;&#12394;&#12510;&#12463;&#12525;&#12290;
</p><pre class="programlisting">
#define SMB_VFS_HANDLE_GET_DATA(handle, datap, type, ret) { \
	if (!(handle)||((datap=(type *)(handle)-&gt;data)==NULL)) { \
		DEBUG(0,("%s() failed to get vfs_handle-&gt;data!\n",FUNCTION_MACRO)); \
		ret; \
	} \
}

#define SMB_VFS_HANDLE_SET_DATA(handle, datap, free_fn, type, ret) { \
	if (!(handle)) { \
		DEBUG(0,("%s() failed to set handle-&gt;data!\n",FUNCTION_MACRO)); \
		ret; \
	} else { \
		if ((handle)-&gt;free_data) { \
			(handle)-&gt;free_data(&amp;(handle)-&gt;data); \
		} \
		(handle)-&gt;data = (void *)datap; \
		(handle)-&gt;free_data = free_fn; \
	} \
}

#define SMB_VFS_HANDLE_FREE_DATA(handle) { \
	if ((handle) &amp;&amp; (handle)-&gt;free_data) { \
		(handle)-&gt;free_data(&amp;(handle)-&gt;data); \
	} \
}
</pre><p>SMB_VFS_LAYER_TRANSPARENT&#38306;&#25968;&#12364;SMB_VFS_LAYER_OPAQUE&#38306;&#25968;&#12434;&#21628;&#12403;&#20986;&#12379;&#12427;&#26041;&#24335;&#12290;</p><p>&#12371;&#12428;&#12434;&#34892;&#12358;&#26368;&#12418;&#31777;&#21336;&#12394;&#26041;&#27861;&#12399;&#12289;SMB_VFS_OPAQUE_*&#12510;&#12463;&#12525;&#12434;&#20351;&#12358;&#12371;&#12392;&#12391;&#12354;&#12427;&#12290;
</p><pre class="programlisting">
...
/* File operations */
#define SMB_VFS_OPAQUE_OPEN(conn, fname, flags, mode) \
	((conn)-&gt;vfs_opaque.ops.open(\
	(conn)-&gt;vfs_opaque.handles.open,\
	 (conn), (fname), (flags), (mode)))
#define SMB_VFS_OPAQUE_CLOSE(fsp, fd) \
	((fsp)-&gt;conn-&gt;vfs_opaque.ops.close(\
	(fsp)-&gt;conn-&gt;vfs_opaque.handles.close,\
	 (fsp), (fd)))
#define SMB_VFS_OPAQUE_READ(fsp, fd, data, n) \
	((fsp)-&gt;conn-&gt;vfs_opaque.ops.read(\
	(fsp)-&gt;conn-&gt;vfs_opaque.handles.read,\
	 (fsp), (fd), (data), (n)))
#define SMB_VFS_OPAQUE_WRITE(fsp, fd, data, n) \
	((fsp)-&gt;conn-&gt;vfs_opaque.ops.write(\
	(fsp)-&gt;conn-&gt;vfs_opaque.handles.write,\
	 (fsp), (fd), (data), (n)))
#define SMB_VFS_OPAQUE_LSEEK(fsp, fd, offset, whence) \
	((fsp)-&gt;conn-&gt;vfs_opaque.ops.lseek(\
	(fsp)-&gt;conn-&gt;vfs_opaque.handles.lseek,\
	 (fsp), (fd), (offset), (whence)))
#define SMB_VFS_OPAQUE_SENDFILE(tofd, fsp, fromfd, header, offset, count) \
	((fsp)-&gt;conn-&gt;vfs_opaque.ops.sendfile(\
	(fsp)-&gt;conn-&gt;vfs_opaque.handles.sendfile,\
	 (tofd), (fsp), (fromfd), (header), (offset), (count)))
...
</pre><p>SMB_VFS_LAYER_TRANSPARENT&#38306;&#25968;&#12364;&#27425;&#12398;&#12514;&#12472;&#12517;&#12540;&#12523;&#38306;&#25968;&#12434;&#21628;&#12403;&#20986;&#12379;&#12427;&#26041;&#24335;&#12290;</p><p>&#12371;&#12428;&#12434;&#34892;&#12358;&#26368;&#12418;&#31777;&#21336;&#12394;&#26041;&#27861;&#12399;&#12289;SMB_VFS_NEXT_*&#12510;&#12463;&#12525;&#12434;&#20351;&#12358;&#12371;&#12392;&#12391;&#12354;&#12427;&#12290;
</p><pre class="programlisting">
...
/* File operations */
#define SMB_VFS_NEXT_OPEN(handle, conn, fname, flags, mode) \
	((handle)-&gt;vfs_next.ops.open(\
	(handle)-&gt;vfs_next.handles.open,\
	 (conn), (fname), (flags), (mode)))
#define SMB_VFS_NEXT_CLOSE(handle, fsp, fd) \
	((handle)-&gt;vfs_next.ops.close(\
	(handle)-&gt;vfs_next.handles.close,\
	 (fsp), (fd)))
#define SMB_VFS_NEXT_READ(handle, fsp, fd, data, n) \
	((handle)-&gt;vfs_next.ops.read(\
	(handle)-&gt;vfs_next.handles.read,\
	 (fsp), (fd), (data), (n)))
#define SMB_VFS_NEXT_WRITE(handle, fsp, fd, data, n) \
	((handle)-&gt;vfs_next.ops.write(\
	(handle)-&gt;vfs_next.handles.write,\
	 (fsp), (fd), (data), (n)))
#define SMB_VFS_NEXT_LSEEK(handle, fsp, fd, offset, whence) \
	((handle)-&gt;vfs_next.ops.lseek(\
	(handle)-&gt;vfs_next.handles.lseek,\
	 (fsp), (fd), (offset), (whence)))
#define SMB_VFS_NEXT_SENDFILE(handle, tofd, fsp, fromfd, header, offset, count) \
	((handle)-&gt;vfs_next.ops.sendfile(\
	(handle)-&gt;vfs_next.handles.sendfile,\
	 (tofd), (fsp), (fromfd), (header), (offset), (count)))
...
</pre></div></div><div class="sect1" title="&#26032;&#12375;&#12356;VFS&#12452;&#12531;&#12479;&#12501;&#12455;&#12540;&#12473;&#12408;&#12398;&#12450;&#12483;&#12503;&#12464;&#12524;&#12540;&#12489;"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2567307"></a>&#26032;&#12375;&#12356;VFS&#12452;&#12531;&#12479;&#12501;&#12455;&#12540;&#12473;&#12408;&#12398;&#12450;&#12483;&#12503;&#12464;&#12524;&#12540;&#12489;</h2></div></div></div><div class="sect2" title="2.2.*&#12363;&#12425;3.0&#945;&#12514;&#12472;&#12517;&#12540;&#12523;&#12408;&#12398;&#12450;&#12483;&#12503;&#12464;&#12524;&#12540;&#12489;"><div class="titlepage"><div><div><h3 class="title"><a name="id2567314"></a>2.2.*&#12363;&#12425;3.0&#945;&#12514;&#12472;&#12517;&#12540;&#12523;&#12408;&#12398;&#12450;&#12483;&#12503;&#12464;&#12524;&#12540;&#12489;</h3></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
&#12377;&#12409;&#12390;&#12398;vfs&#25805;&#20316;&#38306;&#25968;&#12395;&#26368;&#21021;&#12398;&#12497;&#12521;&#12513;&#12540;&#12479;&#12392;&#12375;&#12390;"vfs_handle_struct *handle, "
&#12434;&#36861;&#21152;&#12377;&#12427;&#12290;&#20363;&#12360;&#12400;&#12289;
example_connect(connection_struct *conn, const char *service, const char *user);
-&gt;   example_connect(vfs_handle_struct *handle, connection_struct *conn, const char *service, const char *user);
</p></li><li class="listitem"><p>
"default_vfs_ops."&#12434;"smb_vfs_next_"&#12391;&#32622;&#12365;&#25563;&#12360;&#12427;&#12290;&#12383;&#12392;&#12360;&#12400;&#12289;
default_vfs_ops.connect(conn, service, user);
-&gt;   smb_vfs_next_connect(conn, service, user);
</p></li><li class="listitem"><p>
&#12377;&#12409;&#12390;&#12398;"smb_vfs_next_*"&#38306;&#25968;&#12434;&#22823;&#25991;&#23383;&#21270;&#12377;&#12427;&#12290;&#12383;&#12392;&#12360;&#12400;&#12289;
e.g. smb_vfs_next_connect(conn, service, user);
-&gt;   SMB_VFS_NEXT_CONNECT(conn, service, user);
</p></li><li class="listitem"><p>
&#12377;&#12409;&#12390;&#12398;SMB_VFS_NEXT_*()&#21628;&#12403;&#20986;&#12375;&#12395;&#23550;&#12375;&#12390;&#26368;&#21021;&#12398;&#12497;&#12521;&#12513;&#12540;&#12479;&#12392;&#12375;&#12390;"handle, "&#12434;
&#36861;&#21152;&#12377;&#12427;&#12290;&#12383;&#12392;&#12360;&#12400;&#12289;
SMB_VFS_NEXT_CONNECT(conn, service, user);
-&gt;   SMB_VFS_NEXT_CONNECT(handle, conn, service, user);
</p></li><li class="listitem"><p>
(2.2.*&#12514;&#12472;&#12517;&#12540;&#12523;&#29992;&#12398;&#12415;) 
&#21476;&#12356;struct vfs_ops example_ops&#12434;vfs_op_tuple example_op_tuples[]&#37197;&#21015;&#12395;&#22793;&#25563;&#12377;&#12427;&#12290;&#12383;&#12392;&#12360;&#12400;&#12289;
</p><pre class="programlisting">
struct vfs_ops example_ops = {
	/* Disk operations */
	example_connect,		/* connect */
	example_disconnect,		/* disconnect */
	NULL,				/* disk free *
	/* Directory operations */
	NULL,				/* opendir */
	NULL,				/* readdir */
	NULL,				/* mkdir */
	NULL,				/* rmdir */
	NULL,				/* closedir */
	/* File operations */
	NULL,				/* open */
	NULL,				/* close */
	NULL,				/* read  */
	NULL,				/* write */
	NULL,				/* lseek */
	NULL,				/* sendfile */
	NULL,				/* rename */
	NULL,				/* fsync */
	example_stat,			/* stat  */
	example_fstat,			/* fstat */
	example_lstat,			/* lstat */
	NULL,				/* unlink */
	NULL,				/* chmod */
	NULL,				/* fchmod */
	NULL,				/* chown */
	NULL,				/* fchown */
	NULL,				/* chdir */
	NULL,				/* getwd */
	NULL,				/* utime */
	NULL,				/* ftruncate */
	NULL,				/* lock */
	NULL,				/* symlink */
	NULL,				/* readlink */
	NULL,				/* link */
	NULL,				/* mknod */
	NULL,				/* realpath */
	NULL,				/* fget_nt_acl */
	NULL,				/* get_nt_acl */
	NULL,				/* fset_nt_acl */
	NULL,				/* set_nt_acl */

	NULL,				/* chmod_acl */
	NULL,				/* fchmod_acl */

	NULL,				/* sys_acl_get_entry */
	NULL,				/* sys_acl_get_tag_type */
	NULL,				/* sys_acl_get_permset */
	NULL,				/* sys_acl_get_qualifier */
	NULL,				/* sys_acl_get_file */
	NULL,				/* sys_acl_get_fd */
	NULL,				/* sys_acl_clear_perms */
	NULL,				/* sys_acl_add_perm */
	NULL,				/* sys_acl_to_text */
	NULL,				/* sys_acl_init */
	NULL,				/* sys_acl_create_entry */
	NULL,				/* sys_acl_set_tag_type */
	NULL,				/* sys_acl_set_qualifier */
	NULL,				/* sys_acl_set_permset */
	NULL,				/* sys_acl_valid */
	NULL,				/* sys_acl_set_file */
	NULL,				/* sys_acl_set_fd */
	NULL,				/* sys_acl_delete_def_file */
	NULL,				/* sys_acl_get_perm */
	NULL,				/* sys_acl_free_text */
	NULL,				/* sys_acl_free_acl */
	NULL				/* sys_acl_free_qualifier */
};
</pre><p>
-&gt;
</p><pre class="programlisting"> 
static vfs_op_tuple example_op_tuples[] = {
	{SMB_VFS_OP(example_connect),	SMB_VFS_OP_CONNECT,	SMB_VFS_LAYER_TRANSPARENT},
	{SMB_VFS_OP(example_disconnect),	SMB_VFS_OP_DISCONNECT,	SMB_VFS_LAYER_TRANSPARENT},
	
	{SMB_VFS_OP(example_fstat), 	SMB_VFS_OP_FSTAT,	SMB_VFS_LAYER_TRANSPARENT},
	{SMB_VFS_OP(example_stat),		SMB_VFS_OP_STAT,	SMB_VFS_LAYER_TRANSPARENT},
	{SMB_VFS_OP(example_lstat), 	SMB_VFS_OP_LSTAT,	SMB_VFS_LAYER_TRANSPARENT},

	{SMB_VFS_OP(NULL),				SMB_VFS_OP_NOOP,	SMB_VFS_LAYER_NOOP}
};
</pre><p>
</p></li><li class="listitem"><p>
example_op_tuples[]&#37197;&#21015;&#12434;&#12501;&#12449;&#12452;&#12523;&#12398;&#26368;&#24460;&#12395;&#31227;&#21205;&#12377;&#12427;&#12290;
</p></li><li class="listitem"><p>
&#12501;&#12449;&#12452;&#12523;&#12398;&#26368;&#24460;&#12395;init_module()&#38306;&#25968;&#12434;&#36861;&#21152;&#12377;&#12427;&#12290;&#12383;&#12392;&#12360;&#12400;&#12289;
</p><pre class="programlisting">
NTSTATUS init_module(void)
{
	return smb_register_vfs(SMB_VFS_INTERFACE_VERSION,"example",example_op_tuples);
}
</pre><p>
</p></li><li class="listitem"><p>
&#20351;&#29992;&#12375;&#12390;&#12356;&#12427;vfs_init()&#38306;&#25968;&#12364;vfs_ops&#27083;&#36896;&#20307;&#12434;&#28310;&#20633;&#12377;&#12427;&#12384;&#12369;&#20197;&#19978;&#12363;&#12289;smb_vfs_handle_struct
&#27083;&#36896;&#20307;&#12434;&#35352;&#25014;&#12375;&#12390;&#12356;&#12427;&#12363;&#12434;&#35519;&#12409;&#12427;&#12290;
</p><table border="0" summary="Simple list" class="simplelist"><tr><td>&#12418;&#12375;&#12418;&#12381;&#12358;&#12391;&#12394;&#12369;&#12428;&#12400;&#12289;vfs_init()&#38306;&#25968;&#12434;&#21462;&#12426;&#38500;&#12367;&#12371;&#12392;&#12364;&#20986;&#26469;&#12427;&#12290;</td></tr><tr><td>&#12418;&#12375;&#12418;&#12381;&#12358;&#12394;&#12425;&#12400;&#12289;&#12467;&#12540;&#12489;&#12434;example_connect()&#25805;&#20316;&#12395;&#31227;&#12377;&#12363;&#12289;init_module()&#12395;&#31227;&#12377;&#12363;&#12434;&#27770;&#12417;&#12427;&#12290;
&#12381;&#12375;&#12390;&#27425;&#12395;&#12289;vfs_init()&#12434;&#21462;&#12426;&#38500;&#12367;&#12290;&#12383;&#12392;&#12360;&#12400;&#12289;debug&#12463;&#12521;&#12473;&#12398;&#30331;&#37682;&#12399;&#12289;init_module()&#12395;&#34892;&#12367;&#12409;&#12365;&#12391;
&#12354;&#12426;&#12289;&#22266;&#26377;&#12487;&#12540;&#12479;&#12398;&#21106;&#12426;&#24403;&#12390;&#12399;example_connect()&#12395;&#34892;&#12367;&#12409;&#12365;&#12391;&#12354;&#12427;&#12290;</td></tr></table><p>
</p></li><li class="listitem"><p>
(3.0alpha*&#12514;&#12472;&#12517;&#12540;&#12523;&#12398;&#12415;) 
&#20351;&#29992;&#12375;&#12390;&#12356;&#12427;vfs_done()&#38306;&#25968;&#12364;&#24517;&#35201;&#12392;&#12373;&#12428;&#12427;&#12467;&#12540;&#12489;&#12434;&#21547;&#12435;&#12391;&#12356;&#12427;&#12363;&#12434;&#30906;&#35469;&#12377;&#12427;&#12290;
</p><table border="0" summary="Simple list" class="simplelist"><tr><td>&#12418;&#12375;&#12418;&#12381;&#12358;&#12391;&#12394;&#12369;&#12428;&#12400;&#12289;vfs_done()&#38306;&#25968;&#12434;&#21462;&#12426;&#38500;&#12367;&#12371;&#12392;&#12364;&#20986;&#26469;&#12427;&#12290;</td></tr><tr><td>&#12418;&#12375;&#12418;&#12381;&#12358;&#12394;&#12425;&#12400;&#12289;&#12467;&#12540;&#12489;&#12434;example_disconnect()&#25805;&#20316;&#12395;&#31227;&#21205;&#20986;&#26469;&#12427;&#12363;&#12434;&#27770;&#12417;&#12427;&#12290;
&#12381;&#12428;&#20197;&#22806;&#12398;&#22580;&#21512;&#12289;smb_register_exit_event()&#12392;&#19968;&#32210;&#12395;SMB_EXIT_EVENT&#12434;&#30331;&#37682;&#12377;&#12427;&#12290;&#12383;&#12392;&#12360;&#12400;&#12289;
&#22266;&#26377;&#12487;&#12540;&#12479;&#12434;&#38283;&#25918;&#12377;&#12427;&#20107;&#12399;example_disconnect()&#12395;&#34892;&#12367;&#12409;&#12365;&#12391;&#12354;&#12427;&#12290;
</td></tr></table><p>
</p></li><li class="listitem"><p>
&#20309;&#12425;&#12363;&#12398;&#12464;&#12525;&#12540;&#12496;&#12523;&#22793;&#25968;&#12364;&#27531;&#12387;&#12390;&#12356;&#12427;&#12363;&#12434;&#30906;&#35469;&#12377;&#12427;&#12290;
&#12418;&#12375;&#12418;&#12467;&#12493;&#12463;&#12471;&#12519;&#12531;&#12505;&#12540;&#12473;&#19978;&#12395;&#12371;&#12398;&#12487;&#12540;&#12479;&#12434;&#25345;&#12388;&#26041;&#12364;&#12424;&#12356;&#12363;&#12393;&#12358;&#12363;&#12434;&#27770;&#12417;&#12427;&#12290;
</p><table border="0" summary="Simple list" class="simplelist"><tr><td>&#12418;&#12375;&#12418;&#12381;&#12358;&#12391;&#12394;&#12356;&#22580;&#21512;&#12289;&#23384;&#22312;&#12375;&#12390;&#12356;&#12427;&#12418;&#12398;&#12434;&#21462;&#12426;&#21435;&#12427;(&#12377;&#12394;&#12431;&#12385;&#12289;&#22266;&#26377;&#12487;&#12496;&#12483;&#12464;&#12463;&#12521;&#12473;&#29992;&#12398;&#22793;&#25968;&#12392;&#12377;&#12427;)&#12290;</td></tr><tr><td>&#12418;&#12375;&#12418;&#12381;&#12358;&#12391;&#12354;&#12428;&#12400;&#12289;&#12487;&#12540;&#12479;&#12377;&#12409;&#12390;&#12434;&#27083;&#36896;&#20307;&#12395;&#20837;&#12428;&#12427;&#12290;&#25509;&#32154;&#21336;&#20301;&#12505;&#12540;&#12473;&#19978;&#12391;&#12381;&#12398;&#12424;&#12358;&#12394;&#27083;&#36896;&#20307;&#12434;
    &#25351;&#23450;&#12377;&#12427;&#12383;&#12417;&#12395;handle-&gt;data&#12434;&#20351;&#12358;&#12371;&#12392;&#12364;&#20986;&#26469;&#12427;&#12290;</td></tr></table><p>

  &#12377;&#12394;&#12431;&#12385;&#12289;&#12418;&#12375;&#12418;&#20197;&#19979;&#12424;&#12358;&#12394;&#27083;&#36896;&#20307;&#12434;&#12418;&#12387;&#12390;&#12356;&#12427;&#12424;&#12358;&#12394;&#22580;&#21512;:
</p><pre class="programlisting">    
struct example_privates {
	char *some_string;
	int db_connection;
};
</pre><p>
&#12371;&#12428;&#12434;&#34892;&#12358;&#26368;&#21021;&#12398;&#26041;&#27861;&#12399;&#20197;&#19979;&#12398;&#36890;&#12426;:
</p><pre class="programlisting">
static int example_connect(vfs_handle_struct *handle,
	connection_struct *conn, const char *service, 
	const char* user)
{
	struct example_privates *data = NULL;

	/* alloc our private data */
	data = (struct example_privates *)talloc_zero(conn-&gt;mem_ctx, sizeof(struct example_privates));
	if (!data) {
		DEBUG(0,("talloc_zero() failed\n"));
		return -1;
	}

	/* init out private data */
	data-&gt;some_string = talloc_strdup(conn-&gt;mem_ctx,"test");
	if (!data-&gt;some_string) {
		DEBUG(0,("talloc_strdup() failed\n"));
		return -1;
	}

	data-&gt;db_connection = open_db_conn();

	/* and now store the private data pointer in handle-&gt;data
	 * we don't need to specify a free_function here because
	 * we use the connection TALLOC context.
	 * (return -1 if something failed.)
	 */
	VFS_HANDLE_SET_DATA(handle, data, NULL, struct example_privates, return -1);

	return SMB_VFS_NEXT_CONNECT(handle,conn,service,user);
}

static int example_close(vfs_handle_struct *handle, files_struct *fsp, int fd)
{
	struct example_privates *data = NULL;
	
	/* get the pointer to our private data
	 * return -1 if something failed
	 */
	SMB_VFS_HANDLE_GET_DATA(handle, data, struct example_privates, return -1);
	
	/* do something here...*/
	DEBUG(0,("some_string: %s\n",data-&gt;some_string));
	
	return SMB_VFS_NEXT_CLOSE(handle, fsp, fd);
}
</pre><p>
&#12371;&#12428;&#12434;&#34892;&#12358;&#27425;&#12398;&#26041;&#27861;&#12399;&#20197;&#19979;&#12398;&#36890;&#12426;:
</p><pre class="programlisting">
static void free_example_privates(void **datap)
{
	struct example_privates *data = (struct example_privates *)*datap;
	
	SAFE_FREE(data-&gt;some_string);
	SAFE_FREE(data);
	
	*datap = NULL;
	
	return;
}

static int example_connect(vfs_handle_struct *handle, 
	connection_struct *conn, const char *service, 
	const char* user)
{
	struct example_privates *data = NULL;

	/* alloc our private data */
	data = (struct example_privates *)malloc(sizeof(struct example_privates));
	if (!data) {
		DEBUG(0,("malloc() failed\n"));
		return -1;
	}

	/* init out private data */
	data-&gt;some_string = strdup("test");
	if (!data-&gt;some_string) {
		DEBUG(0,("strdup() failed\n"));
		return -1;
	}

	data-&gt;db_connection = open_db_conn();

	/* and now store the private data pointer in handle-&gt;data
	 * we need to specify a free_function because we used malloc() and strdup().
	 * (return -1 if something failed.)
	 */
	SMB_VFS_HANDLE_SET_DATA(handle, data, free_example_privates, struct example_privates, return -1);

	return SMB_VFS_NEXT_CONNECT(handle,conn,service,user);
}

static int example_close(vfs_handle_struct *handle, files_struct *fsp, int fd)
{
	struct example_privates *data = NULL;
	
	/* get the pointer to our private data
	 * return -1 if something failed
	 */
	SMB_VFS_HANDLE_GET_DATA(handle, data, struct example_privates, return -1);
	
	/* do something here...*/
	DEBUG(0,("some_string: %s\n",data-&gt;some_string));
	
	return SMB_VFS_NEXT_CLOSE(handle, fsp, fd);
}
</pre><p>
</p></li><li class="listitem"><p>
&#12469;&#12540;&#12489;&#12497;&#12540;&#12486;&#12451;&#12514;&#12472;&#12517;&#12540;&#12523;&#12434;&#27083;&#31689;&#12377;&#12427;&#12371;&#12392;&#12434;&#31777;&#21336;&#12395;&#12377;&#12427;&#12383;&#12417;&#12289;configure.in,(configure)&#12289;
install.sh&#12392;Makefile.in&#12434;&#12514;&#12472;&#12517;&#12540;&#12523;&#12392;&#19968;&#32210;&#12395;&#25552;&#20379;&#12377;&#12427;&#12371;&#12392;&#12399;&#26377;&#29992;&#12391;&#12354;&#12429;&#12358;&#12290;
(<code class="filename">examples/VFS</code>&#20013;&#12398;&#20363;&#12434;&#19968;&#35211;&#12375;&#12390;&#12415;&#12427;&#12371;&#12392;&#12290;)
</p><p>
configuration&#12473;&#12463;&#12522;&#12503;&#12488;&#12399;&#12289;Samba&#12477;&#12540;&#12473;&#12484;&#12522;&#12540;&#12408;&#12398;&#12497;&#12473;&#12434;&#25351;&#23450;&#12377;&#12427;&#12383;&#12417;&#12395;&#12289;
<code class="option">--with-samba-source</code>&#12434;&#21463;&#12369;&#20184;&#12369;&#12427;&#12290;&#12414;&#12383;&#12289;&#12467;&#12531;&#12497;&#12452;&#12521;&#12395;&#12383;&#12367;&#12373;&#12435;&#12398;
&#35686;&#21578;&#12434;&#20986;&#12373;&#12379;&#12427;&#12383;&#12417;&#12398;&#12289;<code class="option">--enable-developer</code>&#12418;&#21463;&#12369;&#20184;&#12369;&#12427;&#12290;
</p><p>
&#12354;&#12394;&#12383;&#12398;&#12514;&#12472;&#12517;&#12540;&#12523;&#29992;&#12395;&#12289;&#12371;&#12398;<code class="filename">configure.in</code>&#12392;
<code class="filename">Makefile.in</code>&#12473;&#12463;&#12522;&#12503;&#12488;&#12434;&#25313;&#24373;&#12391;&#12365;&#12427;&#12290;
</p></li><li class="listitem"><p>
&#12467;&#12531;&#12497;&#12452;&#12523;&#12392;&#12486;&#12473;&#12488;...
</p><table border="0" summary="Simple list" class="simplelist"><tr><td><strong class="userinput"><code>./configure <code class="option">--enable-developer</code></code></strong> ...</td></tr><tr><td><strong class="userinput"><code>make</code></strong></td></tr><tr><td>Try to fix all compiler warnings</td></tr><tr><td><strong class="userinput"><code>make</code></strong></td></tr><tr><td>Testing, Testing, Testing ...</td></tr></table><p>
</p></li></ol></div></div></div><div class="sect1" title="&#12356;&#12367;&#12388;&#12363;&#12398;&#27880;&#24847;&#20107;&#38917;"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2567763"></a>&#12356;&#12367;&#12388;&#12363;&#12398;&#27880;&#24847;&#20107;&#38917;</h2></div></div></div><div class="sect2" title="TRANSPARENT&#38306;&#25968;&#12398;&#23455;&#35013;"><div class="titlepage"><div><div><h3 class="title"><a name="id2567768"></a>TRANSPARENT&#38306;&#25968;&#12398;&#23455;&#35013;</h3></div></div></div><p>
&#20197;&#19979;&#12398;&#12424;&#12358;&#12394;&#38306;&#25968;&#12434;&#26360;&#12367;&#12371;&#12392;&#12399;&#12375;&#12394;&#12356;:

</p><pre class="programlisting">
static int example_close(vfs_handle_struct *handle, files_struct *fsp, int fd)
{
	return SMB_VFS_NEXT_CLOSE(handle, fsp, fd);
}
</pre><p>

&#30495;&#12395;&#24517;&#35201;&#12392;&#12377;&#12427;&#38306;&#25968;&#12398;&#12415;&#12434;&#12458;&#12540;&#12496;&#12540;&#12525;&#12540;&#12489;&#12377;&#12427;&#12371;&#12392;!
</p></div><div class="sect2" title="OPAQUE&#38306;&#25968;&#12398;&#23455;&#35013;"><div class="titlepage"><div><div><h3 class="title"><a name="id2567791"></a>OPAQUE&#38306;&#25968;&#12398;&#23455;&#35013;</h3></div></div></div><p>
&#12418;&#12375;&#12418;&#12289;&#26082;&#23450;&#20516;&#12398;Samba opaque&#38306;&#25968;&#12424;&#12426;&#12418;&#12424;&#12426;&#12424;&#12356;&#12496;&#12540;&#12472;&#12519;&#12531;&#12434;&#23455;&#35013;&#12375;&#12383;&#12356;&#12394;&#12425;&#12400;
(&#12383;&#12392;&#12360;&#12400;&#12289;&#29305;&#21029;&#12394;&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#12395;&#23550;&#12377;&#12427;disk_free()&#38306;&#25968;&#12398;&#12424;&#12358;&#12394;&#12418;&#12398;)&#12289;
&#12381;&#12398;&#29305;&#23450;&#12398;&#38306;&#25968;&#12434;&#12458;&#12540;&#12496;&#12525;&#12540;&#12489;&#12377;&#12427;&#12371;&#12392;&#12399;&#21839;&#38988;&#12394;&#12356;&#12290;
</p><p>
&#12418;&#12375;&#12418;&#12487;&#12540;&#12479;&#12505;&#12540;&#12473;&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#12354;&#12427;&#12356;&#12399;posix&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#12363;&#12425;&#30064;&#12394;&#12427;
&#20309;&#12363;&#12434;&#23455;&#35013;&#12375;&#12383;&#12356;&#22580;&#21512;&#12289;&#12377;&#12409;&#12390;&#12398;vfs&#25805;&#20316;&#12434;&#12458;&#12540;&#12496;&#12525;&#12540;&#12489;&#12377;&#12427;&#12424;&#12358;&#12395;&#12377;&#12427;&#12371;&#12392;!!!
</p><p>
&#20351;&#29992;&#12377;&#12427;&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#12364;&#12469;&#12509;&#12540;&#12488;&#12375;&#12394;&#12356;&#27231;&#33021;&#12399;&#12289;&#20197;&#19979;&#12398;&#12424;&#12358;&#12394;&#12418;&#12398;&#12391;&#12458;&#12540;&#12496;&#12525;&#12540;&#12489;&#12377;&#12409;&#12365;&#12391;&#12354;&#12427;:
&#12383;&#12392;&#12360;&#12400;&#12289;&#12522;&#12540;&#12489;&#12458;&#12531;&#12522;&#12501;&#12449;&#12452;&#12523;&#12471;&#12473;&#12486;&#12512;&#12394;&#12393;&#12290;
</p><pre class="programlisting">
static int example_rename(vfs_handle_struct *handle, connection_struct *conn,
			char *oldname, char *newname)
{
	DEBUG(10,("function rename() not allowed on vfs 'example'\n"));
	errno = ENOSYS;
	return -1;
}
</pre></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="rpc-plugin.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="pt03.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="parsing.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 9. RPC&#30528;&#33073;&#21487;&#33021;&#12394;&#12514;&#12472;&#12517;&#12540;&#12523; </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 11. smb.conf&#12501;&#12449;&#12452;&#12523;</td></tr></table></div></body></html>
