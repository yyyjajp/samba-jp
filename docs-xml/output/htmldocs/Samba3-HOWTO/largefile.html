<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Chapter 33. 大きなディレクトリの取扱い</title><link rel="stylesheet" href="../samba.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="公式のSamba 3.2.x HOWTOとリファレンスガイド"><link rel="up" href="optional.html" title="Part III. 詳細な設定方法"><link rel="prev" href="SambaHA.html" title="Chapter 32. 高可用性"><link rel="next" href="cfgsmarts.html" title="Chapter 34. 詳細設定のテクニック"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 33. 大きなディレクトリの取扱い</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="SambaHA.html">Prev</a> </td><th width="60%" align="center">Part III. 詳細な設定方法</th><td width="20%" align="right"> <a accesskey="n" href="cfgsmarts.html">Next</a></td></tr></table><hr></div><div class="chapter" title="Chapter 33. 大きなディレクトリの取扱い"><div class="titlepage"><div><div><h2 class="title"><a name="largefile"></a>Chapter 33. 大きなディレクトリの取扱い</h2></div><div><div class="author"><h3 class="author"><span class="firstname">Jeremy</span> <span class="surname">Allison</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jra@samba.org">jra@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">John</span> <span class="othername">H.</span> <span class="surname">Terpstra</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jht@samba.org">jht@samba.org</a>></code></p></div></div></div></div><div><p class="pubdate">March 5, 2005</p></div></div></div><p><a class="indexterm" name="id2696800"></a><a class="indexterm" name="id2696807"></a><a class="indexterm" name="id2696814"></a>1ディレクトリあたり10 万またはそれ以上のファイルを必要とするアプリケーションを、バージョン 3 系の Sambaで利用することには問題があり、それによって発生するパフォーマンス劣化を経験しているサイトがある。 Samba 3.0.12以降ではその解決策を実装している。</p><p><a class="indexterm" name="id2696835"></a><a class="indexterm" name="id2696842"></a>要求されている最新のリストだけを読むようにディレクトリの取扱いを修正したことが鍵だった。これとは違い、古い (Samba 3.0.11 までの) 振る舞いでは、事前にディレクトリをすべてメモリへ読み込んでから名前を小出しにしていた。通常では、これは とても奇妙な削除動作を持つ OS/2 アプリケーションを誤動作させるだろう。しかし、 Samba 4 (ありがとう Tridge) から流用したロジックにより、3.0.12 の最新のコードでは、これを正しく取り扱う。</p><p><a class="indexterm" name="id2696863"></a><a class="indexterm" name="id2696870"></a>ディレクトリあたりに多数のファイルを必要とするアプリケーションを、パフォーマンスへ著しい影響を与えないように、セットアップするために以下の手順を実施する。</p><p><a class="indexterm" name="id2696888"></a>最初に、ディレクトリ中のファイルをすべて大文字または小文字  好きな方(すでにすべてのファイルが大文字になっていたため大文字を私は選んだ) のどちらかのみに正規化する。 そして、このアプリケーションのために新しくおあつらえ向きの共有を以下のように作成する。</p><table border="0" summary="Simple list" class="simplelist"><tr><td> </td></tr><tr><td><em class="parameter"><code>[bigshare]</code></em></td></tr><tr><td><a class="indexterm" name="id2696925"></a><em class="parameter"><code>path = /data/manyfilesdir</code></em></td></tr><tr><td><a class="indexterm" name="id2696936"></a><em class="parameter"><code>read only = no</code></em></td></tr><tr><td><a class="indexterm" name="id2696948"></a><em class="parameter"><code>case sensitive = True</code></em></td></tr><tr><td><a class="indexterm" name="id2696960"></a><em class="parameter"><code>default case = upper</code></em></td></tr><tr><td><a class="indexterm" name="id2696972"></a><em class="parameter"><code>preserve case = no</code></em></td></tr><tr><td><a class="indexterm" name="id2696984"></a><em class="parameter"><code>short preserve case = no</code></em></td></tr></table><p></p><p><a class="indexterm" name="id2696999"></a><a class="indexterm" name="id2697006"></a><a class="indexterm" name="id2697013"></a>もちろん、あなた自身固有のパスと設定を使うこと。そして、ケースオプションはディレクトリのすべてのファイルに適合するように設定すること。パスは、アプリケーションが必要とする大きなディレクトリを指さなければならない。 そのディレクトリとそれ以下のすべてのディレクトリの下に作られる新しいファイルはすべて smbd によって大文字に強制される。しかし smbd はもはや名前のために走査する必要がなくなる。大文字で存在しなければまったく存在しないことがわかるため。</p><p><a class="indexterm" name="id2697046"></a><a class="indexterm" name="id2697052"></a><a class="indexterm" name="id2697060"></a>極意は実に <a class="link" href="smb.conf.5.html#CASESENSITIVE" target="_top">case sensitive = True</a> 行にある。これは、 smbd にその名前の大小文字が混在したバージョンを走査する必要が絶対にないことを告げる。だから、アプリケーションが <code class="filename">FOO</code> と呼ばれるファイルを要求した場合、 stat コールにて見つからなかったら、 smbd は直ちに file not found を返却する。違うケースのバージョンを走査することはない。その他の <code class="filename">xxx case xxx</code> 行は、 smbd によって作成されるファイルが一貫したケースに強制することでこれが機能するようにしている。</p><p><a class="indexterm" name="id2697114"></a><a class="indexterm" name="id2697120"></a><a class="indexterm" name="id2697127"></a><code class="filename">smb.conf</code> のこのセクションに付随して <em class="parameter"><code>path</code></em> 配下のすべてのファイルとディレクトリは大文字でなければならないことを忘れないこと。何故ならこの設定では、 <span class="application">smbd</span> は小文字のファイル名を見つけることができなくなるからである。このパラメータは、問題のある振る舞いの (多数のエントリをもつディレクトリを使用する) アプリケーションにへ提供する共有にのみ設定が許されているので、これらは共有ごとになされることに注意すること  残りの <span class="application">smbd</span> 共有は、影響を受ける必要はない。</p><p>以上の設定は、大きなディレクトリを処理する際にsmbd をずっと速くさせる。私のテストケースでは 10 万を超えるファイルで smbd は今やとても効率的に処理する。</p></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="SambaHA.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="optional.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="cfgsmarts.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 32. 高可用性 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 34. 詳細設定のテクニック</td></tr></table></div></body></html>