<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Chapter 24. Winbind: ドメインアカウントの使用</title><link rel="stylesheet" href="../samba.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="公式のSamba 3.2.x HOWTOとリファレンスガイド"><link rel="up" href="optional.html" title="Part III. 詳細な設定方法"><link rel="prev" href="VFS.html" title="Chapter 23. スタッカブルVFSモジュール"><link rel="next" href="AdvancedNetworkManagement.html" title="Chapter 25. 詳細なネットワーク管理"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 24. Winbind: ドメインアカウントの使用</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="VFS.html">Prev</a> </td><th width="60%" align="center">Part III. 詳細な設定方法</th><td width="20%" align="right"> <a accesskey="n" href="AdvancedNetworkManagement.html">Next</a></td></tr></table><hr></div><div class="chapter" title="Chapter 24. Winbind: ドメインアカウントの使用"><div class="titlepage"><div><div><h2 class="title"><a name="winbind"></a>Chapter 24. Winbind: ドメインアカウントの使用</h2></div><div><div class="author"><h3 class="author"><span class="firstname">Tim</span> <span class="surname">Potter</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:tpot@linuxcare.com.au">tpot@linuxcare.com.au</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Andrew</span> <span class="surname">Tridgell</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:tridge@samba.org">tridge@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Naag</span> <span class="surname">Mummaneni</span></h3><span class="contrib">Notes for Solaris</span> <div class="affiliation"><div class="address"><p><code class="email"><<a class="email" href="mailto:getnag@rediffmail.com">getnag@rediffmail.com</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">John</span> <span class="surname">Trostel</span></h3><div class="affiliation"><span class="orgname">SNAP<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jtrostel@snapserver.com">jtrostel@snapserver.com</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Jelmer</span> <span class="othername">R.</span> <span class="surname">Vernooij</span></h3><div class="affiliation"><span class="orgname">The Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jelmer@samba.org">jelmer@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">John</span> <span class="othername">H.</span> <span class="surname">Terpstra</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jht@samba.org">jht@samba.org</a>></code></p></div></div></div></div><div><p class="pubdate">June 15, 2005</p></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="winbind.html#id2673134">機能と利便性</a></span></dt><dt><span class="sect1"><a href="winbind.html#id2673507">はじめに</a></span></dt><dt><span class="sect1"><a href="winbind.html#id2673624">Winbindが提供するもの</a></span></dt><dd><dl><dt><span class="sect2"><a href="winbind.html#id2673811">対象となるユーザ</a></span></dt><dt><span class="sect2"><a href="winbind.html#id2673866">外部のSIDの取り扱い</a></span></dt></dl></dd><dt><span class="sect1"><a href="winbind.html#id2674023">Winbindの動き方</a></span></dt><dd><dl><dt><span class="sect2"><a href="winbind.html#id2674080">Microsoft Remote Procedure Calls</a></span></dt><dt><span class="sect2"><a href="winbind.html#id2674184">Microsoft Active Directoryサービス</a></span></dt><dt><span class="sect2"><a href="winbind.html#id2674239">Name Service Switch</a></span></dt><dt><span class="sect2"><a href="winbind.html#id2674521">Pluggable Authentication Modules</a></span></dt><dt><span class="sect2"><a href="winbind.html#id2674709">ユーザとグループIDの割り当て</a></span></dt><dt><span class="sect2"><a href="winbind.html#id2674811">結果のキャッシュ保存</a></span></dt></dl></dd><dt><span class="sect1"><a href="winbind.html#id2674887">インストールと設定</a></span></dt><dd><dl><dt><span class="sect2"><a href="winbind.html#id2674893">はじめに</a></span></dt><dt><span class="sect2"><a href="winbind.html#id2675024">用件</a></span></dt><dt><span class="sect2"><a href="winbind.html#id2675196">テスト</a></span></dt></dl></dd><dt><span class="sect1"><a href="winbind.html#id2677830">結論</a></span></dt><dt><span class="sect1"><a href="winbind.html#id2677884">よくあるエラー</a></span></dt><dd><dl><dt><span class="sect2"><a href="winbind.html#id2677945">NSCDの問題に関する警告</a></span></dt><dt><span class="sect2"><a href="winbind.html#id2677984">Winbindがユーザとグループを解決しない</a></span></dt></dl></dd></dl></div><div class="sect1" title="機能と利便性"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2673134"></a>機能と利便性</h2></div></div></div><p><a class="indexterm" name="id2673142"></a><a class="indexterm" name="id2673148"></a>	UNIXとMicrosoft Windows NTを統合化されたログオンで統合することは、長い間	異機種間コンピューティング環境において<span class="quote">“<span class="quote">聖杯</span>”</span>と考えられてきた。	</p><p><a class="indexterm" name="id2673168"></a><a class="indexterm" name="id2673175"></a><a class="indexterm" name="id2673182"></a><a class="indexterm" name="id2673190"></a>	もう一つ、この機能がなければ、UNIXとMicrosoft Windowsネットワークの相互運用性が	著しく限定されるというものがある。UNIXシステム全般に渡ってファイル共有を	可能にし、ドメインユーザとグループの所有者を整合性のある形で割り当てられる	機構がなければならない。	</p><p><a class="indexterm" name="id2673210"></a><a class="indexterm" name="id2673219"></a><a class="indexterm" name="id2673226"></a><a class="indexterm" name="id2673233"></a>	<span class="emphasis"><em>winbind</em></span>は、Sambaシステム中で、統一されたログオンの	問題を解決するコンポーネントである。Winbind は、Microsoft RPC コール、	Pluggable Authentication Modules (PAM)、Name Service SwitchのUNIXの実装を	使用して、Windows NTのドメインユーザがUNIXマシン上のUNIXユーザとして動作	できるようにする。この章は、Winbindシステムについて、その機能、設定の仕方、	及び内部的にどのように動いているのかを説明する。	</p><p>	Winbind は、三つの別々の機能を提供する。	</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><a class="indexterm" name="id2673272"></a><a class="indexterm" name="id2673279"></a>		ユーザの本人確認情報の認証(PAM経由)。これは、Windows NT4ドメインか		(Sambaドメインも含む)Active Directoryドメインからユーザとグループ		アカウントを使ってUNIX/Linuxシステムにログオンすることを可能にする。		</p></li><li class="listitem"><p><a class="indexterm" name="id2673300"></a><a class="indexterm" name="id2673307"></a>		IDの解決(NSS経由)。これは、winbindが使われなかった時の既定値である。		</p></li><li class="listitem"><p><a class="indexterm" name="id2673321"></a><a class="indexterm" name="id2673328"></a><a class="indexterm" name="id2673334"></a><a class="indexterm" name="id2673341"></a><a class="indexterm" name="id2673348"></a><a class="indexterm" name="id2673354"></a>		Winbindは、winbind_idmap.tdbと呼ばれるデータベースを維持し、その中に、		UNIX UID/GIDとNT SID間のマッピング情報を格納する。このマッピングは、		ローカルUID/GIDを持たないユーザまたはグループにのみ使用する。		idmap uid/gid の範囲から割り当てられ、NTのSIDにマッピングされた		UID/GIDが格納される。<em class="parameter"><code>idmap backend</code></em>が		<code class="constant">ldap:ldap://hostname[:389]</code>に指定されている場合、		ローカルのマッピングを使用する代わりに、Winbindは、この情報をLDAP		データベースから取得する。		</p></li></ul></div><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>	<a class="indexterm" name="id2673390"></a>	<a class="indexterm" name="id2673397"></a><a class="indexterm" name="id2673407"></a><a class="indexterm" name="id2673413"></a><a class="indexterm" name="id2673420"></a><a class="indexterm" name="id2673427"></a>	もしも<code class="literal">winbindd</code>が実行中ではないとき、smbd	(<code class="literal">winbindd</code>を呼び出す方)は、代替手段として純粋にローカルな	<code class="filename">/etc/passwd</code>と<code class="filename">/etc/group</code>からの情報を	使用することにし、動的マッピングは使用しない。OSでNSSが有効になっている場合、	ユーザとグループ情報の解決はNSS経由で行われる。	</p></div><div class="figure"><a name="winbind_idmap"></a><p class="title"><b>Figure 24.1. Winbind Idmap</b></p><div class="figure-contents"><div class="mediaobject"><img src="images/idmap_winbind_no_loop.png" width="243" alt="Winbind Idmap"></div></div></div><br class="figure-break"></div><div class="sect1" title="はじめに"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2673507"></a>はじめに</h2></div></div></div><p>UNIXとMicrosoft Windows NTでは、ユーザ及びグループ情報の見せ方のモデルも、	それを実行するために使用している技術も異なるのは周知の事実である。これが、	二つのシステムを統合して、満足の行く運用をすることを困難にしてきた。	</p><p><a class="indexterm" name="id2673529"></a><a class="indexterm" name="id2673536"></a>	これに対してよく行われる解決策は、UNIXとWindowsの両システム上に全く同名の	ユーザアカウントを作成し、Sambaを使用して、両システム間のファイルサービスと	印刷サービスを提供するというやり方であった。ただし、この解決策は、双方の	マシンにユーザを追加したり削除したりする作業が面倒でパスワードも2セット	持たなければならず、その両方がUNIXとWindowsシステム間の同期のずれの問題に	つながり、ユーザの混乱を招くという、完璧には程遠いものである。</p><p>UNIX マシンのための統一されたログオンという問題を、次のように三つの	構成要素に分けることができる:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Windows NTのユーザ及びグループ情報を取得する。		</p></li><li class="listitem"><p>Windows NT ユーザを認証する。		</p></li><li class="listitem"><p>Windows NT ユーザのためにパスワードを変更する。		</p></li></ul></div><p><a class="indexterm" name="id2673598"></a><a class="indexterm" name="id2673605"></a>	理想的には、統一されたログオンという問題の解決方法は、UNIXマシン上に情報を複製する	ことなく、上記の問題を全て満足させ、しかも、 ユーザやグループ情報をどちらの	システムで維持しても、システム管理者の仕事を増やさないというものであってほしい。	Winbind システムは、統一されたログオンという問題の三つの構成要素を簡単に優雅に	こなすソリューションを提供するものである。	problem.</p></div><div class="sect1" title="Winbindが提供するもの"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2673624"></a>Winbindが提供するもの</h2></div></div></div><p><a class="indexterm" name="id2673633"></a><a class="indexterm" name="id2673640"></a><a class="indexterm" name="id2673647"></a><a class="indexterm" name="id2673655"></a>	Winbindは、UNIXとWindows NTのアカウント管理を、UNIXマシンがNTドメインの完全な	メンバになることを可能にすることによって統一する。一旦これを行えば、UNIX	マシンは、NTユーザやグループをあたかも<span class="quote">“<span class="quote">ネイティブな</span>”</span>UNIXユーザや	グループであるかのように見ることができるようなり、UNIXのみの環境でNIS+を使用	するのとほぼ同様に、NTドメインを使用することができるようになる。</p><p><a class="indexterm" name="id2673685"></a><a class="indexterm" name="id2673692"></a><a class="indexterm" name="id2673700"></a><a class="indexterm" name="id2673706"></a>	その結果、UNIX マシン上のプログラムのいずれかが、OSにユーザ名やグループ名の検索を	依頼すると、指定されたドメインを担当する NT のドメインコントローラにその検索を	依頼することにより、問い合わせは解決する。Winbind は低レベル(Cライブラリ内の	NSS名前解決モジュール経由)でOSに繋がるので、NT ドメインコントローラへの上記の	リダイレクションは、完全に透過である。</p><p><a class="indexterm" name="id2673727"></a><a class="indexterm" name="id2673734"></a>	UNIXマシンのユーザは、<span class="quote">“<span class="quote">ネイティブの</span>”</span>UNIX名を使用するのと同様に、	NTユーザー名とグループ名を使用することができる。ユーザはファイルをchownして、	NTドメインユーザの所有に変えることもでき、UNIXマシンにログインしてドメイン	ユーザとしてUNIXのX Window Systemセッションを実行することもできる。</p><p><a class="indexterm" name="id2673759"></a>	Winbindが使用されていることが明らかにわかるところは、ユーザ及びグループの名前が	<code class="constant">DOMAIN\user</code>と<code class="constant">DOMAIN\group</code>の形を取ると	いう点だけである。これは、Winbind が、信頼関係のあるドメインに参照するの特定の	検索について、ドメインコントローラへのリダイレクト決めるために必要である。</p><p><a class="indexterm" name="id2673785"></a><a class="indexterm" name="id2673792"></a>	さらに、Winbind は、PAMシステムのhookとしての認証サービスを提供し、NTドメインを	経由して、PAM対応のあらゆるアプリケーションに対して認証を行う。この機能は、一カ所	(ドメインコントローラ上)に全てのパスワードが格納されるため、システム間の	パスワード同期の問題を解消する。</p><div class="sect2" title="対象となるユーザ"><div class="titlepage"><div><div><h3 class="title"><a name="id2673811"></a>対象となるユーザ</h3></div></div></div><p><a class="indexterm" name="id2673819"></a>		NTベースのドメイン基盤がすでにあり、それにUNIX ワークステーションか		サーバを組み入れたいという要望のある組織がWinbindの対象となる。Winbind		より、このような組織は別個のアカウント基盤を管理する必要なく、UNIX		ワークステーションを展開することができる。これは、NTベースの組織にUNIX		ワークステーションを展開するための間接費を大幅に軽減する。</p><p><a class="indexterm" name="id2673839"></a><a class="indexterm" name="id2673846"></a>		Winbind のもう一つの興味深い使用方法は、UNIXベースの装置の中心部分に		使用することである。Microsoftベースのネットワークにファイルサービスと		印刷サービスを提供する装置は、Winbindを使用することで、ドメインに		シームレスに統合される。</p></div><div class="sect2" title="外部のSIDの取り扱い"><div class="titlepage"><div><div><h3 class="title"><a name="id2673866"></a>外部のSIDの取り扱い</h3></div></div></div><p><a class="indexterm" name="id2673874"></a>	<span class="emphasis"><em>外部のSID(foreign SID)</em></span>という単語は、特定の環境に依存しない	反応としてしばしば見受けられる。以下はSambaメーリングリスト上で起きたやりとりを	書化したものである。これは、winbindの使用に関連してしばしば現れる混乱の良い例で	ある。	</p><p><a class="indexterm" name="id2673898"></a>	事実:Winbindはローカルドメインの一部でないワークステーションを使うユーザを	扱う必要がある。	</p><p><a class="indexterm" name="id2673913"></a>	対応:<span class="quote">“<span class="quote">なぜ?私はwinbindなしで長い間ドメインに所属していないワークステーション	をSambaとともに使っている。winbindは他のSamba/Windows PDCによって制御される	ドメイン中のメンバサーバとしてのSamba用ではないかと思う。</span>”</span>	</p><p><a class="indexterm" name="id2673931"></a><a class="indexterm" name="id2673937"></a><a class="indexterm" name="id2673944"></a>	もしも、SambaサーバがローカルSambaドメイン以外のドメインからアクセスされる	か、もしも、ローカルドメインメンバでないマシンからアクセスされる場合、winbindは	Sambaドメインのメンバであるユーザから分離された外部のユーザの識別情報を保持する	めの割り当てられた領域からUIDとGIDを割り当てる。	</p><p><a class="indexterm" name="id2673964"></a><a class="indexterm" name="id2673971"></a><a class="indexterm" name="id2673978"></a><a class="indexterm" name="id2673985"></a>	これは、winbindは、ドメインメンバとドメイン非メンバのワークステーションがある、	単一のSambaPDCがローカルネットワーク上にある場合に甚だしく有用である。もしも、	winbindが使われないと、ドメインのメンバでないWindowsワークステーション上の	georgeというユーザはPDCとして動作しているSambaサーバのアカウントデータベース	中のgeorgeと呼ばれるユーザのファイルにアクセスできる。winbindが使われると、	既定値の状態は、ローカルユーザのgeorgeがDOMAIN\georgeというアカウントとして	扱われ、外部(ドメインのメンバでない)アカウントは、おのおの別のSIDを持つために	MACHINE\georgeとして扱われる。	</p></div></div><div class="sect1" title="Winbindの動き方"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2674023"></a>Winbindの動き方</h2></div></div></div><p><a class="indexterm" name="id2674031"></a><a class="indexterm" name="id2674038"></a><a class="indexterm" name="id2674045"></a><a class="indexterm" name="id2674052"></a>	Winbindシステムは、クライアント/サーバアーキテクチャを想定し設計されたもので	ある。長時間走り続ける<code class="literal">winbindd</code>デーモンがUNIXドメイン	ソケット上でリクエストが来るのを待つ。これらのリクエストは、NSS及びPAM	クライアントにより生成され、順番に処理される。</p><p>Winbind を実装するのに使用されている技術を以下に詳述する。</p><div class="sect2" title="Microsoft Remote Procedure Calls"><div class="titlepage"><div><div><h3 class="title"><a name="id2674080"></a>Microsoft Remote Procedure Calls</h3></div></div></div><p><a class="indexterm" name="id2674088"></a><a class="indexterm" name="id2674098"></a><a class="indexterm" name="id2674104"></a><a class="indexterm" name="id2674111"></a><a class="indexterm" name="id2674118"></a>		過去数年間、Sambaチームの多くのメンバが、Microsoftリモートプロシージャ		コール(MSRPC)システムの各側面を解明しようと努力してきた。このシステムは、		リモート管理、ユーザ認証、印刷スプーリングを含むWindows NTマシン間の		ネットワーク関連操作の大半に使用されている。当初、Sambaへのプライマリ		ドメインコントローラ(PDC)機能の実装を支援するために 着手した作業で		あったが、結果としてそれ以外の目的に使用できる一連のコードを得ることが		できた。		</p><p><a class="indexterm" name="id2674150"></a><a class="indexterm" name="id2674157"></a><a class="indexterm" name="id2674164"></a>		winbind はドメインユーザとグループを列挙し、個々のユーザやグループの詳細		情報を取得するために、各種のMSRPC コールを使用する。他のMSRPC コールは、		NTドメインユーザを認証し、ユーザのパスワードを変更するために使用できる。		Windows PDCに、直接ユーザ及びグループ情報を問い合わせることで、Winbindは、		NTのアカウント情報をUNIXユーザ名とグループ名にマッピングする。		</p></div><div class="sect2" title="Microsoft Active Directoryサービス"><div class="titlepage"><div><div><h3 class="title"><a name="id2674184"></a>Microsoft Active Directoryサービス</h3></div></div></div><p><a class="indexterm" name="id2674193"></a><a class="indexterm" name="id2674200"></a><a class="indexterm" name="id2674206"></a><a class="indexterm" name="id2674213"></a>		2001年後半より、SambaはNT4のRPC サービスではなく、<span class="quote">“<span class="quote">ネイティブモード</span>”</span>		のプロトコルを使用して、Microsoft Windows 2000とやり取りする機能を持つ		ようになった。LDAP及びKerberosを使用し、winbindを走らせている ドメイン		メンバは、Windows 200xクライアントの世界で行われるのと全く同じように、		ユーザとグループを列挙でき、そうすることによってより効率的で効果的な		winbind の実装を提供する。		</p></div><div class="sect2" title="Name Service Switch"><div class="titlepage"><div><div><h3 class="title"><a name="id2674239"></a>Name Service Switch</h3></div></div></div><p><a class="indexterm" name="id2674247"></a><a class="indexterm" name="id2674253"></a><a class="indexterm" name="id2674261"></a><a class="indexterm" name="id2674268"></a>		Name Service SwitchまたはNSSは、多くのUNIX OSに存在する機能である。		これは、ホスト名、メールの別名、ユーザ情報などのシステム情報を、異なる		ソースから解決することを可能にする。例えば、スタンドアロンのUNIXワーク		ステーションは、ローカルのファイルシステムに格納されている一連のフラット		ファイルからシステム情報を解決できる。ネットワークに繋がったワーク		ステーションは、最初にローカルファイルからシステム情報を解決しようとし、		次にユーザ情報についてNISデータベースに問い合わせるか、あるいは、ホスト名		情報についてDNS サーバに聞くことができる。</p><p><a class="indexterm" name="id2674305"></a><a class="indexterm" name="id2674312"></a><a class="indexterm" name="id2674318"></a><a class="indexterm" name="id2674325"></a><a class="indexterm" name="id2674332"></a>		UNIXユーザ名とグループの解決の際、NSSのAPIは、winbind が自分をシステム		情報のソースとして見せることを可能にする。winbindは、このインタフェースと		MSRPCコールを使用して、Windows NTサーバから取得した情報を使用して、		アカウント列挙の新しいソースを提供する。標準のUNIXライブラリコールを		利用して、winbind を走らせているUNIXマシン上でユーザとグループを列挙させ、		NTドメインのみならず、信頼関係のあるいずれのドメインでもその全ユーザと		グループを、あたかも、ローカルユーザやグループのように見ることができる。		</p><p><a class="indexterm" name="id2674368"></a><a class="indexterm" name="id2674374"></a><a class="indexterm" name="id2674381"></a>		NSSの基本制御ファイルは<code class="filename">/etc/nsswitch.conf</code>である。		UNIXアプリケーションが検索を行うと、Cライブラリは要求されたサービス		タイプに一致する列を<code class="filename">/etc/nsswitch.conf</code>の中で探す。		例えば、ユーザ名またはグループ名の検索の場合、<span class="quote">“<span class="quote">passwd</span>”</span>の		サービスタイプが使用される。設定の中のこの列が、そのサービスのどの		実装が、どういう順番で試行されるべきか指定している。もし、passwdの		設定列が以下のようになっている場合:</p><pre class="screen">passwd: files example</pre><p><a class="indexterm" name="id2674419"></a><a class="indexterm" name="id2674426"></a><a class="indexterm" name="id2674433"></a>		Cライブラリは、最初に<code class="filename">/lib/libnss_files.so</code>と呼ばれる		モジュールをロードし、次に<code class="filename">/lib/libnss_example.so</code>		モジュールをロードする。Cライブラリはこれらのモジュールを順番に動的		ロードし、モジュール内の解決機能を呼んでリクエストを解決しようとする。		要求が解決されると、Cライブラリ は、その結果をアプリケーションに返す。		</p><p><a class="indexterm" name="id2674468"></a><a class="indexterm" name="id2674475"></a><a class="indexterm" name="id2674482"></a>		このNSSインタフェースは、OSへのフックのための、Winbindへの簡単なしくみを		提供する。必要な手続きは、<code class="filename">/lib/</code>の中に		<code class="filename">libnss_winbind.so</code>を書き、次に適切な場所で		 <code class="filename">/etc/nsswitch.conf</code>に<span class="quote">“<span class="quote">winbind</span>”</span>を追加		するだけである。これで、Cライブラリは、Winbindを呼んでユーザ名や		グループ名を解決できるようになる。		</p></div><div class="sect2" title="Pluggable Authentication Modules"><div class="titlepage"><div><div><h3 class="title"><a name="id2674521"></a>Pluggable Authentication Modules</h3></div></div></div><p><a class="indexterm" name="id2674529"></a><a class="indexterm" name="id2674536"></a><a class="indexterm" name="id2674543"></a><a class="indexterm" name="id2674549"></a>		PAMは、認証と認証技術を抽象化するものである。PAMモジュールを使用すると、		異なるシステムアプリケーション用にそれぞれ異なる認証方法を指定でき、		しかも、これらのアプリーケーションを再コンパイルする必要はない。		PAM はまた、特別なポリシーを認証に実装するためにも有用である。例えば、		システム管理者は、ローカルなパスワードファイルに格納されたユーザからは		コンソールログインのみを許可し、NISデータベースから解決されるユーザに		ついては、ネットワーク経由のログインを許可することができる。		</p><p><a class="indexterm" name="id2674584"></a><a class="indexterm" name="id2674591"></a><a class="indexterm" name="id2674598"></a><a class="indexterm" name="id2674605"></a><a class="indexterm" name="id2674612"></a>		Winbind は、認証管理とパスワード管理のPAMインタフェースを使用して、		Windows NTユーザをUNIXシステムに統合する。これにより、 Windows NT		ユーザはUNIXマシンにログインでき、適切なPDCの認証を受けることが		できるようになる。このようなユーザはパスワードの変更もできる上、		その変更内容をPDCに直に反映させることができる。		</p><p><a class="indexterm" name="id2674632"></a><a class="indexterm" name="id2674639"></a><a class="indexterm" name="id2674645"></a><a class="indexterm" name="id2674652"></a>		PAMは、認証を必要とするサービスごとに、<code class="filename">/etc/pam.d/</code>の		ディレクトリに管理ファイルを設けて設定する。アプリケーションが認証要求を		出すと、Cライブラリ内のPAMコードが、認証を行うために、どのモジュールを		どの順番でロードするべきかを決定するためにこの管理ファイルを検索する。		このインタフェースにより、Winbindに新しい認証サービスを追加することが		簡単になる。必要な手順は、<code class="filename">/lib/security/</code>に		<code class="filename">pam_winbind.so</code>モジュールをコピーすることと、		Winbind 経由の認証を可能にするために、関連するサービスのPAM管理ファイルを		更新することである。詳細は、		<a class="link" href="pam.html" title="Chapter 28. PAM ベースの分散型認証">PAMベースの分散型認証</a>のPAMの説明を参照のこと。		</p></div><div class="sect2" title="ユーザとグループIDの割り当て"><div class="titlepage"><div><div><h3 class="title"><a name="id2674709"></a>ユーザとグループIDの割り当て</h3></div></div></div><p><a class="indexterm" name="id2674717"></a><a class="indexterm" name="id2674724"></a><a class="indexterm" name="id2674730"></a>		Windows NT/200xでユーザまたはグループが作成されると、数字で構成される		相対ID(RID)を割り当てられる。これは、UNIXとは幾分異なる。UNIXでは、		ユーザIDに使用される数字の範囲と、グループIDに使用される数字の範囲が		別々になっている。RIDをUNIXのIDに変換する、またはその逆を行うのが		Winbindの仕事である。Winbindを設定する際、UNIXユーザIDのスペースの		一部とUNIX グループIDのスペースの一部を、Windows NTのユーザと		グループを格納する場所である。Windows NTユーザが最初に解決されるとき、		上記の範囲の中から次の空き番号をUNIX上のIDとして割り当てる。この		同じプロセスがWindows NTグループに対しても適用される。こうして一定の		時間が経つと、全てのWindows NTユーザとグループはWinbindにより、対応		するUNIXユーザIDとグループIDへマッピングされることになる。		</p><p><a class="indexterm" name="id2674772"></a><a class="indexterm" name="id2674780"></a><a class="indexterm" name="id2674786"></a><a class="indexterm" name="id2674793"></a>		このマッピングの結果は、tdbのデータベース内のIDマッピングデータベースに		一貫して格納されていく。これにより、RIDが一貫した方法でUNIXのIDに		マッピングされていくことを確保している。		</p></div><div class="sect2" title="結果のキャッシュ保存"><div class="titlepage"><div><div><h3 class="title"><a name="id2674811"></a>結果のキャッシュ保存</h3></div></div></div><p><a class="indexterm" name="id2674819"></a><a class="indexterm" name="id2674825"></a><a class="indexterm" name="id2674832"></a><a class="indexterm" name="id2674839"></a><a class="indexterm" name="id2674846"></a>		Active Directoryシステムは、数多くのユーザ名やグループ名の検索を発行		する。 これらの検索に係るネットワークの負担を軽減するため、Winbindは、		NTドメインコントローラから供給されるSAM シーケンス番号に基づいて、		キャッシュに保存する。PDCから返されたユーザ情報やグループ情報は、		同じくPDCから返されたシーケンス番号と一緒に、Winbindによってキャッシュに		保存される。ユーザ情報やグループ情報が変更される度に、Windows NTは		シーケンス番号を増やす。キャッシュに保存されたエントリが満了になる		ときに、シーケンス番号をPDC からリクエストし、キャッシュのエントリの		シーケンス番号と比較する。番号が一致しないときは、キャッシュに保存された		情報を捨て、PDCから直接更新情報をもらうように更新を行う。		</p></div></div><div class="sect1" title="インストールと設定"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2674887"></a>インストールと設定</h2></div></div></div><div class="sect2" title="はじめに"><div class="titlepage"><div><div><h3 class="title"><a name="id2674893"></a>はじめに</h3></div></div></div><p><a class="indexterm" name="id2674901"></a><a class="indexterm" name="id2674908"></a><a class="indexterm" name="id2674914"></a>この節では、Winbindを入手して使えるようにするまでの手順を説明する。WinbindはNTまたはWindows 200xの PDCを通して、Windowsのドメインユーザにtelnetやftpのような通常のサービスと、Sambaの各種サービスのためのアクセス制御と認証管理の機能を提供することができる。</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>	<span class="emphasis"><em>どうして、これをやるべきなのか?</em></span>	</p><p><a class="indexterm" name="id2674946"></a><a class="indexterm" name="id2674953"></a><a class="indexterm" name="id2674960"></a><a class="indexterm" name="id2674967"></a>これにより、Samba管理者がドメインメンバの認証のために、Windows NT/200x PDCの認証機構を頼れるようになる。Windows NT/200xユーザは、Sambaサーバ上に別のアカウントを持つ必要がなくなる。	</p></li><li class="listitem"><p>	<span class="emphasis"><em>この文書は誰が読むべきものか?</em></span>	</p><p><a class="indexterm" name="id2674996"></a><a class="indexterm" name="id2675003"></a>この文書はシステム管理者のためのものである。この文書は、Sambaをファイルサーバ上に実装する予定であり、既存のWindows NT/200xユーザを、PDCからSambaサーバへ(比較的簡単に)統合したい場合のものである。	</p></li></ul></div></div><div class="sect2" title="用件"><div class="titlepage"><div><div><h3 class="title"><a name="id2675024"></a>用件</h3></div></div></div><p><a class="indexterm" name="id2675031"></a><a class="indexterm" name="id2675038"></a><a class="indexterm" name="id2675045"></a>現在使用しているSamba設定ファイルがあるなら、<span class="emphasis"><em>バックアップを取ること!</em></span>。使用中のシステムが既にPAMを使用しているなら、<span class="emphasis"><em><code class="filename">/etc/pam.d</code>ディレクトリの内容をバックアップすること!</em></span>。起動ディスクをまだ作成していないのなら<span class="emphasis"><em>今すぐに作ること!</em></span>。</p><p><a class="indexterm" name="id2675078"></a><a class="indexterm" name="id2675085"></a><a class="indexterm" name="id2675092"></a>PAM設定ファイルを間違って修正すると、使用中のマシンにログインするのがほとんど不可能になってしまうことがある。このため、うまくいかない時にはマシンをシングルユーザモードで立ち上げ、<code class="filename">/etc/pam.d</code>を元の状態に戻せるようにすること。</p><p><a class="indexterm" name="id2675118"></a><a class="indexterm" name="id2675125"></a>Samba-3の最新バージョンには、正常に機能する winbindd daemonが含まれている。ソースコードをダウンロードする手順については、 <a class="ulink" href="http://samba.org/" target="_top">Samba Webページ</a>か最寄のSamba ミラーサイトにある説明を参照のこと。</p><p><a class="indexterm" name="id2675149"></a><a class="indexterm" name="id2675156"></a><a class="indexterm" name="id2675163"></a><a class="indexterm" name="id2675169"></a>ドメインユーザがSambaの共有やファイルにアクセスできるようにし、また使用するマシンが提供するその他のサービスにもアクセスできるようにするには、PAMを使用するマシン上で正しく設定しなければならない。Winbindモジュールをコンパイルするには、PAM開発ライブラリをインストールすべきである。<a class="ulink" href="http://www.kernel.org/pub/linux/libs/pam/" target="_top">PAMのウェブサイト</a>を参照のこと。</p></div><div class="sect2" title="テスト"><div class="titlepage"><div><div><h3 class="title"><a name="id2675196"></a>テスト</h3></div></div></div><p><a class="indexterm" name="id2675204"></a><a class="indexterm" name="id2675211"></a><a class="indexterm" name="id2675218"></a><a class="indexterm" name="id2675224"></a><a class="indexterm" name="id2675231"></a>開始する前に、使用しているサーバ上で走っている全てのSamba関連のデーモンを止めておくことを推奨する。動いているかもしれない<span class="application">smbd</span>、<span class="application">nmbd</span>、及び<span class="application">winbindd</span>の全プロセスを停止する。PAMを使用するには、PAMを認識するサービスが使用するPAMモジュール、複数のPAMライブラリ、及びPAMのための<code class="filename">/usr/doc</code>と<code class="filename">/usr/man</code>のエントリを含む、<code class="filename">/etc/pam.d</code>のディレクトリ構造を提供する、標準PAM パッケージを持っていることを確認する。WinbindをSamba内で構築する際、pam-devel パッケージをインストールしていると、よりうまくいく。このパッケージには、PAMを認識するアプリケーションをコンパイルするのに必要なヘッダファイルが含まれる。</p><div class="sect3" title="nsswitch.confとWinbindライブラリをLinuxとSolaris上で設定する"><div class="titlepage"><div><div><h4 class="title"><a name="id2675297"></a><code class="filename">nsswitch.conf</code>とWinbindライブラリをLinuxとSolaris上で設定する</h4></div></div></div><p><a class="indexterm" name="id2675311"></a><a class="indexterm" name="id2675317"></a><a class="indexterm" name="id2675324"></a><a class="indexterm" name="id2675331"></a>PAMは、最新世代のUNIX/Linuxシステムの標準コンポーネントである。しかし、残念ながらPAM対応のSambaを構築するのに必要な<code class="filename">pam-devel</code>ライブラリをインストールしているシステムは数が限られている。また、Samba-3はWinbindファイルを使用中のシステム上の正しい位置に自動インストールするかもしれない。そこでこれ以上先に進む前に、以下に説明する設定が本当に必要かどうか確認すること。もしかしたら、<code class="filename">/etc/nsswitch.conf</code>の設定だけで済むかもしれない。</p><p><span class="application">winbindd</span> daemonをnsswitch経由で走らせるために必要なライブラリを正しい場所にコピーしなければならない:</p><p><a class="indexterm" name="id2675385"></a></p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>cp ../samba/source/nsswitch/libnss_winbind.so /lib</code></strong></pre><p></p><p>また、以下のシンボリック・リンクを作成することが必要である:</p><p><code class="prompt">root# </code> <strong class="userinput"><code>ln -s /lib/libnss_winbind.so /lib/libnss_winbind.so.2</code></strong></p><p>さらに、Sun Solarisの場合は以下が必要である:<a class="indexterm" name="id2675435"></a></p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>ln -s /usr/lib/libnss_winbind.so /usr/lib/libnss_winbind.so.1</code></strong><code class="prompt">root# </code><strong class="userinput"><code>ln -s /usr/lib/libnss_winbind.so /usr/lib/nss_winbind.so.1</code></strong><code class="prompt">root# </code><strong class="userinput"><code>ln -s /usr/lib/libnss_winbind.so /usr/lib/nss_winbind.so.2</code></strong></pre><p></p><p><a class="indexterm" name="id2675485"></a>次に、rootになって、<span class="application">winbindd</span> daemonからユーザやグループのエントリが見えるように、<code class="filename">/etc/nsswitch.conf</code>を編集する。たとえば<code class="filename">/etc/nsswitch.conf</code>ファイルを以下のように編集する:</p><pre class="programlisting">passwd:     files winbindshadow:     filesgroup:      files winbind</pre><p><a class="indexterm" name="id2675524"></a><a class="indexterm" name="id2675531"></a><a class="indexterm" name="id2675538"></a><a class="indexterm" name="id2675545"></a><a class="indexterm" name="id2675552"></a><code class="literal">winbindd</code> daemonが必要とするライブラリは、次回システムが再起動するとき、自動的に<code class="literal">ldconfig</code>のキャッシュに入るが、手動で以下を行う方が早い(それに、再起動する必要もない):</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>/sbin/ldconfig -v | grep winbind</code></strong></pre><p>これにより、winbinddが<code class="filename">libnss_winbind</code>を使える状態になり、dynamic link loaderによって使われる現在の検索パスを返す。<code class="literal">ldconfig</code>コマンドの出力に<code class="literal">grep</code>フィルタを適用することで、このライブラリが本当にdynamic link loaderによって認識されるかの確証を確認できる。</p><p><a class="indexterm" name="id2675619"></a><a class="indexterm" name="id2675626"></a><a class="indexterm" name="id2675633"></a><a class="indexterm" name="id2675640"></a><a class="indexterm" name="id2675647"></a>Sun Solarisのダイナミックリンクローダ管理ツールは<code class="literal">crle</code>と呼ばれる。このツールは元々のOS環境の一部として提供されていないライブラリファイルを含むディレクトリを検索するよう指示するために必要である。以下の例は、ダイナミックリンクローダの検索パスに、どのようにして<code class="filename">/usr/local/lib</code>ディレクトリを追加するために使うかを示す:</p><pre class="screen"><code class="prompt">root# </code> crle -u -l /usr/lib:/usr/local/lib</pre><p>引数なしで実行した場合、<code class="literal">crle</code>は現在のダイナミックリンクローダの設定を表示する。それは以下の通り:</p><pre class="screen"><code class="prompt">root# </code> crleConfiguration file [version 4]: /var/ld/ld.config  Default Library Path (ELF):   /lib:/usr/lib:/usr/local/lib  Trusted Directories (ELF):    /lib/secure:/usr/lib/secure  (system default)Command line:  crle -c /var/ld/ld.config -l /lib:/usr/lib:/usr/local/lib</pre><p>これから、<code class="filename">/usr/local/lib</code>ディレクトリは、オブジェクトモジュールの依存関係を満足させるために、ダイナミックリンクライブラリの検索中に含まれていることがわかる。</p></div><div class="sect3" title="AIXにおけるNSS Winbind"><div class="titlepage"><div><div><h4 class="title"><a name="id2675729"></a>AIXにおけるNSS Winbind</h4></div></div></div><p>(この節はAIXを動作させている人にのみ関係する。)</p><p><a class="indexterm" name="id2675743"></a><a class="indexterm" name="id2675750"></a><a class="indexterm" name="id2675756"></a><a class="indexterm" name="id2675763"></a><a class="indexterm" name="id2675770"></a><a class="indexterm" name="id2675778"></a>Winbind AIX識別モジュールは、Sambaソースのnsswitchディレクトリ内に <code class="filename">libnss_winbind.so</code>として構築される。このファイルは、<code class="filename">/usr/lib/security</code>にコピーでき、AIXの名前変換から、WINBINDという名前にするべきであると指示してくる。次の節では、以下のようにして、</p><pre class="programlisting">WINBIND:        program = /usr/lib/security/WINBIND        options = authonly</pre><p><code class="filename">/usr/lib/security/methods.cfg</code>が追加できるようなる。このモジュールは識別のみサポートするが、標準のWinbind PAMモジュールを認証に使用して成功した例が報告されている。ローダブルな認証モジュール設定の際には、システムにログオンできない状態になってしまうこともあり得るので、慎重に行なうこと。AIX認証モジュールAPIに関する詳細情報は、AIXのための、<a class="ulink" href="http://publibn.boulder.ibm.com/doc_link/en_US/a_doc_lib/aixprggd/kernextc/sec_load_mod.htm" target="_top">Loadable Authentication Module Programming Interface</a>で記述されている、<span class="quote">“<span class="quote">Kernel Extensions and Device Support Programming Concepts for AIX</span>”</span>という文書にある。モジュールの管理に関するさらなる情報は、<a class="ulink" href="http://publibn.boulder.ibm.com/doc_link/en_US/a_doc_lib/aixbman/baseadmn/iandaadmin.htm" target="_top">SystemManagement Guide: Operating System and Devices</a>にある。</p></div><div class="sect3" title="smb.confの設定"><div class="titlepage"><div><div><h4 class="title"><a name="id2675858"></a>smb.confの設定</h4></div></div></div><p><a class="indexterm" name="id2675866"></a><a class="indexterm" name="id2675873"></a><a class="indexterm" name="id2675880"></a><span class="application">winbindd</span>の動作を制御するために、<code class="filename">smb.conf</code>ファイルにいくつかのパラメータを設定する必要がある。これについては、<a class="citerefentry" href="winbindd.8.html"><span class="citerefentry"><span class="refentrytitle">winbindd</span>(8)</span></a>マニュアルページに、より詳細に説明されている。以下の<a class="link" href="winbind.html#winbindcfg" title="Example 24.1. Winbind設定のためのsmb.conf">Winbind設定のためのsmb.conf</a>による<code class="filename">smb.conf</code>は、[global]セクションの中の必要なエントリーも含むように変更したものである。</p><div class="example"><a name="winbindcfg"></a><p class="title"><b>Example 24.1. Winbind設定のためのsmb.conf</b></p><div class="example-contents"><table border="0" summary="Simple list" class="simplelist"><tr><td> </td></tr><tr><td><em class="parameter"><code>[global]</code></em></td></tr><tr><td># DOMAIN\username のように、ドメインとユーザ名を '\'を挟んで分ける。</td></tr><tr><td><a class="indexterm" name="id2675958"></a><em class="parameter"><code>winbind separator = \</code></em></td></tr><tr><td># ドメインユーザには、10000から20000のUIDを使用する。</td></tr><tr><td><a class="indexterm" name="id2675976"></a><em class="parameter"><code>idmap uid = 10000-20000</code></em></td></tr><tr><td># ドメイングループには、10000から20000のGIDを使用する。</td></tr><tr><td><a class="indexterm" name="id2675994"></a><em class="parameter"><code>idmap gid = 10000-20000</code></em></td></tr><tr><td># winbindユーザとグループの列挙を可能にする。</td></tr><tr><td><a class="indexterm" name="id2676011"></a><em class="parameter"><code>winbind enum users = yes</code></em></td></tr><tr><td><a class="indexterm" name="id2676023"></a><em class="parameter"><code>winbind enum groups = yes</code></em></td></tr><tr><td># winbind ユーザに本当のシェルを与える(telnetアクセスを持つ場合のみ必要)</td></tr><tr><td><a class="indexterm" name="id2676041"></a><em class="parameter"><code>template homedir = /home/winnt/%D/%U</code></em></td></tr><tr><td><a class="indexterm" name="id2676053"></a><em class="parameter"><code>template shell = /bin/bash</code></em></td></tr></table></div></div><br class="example-break"></div><div class="sect3" title="SambaサーバをPDCドメインに参加させる"><div class="titlepage"><div><div><h4 class="title"><a name="id2676067"></a>SambaサーバをPDCドメインに参加させる</h4></div></div></div><p><a class="indexterm" name="id2676077"></a><a class="indexterm" name="id2676084"></a><a class="indexterm" name="id2676090"></a>ドメインセキュリティに関与するすべてのマシンはドメインのメンバであるべきである。これはPDCとすべてのBDCにも適用される。</p><p><a class="indexterm" name="id2676106"></a><a class="indexterm" name="id2676113"></a><a class="indexterm" name="id2676120"></a><a class="indexterm" name="id2676131"></a><a class="indexterm" name="id2676138"></a><a class="indexterm" name="id2676144"></a><a class="indexterm" name="id2676152"></a><a class="indexterm" name="id2676158"></a><a class="indexterm" name="id2676165"></a>ドメインへの参加手続きは、<code class="literal">net rpc join</code>コマンドを使って行う。この手続きは、MS DCE RPC経由で登録された(通常はPDC)ドメインコントローラと通信を行う。これは、もちろん、<code class="literal">smbd</code>プロセスが対象のドメインコントローラ上で動作していなければならないということである。それ自身のドメインに参加できるように、一時的にPDCとしてSambaを起動することは、そのために必要である。</p><p><a class="indexterm" name="id2676196"></a><a class="indexterm" name="id2676202"></a><a class="indexterm" name="id2676209"></a><em class="replaceable"><code>PDC</code></em>という名前のPDCで、ドメイン中で管理者権限を持つドメインユーザが<em class="replaceable"><code>Administrator</code></em>である時、以下のコマンドを入力し、Sambaサーバをドメインに参加させる。</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><a class="indexterm" name="id2676231"></a><a class="indexterm" name="id2676238"></a><a class="indexterm" name="id2676245"></a><a class="indexterm" name="id2676252"></a>ドメインにマシンを参加させる前に、対象のドメインコントローラ(通常はPDC)でSambaが動作しているかを確認し、ポート137/udp, 135/tcp, 139/tcp, と 445/tcpが開いているかを確認する(もしもPDCがSambaかWindows Server 2Kxの場合)。</p></div><p><a class="indexterm" name="id2676272"></a><code class="literal">net rpc join</code>機能の使用方法は以下の通り:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>/usr/local/samba/bin/net rpc join -S PDC -U Administrator</code></strong></pre><p>このコマンドへの正しい解答は、<span class="quote">“<span class="quote">Joined the domain<em class="replaceable"><code>DOMAIN</code></em></span>”</span>である。ここで、<em class="replaceable"><code>DOMAIN</code></em>は対象のドメイン名である。</p></div><div class="sect3" title="winbindddaemonの開始とテスト"><div class="titlepage"><div><div><h4 class="title"><a name="id2676322"></a><code class="literal">winbindd</code>daemonの開始とテスト</h4></div></div></div><p><a class="indexterm" name="id2676335"></a><a class="indexterm" name="id2676342"></a><a class="indexterm" name="id2676349"></a>最終的には、Sambaのその他の部分が立ち上がるときに、自動的にwinbindd daemonを呼び出すように、Sambaの起動スクリプトを変更したいと思うかもしれないが、Winbind部分だけを最初にテストしておくことは可能である。Winbind のサービスを立ち上げるには、以下のコマンドをrootとして入力する:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>/usr/local/samba/sbin/winbindd</code></strong></pre><p><code class="literal">winbindd</code>実行ファイルの位置への適切なパスを使用すること。</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><a class="indexterm" name="id2676394"></a><a class="indexterm" name="id2676401"></a>上記は、<code class="filename">/usr/local/samba</code>のディレクトリツリーの中にSamba をインストールしたと仮定している。使用するシステム上で<code class="literal">winbindd</code>が別の所にある場合は、Sambaファイルの位置を探す必要がある。</p></div><p><a class="indexterm" name="id2676427"></a><a class="indexterm" name="id2676434"></a>心配性な人の場合、daemonが本当に動いているかは以下で確認出来る。</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>ps -ae | grep winbindd</code></strong></pre><p></p><p><a class="indexterm" name="id2676463"></a>このコマンドは、daemonが動いているなら、以下のような結果を返してくるはずである。</p><pre class="screen">3025 ?        00:00:00 winbindd</pre><p></p><p><a class="indexterm" name="id2676484"></a><a class="indexterm" name="id2676490"></a>次に、本当のテスト用に、PDC上にあるユーザ情報を取得する:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>/usr/local/samba/bin/wbinfo -u</code></strong></pre><p>これは、PDC上のWindowsユーザ情報に入っているユーザの一覧をエコーバックするはずである。例えば、以下のような結果が表示される:</p><pre class="screen">CEO\AdministratorCEO\burdellCEO\GuestCEO\jt-adCEO\krbtgtCEO\TsInternetUser</pre><p>もちろん、ドメイン名は<span class="quote">“<span class="quote">CEO</span>”</span>で、<a class="link" href="smb.conf.5.html#WINBINDSEPARATOR" target="_top">winbind separator</a>は<span class="quote">“<span class="quote">\</span>”</span>である。</p><p><a class="indexterm" name="id2676555"></a><a class="indexterm" name="id2676562"></a>同様にPDCからグループ情報を取得することができる:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>/usr/local/samba/bin/wbinfo -g</code></strong>CEO\Domain AdminsCEO\Domain UsersCEO\Domain GuestsCEO\Domain ComputersCEO\Domain ControllersCEO\Cert PublishersCEO\Schema AdminsCEO\Enterprise AdminsCEO\Group Policy Creator Owners</pre><p><a class="indexterm" name="id2676593"></a><a class="indexterm" name="id2676600"></a><a class="indexterm" name="id2676606"></a><a class="indexterm" name="id2676613"></a><a class="indexterm" name="id2676619"></a><a class="indexterm" name="id2676626"></a><a class="indexterm" name="id2676633"></a>ここで、<code class="literal">getent</code>コマンドを使用して、ローカルとPDCの両方からユーザとグループの統合された一覧を表示させることができる。以下のコマンドを入力する:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>getent passwd</code></strong></pre><p><code class="filename">/etc/passwd</code>のような、ドメインユーザの新しいUID、GID、ホームディレクトリ及び既定値のシェルが表示される一覧が出てくるはずである。</p><p>グループについても同様に以下のコマンドを実行できる:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>getent group</code></strong></pre><p></p></div><div class="sect3" title="init.d起動スクリプトの修正"><div class="titlepage"><div><div><h4 class="title"><a name="id2676699"></a>init.d起動スクリプトの修正</h4></div></div></div><div class="sect4" title="Linux"><div class="titlepage"><div><div><h5 class="title"><a name="id2676706"></a>Linux</h5></div></div></div><p><a class="indexterm" name="id2676713"></a><a class="indexterm" name="id2676720"></a><a class="indexterm" name="id2676727"></a><a class="indexterm" name="id2676734"></a><a class="indexterm" name="id2676741"></a><a class="indexterm" name="id2676748"></a><span class="application">winbindd</span> daemonは<span class="application">smbd</span>と<span class="application">nmbd</span> daemonが動き出してから起動する必要がある。これを行うには起動スクリプトを書き換える。それは、Red Hat Linuxでは<code class="filename">/etc/init.d/samba</code>にあり、Debian Linuxでは<code class="filename">/etc/init.d/samba</code>にある。これらのdaemonを正しい順序で走らせるためのコマンドをスクリプトに加える。たとえば、起動スクリプトの例としては、<span class="application">smbd</span>, <span class="application">nmbd</span>, と <span class="application">winbindd</span>を直接<code class="filename">/usr/local/samba/bin</code>ディレクトリから起動する。このスクリプト中の<code class="literal">start</code>関数は以下の通り:</p><pre class="programlisting">start() {        KIND="SMB"        echo -n $"Starting $KIND services: "        daemon /usr/local/samba/bin/smbd $SMBDOPTIONS        RETVAL=$?        echo        KIND="NMB"        echo -n $"Starting $KIND services: "        daemon /usr/local/samba/bin/nmbd $NMBDOPTIONS        RETVAL2=$?        echo        KIND="Winbind"        echo -n $"Starting $KIND services: "        daemon /usr/local/samba/sbin/winbindd        RETVAL3=$?        echo        [ $RETVAL -eq 0 -a $RETVAL2 -eq 0 -a $RETVAL3 -eq 0 ] && \		touch /var/lock/subsys/smb || RETVAL=1        return $RETVAL}</pre><p>winbindd をデュアル・デーモン・モードで走らせたい場合は、上記例の中の:</p><pre class="programlisting">        daemon /usr/local/samba/sbin/winbindd</pre><p>の列を、以下に変える:</p><pre class="programlisting">        daemon /usr/local/samba/sbin/winbindd -D</pre><p>.</p><p><code class="literal">stop</code>関数は、サービスを停止するために以下のように起動に対応するエントリを持つ:</p><pre class="programlisting">stop() {        KIND="SMB"        echo -n $"Shutting down $KIND services: "        killproc smbd        RETVAL=$?        echo        KIND="NMB"        echo -n $"Shutting down $KIND services: "        killproc nmbd        RETVAL2=$?        echo        KIND="Winbind"        echo -n $"Shutting down $KIND services: "        killproc winbindd        RETVAL3=$?        [ $RETVAL -eq 0 -a $RETVAL2 -eq 0 -a $RETVAL3 -eq 0 ] && \		 rm -f /var/lock/subsys/smb        echo ""        return $RETVAL}</pre></div><div class="sect4" title="Solaris"><div class="titlepage"><div><div><h5 class="title"><a name="id2676902"></a>Solaris</h5></div></div></div><p>WinbindはSolaris 9では動作しない。 see <a class="link" href="Portability.html#winbind-solaris9" title="Solaris9上の Winbind">Solaris 9でのWinbind</a>の節を参照のこと。for details.</p><p><a class="indexterm" name="id2676925"></a><a class="indexterm" name="id2676931"></a><a class="indexterm" name="id2676938"></a><a class="indexterm" name="id2676946"></a><a class="indexterm" name="id2676952"></a><a class="indexterm" name="id2676959"></a>Solarisでは、<code class="filename">/etc/init.d/samba.server</code>起動スクリプトを変更する必要がある。また、通常は smbd と nmbdのみを起動するが、winbinddも起動すべきである。Sambaが<code class="filename">/usr/local/samba/bin</code>にインストールされている場合、このファイルには以下のようなものを含むことが出来る:</p><p>	</p><pre class="programlisting">	##	## samba.server	##	if [ ! -d /usr/bin ]	then                    # /usr がマウントされていない		exit	fi	killproc() {            # 名前指定でプロセスを停止		pid=`/usr/bin/ps -e |		     /usr/bin/grep -w $1 |		     /usr/bin/sed -e 's/^  *//' -e 's/ .*//'`		[ "$pid" != "" ] && kill $pid	}	# Sambaサーバに必要な起動/停止プロセス	case "$1" in	'start')	#	# 使用環境(パス、ワークグループ、ホスト)に合わせて以下を編集すること	#	echo Starting SMBD	   /usr/local/samba/bin/smbd -D -s \		/usr/local/samba/smb.conf	echo Starting NMBD	   /usr/local/samba/bin/nmbd -D -l \		/usr/local/samba/var/log -s /usr/local/samba/smb.conf	echo Starting Winbind Daemon	   /usr/local/samba/sbin/winbindd	   ;;	'stop')	   killproc nmbd	   killproc smbd	   killproc winbindd	   ;;	*)	   echo "Usage: /etc/init.d/samba.server { start | stop }"	   ;;	esac</pre><p>繰り返すが、Winbindをデュアルdaemonモードで動かしたい場合、上記の:</p><pre class="programlisting">/usr/local/samba/sbin/winbindd</pre><p>の部分を、下記に変える:</p><pre class="programlisting">/usr/local/samba/sbin/winbindd -D</pre><p></p></div><div class="sect4" title="再起動"><div class="titlepage"><div><div><h5 class="title"><a name="id2677044"></a>再起動</h5></div></div></div><p><a class="indexterm" name="id2677052"></a><a class="indexterm" name="id2677059"></a>この時点で<span class="application">smbd</span>, <span class="application">nmbd</span>, と <span class="application">winbindd</span> daemonを再起動すると、まるでローカルユーザであるかのように、Sambaサーバにドメインメンバとして接続できるはずである。</p></div></div><div class="sect3" title="WinbindとPAMの設定"><div class="titlepage"><div><div><h4 class="title"><a name="id2677093"></a>WinbindとPAMの設定</h4></div></div></div><p><a class="indexterm" name="id2677101"></a><a class="indexterm" name="id2677108"></a><a class="indexterm" name="id2677115"></a><a class="indexterm" name="id2677122"></a>ここまで来たということは、<code class="literal">winbindd</code>とSambaが一緒に動作している状態になったと言うことである。Winbindを使用して、他のサービスに認証を提供できるようにしたい場合は、この先を読み進めること。PAMの設定ファイルを、この手順の中で変更する必要が出てくる(現在使っている<code class="filename">/etc/pam.d</code>ファイルのバックアップを取っていないならば、今行うこと)。</p><p><a class="indexterm" name="id2677157"></a><a class="indexterm" name="id2677164"></a><a class="indexterm" name="id2677171"></a><a class="indexterm" name="id2677178"></a><a class="indexterm" name="id2677185"></a><a class="indexterm" name="id2677191"></a>他のサービスでwinbinddを使用するためのPAM モジュールが必要になる。このモジュールは、以下のコマンドで、<code class="filename">../source</code>ディレクトリから<code class="filename">../source/nsswitch</code>ディレクトリにコンパイルされる:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>make nsswitch/pam_winbind.so</code></strong></pre><p><code class="filename">pam_winbind.so</code>ファイルは、他のPAMセキュリティモジュールのある場所にコピーしなければならない。Red Hat システムでは、<code class="filename">/lib/security</code>というディレクトリである。Solaris では、PAMセキュリティモジュールは、<code class="filename">/usr/lib/security</code>に入る。</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>cp ../samba/source/nsswitch/pam_winbind.so /lib/security</code></strong></pre><p></p><div class="sect4" title="Linux/FreeBSD固有のPAM設定"><div class="titlepage"><div><div><h5 class="title"><a name="id2677275"></a>Linux/FreeBSD固有のPAM設定</h5></div></div></div><p><a class="indexterm" name="id2677283"></a><code class="filename">/etc/pam.d/samba</code>ファイルは変更する必要がない。このファイルはそのまま残す:</p><pre class="programlisting">auth    required  /lib/security/pam_stack.so service=system-authaccount required  /lib/security/pam_stack.so service=system-auth</pre><p><a class="indexterm" name="id2677308"></a><a class="indexterm" name="id2677315"></a><a class="indexterm" name="id2677322"></a><a class="indexterm" name="id2677328"></a><a class="indexterm" name="id2677335"></a><a class="indexterm" name="id2677343"></a><a class="indexterm" name="id2677350"></a><a class="indexterm" name="id2677357"></a><a class="indexterm" name="id2677364"></a>Winbindを認証サービスに使用できるように手を加えたその他のサービスは、コンソール上の通常ログイン(またはターミナルセッション)、telnetログイン、それにftpサービスである。これらのサービスを有効にするには、まず、<code class="filename">/etc/xinetd.d</code>(または<code class="filename">/etc/inetd.conf</code>)の中のエントリを変更する必要があるかも知れない。Red Hat Linux 7.1以降のバージョンは、新しい xinetd.d 構造を使用しており、この場合、<code class="filename">/etc/xinetd.d/telnet</code>と<code class="filename">/etc/xinetd.d/wu-ftp</code>の中の文字列を</p><pre class="programlisting">	enable = no</pre><p>から</p><pre class="programlisting">	enable = yes</pre><p>に変更する必要がある。</p><p><a class="indexterm" name="id2677430"></a><a class="indexterm" name="id2677437"></a><a class="indexterm" name="id2677445"></a>ftpサービスを動作させるためには、既にサーバ上に存在するドメインユーザのために、個別にディレクトリを用意するか、ホームディレクトリを全ドメインユーザ用の汎用ディレクトリに変更する必要がある。これらは、<code class="filename">smb.conf</code>の<a class="link" href="smb.conf.5.html#TEMPLATEHOMEDIR" target="_top">template homedir</a>グローバルエントリで簡単に設定できる。</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><a class="indexterm" name="id2677488"></a><a class="link" href="smb.conf.5.html#TEMPLATEHOMEDIR" target="_top">template homedir</a>中のディレクトリは、自動的には生成されない!pam_mkhomedirか、あらかじめ当該ユーザに対してディレクトリを作成しておくようにして、固有のホームディレクトリを使ってUNIXにログインできるようにすること。</p></div><p><a class="indexterm" name="id2677514"></a><a class="indexterm" name="id2677521"></a><a class="indexterm" name="id2677528"></a><code class="filename">/etc/pam.d/ftp</code>ファイルは、<code class="filename">/etc/pam.d/samba</code>ファイルと似たような形で、Winbindのftpアクセスを許可するように変更できる。変更後の<code class="filename">/etc/pam.d/ftp</code>ファイルは以下の通り:</p><pre class="programlisting">auth       required     /lib/security/pam_listfile.so item=user sense=deny \	 file=/etc/ftpusers onerr=succeedauth       sufficient   /lib/security/pam_winbind.soauth       required     /lib/security/pam_stack.so service=system-authauth       required     /lib/security/pam_shells.soaccount    sufficient   /lib/security/pam_winbind.soaccount    required     /lib/security/pam_stack.so service=system-authsession    required     /lib/security/pam_stack.so service=system-auth</pre><p><a class="indexterm" name="id2677573"></a><code class="filename">/etc/pam.d/login</code>ファイルもほぼ同様に変更できる。以下のようになる:</p><pre class="programlisting">auth       required     /lib/security/pam_securetty.soauth       sufficient   /lib/security/pam_winbind.soauth       sufficient   /lib/security/pam_unix.so use_first_passauth       required     /lib/security/pam_stack.so service=system-authauth       required     /lib/security/pam_nologin.soaccount    sufficient   /lib/security/pam_winbind.soaccount    required     /lib/security/pam_stack.so service=system-authpassword   required     /lib/security/pam_stack.so service=system-authsession    required     /lib/security/pam_stack.so service=system-authsession    optional     /lib/security/pam_console.so</pre><p><a class="indexterm" name="id2677603"></a><a class="indexterm" name="id2677610"></a><a class="indexterm" name="id2677617"></a>この場合、前述のように</p><pre class="programlisting">auth sufficient /lib/security/pam_winbind.so</pre><p>を追加するが、それに加え</p><pre class="programlisting">required pam_securetty.so</pre><p>を加えることにより、ネットワーク上からのrootのログインを不許可とした。また、</p><pre class="programlisting">sufficient /lib/security/pam_unix.so use_first_pass</pre><p>行を<code class="literal">winbind.so</code>行の後に加え、パスワードからのプロンプトが二重表示される問題を解消した。</p></div><div class="sect4" title="Solaris固有の設定"><div class="titlepage"><div><div><h5 class="title"><a name="id2677660"></a>Solaris固有の設定</h5></div></div></div><p><a class="indexterm" name="id2677668"></a><a class="indexterm" name="id2677675"></a><code class="filename">/etc/pam.conf</code>の変更が必要である。ドメインユーザがローカルにもtelnetでもログオンできるように変更する。以下が変更内容である。<code class="filename">pam.conf</code>を要件に沿ってカスタマイズしてもよいが、最悪の場合、システムがほとんど起動不能になることがあるので、変更内容に十分自信がある場合のみ変更すること。</p><pre class="programlisting">##ident "@(#)pam.conf 1.14 99/09/16 SMI"## Copyright (c) 1996-1999, Sun Microsystems, Inc.# All Rights Reserved.## PAMの設定## 認証管理#login   auth required   /usr/lib/security/pam_winbind.sologin auth required  /usr/lib/security/$ISA/pam_unix.so.1 try_first_passlogin auth required  /usr/lib/security/$ISA/pam_dial_auth.so.1 try_first_pass#rlogin  auth sufficient /usr/lib/security/pam_winbind.sorlogin  auth sufficient /usr/lib/security/$ISA/pam_rhosts_auth.so.1rlogin auth required  /usr/lib/security/$ISA/pam_unix.so.1 try_first_pass#dtlogin auth sufficient /usr/lib/security/pam_winbind.sodtlogin auth required  /usr/lib/security/$ISA/pam_unix.so.1 try_first_pass#rsh auth required /usr/lib/security/$ISA/pam_rhosts_auth.so.1other   auth sufficient /usr/lib/security/pam_winbind.soother auth required /usr/lib/security/$ISA/pam_unix.so.1 try_first_pass## アカウント管理#login   account sufficient      /usr/lib/security/pam_winbind.sologin account requisite /usr/lib/security/$ISA/pam_roles.so.1login account required /usr/lib/security/$ISA/pam_unix.so.1#dtlogin account sufficient      /usr/lib/security/pam_winbind.sodtlogin account requisite /usr/lib/security/$ISA/pam_roles.so.1dtlogin account required /usr/lib/security/$ISA/pam_unix.so.1#other   account sufficient      /usr/lib/security/pam_winbind.soother account requisite /usr/lib/security/$ISA/pam_roles.so.1other account required /usr/lib/security/$ISA/pam_unix.so.1## セッション管理#other session required /usr/lib/security/$ISA/pam_unix.so.1## パスワード管理##other   password sufficient     /usr/lib/security/pam_winbind.soother password required /usr/lib/security/$ISA/pam_unix.so.1dtsession auth required /usr/lib/security/$ISA/pam_unix.so.1## Kerberos V5 認証のサポート(Kerberosを使用するにはアンコメントすること)##rlogin auth optional /usr/lib/security/$ISA/pam_krb5.so.1 try_first_pass#login auth optional /usr/lib/security/$ISA/pam_krb5.so.1 try_first_pass#dtlogin auth optional /usr/lib/security/$ISA/pam_krb5.so.1 try_first_pass#other auth optional /usr/lib/security/$ISA/pam_krb5.so.1 try_first_pass#dtlogin account optional /usr/lib/security/$ISA/pam_krb5.so.1#other account optional /usr/lib/security/$ISA/pam_krb5.so.1#other session optional /usr/lib/security/$ISA/pam_krb5.so.1#other password optional /usr/lib/security/$ISA/pam_krb5.so.1 try_first_pass</pre><p><a class="indexterm" name="id2677795"></a>さらに、<code class="filename">winbind.so</code>行の後に<em class="parameter"><code>try_first_pass</code></em>行を追加することで、パスワードからのプロンプトが二重表示される問題を解消する。</p><p>Sambaを再起動して、pam.confで設定したアプリケーションから接続してみる。</p></div></div></div></div><div class="sect1" title="結論"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2677830"></a>結論</h2></div></div></div><p><a class="indexterm" name="id2677838"></a><a class="indexterm" name="id2677845"></a><a class="indexterm" name="id2677851"></a><a class="indexterm" name="id2677858"></a><a class="indexterm" name="id2677865"></a>Winbindシステムは、NSSとPAM及び適切なMicrosoft RPCコールを使用することで、UNIXシステム上のMicrosoft Windows NTドメインユーザのシームレスな統合を可能にした。その結果、UNIXとNTの混在するネットワークを運用する管理コストの大幅削減が実現さた。</p></div><div class="sect1" title="よくあるエラー"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2677884"></a>よくあるエラー</h2></div></div></div><p>	Winbindは、現在のリリース版には、幾つかの制約があり、これは将来の リリースで克服していきたいと考えている:	</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>		Winbindは、現行では、他のOSへの移植は可能だが、Linux、Solaris、AIX、		及びIRIXのOSでのみ使用可能である。このような移植を実現するには、移植先の		OSのCライブラリが、NSSとPAMシステムをサポートしていることが要件となる。		NSSとPAMがUNIXベンダの間でサポートを得るようになってきたので、この二つの		サポートは以前より一般的に見られるようになった。		</p></li><li class="listitem"><p>		Windows NT RIDからUNIX IDへのマッピングは、 アルゴリズムで決められる		のではなく、マッピングされていないユーザとグループをWinbindが目にした		順番に番号を振っていく。そのため、RIDとUNIX IDのマッピング情報を持つ		ファイルが不良になったり壊れたりした場合、前と同じマッピングを再現		することは難しいかもしれない。		</p></li><li class="listitem"><p>		現行では、Winbind PAMのモジュールは、Windows NTユーザに対して設定される		ワークステーションのログオン時間などの制約を考慮しておらず、PDC が強制		するものと想定している。		</p></li></ul></div><div class="sect2" title="NSCDの問題に関する警告"><div class="titlepage"><div><div><h3 class="title"><a name="id2677945"></a>NSCDの問題に関する警告</h3></div></div></div><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>	いかなる状況でも<code class="literal">winbindd</code>が動作しているシステム上で	<code class="literal">nscd</code>を動かさないこと。	</p></div><p>	もしも<code class="literal">nscd</code>がUNIX/Linuxシステム上で動いている時、NSSWITCHが	正しく設定されていても、ファイルとディレクトリの管理のために、ドメインユーザと	グループを解決することはできない。	</p></div><div class="sect2" title="Winbindがユーザとグループを解決しない"><div class="titlepage"><div><div><h3 class="title"><a name="id2677984"></a>Winbindがユーザとグループを解決しない</h3></div></div></div><p><span class="quote">“<span class="quote">	<code class="filename">smb.conf</code>ファイルは正しく設定した。	<a class="link" href="smb.conf.5.html#IDMAPUID" target="_top">idmap uid = 12000</a>と	<a class="link" href="smb.conf.5.html#IDMAPGID" target="_top">idmap gid = 3000-3500</a>を設定し、	<code class="literal">winbind</code>を走らせている。以下を行うとすべてうまく行く。	</span>”</span></p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>wbinfo -u</code></strong>MIDEARTH\maryoMIDEARTH\jackbMIDEARTH\ameds...MIDEARTH\root<code class="prompt">root# </code><strong class="userinput"><code>wbinfo -g</code></strong>MIDEARTH\Domain UsersMIDEARTH\Domain AdminsMIDEARTH\Domain Guests...MIDEARTH\Accounts<code class="prompt">root# </code><strong class="userinput"><code>getent passwd</code></strong>root:x:0:0:root:/root:/bin/bashbin:x:1:1:bin:/bin:/bin/bash...maryo:x:15000:15003:Mary Orville:/home/MIDEARTH/maryo:/bin/false</pre><p><span class="quote">“<span class="quote">ところが、以下のコマンドは失敗する:</span>”</span></p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>chown maryo a_file</code></strong>chown: `maryo': invalid user</pre><p><span class="quote">“<span class="quote">気が変になりそうなのだが何がいけないのだろう?</span>”</span></p><p>前記の問題と同じである。使用しているシステムは、恐らく<code class="literal">nscd</code>を動作させているのだろう。システムを再起動ではなく一旦シャットダウンすれば、その後では、問題は解消しているだろう。</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="VFS.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="optional.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="AdvancedNetworkManagement.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 23. スタッカブルVFSモジュール </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 25. 詳細なネットワーク管理</td></tr></table></div></body></html>