<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Chapter 45. Sambaパフォーマンスチューニング</title><link rel="stylesheet" href="../samba.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="公式のSamba 3.2.x HOWTOとリファレンスガイド"><link rel="up" href="Appendix.html" title="Part VI. Reference Section"><link rel="prev" href="Other-Clients.html" title="Chapter 44. Samba と他の CIFS クライアント"><link rel="next" href="ch-ldap-tls.html" title="Chapter 46. LDAPとトランスポート層のセキュリティ"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 45. Sambaパフォーマンスチューニング</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="Other-Clients.html">Prev</a> </td><th width="60%" align="center">Part VI. Reference Section</th><td width="20%" align="right"> <a accesskey="n" href="ch-ldap-tls.html">Next</a></td></tr></table><hr></div><div class="chapter" title="Chapter 45. Sambaパフォーマンスチューニング"><div class="titlepage"><div><div><h2 class="title"><a name="speed"></a>Chapter 45. Sambaパフォーマンスチューニング</h2></div><div><div class="author"><h3 class="author"><span class="firstname">Paul</span> <span class="surname">Cochrane</span></h3><div class="affiliation"><span class="orgname">Dundee Limb Fitting Centre<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:paulc@dth.scot.nhs.uk">paulc@dth.scot.nhs.uk</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Jelmer</span> <span class="othername">R.</span> <span class="surname">Vernooij</span></h3><div class="affiliation"><span class="orgname">The Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jelmer@samba.org">jelmer@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">John</span> <span class="othername">H.</span> <span class="surname">Terpstra</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jht@samba.org">jht@samba.org</a>></code></p></div></div></div></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="speed.html#id2716116">比較</a></span></dt><dt><span class="sect1"><a href="speed.html#id2716172">ソケットオプション</a></span></dt><dt><span class="sect1"><a href="speed.html#id2716287">読み取りサイズ</a></span></dt><dt><span class="sect1"><a href="speed.html#id2716348">Max Xmit</a></span></dt><dt><span class="sect1"><a href="speed.html#id2716410">ログレベル</a></span></dt><dt><span class="sect1"><a href="speed.html#id2716434">Read Raw</a></span></dt><dt><span class="sect1"><a href="speed.html#id2716506">Write Raw</a></span></dt><dt><span class="sect1"><a href="speed.html#id2716560">ログインが遅い</a></span></dt><dt><span class="sect1"><a href="speed.html#id2716587">クライアントのチューニング</a></span></dt><dt><span class="sect1"><a href="speed.html#id2716614">Linuxカーネルを変更した事によるSambaパフォーマンス問題</a></span></dt><dt><span class="sect1"><a href="speed.html#id2716734">壊れたtdbファイル</a></span></dt><dt><span class="sect1"><a href="speed.html#id2716842">Sambaのパフォーマンスがとても悪い</a></span></dt></dl></div><div class="sect1" title="比較"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2716116"></a>比較</h2></div></div></div><p>SamvaサーバーはクライアントとTCP通信を使用しているため、パフォーマンスを上げるには同じプロトコルを使用しているプログラムと比べてみるべきである。最も簡単に入手できるTCPを使用したファイル転送プログラムは、FTPもしくは他のTCPベースのSMBサーバである。</p><p>もしNTやWindows Workgroups serverに対して実験してみたいなら、クライアントかサーバのTCP以外は無効にする必要がある。そうしないとNetBEUIのようなまったく違うプロトコルが使われ、比較は意味がない。</p><p>通常、SambaプラットフォームがFTPと同じぐらいの理論上の転送速度で動作することが解るだろう。速度はそのシステムの環境次第だが、NFSよりかは相当早い。</p><p>何人かは、SambaとNovell、NFS又はWindows NTとの間での比較を行った。そのうちのいくつかの場合は、Sambaの動作は一番よく、ほかの場合は一番悪かった。最も大きな要素は、Samba対他のシステムではなく、種々のシステムで使用しているハードウェアとドライバであると推測している。同じようなハードウェアで、Sambahaは他のシステムと、速度の点において競合できうる。</p></div><div class="sect1" title="ソケットオプション"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2716172"></a>ソケットオプション</h2></div></div></div><p>いくつかのオプションは、SambaのようなTCPベースのサーバのパフォーマンスに大きな影響を与える。</p><p>Sambaが使うソケットオプションは、<code class="option">-O</code>をコマンド行に指定するか、<code class="filename">smb.conf</code> ファイルに記述できる。</p><p><code class="filename">smb.conf</code> のマニュアルページの<a class="link" href="smb.conf.5.html#SOCKETOPTIONS" target="_top">socket options</a>に、どのように記述するか、推奨は何かがが書いてある。</p><p>ソケットオプションを正しく設定すれば大きくパフォーマンスを改善できるが、間違って設定すると同じくらいパフォーマンスが悪くなる。正しい設定は、使用するネットワークにとても依存する。</p><p>TCP_NODELAYは多くのネットワークにおいて、単独で大きな違いを引き起こす。多くの人々が<a class="link" href="smb.conf.5.html#SOCKETOPTIONS" target="_top">socket options = TCP_NODELAY</a>を追加することで、Sambaのreadパフォーマンスを2倍にしたと報告している。MicrosoftのTCP/IPスタックがTCP ACKを送るのが遅いためだというのが一番良い説明だろう。</p><p><em class="parameter"><code>socket options = SO_RCVBUF=8192</code></em> をsmb.confの中に書き込むことで、Sambaのループバックアダプタ(IP Address 127.0.0.1)のパフォーマンスがひどく下がるという報告がある。<em class="parameter"><code>socket options</code></em>を設定する前に、サーバ上で定量的に計測することを強く推奨する。</p></div><div class="sect1" title="読み取りサイズ"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2716287"></a>読み取りサイズ</h2></div></div></div><p><a class="link" href="smb.conf.5.html#READSIZE" target="_top">read size</a>オプションは、ディスクのR/WとネットワークのR/Wの同時動作に影響する。いくつかのSMBコマンド(currently SMBwrite, SMBwriteXとSMBreadbraw)で転送されているデータ量がこの値より大きかったとき、サーバはネットワークからそのパケットを受け取る前にデータを書き込む。もしくは、SMBreadrawコマンドの場合、全てのデータをディスクから読む前にネットワークに書き込む。</p><p>この並列動作は、ディスクアクセスとネットワークアクセスがほぼ同じ速度の場合に最も効果があり、どちらか片方がとても早い場合にはあまり効果がない。</p><p>既定値は16384である。最適値を決めるために多少試験してみたが、最適値はシステム間で非常に大きく違うようである。65536以上の値には意味が無く、不必要にメモリを割り当ててしまう。</p></div><div class="sect1" title="Max Xmit"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2716348"></a>Max Xmit</h2></div></div></div><p>起動時にクライアントとサーバとの間で、ほぼすべてのコマンドサイズを制限する、<em class="parameter"><code>maximum transmit</code></em>値の調停を行う。sambaが調停する最大値を<code class="filename">smb.conf</code>に<a class="link" href="smb.conf.5.html#MAXXMIT" target="_top">max xmit</a>オプションを使うことで設定できる。これはSambaが受け取るSMBリクエストの最大値であり、クライアントが受け取る最大値ではない。クライアントのmaximum受信サイズはクライアントからSambaに送られ、Sambaはその値を信頼する。</p><p>既定値では65536バイトに設定されているが、より小さい値の方がよいという場合もありうる。2048より小さい値にすると、重大な問題を引き起こす可能性がある。殆どの場合、既定値が最適である。</p></div><div class="sect1" title="ログレベル"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2716410"></a>ログレベル</h2></div></div></div><p><a class="link" href="smb.conf.5.html#DEBUGLEVEL" target="_top">debug level</a>として設定できるログレベルを2より大きくすると、大幅にパフォーマンスが低下する。これはサーバが各操作後ににログをフラッシュし、それがとても時間がかかるためである。</p></div><div class="sect1" title="Read Raw"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2716434"></a>Read Raw</h2></div></div></div><p><a class="link" href="smb.conf.5.html#READRAW" target="_top">read raw</a>操作は、最適化された、レイテンシの小さい、ファイル読み取り操作の為に設計されている。サーバはそれをサポートしなくてもよいが、Sambaは<a class="link" href="smb.conf.5.html#READRAW" target="_top">read raw</a>サポートをオプションとしていて、規定値では有効になっている。</p><p>ある場合、クライアントは<a class="link" href="smb.conf.5.html#READRAW" target="_top">read raw</a>をうまく扱えず、従来の読み取り操作を使うよりも、それを使うことで実際にはパフォーマンスが落ちることとなり、そのため、<a class="link" href="smb.conf.5.html#READRAW" target="_top">read raw = no</a>を試して、ネットワーク上で何が起きるかを観察しても良い。それはパフォーマンスを下げるか上げるか、あるいは何も起きないかもしれない。テストすることで真実がわかる。</p></div><div class="sect1" title="Write Raw"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2716506"></a>Write Raw</h2></div></div></div><p><a class="link" href="smb.conf.5.html#WRITERAW" target="_top">write raw</a>操作は、最適化された、レイテンシの小さい、ファイル読み取り操作の為に設計されている。サーバはそれをサポートしなくてもよいが、Sambaは<a class="link" href="smb.conf.5.html#READRAW" target="_top">read raw</a>サポートをオプションとしていて、規定値では有効になっている。</p><p>多くの場合、<a class="link" href="smb.conf.5.html#WRITERAW" target="_top">write raw</a>をパラメータを変更しようとした場合、変更すると通常よりも速度が遅くなる。</p></div><div class="sect1" title="ログインが遅い"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2716560"></a>ログインが遅い</h2></div></div></div><p>ログインが遅い場合は、多くの場合パスワードチェックのためである。最も小さい実用的な<a class="link" href="smb.conf.5.html#PASSWORDLEVEL" target="_top">password level</a>は、これを改善する。</p></div><div class="sect1" title="クライアントのチューニング"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2716587"></a>クライアントのチューニング</h2></div></div></div><p>大抵の場合、スピードの問題はクライアントに原因がある。(Windows for Workgroupsのような)クライアントはたいていの場合、TCPパフォーマンスをより改善できる。<a class="link" href="Other-Clients.html" title="Chapter 44. Samba と他の CIFS クライアント">Sambaとその他のCIFSクライアント</a>中の、各種クライアントについての節をチェックすること。</p></div><div class="sect1" title="Linuxカーネルを変更した事によるSambaパフォーマンス問題"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2716614"></a>Linuxカーネルを変更した事によるSambaパフォーマンス問題</h2></div></div></div><p>あるユーザーがメーリングリストに次のように発言した。</p><div class="blockquote"><blockquote class="blockquote"><p><a class="indexterm" name="id2716632"></a><a class="indexterm" name="id2716638"></a>私はGentooの上でSamba 2.2.8aを動かしています。最近私はカーネルのバージョンを<code class="filename">linux-2.4.19-gentoo-r10</code>から<code class="filename">linux-2.4.20-wolk4.0s</code>に変更しました。すると、Sambaのパフォーマンスに問題が生じました。多くの人々はおそらく<span class="quote">“<span class="quote">普通のソース(kernel)に移行しろ!</span>”</span>」と言うでしょう。もちろん私は試しましたが、上手くいきませんでした。私は100MBのLANと２台のコンピュータ(LinuxとWindows2000)を使っています。LinuxサーバーでDivxファイルの入ったフォルダを共有し、クライアント(Windows2000)でLAN経由で再生していました。2.4.19カーネルにする前は全てが上手く動いていましたが、現在では動画は固まって止まってしまいます。サーバーからWindowsへファイルを移動させようとしましたが、それもとても遅いです。</p></blockquote></div><p>それに対してこのような返答があった。</p><div class="blockquote"><blockquote class="blockquote"><p><a class="indexterm" name="id2716699"></a><a class="indexterm" name="id2716706"></a><a class="indexterm" name="id2716713"></a>mii-toolを持ってきて、NIC上の全二重の設定をチェックするとよいでしょう。私はこれはデータリンク層の問題で、アプリケーション層の問題ではないと思います。また、ifconfigを動かし、そのフレーミングエラー、コリジョン、その他を調べ、ethenetが問題ないのかを見ましょう。</p></blockquote></div></div><div class="sect1" title="壊れたtdbファイル"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2716734"></a>壊れたtdbファイル</h2></div></div></div><p><a class="indexterm" name="id2716742"></a><a class="indexterm" name="id2716748"></a><a class="indexterm" name="id2716755"></a>我々のSambaPDCサーバは、3年間の間問題なく500以上のユーザ[Windows NT/XP]で3TBのデータをホスティングしていました。現在ではすべての共有がとても遅いです。親プロセスのsmbdは継続してプロセスを起動していて、(通常なら平均で250なのに)1600以上のSMDBプロセスが起動しています。これによってSUN E3500が2回壊れています。幾たびもの調査の後、<code class="literal">rm /var/locks/*.tdb</code>を実行することにしました。その結果、再び良好に動作しました。</p><p><span class="emphasis"><em>質問:</em></span>*.tdbファイルを最良の状態に保持する何らかの方法はあるのでしょうか?あるいは、どのようにしたら、素早く破壊状態を検出できるのでしょうか?</p><p><a class="indexterm" name="id2716796"></a><a class="indexterm" name="id2716803"></a><span class="emphasis"><em>答え:</em></span> はい、nmdbの停止と起動のたびに<code class="literal">tdbbackup</code>を実行してください。</p><p><span class="emphasis"><em>質問:</em></span>さらに言及したいこととして、サービスのレイテンシは削除前よりかなり遅くなったように見えます。最高速度を保持する良いアイデアはありませんか?</p><p><span class="emphasis"><em>答え:</em></span>はい、同じ質問が前にありました。</p></div><div class="sect1" title="Sambaのパフォーマンスがとても悪い"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2716842"></a>Sambaのパフォーマンスがとても悪い</h2></div></div></div><p><a class="indexterm" name="id2716851"></a>MYOB Premier操作とそのデータファイルへのアクセスにおいて、とても不可解な徴候を経験したと、あるサイトは報告した。そのファイルへのいくつかの操作で40秒から45秒の時間がかかった。</p><p><a class="indexterm" name="id2716870"></a><a class="indexterm" name="id2716877"></a>Windowsクライアント上でプリンタモニタープログラムを走らせたところ、この問題が発生した。ログから、1秒ごとに休止状態が発生していることが分かりました。</p><p><a class="indexterm" name="id2716894"></a><a class="indexterm" name="id2716902"></a>モニタソフトウエアを止めたところ、ネットワーク速度が普通(早い状態に)戻りました。再びモニタソフトウエアを起動させたところ、再び遅くなりました。プリンターはCanon LBP-810で and the relevant task wassomething like CAPON (not sure on spelling). モニタソフトウエアは、クライアントが印刷中、"印刷中"を表示している。</p><p>Windowsのクリーンインストールと、他のソフトを何度も段階的にインストールすることによって、発見した。</p><p>この話の教訓:すべてをチェックしなさい(他のソフトウェアも含めて)!</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="Other-Clients.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="Appendix.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch-ldap-tls.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 44. Samba と他の CIFS クライアント </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 46. LDAPとトランスポート層のセキュリティ</td></tr></table></div></body></html>