<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Chapter 32. 高可用性</title><link rel="stylesheet" href="../samba.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="公式のSamba 3.2.x HOWTOとリファレンスガイド"><link rel="up" href="optional.html" title="Part III. 詳細な設定方法"><link rel="prev" href="Backup.html" title="Chapter 31. バックアップテクニック"><link rel="next" href="largefile.html" title="Chapter 33. 大きなディレクトリの取扱い"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 32. 高可用性</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="Backup.html">Prev</a> </td><th width="60%" align="center">Part III. 詳細な設定方法</th><td width="20%" align="right"> <a accesskey="n" href="largefile.html">Next</a></td></tr></table><hr></div><div class="chapter" title="Chapter 32. 高可用性"><div class="titlepage"><div><div><h2 class="title"><a name="SambaHA"></a>Chapter 32. 高可用性</h2></div><div><div class="author"><h3 class="author"><span class="firstname">John</span> <span class="othername">H.</span> <span class="surname">Terpstra</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jht@samba.org">jht@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Jeremy</span> <span class="surname">Allison</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jra@samba.org">jra@samba.org</a>></code></p></div></div></div></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="SambaHA.html#id2695217">機能と利便性</a></span></dt><dt><span class="sect1"><a href="SambaHA.html#id2695369">技術的な議論</a></span></dt><dd><dl><dt><span class="sect2"><a href="SambaHA.html#id2695409">最終目的</a></span></dt><dt><span class="sect2"><a href="SambaHA.html#id2695548">これがなぜ難しいか?</a></span></dt><dt><span class="sect2"><a href="SambaHA.html#id2696383">簡単なソリューション</a></span></dt><dt><span class="sect2"><a href="SambaHA.html#id2696484">高可用性サーバ製品</a></span></dt><dt><span class="sect2"><a href="SambaHA.html#id2696648">MS-DFS: 貧者のクラスター</a></span></dt><dt><span class="sect2"><a href="SambaHA.html#id2696695">結論</a></span></dt></dl></dd></dl></div><div class="sect1" title="機能と利便性"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2695217"></a>機能と利便性</h2></div></div></div><p><a class="indexterm" name="id2695225"></a><a class="indexterm" name="id2695231"></a><a class="indexterm" name="id2695238"></a>ネットワーク管理者は、しばしばファイルと印刷サービスの可用性について関心を持っている。ネットワークユーザは、きわめて重要な、責任ある仕事を遂行するのに依存するサービスに対して、厳しい態度をとりがちである。</p><p>コンピュータルームにある以下の標語が、スタッフに自らの責任を思い起こさせるのであった。それは以下のようなものであった:</p><div class="blockquote"><blockquote class="blockquote"><p><a class="indexterm" name="id2695270"></a><a class="indexterm" name="id2695277"></a><a class="indexterm" name="id2695284"></a><a class="indexterm" name="id2695291"></a>すべての人間は過ちを犯すものである。大小を問わず、我々は絶えず過ちを犯している。機会も同様に故障するものである。コンピュータは人によって管理される機械であり、故障の結果は悲惨なものとなりうる。管理者の責任は、故障に対処し、故障を予測し、人知の及ぶ限り、かつ経済的に合理的な範囲でその可能性を抹消することに他ならない。あなたの行動は、問題の一部となるか、それとも解決の一部となるか。</p></blockquote></div><p>もしも、計画的、生産的な方法で障害に対処するのであれば、まず最初に問題を理解する必要がある。それがこの章の目的である。</p><p><a class="indexterm" name="id2695321"></a><a class="indexterm" name="id2695328"></a><a class="indexterm" name="id2695335"></a>以下の議論には障害に対抗するためにネットワーク基盤をどのように展開すべきかについてのポイントとなる情報も含まれている。ただし、ここでの目的は、高可用性に関する長大な論文を発表することではない。そのため、高可用性を提供するソリューションの具体的な実例は提示していない。Samba を含む CIFS/SMB 技術を展開する際に適用するための、高可用性に関する最新の知識とノウハウの紹介を主眼に置いた詳細なドキュメントの作成に誰かが挑戦してくれることを期待して、ここでの記述は概論に留める判断を行っている。</p></div><div class="sect1" title="技術的な議論"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2695369"></a>技術的な議論</h2></div></div></div><p><a class="indexterm" name="id2695376"></a><a class="indexterm" name="id2695384"></a><a class="indexterm" name="id2695391"></a>以下の要約は、2003年4月に、ドイツのゲッティンンゲンで行われた、SambaXP 2003カンファレンスで、Jeremy Allisonによって行われた発表の一部である。素材となる情報は、幾つか追加されているが、それらを以下の構成にまとめあげたのは、Jeremy ならではである。</p><div class="sect2" title="最終目的"><div class="titlepage"><div><div><h3 class="title"><a name="id2695409"></a>最終目的</h3></div></div></div><p><a class="indexterm" name="id2695417"></a><a class="indexterm" name="id2695424"></a><a class="indexterm" name="id2695431"></a>	すべてのクラスタリング技術は以下の1つあるいはそれ以上を達成することを目的としている:	</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>コンピュータの能力を最大限使えること。</p></li><li class="listitem"><p>より高速なプロトコル実行を行うこと。</p></li><li class="listitem"><p>無停止サービスを提供すること。</p></li><li class="listitem"><p>単一障害点を避けること。</p></li><li class="listitem"><p>資源を最も効果的に使うこと。</p></li></ul></div><p>	クラスタ化されたファイルサーバは理想的に以下の属性を有している:<a class="indexterm" name="id2695478"></a><a class="indexterm" name="id2695486"></a><a class="indexterm" name="id2695493"></a><a class="indexterm" name="id2695500"></a>	</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>すべてのクライアントはどのサーバにも透過的に接続できる。</p></li><li class="listitem"><p>サーバが故障するとクライアントは透過的に他のサーバに再接続できる。</p></li><li class="listitem"><p>すべてのサーバは、同じファイル群を提供する。</p></li><li class="listitem"><p>すべてのファイルの変更は、すべてのサーバで直接行われるように見える。</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p>分散ファイルシステムが必要。</p></li></ul></div></li><li class="listitem"><p>より多くのサーバやディスクを追加することで、無限に拡張できる。</p></li></ul></div></div><div class="sect2" title="これがなぜ難しいか?"><div class="titlepage"><div><div><h3 class="title"><a name="id2695548"></a>これがなぜ難しいか?</h3></div></div></div><p>	簡単に言うと、問題は<span class="emphasis"><em>状態(state)</em></span>にある。	</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><a class="indexterm" name="id2695569"></a>			すべてのTCP/IP接続はステート情報に依存する。			</p><p><a class="indexterm" name="id2695581"></a>			TCP接続はパケットシーケンス番号を持っている。このシーケンス			番号は、シームレスなTCPフェールオーバーを引き起こすために、			クラスタ中で、すべてのマシン上で動的に更新される必要がある。			</p></li><li class="listitem"><p><a class="indexterm" name="id2695604"></a><a class="indexterm" name="id2695611"></a>			CIFS/SMB(Windowsネットワークプロトコル)はTCP接続を使用している。			</p><p>			これは、基本的な設計の見地から、フェイルオーバーは真剣に考慮			されていない事を意味する。			</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p>				すべての現在のSMBクラスタはフェールオーバーソリューション				である。これらは再接続するクライアントに				頼っている。これは、サーバのフェールオーバーを提供するが、				クライアントはサーバの故障のために情報を失う可能性がある。<a class="indexterm" name="id2695645"></a>				</p></li></ul></div><p>			</p></li><li class="listitem"><p>			サーバはクライアント接続に関するステート情報を保存する。			</p><div class="itemizedlist"><a class="indexterm" name="id2695665"></a><ul class="itemizedlist" type="circle"><li class="listitem"><p>CIFS/SMBには多くのステートがある。</p></li><li class="listitem"><p>すべてのファイルのオープンは、共有モードを				    チェックするために他のオープンしているファイルと比較する。</p></li></ul></div><p>			</p></li></ul></div><div class="sect3" title="最先端の状況"><div class="titlepage"><div><div><h4 class="title"><a name="id2695689"></a>最先端の状況</h4></div></div></div><p><a class="indexterm" name="id2695697"></a><a class="indexterm" name="id2695704"></a><a class="indexterm" name="id2695711"></a><a class="indexterm" name="id2695719"></a><a class="indexterm" name="id2695726"></a><a class="indexterm" name="id2695733"></a><a class="indexterm" name="id2695740"></a>		1つの名前と1つのIPアドレスを持つ単一のサーバのように、ファイルサーバの		クラスタを見せるためにすることは可能で、クライアントから受信した		TCPデータストリームはフロントエンドの仮想サーバによって処理される必要が		ある。このサーバはSMBプロトコルレイヤレベルで、入力したパケットを分割し、		次に、クラスタ中の異なったサーバにSMBパケットを中継する。		</p><p><a class="indexterm" name="id2695760"></a><a class="indexterm" name="id2695767"></a>		印刷とユーザ検索要求を扱うためには、すべてのIPC$接続とRPC呼び出しを1台の		サーバに振り分けるしかない。RPC印刷ハンドルは、異なったIPC$		セッションで共有される。これをクラスタを構成するサーバ間で		分割するのは難しい!		</p><p>		概念的に、他のすべてのサーバはファイルサービスのみ提供する。これは		集中させるよりも簡単な問題である。		</p></div><div class="sect3" title="SMBリクエストの分割"><div class="titlepage"><div><div><h4 class="title"><a name="id2695797"></a>SMBリクエストの分割</h4></div></div></div><p><a class="indexterm" name="id2695806"></a><a class="indexterm" name="id2695813"></a><a class="indexterm" name="id2695820"></a><a class="indexterm" name="id2695828"></a>		SMBリクエストを分割する事は、SMBステート情報を知っていることが要求され、そのすべては		フロントエンドの<span class="emphasis"><em>仮想</em></span>サーバによって保持されねばならない。		これは解決するのには複雑で難しい問題である。		</p><p><a class="indexterm" name="id2695849"></a><a class="indexterm" name="id2695856"></a><a class="indexterm" name="id2695862"></a>		Windows XPとその後継は、その意味を変更し、そのため、ステート情報		(vuid,tid,fid)は操作が成功するために一致しなければならない。これは、		以前よりも物事を単純にし、前へ進むためのよい一歩である。		</p><p><a class="indexterm" name="id2695881"></a><a class="indexterm" name="id2695889"></a>		SMBリクエストは、それに対応するサーバにvuidによって送られる。		このソリューションを作り出すコードは現在存在しない。この問題は、		Samba中で、Windows 2000ターミナルサーバからの複数のリクエストからの		リクエストを正しく処理する問題と、概念的に似ている。		</p><p><a class="indexterm" name="id2695909"></a>		直接クライアントにサーバプールを提示することで開始するという		1つの可能性がある。これは、分割ステップを省略できる。		</p></div><div class="sect3" title="分散ファイルシステムの試み"><div class="titlepage"><div><div><h4 class="title"><a name="id2695924"></a>分散ファイルシステムの試み</h4></div></div></div><p><a class="indexterm" name="id2695933"></a>		UNIXとLinux用に、たくさんの分散ファイルシステムがある。		</p><p><a class="indexterm" name="id2695946"></a><a class="indexterm" name="id2695953"></a><a class="indexterm" name="id2695960"></a><a class="indexterm" name="id2695967"></a><a class="indexterm" name="id2695974"></a><a class="indexterm" name="id2695980"></a>		SMB文法を認識することを、ずっと心にとめている間は、我々のクラスタの		バックエンドに多くが適用できる(共有モード、ロックとoplock問題は特に)。		一般的な自由に使える分散ファイルシステムには以下がある:		Many could be adopted to backend our cluster, so long as awareness of SMB		semantics is kept in mind (share modes, locking, and oplock issues in particular).		Common free distributed file systems include:<a class="indexterm" name="id2695998"></a><a class="indexterm" name="id2696005"></a><a class="indexterm" name="id2696012"></a><a class="indexterm" name="id2696018"></a>		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>NFS</p></li><li class="listitem"><p>AFS</p></li><li class="listitem"><p>OpenGFS</p></li><li class="listitem"><p>Lustre</p></li></ul></div><p><a class="indexterm" name="id2696049"></a>		サーバプール(クラスタ)は、もしもすべてのSMB文法がそのプール内で実行出来るならば、		任意の分散ファイルシステムを使える。		</p></div><div class="sect3" title="分散ファイルシステム上の限定的な制約"><div class="titlepage"><div><div><h4 class="title"><a name="id2696064"></a>分散ファイルシステム上の限定的な制約</h4></div></div></div><p><a class="indexterm" name="id2696073"></a><a class="indexterm" name="id2696080"></a><a class="indexterm" name="id2696088"></a><a class="indexterm" name="id2696095"></a>		クラスタ化されたサーバが純粋なSMBサービスを提供するとき、oplockの		処理は、バックエンドのファイルシステムプールに渡す必要性はなく、		サーバプール内で完結してもよい。		</p><p><a class="indexterm" name="id2696113"></a><a class="indexterm" name="id2696120"></a>		他方、サーバプールがNFSや他のファイルサービスをも提供する場合、		SMBサービスと相互運用できるように、oplockを認識する実装は基本である。		これは、現在有意義な挑戦である。これの相互運用性の提供に失敗すると、		Microsoft Windows クライアントのユーザによってはっきりと気がつく		明確な性能の低下をもたらす。		</p><p>		最後に、すべてのステート情報は、サーバプール間で共有されるべきである。		</p></div><div class="sect3" title="サーバプールの通信"><div class="titlepage"><div><div><h4 class="title"><a name="id2696146"></a>サーバプールの通信</h4></div></div></div><p><a class="indexterm" name="id2696154"></a><a class="indexterm" name="id2696161"></a><a class="indexterm" name="id2696168"></a><a class="indexterm" name="id2696174"></a>		ほとんどのバックエンドファイルシステムは、POSIXファイルシステムを		サポートしている。これは、SMB文法をファイルシステム中で使うことを		困難にしている。POSIXのロック機構は、SMBのロック機構とは異なる		属性と文法である。		</p><p><a class="indexterm" name="id2696195"></a><a class="indexterm" name="id2696202"></a><a class="indexterm" name="id2696208"></a>		サーバプール中のすべての<code class="literal">smbd</code>プロセスはごく短時間に		通信しなければならない。このため、Sambaが使う現在の		<em class="parameter"><code>tdb</code></em>ファイル構造はネットワーク間で使うのには		適していない。クラスタ化された<code class="literal">smbd</code>は何らかの、		他のものを使う必要がある。		</p></div><div class="sect3" title="サーバプール通信の要求"><div class="titlepage"><div><div><h4 class="title"><a name="id2696241"></a>サーバプール通信の要求</h4></div></div></div><p>		サーバプール内の高速サーバ間通信は、完全に機能するシステムのために		あらかじめ必要な機能である。これを可能にするものは以下のものがある:		</p><div class="itemizedlist"><a class="indexterm" name="id2696259"></a><a class="indexterm" name="id2696266"></a><ul class="itemizedlist" type="disc"><li class="listitem"><p>			商用の共有メモリバス(例:MyrinetまたはSCI [scalable coherent interface])。			これはとても価格が高い。			</p></li><li class="listitem"><p>			ギガビットイーサネット(現在簡単に使える)。			</p></li><li class="listitem"><p>			生のイーサネットフレーミング(TCPとUDPのオーバヘッドをバイパス)。			</p></li></ul></div><p>		これらの機能を有効化する効果の有無を計るパフォーマンス指標はまだ確立していない。		</p></div><div class="sect3" title="Sambaに対する変更要求"><div class="titlepage"><div><div><h4 class="title"><a name="id2696309"></a>Sambaに対する変更要求</h4></div></div></div><p>		Sambaは、透過的なフィルオーバクラスタが出来るように、高速サーバ間接続システムで		動くように、明確に修正する必要がある。		</p><p>		影響を受けると思われるSamba内の特定の機能は以下の通り:		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>			データベースのロック、oplockの通知と共有モードデータベース。			</p></li><li class="listitem"><p><a class="indexterm" name="id2696344"></a><a class="indexterm" name="id2696351"></a>			何をもって「障害」とみなすかを定義する必要がある。Sambaは			Windowsと同様に動作する。oplockが失敗を通知すると、ファイル			オープン要求は許可されるが、これはクラスタ環境では潜在的な			危険性がある。サーバ間プールの障害という意味は、どのように			位置づけるべきか、またこうした機能をどのように実装すべきか。			</p></li><li class="listitem"><p>			これはポイントツーポイントロックマネージャを使って実装すべきか、			あるいは、マルチキャスト手法を使って行うべきだろうか?			</p></li></ul></div></div></div><div class="sect2" title="簡単なソリューション"><div class="titlepage"><div><div><h3 class="title"><a name="id2696383"></a>簡単なソリューション</h3></div></div></div><p><a class="indexterm" name="id2696391"></a><a class="indexterm" name="id2696398"></a><a class="indexterm" name="id2696406"></a>	フェイルオーバサーバにエクスポートされたファイルシステム内で異なった機能を	扱えるようにすることは、分散ロッキングプロトコルを要求する問題をなくす。	</p><p><a class="indexterm" name="id2696424"></a><a class="indexterm" name="id2696431"></a>	もしも、ペアの中で1つのサーバのみアクティブである場合、高速サーバ間通信の必要性は	無くなる。この場合、新しいものを開発する代わりに、既存の高可用性ソリューションが	使える。これはかなりのコストがかかる単純なソリューションである。	そのコストとは、より複雑なファイル名空間を管理する必要があるということである。	単一のファイルシステムではないため、管理者はすべてのサービスがどこに配置されて	いるかを覚えておかなければならない。複雑さは、扱うのが容易ではない。	</p><p><a class="indexterm" name="id2696468"></a>	<span class="emphasis"><em>仮想サーバ</em></span>は、バックエンドサーバに要求をリダイレクトする	ため、引き続き必要である。バックエンドファイル空間の完全性は管理者の責任である。	</p></div><div class="sect2" title="高可用性サーバ製品"><div class="titlepage"><div><div><h3 class="title"><a name="id2696484"></a>高可用性サーバ製品</h3></div></div></div><p><a class="indexterm" name="id2696492"></a><a class="indexterm" name="id2696498"></a><a class="indexterm" name="id2696505"></a><a class="indexterm" name="id2696512"></a><a class="indexterm" name="id2696519"></a>	フェイルオーバサーバはリソースのフェイルオーバを扱うために通信する必要がある。	これは高可用性サービスでは基本である。専用のハートビートを使うことは、	フェイルオーバプロセスで、ある種の自立性を導入する、一般的な技術である。	これは、しばしは専用のリンク(LANまたはシリアル通信)上で行われる。	</p><p><a class="indexterm" name="id2696540"></a><a class="indexterm" name="id2696546"></a><a class="indexterm" name="id2696554"></a><a class="indexterm" name="id2696561"></a><a class="indexterm" name="id2696568"></a>	多くのフェイルオーバソリューション(Red HatクラスタマネージャとMicrosoft Wolfpack	のような)はフェイルオーバ通信のためにファイバチャネルディスクストレージアレイ	をSCSIで共有して使える。Sambaに対するRed Hat高可用性ソリューションについての	情報は、	<a class="ulink" href="http://www.redhat.com/docs/manuals/enterprise/RHEL-AS-2.1-Manual/cluster-manager/s1-service-samba.html" target="_top">www.redhat.com</a>	で得られる。	</p><p><a class="indexterm" name="id2696597"></a>	Linux高可用性プロジェクトは、高可用性Sambaファイルサーバソリューションを構築	したいならば、考慮するに値するリソースである。	<a class="ulink" href="http://www.linux-ha.org/" target="_top">www.linux-ha.org/</a>にある	ホームページを見てほしい。	</p><p><a class="indexterm" name="id2696622"></a><a class="indexterm" name="id2696629"></a>	フロントエンドサーバの複雑性は、すべてのネットワーククライアントに対して、	サービスの継続性を同時に提供する間、バックエンドの障害をうまく扱わなければ	ならないという理由で、高可用性に対する挑戦の余地がある。	</p></div><div class="sect2" title="MS-DFS: 貧者のクラスター"><div class="titlepage"><div><div><h3 class="title"><a name="id2696648"></a>MS-DFS: 貧者のクラスター</h3></div></div></div><p><a class="indexterm" name="id2696657"></a><a class="indexterm" name="id2696664"></a>	MS-DFSリンクは異なったバックエンドサーバにクライアントをリダイレクトするのに	使われる。これはMicrosoftによってすでに導入された何かで、ネットワーククライアントに	複雑性を増やしてしまう。MS-DFSは単純な、ファイルレベルでさえ動作する、継続的な	ファイルシステム名前空間という幻影を作成する。	</p><p>	とりわけ、管理の複雑さを犠牲にすると、分散システム(仮のクラスタ)は既存のSambaの	機能を使うことで作成できる。	</p></div><div class="sect2" title="結論"><div class="titlepage"><div><div><h3 class="title"><a name="id2696695"></a>結論</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>透過的なSMBクラスタは作るのが難しい!</p></li><li class="listitem"><p>クライアントフェイルオーバは現在出来る最も良いものである。</p></li><li class="listitem"><p>実用的で管理が楽な高可用性透過的クラスタソリューションを可能にする前には、		    たくさんの作業が必要である。</p></li><li class="listitem"><p>MS-DFSは単一の透過的クラスタという幻想を作るのことができる。</p></li></ul></div></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="Backup.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="optional.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="largefile.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 31. バックアップテクニック </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 33. 大きなディレクトリの取扱い</td></tr></table></div></body></html>