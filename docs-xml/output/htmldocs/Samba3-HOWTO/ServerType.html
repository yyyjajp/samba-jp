<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Chapter 3. サーバタイプとセキュリティモード</title><link rel="stylesheet" href="../samba.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="公式のSamba 3.2.x HOWTOとリファレンスガイド"><link rel="up" href="type.html" title="Part II. サーバ設定の基本"><link rel="prev" href="type.html" title="Part II. サーバ設定の基本"><link rel="next" href="samba-pdc.html" title="Chapter 4. ドメイン制御"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 3. サーバタイプとセキュリティモード</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="type.html">Prev</a> </td><th width="60%" align="center">Part II. サーバ設定の基本</th><td width="20%" align="right"> <a accesskey="n" href="samba-pdc.html">Next</a></td></tr></table><hr></div><div class="chapter" title="Chapter 3. サーバタイプとセキュリティモード"><div class="titlepage"><div><div><h2 class="title"><a name="ServerType"></a>Chapter 3. サーバタイプとセキュリティモード</h2></div><div><div class="author"><h3 class="author"><span class="firstname">Andrew</span> <span class="surname">Tridgell</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:tridge@samba.org">tridge@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Jelmer</span> <span class="othername">R.</span> <span class="surname">Vernooij</span></h3><div class="affiliation"><span class="orgname">The Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jelmer@samba.org">jelmer@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">John</span> <span class="othername">H.</span> <span class="surname">Terpstra</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jht@samba.org">jht@samba.org</a>></code></p></div></div></div></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="ServerType.html#id2565754">機能と利便性</a></span></dt><dt><span class="sect1"><a href="ServerType.html#id2565956">サーバタイプ</a></span></dt><dt><span class="sect1"><a href="ServerType.html#id2566120">Sambaセキュリティモード</a></span></dt><dd><dl><dt><span class="sect2"><a href="ServerType.html#id2566312">ユーザレベルのセキュリティ</a></span></dt><dt><span class="sect2"><a href="ServerType.html#id2566518">共有レベルのセキュリティ</a></span></dt><dt><span class="sect2"><a href="ServerType.html#id2566743">ドメインセキュリティモード(ユーザレベルのセキュリティ)</a></span></dt><dt><span class="sect2"><a href="ServerType.html#id2567323">ADS セキュリティモード(ユーザレベルのセキュリティ)</a></span></dt><dt><span class="sect2"><a href="ServerType.html#id2567485">サーバセキュリティ(ユーザレベルのセキュリティ)</a></span></dt></dl></dd><dt><span class="sect1"><a href="ServerType.html#id2567812">パスワードの検査</a></span></dt><dt><span class="sect1"><a href="ServerType.html#id2568075">共通のエラー</a></span></dt><dd><dl><dt><span class="sect2"><a href="ServerType.html#id2568107">何がSambaをサーバにするか?</a></span></dt><dt><span class="sect2"><a href="ServerType.html#id2568153">何がSambaをドメインコントローラにするか?</a></span></dt><dt><span class="sect2"><a href="ServerType.html#id2568193">何がSambaをドメインメンバにするか?</a></span></dt><dt><span class="sect2"><a href="ServerType.html#id2568224">常時パスワードサーバへの接続不可</a></span></dt><dt><span class="sect2"><a href="ServerType.html#id2568289">スタンドアロンサーバはドメインコントローラに変換された  が、ユーザのアカウントが動作しない</a></span></dt></dl></dd></dl></div><p><a class="indexterm" name="id2565699"></a><a class="indexterm" name="id2565706"></a>この章では、Sambaで設定可能なサーバのタイプに関する情報を提供する。Sambaへのマイグレーションか、単に使いたいと思っているMicrosoft ネットワーク管理者は、Microsoft Windows管理者にわかりやすい言葉で、Sambaの文脈においてその意味を知りたいはずである。これは、サーバそれ自身をどのように設定するかという詳細を得る前に重要なセキュリティモードの機能を定義すると同様に重要であることを意味する。</p><p>この章では、Microsoftサーバとクライアントにどのように関連することと、Sambaのセキュリティモードができることについての概要を提供する。</p><p>しばしば聞かれる質問は、<span class="quote">“<span class="quote">なぜSambaを使うのか</span>”</span>である。ほとんどの章は、機能と利便性に注目した節を含んでいる。情報がこの質問に答える手助けを提供することを希望している。しかし、我々は公正で合理的であることを望むので、すべての機能がSambaに対して好ましいとは限らないことを警告する。利便性は競合他社の方にあるかもしれない。</p><div class="sect1" title="機能と利便性"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2565754"></a>機能と利便性</h2></div></div></div><p>2人の人が汚れた道を歩いていたとき、1人が突然小さな赤い石を蹴飛ばした。それは彼のつま先を傷つけ、サンダルに突き刺さった。彼は石を取り去り、苦しみと激怒のあまりののしった。もう1人は石を見て、<span class="quote">“<span class="quote">これはガーネットだ。これを貴重な宝石に変えられる。そして、いつの日かこれはプリンセスを非常に幸福にするだろう!</span>”</span></p><p>この物語の教訓:2人の人は同じ石に対して2つの非常に異なった観点を持っていた。それと同じかどうかにかかわらず、Sambaはその石と似ている。正しく扱えばとても優れた宝物になるが、それに関わる時間を持つことが出来ないことを強いられるならば、それは非常に不愉快なものになる。</p><p><a class="indexterm" name="id2565794"></a><a class="indexterm" name="id2565803"></a>SambaはUNIXサーバとMicrosoft Windows 3.xクライアントのための相互運用性を提供するためのプロジェクトとして開始された。それは、ささやかなスタートから大きく成長し、いまや巨大システムに適合する機能を提供するようになった。しかし若干の問題点もある。このような節ではその両方について触れる。</p><p>そのため、この章で説明されている機能の利点は何であろうか?</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>	<a class="indexterm" name="id2565832"></a>	Samba-3はMicrosoft Windows NT4 ドメインコントローラを置き換えられる。	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2565848"></a>	Samba-3はネイティブのMicrosoft Active Directoryドメインと同じように	NT4スタイルのMicrosoft Windows NT4スタイルのドメインとのすぐれた相	互運用性を提供する。	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2565866"></a>	Samba-3は完全なNT4スタイルのドメイン間の信頼関係を許可する。	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2565881"></a>	<a class="indexterm" name="id2565888"></a>	SambaはMicrosoft Windows NT4ドメインコントローラで出来るよりも	より柔軟性のある認証機能を許可するセキュリティモードを持っている。	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2565906"></a>	<a class="indexterm" name="id2565917"></a>	Samba-3は複数の同時アクセス可能なアカウントデータベースバックエンドを	使える(暗号化パスワードはWindowsネットワーキングのために固有となる形	式でアカウントデータベース中に格納される)。	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2565937"></a>	アカウントデータベースバックエンドは複数の方法で複製され配布される。	これは、Samba-3がMicrosoft Windows NT4よりもより優れた柔軟性を与え、	多くの場合、Microsoft Windows 200xのActive Directory ドメインよりも	かなり便利なユーティリティとなる。	</p></li></ul></div></div><div class="sect1" title="サーバタイプ"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2565956"></a>サーバタイプ</h2></div></div></div><p><a class="indexterm" name="id2565964"></a>Microsoftネットワークの管理者はしばしば3つの異なったタイプのサーバを参照する:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>ドメインコントローラ</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p>Primary Domain Controller (PDC)</p></li><li class="listitem"><p>Backup Domain Controller (BDC)</p></li><li class="listitem"><p>ADS Domain Controller</p></li></ul></div></li><li class="listitem"><p>ドメインメンバサーバ</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p>Active Directory Domain Server</p></li><li class="listitem"><p>NT4 Style Domain Domain Server</p></li></ul></div></li><li class="listitem"><p>スタンドアロンサーバ</p></li></ul></div><p><a class="indexterm" name="id2566027"></a><a class="indexterm" name="id2566036"></a><a class="indexterm" name="id2566044"></a><a class="indexterm" name="id2566052"></a>ドメイン制御を扱っている節(<a class="link" href="samba-pdc.html" title="Chapter 4. ドメイン制御">ドメイン制御</a>), バックアップのドメイン制御(<a class="link" href="samba-bdc.html" title="Chapter 5. バックアップドメインコントローラ">バックアップドメイン制御</a>),と ドメインメンバシップ(<a class="link" href="domain-member.html" title="Chapter 6. ドメインメンバシップ">ドメインメンバシップ</a>)は3つのサーバの役割のためのSambaの設定に言及する適切な情報を提供する。Sambaドメインセキュリティの実装のための基礎を作るために、それらの章のそれぞれについて、精通しておくことを強く推奨する。</p><p><a class="indexterm" name="id2566095"></a>スタンドアロンサーバはアカウント管理が独立している。<span class="emphasis"><em>スタンドアロン</em></span>サーバとして設定することがサーバにとって何を意味するかについてのより広い評価を得るために、<a class="link" href="StandAloneServer.html" title="Chapter 7. スタンドアロンサーバ">スタンドアロンサーバ</a>を参照のこと。</p></div><div class="sect1" title="Sambaセキュリティモード"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2566120"></a>Sambaセキュリティモード</h2></div></div></div><p><a class="indexterm" name="id2566129"></a><a class="indexterm" name="id2566135"></a>この節では、Sambaのセキュリティモードの機能と目的について説明する。おのおののモードのためにMicrosoft Windows クライアントを設定する方法と同様におのおののセキュリティモードについてどのようにSambaが実装しているかを正確に理解することは、ユーザの不満と管理者の心労をとても減らすだろう。</p><p><a class="indexterm" name="id2566155"></a><a class="indexterm" name="id2566163"></a>Microsoft Windows ネットワークはもともとServer Message Block(SMB)プロトコルと呼ばれていたプロトコルを使っている。1996年あたりから、プロトコルはCommon Internet Filesystem(CIFS)プロトコルとしてより知られるようになった。</p><p><a class="indexterm" name="id2566184"></a><a class="indexterm" name="id2566191"></a><a class="indexterm" name="id2566197"></a><a class="indexterm" name="id2566203"></a>SMB/CIFSネットワークにおいては、<span class="emphasis"><em>ユーザレベル</em></span>と<span class="emphasis"><em>共有レベル</em></span>という2つのセキュリティのみがある。それらをまとめて<span class="emphasis"><em>セキュリティレベル</em></span>として参照する。それら2つのセキュリティレベルの実装において、SambaはMicrosoft Windows NT4/200xサーバでは出来ない柔軟性を提供する。実際、Sambaは<span class="emphasis"><em>共有レベル</em></span>のセキュリティを1つの方法で実装しているが、<span class="emphasis"><em>ユーザレベル</em></span>のセキュリティについては4つの方法で実装している。それらをまとめて、Sambaでのセキュリティレベルの実装を<span class="emphasis"><em>セキュリティモード</em></span>と呼ぶ。それらは、<span class="emphasis"><em>share</em></span>, <span class="emphasis"><em>user</em></span>, <span class="emphasis"><em>domain</em></span>,<span class="emphasis"><em>ADS</em></span>と<span class="emphasis"><em>server</em></span>モードとして知られている。それらはこの章で解説されている。</p><p>セッションのセットアップ時にクライアントに対してSMBサーバは動作しているサーバのセキュリティレベルを伝える。それはシェアレベルとユーザレベルという2つのオプションである。2つのうちのどちらかをクライアントが受け取り、それは、クライアントがそれ自身を認証するときに試みる方法に影響する。それはSambaサーバをセキュリティ化する方法には直接(たいして)影響しない。これは奇妙に聞こえるが、それはSMBのクライアント/サーバアプローチに適合する。SMB中では、すべてはクライアントによって開始され、制御され、サーバはクライアントに対して、何が有効で、どのような動作が許可されるかのみを通知できる。</p><p><code class="literal">client</code>という語は、たとえばWindowsワークステーション、Windowsサーバ、あるいはその他の平凡なSMBまたはCIFSクライアントアプリケーション(たとえば<code class="literal">smbclient</code>)のような、SMB/CIFSサーバによって提供されるサービスを使うものすべてのエージェントを参照する。</p><div class="sect2" title="ユーザレベルのセキュリティ"><div class="titlepage"><div><div><h3 class="title"><a name="id2566312"></a>ユーザレベルのセキュリティ</h3></div></div></div><p><a class="indexterm" name="id2566320"></a>それが簡単なため、最初にユーザレベルのセキュリティを説明する。ユーザレベルのセキュリティでは、クライアントはプロトコルネゴシエーションを伴って、直接セッションセットアップ要求を送信する。この要求はユーザ名とパスワードを提供する。サーバはそのユーザ名/パスワードペアを受け取るか拒否するかのどちらかを行う。この段階で、サーバはクライアントが結局接続しようと試みる共有が何であるかを知るすべはなく、そのため、<span class="emphasis"><em>許可/拒否</em></span>について、以下の2つ以外をベースと出来ない:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>ユーザ名/パスワード ペア</p></li><li class="listitem"><p>クライアントマシンの名前</p></li></ol></div><p><a class="indexterm" name="id2566373"></a>もしもサーバがユーザ名/パスワードペア認証を許可するならば、クライアントは、その先パスワード指定なしで(<span class="emphasis"><em>tree connection</em></span>を使って)共有をマウントできることを仮定する。クライアントは、すべてのアクセス権限が最初の<span class="emphasis"><em>session setup</em></span>中で指定したユーザ名/パスワード認証セットであることを仮定する。</p><p><a class="indexterm" name="id2566398"></a>複数の<span class="emphasis"><em>session setup</em></span>要求をクライアントが送信することも可能である。サーバが返信するとき、そのユーザ名/パスワードペアのための、認証タグとして使うために、<span class="emphasis"><em>uid</em></span>を送る。クライアントはこの方法で複数の認証コンテキストを操作することが可能である(このことを行うアプリケーションの例としてはWinDDがある)。</p><p><a class="indexterm" name="id2566421"></a><a class="indexterm" name="id2566428"></a><a class="indexterm" name="id2566434"></a><a class="indexterm" name="id2566440"></a><a class="indexterm" name="id2566446"></a>Windowsネットワークユーザアカウント名は大文字小文字に依存しない。すなわち、アカウント名中の大文字小文字はすべて同一視されると言うことである。また、大文字小文字の状態は保存されるが、大文字小文字の状態は関係ないということである。Windows NT 3.10より前のWindowsとLanManagerシステムは、大文字小文字の状態を保存する必要がない、大文字小文字を無視するパスワードを使っていた。すべてのWindows NT ファミリシステムはパスワードについて、大文字小文字を保存し、それを意識するように取り扱う。</p><div class="sect3" title="設定例"><div class="titlepage"><div><div><h4 class="title"><a name="id2566478"></a>設定例</h4></div></div></div><p>ユーザレベルのセキュリティを実現する <code class="filename">smb.conf</code> の例は以下の通り:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2566501"></a><em class="parameter"><code>security = user</code></em></td></tr></table><p>これはSamba-2.2.xの既定値である。</p></div></div><div class="sect2" title="共有レベルのセキュリティ"><div class="titlepage"><div><div><h3 class="title"><a name="id2566518"></a>共有レベルのセキュリティ</h3></div></div></div><p><a class="indexterm" name="id2566526"></a><a class="indexterm" name="id2566533"></a>共有レベルのセキュリティ中では、クライアント自身の認証はおのおのの共有毎に分離している。クライアントはおのおのの tree connection要求(共有マウント)と共にパスワードを送るが、この操作で明示的にユーザ名を送らない。クライアントは、おのおのの共有にパスワードが関連づけられ、ユーザから独立していることを期待する。これは、Sambaは、ユーザ名がSMBサーバに明示的に送られないために、クライアントが使いたいとしているユーザ名をSambaが考えなければならないことを意味する。たとえばNTのような、いくつかの商用SMBサーバは共有レベルのセキュリティ中に直接共有とパスワードを関連づけるが、Sambaはいつでも、共有/パスワードペアではなく、認証に使ったユーザ名/パスワードペアを使うUNIX認証スキームを使う。</p><p>Microsoftネットワーキングとの類似点を理解するために、パスワードあり/なしでリードオンリまたはフルアクセスできる共有フォルダを作成できる、Microsoft Windows 9x/Meについて考えてみる。</p><p>多くのクライアントは、サーバが共有レベルのセキュリティであったとしても、session setup要求を送る。それらは通常有効なユーザ名を送るがパスワードは送らない。Sambaは有効なユーザ名リスト中にこのユーザ名を記憶する。クライアントがtree connection要求を次に発行するとき、接続しようとする共有名の名前(ホームディレクトリに有用)をこのリストに追加もし、<code class="filename">smb.conf</code>ファイル中の<a class="link" href="smb.conf.5.html#USER" target="_top">user</a>パラメータ中にリストされているユーザもである。次にパスワードが、それらの可能なユーザ名に対して順番にチェックされる。もしも一致したものが見つかれば、クライアントはそのユーザとして認証される。</p><p><a class="indexterm" name="id2566617"></a><a class="indexterm" name="id2566626"></a><a class="indexterm" name="id2566632"></a>使用可能なユーザ名のリストが提供されていない場合、Sambaは、標準のアカウントデータベースから、そのユーザに対して提供されるパスワードとユーザアカウントをUNIXのシステムコールを使って探し出すことを行う。システムがネームサービススイッチ(NSS)機能を持っていない場合、そのような検索は<code class="filename">/etc/passwd</code>データベースを対象として行う。NSSが有効なシステムの場合、検索は、<code class="filename">nsswitch.conf</code>ファイル中で指定されたライブラリを通じて行う。ライブラリを指定するそのファイル中のエントリは以下の通り:</p><pre class="screen">passwd: files nis ldapshadow: files nis ldapgroup: files nis ldap</pre><p><a class="indexterm" name="id2566672"></a><a class="indexterm" name="id2566678"></a><a class="indexterm" name="id2566684"></a>以下の例(実際に使われるようなものではないが)では、検索は、<code class="filename">/etc/passwd</code>と <code class="filename">/etc/group</code>に対して行われ、見つからなければ NISでチェックし、次にLDAPでチェックする。</p><div class="sect3" title="設定例"><div class="titlepage"><div><div><h4 class="title"><a name="id2566707"></a>設定例</h4></div></div></div><p>共有レベルのセキュリティを設定する<code class="filename">smb.conf</code> パラメータは以下の通り:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2566730"></a><em class="parameter"><code>security = share</code></em></td></tr></table></div></div><div class="sect2" title="ドメインセキュリティモード(ユーザレベルのセキュリティ)"><div class="titlepage"><div><div><h3 class="title"><a name="id2566743"></a>ドメインセキュリティモード(ユーザレベルのセキュリティ)</h3></div></div></div><p><a class="indexterm" name="id2566752"></a><a class="indexterm" name="id2566760"></a><a class="indexterm" name="id2566768"></a><a class="indexterm" name="id2566775"></a><a class="indexterm" name="id2566781"></a><a class="indexterm" name="id2566787"></a>ドメインセキュリティは、すべてのユーザとグループアカウントを、中央の共有されているアカウントリポジトリに保存するメカニズムを提供する。中央のアカウントリポジトリはドメイン(セキュリティ)コントローラ間で共有される。ドメインコントローラとして振る舞うサーバはドメインに対するセキュリティコンテキストに参加するすべてのマシンに、認証と確認サービスを提供する。プライマリドメインコントローラ(PDC)はセキュリティアカウントデータベースの完全性を管理するための責任を負うサーバである。バックアップドメインコントローラ(BDC)はドメインログオンと認証サービスのみを提供する。通常、BDCはPDCが行うよりもより反応性がよいネットワークログオン要求を提供する。</p><p><a class="indexterm" name="id2566827"></a><a class="indexterm" name="id2566833"></a><a class="indexterm" name="id2566840"></a><a class="indexterm" name="id2566848"></a><a class="indexterm" name="id2566856"></a>Sambaが<a class="link" href="smb.conf.5.html#SECURITY" target="_top">security = domain</a>モードで動作中の時、Sambaサーバはドメインセキュリティ信頼アカウント(マシンアカウント)を持ち、ドメインコントローラに対してすべての認証要求をパススルーする。別の言い方をすると、この設定は、実際、それがドメインコントローラとして振る舞う場合にも、Sambaサーバをドメインメンバサーバにする。ドメインセキュリティに参加するすべてのマシンはセキュリティデータベース中にマシンアカウントを持たなければならない。</p><p><a class="indexterm" name="id2566897"></a><a class="indexterm" name="id2566905"></a><a class="indexterm" name="id2566914"></a><a class="indexterm" name="id2566922"></a>ドメインセキュリティ環境ないで、セキュリティアーキテクチャの基盤は、ユーザレベルのセキュリティを使う。ドメインメンバであるマシンは開始時に認証を行わなければならない。アカウントデータベース内にあるアカウントエントリの一部であるマシンアカウントは、その名前がマシンのNetBIOS名であり、パスワードはランダムに生成され、ドメインコントローラと他のマシンの両方に知られている。もしもマシンアカウントがセットアップ中に認証されなければ、ユーザは、それが認証できないため、そのマシンを使ってドメインにログオンできない。マシンアカウントはマシン信頼アカウントとして参照される。</p><p>ドメインメンバの設定には以下の3つのパターンがある:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>プライマリドメインコントローラ(PDC) - ドメインに1つのみ。</p></li><li class="listitem"><p>バックアップドメインコントローラ(BDC) - ドメインに複数配置可能。</p></li><li class="listitem"><p>ドメインメンバサーバ(DMS) - ドメインに複数配置可能。</p></li></ol></div><p><a class="indexterm" name="id2566990"></a>それぞれについて別の節で解説する。まずはじめに、もっとも関心のある基本的なDMSの設定について説明する。</p><div class="sect3" title="設定例"><div class="titlepage"><div><div><h4 class="title"><a name="id2567003"></a>設定例</h4></div></div></div><p><span class="emphasis"><em>Sambaをドメインメンバサーバとする</em></span></p><p><a class="indexterm" name="id2567016"></a>この方法は<code class="filename">smb.conf</code>ファイル中に以下のパラメータを必要とする:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2567036"></a><em class="parameter"><code>security = domain</code></em></td></tr><tr><td><a class="indexterm" name="id2567047"></a><em class="parameter"><code>workgroup = MIDEARTH</code></em></td></tr></table><p></p><p>この方法を動作させるために、SambaサーバはMicrosoft Windows NTセキュリティドメインにジョインする必要がある。これは以下の方法で行う:<a class="indexterm" name="id2567067"></a><a class="indexterm" name="id2567075"></a></p><div class="procedure"><ol class="procedure" type="1"><li class="step" title="Step 1"><p>Microsoft Windows NT ドメインコントローラ上で、サーバマネージャを	つかい、Sambaサーバのマシンアカウントを追加する。        </p></li><li class="step" title="Step 2"><p>UNIX/Linuxシステム上で以下を実行する:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>net rpc join -U administrator%password</code></strong></pre></li></ol></div><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><a class="indexterm" name="id2567126"></a>Samba-2.2.4とそれ以降の Samba 2.2.x 系列では、以下を実行することで、Windows NT4スタイルドメインへの自動ジョインが可能である:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>smbpasswd -j <em class="replaceable"><code>DOMAIN_NAME</code></em> -r <em class="replaceable"><code>PDC_NAME</code></em> \	 -U Administrator%<em class="replaceable"><code>password</code></em></code></strong></pre><p><a class="indexterm" name="id2567162"></a>Samba-3では同じことを以下の方法で行う:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>net rpc join -U Administrator%<em class="replaceable"><code>password</code></em></code></strong></pre><p>Samba-3では<em class="replaceable"><code>DOMAIN_NAME</code></em>か<em class="replaceable"><code>PDC_NAME</code></em>を指定する必要はないので、<code class="filename">smb.conf</code>ファイルの設定からこれをわかるようにする(訳注:訳があやしい)。</p></div><p><a class="indexterm" name="id2567210"></a><a class="indexterm" name="id2567216"></a><a class="indexterm" name="id2567222"></a>Windowsドメインコントローラによってアカウントが認証される時に、UIDを割り当てるため、このモードを使う認証は、おのおののユーザに対する標準UNIXアカウントがあることを要求する。このアカウントは、<code class="filename">/etc/passwd</code>エントリ中で不正なシェルとして設定するような方法で、Microsoft Windows以外のクライアントによってログオンすることをブロックすることができる。ユーザアカウントに対して不正なシェルを割り当てる最も良い方法は、シェルに<code class="filename">/bin/false</code>を割り当てることである。</p><p><a class="indexterm" name="id2567263"></a><a class="indexterm" name="id2567269"></a>ドメインコントローラは、利便性のために任意の場所に配置できる。BDCを配置する推奨は、物理ネットワーク毎に配置し、もしもPDCがリモートネットワークセグメントにあるならば、WINS(詳細は<a class="link" href="NetworkBrowsing.html" title="Chapter 10. ネットワークブラウジング">ネットワークのブラウジング</a>を参照)を使うのが基本である。</p><p>Sambaサーバ上でWindowsユーザにUIDを割り当てる別の方法は、<a class="link" href="winbind.html" title="Chapter 24. Winbind: ドメインアカウントの使用">Winbind</a>と<a class="link" href="winbind.html" title="Chapter 24. Winbind: ドメインアカウントの使用">Winbind: Use of Domain Accounts</a>にある。</p><p>ドメインメンバシップについてのより詳細な情報は<a class="link" href="domain-member.html" title="Chapter 6. ドメインメンバシップ">Domain Membership</a>を参照のこと。</p></div></div><div class="sect2" title="ADS セキュリティモード(ユーザレベルのセキュリティ)"><div class="titlepage"><div><div><h3 class="title"><a name="id2567323"></a>ADS セキュリティモード(ユーザレベルのセキュリティ)</h3></div></div></div><p><a class="indexterm" name="id2567333"></a><a class="indexterm" name="id2567339"></a>Samba-2.2とSamba-3の両方は、NT4スタイルのRPCベースのセキュリティを使ってActive Directoryドメインに参加することが出来る。これは、ドメインがネイティブモードで動作しているときに可能である。ネイティブモードのActive Directoryは完全にNT4スタイルのドメインメンバを許可する。これは世間一般の考えに反してである。</p><p>もしも、Active DirectoryをSamba-3と一緒に使っているとき、ネイティブなADメンバとしてジョインできる。なぜそれを望むか?NT互換の認証プロトコルの使用をセキュリティポリが禁止するかもしれない。Windows2000とそれ以降のすべてのマシンはKerberosを使用している。この場合、NT4スタイルのドメインとしてのSambaはNT互換の認証データを引き続き要求する。ADメンバモード中のSambaは、Kerberosチケットを受け取ることが出来る。</p><p><a class="indexterm" name="id2567372"></a><a class="indexterm" name="id2567379"></a>Microsoft WindowsのActive Directoryサービス(ADS)を使うサイトは、以下の用語の重要性に気づくべきである:<code class="literal">native mode</code> と <code class="literal">mixed mode</code>の ADS操作。 The term<code class="literal">realm</code>という単語はKerberosベースのセキュリティアーキテクチャ(Microsoft ADSによって使われるような)を説明するのに使われる。</p><div class="sect3" title="設定例"><div class="titlepage"><div><div><h4 class="title"><a name="id2567409"></a>設定例</h4></div></div></div><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2567421"></a><em class="parameter"><code>realm = your.kerberos.REALM</code></em></td></tr><tr><td><a class="indexterm" name="id2567431"></a><em class="parameter"><code>security = ADS</code></em></td></tr></table><p>以下のパラメータを必要としても良い:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2567453"></a><em class="parameter"><code>password server = your.kerberos.server</code></em></td></tr></table><p>この設定オプションの参考情報として、<a class="link" href="domain-member.html" title="Chapter 6. ドメインメンバシップ">ドメインメンバシップ</a>と<a class="link" href="domain-member.html#ads-member" title="Samba ADS ドメインメンバシップ">Samba ADS ドメインメンバシップ</a>を参照してほしい。</p></div></div><div class="sect2" title="サーバセキュリティ(ユーザレベルのセキュリティ)"><div class="titlepage"><div><div><h3 class="title"><a name="id2567485"></a>サーバセキュリティ(ユーザレベルのセキュリティ)</h3></div></div></div><p>サーバ席モードはドメインメンバサーバとして振る舞うのが出来ない場合に残されているものである。この機能を使わないことを強く推奨する。サーバセキュリティモードは以下のような多数の欠点がある:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Microsoft Windows NT4/200xパスワードサーバ上でアカウントロックアウトの可能性。</p></li><li class="listitem"><p>Lack of assurance that the password server is the one specified.</p></li><li class="listitem"><p>リモートでプロファイルを格納するときに特に必要な、Winbindと一緒に動かない。</p></li><li class="listitem"><p>このモードはパスワードサーバに対して接続をオープンにでき、また長期間それとオープンしたままにできる</p></li><li class="listitem"><p>突然リモートのパスワードサーバが停止したときに、不正にSambaサーバのセキュリティを壊す。</p></li><li class="listitem"><p>このモードでは、Sambaサーバのために属するドメイン中のパスワードサーバにセキュリティアカウントがない(訳注:訳が微妙)。</p></li></ul></div><p><a class="indexterm" name="id2567550"></a><a class="indexterm" name="id2567556"></a>サーバセキュリティモード中で、Sambaサーバはクライアントに、ユーザレベルセキュリティであることを報告する。クライアントは次に以前に説明したようにsession setupを行う。Sambaサーバはユーザ名/パスワードペアをクライアントから得、クライアントから得たユーザ名/パスワードペアと正確に同じものを送って<a class="link" href="smb.conf.5.html#PASSWORDSERVER" target="_top">password server</a>にログインしようとする。もしもサーバがユーザレベルのセキュリティで動作していて、パスワードを受け入れるならば、Sambaはクライアントからの接続を許可する。このパラメータは<a class="link" href="smb.conf.5.html#PASSWORDSERVER" target="_top">password server</a>としてSambaサーバを、別のSMBサーバを使うことができるようになる。</p><p><a class="indexterm" name="id2567599"></a><a class="indexterm" name="id2567606"></a>どのセキュリティレベルであるかとクライアントに告げるとき、これらすべての開始時にもしも暗号化をサポートしているのであrばそのこともクライアントに告げる。もしもそうであれば、クライアントに対して乱数を使った暗号化キーを送信する。クライアントは暗号化形式ですべてのパスワードを送る。Sambaは既定値でこのタイプの暗号化をサポートする。</p><p>パラメータ<a class="link" href="smb.conf.5.html#SECURITY" target="_top">security = server</a>は<span class="emphasis"><em>user mode</em></span>で動いていることをSambaがクライアントに報告することを意味するが、実際には別のユーザモードサーバに対してすべての認証要求を渡す。これは、真の認証サーバを差す追加の<a class="link" href="smb.conf.5.html#PASSWORDSERVER" target="_top">password server</a>パラメータを必要とする。真の認証サーバは別のSambaサーバでも、Windows NTサーバでもよく、後者は標準で暗号化パスワードをサポートしている。</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><a class="indexterm" name="id2567661"></a><a class="indexterm" name="id2567667"></a><span class="emphasis"><em>server security mode</em></span>でSambaサーバが動作しているとき、パラメータ<span class="emphasis"><em>password server</em></span>をターゲットの認証サーバの正確なNetBIOSマシン名に設定することは必要である。Sambaは、ターゲットの認証サーバの選択は任意であり、ドメイン名から決定できないという理由で、NetBIOS名前検索からこれを決定できない。本質的に、<span class="emphasis"><em>サーバセキュリティモード</em></span>のSambaサーバはワークグループモードとして知られているものとして動作している。</p></div><div class="sect3" title="設定例"><div class="titlepage"><div><div><h4 class="title"><a name="id2567698"></a>設定例</h4></div></div></div><p><span class="emphasis"><em>Microsoft Windows NTを認証サーバとして使う</em></span></p><p>この方法は<code class="filename">smb.conf</code>ファイル中に以下のパラメータを追記することになる:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2567726"></a><em class="parameter"><code>encrypt passwords = Yes</code></em></td></tr><tr><td><a class="indexterm" name="id2567737"></a><em class="parameter"><code>security = server</code></em></td></tr><tr><td><a class="indexterm" name="id2567747"></a><em class="parameter"><code>password server = "NetBIOS_name_of_a_DC"</code></em></td></tr></table><p>ユーザ名/パスワードペアが正しいかどうかを確認する2つの方法がある。1つは提供された認証メッセージングプロセスの一部としてリプライ情報を使うことであり、もう1つはエラーコードを使うことである。</p><p><a class="indexterm" name="id2567773"></a><a class="indexterm" name="id2567779"></a>このモードの設定の悪い点は、セキュリティの観点でSambaが偽のユーザ名と偽のパスワードをパスワードサーバに送る可能性があることと、もしもリモートのサーバが偽のユーザ名と偽のパスワードの認証拒否に失敗すると代替の認証か承認作業が使われてしまうと言うことである。数回の認証の繰り返し後にサイトがパスワードロックを使う場合、これはユーザをロックアウトしてしまう。</p><p>認証要求でのこのモードの使用はユーザが標準UNIXアカウントがあることを必要とする。このアカウントは非SMB/CIFSクライアントからのログオンを防止するためにブロックすることが出来る。</p></div></div></div><div class="sect1" title="パスワードの検査"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2567812"></a>パスワードの検査</h2></div></div></div><p>Microsoft Windows クライアントはチャレンジ/レスポンス認証モデル(NTLMv1とNTLMv2として知られる)の一部としての暗号化パスワードか、単独か、あるいは単純なパスワードベースの認証のための平文パスワードを使うことが出来る(訳注:aloneがよく分からない)。これはSMBプロトコルで実現され、パスワードは平文または暗号化されてネットワーク経由で渡されるが、同じ認証要求では両方は使われない。</p><p><a class="indexterm" name="id2567834"></a><a class="indexterm" name="id2567840"></a>暗号化パスワードが使われるとき、以下の2つの方法でユーザが入力したパスワードは暗号化される:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>unicodeのパスワード文字列をMD4でハッシュ。	これはNTハッシュとして知られているものである。        </p></li><li class="listitem"><p>パスワードは大文字化され、14バイトに短縮	される。この文字列に5バイトのNULL文字が追加され、"magic"	な8バイト値に暗号化するために、2つの56ビットDESキー形式	に分割される。結果はLanManハッシュという16ビットの値である。        </p></li></ul></div><p><a class="indexterm" name="id2567881"></a>Microsoft Windows 95 サービスパック1より前とWindows NT バージョン3.xとバージョン4.0のサービスパック3より前では、パスワード認証のどちらかのモードを使う。すべてのそれより後のMicrosoft Windowsバージョンはもはや既定値で平文パスワードをサポートしない。</p><p><a class="indexterm" name="id2567904"></a>Microsoft Windows クライアントは10分またはそれより長くアイドルな時にネットワークマッピングを切断するという習性がある。切断した、マップされたドライブ接続を使うためにユーザが試みるとき、クライアントはキャッシュされたパスワードのコピーを使って再接続する。</p><p>Microsoftが既定値のパスワードモードを変更したとき、平文パスワードのキャッシュサポートをやめた。これは、平文パスワードを使うためにレジストリパラメータを修正したときに、それは動くようになるが、もしもリモートの認証サーバが暗号化パスワードをサポートしないときに、切断されたサービスのマッピングを試みるときに失敗することを意味する。そのようなクライアントで平文パスワードを再度有効にすることは良い考えではないと確かに言える。</p><p>以下のパラメータは、平文テキストでの認証を使うときに、Windows 9x/Meクライアントが大文字化したユーザ名とパスワードをSMBサーバに送る前に問題になる時に使うことができるものである:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2567969"></a></td></tr><tr><td><a class="indexterm" name="id2567975"></a></td></tr></table><p>既定値では、Sambaはローカルのシステムアカウントデータベース中でユーザ名を検索する前にユーザ名を小文字に変更する。これは、UNIXユーザ名が慣習的に小文字のみで構成されていることによるためであり、<a class="link" href="smb.conf.5.html#USERNAME-LEVEL" target="_top">username-level</a>パラメータは滅多に必要とさない。</p><p><a class="indexterm" name="id2568006"></a>しかしながら、UNIXシステム上のパスワードはしばしば大文字小文字を混ぜた文字で構成されている。これは、平文認証を使ってSambaサーバに接続しようとするWindows 9x/Meクライアント上でのユーザのために、<a class="link" href="smb.conf.5.html#PASSWORDLEVEL" target="_top">password level</a>が、パスワードに現れることが<span class="emphasis"><em>出来る</em></span>大文字の最大数を設定しなければならないことを意味する。もしもサーバのOSが伝統的なDESバージョンを使うcrypt()を使うならば、<a class="link" href="smb.conf.5.html#PASSWORDLEVEL" target="_top">password level</a>を8に設定することは、結果としてWindowsユーザにとって、大文字小文字を無視したパスワードとして見える。これはまた、一致するまで(あるいはすべての組み合わせが失敗するまで)1つ1つ、Sambaがパスワード文字列の組み合わせを試みるために、より長いログイン時間がかかるという結果となる。</p><p>最も適用するのによいオプションは、Sambaが使われている所はどこでも、暗号化パスワードをサポートすることを有効にすることである。平文パスワードを使うためにレジストリを変更する試みは、結局はユーザの苦情と不便を導くことになるだろう。</p></div><div class="sect1" title="共通のエラー"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2568075"></a>共通のエラー</h2></div></div></div><p>我々はいつでも間違いを犯す。正しい場所で正しい時間と同じくらいの長さで間違いを犯すのは問題ない(訳注:意味がよく取れない)。製品版での重要な障害は重要視されるが、ラボでの開発バージョンにおいてのバグは期待されるものである。</p><p>Sambaメーリングリスト上の議論の題名となる共通の誤解と間違いを見てみよう。その多くは、Samba実装を試みる前にあなたの宿題としてその多くが回避可能である。そのいくつかは、英語を母国語としない人にとって、潜在的に曖昧で、とても紛らわしい多くのフレーズを持つ英文の誤解釈の結果である。</p><div class="sect2" title="何がSambaをサーバにするか?"><div class="titlepage"><div><div><h3 class="title"><a name="id2568107"></a>何がSambaをサーバにするか?</h3></div></div></div><p>ある人たちにとって、Sambaのセキュリティモードの性質は明白であるが、それでも完全に間違っている(訳注:意味取れない)。<a class="link" href="smb.conf.5.html#SECURITY" target="_top">security = server</a>はSambaがサーバとして動くと言うことを意味していることを仮定している。が、違う。この設定は、Sambaが、別のSmBサーバがユーザ認証サーバだけの提供元として使うことを<span class="emphasis"><em>試みる</em></span>ことを意味している。</p><p>Sambaはセキュリティモードが選択されたとしてもサーバである。Sambaがドメインセキュリティコンテキストの外で使われた場合、既定値にセキュリティモードをしておくのが最適である。Samba-3の既定値では、ユーザモードのセキュリティを使う。</p></div><div class="sect2" title="何がSambaをドメインコントローラにするか?"><div class="titlepage"><div><div><h3 class="title"><a name="id2568153"></a>何がSambaをドメインコントローラにするか?</h3></div></div></div><p><a class="indexterm" name="id2568161"></a><code class="filename">smb.conf</code> パラメータ <a class="link" href="smb.conf.5.html#SECURITY" target="_top">security = domain</a>は実際にSambaをドメインコントローラとして振る舞わさせるのではない。この設定はSambaがドメインメンバになることを期待することを意味する。より詳細については<a class="link" href="samba-pdc.html" title="Chapter 4. ドメイン制御">PDCとしてのSamba</a>を参照のこと。</p></div><div class="sect2" title="何がSambaをドメインメンバにするか?"><div class="titlepage"><div><div><h3 class="title"><a name="id2568193"></a>何がSambaをドメインメンバにするか?</h3></div></div></div><p>想像してみよう!So many others do. But whatever you do,<a class="link" href="smb.conf.5.html#SECURITY" target="_top">security = user</a>はSambaをドメインメンバとして振る舞わせることを考えてはいけない。保証期限が切れる前に製造者のマニュアルを読みなさい。より詳細については、<a class="link" href="domain-member.html" title="Chapter 6. ドメインメンバシップ">ドメインメンバシップ</a>を参照のこと。</p></div><div class="sect2" title="常時パスワードサーバへの接続不可"><div class="titlepage"><div><div><h3 class="title"><a name="id2568224"></a>常時パスワードサーバへの接続不可</h3></div></div></div><p><span class="quote">“<span class="quote">なぜ、server_validate()は単に、パスワードサーバに対する接続を再接続しないであきらめるのか?私はSMBプロトコルに詳しくはないが、たぶん、クラスタサーバプロセスはそのクライアントワークステーションの方に、パスワードサーバから渡されたセッションキーを渡し、それはクライアントから送信されたパスワードハッシュが、セッションキーが異なるそのあとの接続で動作しないことを意味する。(訳注:ちょっと不安)そのため、server_validate()は中断しなければならない。</span>”</span></p><p>本当に。それは、なぜ <a class="link" href="smb.conf.5.html#SECURITY" target="_top">security = server</a>が全くひどいハックである理由である。認証をパススルーすることが分かっている、<a class="link" href="smb.conf.5.html#SECURITY" target="_top">security = server</a>モードである、<a class="link" href="smb.conf.5.html#SECURITY" target="_top">security = domain</a>を使ってほしい。</p></div><div class="sect2" title="スタンドアロンサーバはドメインコントローラに変換された が、ユーザのアカウントが動作しない"><div class="titlepage"><div><div><h3 class="title"><a name="id2568289"></a>スタンドアロンサーバはドメインコントローラに変換された  が、ユーザのアカウントが動作しない</h3></div></div></div><p><span class="quote">“<span class="quote">DOMAINに入ろうとしたとき、イベントログに<span class="emphasis"><em>tried credentials DOMAIN/username; effective credentials SERVER/username</em></span>が表示された。</span>”</span></p><p>通常これはSambaサーバがドメインコントローラとして設定される前にユーザかマシンアカウントが作成されたことによるものである。サーバがドメインコントローラになるまえに作成されたアカウントは、<span class="emphasis"><em>ローカルの</em></span>アカウントであり、SERVERドメイン中のメンバとして見えるものとしてに認証され、Windows 2000とそれ以降の中のローカルユーザアカウントとほとんど同じである。Sambaサーバがドメインコントローラになったとに作成されたアカウントは、 <span class="emphasis"><em>ドメイン</em></span>アカウントであり、DOMAINメンバのメンバとして認証される。</p><p>これは、<code class="literal">pdbedit -L -v username</code>コマンドをを発行することによって確かめられる。もしも、これがDOMAINという結果を出したならば、アカウントはドメインアカウントであり、もしもSERVERであれば、そのアカウントはローカルアカウントである。</p><p>これを解決する最も簡単な方法は、アカウントを削除し再作成することである。しかしながら、この方法は、ユーザプロファイルの確率に問題を引き起こすかもしれない。<code class="literal">pdbedit -u username -I DOMAIN</code>コマンドを使うことも出来る。ドメインに一致するためにユーザSIDとプライマリグループSIDを変更する必要があるかもしれない。</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="type.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="type.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="samba-pdc.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Part II. サーバ設定の基本 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 4. ドメイン制御</td></tr></table></div></body></html>