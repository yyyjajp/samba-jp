<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Chapter 17. ファイルとレコードのロッキング</title><link rel="stylesheet" href="../samba.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="公式のSamba 3.2.x HOWTOとリファレンスガイド"><link rel="up" href="optional.html" title="Part III. 詳細な設定方法"><link rel="prev" href="AccessControls.html" title="Chapter 16. ファイル、ディレクトリと共有のアクセス制御"><link rel="next" href="securing-samba.html" title="Chapter 18. Securing Samba"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 17. ファイルとレコードのロッキング</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="AccessControls.html">Prev</a> </td><th width="60%" align="center">Part III. 詳細な設定方法</th><td width="20%" align="right"> <a accesskey="n" href="securing-samba.html">Next</a></td></tr></table><hr></div><div class="chapter" title="Chapter 17. ファイルとレコードのロッキング"><div class="titlepage"><div><div><h2 class="title"><a name="locking"></a>Chapter 17. ファイルとレコードのロッキング</h2></div><div><div class="author"><h3 class="author"><span class="firstname">Jeremy</span> <span class="surname">Allison</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jra@samba.org">jra@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Jelmer</span> <span class="othername">R.</span> <span class="surname">Vernooij</span></h3><div class="affiliation"><span class="orgname">The Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jelmer@samba.org">jelmer@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">John</span> <span class="othername">H.</span> <span class="surname">Terpstra</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jht@samba.org">jht@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Eric</span> <span class="surname">Roseme</span></h3><div class="affiliation"><span class="orgname">HP Oplocks Usage Recommendations Whitepaper<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:eric.roseme@hp.com">eric.roseme@hp.com</a>></code></p></div></div></div></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="locking.html#id2629877">機能と利便性</a></span></dt><dt><span class="sect1"><a href="locking.html#id2629991">議論</a></span></dt><dd><dl><dt><span class="sect2"><a href="locking.html#id2630312">Opportunistic Lockingの概要</a></span></dt></dl></dd><dt><span class="sect1"><a href="locking.html#id2631558">SambaのOplocks制御</a></span></dt><dd><dl><dt><span class="sect2"><a href="locking.html#id2631746">設定例</a></span></dt></dl></dd><dt><span class="sect1"><a href="locking.html#id2632213">Microsoft Windowsのoplocksとキャッシュ制御</a></span></dt><dd><dl><dt><span class="sect2"><a href="locking.html#id2632510">ワークステーションサービスのエントリ</a></span></dt><dt><span class="sect2"><a href="locking.html#id2632539">サーバサービスのエントリ</a></span></dt></dl></dd><dt><span class="sect1"><a href="locking.html#id2632634">持続的なデータ破壊</a></span></dt><dt><span class="sect1"><a href="locking.html#id2632683">よくあるエラー</a></span></dt><dd><dl><dt><span class="sect2"><a href="locking.html#id2632783">locking.tdb のエラーメッセージ</a></span></dt><dt><span class="sect2"><a href="locking.html#id2632822">Windows XP上でのMicrosoft Officeファイルセーブ時の問題</a></span></dt><dt><span class="sect2"><a href="locking.html#id2632850">XP SP1でネットワーク経由でファイルを消すのに長い時間がかかる</a></span></dt></dl></dd><dt><span class="sect1"><a href="locking.html#id2632888">参考文献</a></span></dt></dl></div><p><a class="indexterm" name="id2629862"></a>多くのネットワーク管理者に問題を発生させる1つの領域はロッキングである。問題の範囲はインターネット上で検索することですぐにはっきりする。</p><div class="sect1" title="機能と利便性"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2629877"></a>機能と利便性</h2></div></div></div><p><a class="indexterm" name="id2629885"></a>Sambaは、Microsoft Windows NT4/200xサーバも提供する、Microsoft Windowsクライアントが期待するすべてのロッキングのセマンティクスを提供する。</p><p><a class="indexterm" name="id2629902"></a><span class="emphasis"><em>ロッキング</em></span>という用語は、並外れて広い意味を持ち、この1つの用語の配下にすべてカテゴライズされる機能の範囲をカバーしている。</p><p><a class="indexterm" name="id2629918"></a><a class="indexterm" name="id2629925"></a><a class="indexterm" name="id2629932"></a>Opportunistic lockingはネットワークで結合されたクライアント上で、アプリケーションの見かけの性能を向上させることが出来る好ましい機能である。しかし、opportunistic lockingプロトコルは頑丈ではなく、そのため、極端に単純化した設定か、広範囲の遅くて障害の多いネットワーク上を超えて起動するときに、問題に遭遇する。この場合、opportunistic lockingのOSによる管理か、反復的なエラーは提供することを意図した考えられる性能の利点を相殺する。</p><p><a class="indexterm" name="id2629954"></a>Microsoft Windows ネットワーク管理者は、ファイルとレコードのロッキングセマンティックス(動作)はSamba中かMicrosoft Windowsクライアント上のレジストリの設定で制御できることを知っておく必要がある。</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><a class="indexterm" name="id2629975"></a>時々、各Microsoft WindowsクライアントのようにSambaサーバ上でロッキングの制御の設定を無効化する必要がある！</p></div></div><div class="sect1" title="議論"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2629991"></a>議論</h2></div></div></div><p><a class="indexterm" name="id2629998"></a><a class="indexterm" name="id2630006"></a>SMBサーバによって実行されることが必要な2つのタイプのロッキングがある。最初のものはオープンしているファイル中の一定の範囲のバイト範囲をクライアントがロックすることができる<span class="emphasis"><em>レコードロッキング</em></span>である。2番目のものは、ファイルがオープンしているときに指定される<span class="emphasis"><em>拒否モード</em></span>である。</p><p><a class="indexterm" name="id2630034"></a><a class="indexterm" name="id2630041"></a><a class="indexterm" name="id2630048"></a><a class="indexterm" name="id2630055"></a><a class="indexterm" name="id2630062"></a>UNIX配下のレコードロッキングのセマンティックスは、Windows配下のレコードロッキングと大幅に異なる。Samba2.2より前のSambaは、異なったSambaクライアントとの間で、適切なレコードロッキングを実装するために、ネイティブなfcntl()UNIXシステムコールを使うことを試みた。これはいくつかの理由で完全に正しいものにはならなかった。最も簡単なものは、Windowsクライアントはロックするバイトレンジとして、クライアントのOSに依存するが、2の32乗か2の64乗の範囲を指定できた。UNIXロッキングはレンジの幅として2の31乗までしかサポートしていなかった。そのため、2の31乗以上のロック要求を正確に満足させることは出来なかった。そのほかにもここに記述するのには余りにも多すぎる数多くの違いがあった。</p><p><a class="indexterm" name="id2630103"></a><a class="indexterm" name="id2630110"></a>Samba2.2以降では、UNIXシステムに依存しない、独立したレコードロッキングを完璧に実装した。もしもクライアントが0から2の31乗までの間でバイト幅ロックを要求した場合、SambaはUNIXシステムにこの要求を落として扱う。他のどのようなロックもUNIXでは扱わない。</p><p><a class="indexterm" name="id2630131"></a><a class="indexterm" name="id2630138"></a>厳密に言うと、Sambaサーバはファイル上への各読み/書きの呼び出し前にロックのチェックをすべきである。不幸にも、fcntl()が機能する方法で、これは遅延を引き起こし、<code class="literal">rpc.lockd</code>に負荷を掛けることになる。これは、それに対してロッキングが重要なとき、読み書きの前にロッキングを呼び出すことをクライアントは独立して行うはずという理由で、ほとんど常時不必要である。既定値では、Sambaはクライアントによって明示的に問い合わせがあったときにのみロッキングコールを行うが、もしも<a class="link" href="smb.conf.5.html#STRICTLOCKING" target="_top">strict locking = yes</a>を設定した場合、読み/書きの呼び出し<span class="emphasis"><em>毎に</em></span>ロックチェックの呼び出しを行う。</p><p><a class="indexterm" name="id2630196"></a><a class="link" href="smb.conf.5.html#LOCKING" target="_top">locking = no</a>を使うことによってバイト幅ロッキングを完全に停止することも出来る。これは、ロッキングをサポートしない共有か、必要がないとき(たとえばCD-ROMなど)に便利である。この場合、Sambaは毎回OKであると、ロッキング呼び出しの戻り値をクライアントに返すようにごまかす。</p><p><a class="indexterm" name="id2630231"></a><a class="indexterm" name="id2630237"></a><a class="indexterm" name="id2630244"></a><a class="indexterm" name="id2630251"></a><a class="indexterm" name="id2630258"></a><a class="indexterm" name="id2630264"></a><a class="indexterm" name="id2630271"></a>2番目のクラスのロッキングは、<span class="emphasis"><em>deny modes</em></span>である。これらは、そのオープンに対して同時に許されるべきアクセスのタイプを決めるため、ファイルをオープンしたときにアプリケーションによって設定される。クライアントは、<code class="constant">DENY_NONE</code>, <code class="constant">DENY_READ</code>,<code class="constant">DENY_WRITE</code>, か <code class="constant">DENY_ALL</code>を問い合わせできる。<code class="constant">DENY_FCB</code> と <code class="constant">DENY_DOS</code>と呼ばれる特別な互換モードもある。</p><div class="sect2" title="Opportunistic Lockingの概要"><div class="titlepage"><div><div><h3 class="title"><a name="id2630312"></a>Opportunistic Lockingの概要</h3></div></div></div><p><a class="indexterm" name="id2630320"></a><a class="indexterm" name="id2630327"></a><a class="indexterm" name="id2630334"></a>Opportunistic locking (oplocks)はサーバ上に存在するファイルにアクセスする時に、ネットワークの効率を増大させる目的で、レジストリエントリ(サーバとクライアント上)経由でWindowsファイルシステム(APIと対照した場合)によって起動される。効率は、以下を許容することでクライアント上にローカルにファイルをキャッシュすることにより増大させる:</p><div class="variablelist"><dl><dt><span class="term">Read-ahead:</span></dt><dd><p><a class="indexterm" name="id2630363"></a>		クライアントはファイルのローカルコピーから読み、ネットワークの待ち時間を		なくす。		</p></dd><dt><span class="term">Write caching:</span></dt><dd><p><a class="indexterm" name="id2630384"></a>		クライアントはファイルのローカルコピーに書き込み、ネットワークの待ち		間をなくす。		</p></dd><dt><span class="term">Lock caching:</span></dt><dd><p><a class="indexterm" name="id2630406"></a>		クライアントはアプリケーションをローカルにロックし、ネットワークの待ち		間をなくす。		</p></dd></dl></div><p><a class="indexterm" name="id2630422"></a><a class="indexterm" name="id2630429"></a><a class="indexterm" name="id2630436"></a>oplocksによる効率の増大は、他のプロセスからの同時アクセスのためのファイルのステータスをWindowsがモニタするために、deny-noneでオープンされていたとしても、ファイルに対する排他的なアクセスを行うことによる。</p><div class="variablelist" title="Windowsは4つの種類のOplocksを定義する:"><p class="title"><b>Windowsは4つの種類のOplocksを定義する:</b></p><dl><dt><span class="term">Level1 Oplock</span></dt><dd><p><a class="indexterm" name="id2630469"></a><a class="indexterm" name="id2630476"></a><a class="indexterm" name="id2630483"></a><a class="indexterm" name="id2630490"></a>			リダイレクタは、ファイルがdeny none(同時アクセスを許可)で			オープンしていることを確認し、ファイルに他のプロセスからの			アクセスが無いことを検査し、oplocksが有効になっていることを			確認し、次に、ファイルに対するdeny-all/read-write/exclusive			アクセスを許可する。その後、クライアントはキャッシュされたローカル			ファイルに対して操作を実行する。			</p><p><a class="indexterm" name="id2630511"></a><a class="indexterm" name="id2630518"></a><a class="indexterm" name="id2630524"></a><a class="indexterm" name="id2630531"></a>			もしも2番目のプロセスがファイルをオープンしようとすると、			オリジナルのoplockをリダイレクタが"ブレーク"するまで			オープンは待たされる。oplockブレークは、キャッシュしている			クライアントに、サーバにローカルファイルを書き戻し、ローカルの			ロックをフラッシュし、先読みしたデータを廃棄するように通知する。			ブレークが完了し、遅延したオープンが許可され、多重プロセスが、			強制的かバイト幅ロッキングオプションによって指示されたように、			同時ファイルアクセスが出来るようになる。しかし、もしもオリジナルの			ファイルがdeny-mode以外の共有モードの場合、次に、2番目の			プロセスは、oplockがブレークしても、アクセスが制限されるか			アクセスが拒否される。			</p></dd><dt><span class="term">Level2 Oplock</span></dt><dd><p><a class="indexterm" name="id2630579"></a><a class="indexterm" name="id2630586"></a><a class="indexterm" name="id2630593"></a>		キャッシングを除いて、Level1 oplockのような機能は、すべての読み出しに		対してのみ重要である。すべてのその他の操作は、サーバ上でファイルの		ディスクへのコピーを実行する。                </p></dd><dt><span class="term">Filter Oplock</span></dt><dd><p><a class="indexterm" name="id2630619"></a>				ファイルへの書き込み又は削除アクセスを許可しない。                </p></dd><dt><span class="term">Batch Oplock</span></dt><dd><p><a class="indexterm" name="id2630639"></a>				ファイルのオープンとクローズを操作し、ファイル属性のキャッシュを行う。                </p></dd></dl></div><p><a class="indexterm" name="id2630656"></a>oplocksはファイルシステムによって起動され、アプリケーションAPIではないということは重要な詳細事項である。そのため、あるアプリケーションはoplockされたファイルをクローズできるが、ファイルシステムはoplocksを放棄しない。oplockのブレークが発生したとき、ファイルシステムは次に、2番目のプロセスによる、次のファイルオープンの準備中で、単純にファイルをクローズする。</p><p><a class="indexterm" name="id2630676"></a><a class="indexterm" name="id2630683"></a><a class="indexterm" name="id2630690"></a><a class="indexterm" name="id2630697"></a><span class="emphasis"><em>Opportunistic locking</em></span>は、この機能に対して、実際には妥当ではない名前である。この機能の真の利点は、クライアントサイドのデータキャッシングであり、oplocksはネットワーク上のディスクストレージにデータを書き戻すための、単なる通知メカニズムである。oplocksの制限は、サーバとキャッシュしているクライアント間でのoplocksブレーク(通知)を処理するためのメカニズムの信頼性である。もしもこの交換に失敗すると(通常、数多くの理由でタイムアウトするという場合)、クライアントサイドキャッシングの優位性は否定される。</p><p><a class="indexterm" name="id2630731"></a>ユーザか管理者が考慮すべき、実際の決断点は、ローカルにクライアント上にキャッシュされる複数のユーザのデータ間で共有するのは賢明であるかどうかと言うことである。多くの場合、答えは「否」である。データをキャッシュするかしないかの決断は真の質問であり、そのため、oplocksはクライアントサイドのキャッシングのトグルとして取り扱うべきである。クライアントサイドのキャッシングが望ましく、信頼性がある場合、それを<span class="quote">“<span class="quote">on</span>”</span>にする。クライアントサイドのキャッシングが不必要で、信頼性に欠け、あるいは反生産的な場合、<span class="quote">“<span class="quote">off</span>”</span>にする。</p><p><a class="indexterm" name="id2630761"></a>Oplocksは既定値ではすべての設定された共有上にSambaによって<span class="quote">“<span class="quote">on</span>”</span>に設定されているので、もしも潜在的な利便性が、遅延の可能性より小さい場合、それぞれのケースで決定するときには注意深く行うべきである。以下の推奨項目は、oplocksが効果的になる環境を特徴づけるのに役に立つだろう。</p><p><a class="indexterm" name="id2630788"></a><a class="indexterm" name="id2630795"></a>Windowsのoplocksは簡易な効率向上機能である。これは堅牢でも信頼できるプロトコルではない。oplocksのすべての実装は、考え得る性能と信頼性との間でのトレードオフとして評価されるべきである。信頼性は、上記での継続したルールが適用されないように減少する。oplockが有効で、WAN上をまたいで、南太平洋の環礁の、高信頼性のサーバ上で、ミッションクリティカルな、多人数で使う会社のデータベースが台風にさらされている状況を考えてみよう。この設定はoplockの問題に遭遇するだろう。</p><p><a class="indexterm" name="id2630828"></a>Oplocksは、クライアントサイドでのデータキャッシングのための構成要素のトグルとして扱われる時、クライアントの性能を理解するために有益であり得る。もしもデータのキャッシングがさえぎられそうな場合、oplocksの使用は評価されるべきである。Sambaはすべての共有に対してoplocksを既定値で有効にする。サーバ上の共有データ、サーバネットワークの信頼性と各共有のoplocksの設定の使用法をクライアントに提供すべきであることに注意深く注意を払う。ミッションクリティカルな領域、高信頼性環境では、データの整合性はしばしば優先度が高くなる。複雑で高価な構成は、もしもクライアントがファイルサーバへの接続が切れた時、継続したデータの可用性を提供するために、フェイルオーバによるサーバ切り替えがすぐに出来ることが出来るように、実装される。</p><p><a class="indexterm" name="id2630869"></a><a class="indexterm" name="id2630877"></a>Windowsクライアントのフェイルオーバの動作は、確立しているTCP/IPトランスポートコネクションに依存するという理由で、他のプラットフォームよりもアプリケーションの中断のリスクがより大きい。もしも、ファイルサーバのフェールオーバとして接続が中断されたならば、新しいセッションは再度確立せねばならない。トランスポート層が切断された時から正しく復帰するためにプログラミングされているWindowsクライアントはまれである。そのため、ほとんどのアプリケーションは、ある種の中断を経験することになる。最悪の場合、アボートして再起動が必要となる。</p><p><a class="indexterm" name="id2630914"></a><a class="indexterm" name="id2630921"></a><a class="indexterm" name="id2630928"></a>もしもクライアントセッションが、oplocksのために、ローカルに書き込みと読み取りをキャッシングしているなら、TCPの中断からアプリケーションの再起動または復帰のときにデータが喪失するだろう。ファイルサーバが復旧すると、oplocksのブレークはクライアントには送信されない。この場合、先のセッションからの作業は失われる。oplocksが無効になっていて、リアルタイムにファイルサーバにクライアントがデータを書き込むというシナリオを観察することで、フェイルオーバは、切断時に存在するディスク上のデータを提供する。</p><p>ミッションクリティカルな、高可用性環境では、oplocksに対して厳重な注意をはらうべきである。理想的には、広範囲なテストは、oplocksが有効かつ無効な状態で、すべての影響されるアプリケーションで行うべきである。</p><div class="sect3" title="共有の排他的なアクセス"><div class="titlepage"><div><div><h4 class="title"><a name="id2630974"></a>共有の排他的なアクセス</h4></div></div></div><p>oplocksは、単一のユーザか、同時に1人のみのユーザで、排他的にアクセスされる共有に限定される時に最も有効である。oplocksの本当の姿は、ローカルにクライアントでキャッシングされているデータという理由により、キャッシングを中断する何らかの操作は遅延を引き起こす。</p><p>ホームディレクトリは、oplocksが問題ないと理解され、効率を得られる、最も明らかな例である。</p></div><div class="sect3" title="共有またはファイルに対する多重アクセス"><div class="titlepage"><div><div><h4 class="title"><a name="id2631002"></a>共有またはファイルに対する多重アクセス</h4></div></div></div><p>共有中のファイルへ各追加ユーザがoplocksを有効にしてアクセスすると、遅延の可能性と、結果として生じる性能の低下が増大する。複数のユーザが、oplocksを有効にした共有上のファイルにアクセスする時、oplocksブレークの送受信と、の管理と、データのオフセットをフラッシュするためにクライアントのキャッシングを他のクライアントが待つ間に結果として生じる遅延の管理の影響は、キャッシュしているユーザの効率向上を相殺する。</p><p>oplocksを設定して各追加のクライアントがファイルにアクセスする時、潜在的な効率の向上は否定され、最終的には効率のボトルネックとなる。</p></div><div class="sect3" title="UNIXまたはNFSクライアントがアクセスしたファイル"><div class="titlepage"><div><div><h4 class="title"><a name="id2631033"></a>UNIXまたはNFSクライアントがアクセスしたファイル</h4></div></div></div><p><a class="indexterm" name="id2631043"></a><a class="indexterm" name="id2631050"></a>ローカルのUNIXとNFSクライアントは強制的なファイルロックメカニズムなしでファイルにアクセスする。そのため、それらクライアントプラットフォームは、ファイルをキャッシュしているWindowsクライアントにサーバからのoplocksブレークを初期化できない。ローカルのUNIXかNFSファイルアクセスはこのため、データが壊れるようなファイルを公開している、Windowsクライアントによってキャッシュされたファイルに書き込める。</p><p>もしも、ファイルがWindows間とローカルUNIXかNFSユーザによって共有されているならば、oplocksはoffにする。</p></div><div class="sect3" title="遅くて信頼できないネットワーク"><div class="titlepage"><div><div><h4 class="title"><a name="id2631078"></a>遅くて信頼できないネットワーク</h4></div></div></div><p><a class="indexterm" name="id2631086"></a><a class="indexterm" name="id2631093"></a><a class="indexterm" name="id2631100"></a>クライアントサイドの読み取りと書き込みのキャッシングが、回線上でそれらの読み書きを送る上での大部分の差分を送る時に、oplocksが遭遇する性能向上の最も大きな可能性がある。これは、ネットワークがとても遅く、詰まっているか分散している(WAN中の場合)には、頻繁に起きる。しかし、ネットワークの遅延がoplocksメカニズムの信頼性に関して大きな影響があり、そのため、潜在的に知覚できる効率の向上を十二分に相殺するoplocks問題を発生する見込みを増大する。もちろん、もしもoplocksブレークが、決して送られる必要がなければ、これは、oplocksを利用する最も効率的なシナリオである。</p><p>もしもネットワークが遅いか、信頼性がないばあいか、WANの場合、もしも複数のユーザが同じファイルを定期的に開く事がある場合、決してoplocksを設定しないこと。</p></div><div class="sect3" title="マルチユーザデータベース"><div class="titlepage"><div><div><h4 class="title"><a name="id2631147"></a>マルチユーザデータベース</h4></div></div></div><p><a class="indexterm" name="id2631155"></a><a class="indexterm" name="id2631162"></a><a class="indexterm" name="id2631170"></a>マルチユーザデータベースは、その本質的な性質から、明らかに危険である。それらは通常不定間隔でたくさんのユーザによって激しくアクセスされる。oplocksが有効になっている共有上でマルチユーザデータベースを配置すると、Sambaサーバ上でのロッキング管理のボトルネックになるだろう。手作りあるいは所用製品のデータベースアプリケーションのどちらにせよ、共有のoplocksは無効にすること。</p></div><div class="sect3" title="PDM Data Shares"><div class="titlepage"><div><div><h4 class="title"><a name="id2631189"></a>PDM Data Shares</h4></div></div></div><p><a class="indexterm" name="id2631197"></a><a class="indexterm" name="id2631204"></a><a class="indexterm" name="id2631211"></a><a class="indexterm" name="id2631218"></a><a class="indexterm" name="id2631225"></a>IMAN、EnoviaやCleacaseのようなProcess data management (PDM)アプリケーションはWindowsクライアントプラットフォームでの使用が増え、そのため、SMBによるデータ格納も増えている。PDMアプリケーションは、重要なデータのセキュリティとアクセスのために、複数ユーザ環境を管理する。一般的なPDM環境では、必要に応じてローカルにロードするデータは、洗練されたクライアントデザインのアプリケーションに関連づけられる。更に追加で、PDMアプリケーションは通常各クライアントのデータ状態をモニタする。この場合、クライアントサイドのデータキャッシングは、ローカルのアプリケーションとPDMサーバで協調して保守するために、最も残される。任意のキャッシング作業からクライアントOSを、任意のoplocks管理から、共有上でoplocksを無効にすることによって取り除くことは適切である。</p></div><div class="sect3" title="Force Userに対する注意"><div class="titlepage"><div><div><h4 class="title"><a name="id2631265"></a>Force Userに対する注意</h4></div></div></div><p><a class="indexterm" name="id2631274"></a>Sambaには、<code class="filename">smb.conf</code>の変数によって定義されるどんなユーザにも、接続してきたユーザが共有にアクセスする時に、ユーザを変更する<a class="link" href="smb.conf.5.html#FORCEUSER" target="_top">force user</a>というパラメータを<code class="filename">smb.conf</code>中に含むことが出来る。もしもoplocksが共有上で有効になっている場合、ユーザアクセス中の変更は、ユーザが明示的にファイルをロードしなくとも、クライアントに送信するoplocksブレークを発生させる。ネットワークが遅いか信頼性がない場合、ファイルにアクセスしているユーザなしでoplocksブレークが失われることがある。これは、oplocksブレークの喪失を補うために、絶えず再接続するクライアントとして見た目の効率低下を引き起こす。</p><p>以下を組み合わせることを防ぐ:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>	<code class="filename">smb.conf</code>中の共有定義中の<a class="link" href="smb.conf.5.html#FORCEUSER" target="_top">force user</a> 。	</p></li><li class="listitem"><p>	遅いか信頼性のないネットワーク。	</p></li><li class="listitem"><p>	Oplocksが有効。	</p></li></ul></div></div><div class="sect3" title="高度なSamba Oplocksパラメータ"><div class="titlepage"><div><div><h4 class="title"><a name="id2631371"></a>高度なSamba Oplocksパラメータ</h4></div></div></div><p><a class="indexterm" name="id2631379"></a><a class="indexterm" name="id2631386"></a><a class="indexterm" name="id2631393"></a>Sambaはタイミングと使用レベルの計測のためにoplocksメカニズムの、種々のプロパティを管理者が調整できるoplocksパラメータを提供する。これらのパラメータは、問題を引き起こすような環境中でoplocksを実装するために、すぐれた融通性を提供する。パラメータは、<a class="link" href="smb.conf.5.html#OPLOCKBREAKWAITTIME" target="_top">oplock break wait time</a>と<a class="link" href="smb.conf.5.html#OPLOCKCONTENTIONLIMIT" target="_top">oplock contention limit</a>である。</p><p><a class="indexterm" name="id2631440"></a>ほとんどのユーザ、管理者と環境にとって、もしも、これらのパラメータが必要ならば、より良い選択肢は、単にoplocksをoffにすることである。Samba SWATでは、両パラメータについて、<span class="quote">“<span class="quote">Samba oplocksコードを読解しない限り、このパラメータを変更しないこと。</span>”</span>という説明がある。これは良い助言である。</p></div><div class="sect3" title="ミッションクリティカル、高信頼性"><div class="titlepage"><div><div><h4 class="title"><a name="id2631466"></a>ミッションクリティカル、高信頼性</h4></div></div></div><p>ミッションクリティカル、高信頼性を必要とする環境では、データの整合性がしばしば優先される。複雑で高価な構成は、もしもクライアントとファイルサーバへの接続が切れた時、フェイルオーバによる切り替えが、継続したデータの有効性を提供するためにすぐに行われるように実装される。</p><p>Windowsクライアントのフェイルオーバの動作は、確立したTCPトランスポート層の接続に依存しているために、他のプラットフォームよりアプリケーションの中断というリスクとなる。もしも、ファイルサーバのフェイルオーバで接続が中断されたならば、新しいセッションは確立されねばならない。トランスポート層の切断から正しく復帰するためにコードが書かれているWindowsアプリケーションはまれである。そのため、ほとんどのアプリケーションは、ある種の中断が生じることになる。最悪の場合、アボートして再起動が必要となる。</p><p>もしもクライアントセッションが、oplocksにより、ローカルに読み書きをキャッシュしているならば、TCPの中断からアプリケーションが再起動か復帰する時、データが失われるかもしれない。TCPの接続が失われた時、oplocksブレークはクライアントには送られない。この場合、以前のセッションからの作業は失われる。oplocksを無効にしてこのシナリオを観察すると、もしもクライアントがリアルタイムにファイルサーバにデータを書き込んでいたら、フェイルオーバはディスコネクト時に存在したディスク上のデータを提供するだろう。</p><p>ミッションクリティカル、高可用性を要求する環境では、oplocksの使用については厳重に注意を払う必要がある。理想的には、oplocksを有効/無効にした、すべての影響があるアプリケーションについて、広範囲なテストを行うべきである。</p></div></div></div><div class="sect1" title="SambaのOplocks制御"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2631558"></a>SambaのOplocks制御</h2></div></div></div><p>oplocsは、ユニークなWindowsファイルロッキング機能である。これは真のファイルロッキング機能ではないが、Windowsのファイルロッキングの多くの議論中に含まれ、そのため、事実上のロッキング機能として考えられる。oplocksは、実際の所、Windowsクライアントファイルキャッシング機能の一部である。これは、エンタープライズコンピューティング領域中に存在する、種々のカスタマイズされたネットワーク上で実装される時には、とりわけ丈夫か信頼性がある機能ではない。</p><p>SambaではWindowsと同様に、クライアント側のキャッシング機構であるoplockを、サーバ側のコンポーネントとして実装している。Windowsの機能設計上、oplock は軽量型として設定されている(機能が限定されている)。このためoplockを効果的に設定するには、これらの制限事項の把握が不可欠であり、またカスタマイズされたネットワークやクライアントの利用状況に特化したデータアクセスを構成する際の理解が行き届いている場合にのみ適用されるものである。</p><p>Oplocksの基本的な意味は、クライアントが、変更中にそのハードドライブ上にファイルをダウンロードし、キャッシュ出来るということである。もしも、2番目のクライアントがファイルにアクセスしようとした場合、最初のクライアントはブレークを受け取り、サーバに対して同期を取らねばならない。これは、ある場合においては、かなり効率が向上する。いくつかのプログラムは、単一の変更のためにサーバに対してファイルの内容すべてを戻して同期を取ることを行うものもある。</p><p>Level1 Oplocks(単に<span class="quote">“<span class="quote">oplocks</span>”</span>としても知られている)はopportunistic lockingの別の言い方である。</p><p>Level2 Oplocksは<span class="emphasis"><em>リードオンリ</em></span>として取り扱うファイルに対してopportunistic lockingを提供する。通常これはリードオンリか、クライアントが、ファイルのオープン時に、最初に書き込まないファイルに使われる。</p><p>Kernel OplocksはLinux kernelに、Microsoft Windowsネットワークファイルロッキングのより良い統合を提供するにも関わらず、Sambaがoplocksしたファイルとの共存を許可する基本的な方式である。SGI IRIXとLinuxは現時点でoplocksを認識するただ2つのOSである。</p><p>使用しているシステムがkernel oplocksをサポートしている限り、UNIX/LinuxとSMBクライアントの両方から同じファイルをアクセスする時、oplocksを無効にすべきである。もしも、複数のクライアントからデータベースファイルを共有している時(たとえば、Microsoft Access)、顕著なパフォーマンスダウンと、さらに、最初の場所におけるデータベースのアクセス問題が発生する、ファイル全体(1つのレコードではなく)の同期に影響する、最初のクライアントが受け取る任意のブレークという理由で、oplocksは気にせず常時無効にすべきである。特に、Microsoft Outlookのパーソナルフォルダ(*.pst)はoplocksに対してとてもひどく反応する。疑っているのならば、oplocksを無効にして、その辞典からシステムを調整してみると良いだろう。</p><p>もしもクライアントサイドのキャッシングが無効で、ネットワークの信頼性があるのであれば、oplocksをonにすることで利点が得られる。もしも、使用しているネットワークが遅くて、信頼性がないか､他のファイル共有方式(たとえばNFS)との間でファイルを共有しているか、WAN経由の場合か、頻繁に同一ファイルを複数の人がアクセスする場合、クライアントがoplocksブレークを送るオーバヘッドからの利益を得られず、そのかわりに共有に対してoplocksを無効にしたいと思うだろう。</p><p>考慮すべき他の要素は、ファイルアクセスの認識されたパフォーマンスである。もしもoplocksが使用するネットワーク上で、わかるほどのスピード向上を提供しない場合、それを取り扱う難しさ分の価値がないかもしれない。</p><div class="sect2" title="設定例"><div class="titlepage"><div><div><h3 class="title"><a name="id2631746"></a>設定例</h3></div></div></div><p>以下の節では、Sambaロッキングの制御に関する2つの異なった側面について評価する。</p><div class="sect3" title="oplocksを無効にする"><div class="titlepage"><div><div><h4 class="title"><a name="id2631759"></a>oplocksを無効にする</h4></div></div></div><p>以下のようにして、共有単位でoplocksを無効にすることが出来る:</p><p></p><table border="0" summary="Simple list" class="simplelist"><tr><td> </td></tr><tr><td><em class="parameter"><code>[acctdata]</code></em></td></tr><tr><td><a class="indexterm" name="id2631788"></a><em class="parameter"><code>oplocks = False</code></em></td></tr><tr><td><a class="indexterm" name="id2631800"></a><em class="parameter"><code>level2 oplocks = False</code></em></td></tr></table><p></p><p>既定値のoplocksタイプはLevel1である。Level2 oplocksは<code class="filename">smb.conf</code>ファイル中で、共有単位に有効に出来る。</p><p>代わりに、以下のようにして、共有内でファイル単位にoplocksを無効に出来る:</p><p>	</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2631839"></a><em class="parameter"><code>veto oplock files = /*.mdb/*.MDB/*.dbf/*.DBF/</code></em></td></tr></table><p></p><p>もしも、Sambaのログエントリから確認出来る、oplocksの問題に遭遇した場合、安全を期すために、oplocksとLevel2 oplocksを無効にしても良い。</p></div><div class="sect3" title="Kernel oplocksを無効にする"><div class="titlepage"><div><div><h4 class="title"><a name="id2631863"></a>Kernel oplocksを無効にする</h4></div></div></div><p>Kernel oplocks は、キャッシュされているファイルをUNIXプロセスがオープンしようとする時に、(もしもUNIX kernelがWindowsクライアントに対してoplocksを送信する機能がある時)Sambaに対して通知する<code class="filename">smb.conf</code>パラメータである。このパラメータはUNIXと、Sambaサーバ上でoplocksが有効になっているWindows間で共有するファイルをアドレスする。UNIXプロセスはWindowsクライアントによってoplockedされた(キャッシュされた)ファイルを開くことが出来、ファイルがデータ破壊のリスクがあるという事を伝える、oplocksブレークをsmbdプロセスは送らない。もしもUNIX kernelがoplockブレークを送る機能があるならば、kenel oplocksパラメータは、Sambaにoplockブレークを送ることを有効にする。kernel oplocksは、<code class="filename">smb.conf</code>ファイル中でサーバ単位に有効に出来る。</p><p></p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2631922"></a><em class="parameter"><code>kernel oplocks = yes</code></em></td></tr></table><p>既定値はnoである。</p><p><span class="emphasis"><em>Veto oplocks</em></span>は、oplocksが無効になる特定のファイルを識別するための、<code class="filename">smb.conf</code>パラメータである。veto oplocksに設定されているファイルをWindowsクライアントがオープンする時、クライアントはoplocksが許可されず、すべての操作はクライアント上にキャッシュされたファイルのコピーの代わりにディスク上のオリジナルのファイル上で実行される。UNIXプロセスとoplocksを無効にしたそれらファイルとの間で共有されるファイルを明示的に識別することで、サーバ全体でのoplocks設定が、データ破壊のリスクがない、ファイルのキャッシングという効率の向上を、Windowsクライアントが利用できることを有効にできる。veto oplocksは、以下の<a class="link" href="locking.html#far1" title="Example 17.1. いくつかのファイルがoplocksされた共有">“いくつかのファイルがoplocksされた共有”</a>で示されるような、<code class="filename">smb.conf</code>中で、共有単位か、サーバ全体で有効に出来る。</p><p></p><div class="example"><a name="far1"></a><p class="title"><b>Example 17.1. いくつかのファイルがoplocksされた共有</b></p><div class="example-contents"><table border="0" summary="Simple list" class="simplelist"><tr><td> </td></tr><tr><td><em class="parameter"><code>[global]</code></em></td></tr><tr><td><a class="indexterm" name="id2632011"></a><em class="parameter"><code>veto oplock files = /filename.htm/*.txt/</code></em></td></tr><tr><td> </td></tr><tr><td><em class="parameter"><code>[share_name]</code></em></td></tr><tr><td><a class="indexterm" name="id2632033"></a><em class="parameter"><code>veto oplock files = /*.exe/filename.ext/</code></em></td></tr></table></div></div><p><br class="example-break"></p><p><a class="link" href="smb.conf.5.html#OPLOCKBREAKWAITTIME" target="_top">oplock break wait time</a>は、<code class="filename">smb.conf</code>中のパラメータで、oplockブレーク要求をSambaが繰り返す時間感覚を調整する。Sambaは<span class="quote">“<span class="quote">Sambaのoplocksコードを読んで理解しない限りこのパラメータを変更しないこと</span>”</span>と忠告している。oplock break wait timeは、以下のように、<code class="filename">smb.conf</code>中でグローバルな形でのみ設定できる。</p><p>	</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2632094"></a><em class="parameter"><code>oplock break wait time =  0 (default)</code></em></td></tr></table><p></p><p><span class="emphasis"><em>Oplock break contention limit</em></span>は、<code class="filename">smb.conf</code>中のパラメータで、パラメータによって指定された制限に、設定された数多くの競合するクライアントが到達する場合、 oplockを許可するためのSambaサーバのレスポンスを制限する。Sambaは<span class="quote">“<span class="quote">Sambaのoplocksコードを読んで理解しない限りこのパラメータを変更しないこと</span>”</span>と忠告している。oplock break contention limitは、<a class="link" href="locking.html#far3" title="Example 17.2. Oplock Break Contention Limitの設定">“Oplock Break Contention Limitの設定”</a>のように、<code class="filename">smb.conf</code>中で共有単位あるいはグローバルにサーバ全体で有効に出来る。</p><p></p><div class="example"><a name="far3"></a><p class="title"><b>Example 17.2. Oplock Break Contention Limitの設定</b></p><div class="example-contents"><table border="0" summary="Simple list" class="simplelist"><tr><td> </td></tr><tr><td><em class="parameter"><code>[global]</code></em></td></tr><tr><td><a class="indexterm" name="id2632173"></a><em class="parameter"><code>oplock break contention limit =  2 (default)</code></em></td></tr><tr><td> </td></tr><tr><td><em class="parameter"><code>[share_name]</code></em></td></tr><tr><td><a class="indexterm" name="id2632195"></a><em class="parameter"><code>oplock break contention limit =  2 (default)</code></em></td></tr></table></div></div><p><br class="example-break"></p></div></div></div><div class="sect1" title="Microsoft Windowsのoplocksとキャッシュ制御"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2632213"></a>Microsoft Windowsのoplocksとキャッシュ制御</h2></div></div></div><p>ネットワーク経由で共有データベースにアクセスする任意のアプリケーションに影響しうるWindows 2000/XPワークステーション上でアプリケーション(Norton Antivirusのような)を動かす時によく知られている問題がある。これは、Windows 2000/XP OSの既定値の設定の結果によるものである。他の 2000/XPコンピュータ上の共有データベースファイルに、ワークステーションがアクセスする時、Windows 2000/XP OSは、ファイルをロックし、情報をローカルにキャッシュすることで効率を向上することを試みる。これが起きると、アプリケーションは、ネットワーク操作中、<span class="quote">“<span class="quote">アクセスが拒否されました</span>”</span>というエラーが表示されて適切に動作しなくなる。</p><p>データファイル(データファイルがそこに格納されて、他のWindows PCによってアクセスされるという意味で)のためのデータベースサーバとして振る舞う、NTファミリの、すべてのWindows OSは、データファイルの破損を防ぐリスクを最小限にするために、oplocksを無効にする必要があるかもしれない。これには、Windows 9x/Me、Windows NT、Windows 200xとWindows XPが含まれる。<sup>[<a name="id2632266" href="#ftn.id2632266" class="footnote">5</a>]</sup></p><p>もしも、サーバの代わりにWindows NTファミリのワークステーションを使っているならば、そのワークステーション上でoplocksを無効にしなければならない。例えば、もしも、Windows NT サーバの代わりにWindows NT ワークステーションをPC上で使っていて、その上に、他のWindows PCからアクセスされるデータファイルがあるならば、そのシステム上でoplocksを無効にしなければならないかもしれない。</p><p>大きな違いは、oplocksを無効にするための値を入れるWindowsレジストリの位置である。LanManServerの位置の代わりにLanManWorkstationの位置が使われる。</p><p>Windowsレジストリエディタを使ってこのレジストリの値を検査(必要に応じて変更か追加)することができる。このレジストリ値を変更する時、新しい設定を反映させるために、PCを再起動しなければならない。</p><p>oplocksのためのクライアントレジストリエントリの位置は、Microsoft Windows NTよりも前の位置から、Windows 2000では変わっている。</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Windows 2000 は、以前のWindows中でoplocksを無効にするために使うEnableOplocksレジストリエントリを引き続き使用している。</p></div><p>以下のレジストリエントリを変更することによって、oplocksの許可を拒否することも出来る:</p><p></p><pre class="programlisting">	HKEY_LOCAL_MACHINE\System\		CurrentControlSet\Services\MRXSmb\Parameters\		OplocksDisabled REG_DWORD 0 又は 1		既定値: 0 (無効になっていない)</pre><p></p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>OplocksDisabledというレジストリエントリ値は、リモートファイル上のoplocksの要求のあるなしをWindowsクライアント上で設定する。oplocksを無効にするためには、OplocksDisabledの値は1に設定しなければならない。</p></div><p></p><pre class="programlisting">	HKEY_LOCAL_MACHINE\System\		CurrentControlSet\Services\LanmanServer\Parameters		EnableOplocks REG_DWORD 0 又は 1		既定値: 1 (既定値で有効)		EnableOpLockForceClose REG_DWORD 0 又は 1		既定値: 0 (既定値で無効)</pre><p></p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>EnableOplocksという値はWindowsベースのサーバ(ファイルを共有しているワークステーションを含む)で、ローカルファイル上のoplocksを許可/拒否することを設定する。</p></div><p>クローズまたはプログラム終了時でオープンしているoplocksを強制的に終了するためには、EnableOpLockForceCloseを1に設定しなければならない。</p><p>Level2 oplocksの動作概要は以下の通り:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>	ステーション1がoplockを要求してファイルを開く。	</p></li><li class="listitem"><p>	他のどのステーションもファイルを開かない間、サーバはステーション1に排他的oplockを許可する。	</p></li><li class="listitem"><p>	ステーション2がoplockを要求してファイルを開く。	</p></li><li class="listitem"><p>	ステーション1がまだファイルを書き込んでいないなら、サーバはステーション1にレベル2の	oplockのブレーク通知を行う。	</p></li><li class="listitem"><p>	ステーション1はローカルにバッファした情報をサーバに書き戻す。	</p></li><li class="listitem"><p>	ステーション1はレベル2のoplockを素unしたサーバに情報を送る(代わりにステーション1は	ファイルをクローズすることが出来たはずである)。	</p></li><li class="listitem"><p>	サーバはステーション2のオープン要求に対応し、レベル2のoplockを許可する。	その他のステーションは同じくファイルを開くことが出来、同様にレベル2のoplockが	許可される。	</p></li><li class="listitem"><p>	ステーション2(か、ファイルをオープンしている他のステーション)はSMB書き込み要求を	送る。サーバは書き込み応答を返す。	</p></li><li class="listitem"><p>	サーバは、ファイルをオープンしているすべてのステーションに対して、ロックを	壊さないこと、すなわちファイルに対して oplock を保持しているステーションが	ないことを確認する。この時点で、ワークステーションはキャッシュされた	書き込みもロックも保持していないため、break-to-none 勧告に対して応答する	必要がないからである。それぞれのワークステーションは、単にローカルで	キャッシュしている先読みデータを無効にするだけでよい。	</p></li></ul></div><div class="sect2" title="ワークステーションサービスのエントリ"><div class="titlepage"><div><div><h3 class="title"><a name="id2632510"></a>ワークステーションサービスのエントリ</h3></div></div></div><pre class="programlisting">	\HKEY_LOCAL_MACHINE\System\		CurrentControlSet\Services\LanmanWorkstation\Parameters	UseOpportunisticLocking   REG_DWORD   0 又は 1	既定値: 1 (真)</pre><p>これは、リダイレクタがoplockの効率向上機能を使うかどうかを指示する。このパラメータは問題を判別するためにのみ無効にすべきである。</p></div><div class="sect2" title="サーバサービスのエントリ"><div class="titlepage"><div><div><h3 class="title"><a name="id2632539"></a>サーバサービスのエントリ</h3></div></div></div><pre class="programlisting">	\HKEY_LOCAL_MACHINE\System\		CurrentControlSet\Services\LanmanServer\Parameters	EnableOplocks   REG_DWORD   0 又は 1	既定値: 1 (真)</pre><p>これは、サーバが、ファイルにoplocksを使うことをクライアントに対して許可するかどうかを指定する。oplocksは明確に効率を向上させるが、特にWANのような、ある種のネットワーク上でキャッシュされたデータを失う可能性がある。</p><pre class="programlisting">	MinLinkThroughput   REG_DWORD   0 は秒あたり無限のバイト量	既定値: 0</pre><p>これは、この接続のための、生の(raw) I/Oとoplocksを無効にする前に、サーバによって許可される最小のリンクスループットを指定する。</p><pre class="programlisting">	MaxLinkDelay   REG_DWORD   0 から 10万秒	既定値: 60</pre><p>これは、リンクのディレイで許される最小限の時間を指定する。もしもこの値よりも遅延が大きい場合、サーバは生の(raw)I/Oとoplocksを、この接続では無効にする。</p><pre class="programlisting">	OplockBreakWait   REG_DWORD   10 から 180 秒	既定値: 35</pre><p>これは、oplockブレーク要求に対してクライアントが返答するまで、サーバが待つ時間を指定する。より小さな値はより速やかにクラッシュしたクライアントを検出できるが、キャッシュしたデータを失う可能性がある。</p></div></div><div class="sect1" title="持続的なデータ破壊"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2632634"></a>持続的なデータ破壊</h2></div></div></div><p>もしもこの章で議論されている設定のすべてを適用したが、データの破壊問題と他の症状が持続しているのであれば、追加して監視するものがある。</p><p>単独の欠陥があるネットワークカードのような、欠陥があるネットワークハードウェアについて、開発者から信用できる報告を受けていることが、読み取りキャッシングとデータ破壊に類似している兆候を引き起こす。もしも、繰り返しインデックスした後にもかかわらす、持続的なデータ破壊が起きているならば、問い合わせ中でデータファイルの再構築をしなければならないかもしれない。これは、リビルドするようなのと同じいくつかの定義で新しいデータファイルを作成することを改善し、古いファイルから新しいファイルにデータを転送する。Samba知識ベース中で見つけることが出来る、これを行う、いくつかの手法がある。</p></div><div class="sect1" title="よくあるエラー"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2632683"></a>よくあるエラー</h2></div></div></div><p>サーバをインストールするやいなや、問題が表面化するサイトがある。他のサイト内では長い間問題が表面化していない。例外を除いてほとんど、問題が表面化したとき、当惑と、潜在的なデータ破壊を引き起こすだろう。</p><p>過去数年の間、Sambaがデータ破壊を引き起こすというクレームの、数多くの不満が、Sambaメーリングリスト上に投稿されてきた。3つの原因が認識されてきた:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>	不正なoplocksの設定(アプリが使うものとの非互換)。これは、Microsoft Windows NT4か	Microsoft Windows 200xベースで使っているサーバでも共通の問題である。ソフトウェア	アプリケーションベンダのファイルロッキングに関する設定手順に急いで従うべきである。	もしも疑うのであれば、サーバとクライアント両方でoplocksを無効にする。Microsoft	Windowsクライアント上でキャッシングするすべての形式のファイルを無効にすることも	必要かもしれない。	</p></li><li class="listitem"><p>	不完全なネットワークカード、ケーブル、あるいはハブ/スイッチ。これは、一般的に	低コストネットワークハードウェアにおける一般的な事項であるが、より高級なハード	ウェアにおける非互換性の問題も時折ある。	</p></li><li class="listitem"><p>	データファイルを書く時にSambaのログファイルに時折痕跡が残ることがある。これは、	ごく少数のサイトで報告されていて(過去3年でおおよそ5つ)、すべての再現試験は	失敗した。Sambaチームはこの現象を捕まえられず、そのため、何らかの特定の現象と	して分離できていない。Sambaを使う非常に数多くのシステムがあることを考えると、	Sambaチームと同様に、これに影響を受けたサイトにとって、これはいらいらする、	やっかいな難問である。もしも、このタイプの現象に遭遇したならば、遅滞なく、	Sambaの<a class="ulink" href="https://bugzilla.samba.org" target="_top">Bugzilla</a>にバグレポートを	投稿してほしい。可能な限りのたくさんの情報をもらえると、現象の特定の手助けと、	(問題の特定と修正のための基本的なステップである)問題の再現の手助けになる。	</p></li></ul></div><div class="sect2" title="locking.tdb のエラーメッセージ"><div class="titlepage"><div><div><h3 class="title"><a name="id2632783"></a>locking.tdb のエラーメッセージ</h3></div></div></div><p>		<span class="quote">“<span class="quote">			以下のようなたくさんのエラーメッセージがSambaのログ中にある:		</span>”</span></p><pre class="programlisting">tdb(/usr/local/samba_2.2.7/var/locks/locking.tdb): rec_read bad magic 0x4d6f4b61 at offset=36116</pre><p>		<span class="quote">“<span class="quote">			これは何を意味するのか?		</span>”</span>	</p><p>	このエラーはtdbファイルが壊れていることを表示している。smbdのすべてのプロセスを停止し、	locking.tdbを削除してsmbdを再起動する。	</p></div><div class="sect2" title="Windows XP上でのMicrosoft Officeファイルセーブ時の問題"><div class="titlepage"><div><div><h3 class="title"><a name="id2632822"></a>Windows XP上でのMicrosoft Officeファイルセーブ時の問題</h3></div></div></div><a class="indexterm" name="id2632830"></a><p>これはWindows XPのバグである。より詳細な情報は、		<a class="ulink" href="http://support.microsoft.com/?id=812937" target="_top">Microsoft KBの記事812937</a>		を参照のこと。</p></div><div class="sect2" title="XP SP1でネットワーク経由でファイルを消すのに長い時間がかかる"><div class="titlepage"><div><div><h3 class="title"><a name="id2632850"></a>XP SP1でネットワーク経由でファイルを消すのに長い時間がかかる</h3></div></div></div><p><span class="quote">“<span class="quote">XP SP1を適用語、ネットワーク経由でファイルを消すのに、時々おおよそ35秒もかかる。</span>”</span></p><a class="indexterm" name="id2632867"></a><p>これはWindows XPのバグである。より詳しい情報は、		<a class="ulink" href="http://support.microsoft.com/?id=811492" target="_top">Microsoft KBの記事</a>		を参照のこと。</p></div></div><div class="sect1" title="参考文献"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2632888"></a>参考文献</h2></div></div></div><p>Microsoftの<a class="ulink" href="http://support.microsoft.com/" target="_top">サポート</a>webサイトで、ファイルとレコードのロッキングに関する更新された文書をチェックしても良いだろう。追加で、Sambaの<a class="ulink" href="http://www.samba.org/" target="_top">web</a>サイトで、<code class="literal">locking</code>という単語を探しても良いだろう。</p><p>Microsoft MSDNライブラリ上にある opportunistic locking 節は以下の通り:</p><p><a class="indexterm" name="id2632930"></a>Microsoft KB, <span class="quote">“<span class="quote">OPLOCKS によるトランザクションの整合性を維持</span>”</span>,Microsoft Corporation, April 1999, <a class="ulink" href="http://support.microsoft.com/kb/224992/ja" target="_top">MicrosoftKB の記事 224992(訳注:機械翻訳)</a>.</p><p><a class="indexterm" name="id2632957"></a>Microsoft KB, <span class="quote">“<span class="quote">Windows で Opportunistic Lock を構成する</span>”</span>,Microsoft Corporation, April 2001 <a class="ulink" href="http://support.microsoft.com/kb/296264/ja" target="_top">Microsoft KB の記事 296264</a>.</p><p><a class="indexterm" name="id2632982"></a>Microsoft KB, <span class="quote">“<span class="quote">PC Ext: Windows NT の Opportunistic Locking の説明</span>”</span>,Microsoft Corporation, April 1995 <a class="ulink" href="http://support.microsoft.com/kb/129202/ja" target="_top">MicrosoftKB の記事 129202</a>.</p></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.id2632266" href="#id2632266" class="para">5</a>] </sup>Microsoftはこの件について KB 300216で解説している。</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="AccessControls.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="optional.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="securing-samba.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 16. ファイル、ディレクトリと共有のアクセス制御 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 18. Securing Samba</td></tr></table></div></body></html>