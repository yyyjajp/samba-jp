<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Chapter 19. ドメイン間の信頼関係</title><link rel="stylesheet" href="../samba.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="公式のSamba 3.2.x HOWTOとリファレンスガイド"><link rel="up" href="optional.html" title="Part III. 詳細な設定方法"><link rel="prev" href="securing-samba.html" title="Chapter 18. Securing Samba"><link rel="next" href="msdfs.html" title="Chapter 20. Microsoft 分散ファイルシステムツリーのホスティング"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 19. ドメイン間の信頼関係</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="securing-samba.html">Prev</a> </td><th width="60%" align="center">Part III. 詳細な設定方法</th><td width="20%" align="right"> <a accesskey="n" href="msdfs.html">Next</a></td></tr></table><hr></div><div class="chapter" title="Chapter 19. ドメイン間の信頼関係"><div class="titlepage"><div><div><h2 class="title"><a name="InterdomainTrusts"></a>Chapter 19. ドメイン間の信頼関係</h2></div><div><div class="author"><h3 class="author"><span class="firstname">John</span> <span class="othername">H.</span> <span class="surname">Terpstra</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jht@samba.org">jht@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Rafal</span> <span class="surname">Szczesniak</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:mimir@samba.org">mimir@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Jelmer</span> <span class="othername">R.</span> <span class="surname">Vernooij</span></h3><span class="contrib">drawing</span> <div class="affiliation"><span class="orgname">The Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jelmer@samba.org">jelmer@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Stephen</span> <span class="surname">Langasek</span></h3><div class="affiliation"><div class="address"><p><code class="email"><<a class="email" href="mailto:vorlon@netexpress.net">vorlon@netexpress.net</a>></code></p></div></div></div></div><div><p class="pubdate">April 3, 2003</p></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="InterdomainTrusts.html#id2634999">機能と利便性</a></span></dt><dt><span class="sect1"><a href="InterdomainTrusts.html#id2635078">信頼関係に関する背景情報</a></span></dt><dt><span class="sect1"><a href="InterdomainTrusts.html#id2635404">ネイティブなMicrosoft Windows NT4の信頼関係の設定</a></span></dt><dd><dl><dt><span class="sect2"><a href="InterdomainTrusts.html#id2635447">NT4ドメイン信頼関係の作成</a></span></dt><dt><span class="sect2"><a href="InterdomainTrusts.html#id2635558">NT4ドメイン信頼関係の構築完了</a></span></dt><dt><span class="sect2"><a href="InterdomainTrusts.html#id2635652">ドメイン間信頼関係の機能</a></span></dt></dl></dd><dt><span class="sect1"><a href="InterdomainTrusts.html#id2635902">SambaにおけるNT形式のドメイン信頼関係の設定</a></span></dt><dd><dl><dt><span class="sect2"><a href="InterdomainTrusts.html#samba-trusted-domain">信頼されるドメインとしてのSamba</a></span></dt><dt><span class="sect2"><a href="InterdomainTrusts.html#id2636296">信頼するドメインとしてのSamba</a></span></dt></dl></dd><dt><span class="sect1"><a href="InterdomainTrusts.html#id2636523">Windows 2000との間での、NT4形式のドメイン信頼関係</a></span></dt><dt><span class="sect1"><a href="InterdomainTrusts.html#id2636704">よくあるエラー</a></span></dt><dd><dl><dt><span class="sect2"><a href="InterdomainTrusts.html#id2636723">信頼されるドメインからのブラウジングに失敗する</a></span></dt><dt><span class="sect2"><a href="InterdomainTrusts.html#id2636795">LDAP ldapsamと古いバージョンのsmbldap-toolsに関する問題</a></span></dt></dl></dd></dl></div><p><a class="indexterm" name="id2634764"></a><a class="indexterm" name="id2634771"></a><a class="indexterm" name="id2634778"></a><a class="indexterm" name="id2634785"></a><a class="indexterm" name="id2634793"></a><a class="indexterm" name="id2634800"></a><a class="indexterm" name="id2634807"></a><a class="indexterm" name="id2634814"></a><a class="indexterm" name="id2634820"></a>Samba-3はNT4形式のドメイン信頼関係をサポートする。NT4形式のドメインからSamba-3に移行したいが、Active Directory やLDAPベースの認証バックエンドを採用したくないという多くのサイトが使用したいと思う機能である。この章では、信頼関係に関する背景情報と信頼関係の作成方法を説明する。Samba-3はNT4を信頼することができ(その逆も可)、またSamba対Sambaの信頼を作成することも可能である。</p><p><a class="indexterm" name="id2634841"></a><a class="indexterm" name="id2634848"></a><a class="indexterm" name="id2634855"></a><a class="indexterm" name="id2634862"></a><a class="indexterm" name="id2634869"></a>ドメイン間の信頼関係を使う場合、<code class="literal">winbind</code>を使うことが必要であるので、<code class="literal">winbindd</code>が動いていなければならない。このモードにおけるwinbindの動作は、<code class="filename">smb.conf</code>ファイル中の有効なUIDレンジと有効なGIDレンジの指定に依存する。これらは以下のように指定する:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2634905"></a><em class="parameter"><code>idmap uid = 10000-20000</code></em></td></tr><tr><td><a class="indexterm" name="id2634917"></a><em class="parameter"><code>idmap gid = 10000-20000</code></em></td></tr></table><p><a class="indexterm" name="id2634928"></a><a class="indexterm" name="id2634936"></a><a class="indexterm" name="id2634944"></a><a class="indexterm" name="id2634950"></a>指定されたレンジの値はホストOSで使っている値とPOSIXユーザアカウント用のpassdbバックエンドで使っている値を上書きしてはならない。最大値はホストOSによって許可されている上限の値で制限される。これはUNIXカーネルで制限されるパラメータである。Linux kernel2.6ベースのシステムは最大値として4294967295(符号なし32ビット値)である。</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><a class="indexterm" name="id2634972"></a><a class="indexterm" name="id2634978"></a><a class="indexterm" name="id2634986"></a>winbindを使用するのはSambaが信頼しているドメインの時のみであり、信頼されたドメインの時には不要である。</p></div><div class="sect1" title="機能と利便性"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2634999"></a>機能と利便性</h2></div></div></div><p><a class="indexterm" name="id2635007"></a><a class="indexterm" name="id2635014"></a>Samba-3はSambaとMicrosoft Windows NT4形式と同じようにSamba間の信頼関係に参加できる。これは、Microsoft Windows NT4と同様な拡張性をSambaに付与する。</p><p><a class="indexterm" name="id2635030"></a><a class="indexterm" name="id2635038"></a><a class="indexterm" name="id2635045"></a><a class="indexterm" name="id2635051"></a><a class="indexterm" name="id2635058"></a>Samaba-3はLDAPのような拡張性のあるバックエンド認証データベースと共に動作でき、プライマリ及びバックアップドメイン管理モードで動作できるので、管理者はドメイン間の信頼関係を使用する代わりの選択肢を考慮するべきである。なぜならば、この機能はその動作原理からして、本質的に脆弱なものだからである。このことこそが、Microsoft Active Directory が開発され採用される主な理由でもある。</p></div><div class="sect1" title="信頼関係に関する背景情報"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2635078"></a>信頼関係に関する背景情報</h2></div></div></div><p><a class="indexterm" name="id2635086"></a><a class="indexterm" name="id2635093"></a><a class="indexterm" name="id2635100"></a><a class="indexterm" name="id2635107"></a><a class="indexterm" name="id2635114"></a><a class="indexterm" name="id2635121"></a>MS Windows NT3/4形式のセキュリティドメインは、階層がないセキュリティ構造を採用している。この構造の制約が、大規模な組織では Microsoft Windows ネットワークの拡張性に影響を与えることはよく知られている。さらに、この設計の結果であるフラットな名前空間は、大規模で多様性に富む組織における管理責務の代行に多大な影響を及ぼす。</p><p><a class="indexterm" name="id2635142"></a><a class="indexterm" name="id2635148"></a><a class="indexterm" name="id2635155"></a><a class="indexterm" name="id2635162"></a><a class="indexterm" name="id2635169"></a>Microsoft は、古いテクノロジーの制約を回避するために、Active Directory Service(ADS)を、Kerberos及びLDAPをベースとして開発した。しかし全ての組織が ADSを採用する準備ができ、その意思があるわけではない。小規模の組織にとっては古い NT形式のドメインセキュリティで充分である。また、ADS を採用するために面倒な変更作業を行うことを望まない保守的なユーザも残っている。</p><p><a class="indexterm" name="id2635189"></a><a class="indexterm" name="id2635196"></a><a class="indexterm" name="id2635204"></a><a class="indexterm" name="id2635210"></a><a class="indexterm" name="id2635217"></a><a class="indexterm" name="id2635224"></a><a class="indexterm" name="id2635231"></a>Microsoft Windows NTで、Microsoft はあるドメインのユーザが、別のドメインのアクセス権や他の権限を付与されるような機構を実現するため、多様なセキュリティドメインの存在を可能にする機能を導入した。この機能を<span class="emphasis"><em>信頼(Trusts)</em></span>という言葉で言い表わす。具体的には、あるドメインが別のドメインのユーザを<span class="emphasis"><em>信頼する</em></span>ということである。あるドメインのユーザが別のセキュリティドメインのユーザになれる時、そのようなドメインを信頼される(trusted)ドメインと言う。そのようなユーザに権利や権限を与えた方のドメインは信頼する(trusting) ドメインと言う。NT3.x/4.0 では信頼関係は一方向のみである。そのため双方のドメインのユーザが他方のドメインで権限と権利を持とうとする場合には、それぞれの方向に一つずつ、二つの信頼関係を設定する必要がある。</p><p><a class="indexterm" name="id2635281"></a><a class="indexterm" name="id2635288"></a><a class="indexterm" name="id2635295"></a><a class="indexterm" name="id2635302"></a><a class="indexterm" name="id2635309"></a>NT4形式のMicrosoft セキュリティドメインでは、全ての信頼は非推移的である。この意味は、例えば三つのドメインがあり(仮に赤、白、青とする)、その赤と白が信頼関係を持ち、また白と青が信頼関係を持つとする。この場合、赤と青のドメインの間に暗黙に了解された信頼関係を持つわけではない。関係は明示的でなければならず、推移的ではない。</p><p><a class="indexterm" name="id2635329"></a><a class="indexterm" name="id2635336"></a><a class="indexterm" name="id2635343"></a><a class="indexterm" name="id2635350"></a><a class="indexterm" name="id2635357"></a><a class="indexterm" name="id2635364"></a><a class="indexterm" name="id2635371"></a>Microsoft Windows 2000から登場した新たなADSセキュリティの方式では、信頼関係は既定値で双方向になっている。また、全てのADSドメイン間の信頼は推移的である。上の赤、白、青ドメインの例では、Windows 2000及びADSを使用する場合、赤と青ドメインは互いに信頼できる。これはADSドメインの本質的な特長である。Samba-3 はMicrosoft Windows NT4方式のドメイン間信頼機能を実装し、Microsoft Windows NT4方式のドメインと類似した方法で、Microsoft Windows 200x ADS セキュリティドメインとの相互運用を実現している。</p></div><div class="sect1" title="ネイティブなMicrosoft Windows NT4の信頼関係の設定"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2635404"></a>ネイティブなMicrosoft Windows NT4の信頼関係の設定</h2></div></div></div><p><a class="indexterm" name="id2635413"></a><a class="indexterm" name="id2635422"></a><a class="indexterm" name="id2635429"></a>ドメイン間信頼関係を作成するには二つのステップがある。双方向の信頼関係を有効にするためには、双方のドメイン管理者が相手のドメインのために信頼アカウントを作成し、セキュリティに関する信用情報を確認する際に使用できるようにしなければならない。</p><div class="sect2" title="NT4ドメイン信頼関係の作成"><div class="titlepage"><div><div><h3 class="title"><a name="id2635447"></a>NT4ドメイン信頼関係の作成</h3></div></div></div><p><a class="indexterm" name="id2635456"></a><a class="indexterm" name="id2635463"></a><a class="indexterm" name="id2635470"></a><a class="indexterm" name="id2635477"></a><a class="indexterm" name="id2635484"></a>Microsoft Windows NT4では、全てのドメインの信頼関係は<span class="application">ドメインユーザーマネジャ</span>を使って設定する。これは、メニューバーのドメインユーザーマネジャーポリシーのエントリから行う。<span class="guimenu">ポリシー</span>メニューから<span class="guimenuitem">信頼関係</span>を選択する。<span class="guimenuitem">信頼する側のドメイン</span>と記された低い方のボックスの隣に二つのボタンがある。 <span class="guibutton">追加</span>と<span class="guibutton">削除</span>である。<span class="guibutton">追加</span>ボタンは、自ドメイン内のユーザにアクセス権限を付与することができるリモートドメイン名を入力するパネルを開く。また、信頼するドメインが信頼されるドメインのユーザを認証するときに使用する、信頼関係のパスワードも入力する必要がある。パスワードは(標準的な確認の手続きとして)二度入力しなければならない。</p></div><div class="sect2" title="NT4ドメイン信頼関係の構築完了"><div class="titlepage"><div><div><h3 class="title"><a name="id2635558"></a>NT4ドメイン信頼関係の構築完了</h3></div></div></div><p><a class="indexterm" name="id2635567"></a><a class="indexterm" name="id2635574"></a><a class="indexterm" name="id2635581"></a><a class="indexterm" name="id2635588"></a><a class="indexterm" name="id2635595"></a><a class="indexterm" name="id2635603"></a>信頼関係は、もう一方のドメイン(信頼するドメイン)が信頼されるドメインと適切に接続された場合のみ動作する。信頼関係を完成するためには、管理者はまず、ドメインユーザーマネジャを起動し、メニューから<span class="guilabel">ポリシー</span>を選択し、それから<span class="guilabel">信頼関係</span>を選択し、<span class="guilabel">信頼される側のドメイン</span>と記されたボックスの横の<span class="guibutton">追加</span>ボタンをクリックする。パネルが開いたらリモートドメイン名とパスワードを入力する。</p></div><div class="sect2" title="ドメイン間信頼関係の機能"><div class="titlepage"><div><div><h3 class="title"><a name="id2635652"></a>ドメイン間信頼関係の機能</h3></div></div></div><p><a class="indexterm" name="id2635660"></a><a class="indexterm" name="id2635667"></a><a class="indexterm" name="id2635674"></a><a class="indexterm" name="id2635681"></a><a class="indexterm" name="id2635688"></a><a class="indexterm" name="id2635696"></a>双方向の信頼関係は、二つの方方向の信頼がそれぞれ互いの方向に作成されることで築かれる。二つのMicrosoft Windows NT4ドメイン間で片方向の信頼が確立されている場合(仮にDomAとDomBとする)、次の機能が可能になる:</p><div class="figure"><a name="trusts1"></a><p class="title"><b>Figure 19.1. 信頼の概要</b></p><div class="figure-contents"><div class="mediaobject"><img src="images/trusts1.png" alt="信頼の概要"></div></div></div><br class="figure-break"><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>	DomA(DomB への信頼接続を完了する)はDomBを<em class="parameter"><code>信頼する</code></em>。	</p></li><li class="listitem"><p>	DomAが<em class="parameter"><code>信頼する</code></em>ドメインである。	</p></li><li class="listitem"><p>	DomBが<em class="parameter"><code>信頼される</code></em>ドメインである(信頼アカウントの起点)。	</p></li><li class="listitem"><p>	DomB のユーザーは DomA のリソースにアクセスすることができる。	</p></li><li class="listitem"><p>	DomA のユーザーは DomB のリソースにアクセスすることはできない。	</p></li><li class="listitem"><p>	DomB のグローバル・グループは DomA で使用できる。	</p></li><li class="listitem"><p>	DomA のグローバル・グループは DomB では使用できない。	</p></li><li class="listitem"><p>	DomB は DomA のクライアントワークステーションのログオンダイアログボックスに表示される。	</p></li><li class="listitem"><p>	DomA は DomB のクライアントワークステーションのログオンダイアログボックスに表示されない。	</p></li></ul></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>	信頼するドメインのユーザー/グループは信頼されるドメインへの権限、許可、	アクセスは与えられない。	</p></li><li class="listitem"><p>	信頼するドメインは信頼されるドメインにアクセスしたり(ユーザ/グローバルグループの)	アカウントを使用することができる。	</p></li><li class="listitem"><p>	信頼されるドメインの管理者は信頼するドメイン内で管理権限を付与される。	</p></li><li class="listitem"><p>	信頼されるドメインのユーザは信頼するドメインで権利や特権を付与される。	</p></li><li class="listitem"><p>	信頼されるドメインのグローバルグループは信頼するドメインで権利や許可を	与えられる。	</p></li><li class="listitem"><p>	信頼されるドメインのグローバルグループはMicrosoft Windowsドメインメンバ	マシンのローカルグループのメンバーになることができる。	</p></li></ul></div></div></div><div class="sect1" title="SambaにおけるNT形式のドメイン信頼関係の設定"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2635902"></a>SambaにおけるNT形式のドメイン信頼関係の設定</h2></div></div></div><p><a class="indexterm" name="id2635911"></a>ここでは、Samba サーバがドメイン間の信頼関係に参加できるようにするための設定方法を、簡潔に紹介する。Samba における信頼関係のサポートは初期段階なので、正しく機能しないことがあっても驚かないこと。</p><p><a class="indexterm" name="id2635932"></a><a class="indexterm" name="id2635938"></a><a class="indexterm" name="id2635945"></a><a class="indexterm" name="id2635953"></a>下記における手順の説明では、信頼関係の相手先のドメインは、Windows NT4 サーバで管理されていると仮定する。しかし、リモート側は Samba-3 ドメインであっても構わない。この文書を読み終わるころには明らかになることであるが、以下に書かれている説明のうち、Samba固有の部分のみを合わせると、純粋なSamba環境におけるドメイン信頼の構築の説明となる、ということである。</p><div class="sect2" title="信頼されるドメインとしてのSamba"><div class="titlepage"><div><div><h3 class="title"><a name="samba-trusted-domain"></a>信頼されるドメインとしてのSamba</h3></div></div></div><p><a class="indexterm" name="id2635984"></a><a class="indexterm" name="id2635991"></a><a class="indexterm" name="id2635998"></a><a class="indexterm" name="id2636005"></a><a class="indexterm" name="id2636011"></a>Samba PDC を、信頼関係のある二者のうち信頼される側に設定するためには、まず信頼する側のドメインのための特別なアカウントを作成する必要がある。そのためには<code class="literal">smbpasswd</code>ユーティリティを使う。信頼されるドメインアカウントを作成するのは、信頼されるマシンアカウントを作成するのに似ている。仮にドメイン名をSAMBAとし、リモートドメインをRUMBAとする。最初のステップは好みのシェルからこのコマンドを発行することである:</p><p></p><pre class="screen"><code class="prompt">root# </code> <strong class="userinput"><code>smbpasswd -a -i rumba</code></strong>New SMB password: <strong class="userinput"><code>XXXXXXXX</code></strong>Retype SMB password: <strong class="userinput"><code>XXXXXXXX</code></strong>Added user rumba$</pre><p>ここで、<code class="option">-a</code>はパスワードデータベースの中に新規のアカウントを追加することを意味し、<code class="option">-i</code>は、<span class="quote">“<span class="quote">このアカウントをドメイン間の信頼フラグ付きで作成せよ</span>”</span>ということを意味する。</p><p><a class="indexterm" name="id2636095"></a><a class="indexterm" name="id2636102"></a><a class="indexterm" name="id2636109"></a><a class="indexterm" name="id2636117"></a>このアカウント名は<span class="quote">“<span class="quote">rumba$</span>”</span>(リモートドメインの名前)である。もしもこのステップが失敗した場合、信頼アカウントがシステムのパスワードデータベース(<code class="filename">/etc/passwd</code>)に追加されたか確認すること。もしも追加されていなければ、手動で追加し、上のステップを再度行うこと。</p><p><a class="indexterm" name="id2636148"></a><a class="indexterm" name="id2636155"></a><a class="indexterm" name="id2636162"></a><a class="indexterm" name="id2636169"></a>このコマンドを実行後、そのアカウントのパスワードの入力要求が来る。ここでは任意のパスワードを使用できるが、Windows NTではアカウント作成後7日間はパスワードを変更できないので、注意すること。コマンドの実行が成功すると、新しいアカウントのエントリを、(設定した環境でのの標準的な方法で)見ることができるので、アカウント名が本当にRUMBA$で、フラグ欄に<span class="quote">“<span class="quote">I</span>”</span>が設定されているか確認する。この信頼関係の設定を完成するために、次は Windows NTサーバの方から信頼を設定する。</p><p><a class="indexterm" name="id2636196"></a><a class="indexterm" name="id2636203"></a><a class="indexterm" name="id2636210"></a><a class="indexterm" name="id2636217"></a><a class="indexterm" name="id2636224"></a><span class="application">ドメインユーザマネージャ</span>を開き、メニューから<span class="guimenu">ポリシー</span>を選び、<span class="guimenuitem">信頼関係</span>を選択する。<span class="guilabel">信頼されたドメイン</span>リストボックスのそばの<span class="guimenu">追加</span>ボタンをクリックする。信頼されたドメインの名前とそのパスワードを入力するダイアログボックスが表示される。リモートドメインの名前としてSAMBAを入力し、アカウント作成時に使用したパスワードを入力する。<span class="guibutton">OK</span>をクリックし、すべてが何事もなくうまくいくならば、<code class="computeroutput">信頼関係が確立しました</code>(訳注:英文では<code class="computeroutput">Trusted domain relationship successfully established</code>)が表示される。</p></div><div class="sect2" title="信頼するドメインとしてのSamba"><div class="titlepage"><div><div><h3 class="title"><a name="id2636296"></a>信頼するドメインとしてのSamba</h3></div></div></div><p><a class="indexterm" name="id2636304"></a><a class="indexterm" name="id2636311"></a>ここでは作業の順番が逆になる。今回も、Samba PDCに管理されるドメインを「SAMBA」とし、NTが管理するドメインを「RUMBA」とする。</p><p>一番初めのステップはRUMBAのPDCにSAMBAドメインのアカウントを追加することである。</p><p><a class="indexterm" name="id2636334"></a><a class="indexterm" name="id2636341"></a><a class="indexterm" name="id2636348"></a><span class="application">ドメインユーザマネージャ</span>を起動し、<span class="guimenu">ポリシー</span>、<span class="guimenuitem">信頼関係</span>を選択する。次に、<span class="guilabel">信頼するドメイン</span>のボックスのそばの<span class="guibutton">追加</span>ボタンをクリックし、信頼されるドメイン(SAMBA)の名前を入力し、信頼関係を確立するために使用するパスワードを入力する。</p><p><a class="indexterm" name="id2636396"></a><a class="indexterm" name="id2636403"></a>パスワードは任意に選択できる。Sambaサーバでは、いつでも容易にパスワードを変更することができる。パスワードを確定するとアカウントは準備完了である。次は Sambaの番である。</p><p>rootでログインし、好みのシェルを使って以下のコマンドを発行する:<a class="indexterm" name="id2636425"></a></p><p><code class="prompt">root# </code><strong class="userinput"><code>net rpc trustdom establish rumba</code></strong></p><p><a class="indexterm" name="id2636453"></a><a class="indexterm" name="id2636460"></a><a class="indexterm" name="id2636467"></a>Windows NT4サーバで入力したばかりのパスワードが聞かれる。時々、<code class="literal">NT_STATUS_NOLOGON_INTERDOMAIN_TRUST_ACCOUNT</code>というエラーメッセージが現れるが、問題はないので無視して構わない。これは入力したパスワードが正しく、このアカウントは通常の接続ではなく、ドメイン間接続のための準備ができている、と NTサーバが言っている、という意味である。その後、(大規模ネットワークの場合は特に)しばらく時間がかかるかもしれないが、我慢する。しばらくすると<code class="literal">Success</code>というメッセージが表示される。おめでとう! これで信頼関係が成立した。</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><code class="filename">secrets.tdb</code>ファイルに書き込み権がなければならないので、上記のコマンドはrootとして実行すること。</p></div></div></div><div class="sect1" title="Windows 2000との間での、NT4形式のドメイン信頼関係"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2636523"></a>Windows 2000との間での、NT4形式のドメイン信頼関係</h2></div></div></div><p><a class="indexterm" name="id2636532"></a><a class="indexterm" name="id2636539"></a><a class="indexterm" name="id2636547"></a><a class="indexterm" name="id2636554"></a><span class="application">ドメインユーザマネージャ</span>が無いにもかかわらず、ミックスモードで動作するWindows 2000ドメインコントローラを、信頼するサーバとして、NT4形式の信頼関係を設定することは可能である。また、SambaがWindows 2000サーバを信頼することもできるはずだが、この領域ではさらにテストが必要である。</p><p><a class="indexterm" name="id2636582"></a><a class="indexterm" name="id2636589"></a><a class="indexterm" name="id2636596"></a><a class="indexterm" name="id2636603"></a>前述のように、<a class="link" href="InterdomainTrusts.html#samba-trusted-domain" title="信頼されるドメインとしてのSamba">Sambaサーバ上でのドメイン間信頼関係の作成</a>で、信頼関係を作成したら、SambaユーザにアクセスさせたいリソースのあるドメインのADコントローラ上で、<span class="application">Active Directoryドメインと信頼関係</span>ダイアログボックスを開く。NT4形式の信頼関係は推移的ではないので、自ドメインのユーザが、AD内の複数のミックスモードのドメインにアクセスできるようにしたい場合は、各ドメインについて上記の手順を繰り返さなければならない、ということを忘れないこと。<span class="application">Active Directoryドメインと信頼関係</span>を開き、Samba ドメインを信頼する Active Directory ドメインの名前を右クリックし、<span class="guimenuitem">プロパティ</span>を選択し、<span class="guilabel">信頼</span>タブをクリックする。パネルの上部に<span class="guilabel">このドメインによって信頼されるドメイン:</span>という名前の付いた一覧が表示され、その隣に<span class="guilabel">追加...</span>ボタンがある。このボタンをクリックすると、NT4のように、信頼されるドメインの名前と関係パスワードを聞かれる。<span class="emphasis"><em>OK</em></span>をクリックし、しばらくすると、<code class="computeroutput">Active Directoryから、信頼されるドメインが追加されて信頼関係が確認された</code>というメッセージが表示される。これで、自システムのSamba ユーザに、ADドメインのリソースへのアクセス権限が付与された。</p></div><div class="sect1" title="よくあるエラー"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2636704"></a>よくあるエラー</h2></div></div></div><p>ドメイン間の信頼関係は、不安定な、又は頻繁にダウンするようなネットワークで試みるべきではない。ネットワークの安定性と整合性は、分散型ネットワークにおけるドメイン間の信頼関係のための必須要件である。</p><div class="sect2" title="信頼されるドメインからのブラウジングに失敗する"><div class="titlepage"><div><div><h3 class="title"><a name="id2636723"></a>信頼されるドメインからのブラウジングに失敗する</h3></div></div></div><p><span class="emphasis"><em>信頼されるWindows200xドメインのマシンから信頼するSambaドメインのWindows200xメンバをブラウズしようとすると、次のエラーが出</em></span></p><pre class="screen">システムはセキュリティを侵害しようとするような行為を検出しました。認証を受けるサーバに連絡が取れることを確認してください。</pre><p></p><p><span class="emphasis"><em>接続しようとしているサーバのイベントログに、下位レベルのドメインのメンバであるためにグループポリシーが適用されない、というエントリがある。</em></span></p><p>問題のマシンのコンピュータアカウントが Windows200xドメインにあり、それが無効化されている場合にこの問題が起こり得る。コンピュータアカウントがない(削除されたか、もともと存在しない)か、そのアカウントを有効になっていない(すなわち、そのアカウントを他のドメインに参加させただけという)場合は、問題は起こらないようである。既定値では、ドメイン(Windows 200xドメイン) から離脱する場合、コンピュータは自動的にドメイン内のコンピュータ・アカウントを無効にしようとする。アカウントを無効化する権限をもつアカウントととして操作していた時にドメインからマシンを離脱した場合、アカウントの無効化が実行される。そうでなければ実行されない。</p></div><div class="sect2" title="LDAP ldapsamと古いバージョンのsmbldap-toolsに関する問題"><div class="titlepage"><div><div><h3 class="title"><a name="id2636795"></a>LDAP ldapsamと古いバージョンのsmbldap-toolsに関する問題</h3></div></div></div><p>ドメイン間の信頼関係を設定するために、信頼アカウントを作成するために、<code class="literal">smbldap-useradd</code>スクリプトを使うと、信頼関係の設定処理は失敗する。LDAPデータベース中に作成されたアカウントはアカウントフラグとして<code class="literal">[W          ]</code>となっていて、ドメイン間の信頼関係が動作する時に必要である<code class="literal">[I          ]</code>がない。</p><p>これに対する簡単な解決方法がある。以下のようにして、マシンアカウントを作成する:</p><pre class="screen"><code class="prompt">root# </code> smbldap-useradd -w domain_name</pre><p>次に、信頼アカウントのパスワードを設定する:</p><pre class="screen"><code class="prompt">root# </code> smbldap-passwd domain_name\$</pre><p>テキストエディタを使って以下のファイルを作成する:</p><pre class="screen">dn: uid=domain_name$,ou=People,dc={your-domain},dc={your-top-level-domain}changetype: modifysambaAcctFlags: [I         ]</pre><p>次に、以下のようにして、LDAPデータベースにテキストファイルを適用する:</p><pre class="screen"><code class="prompt">root# </code> ldapmodify -x -h localhost \ -D "cn=Manager,dc={your-domain},dc={your-top-level-domain}" \ -W -f /path-to/foobar</pre><p>NT4のドメインユーザマネージャから片方向の信頼関係を作成した後、以下を実行する:</p><pre class="screen"><code class="prompt">root# </code> net rpc trustdom establish domain_name</pre><p></p><p>この機能は Samba-3とNT4ドメインで動くし、Samba-3とミックスモードの Windows 200x ADSでも動作する。sambaとNTの両方のDCが同じWINS サーバーを使用していなければならず、そうでなければ信頼関係は動作しない。</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="securing-samba.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="optional.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="msdfs.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 18. Securing Samba </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 20. Microsoft 分散ファイルシステムツリーのホスティング</td></tr></table></div></body></html>