<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Chapter 6. ドメインメンバシップ</title><link rel="stylesheet" href="../samba.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="公式のSamba 3.2.x HOWTOとリファレンスガイド"><link rel="up" href="type.html" title="Part II. サーバ設定の基本"><link rel="prev" href="samba-bdc.html" title="Chapter 5. バックアップドメインコントローラ"><link rel="next" href="StandAloneServer.html" title="Chapter 7. スタンドアロンサーバ"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 6. ドメインメンバシップ</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="samba-bdc.html">Prev</a> </td><th width="60%" align="center">Part II. サーバ設定の基本</th><td width="20%" align="right"> <a accesskey="n" href="StandAloneServer.html">Next</a></td></tr></table><hr></div><div class="chapter" title="Chapter 6. ドメインメンバシップ"><div class="titlepage"><div><div><h2 class="title"><a name="domain-member"></a>Chapter 6. ドメインメンバシップ</h2></div><div><div class="author"><h3 class="author"><span class="firstname">John</span> <span class="othername">H.</span> <span class="surname">Terpstra</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jht@samba.org">jht@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Jeremy</span> <span class="surname">Allison</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jra@samba.org">jra@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Gerald</span> <span class="othername">(Jerry)</span> <span class="surname">Carter</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jerry@samba.org">jerry@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Andrew</span> <span class="surname">Tridgell</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:tridge@samba.org">tridge@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Jelmer</span> <span class="othername">R.</span> <span class="surname">Vernooij</span></h3><div class="affiliation"><span class="orgname">The Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:jelmer@samba.org">jelmer@samba.org</a>></code></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Guenther</span> <span class="surname">Deschner</span></h3><span class="contrib">LDAP updates</span> <div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:gd@samba.org">gd@samba.org</a>></code></p></div></div></div></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="domain-member.html#id2577919">機能と利便性</a></span></dt><dt><span class="sect1"><a href="domain-member.html#machine-trust-accounts">MicrosoftWindowsワークステーション/サーバのマシン信頼アカウント</a></span></dt><dd><dl><dt><span class="sect2"><a href="domain-member.html#id2578717">マシン信頼アカウントの手動作成</a></span></dt><dt><span class="sect2"><a href="domain-member.html#id2579187">NT4サーバマネージャによるドメインマシンアカウントの管理</a></span></dt><dt><span class="sect2"><a href="domain-member.html#id2579495">マシン信頼アカウントの即時作成</a></span></dt><dt><span class="sect2"><a href="domain-member.html#id2579616">Microsoft Windows ワークステーション又はサーバをドメインメンバにする</a></span></dt></dl></dd><dt><span class="sect1"><a href="domain-member.html#domain-member-server">ドメインメンバサーバ</a></span></dt><dd><dl><dt><span class="sect2"><a href="domain-member.html#id2580152">Samba-3でNT4形式でのドメインに参加する</a></span></dt><dt><span class="sect2"><a href="domain-member.html#id2580966">これがなぜ<em class="parameter"><code>security = server</code></em>よりもすぐれているのか?</a></span></dt></dl></dd><dt><span class="sect1"><a href="domain-member.html#ads-member">Samba ADS ドメインメンバシップ</a></span></dt><dd><dl><dt><span class="sect2"><a href="domain-member.html#id2581290"><code class="filename">smb.conf</code>の設定</a></span></dt><dt><span class="sect2"><a href="domain-member.html#id2581494"><code class="filename">/etc/krb5.conf</code>の設定</a></span></dt><dt><span class="sect2"><a href="domain-member.html#ads-create-machine-account">コンピュータアカウントの作成</a></span></dt><dt><span class="sect2"><a href="domain-member.html#ads-test-server">サーバ設定のテスト</a></span></dt><dt><span class="sect2"><a href="domain-member.html#ads-test-smbclient"><span class="application">smbclient</span>によるテスト</a></span></dt><dt><span class="sect2"><a href="domain-member.html#id2582693">注意</a></span></dt></dl></dd><dt><span class="sect1"><a href="domain-member.html#id2582771">Sambaドメインメンバ間でのユーザIDマッピング共有</a></span></dt><dt><span class="sect1"><a href="domain-member.html#id2582992">よくあるエラー</a></span></dt><dd><dl><dt><span class="sect2"><a href="domain-member.html#id2583043">マシンをドメインに追加し直すことができない</a></span></dt><dt><span class="sect2"><a href="domain-member.html#id2583134">マシンのドメインへの追加に失敗する</a></span></dt><dt><span class="sect2"><a href="domain-member.html#id2583391">Windows 2003 PDC に参加できない</a></span></dt></dl></dd></dl></div><p><a class="indexterm" name="id2577859"></a><a class="indexterm" name="id2577866"></a><a class="indexterm" name="id2577873"></a>ドメインメンバシップはきわめて重要な事項である。SambaはMicrosoftドメインセキュリティコンテキスト中においてメンバサーバとして参加できねばならず、Sambaはドメインマシンメンバ信頼アカウントを付与できねばならない。これなしには多くのユーザに実行可能なオプションを提供できないだろう。</p><p><a class="indexterm" name="id2577894"></a><a class="indexterm" name="id2577901"></a>この章では、ドメインメンバシップに関する背景情報、Sambaの設定と、Microsoft Windows クライアントのドメインに参加方法について説明する。なぜそれが必要なのであろうか?なぜならば、現在のMicrosoft Windowsネットワーキングと、特にUNIX/Linuxネットワーキングおよび管理の世界に関してかなりの間違った情報、誤解があり、また知識の欠如が顕著だからである。この章によってその欠如を埋めることを望みたい。</p><div class="sect1" title="機能と利便性"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2577919"></a>機能と利便性</h2></div></div></div><p><a class="indexterm" name="id2577927"></a><a class="indexterm" name="id2577934"></a><a class="indexterm" name="id2577941"></a>Microsoft Windows ワークステーションおよびサーバがドメインセキュリティに参加するためには、ドメインメンバにならなければならない。ドメインセキュリティに参加することは、しばしば<span class="emphasis"><em>シングルサインオン</em></span>か省略して<acronym class="acronym">SSO</acronym>と呼ばれる。この章では、ワークステーション(かあるいは<span class="application">Microsoft Windows NT4/200x</span>サーバであるもう一台のサーバ)又はSambaサーバを、Microsoft Windowsドメインセキュリティのメンバにするための手順について説明する。</p><p><a class="indexterm" name="id2577983"></a><a class="indexterm" name="id2577990"></a><a class="indexterm" name="id2577996"></a><a class="indexterm" name="id2578003"></a>Samba-3 はNT4形式のMicrosoft Windowsドメインにネイティブなメンバサーバとして、Microsoft Windows Active Directoryドメインにネイティブなメンバサーバとして、あるいは、Sambaドメイン管理ネットワークに参加できる。ドメインメンバシップはたくさんの利点を持つ:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>	<a class="indexterm" name="id2578030"></a>	Microsoft WindowsワークステーションユーザはSSOの利点を享受できる。	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2578044"></a>	<a class="indexterm" name="id2578050"></a>	<a class="indexterm" name="id2578058"></a>	<a class="indexterm" name="id2578064"></a>	ドメインユーザアカウントの(アクセス)権限とファイルの所有権およびアクセス制御は	単一のドメインセキュリティアカウントマネージャ(SAM)データベース	から設定できる(ドメインメンバであるMicrosoft Windowsワークステーション	と同様にドメインメンバサーバで動作する)。	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2578086"></a>	<a class="indexterm" name="id2578093"></a>	ドメインメンバである<span class="application">Microsoft Windows NT4/200x/XP Professional</span>	ワークステーションのみがネットワークログオン機能を使える。	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2578115"></a>	<a class="indexterm" name="id2578122"></a>	<a class="indexterm" name="id2578129"></a>	<a class="indexterm" name="id2578136"></a>	ドメインメンバのワークステーションを、ポリシーファイル	(<code class="filename">NTConfig.POL</code>)およびデスクトッププロファイルを使用	してよりよく制御できる。	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2578160"></a>	<a class="indexterm" name="id2578167"></a>	<a class="indexterm" name="id2578174"></a>	ログオンスクリプトを使用することで、ユーザはアプリケーションサーバ	上のネットワークアプリケーションへ自由にアクセスできる。	(訳注:意味はこれでよい?)。	Through the use of logon scripts, users can be given transparent access to network	applications that run off application servers.	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2578195"></a>	<a class="indexterm" name="id2578202"></a>	<a class="indexterm" name="id2578209"></a>	<a class="indexterm" name="id2578216"></a>	ネットワーク管理者にとっては、より優れたアプリケーション管理およびユーザアクセス	管理が可能になる。ユーザアカウントを、中央にあるドメインデータベース	(NT4/SambaでのSAM形式ドメインか、LDAPによるディレクトリがバックエンドになった	NT4ドメインか、Active Directory基盤経由で)以外の任意のネットワーク	クライアントかサーバ上でユーザアカウントを保守する必要がないからである。	</p></li></ul></div></div><div class="sect1" title="MicrosoftWindowsワークステーション/サーバのマシン信頼アカウント"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="machine-trust-accounts"></a>MicrosoftWindowsワークステーション/サーバのマシン信頼アカウント</h2></div></div></div><p><a class="indexterm" name="id2578250"></a><a class="indexterm" name="id2578258"></a><a class="indexterm" name="id2578264"></a><a class="indexterm" name="id2578272"></a>マシン信頼アカウントは(ユーザではなく)クライアントマシンをドメインコントローラサーバに対して認証するために使われる。Windowsの用語では、これは<span class="quote">“<span class="quote">コンピュータアカウント</span>”</span>として知られている。マシン信頼アカウントの目的は、不正(訳注:rogue)ユーザとドメインコントローラが、共謀してドメインメンバのワークステーションにアクセスすることを防ぐことである。</p><p><a class="indexterm" name="id2578297"></a><a class="indexterm" name="id2578307"></a><a class="indexterm" name="id2578313"></a><a class="indexterm" name="id2578320"></a><a class="indexterm" name="id2578328"></a>マシン信頼アカウントのパスワードは、ドメインコントローラとの間で暗号化通信を行うために共通の秘密鍵(訳注:shared secret:共通鍵?)である。これは、同じNetBIOS名を持つ未認証マシンがドメインに参加し、ドメインセキュリティ操作をし、ドメインユーザ/グループアカウントへアクセスすることを得ることを防ぐセキュリティ機能である。Windows NT/200x/XP Professionalクライアントはマシン信頼アカウントを使うが、Windows 9x/Me/XP Homeは使わない。従って、Windows 9x/Me/XP Homeクライアントは、マシン信頼アカウントを持たないため、ドメインコントローラとの間で、共通の秘密鍵を持つことはなく、決してドメインの真のメンバにはなれない。</p><p><a class="indexterm" name="id2578367"></a><a class="indexterm" name="id2578374"></a><a class="indexterm" name="id2578381"></a><a class="indexterm" name="id2578387"></a>Windows NT4 PDCはマシン信頼アカウントをWindowsレジストリ中に格納する。Microsoft Windows 2000の登場と共に、Active Directoryという、マシン信頼アカウントのための新しいリポジトリが登場した。それに対し、Samba PDCはマシン信頼アカウントを以下のように2つの部分に分けて格納する:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>	<a class="indexterm" name="id2578410"></a>	<a class="indexterm" name="id2578418"></a>	<a class="indexterm" name="id2578425"></a>	ドメインセキュリティアカウントは<code class="filename">smb.conf</code>ファイル中で設定される	<a class="link" href="smb.conf.5.html#PASSDBBACKEND" target="_top">passdb backend</a>に格納される。格納される	アカウント情報の性質は、選択されたバックエンドデータベースの	タイプに依存する。	</p><p>	<a class="indexterm" name="id2578459"></a>	<a class="indexterm" name="id2578465"></a>	<a class="indexterm" name="id2578472"></a>	<a class="indexterm" name="id2578479"></a>	<a class="indexterm" name="id2578486"></a>	<a class="indexterm" name="id2578494"></a>	このデータのより古い形式は<code class="filename">smbpasswd</code>データベースで、	そこにはUNIXのログインID、UNIXのユーザ識別子(UID)、LanManおよびNT形式で	暗号化されたパスワードを格納している。また、ここでは触れないが、その他	にもいくつかの情報が含まれている。	</p><p>	<a class="indexterm" name="id2578519"></a>	<a class="indexterm" name="id2578525"></a>	<a class="indexterm" name="id2578532"></a>	<a class="indexterm" name="id2578539"></a>	より新しいデータベースは、ldapsamとtdbsamと呼ばれる。どちらも、以前の	<code class="filename">smbpasswd</code>ファイルよりもかなりより多くのデータを格納する。	その付加情報により、新しいユーザアカウント管理の新しい方法が可能になる。	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2578563"></a>	<a class="indexterm" name="id2578570"></a>	対応するUNIXアカウントは通常<code class="filename">/etc/passwd</code>に格納される。	UNIX ユーザアカウントを必要としないような、より簡便なオペレーションの実現	に向けて開発中だが、この機能は Samba-3 の初期リリースまでは実装されない予定	である(訳注:この部分は古い)。	</p></li></ul></div><p></p><p><a class="indexterm" name="id2578598"></a>マシン信頼アカウントの作成には3つの方法がある:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>	<a class="indexterm" name="id2578616"></a>	UNIX/Linuxコマンド行からの手動作成。この方法では、Sambaとそれに対応する	UNIXアカウントが手動で作成される。	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2578632"></a>	<a class="indexterm" name="id2578639"></a>	NT4ドメインコントローラからMicrosoft Windows NT4サーバマネージャを使うか、	MicrosoftのWebサイトから入手可能なNexusツールキットを使う。このツールは	ユーザが管理者アカウントでログオンしている限り、任意のMicrosoft Windows	マシンから実行することが出来る。	</p></li><li class="listitem"><p>	<a class="indexterm" name="id2578661"></a>	<a class="indexterm" name="id2578668"></a>		<span class="quote">“<span class="quote">その場での(on the fly)</span>”</span>作成。Sambaマシン信頼アカウントは、	クライアントがドメインに参加したときに、Sambaによって自動的に作成	される(セキュリティ上、この方法が推奨される)。対応するUNIX	アカウントは自動でも、手動ででも作成できる。	</p></li></ul></div><p><a class="indexterm" name="id2578694"></a><a class="indexterm" name="id2578700"></a>Microsoft Windows NT4/200x/XP ProfessionalもSambaもマシン信頼アカウントを強制する方法を提供しない。これは管理者の選択問題である。</p><div class="sect2" title="マシン信頼アカウントの手動作成"><div class="titlepage"><div><div><h3 class="title"><a name="id2578717"></a>マシン信頼アカウントの手動作成</h3></div></div></div><p><a class="indexterm" name="id2578725"></a><a class="indexterm" name="id2578732"></a><a class="indexterm" name="id2578738"></a><a class="indexterm" name="id2578744"></a>マシン信頼アカウントの手動作成の最初の手順は、<code class="filename">/etc/passwd</code>中に対応するUNIXアカウントを手動で作成することである。この作業は、<code class="literal">vipw</code>か、通常、新規のUNIXアカウント作成時に使われる<span class="quote">“<span class="quote">adduser</span>”</span>コマンドを使用する。以下は、LinuxベースのSambaサーバにおける例である:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>/usr/sbin/useradd -g machines -d /var/lib/nobody \   -c <em class="replaceable"><code>"machine nickname"</code></em> \   -s /bin/false <em class="replaceable"><code>machine_name</code></em>$ </code></strong><code class="prompt">root# </code><strong class="userinput"><code>passwd -l <em class="replaceable"><code>machine_name</code></em>$</code></strong></pre><p></p><p><a class="indexterm" name="id2578817"></a><a class="indexterm" name="id2578824"></a><a class="indexterm" name="id2578831"></a>上記の例では、全マシンアカウントのプライマリグループとして使われる<span class="quote">“<span class="quote">machines</span>”</span>という、既存のシステムグループがある。以下の例では、<span class="quote">“<span class="quote">machines</span>”</span>グループのGIDは100である。</p><p><a class="indexterm" name="id2578854"></a><a class="indexterm" name="id2578860"></a>*BSDシステム上では、この作業は<code class="literal">chpass</code>ユーティリティを使うこともできる:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>chpass -a \'<em class="replaceable"><code>machine_name</code></em>$:*:101:100::0:0:Windows <em class="replaceable"><code>machine_name</code></em>:/dev/null:/sbin/nologin'</code></strong></pre><p></p><p><a class="indexterm" name="id2578903"></a><a class="indexterm" name="id2578910"></a><a class="indexterm" name="id2578916"></a><a class="indexterm" name="id2578923"></a><code class="filename">/etc/passwd</code>のエントリは<span class="quote">“<span class="quote">$</span>”</span>を追加したマシン名を付けたもので、パスワードは持たず、シェル情報が空白で(訳注:/dev/nullを指定すること)、ホームディレクトリの定義がない。たとえば、マシン名が<span class="quote">“<span class="quote">doppy</span>”</span>の場合は<code class="filename">/etc/passwd</code>のエントリは以下のようになる:</p><pre class="programlisting">doppy$:x:505:100:<em class="replaceable"><code>machine_nickname</code></em>:/dev/null:/bin/false</pre><p></p><p><a class="indexterm" name="id2578968"></a><a class="indexterm" name="id2578975"></a><a class="indexterm" name="id2578982"></a>上記の例では、<em class="replaceable"><code>machine_nickname</code></em>はクライアントに対する任意の名前を記述する(たとえばBasementComputer)。<em class="replaceable"><code>machine_name</code></em>はドメインに参加するときのクライアントのNetBIOS名でなければならない。<span class="quote">“<span class="quote">$</span>”</span>をクライアントのNetBIOS名に必ず付加しなければならず、これがないと、Sambaはこれをマシン信頼アカウントと認識できない。</p><p><a class="indexterm" name="id2579010"></a><a class="indexterm" name="id2579017"></a><a class="indexterm" name="id2579025"></a>対応するUNIXアカウントが作成されると、次の手順は初期マシン信頼アカウントの、よく知られたパスワードを持つクライアント用のSambaアカウントを作成することである。これは以下に示すような<code class="literal">smbpasswd</code>を使用する:</p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>smbpasswd -a -m <em class="replaceable"><code>machine_name</code></em></code></strong></pre><p></p><p><a class="indexterm" name="id2579071"></a><a class="indexterm" name="id2579078"></a><a class="indexterm" name="id2579085"></a><a class="indexterm" name="id2579092"></a>ここで<em class="replaceable"><code>machine_name</code></em>はマシンのNetBIOS名である。新規のマシンアカウントのRIDは対応するUNIXアカウントのUIDから生成される。</p><div class="warning" title="クライアントをドメインに即座に参加させる" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">クライアントをドメインに即座に参加させる</h3><p><a class="indexterm" name="id2579115"></a><a class="indexterm" name="id2579122"></a><a class="indexterm" name="id2579129"></a><a class="indexterm" name="id2579136"></a><a class="indexterm" name="id2579143"></a>この方法でマシン信頼アカウントを手動作成することは、 Windows NT PDC で<a class="indexterm" name="id2579153"></a>により<span class="application">サーバマネージャ</span>によりマシン信頼アカウントを作成するのと同等である。アカウントが作成されてからクライアントがドメインに参加してパスワードを変更するまでの間、同じ NetBIOS 名を持つマシンでドメインに参加しようとする侵入者の被害を受ける可能性がある。 PDC は、ドメインのメンバを信頼するようにできており、多くのユーザ情報をこのようなクライアントに渡してしまう。注意すること!</p></div></div><div class="sect2" title="NT4サーバマネージャによるドメインマシンアカウントの管理"><div class="titlepage"><div><div><h3 class="title"><a name="id2579187"></a>NT4サーバマネージャによるドメインマシンアカウントの管理</h3></div></div></div><p><a class="indexterm" name="id2579198"></a><a class="indexterm" name="id2579205"></a><a class="indexterm" name="id2579212"></a>有効な<a class="link" href="smb.conf.5.html#ADDMACHINESCRIPT" target="_top">add machine script</a>はマシン信頼アカウントの自動作成に必須である。これは自動アカウント作成機能を使用する場合でも、NT4 ドメインサーバマネージャを使用する場合でも必要である。</p><p><a class="indexterm" name="id2579240"></a><a class="indexterm" name="id2579246"></a><a class="indexterm" name="id2579253"></a><a class="indexterm" name="id2579260"></a>ドメインを管理しようとしているマシンが<span class="application">Microsoft Windows NT4 ワークステーション又はMicrosoft Windows 200x/XP Professional</span>の場合、使用するツールは<code class="literal">SRVTOOLS.EXE</code>というパッケージである。これをターゲットディレクトリで実行すると、<code class="literal">SrvMgr.exe</code>及び<code class="literal">UsrMgr.exe</code>(どちらもMicrosoft Windows NT4 ワークステーションのドメイン管理ツール)が解凍される。</p><p><a class="indexterm" name="id2579306"></a><a class="indexterm" name="id2579312"></a>ワークステーションが<span class="application">Microsoft Windows 9x/Me</span>ファミリー製品であれば、 Microsoft のWebサイトから<code class="literal">Nexus.exe</code>パッケージをダウンロードする。それをターゲットディレクトリから実行すると、上記と同じツールで、9x/Meプラットフォーム用のものが解凍される。</p><p>これらのツールに関する詳細情報は次のKnowledge Baseの記事で得ることができる: <a class="ulink" href="http://support.microsoft.com/default.aspx?scid=kb;en-us;173673" target="_top">173673</a>と<a class="ulink" href="http://support.microsoft.com/default.aspx?scid=kb;en-us;172540" target="_top">172540</a></p><p><a class="indexterm" name="id2579366"></a><a class="indexterm" name="id2579372"></a><code class="literal">srvmgr.exe</code>(ドメイン用のサーバマネージャ)を起動し、以下の手順を実行する:</p><div class="procedure" title="Procedure 6.1. サーバマネージャによるドメインマシンアカウント管理"><a name="id2579389"></a><p class="title"><b>Procedure 6.1. サーバマネージャによるドメインマシンアカウント管理</b></p><ol class="procedure" type="1"><li class="step" title="Step 1"><p>	メニューから<span class="guimenu">コンピュータ</span>を選択する。	</p></li><li class="step" title="Step 2"><p>	<span class="guimenuitem">Select Domain</span>をクリックする。	</p></li><li class="step" title="Step 3"><p>	<span class="guilabel">Select Domain</span>パネルで管理対象の	ドメイン名をクリックし、 <span class="guibutton">OK</span>をクリックする。	</p></li><li class="step" title="Step 4"><p>	再度メニュー画面から<span class="guimenu">コンピュータ</span>を選択する。	</p></li><li class="step" title="Step 5"><p>	<span class="guimenuitem">Add to Domain</span>を選択する。	</p></li><li class="step" title="Step 6"><p>	ダイアログボックス中で、<span class="guilabel">Add NT Workstation of Server</span>	ラジオボタンをクリックし、フィールドにマシン名を入力し、	<span class="guibutton">Add</span>ボタンをクリックする。	</p></li></ol></div></div><div class="sect2" title="マシン信頼アカウントの即時作成"><div class="titlepage"><div><div><h3 class="title"><a name="id2579495"></a>マシン信頼アカウントの即時作成</h3></div></div></div><p><a class="indexterm" name="id2579504"></a>マシン信頼アカウント作成の第3の(そして推奨する)方法は、クライアントがドメインに参加する時、必要に応じて Samba サーバーアカウントを作成する方法である。</p><p><a class="indexterm" name="id2579524"></a><a class="indexterm" name="id2579534"></a><a class="indexterm" name="id2579541"></a>Samba の各マシン信頼アカウントは対応するUNIXアカウントを必要とするので、通常、 UNIXアカウントを自動作成する機能が提供されている。これには <code class="filename">smb.conf</code>ファイル内に add machine script オプションを設定する必要がある。しかし、この方法は必須ではなく、対応するUNIXアカウントを手動で作成しても構わない。</p><p><a class="indexterm" name="id2579571"></a><a class="indexterm" name="id2579578"></a>以下は、Red Hat linux での例である:</p><table border="0" summary="Simple list" class="simplelist"><tr><td> </td></tr><tr><td><em class="parameter"><code>[global]</code></em></td></tr><tr><td><a class="indexterm" name="id2579601"></a><em class="parameter"><code>add machine script = /usr/sbin/useradd -d /var/lib/nobody -g 100 -s /bin/false -M %u</code></em></td></tr></table><p></p></div><div class="sect2" title="Microsoft Windows ワークステーション又はサーバをドメインメンバにする"><div class="titlepage"><div><div><h3 class="title"><a name="id2579616"></a>Microsoft Windows ワークステーション又はサーバをドメインメンバにする</h3></div></div></div><p>Microsoft Windows ワークステーションやサーバをドメインのメンバにする手順は Windowsのバージョンによって異なる。</p><div class="sect3" title="Windows 200x/XP Professionalクライアント"><div class="titlepage"><div><div><h4 class="title"><a name="id2579632"></a>Windows 200x/XP Professionalクライアント</h4></div></div></div><p><a class="indexterm" name="id2579641"></a><a class="indexterm" name="id2579648"></a><a class="indexterm" name="id2579658"></a><a class="indexterm" name="id2579665"></a>        ユーザーがクライアントをドメインメンバにする時、 Windows 200x は、ドメイン内で        マシンアカウントを作成する権限を持つアカウント及びパスワードの入力を要求する。        Samba管理者アカウント(すなわち、Sambaサーバ上で<code class="constant">root</code>権限を        持つSambaアカウント)をここで入力せねばならない。通常のユーザアカウントが入力さ        れると、この作業は失敗する(訳注:net rpc rightsでSeMachineAccountPrivilege権限を        持ったユーザも出来るのでは?)	</p><p><a class="indexterm" name="id2579694"></a><a class="indexterm" name="id2579701"></a>        セキュリティのため、この管理者アカウントのパスワードは<code class="filename">/etc/passwd</code>        でルートユーザ用に使用されているパスワード以外のものを設定するべきである。	</p><p><a class="indexterm" name="id2579724"></a><a class="indexterm" name="id2579731"></a><a class="indexterm" name="id2579738"></a><a class="indexterm" name="id2579745"></a>        ドメインメンバのマシンアカウントを作成するために使用するアカウント名は        ネットワーク管理者が任意に選択する。もしそれが<code class="constant">root</code>以外なら        <code class="filename">smb.conf</code>中のパラメータ        <a class="link" href="smb.conf.5.html#USERNAMEMAP" target="_top">username map = /etc/samba/smbusers</a>        で指定するファイル名中で容易にマッピングできる。	</p><p><a class="indexterm" name="id2579788"></a><a class="indexterm" name="id2579795"></a><a class="indexterm" name="id2579802"></a>        Samba管理者アカウントのセッションキーは、マシン信頼アカウントのパスワード        設定の際、暗号化キーの機能を果たす。マシン信頼アカウントはその場でで作成        されるか、または、既に存在していれば更新される。	</p></div><div class="sect3" title="Windows NT4 クライアント"><div class="titlepage"><div><div><h4 class="title"><a name="id2579822"></a>Windows NT4 クライアント</h4></div></div></div><p><a class="indexterm" name="id2579830"></a><a class="indexterm" name="id2579837"></a><a class="indexterm" name="id2579844"></a>        マシン信頼アカウントが手動作成された場合、Identification Changes        メニュー画面でドメイン名を入力するが、        <span class="guilabel">Create a Computer Account in the Domain</span>	チェックボックスにはチェックを入れない。こうすることでマシン	がドメインに参加する際に既存のマシン信頼アカウントが使用される。	</p><p><a class="indexterm" name="id2579873"></a><a class="indexterm" name="id2579880"></a><a class="indexterm" name="id2579887"></a><a class="indexterm" name="id2579894"></a>	もしマシン信頼アカウントがその場で作成される場合は、Identification Changes	メニュー画面でドメイン名を入力し、	<span class="guilabel">Create a Computer Account in the Domain</span>	チェックボックスにチェックを入れる。この場合、上記 Windows2000用	の手順に従いドメインに参加する(プロンプトに対してSamba管理者	アカウント名を入力する)。	</p></div><div class="sect3" title="Sambaクライアント"><div class="titlepage"><div><div><h4 class="title"><a name="id2579922"></a>Sambaクライアント</h4></div></div></div><p><a class="indexterm" name="id2579931"></a>	Joining a Sambaクライアントをドメインに参加させる方法は	<a class="link" href="domain-member.html#domain-member-server" title="ドメインメンバサーバ">次の章</a>に記述されている。	</p></div></div></div><div class="sect1" title="ドメインメンバサーバ"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="domain-member-server"></a>ドメインメンバサーバ</h2></div></div></div><p><a class="indexterm" name="id2579964"></a><a class="indexterm" name="id2579972"></a><a class="indexterm" name="id2579979"></a><a class="indexterm" name="id2579986"></a>このモードのサーバ操作は、Sambaマシンをドメインセキュリティコンテキストのメンバーにすることを含む。またこれは定義上、全てのユーザ認証は中央で定義された認証機構(訳注:authentication regime)で行われることを意味する。この認証機構は NT3/4形式(旧式のドメインテクノロジー)サーバ又はMicrosoft Windows 2000以降で実装されているActive Directory server(ADS)が提供する。</p><p><span class="emphasis"><em><a class="indexterm" name="id2580008"></a><a class="indexterm" name="id2580017"></a><a class="indexterm" name="id2580024"></a><a class="indexterm" name="id2580031"></a><a class="indexterm" name="id2580037"></a><a class="indexterm" name="id2580044"></a><a class="indexterm" name="id2580051"></a><a class="indexterm" name="id2580058"></a>もちろん、認証バックエンド自体はSambaがサポートしている分散ディレクトリ構造のサーバなら、いずれでも構わない。LDAP(OpenLDAPベース) 、SunのiPlanet、Novellの e-Directoryなどが使用可能である。</em></span></p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><a class="indexterm" name="id2580079"></a><a class="indexterm" name="id2580085"></a><a class="indexterm" name="id2580093"></a>SambaがLDAPやその他のアイデンティティ管理、あるいは、ディレクトリサービスを使用するように設定される場合、ユーザ及びマシン認証を継続して実行するのはSambaである。Sambaが行う認証をLDAPサーバが代替するわけではないことに注意。</p></div><p><a class="indexterm" name="id2580113"></a><a class="indexterm" name="id2580121"></a><a class="indexterm" name="id2580128"></a>ドメインメンバサーバーのドメインマシンアカウント作成に関する詳細情報やSambaドメインメンバマシンがドメインに参加し完全に信頼されるようにする方法に関しては、<a class="link" href="samba-pdc.html" title="Chapter 4. ドメイン制御">ドメイン管理</a>の章を参照のこと。</p><div class="sect2" title="Samba-3でNT4形式でのドメインに参加する"><div class="titlepage"><div><div><h3 class="title"><a name="id2580152"></a>Samba-3でNT4形式でのドメインに参加する</h3></div></div></div><p><a class="link" href="domain-member.html#assumptions" title="Table 6.1. 前提">下記の表</a>に、この後この章で使用される名前を示す。</p><div class="table"><a name="assumptions"></a><p class="title"><b>Table 6.1. 前提</b></p><div class="table-contents"><table summary="前提" border="1"><colgroup><col align="right"><col align="left"></colgroup><tbody><tr><td align="right">Samba DMSのNetBIOS名:</td><td align="left">SERV1</td></tr><tr><td align="right">Windows 200x/NTドメイン名:</td><td align="left">MIDEARTH</td></tr><tr><td align="right">ドメインのPDCのNetBIOS名:</td><td align="left">DOMPDC</td></tr><tr><td align="right">ドメインのBDCのNetBIOS名:</td><td align="left">DOMBDC1とDOMBDC2</td></tr></tbody></table></div></div><br class="table-break"><p><a class="indexterm" name="id2580239"></a>まず<code class="filename">smb.conf</code>ファイルを編集し、Sambaが以後ドメインセキュリティを使用するように設定しなければならない。</p><p><a class="indexterm" name="id2580256"></a><a class="indexterm" name="id2580263"></a><a class="indexterm" name="id2580270"></a><a class="indexterm" name="id2580277"></a><code class="filename">smb.conf</code>中の[global]セクション中に<a class="link" href="smb.conf.5.html#SECURITY" target="_top">security</a>行を、下記のように変更(又は追加)する:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2580309"></a><em class="parameter"><code>security = domain</code></em></td></tr></table><p>もしも、パラメータ<em class="parameter"><code>security = user</code></em>が使われているならば、このマシンはスタンドアロンサーバで動作するのでドメインメンバサーバではないことに注意。ドメインセキュリティモードはSambaにドメインセキュリティコンテキスト内で動作するようにさせる。</p><p>次に、<em class="parameter"><code>[global]</code></em>セクション中の<a class="link" href="smb.conf.5.html#WORKGROUP" target="_top">workgroup</a>行を下記のように修正する:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2580364"></a><em class="parameter"><code>workgroup = MIDEARTH</code></em></td></tr></table><p>これが参加するドメイン名である。</p><p><a class="indexterm" name="id2580381"></a><a class="indexterm" name="id2580388"></a>ユーザーが NT PDC で認証されるように<a class="link" href="smb.conf.5.html#ENCRYPTPASSWORDS" target="_top">encrypt passwords</a>パラメータを<code class="constant">yes</code>に設定しなければならない。もしこのパラメータが特に指定されていなければ、既定値で設定されている。このパラメータを設定する必要はないが、もしも<code class="filename">smb.conf</code>ファイル中で指定されたならば、必ず<code class="constant">Yes</code>に設定されねばならない。</p><p><a class="indexterm" name="id2580431"></a><a class="indexterm" name="id2580437"></a><a class="indexterm" name="id2580444"></a><a class="indexterm" name="id2580451"></a>最後に、[global]セクションの<a class="link" href="smb.conf.5.html#PASSWORDSERVER" target="_top">password server</a>行を下記のように追加(又は修正)する:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2580478"></a><em class="parameter"><code>password server = DOMPDC DOMBDC1 DOMBDC2</code></em></td></tr></table><p>これらはSambaがユーザ認証のために通信を行うプライマリ及びバックアップのドメインコントローラである。Sambaは各サーバに対し、リスト順に接続するので、複数のドメインコントローラの間で認証負荷を分散するためには、このリストの順番を適宜変更してもよい。</p><p><a class="indexterm" name="id2580502"></a><a class="indexterm" name="id2580510"></a><a class="indexterm" name="id2580517"></a><a class="indexterm" name="id2580524"></a>代わりに、認証に使用するドメインコントローラのリストを smbdが自動的に決めるようにしたい場合、この行を次のように設定する:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2580543"></a><em class="parameter"><code>password server = *</code></em></td></tr></table><p><a class="indexterm" name="id2580555"></a>この方法で、NTと全く同じメカニズムをSambaが使用するようにできる。この方法はブロードキャストベースの名前解決を使用するか、WINS データベースの検索により認証するドメインコントローラを決めるか、DNSによる名前解決によりドメインコントローラを見つける。</p><p>ドメインに参加するために次のコマンドを実行する:<a class="indexterm" name="id2580578"></a></p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>net rpc join -S DOMPDC -U<em class="replaceable"><code>Administrator%password</code></em></code></strong></pre><p></p><p><a class="indexterm" name="id2580611"></a><a class="indexterm" name="id2580618"></a><a class="indexterm" name="id2580625"></a><a class="indexterm" name="id2580632"></a>もしも、<code class="option">-S DOMPDC</code>引数が与えられない場合、ドメイン名は<code class="filename">smb.conf</code>から入手し、PDCのNetBIOS名は、WINS検索を使うか、NetBIOSブロードキャストベースの名前検索のどちらかで入手する。</p><p><a class="indexterm" name="id2580659"></a><a class="indexterm" name="id2580666"></a><a class="indexterm" name="id2580672"></a><a class="indexterm" name="id2580679"></a>マシンがDOMドメインに参加しようとしていて、そのドメインのPDC(ドメインのSAMデータベースへの書き込み権限のある唯一のマシン)がDOMPDCなので、<code class="option">-S</code>オプションを使用する。<em class="replaceable"><code>Administrator%password</code></em>は、はマシンをドメインに追加するのに必要な権限を持つアカウントのログイン名とパスワードである。これが成功すれば、使用しているターミナルの画面に下のようなメッセージが表示される。古いNT4式のドメイン環境使用の場合:</p><pre class="screen"><code class="computeroutput">Joined domain DOM.</code></pre><p></p><p><a class="indexterm" name="id2580727"></a><a class="indexterm" name="id2580738"></a><a class="indexterm" name="id2580745"></a>Active Directory使用の場合、ADSドメインへ参加するためのコマンドは以下の通り:</p><pre class="screen"><code class="prompt">root# </code> net ads join -U<em class="replaceable"><code>Administrator%password</code></em></pre><p>成功すると以下の結果が表示される:</p><pre class="screen"><code class="computeroutput">Joined SERV1 to realm MYREALM.</code></pre><p></p><p>詳細情報については、<code class="literal">net</code>のマニュアルページと<a class="link" href="NetCommand.html" title="Chapter 13. リモートとローカル管理:Netコマンド">リモート管理の章</a>を参照のこと。</p><p><a class="indexterm" name="id2580806"></a><a class="indexterm" name="id2580813"></a><a class="indexterm" name="id2580821"></a>この手順により、事前にPDC上でマシン信頼アカウントを作成する必要はなく、サーバがドメインに接続できる。</p><p><a class="indexterm" name="id2580836"></a><a class="indexterm" name="id2580846"></a><a class="indexterm" name="id2580853"></a><a class="indexterm" name="id2580860"></a>このコマンドは、マシンアカウントパスワード変更プロトコルを通して、Sambaサーバの新規(任意の)マシンアカウントパスワードを、smbpasswdファイルが通常格納されているディレクトリと同じディレクトリにあるファイルに書き込む。DMSによって必要とされる信頼アカウント情報は<code class="filename">/usr/local/samba/private/secrets.tdb</code>か<code class="filename">/etc/samba/secrets.tdb</code>ファイル中に書かれる。</p><p><a class="indexterm" name="id2580894"></a><a class="indexterm" name="id2580901"></a>このファイルはrootにより作成・所有され、root 以外のユーザは読めない。これが、システムのドメインレベルのセキュリティの鍵を握る部分であり、シャドウパスワードファイル同様に慎重に扱わなければならない。</p><p><a class="indexterm" name="id2580922"></a><a class="indexterm" name="id2580929"></a><a class="indexterm" name="id2580936"></a>最後に、Sambaのdaemonを再起動し、クライアントがドメインセキュリティを使用開始する準備をする。Samba デーモンの再起動方法はディストリビューションにもよるが、ほとんどの場合は次のとおりである:</p><pre class="screen"><code class="prompt">root# </code>/etc/init.d/samba restart</pre><p></p></div><div class="sect2" title="これがなぜsecurity = serverよりもすぐれているのか?"><div class="titlepage"><div><div><h3 class="title"><a name="id2580966"></a>これがなぜ<em class="parameter"><code>security = server</code></em>よりもすぐれているのか?</h3></div></div></div><p><a class="indexterm" name="id2580981"></a><a class="indexterm" name="id2580988"></a><a class="indexterm" name="id2580995"></a>現在、Samba のドメインセキュリティでは、サーバに紐づくユーザに対応するローカルUNIXユーザを作成しなければならない。このことは、もしも、ドメインユーザ<code class="constant">DOM\fred</code>がドメインセキュリティのSambaサーバーに紐づく場合、UNIXファイルシステム上にそれに対応するfred というローカル UNIXユーザーがいなければならないことを意味する。これは以前のSambaのセキュリティモードである<a class="link" href="smb.conf.5.html#SECURITY" target="_top">security = server</a>と似ているが、このモードでは、Windows 95又はWindows 98サーバと同じように、 Sambaが認証リクエストをWindows NT サーバーに回送していた。</p><p><a class="indexterm" name="id2581041"></a><a class="indexterm" name="id2581047"></a><a class="indexterm" name="id2581054"></a>UNIX の UID 及び GID を自動的に Windows NT ドメインユーザ及びグループへ割り当てるシステムについての情報は<a class="link" href="winbind.html" title="Chapter 24. Winbind: ドメインアカウントの使用">Winbind: ドメインアカウントの使用</a>を参照のこと。</p><p><a class="indexterm" name="id2581078"></a><a class="indexterm" name="id2581085"></a><a class="indexterm" name="id2581092"></a>ドメインレベルのセキュリティの利点は、NT サーバと全く同じように、ドメインレベルセキュリティにおける認証が、認証されたRPC チャンネルを通ることである。これは、Sambaサーバが NT サーバと全く同じやり方でドメインの信頼関係に参加できることを意味する(すなわち、Sambaサーバをリソースドメインに追加し、リソースドメインPDC からアカウントドメイン PDC に認証を渡してもらうことができる)。</p><p><a class="indexterm" name="id2581112"></a><a class="indexterm" name="id2581118"></a><a class="indexterm" name="id2581125"></a>さらに、<a class="link" href="smb.conf.5.html#SECURITY" target="_top">security = server</a>(訳注:サーバレベルのセキュリティ)を使う場合、サーバ上のすべてのSambaデーモンは、起動している限り認証サーバーと接続し続けなければならない。これはMicrosoft NTサーバの接続リソースを使い果たし、利用可能な接続がなくなることになりかねない。それに対し<a class="link" href="smb.conf.5.html#SECURITY" target="_top">security = domain</a>(訳注:ドメインレベルのセキュリティ)の場合は、Sambaデーモンはユーザー認証に必要な時のみPDC/BDCに接続し、その後接続を切断する。これにより PDC の接続リソースを節約することができる。</p><p><a class="indexterm" name="id2581177"></a><a class="indexterm" name="id2581183"></a><a class="indexterm" name="id2581189"></a><a class="indexterm" name="id2581196"></a>最後に、NT サーバと同じように PDC 認証を行うということは、認証の返答の一部として、ユーザ SIDやユーザが属する NTグループなどのユーザ識別情報を、Samba サーバーが受け取ることを意味する。</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>この文書の内容の大半は、ウェブマガジン<a class="ulink" href="http://www.linuxworld.com" target="_top"><span class="emphasis"><em>LinuxWorld</em></span></a>の記事<a class="ulink" href="http://www.linuxworld.com/linuxworld/lw-1998-10/lw-10-samba.html" target="_top">http://www.linuxworld.com/linuxworld/lw-1998-10/lw-10-samba.html</a><span class="emphasis"><em>Doing the NIS/NT Samba</em></span>として最初に発表された(訳注:リンク切れ)。</p></div></div></div><div class="sect1" title="Samba ADS ドメインメンバシップ"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ads-member"></a>Samba ADS ドメインメンバシップ</h2></div></div></div><p><a class="indexterm" name="id2581253"></a><a class="indexterm" name="id2581260"></a><a class="indexterm" name="id2581269"></a><a class="indexterm" name="id2581276"></a>これは、Windows 200x KDC に対し Kerberos認証を行うSamba-3の設定方法の概略である。Kerberosの知識を有することを前提としている。</p><div class="sect2" title="smb.confの設定"><div class="titlepage"><div><div><h3 class="title"><a name="id2581290"></a><code class="filename">smb.conf</code>の設定</h3></div></div></div><p>最低以下の3つのオプションを<code class="filename">smb.conf</code>で使用しなければならない:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2581317"></a><em class="parameter"><code>realm = your.kerberos.REALM</code></em></td></tr><tr><td><a class="indexterm" name="id2581328"></a><em class="parameter"><code>security = ADS</code></em></td></tr><tr><td># もしも存在するときのみ、以下のパラメータを指定する必要がある。</td></tr><tr><td># もしも存在しないときの既定値はYesである。</td></tr><tr><td><a class="indexterm" name="id2581352"></a><em class="parameter"><code>encrypt passwords = yes</code></em></td></tr></table><p><a class="indexterm" name="id2581366"></a><a class="indexterm" name="id2581373"></a><a class="indexterm" name="id2581379"></a><a class="indexterm" name="id2581386"></a><a class="indexterm" name="id2581393"></a>Samba がレルム名を使用して適切な ADS サーバーを正確に識別できない場合、<code class="filename">smb.conf</code>中の<a class="link" href="smb.conf.5.html#PASSWORDSERVER" target="_top">password server</a>オプションを使用する:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2581428"></a><em class="parameter"><code>password server = your.kerberos.server</code></em></td></tr></table><p>ADSドメインコントローラを識別できない最も共通的な理由は、ADS基盤のDNS要求条件に関係なくUNIXシステム上でいくつかのDNSサーバを保守しているサイトの問題である。<em class="parameter"><code>password server</code></em>を使って、優先するADSドメインコントローラを指定することは問題ない。</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><a class="indexterm" name="id2581459"></a><a class="indexterm" name="id2581465"></a>smbpasswdファイルは<span class="emphasis"><em>必要でなく</em></span>、古いクライアントはあたかも<a class="link" href="smb.conf.5.html#SECURITY" target="_top">security = domain</a>のように認証され、何の害もなく、ドメインに入らないローカルユーザーを持つことができる。</p></div></div><div class="sect2" title="/etc/krb5.confの設定"><div class="titlepage"><div><div><h3 class="title"><a name="id2581494"></a><code class="filename">/etc/krb5.conf</code>の設定</h3></div></div></div><p><a class="indexterm" name="id2581506"></a><a class="indexterm" name="id2581513"></a><a class="indexterm" name="id2581523"></a><a class="indexterm" name="id2581530"></a>MIT 及び Heimdal Kerberosでは、<code class="filename">/etc/krb5.conf</code>の設定は必要なく、時に害となることがある。</p><p><a class="indexterm" name="id2581548"></a><a class="indexterm" name="id2581554"></a><a class="indexterm" name="id2581561"></a><a class="indexterm" name="id2581568"></a><a class="indexterm" name="id2581575"></a>Microsoft ADSは、DNSの<em class="parameter"><code>_kerberos._tcp.REALM.NAME</code></em>に、レルム内の各KDCのSRVレコードを、自動的に作成する。 これは、Active Directoryドメインを作成するために使われるインストールと設定プロセスの一部である。KDCはKerberosのキー配信センタであり、Microsoft Active Directory基盤の不可欠な部分として構成されている。</p><p><a class="indexterm" name="id2581604"></a><a class="indexterm" name="id2581611"></a><a class="indexterm" name="id2581618"></a><a class="indexterm" name="id2581624"></a><a class="indexterm" name="id2581631"></a><a class="indexterm" name="id2581638"></a>UNIXシステムは、Windows2000 KDCにで認証を行うために、kinitとDES-CBC-MD5又はDES-CBC-CRCという種類の暗号手法を使える。Windows 2000 ADSのkerberos相互運用性に関連する詳細情報は、<a class="ulink" href="http://www.microsoft.com/windows2000/techinfo/planning/security/kerbsteps.asp" target="_top">Interoperability</a>というガイドを参照のこと。もう1つの、とても有用な、Kerberosの相互運用性に関する一般的な情報として参照できる文書は、<a class="ulink" href="http://www.ietf.org/rfc/rfc1510.txt?number=1510" target="_top">RFC1510</a>である。このRFCはKerberosの操作についてのたくさんの不可思議な背景について説明している。</p><p><a class="indexterm" name="id2581680"></a><a class="indexterm" name="id2581686"></a><a class="indexterm" name="id2581693"></a><a class="indexterm" name="id2581700"></a><a class="indexterm" name="id2581707"></a><a class="indexterm" name="id2581714"></a>MITとHeimdalでは、最新のKRB5ライブラリがSRVレコードをチェックするように既定値で設定されていて、従って、自動的にKDCを見つける。さらに、<code class="filename">krb5.conf</code>は、たとえ2つ以上あったとしても単一のKDCの指定のみ許可する。DNSルックアップを使用することによりKRB5ライブラリは使用可能な任意のKDCを使用できる。</p><p><a class="indexterm" name="id2581740"></a>手動で<code class="filename">krb5.conf</code>を設定する場合の最小限の設定は次のとおり:</p><pre class="screen">[libdefaults]	default_realm = YOUR.KERBEROS.REALM[realms]	YOUR.KERBEROS.REALM = {	kdc = your.kerberos.server	}[domain_realms]	.kerberos.server = YOUR.KERBEROS.REALM</pre><p></p><p><a class="indexterm" name="id2581766"></a>Heimdal のバージョン 0.6 以前を使用する場合は次のように設定する:</p><pre class="screen">[libdefaults]	default_realm      = YOUR.KERBEROS.REALM	default_etypes     = des-cbc-crc des-cbc-md5	default_etypes_des = des-cbc-crc des-cbc-md5[realms]        YOUR.KERBEROS.REALM = {        kdc = your.kerberos.server	}[domain_realms]        .kerberos.server = YOUR.KERBEROS.REALM</pre><p></p><p><a class="indexterm" name="id2581790"></a><a class="indexterm" name="id2581797"></a><strong class="userinput"><code>kinit<em class="replaceable"><code>USERNAME</code></em>@<em class="replaceable"><code>REALM</code></em></code></strong>を実行して設定をテストし、パスワードが Windows 2000 KDC に認証されることを確認する。</p><p><a class="indexterm" name="id2581823"></a><a class="indexterm" name="id2581829"></a><a class="indexterm" name="id2581836"></a><a class="indexterm" name="id2581842"></a>Heimdal 0.6.x 以前のバージョンでは、ADSで新規に作成されたアカウントであるか、移行後にパスワードが変更されたアカウントであるか、インストール後に<code class="constant">Administrator</code>であれば使用できる。現行、Windows 2003 KDCはHeimdal のバージョン 0.6 以降のリリース(かつkrb5.conf内にetypesの既定値の設定がないもの)とのみ使用できる。残念ながらこの領域はいまだに流動的な状態である。</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><a class="indexterm" name="id2581869"></a><a class="indexterm" name="id2581876"></a><a class="indexterm" name="id2581883"></a>レルムは大文字でなければ、<span class="quote">“<span class="quote"><span class="errorname">Cannot find KDC for requested realm while getting initial credentials</span>(最初の認証情報取得時にリクエストされたレルムの KDC を見つけられない)</span>”</span>というエラーが表示される(Kerberos は大文字・小文字を区別する)。</p></div><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><a class="indexterm" name="id2581908"></a><a class="indexterm" name="id2581915"></a><a class="indexterm" name="id2581922"></a><a class="indexterm" name="id2581929"></a>2つのサーバは時間の同期を取らなければならない。もし時間差が5分以上になるとメッセージ<span class="quote">“<span class="quote"><span class="errorname">kinit(v5): Clock skew toogreat while getting initial credentials</span>(kinit(v5): 最初の認証情報取得時にクロックスキューが過大)</span>”</span>が表示される。</p></div><p><a class="indexterm" name="id2581954"></a><a class="indexterm" name="id2581961"></a>Kerberos プロトコルではクロックスキューの限界値を設定できる。既定値は5分である。</p><p><a class="indexterm" name="id2581975"></a><a class="indexterm" name="id2581981"></a><a class="indexterm" name="id2581988"></a><a class="indexterm" name="id2581995"></a>更に、使用するKDCのIP アドレスによる逆引きDNS検索をできるようにしなければならない。また、この逆引きDNS検索がマッピングする先の名前はKDCのNetBIOS名(すなわち、ドメインに紐づかないホスト名)またはレルムが後に付くNetBIOS名のどちらでもよい。</p><p><a class="indexterm" name="id2582015"></a><a class="indexterm" name="id2582022"></a><a class="indexterm" name="id2582028"></a>以上を確実に行うための最も簡単な方法は、使用するKDCのIPアドレスをマッピングする<code class="filename">/etc/hosts</code>のエントリを、KDCのNetBIOS名に追加することである。もし正しくなければ、レルムに参加しようとすると<span class="errorname">local error</span>が発生する。</p><p><a class="indexterm" name="id2582055"></a><a class="indexterm" name="id2582062"></a><a class="indexterm" name="id2582068"></a><a class="indexterm" name="id2582075"></a><span class="application">smbclient</span>中でのKerberos のサポートのみが必要な場合は、次の項は飛ばして直接<a class="link" href="domain-member.html#ads-test-smbclient" title="smbclientによるテスト"><span class="application">smbclient</span>でのテスト</a>に進むこと。<a class="link" href="domain-member.html#ads-create-machine-account" title="コンピュータアカウントの作成">コンピュータアカウントの作成</a>と<a class="link" href="domain-member.html#ads-test-server" title="サーバ設定のテスト">サーバ設定のテスト</a>は、<span class="application">smbd</span>と<span class="application">winbindd</span>でKerberosのサポートをしたい場合にのみ必要である。</p></div><div class="sect2" title="コンピュータアカウントの作成"><div class="titlepage"><div><div><h3 class="title"><a name="ads-create-machine-account"></a>コンピュータアカウントの作成</h3></div></div></div><p><a class="indexterm" name="id2582148"></a><a class="indexterm" name="id2582155"></a><a class="indexterm" name="id2582163"></a><a class="indexterm" name="id2582169"></a>Samba のプライベートディレクトリに書き込み権限があるユーザ(通常はroot)として以下を実行する:</p><pre class="screen"><code class="prompt">root# </code> <strong class="userinput"><code>net ads join -U Administrator%password</code></strong></pre><p>管理者アカウントは、ADSドメインにマシンを追加することを許可されているADSドメインセキュリティの設定中で指定された任意のアカウントでも良い。それはもちろん、Administrator以外のアカウントを使うことは良いアイデアである。UNIX/Linuxシステム上では、このコマンドはUID=0(root)であるアカウントによって実行されねばならない。</p><p><a class="indexterm" name="id2582211"></a><a class="indexterm" name="id2582218"></a><a class="indexterm" name="id2582225"></a><a class="indexterm" name="id2582232"></a><a class="indexterm" name="id2582239"></a><a class="indexterm" name="id2582246"></a>複雑な組織内でWindowsクライアントをADSドメインのメンバにする場合、特定の組織単位内でマシンアカウントを作成しても良い。Samba-3では次の構文でこれを実現できる:</p><pre class="screen"><code class="prompt">root# </code> <strong class="userinput"><code>kinit Administrator@your.kerberos.REALM</code></strong><code class="prompt">root# </code> <strong class="userinput"><code>net ads join createcomputer="organizational_unit"</code></strong></pre><p>ADS管理者は"organizational_unit"パラメータに指定すべきものを助言することも可能である。</p><p><a class="indexterm" name="id2582302"></a><a class="indexterm" name="id2582309"></a><a class="indexterm" name="id2582316"></a><a class="indexterm" name="id2582323"></a>例をあげると、ある組織ディレクトリ<span class="quote">“<span class="quote">Computers/BusinessUnit/Department,</span>”</span>の配下の<span class="quote">“<span class="quote">Servers</span>”</span>というコンテナにマシン信頼アカウントを作成したい場合は以下のようになる:</p><pre class="screen"><code class="prompt">root# </code> <strong class="userinput"><code>net ads join "Computers/BusinessUnit/Department/Servers"</code></strong></pre><p>このコマンドは、コンテナ<code class="literal">Computers/BusinessUnit/Department/Servers</code>中に、Sambaサーバのマシン信頼アカウントを置く。コンテナはこのコマンドを実行する前にADS ディレクトリ中に存在しなければならない。バックスラッシュはOU名とその他の文字に対するエスケープ文字の両方として有効な文字のため、普通のスラッシュを使わなければならないことに注意。もしもOU名にバックスラッシュを使う必要があるならば、シェルによる解釈と、LDAPによる解釈を考慮して4重にする必要がある。</p><div class="sect3" title="よくあるエラー"><div class="titlepage"><div><div><h4 class="title"><a name="id2582378"></a>よくあるエラー</h4></div></div></div><p></p><div class="variablelist"><dl><dt><span class="term"><span class="errorname">ADS サポートがコンパイルされていない</span></span></dt><dd><p>	<a class="indexterm" name="id2582399"></a>	<a class="indexterm" name="id2582406"></a>	<a class="indexterm" name="id2582412"></a>	Kerberosライブラリとヘッダファイルのインストール後に、Samba を再設定(config.cache を削除)	して、リコンパイルする(make clean all install)。	</p></dd><dt><span class="term"><span class="errorname">net ads joinがユーザー名の入力を要求する</span></span></dt><dd><p>	<a class="indexterm" name="id2582437"></a>	<a class="indexterm" name="id2582444"></a>	<strong class="userinput"><code>kinit	<em class="replaceable"><code>USERNAME</code></em>@<em class="replaceable"><code>REALM</code></em></code></strong>	を使ってドメインにログインする必要がある。	<em class="replaceable"><code>USERNAME</code></em>はマシンをドメインへ追加する権限を持つユーザーでなければならない。	</p></dd><dt><span class="term">サポートされない暗号/もしくはチェックサムタイプ</span></dt><dd><p>	<a class="indexterm" name="id2582480"></a>	<a class="indexterm" name="id2582487"></a>	<a class="indexterm" name="id2582494"></a>	<code class="filename">/etc/krb5.conf</code>システムにインストールされているKerberosの	タイプとバージョンに対して適切に設定されているか確認する。	</p></dd></dl></div><p></p></div></div><div class="sect2" title="サーバ設定のテスト"><div class="titlepage"><div><div><h3 class="title"><a name="ads-test-server"></a>サーバ設定のテスト</h3></div></div></div><p><a class="indexterm" name="id2582526"></a><a class="indexterm" name="id2582533"></a><a class="indexterm" name="id2582540"></a>参加に成功したら、Active DirectoryにSambaサーバのNetBIOS名の付いた新規のコンピュータアカウントが表示される(ユーザとコンピュータ配下の<span class="quote">“<span class="quote">コンピュータ</span>”</span>フォルダ中)。</p><p><a class="indexterm" name="id2582560"></a><a class="indexterm" name="id2582567"></a><a class="indexterm" name="id2582576"></a>Windows 2000 クライアントでは、<strong class="userinput"><code>net use * \\server\share</code></strong>を試してみること。パスワードを知らないでもKerberos にログインできるはずである。もしも失敗したら、<strong class="userinput"><code>klist tickets</code></strong>を実行すること。サーバー用のチケットを取得できたか?それには暗号タイプ DES-CBC-MD5 があるか?</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><a class="indexterm" name="id2582608"></a><a class="indexterm" name="id2582615"></a><a class="indexterm" name="id2582622"></a>SambaはDES-CBC-MD5暗号及びARCFOUR-HMAC-MD5符号を使用できる。</p></div></div><div class="sect2" title="smbclientによるテスト"><div class="titlepage"><div><div><h3 class="title"><a name="ads-test-smbclient"></a><span class="application">smbclient</span>によるテスト</h3></div></div></div><p><a class="indexterm" name="id2582650"></a><a class="indexterm" name="id2582657"></a><a class="indexterm" name="id2582663"></a>Sambaサーバ上で<span class="application">smbclient</span>とKerberosを使用してWindows2000サーバ又はSambaサーバにログインすることを試みる。<span class="application">smbclient</span>は通常通り使用するが、Kerberos認証を選択するように、<code class="option">-k</code>オプションを指定する。</p></div><div class="sect2" title="注意"><div class="titlepage"><div><div><h3 class="title"><a name="id2582693"></a>注意</h3></div></div></div><p><a class="indexterm" name="id2582700"></a><a class="indexterm" name="id2582707"></a><a class="indexterm" name="id2582714"></a>ドメインコントローラインストール後は、正しい暗号化タイプを作成するために、少なくとも一度は管理者パスワードを変更しなれけばならない。</p><p><a class="indexterm" name="id2582731"></a><a class="indexterm" name="id2582738"></a><a class="indexterm" name="id2582745"></a>Windows200xは既定値のDNS設定では<em class="parameter"><code>_kerberos._udp</code></em>や<em class="parameter"><code>_ldap._tcp</code></em>を作成しないようである。おそらく今後サービスパックで修正されるだろう。</p></div></div><div class="sect1" title="Sambaドメインメンバ間でのユーザIDマッピング共有"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2582771"></a>Sambaドメインメンバ間でのユーザIDマッピング共有</h2></div></div></div><p><a class="indexterm" name="id2582781"></a><a class="indexterm" name="id2582789"></a><a class="indexterm" name="id2582795"></a><a class="indexterm" name="id2582802"></a>SambaはUNIXユーザ及びグループ(それぞれUIDとGIDで識別される)をWindowsユーザ及びグループ(SIDで識別される)にマッピングする。これらのマッピングは Sambaの<em class="parameter"><code>idmap</code></em>サブシステムが行う。</p><p><a class="indexterm" name="id2582825"></a><a class="indexterm" name="id2582832"></a><a class="indexterm" name="id2582839"></a>これらのマッピングをSambaドメインメンバー間で共有することは、<span class="emphasis"><em>名前からIDへの</em></span>マッピングが全マシンで同一になるので便利である。特に、CIFSとNFSの両方でファイルを共有する場合に有用である。</p><p><a class="indexterm" name="id2582858"></a><a class="indexterm" name="id2582865"></a><span class="emphasis"><em>LDAP</em></span> <em class="parameter"><code>ldap idmap suffix</code></em>を使う場合、以下のように設定する:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="indexterm" name="id2582889"></a><em class="parameter"><code>ldap idmap suffix = ou=Idmap</code></em></td></tr></table><p>詳細情報については <code class="filename">smb.conf</code> マニュアルページの<a class="link" href="smb.conf.5.html#LDAPIDMAPSUFFIX" target="_top">ldap idmap suffix</a>パラメータのエントリを参照のこと。</p><p><a class="indexterm" name="id2582929"></a><a class="indexterm" name="id2582935"></a><a class="indexterm" name="id2582942"></a><a class="link" href="smb.conf.5.html#LDAPADMINDN" target="_top">ldap admin dn</a>も設定することと、<code class="filename">secrets.tdb</code>中にLDAP管理用パスワードを設定するのを忘れないこと。これには下記を使用する:</p><pre class="screen"><code class="prompt">root# </code> smbpasswd -w ldap-admin-password</pre><p><code class="literal">ldap-admin-password</code>の部分は、システムで使うLDAPサーバ管理用パスワードで置き換えること。</p></div><div class="sect1" title="よくあるエラー"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2582992"></a>よくあるエラー</h2></div></div></div><p><a class="indexterm" name="id2583000"></a><a class="indexterm" name="id2583007"></a>ドメインメンバのマシンアカウントの追加/削除/再追加の手順の中には、不注意により陥りやすい多くの落とし穴や間違いを招きかねない多くの<span class="quote">“<span class="quote">事細かな</span>”</span>ことがある。興味深いことにSambaメーリングリストの購読者の中には、マシンアカウントの追加を繰り返し失敗し、最終的にMicrosoft Windows をマシンに<span class="quote">“<span class="quote">再インストール</span>”</span>しなければならないという結論を出す人がよくいる。しかし、実際はこのような種類の問題で再インストールが必要になることはめったにない。正しい解決法は単純である場合が多く、Microsoft Windowsのネットワーク機能を理解していれば容易に解決できる。</p><div class="sect2" title="マシンをドメインに追加し直すことができない"><div class="titlepage"><div><div><h3 class="title"><a name="id2583043"></a>マシンをドメインに追加し直すことができない</h3></div></div></div><p><a class="indexterm" name="id2583052"></a><a class="indexterm" name="id2583059"></a><span class="quote">“<span class="quote">Windowsワークステーションを再インストールした。元々のドメインマシンアカウントが削除されその直後に再度追加された。同じマシン名を使用するとワークステーションはドメインに参加できない。マシンの追加に失敗する際に、マシンはネットワーク上に存在していないにもかかわらず、マシンが既に存在するというメッセージが表示される。なぜこのように失敗するのか?</span>”</span></p><p><a class="indexterm" name="id2583086"></a><a class="indexterm" name="id2583094"></a>前の名前がまだNetBIOS 名キャッシュに残っているためである。マシンアカウントが削除されると、同じ名前のマシンをドメインメンバとして再度追加できるようになるには、まず、その名前が期限切れにならなければならない。最もよい方法は、古いアカウントを削除し、新しい名前でマシンを追加することである。そのほかに、Windows上のクライアントから以下の<code class="literal">nbtstat</code>コマンドを使って、名前キャッシュにある現在のデータをフラッシュし、再ロードする。</p><pre class="screen"><code class="prompt">C:\> </code> nbtstat -R</pre><p></p></div><div class="sect2" title="マシンのドメインへの追加に失敗する"><div class="titlepage"><div><div><h3 class="title"><a name="id2583134"></a>マシンのドメインへの追加に失敗する</h3></div></div></div><p><a class="indexterm" name="id2583143"></a><a class="indexterm" name="id2583149"></a><span class="quote">“<span class="quote">Windows200xもしくはXP ProfessionalマシンをSamba PDCドメインに追加しようとすると失敗する。エラーメッセージは<span class="errorname">今回はネットワークの問題によりマシンを追加できませんでした。後ほどやり直して下さい。</span>である(訳注:実際に表示されるメッセージとは違います)。なぜか?</span>”</span></p><p><a class="indexterm" name="id2583176"></a><code class="filename">smb.conf</code>ファイル中に<a class="link" href="smb.conf.5.html#ADDMACHINESCRIPT" target="_top">add machine script</a>があることを確認する。もしも存在していないならば、OSプラットフォームに適したスクリプトを追加する。もしも、スクリプトがすでに定義されているならば、その動作をデバッグする必要がある。<code class="filename">smb.conf</code>ファイル中の<a class="link" href="smb.conf.5.html#LOGLEVEL" target="_top">log level</a>の値を10まで増やし、ドメインへの参加を試行してみる。そのログをチェックし、どの動作が失敗しているか突き止める。</p><p>可能性のある原因:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><a class="indexterm" name="id2583238"></a><a class="indexterm" name="id2583244"></a>	スクリプトが実際には存在していないか、指定したパスにない。	</p><p><a class="indexterm" name="id2583257"></a><a class="indexterm" name="id2583265"></a>	<span class="emphasis"><em>是正処置:</em></span>修正する。スクリプトを手動で実行すると、UNIX システム	アカウントとSamba SAM アカウントの両方が追加されることを確認する。	</p></li><li class="listitem"><p><a class="indexterm" name="id2583284"></a><a class="indexterm" name="id2583291"></a>	マシンをUNIXシステムアカウントファイル<code class="filename">/etc/passwd</code>に追加できない。	</p><p><a class="indexterm" name="id2583310"></a><a class="indexterm" name="id2583316"></a>	<span class="emphasis"><em>是正処置:</em></span>マシン名が有効なUNIXシステムアカウント名であるか確認する。	もしもUNIXユーティリティ<code class="literal">useradd</code>が呼び出されるならば、このツールを	使用して追加したいマシン名を追加できることを確認する。一部のシステム上の	<code class="literal">Useradd</code>は大文字やスペースを名前に使用することを許可しない。	</p></li></ul></div><p><a class="indexterm" name="id2583349"></a><a class="indexterm" name="id2583356"></a><a class="indexterm" name="id2583364"></a><a class="link" href="smb.conf.5.html#ADDMACHINESCRIPT" target="_top">add machine script</a>はSamba バックエンドデータベースでは、マシンアカウントを作成しない。Sambaバックエンドデータベースアカウントがマッピングされる先のUNIXシステムアカウントを作成するためにのみあるものである。</p></div><div class="sect2" title="Windows 2003 PDC に参加できない"><div class="titlepage"><div><div><h3 class="title"><a name="id2583391"></a>Windows 2003 PDC に参加できない</h3></div></div></div><p><a class="indexterm" name="id2583400"></a><a class="indexterm" name="id2583407"></a><a class="indexterm" name="id2583413"></a><a class="indexterm" name="id2583420"></a>	Windows 2003はSMB署名を必要とする。クライアント側のSMB署名はSamba-3.0で	実現されている。Windows 2003サーバと通信する際には	<a class="link" href="smb.conf.5.html#CLIENTUSESPNEGO" target="_top">client use spnego = yes</a>に設定する。	この機能は、クライアントは単純にそれ自身とサーバと両方がサポートする	プロトコルをネゴシエートするので、Windows 2003が持つより高度なセキュリティ	機能をサポートしない他のWindowsクライアントとインタフェースを取れない。	これは、SMB/CIFSプロトコル中で構築されているよく知られたフォールバック	機能である。	</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="samba-bdc.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="type.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="StandAloneServer.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 5. バックアップドメインコントローラ </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 7. スタンドアロンサーバ</td></tr></table></div></body></html>