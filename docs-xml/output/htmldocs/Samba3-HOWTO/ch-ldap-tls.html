<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Chapter 46. LDAPとトランスポート層のセキュリティ</title><link rel="stylesheet" href="../samba.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="公式のSamba 3.2.x HOWTOとリファレンスガイド"><link rel="up" href="Appendix.html" title="Part VI. Reference Section"><link rel="prev" href="speed.html" title="Chapter 45. Sambaパフォーマンスチューニング"><link rel="next" href="ch47.html" title="第47章 Samba サポート"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 46. LDAPとトランスポート層のセキュリティ</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="speed.html">Prev</a> </td><th width="60%" align="center">Part VI. Reference Section</th><td width="20%" align="right"> <a accesskey="n" href="ch47.html">Next</a></td></tr></table><hr></div><div class="chapter" title="Chapter 46. LDAPとトランスポート層のセキュリティ"><div class="titlepage"><div><div><h2 class="title"><a name="ch-ldap-tls"></a>Chapter 46. LDAPとトランスポート層のセキュリティ</h2></div><div><div class="author"><h3 class="author"><span class="firstname">Gavin</span> <span class="surname">Henry</span></h3><div class="affiliation"><span class="orgname">Suretec Systems Limited, UK<br></span><div class="address"><p><code class="email"><<a class="email" href="mailto:ghenry@suretecsystems.com">ghenry@suretecsystems.com</a>></code></p></div></div></div></div><div><p class="pubdate">July 8, 2005</p></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="ch-ldap-tls.html#s1-intro-ldap-tls">概要</a></span></dt><dt><span class="sect1"><a href="ch-ldap-tls.html#s1-config-ldap-tls">設定</a></span></dt><dd><dl><dt><span class="sect2"><a href="ch-ldap-tls.html#s1-config-ldap-tls-certs">認証局の作成</a></span></dt><dt><span class="sect2"><a href="ch-ldap-tls.html#s1-config-ldap-tls-server">サーバ証明書の生成</a></span></dt><dt><span class="sect2"><a href="ch-ldap-tls.html#s1-config-ldap-tls-install">証明書のインストール</a></span></dt></dl></dd><dt><span class="sect1"><a href="ch-ldap-tls.html#s1-test-ldap-tls">評価</a></span></dt><dt><span class="sect1"><a href="ch-ldap-tls.html#s1-int-ldap-tls">トラブルシューティング</a></span></dt></dl></div><div class="sect1" title="概要"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="s1-intro-ldap-tls"></a>概要</h2></div></div></div><p>	<a class="indexterm" name="id2716993"></a><a class="indexterm" name="id2717003"></a>	現在に至るまで、ACLのような、いくつかの高度な機能を含む、	<span class="trademark">OpenLDAP</span>™の簡単な設定について議論してきた。	しかし、ネットワーク上の通信が引き続き平文であるという現状には対応しない。	これが、<em class="firstterm">Transport Layer Security (TLS)</em>が導入された	理由である。	</p><p><a class="indexterm" name="id2717029"></a>	<span class="trademark">OpenLDAP</span>™クライアントとサーバは、	<a class="ulink" href="http://rfc.net/rfc2830.html" target="_top">RFC 2830</a>(訳注:現在は	<a class="ulink" href="http://rfc.net/rfc4513.html" target="_top">RFC 4513</a>が最新)	<span class="emphasis"><em>Lightweight Directory Access Protocol (v3):        Extension for Transport Layer Security.</em></span>	による、完全性と機密性を提供するため、Transport Layer Security (TLS)を使う	能力がある。	</p><p><a class="indexterm" name="id2717067"></a>	TLSはX.509証明書を使う。すべてのサーバは有効な証明書を持つ必要があるが、	クライアント証明書はあってもなくてもよい。ここではサーバ証明書のみを	議論の対象とする。	</p><div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p><a class="indexterm" name="id2717087"></a><a class="indexterm" name="id2717093"></a><a class="indexterm" name="id2717100"></a>	サーバ証明書のDNはサーバの名前を指定するCN属性を使う必要があり、CNは、サーバの、	完全に記述されたドメイン名(FQDN)を引き継ぐ必要がある。追加の別名と	ワイルドカードは、<code class="option">subjectAltName</code>証明書エクステンションに存在しても	よい。サーバ証明書の名前についてのより詳細については、	<a class="ulink" href="http://rfc.net/rfc2830.html" target="_top">RFC2830</a>にある。	</p></div><p>	これについては次の節で詳細に説明する。	</p></div><div class="sect1" title="設定"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="s1-config-ldap-tls"></a>設定</h2></div></div></div><p>	<a class="indexterm" name="id2717147"></a>	これから重要なところを説明する。	</p><div class="sect2" title="認証局の作成"><div class="titlepage"><div><div><h3 class="title"><a name="s1-config-ldap-tls-certs"></a>認証局の作成</h3></div></div></div><p><a class="indexterm" name="id2717172"></a>	適切な証明書を作成するために、固有の認証局(CA)を立てる必要がある。	<sup>[<a name="id2717185" href="#ftn.id2717185" class="footnote">8</a>]</sup>	これは必要であり、そうすると、サーバ証明書に署名できる。	</p><p><a class="indexterm" name="id2717217"></a>	これに対しては、ほとんどの<span class="trademark">Linux</span>®	ディストリビューションに含まれている<a class="ulink" href="http://www.openssl.org" target="_top">OpenSSL</a>	<sup>[<a name="id2717239" href="#ftn.id2717239" class="footnote">9</a>]</sup>	を使うことになる。	</p><p>	TLSは多くの種類のサーバによって使われるが、その手続きは、	<sup>[<a name="id2717254" href="#ftn.id2717254" class="footnote">10</a>]</sup>	ここで説明されていて、<span class="application">OpenLDAP</span> に特化している。	</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>	以下の例における<span class="emphasis"><em>Common Name (CN)</em></span>は、使用しているLDAPサーバの	完全に記述されたドメイン名(FQDN)で<span class="emphasis"><em>なければならない</em></span>。	</p></div><p>	最初に認証局(CA)を生成する必要がある:</p><pre class="screen" width="90"><code class="computeroutput"><code class="prompt">root# </code> mkdir myCA</code></pre><p>	そのディレクトリに移動する:</p><pre class="screen" width="90"><code class="computeroutput"><code class="prompt">root# </code> cd myCA</code></pre><p>	Now generate the CA:<sup>[<a name="id2717336" href="#ftn.id2717336" class="footnote">11</a>]</sup></p><pre class="screen" width="90"><code class="computeroutput"><code class="prompt">root# </code> /usr/share/ssl/misc/CA.pl -newcaCA certificate filename (or enter to create)  Making CA certificate ...Generating a 1024 bit RSA private key.......................++++++.............................++++++writing new private key to './demoCA/private/cakey.pem'Enter PEM pass phrase:Verifying - Enter PEM pass phrase:-----You are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter '.', the field will be left blank.-----Country Name (2 letter code) [AU]:AUState or Province Name (full name) [Some-State]:NSWLocality Name (eg, city) []:SydneyOrganization Name (eg, company) [Internet Widgits Pty Ltd]:AbmasOrganizational Unit Name (eg, section) []:ITCommon Name (eg, YOUR name) []:ldap.abmas.bizEmail Address []:support@abmas.biz</code></pre><p>	</p><p>	注意すべき点がいくつかある。	</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>			サーバの証明書に署名するのに必要なので、			パスワードを<span class="emphasis"><em>覚えておく必要がある</em></span>。			</p></li><li class="listitem"><p>			<span class="emphasis"><em>Common Name (CN)</em></span>は使用しているLDAPサーバの			完全に記述されたドメイン名(FQDN)で<span class="emphasis"><em>なければならない</em></span>。			</p></li></ol></div></div><div class="sect2" title="サーバ証明書の生成"><div class="titlepage"><div><div><h3 class="title"><a name="s1-config-ldap-tls-server"></a>サーバ証明書の生成</h3></div></div></div><p>	次にサーバ証明書を生成する必要がある:</p><pre class="screen" width="90"><code class="computeroutput"><code class="prompt">root# </code> openssl req -new -nodes -keyout newreq.pem -out newreq.pemGenerating a 1024 bit RSA private key.............++++++........................................................++++++writing new private key to 'newreq.pem'-----You are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter '.', the field will be left blank.-----Country Name (2 letter code) [AU]:AUState or Province Name (full name) [Some-State]:NSWLocality Name (eg, city) []:SydneyOrganization Name (eg, company) [Internet Widgits Pty Ltd]:AbmasOrganizational Unit Name (eg, section) []:ITCommon Name (eg, YOUR name) []:ldap.abmas.bizEmail Address []:support@abmas.biz  Please enter the following 'extra' attributesto be sent with your certificate requestA challenge password []:An optional company name []:</code></pre><p>	</p><p>	繰り返すが、ここでもいくつか注意すべき事がある。	</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>			パスワードを入力<span class="emphasis"><em>すべきではない</em></span>。			</p></li><li class="listitem"><p>                        <span class="emphasis"><em>Common Name (CN)</em></span>は使用しているLDAPサーバの                        完全に記述されたドメイン名(FQDN)で<span class="emphasis"><em>なければならない</em></span>。			</p></li></ol></div><p>	次に新しい認証局(CA)の証明書に署名する:</p><pre class="screen" width="90"><code class="computeroutput"><code class="prompt">root# </code> /usr/share/ssl/misc/CA.pl -signUsing configuration from /etc/ssl/openssl.cnfEnter pass phrase for ./demoCA/private/cakey.pem:Check that the request matches the signatureSignature okCertificate Details:Serial Number: 1 (0x1)Validity	Not Before: Mar  6 18:22:26 2005 EDT	Not After : Mar  6 18:22:26 2006 EDTSubject:	countryName               = AU	stateOrProvinceName       = NSW	localityName              = Sydney	organizationName          = Abmas	organizationalUnitName    = IT	commonName                = ldap.abmas.biz	emailAddress              = support@abmas.bizX509v3 extensions:	X509v3 Basic Constraints:	    CA:FALSE	Netscape Comment:	    OpenSSL Generated Certificate	X509v3 Subject Key Identifier:	    F7:84:87:25:C4:E8:46:6D:0F:47:27:91:F0:16:E0:86:6A:EE:A3:CE	X509v3 Authority Key Identifier:	    keyid:27:44:63:3A:CB:09:DC:B1:FF:32:CC:93:23:A4:F1:B4:D5:F0:7E:CC	    DirName:/C=AU/ST=NSW/L=Sydney/O=Abmas/OU=IT/						CN=ldap.abmas.biz/emailAddress=support@abmas.biz	    serial:00Certificate is to be certified until Mar  6 18:22:26 2006 EDT (365 days)Sign the certificate? [y/n]:y1 out of 1 certificate requests certified, commit? [y/n]yWrite out database with 1 new entriesData Base UpdatedSigned certificate is in newcert.pem</code></pre><p>	</p><p>	これでサーバ証明書の生成が完了する。	</p></div><div class="sect2" title="証明書のインストール"><div class="titlepage"><div><div><h3 class="title"><a name="s1-config-ldap-tls-install"></a>証明書のインストール</h3></div></div></div><p>	次に、正しい設定ディレクトリ中に証明書をコピーする必要があり、その後同時に改名して	(利便性のために)、所有権を変更し、最後にアクセス許可を与える:</p><pre class="screen" width="90"><code class="computeroutput"><code class="prompt">root# </code> cp demoCA/cacert.pem /etc/openldap/<code class="prompt">root# </code> cp newcert.pem /etc/openldap/servercrt.pem<code class="prompt">root# </code> cp newreq.pem /etc/openldap/serverkey.pem<code class="prompt">root# </code> chown ldap.ldap /etc/openldap/*.pem<code class="prompt">root# </code> chmod 640 /etc/openldap/cacert.pem;<code class="prompt">root# </code> chmod 600 /etc/openldap/serverkey.pem</code></pre><p>	</p><p>	次に、これらのファイル位置情報を、以下のようにして、<code class="filename">slapd.conf</code>	の、<code class="option">database</code>定義の前のどこかに追加する必要がある:</p><pre class="screen" width="90"><code class="computeroutput">TLSCertificateFile /etc/openldap/servercrt.pemTLSCertificateKeyFile /etc/openldap/serverkey.pemTLSCACertificateFile /etc/openldap/cacert.pem</code></pre><p>	</p><p>	以下は、<code class="filename">ldap.conf</code>での定義である:<code class="filename">ldap.conf</code></p><pre class="screen" width="90"><code class="computeroutput">TLS_CACERT /etc/openldap/cacert.pem</code></pre><p>	</p><p>	これですべてである。次に<a class="xref" href="ch-ldap-tls.html#s1-test-ldap-tls" title="評価">the section called “評価”</a>を行う。	</p></div></div><div class="sect1" title="評価"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="s1-test-ldap-tls"></a>評価</h2></div></div></div><p><a class="indexterm" name="id2717762"></a>ここは簡単な部分である。サーバを再起動する:</p><pre class="screen" width="90"><code class="computeroutput"><code class="prompt">root# </code> /etc/init.d/ldap restartStopping slapd:                                            [  OK  ]Checking configuration files for slapd: config file testing succeededStarting slapd:                                            [  OK  ]</code></pre><p>	次に、<code class="literal">ldapsearch</code>を使い、<code class="option">-ZZ</code>オプションを使って	<sup>[<a name="id2717808" href="#ftn.id2717808" class="footnote">12</a>]</sup>	匿名検索で評価する:</p><pre class="screen" width="90"><code class="computeroutput"><code class="prompt">root# </code> ldapsearch -x -b "dc=ldap,dc=abmas,dc=biz" \        -H 'ldap://ldap.abmas.biz:389' -ZZ</code></pre><p>	以下のように、サーバを再起動する前と結果は同じであるべきである:</p><pre class="screen" width="90"><code class="computeroutput"><code class="prompt">root# </code> ldapsearch -x -b "dc=ldap,dc=abmas,dc=biz" \    -H 'ldap://ldap.abmas.biz:389' -ZZ# extended LDIF## LDAPv3# base <> with scope sub# filter: (objectclass=*)# requesting: ALL## abmas.bizdn: dc=ldap,dc=abmas,dc=bizobjectClass: dcObjectobjectClass: organizationo: Abmasdc: abmas# Manager, ldap.abmas.bizdn: cn=Manager,dc=ldap,dc=abmas,dc=bizobjectClass: organizationalRolecn: Manager# ABMAS, abmas.bizdn: sambaDomainName=ABMAS,dc=ldap,dc=abmas,dc=bizsambaDomainName: ABMASsambaSID: S-1-5-21-238355452-1056757430-1592208922sambaAlgorithmicRidBase: 1000objectClass: sambaDomainsambaNextUserRid: 67109862sambaNextGroupRid: 67109863</code></pre><p>	何か問題が起きた場合は、<a class="xref" href="ch-ldap-tls.html#s1-int-ldap-tls" title="トラブルシューティング">the section called “トラブルシューティング”</a>を読んでみてほしい。</p></div><div class="sect1" title="トラブルシューティング"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="s1-int-ldap-tls"></a>トラブルシューティング</h2></div></div></div><p><a class="indexterm" name="id2717910"></a>TLSを設定しているときに最もよくあるエラーは、何回も説明したように、<a class="xref" href="ch-ldap-tls.html#s1-config-ldap-tls-server" title="サーバ証明書の生成">the section called “サーバ証明書の生成”</a>で入力した<span class="emphasis"><em>Common Name (CN)</em></span>が、使用しているLDAPサーバの、完全に記述されたドメイン名(FQDN)<span class="emphasis"><em>でない</em></span>というものである。</p><p>他のエラーとしては、<code class="literal">ldapsearch</code>コマンドのどこかでタイプミスしたとか、<code class="filename">servercrt.pem</code>と<code class="filename">cacert.pem</code>に間違ったアクセス許可を設定しているかである。<a class="xref" href="ch-ldap-tls.html#s1-config-ldap-tls-install" title="証明書のインストール">the section called “証明書のインストール”</a>単位に<code class="literal">chmod 640</code>で設定すべきである。</p><p>それ以外は、ldapのログファイルを読むか、<span class="application">OpenLDAP</span>メーリングリストに参加するのが最も良い方法である。</p></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.id2717185" href="#id2717185" class="para">8</a>] </sup>しかし、作成したサーバ証明書は、たとえば、	<a class="ulink" href="http://www.thawte.com/" target="_top">Thawte</a>と	<a class="ulink" href="http://www.verisign.com/" target="_top">VeriSign</a>のような、有料または	<a class="ulink" href="http://www.cacert.org/" target="_top">CAcert</a>経由の、無料のものを使って、	適切なCAによって署名されるようにできる。</p></div><div class="footnote"><p><sup>[<a name="ftn.id2717239" href="#id2717239" class="para">9</a>] </sup>固有の認証局(CA)を作ることの不都合な点は、商用のものがそうであるように、	証明書がクライアントによって自動的に認識されないということである。</p></div><div class="footnote"><p><sup>[<a name="ftn.id2717254" href="#id2717254" class="para">10</a>] </sup>一番確かなところからの情報は、	<a class="ulink" href="http://www.openssl.org/docs/HOWTO/" target="_top">http://www.openssl.org/docs/HOWTO/</a>	のmain OpenSSLサイトを参照のこと。</p></div><div class="footnote"><p><sup>[<a name="ftn.id2717336" href="#id2717336" class="para">11</a>] </sup>Your <code class="filename">CA.pl</code> or <code class="filename">CA.sh</code> might not be	in the same location as mine is, you can find it by using the <code class="literal">locate</code> command, i.e.,	<code class="literal">locate CA.pl</code>.  If the command complains about the database being too old, run	<code class="literal">updatedb</code> as <span class="emphasis"><em>root</em></span> to update it.</p></div><div class="footnote"><p><sup>[<a name="ftn.id2717808" href="#id2717808" class="para">12</a>] </sup><code class="literal">man ldapsearch</code>を参照</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="speed.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="Appendix.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch47.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 45. Sambaパフォーマンスチューニング </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 第47章 Samba サポート</td></tr></table></div></body></html>