<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE refentry PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<refentry id="vfs_smb_traffic_analyzer.8">

<refmeta>
	<refentrytitle>smb_traffic_analyzer</refentrytitle>
	<manvolnum>8</manvolnum>
	<refmiscinfo class="source">Samba</refmiscinfo>
	<refmiscinfo class="manual">システム管理ツール</refmiscinfo>
	<refmiscinfo class="version">4.0</refmiscinfo>
</refmeta>


<refnamediv>
	<refname>vfs_smb_traffic_analyzer</refname>
	<refpurpose>Samba VFS の読み書き動作をソケット経由でヘルパーアプリケーションに記録する
	</refpurpose>
</refnamediv>

<refsynopsisdiv>
	<cmdsynopsis>
		<command>vfs objects = smb_traffic_analyzer</command>
	</cmdsynopsis>
</refsynopsisdiv>

<refsect1>
	<title>説明</title>

	<para>このVFSモジュールは、<citerefentry><refentrytitle>samba</refentrytitle>
	<manvolnum>7</manvolnum></citerefentry>システムの一部である。</para>

	<para><command>vfs_smb_traffic_analyzer</command> VFSモジュールは、
	  Sambaサーバー上のクライアントファイル操作のログを取り、
	  このデータを、SQLデータベースに送る、ヘルパプログラム
	  (以下では"Receiver")に対して
	  ソケット上で送信する。ヘルパプログラムの詳細な情報は、
	  http://holger123.wordpress.com/smb-traffic-analyzer/
	  にあるプロジェクトホームページから得られる。
	  データに対して何かを行うReceiverに、VFSモジュールは依存するので、
	  その開発によって進化することになる。それゆえ、モジュールは異なった
	  プロトコルバージョンで動作し、receiverは、使用するプロトコルをデコード
	  出来るようにしなければならない。プロトコルバージョン1は、2008年9月25日に
	  Sambaに導入された。これはとても単純なプロトコルで、VFS操作の小さな
	  一覧のみをサポートし、いくつかの欠点があった。プロトコルバージョン2では
	  バージョン1が持っていた問題を解決することと、新しい機能追加が行われた
	  ものである。
	  Samba 4.0.0リリースから、モジュールは既定値でバージョン2のプロトコルで
	  動作する。
	</para>
</refsect1>

<refsect1>
    <title>プロトコルバージョン1の説明</title>
	<para><command>vfs_smb_traffic_analyzer</command>プロトコルバージョン1は
	以下のVFS操作を認識する:</para>

	<simplelist>
        <member>write</member>
        <member>pwrite</member>
	<member>read</member>
	<member>pread</member>
	</simplelist>

	<para><command>vfs_smb_traffic_analyzer</command> sends the following data
	in a fixed format seperated by a comma through either an internet or a
	unix domain socket:</para>
	<para><command>vfs_smb_traffic_analyzer</command>は、コンマによって分離された
	  固定フォーマットで、以下のデータを、インターネットまたはUNIXドメインソケット
	  を通じて送る:</para>
	<programlisting>
	BYTES|USER|DOMAIN|READ/WRITE|SHARE|FILENAME|TIMESTAMP
	</programlisting>

	<para>レコードの詳細:

	<itemizedlist>
	<listitem><para><command>BYTES</command> - VFS操作のバイト単位の長さ</para></listitem>
	<listitem><para><command>USER</command> - 操作を開始したユーザー</para></listitem>
	<listitem><para><command>DOMAIN</command> - ユーザーのドメイン</para></listitem>
	<listitem><para><command>READ/WRITE</command> - "W"なら書き込み操作、"R"なら読み出し操作</para></listitem>
	<listitem><para><command>SHARE</command> - VFS操作が行われた共有の名前</para></listitem>
	<listitem><para><command>FILENAME</command> - VFS操作によって使われたファイルの名前</para></listitem>
	<listitem><para><command>TIMESTAMP</command> - VFS操作が行われたことを示す "yyyy-mm-dd hh-mm-ss.ms" での時間</para></listitem>
       <listitem><para><command>IP</command> - VFS操作を開始したクライアントマシンのIPアドレス(v4又はv6)。</para></listitem>
	</itemizedlist>

	</para>

	<para>このモジュールはスタック可能である。</para>
</refsect1>

<refsect1>
	<title>プロトコルバージョン1の問題点</title>
	<para>長い間、プロトコルバージョン1にはいくつかの問題点があった。</para>
	<itemizedlist>
	<listitem>
		<para>
			<command>構文解析の問題(Problematic parsing) - </command>
			プロトコルバージョン1はデータのブロックを分離するのに、
			ハイフンとカンマを使っている。ファイル名にハイフンがあると、
			receiverがデータを間違った方法でデコードするため、問題が
			発生する。
		</para>
	</listitem>
	<listitem>
		<para>
			<command>安全でないネットワーク転送(Insecure network transfer) - </command>
			プロトコルバージョン1は、すべてのデータを、ネットワーク上で
			暗号化しないで送信する。
		</para>
	</listitem>
	<listitem>
		<para>
			<command>サポートしているVFS操作の制限 - </command>
			プロトコルバージョン1は4つのVFS操作しかサポートしていない。
		</para>
	</listitem>
	<listitem>
		<para>
			<command>プロトコルの更新版がない(No subreleases of the protocol) - </command>
			プロトコルバージョン1は、そのバージョンで固定であり、互換がある
			更新版において、新規機能の導入やバグ修正が出来ない。
		</para>
	</listitem>
	</itemizedlist>
</refsect1>
<refsect1>
	<title>バージョン2のプロトコル</title>
	<para>プロトコルバージョン2はバージョンv1で導入された問題を解決する試みである。
	利用者の観点から、以下の変更がその他の強化に加えて最も顕著である:
	</para>
	<itemizedlist>
		<listitem>
		<para>
		  モジュールからのデータは、secrets.tdb(あるいはsecrets.ntdb)中に
		  格納されるキーにより暗号化
		  することが出来る。receiverは同じキーを使わなければならない。
		  モジュールはデータを送る時にAESブロック暗号化を行う。
		</para>
		</listitem>
		<listitem>
		<para>
		  モジュールは、副リリース番号を伴うreceiverに対してそれ自身を識別でき、
		  receiverはモジュールに対して異なった副リリース番号と一緒に動作できる。
		The module now can identify itself against the receiver with a sub-release number, where
		the receiver may run with a different sub-release number than the module.
		しかしながら、V2.xプロトコル上で両者が動いても、たとえモジュールが
		より新しい副リリース中でのみ実装される機能を使うとしても、receiverは
		クラッシュしない。最終的に、もしもモジュールが、新しい副リリースから
		新しい機能を使う場合で、receiverが古いプロトコルで動作する場合、
		それは単に機能を無視するだけである。もちろん、receiverとモジュールが
		共にプロトコルの同じ副リリースを使うのが最善である。</para><para>
 However, as
		long as both run on the V2.x protocol, the receiver will not crash, even if the module
		uses features only implemented in the newer subrelease. Ultimatively, if the module uses
		a new feature from a newer subrelease, and the receiver runs an older protocol, it is just
		ignoring the functionality. Of course it is best to have both the receiver and the module
		running the same subrelease of the protocol.
		</para>
		</listitem>
		<listitem>
		<para>
		  プロトコルV1の構文解析問題はもはや起きない。なぜならV2では適切な
		  方法で、データパッケージを整理する。
		The parsing problems of protocol V1 can no longer happen, because V2 is marshalling the
		data packages in a proper way.
		</para>
		</listitem>
		<listitem>
		<para>
		  モジュールは現在すべてのVFS機能毎にデータを作成する能力が潜在的にある。
		  プロトコル V2.0では、8つのVFS機能、すなわち、rite,read,pread,pwrite,
		  rename,chdir,mkdir と rmdirをサポートする。より多くのVFS機能の
		  サポートは、将来の副リリースの課題の1つである。</para><para>
		The module now potientially has the ability to create data on every VFS function. As of
		protocol V2.0, there is support for 8 VFS functions, namely write,read,pread,pwrite,
		rename,chdir,mkdir and rmdir. Supporting more VFS functions is one of the targets for the
		upcoming sub-releases.
		</para>
		</listitem>
	</itemizedlist>
	<para>
	  プロトコルV2を有効にするには、protocol_version VFS オプションを使わなければ
	  ならない(オプション節を参照)。
	</para>
		
</refsect1>		

<refsect1>
	<title>プロトコルV1とV2.xにおけるオプション</title>

	<variablelist>

		<varlistentry>
                <term>smb_traffic_analyzer:mode = STRING</term>
                <listitem>
                <para>もしも、STRINGが "unix_domain_socket" に一致するならば、モジュール
		  は/var/tmp/stadsocketに位置するunixドメインソケットを使い、もしも、
		  STRINGにそのほかの文字列か、未定義ならば、モジュールは、データの転送
		  のためにインターネットドメインソケットを使う。</para>

                </listitem>
                </varlistentry>


		<varlistentry>
		<term>smb_traffic_analyzer:host = STRING</term>
		<listitem>
		<para>モジュールはホスト名がSTRINGという名前のシステムにデータを送る。</para>

		</listitem>
		</varlistentry>

		<varlistentry>
		<term>smb_traffic_analyzer:port = STRING</term>
		<listitem>
		<para>モジュールはSTRING中で指定されたTCPポートにデータを送る。</para>
		</listitem>
		</varlistentry>
		<varlistentry>
		<term>smb_traffic_analyzer:anonymize_prefix = STRING</term>
		<listitem>
		<para>モジュールは、STRINGで与えられたプレフィックスと単純なハッシュ値で
		  ユーザー名を置き換える。バージョン2.xのプロトコルでは、ユーザーのSIDも
		  匿名化する。
		</para>

		</listitem>
		</varlistentry>

		<varlistentry>
		<term>smb_traffic_analyzer:total_anonymization = STRING</term>
		<listitem>
		<para>もしもSTRINGが'yes'に一致するならば、このモジュールは、
		  追加のハッシュ値を生成しないで、smb_traffic_analyzer:anonymize_prefix
		  オプションによって与えられる文字列で、任意のユーザー名を置き換える。
		  これは、任意の転送データが1人のユーザーにマッピングされ、ユーザーに
		  関連するデータの完全な匿名化を提供する。バージョン2.xのプロトコルでは、
		  ユーザーのSIDも匿名化する。</para>
                </listitem>
                </varlistentry>

                <varlistentry>
                <term>smb_traffic_analyzer:protocol_version = STRING</term>
                <listitem>
                <para>もしもSTRINGがV1に一致する場合、
		モジュールはバージョン1のプロトコルを使う。もしもSTRINGが
		なかった場合、モジュールはバージョン2のプロトコルを使い、それが
		既定値となる。
                </para>
		</listitem>
		</varlistentry>

	</variablelist>
</refsect1>

<refsect1>
	<title>使用例</title>

        <para>共有"example_share"上でプロトコルV2を走らせ、インターネットソケットを使う</para>
        <programlisting>
        <smbconfsection name="[example_share]"/>
        <smbconfoption name="path">/data/example</smbconfoption>
        <smbconfoption name="vfs_objects">smb_traffic_analyzer</smbconfoption>
        <smbconfoption name="smb_traffic_analyzer:host">examplehost</smbconfoption>
        <smbconfoption name="smb_traffic_analyzer:port">3491</smbconfoption>
        </programlisting>

	<para>unixドメインソケットを使い、共有"example_share"上でモジュールを走らせる</para>
	<programlisting>
	<smbconfsection name="[example_share]"/>
	<smbconfoption name="path">/data/example</smbconfoption>
	<smbconfoption name="vfs objects">smb_traffic_analyzer</smbconfoption>
	<smbconfoption name="smb_traffic_analyzer:mode">unix_domain_socket</smbconfoption>
	</programlisting>

	<para>The module running on share "example_share", using an internet socket,
	connecting to host "examplehost" on port 3491.</para>
	<para>インターネットソケットを使い、ポート3491のホスト名"examplehost"に対して
	  接続し、共有"example_share"上でモジュールを走らせる</para>
	<programlisting>
	<smbconfsection name="[example_share]"/>
	<smbconfoption name="path">/data/example</smbconfoption>
	<smbconfoption name="vfs objects">smb_traffic_analyzer</smbconfoption>
	<smbconfoption name="smb_traffic_analyzer:host">examplehost</smbconfoption>
	<smbconfoption name="smb_traffic_analyzer:port">3491</smbconfoption>
	</programlisting>

	<para>The module running on share "example_share", using an internet socket,
	connecting to host "examplehost" on port 3491, anonymizing user names with
	the prefix "User".</para>
	<para>インターネットソケットを使い、ポート3491のホスト名"examplehost"に対して
	  接続し、プレフィックス"User"でユーザー名を匿名化する</para>
	<programlisting>
	<smbconfsection name="[example_share]"/>
	<smbconfoption name="path">/data/example</smbconfoption>
	<smbconfoption name="vfs objects">smb_traffic_analyzer</smbconfoption>
	<smbconfoption name="smb_traffic_analyzer:host">examplehost</smbconfoption>
	<smbconfoption name="smb_traffic_analyzer:port">3491</smbconfoption>
	<smbconfoption name="smb_traffic_analyzer:anonymize_prefix">User</smbconfoption>
	</programlisting>
</refsect1>

<refsect1>
	<title>バージョン</title>
	<para>このマニュアルページはSamba3.3(訳注 4.x?)用のものである。
	</para>
</refsect1>

<refsect1>
	<title>著者</title>

	<para>オリジナルの Samba ソフトウェアと関連するユーティリティは、Andrew
	Tridgell によって作成された。現在 Samba は Samba Team に
	よって、Linuxカーネルの開発と同様のオープンソースプロジェクト
	として開発が行なわれている。</para>

	<para>オリジナルのバージョンのVFSモジュールとヘルパツールは、
	Holger Hetterichによって作成された。</para>

</refsect1>

<refsect1>
	<title>日本語訳</title>
	<para>このマニュアルページは Samba 4.1.0 - 4.1.12 に対応する。</para>
        <para>このドキュメントの Samba 3.2.8 - 4.1.12 対応の翻訳は
	<itemizedlist>
		<listitem><para>太田俊哉 (ribbon@samba.gr.jp)</para></listitem>
	</itemizedlist>
        によって行なわれた。</para>
</refsect1>

</refentry>
