<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE refentry PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
<refentry id="vfs_fruit.8">

<refmeta>
	<refentrytitle>vfs_fruit</refentrytitle>
	<manvolnum>8</manvolnum>
	<refmiscinfo class="source">Samba</refmiscinfo>
	<refmiscinfo class="manual">システム管理ツール</refmiscinfo>
	<refmiscinfo class="version">4.4</refmiscinfo>
</refmeta>


<refnamediv>
	<refname>vfs_fruit</refname>
	<refpurpose>OS X と Netatalk との相互運用性を強化する</refpurpose>
</refnamediv>

<refsynopsisdiv>
	<cmdsynopsis>
		<command>vfs objects = fruit</command>
	</cmdsynopsis>
</refsynopsisdiv>

<refsect1>
	<title>説明</title>

	<para>この VFS モジュールは
	<citerefentry><refentrytitle>samba</refentrytitle>
	<manvolnum>7</manvolnum></citerefentry>システムの一部である。</para>

	<para>The <command>vfs_fruit</command> モジュールは、Apple SMB クライアント
	との互換性向上と、Netatalk 3 AFP ファイルサーバとの相互運用性を提供する。
	</para>

	<para>このモジュールは、もしも文字変換をするのであれば、
	<command>vfs_catia</command> といっしょに使うべきであり、さらに、
	<command>vfs_streams_xattr</command> と共に使わなければならない。
	正しい設定方法は、例 の節を参照のこと。</para>

	<para>モジュールは、共有に対して、代替データストリーム(ADS)
	のサポートと、OS X 特有のストーリム "AFP_AfpInfo" と "AFP_Resource"
	を横取りし、それを特別な方法で扱う機能を有効にする。
	その他すべての名前付きストリームは、<command>vfs_fruit</command>
	といっしょにロードされねばならない<command>vfs_streams_xattr</command>
	にゆだねられる。</para>

	<para>OS Xクライアントに対する、ADSサポートが有効な共有
	があると言うことは、Apple固有のSMBサーバ実装の動作と似て、
	Sambaが大文字と小文字を区別することにより引き起こされる
	深刻なパフォーマンスの低下を回避すると言う点において価値がある。
	</para>

	<para>OS X メタデータとリソースフォークストリームは、Netatalk 3 と
	互換性のある方法で、下記のように設定することにより格納される。
	<command>fruit:resource = file</command> と
	<command>fruit:metadata = netatalk</command></para>

	<para>OS X は、NTFS の不正な文字を、SMB要求中で、Unicode
	のプライベート領域にマップする。
	<command>fruit:encoding = native</command> を設定することにより、
	すべてのマップされた文字は ネイティブなASCII文字に変換される。
	</para>

	<para>最後に、共有アクセスモードは、
	<command>fruit:locking = netatalk</command>
	を設定することにより、Netatalk AFP 共有モードに対して
	チェックすることもできる。</para>

	<para>このモジュールは、このマニュアルページで言及されている
	物以外に対してはスタックできない。</para>

</refsect1>

<refsect1>
        <title>グローバルオプション</title>

        <para>以下のオプションはsmb.conf のグローバルセクションに記述しなければ
	ならず、共有ごとのセクションに設定しても効果がない。</para>

        <variablelist>

          <varlistentry>
            <term>fruit:aapl = yes | no</term>
            <listitem>
              <para><emphasis>グローバル</emphasis>オプションで、
	      コードネーム AAPL という、Apple の SMB2+ 拡張を有効にするかを指定する。
	      既定値は<emphasis>yes</emphasis>である。
	      この拡張は、Mac から繋ぐときに、いくつか欠けている点を
	      機能を追加する:</para>

              <itemizedlist>
                <listitem><para>ディレクトリ一覧表示において、
		Mac に関連したファイルシステムメタデータ(UNIX モード、
		ファインダ情報、リソースフォークと実行パーミッション)
		が強化されているため、その結果として、Mac クライアントは
		このメタデータを、個々ののディレクトリエントリごと個別に
		取得する必要はなく、その結果、しばしば大幅にパフォーマンス
		が向上する。
		</para></listitem>

                <listitem><para>ディレクトリエントリの UNIX モード情報を
		得たり、変更する機能。</para></listitem>
              </itemizedlist>

	      <para><emphasis>fruit:aapl</emphasis>が有効になっているときに
	      使える、共有単位のオプションがある。以下で説明する、それらの
	      オプションは、ディレクトリ一覧表示時に、特定の Mac
	      メタデータの処理を無効にする。なお、それらのオプションにおける
	      既定値は 有効 である: </para>

              <itemizedlist>
                <listitem><para>readdir_attr:aapl_rsize = yes | no</para></listitem>
                <listitem><para>readdir_attr:aapl_finder_info = yes | no</para></listitem>
                <listitem><para>readdir_attr:aapl_max_access = yes | no</para></listitem>
              </itemizedlist>

              <para>以下では、上記のオプションの説明を記載する。</para>

            </listitem>
          </varlistentry>

          <varlistentry>
            <term>fruit:nfs_aces = yes | no</term>
            <listitem>
	      <para><emphasis>グローバル</emphasis>オプションであり、NFS ACE 経由の、
	      ディレクトリエントリに対する UNIX モードの問合せと変更のサポートが有効化か
	      どうかを指定する。既定値は<emphasis>yes</emphasis>である。
	      </para>
              <para>A <emphasis>global</emphasis> option whether support for
              querying and modifying the UNIX mode of directory entries via NFS
              ACEs is enabled, default <emphasis>yes</emphasis>.</para>
            </listitem>
          </varlistentry>

          <varlistentry>
            <term>fruit:copyfile = yes | no</term>
            <listitem>
	      <para><emphasis>グローバル</emphasis>オプションであり、
	      すべての添付されたメタデータとともに、すべてのファイルの
	      コピーを要求する、OS X 固有の copychunk ioctl を有効にするかの
	      指定。</para>
              <para>A <emphasis>global</emphasis> option whether to enable OS X
              specific copychunk ioctl that requests a copy of a whole file
              along with all attached metadata.</para>
              <para>注意: サーバがコピー実行中、copyfile 要求は、
	      クライアントをブロックする。</para>.
              <para>既定値は<emphasis>no</emphasis>である。</para>
            </listitem>
          </varlistentry>

        </variablelist>
</refsect1>
	      
<refsect1>
	<title>オプション</title>

	<para>以下のオプションは、smb.conf のグローバルセクションか、
	個々の共有セクションに設定出来る。</para>
	
	<variablelist>

	  <varlistentry>
	    <term>fruit:resource = [ file | xattr | stream ]</term>
	    <listitem>
	      <para>どこに OSX リソースフォークを格納するかを制御する:</para>


              <para><emphasis>重要: </emphasis>バージョン 4.5 とそれ以前の
	      すべての Samba 中では、オプションパーサでミススペルが
	      あったため、このオプションは<emphasis>fruit:ressource</emphasis>
	      と記述しなければならない。すなわち、<emphasis>s</emphasis>が
	      2つ必要である。</para>

	      <para>このオプションを、既定値以外に設定する場合、
	      ひきつづき<emphasis>file</emphasis>
	      の既定値設定を使うので、有効な設定を反映するように、
	      smb.conf を調整し、<emphasis>fruit:ressource=file</emphasis>
	      を追加する事を推奨する。オプション行をすべて削除しても
	      同じように動作する。
	      </para>
              <para>Users who set this opion to any non-default
              setting were still using the default setting of
              <emphasis>file</emphasis> and are advised to adjust
              their smb.conf to reflect the effective setting and set
              <emphasis>fruit:ressource=file</emphasis> in their
              smb.conf. Removing the option line altogether works as
              well.</para>

              <para>Samba 4.6 では、正しい/間違ったスペル両方とも
	      処理できるが、Samba 4.7 以降では 正しいスペルのみ受け付ける。
	      </para>

              <para>設定:</para>

	      <itemizedlist>
		<listitem><para><command>file (既定値)</command> -
		OS X と Netatalk 互換の ._ AppleDouble ファイル
		を使う。</para></listitem>

		<listitem><para><command>xattr</command> - use a
		xattr, requires a filesystem with large xattr support
		and a file IO API compatible with xattrs, this boils
		down to Solaris and derived platforms and
		ZFS
		拡張属性(xattr)を使用する。これは、大きなサイズの拡張属性をサポート
		するファイルシステムと、拡張属性に準拠した
		ファイルIO APIが必要となる。つまり、
		Solaris と Solaris派生プラットフォームのZFSが必須である。
		</para></listitem>

		<listitem><para><command>stream</command> - 
		VFSスタックの、次のモジュールに、ストリームを渡す</para></listitem>
	      </itemizedlist>

	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>fruit:metadata = [ stream | netatalk ]</term>
	    <listitem>
	      <para>OS X メタデータストリームが格納される場所を指定する:</para>

	      <itemizedlist>
		<listitem><para><command>netatalk (既定値)</command> - 
		Netatalk 互換の xattr を使う</para></listitem>

		<listitem><para><command>stream</command> - 
		VFSスタックの次のモジュールにストリームを渡す</para></listitem>
	      </itemizedlist>

	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>fruit:locking = [ netatalk | none ]</term>
	    <listitem>
	      <para></para>
	      <itemizedlist>
		<listitem><para><command>none (既定値)</command> - 
		cross protocol lockingを使わない</para></listitem>

		<listitem><para><command>netatalk</command> - 
		Netatalk で cross protocol locking を使う</para></listitem>

	      </itemizedlist>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>fruit:encoding = [ native | private ]</term>
	    <listitem>

	      <para>ファイルシステムに格納される、OS X クライアントで一般的に
	      使われる、不正なNTFS ASCII文字セットを制御:</para>

	      <itemizedlist>

		<listitem><para><command>private (規定値)</command> -
		OS Xクライアントによってエンコードされた形で文字を格納:
		Unicodeプライベート領域にマップされる</para></listitem>

		<listitem><para><command>native</command> - 
		そのままのASCII値として文字を格納</para></listitem>

	      </itemizedlist>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>fruit:veto_appledouble = yes | no</term>

	    <listitem>
              <para><emphasis>参考:</emphasis>このオプションは、
	      <parameter>fruit:resource</parameter>が
	      <parameter>file</parameter>(既定値)に設定されている
	      場合にのみ適用される。</para>

	      <para><parameter>fruit:resource</parameter>が
	      <parameter>file</parameter>に設定された場合、
	      vfs_fruit は ._ AppleDouble ファイルを生成できる。
	      このオプションは、クライアントからファイルに対するアクセスを
	      防ぐために、._ AppleDouble を見えなくする(veto)
	      かを制御する。</para>
              <para>When <parameter>fruit:resource</parameter> is set to
              <parameter>file</parameter>, vfs_fruit may create ._ AppleDouble
              files. This options controls whether these ._ AppleDouble files
              are vetoed which prevents the client from accessing them.</para>
	      <para> ._ ファイルをアクセス不可にすると、いくつかのアプリケーションで
	      誤動作を引き起こすことがある。たとえば、Mac クライアントから
	      Mac ZIP アーカイブのを展開すると、アーカイブ中に ._ ファイルが
	      含まれているために失敗する。
	      このオプションを false にすることでこの問題を回避できるが、
	      内部向けに作成された ._ ファイルが露見してしまうことで
              未知の副作用を引き起こすかもしれない。</para>
              <para>Vetoing ._ files may break some applications, eg
              extracting Mac ZIP archives from Mac clients failes,
              because they contain ._ files. Setting this option to
              false will fix this, but the abstraction leak of
              exposing the internally created ._ files may have other
              unknown side effects.</para>
              <para>The default is <emphasis>yes</emphasis>.</para>	      
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>fruit:nfs_aces = yes | no</term>
	    <listitem>
	      <para>NFS ACE 経由での、ディレクトリエントリのUNIX モードを問合せ/変更する
	      機能を有効にするかどうかの指定で、既定値は <emphasis>yes</emphasis>。 </para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>fruit:veto_appledouble = yes | no</term>
	    <listitem>
	    <para> Mac リソースフォークを格納する目的のため、 vfs_fruit それ自身に
	    よって作成された、内部 AppleDouble ファイルの閲覧と変更を、クライアントから
	    防止するため、._ AppleDouble ファイルを見せなくするかどうかの指定。</para>
	    <para> ._ ファイルを見せなくすると、いくつかのアプリケーションが動かなくなる
	    ことがある。たとえば、 ._ ファイルを含むため、Mac クライアントからの Mac ZIP
	    の回答は失敗する。このオプションを false に設定すると、これを修正するが、
	    内部的に作成された ._ ファイルの露出をリークする概念は、他の不明な
	    副作用を引き起こすかもしれない。</para>
	    <para>既定値は<emphasis>yes</emphasis>である。</para>
	  </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>fruit:posix_rename = yes | no</term>
	    <listitem>
	      <para>OS X クライアントで、POSIX の改名動作を有効にするかどうかの指定。
	      このオプションを指定しないと、クライアントは、(再帰的にも!)
	      対象ディレクトリ中にオープンしているファイルがある場合、
	      ディレクトリを改名出来ない。
	      </para>
	      <para>既定値は<emphasis>yes</emphasis>である。</para>
	    </listitem>
	   </varlistentry>

          <varlistentry>
            <term>readdir_attr:aapl_rsize = yes | no</term>
            <listitem>
              <para>SMB2 FIND の応答で リソースフォークのサイズを返す。</para>
              <para>既定値は<emphasis>yes</emphasis>である。</para>
            </listitem>
          </varlistentry>

          <varlistentry>
            <term>readdir_attr:aapl_finder_info = yes | no</term>
            <listitem>
              <para>SMB2 FIND の応答で FinderInfo を返す。</para>
              <para>既定値は<emphasis>yes</emphasis>である。</para>
            </listitem>
          </varlistentry>

          <varlistentry>
            <term>readdir_attr:aapl_max_access = yes | no</term>
            <listitem>
              <para>SMB2 FIND の応答で、ユーザの有効な最大のアクセス許可
	      を返す。これは計算に時間がかかるので、設定を off にすると、
	      最大の有効なアクセス許可を持っているとみなす。</para>
	      <para>Return the user's effective maximum permissions in SMB2 FIND
              responses. This is an expensive computation, setting this to off
              pretends the use has maximum effective permissions.</para>
              <para>既定値は <emphasis>yes</emphasis>である。</para>
            </listitem>
          </varlistentry>
	  
	   
	</variablelist>
</refsect1>

<refsect1>
	<title>例</title>

<programlisting>
        <smbconfsection name="[share]"/>
	<smbconfoption name="vfs objects">catia fruit streams_xattr</smbconfoption>
	<smbconfoption name="fruit:resource">file</smbconfoption>
	<smbconfoption name="fruit:metadata">netatalk</smbconfoption>
	<smbconfoption name="fruit:locking">netatalk</smbconfoption>
	<smbconfoption name="fruit:encoding">native</smbconfoption>
</programlisting>

</refsect1>

<refsect1>
	<title>著者</title>

	<para>
    オリジナルの Samba ソフトウェアと関連するユーティリティは、Andrew
    Tridgell によって作成された。現在 Samba は Samba Team に
    よって、Linuxカーネルの開発と同様のオープンソースプロジェクト
    として開発が行なわれている。
	</para>   

</refsect1>
<refsect1>
    <title>日本語訳</title>
    <para>このマニュアルページは Samba 4.4.11 - 4.4.12 に対応する。</para>
    <para>このドキュメントの Samba 4.2.0 - 4.4.12 対応の翻訳は
    <itemizedlist>
        <listitem><para>太田俊哉 (ribbon@samba.gr.jp)</para></listitem>
    </itemizedlist>
    によって行なわれた。</para>
</refsect1>

</refentry>
